(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const C of document.querySelectorAll('link[rel="modulepreload"]'))m(C);new MutationObserver(C=>{for(const b of C)if(b.type==="childList")for(const S of b.addedNodes)S.tagName==="LINK"&&S.rel==="modulepreload"&&m(S)}).observe(document,{childList:!0,subtree:!0});function g(C){const b={};return C.integrity&&(b.integrity=C.integrity),C.referrerPolicy&&(b.referrerPolicy=C.referrerPolicy),C.crossOrigin==="use-credentials"?b.credentials="include":C.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function m(C){if(C.ep)return;C.ep=!0;const b=g(C);fetch(C.href,b)}})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */function _i(f,c,g,m){f.prototype._pos=[0,0,0],f.prototype._orientation=[0,0,-1,0,1,0],f.prototype.stereo=function(b){var S=this;if(!S.ctx||!S.ctx.listener)return S;for(var x=S._howls.length-1;x>=0;x--)S._howls[x].stereo(b);return S},f.prototype.pos=function(b,S,x){var R=this;if(!R.ctx||!R.ctx.listener)return R;if(S=typeof S!="number"?R._pos[1]:S,x=typeof x!="number"?R._pos[2]:x,typeof b=="number")R._pos=[b,S,x],typeof R.ctx.listener.positionX<"u"?(R.ctx.listener.positionX.setTargetAtTime(R._pos[0],c.ctx.currentTime,.1),R.ctx.listener.positionY.setTargetAtTime(R._pos[1],c.ctx.currentTime,.1),R.ctx.listener.positionZ.setTargetAtTime(R._pos[2],c.ctx.currentTime,.1)):R.ctx.listener.setPosition(R._pos[0],R._pos[1],R._pos[2]);else return R._pos;return R},f.prototype.orientation=function(b,S,x,R,O,E){var V=this;if(!V.ctx||!V.ctx.listener)return V;var j=V._orientation;if(S=typeof S!="number"?j[1]:S,x=typeof x!="number"?j[2]:x,R=typeof R!="number"?j[3]:R,O=typeof O!="number"?j[4]:O,E=typeof E!="number"?j[5]:E,typeof b=="number")V._orientation=[b,S,x,R,O,E],typeof V.ctx.listener.forwardX<"u"?(V.ctx.listener.forwardX.setTargetAtTime(b,c.ctx.currentTime,.1),V.ctx.listener.forwardY.setTargetAtTime(S,c.ctx.currentTime,.1),V.ctx.listener.forwardZ.setTargetAtTime(x,c.ctx.currentTime,.1),V.ctx.listener.upX.setTargetAtTime(R,c.ctx.currentTime,.1),V.ctx.listener.upY.setTargetAtTime(O,c.ctx.currentTime,.1),V.ctx.listener.upZ.setTargetAtTime(E,c.ctx.currentTime,.1)):V.ctx.listener.setOrientation(b,S,x,R,O,E);else return j;return V},g.prototype.init=function(b){return function(S){var x=this;return x._orientation=S.orientation||[1,0,0],x._stereo=S.stereo||null,x._pos=S.pos||null,x._pannerAttr={coneInnerAngle:typeof S.coneInnerAngle<"u"?S.coneInnerAngle:360,coneOuterAngle:typeof S.coneOuterAngle<"u"?S.coneOuterAngle:360,coneOuterGain:typeof S.coneOuterGain<"u"?S.coneOuterGain:0,distanceModel:typeof S.distanceModel<"u"?S.distanceModel:"inverse",maxDistance:typeof S.maxDistance<"u"?S.maxDistance:1e4,panningModel:typeof S.panningModel<"u"?S.panningModel:"HRTF",refDistance:typeof S.refDistance<"u"?S.refDistance:1,rolloffFactor:typeof S.rolloffFactor<"u"?S.rolloffFactor:1},x._onstereo=S.onstereo?[{fn:S.onstereo}]:[],x._onpos=S.onpos?[{fn:S.onpos}]:[],x._onorientation=S.onorientation?[{fn:S.onorientation}]:[],b.call(this,S)}}(g.prototype.init),g.prototype.stereo=function(b,S){var x=this;if(!x._webAudio)return x;if(x._state!=="loaded")return x._queue.push({event:"stereo",action:function(){x.stereo(b,S)}}),x;var R=typeof c.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof S>"u")if(typeof b=="number")x._stereo=b,x._pos=[b,0,0];else return x._stereo;for(var O=x._getSoundIds(S),E=0;E<O.length;E++){var V=x._soundById(O[E]);if(V)if(typeof b=="number")V._stereo=b,V._pos=[b,0,0],V._node&&(V._pannerAttr.panningModel="equalpower",(!V._panner||!V._panner.pan)&&C(V,R),R==="spatial"?typeof V._panner.positionX<"u"?(V._panner.positionX.setValueAtTime(b,c.ctx.currentTime),V._panner.positionY.setValueAtTime(0,c.ctx.currentTime),V._panner.positionZ.setValueAtTime(0,c.ctx.currentTime)):V._panner.setPosition(b,0,0):V._panner.pan.setValueAtTime(b,c.ctx.currentTime)),x._emit("stereo",V._id);else return V._stereo}return x},g.prototype.pos=function(b,S,x,R){var O=this;if(!O._webAudio)return O;if(O._state!=="loaded")return O._queue.push({event:"pos",action:function(){O.pos(b,S,x,R)}}),O;if(S=typeof S!="number"?0:S,x=typeof x!="number"?-.5:x,typeof R>"u")if(typeof b=="number")O._pos=[b,S,x];else return O._pos;for(var E=O._getSoundIds(R),V=0;V<E.length;V++){var j=O._soundById(E[V]);if(j)if(typeof b=="number")j._pos=[b,S,x],j._node&&((!j._panner||j._panner.pan)&&C(j,"spatial"),typeof j._panner.positionX<"u"?(j._panner.positionX.setValueAtTime(b,c.ctx.currentTime),j._panner.positionY.setValueAtTime(S,c.ctx.currentTime),j._panner.positionZ.setValueAtTime(x,c.ctx.currentTime)):j._panner.setPosition(b,S,x)),O._emit("pos",j._id);else return j._pos}return O},g.prototype.orientation=function(b,S,x,R){var O=this;if(!O._webAudio)return O;if(O._state!=="loaded")return O._queue.push({event:"orientation",action:function(){O.orientation(b,S,x,R)}}),O;if(S=typeof S!="number"?O._orientation[1]:S,x=typeof x!="number"?O._orientation[2]:x,typeof R>"u")if(typeof b=="number")O._orientation=[b,S,x];else return O._orientation;for(var E=O._getSoundIds(R),V=0;V<E.length;V++){var j=O._soundById(E[V]);if(j)if(typeof b=="number")j._orientation=[b,S,x],j._node&&(j._panner||(j._pos||(j._pos=O._pos||[0,0,-.5]),C(j,"spatial")),typeof j._panner.orientationX<"u"?(j._panner.orientationX.setValueAtTime(b,c.ctx.currentTime),j._panner.orientationY.setValueAtTime(S,c.ctx.currentTime),j._panner.orientationZ.setValueAtTime(x,c.ctx.currentTime)):j._panner.setOrientation(b,S,x)),O._emit("orientation",j._id);else return j._orientation}return O},g.prototype.pannerAttr=function(){var b=this,S=arguments,x,R,O;if(!b._webAudio)return b;if(S.length===0)return b._pannerAttr;if(S.length===1)if(typeof S[0]=="object")x=S[0],typeof R>"u"&&(x.pannerAttr||(x.pannerAttr={coneInnerAngle:x.coneInnerAngle,coneOuterAngle:x.coneOuterAngle,coneOuterGain:x.coneOuterGain,distanceModel:x.distanceModel,maxDistance:x.maxDistance,refDistance:x.refDistance,rolloffFactor:x.rolloffFactor,panningModel:x.panningModel}),b._pannerAttr={coneInnerAngle:typeof x.pannerAttr.coneInnerAngle<"u"?x.pannerAttr.coneInnerAngle:b._coneInnerAngle,coneOuterAngle:typeof x.pannerAttr.coneOuterAngle<"u"?x.pannerAttr.coneOuterAngle:b._coneOuterAngle,coneOuterGain:typeof x.pannerAttr.coneOuterGain<"u"?x.pannerAttr.coneOuterGain:b._coneOuterGain,distanceModel:typeof x.pannerAttr.distanceModel<"u"?x.pannerAttr.distanceModel:b._distanceModel,maxDistance:typeof x.pannerAttr.maxDistance<"u"?x.pannerAttr.maxDistance:b._maxDistance,refDistance:typeof x.pannerAttr.refDistance<"u"?x.pannerAttr.refDistance:b._refDistance,rolloffFactor:typeof x.pannerAttr.rolloffFactor<"u"?x.pannerAttr.rolloffFactor:b._rolloffFactor,panningModel:typeof x.pannerAttr.panningModel<"u"?x.pannerAttr.panningModel:b._panningModel});else return O=b._soundById(parseInt(S[0],10)),O?O._pannerAttr:b._pannerAttr;else S.length===2&&(x=S[0],R=parseInt(S[1],10));for(var E=b._getSoundIds(R),V=0;V<E.length;V++)if(O=b._soundById(E[V]),O){var j=O._pannerAttr;j={coneInnerAngle:typeof x.coneInnerAngle<"u"?x.coneInnerAngle:j.coneInnerAngle,coneOuterAngle:typeof x.coneOuterAngle<"u"?x.coneOuterAngle:j.coneOuterAngle,coneOuterGain:typeof x.coneOuterGain<"u"?x.coneOuterGain:j.coneOuterGain,distanceModel:typeof x.distanceModel<"u"?x.distanceModel:j.distanceModel,maxDistance:typeof x.maxDistance<"u"?x.maxDistance:j.maxDistance,refDistance:typeof x.refDistance<"u"?x.refDistance:j.refDistance,rolloffFactor:typeof x.rolloffFactor<"u"?x.rolloffFactor:j.rolloffFactor,panningModel:typeof x.panningModel<"u"?x.panningModel:j.panningModel};var tt=O._panner;tt||(O._pos||(O._pos=b._pos||[0,0,-.5]),C(O,"spatial"),tt=O._panner),tt.coneInnerAngle=j.coneInnerAngle,tt.coneOuterAngle=j.coneOuterAngle,tt.coneOuterGain=j.coneOuterGain,tt.distanceModel=j.distanceModel,tt.maxDistance=j.maxDistance,tt.refDistance=j.refDistance,tt.rolloffFactor=j.rolloffFactor,tt.panningModel=j.panningModel}return b},m.prototype.init=function(b){return function(){var S=this,x=S._parent;S._orientation=x._orientation,S._stereo=x._stereo,S._pos=x._pos,S._pannerAttr=x._pannerAttr,b.call(this),S._stereo?x.stereo(S._stereo):S._pos&&x.pos(S._pos[0],S._pos[1],S._pos[2],S._id)}}(m.prototype.init),m.prototype.reset=function(b){return function(){var S=this,x=S._parent;return S._orientation=x._orientation,S._stereo=x._stereo,S._pos=x._pos,S._pannerAttr=x._pannerAttr,S._stereo?x.stereo(S._stereo):S._pos?x.pos(S._pos[0],S._pos[1],S._pos[2],S._id):S._panner&&(S._panner.disconnect(0),S._panner=void 0,x._refreshBuffer(S)),b.call(this)}}(m.prototype.reset);var C=function(b,S){S=S||"spatial",S==="spatial"?(b._panner=c.ctx.createPanner(),b._panner.coneInnerAngle=b._pannerAttr.coneInnerAngle,b._panner.coneOuterAngle=b._pannerAttr.coneOuterAngle,b._panner.coneOuterGain=b._pannerAttr.coneOuterGain,b._panner.distanceModel=b._pannerAttr.distanceModel,b._panner.maxDistance=b._pannerAttr.maxDistance,b._panner.refDistance=b._pannerAttr.refDistance,b._panner.rolloffFactor=b._pannerAttr.rolloffFactor,b._panner.panningModel=b._pannerAttr.panningModel,typeof b._panner.positionX<"u"?(b._panner.positionX.setValueAtTime(b._pos[0],c.ctx.currentTime),b._panner.positionY.setValueAtTime(b._pos[1],c.ctx.currentTime),b._panner.positionZ.setValueAtTime(b._pos[2],c.ctx.currentTime)):b._panner.setPosition(b._pos[0],b._pos[1],b._pos[2]),typeof b._panner.orientationX<"u"?(b._panner.orientationX.setValueAtTime(b._orientation[0],c.ctx.currentTime),b._panner.orientationY.setValueAtTime(b._orientation[1],c.ctx.currentTime),b._panner.orientationZ.setValueAtTime(b._orientation[2],c.ctx.currentTime)):b._panner.setOrientation(b._orientation[0],b._orientation[1],b._orientation[2])):(b._panner=c.ctx.createStereoPanner(),b._panner.pan.setValueAtTime(b._stereo,c.ctx.currentTime)),b._panner.connect(b._node),b._paused||b._parent.pause(b._id,!0).play(b._id,!0)}}/*!
 *  howler.js v2.2.3
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var Ce=function(){this.init()};Ce.prototype={init:function(){var f=this||ct;return f._counter=1e3,f._html5AudioPool=[],f.html5PoolSize=10,f._codecs={},f._howls=[],f._muted=!1,f._volume=1,f._canPlayEvent="canplaythrough",f._navigator=typeof window<"u"&&window.navigator?window.navigator:null,f.masterGain=null,f.noAudio=!1,f.usingWebAudio=!0,f.autoSuspend=!0,f.ctx=null,f.autoUnlock=!0,f._setup(),f},volume:function(f){var c=this||ct;if(f=parseFloat(f),c.ctx||ae(),typeof f<"u"&&f>=0&&f<=1){if(c._volume=f,c._muted)return c;c.usingWebAudio&&c.masterGain.gain.setValueAtTime(f,ct.ctx.currentTime);for(var g=0;g<c._howls.length;g++)if(!c._howls[g]._webAudio)for(var m=c._howls[g]._getSoundIds(),C=0;C<m.length;C++){var b=c._howls[g]._soundById(m[C]);b&&b._node&&(b._node.volume=b._volume*f)}return c}return c._volume},mute:function(f){var c=this||ct;c.ctx||ae(),c._muted=f,c.usingWebAudio&&c.masterGain.gain.setValueAtTime(f?0:c._volume,ct.ctx.currentTime);for(var g=0;g<c._howls.length;g++)if(!c._howls[g]._webAudio)for(var m=c._howls[g]._getSoundIds(),C=0;C<m.length;C++){var b=c._howls[g]._soundById(m[C]);b&&b._node&&(b._node.muted=f?!0:b._muted)}return c},stop:function(){for(var f=this||ct,c=0;c<f._howls.length;c++)f._howls[c].stop();return f},unload:function(){for(var f=this||ct,c=f._howls.length-1;c>=0;c--)f._howls[c].unload();return f.usingWebAudio&&f.ctx&&typeof f.ctx.close<"u"&&(f.ctx.close(),f.ctx=null,ae()),f},codecs:function(f){return(this||ct)._codecs[f.replace(/^x-/,"")]},_setup:function(){var f=this||ct;if(f.state=f.ctx&&f.ctx.state||"suspended",f._autoSuspend(),!f.usingWebAudio)if(typeof Audio<"u")try{var c=new Audio;typeof c.oncanplaythrough>"u"&&(f._canPlayEvent="canplay")}catch{f.noAudio=!0}else f.noAudio=!0;try{var c=new Audio;c.muted&&(f.noAudio=!0)}catch{}return f.noAudio||f._setupCodecs(),f},_setupCodecs:function(){var f=this||ct,c=null;try{c=typeof Audio<"u"?new Audio:null}catch{return f}if(!c||typeof c.canPlayType!="function")return f;var g=c.canPlayType("audio/mpeg;").replace(/^no$/,""),m=f._navigator?f._navigator.userAgent:"",C=m.match(/OPR\/([0-6].)/g),b=C&&parseInt(C[0].split("/")[1],10)<33,S=m.indexOf("Safari")!==-1&&m.indexOf("Chrome")===-1,x=m.match(/Version\/(.*?) /),R=S&&x&&parseInt(x[1],10)<15;return f._codecs={mp3:!!(!b&&(g||c.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!g,opus:!!c.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!c.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!c.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(c.canPlayType('audio/wav; codecs="1"')||c.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!c.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!c.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(c.canPlayType("audio/x-m4a;")||c.canPlayType("audio/m4a;")||c.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(c.canPlayType("audio/x-m4b;")||c.canPlayType("audio/m4b;")||c.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(c.canPlayType("audio/x-mp4;")||c.canPlayType("audio/mp4;")||c.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!R&&c.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!R&&c.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!c.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(c.canPlayType("audio/x-flac;")||c.canPlayType("audio/flac;")).replace(/^no$/,"")},f},_unlockAudio:function(){var f=this||ct;if(!(f._audioUnlocked||!f.ctx)){f._audioUnlocked=!1,f.autoUnlock=!1,!f._mobileUnloaded&&f.ctx.sampleRate!==44100&&(f._mobileUnloaded=!0,f.unload()),f._scratchBuffer=f.ctx.createBuffer(1,1,22050);var c=function(g){for(;f._html5AudioPool.length<f.html5PoolSize;)try{var m=new Audio;m._unlocked=!0,f._releaseHtml5Audio(m)}catch{f.noAudio=!0;break}for(var C=0;C<f._howls.length;C++)if(!f._howls[C]._webAudio)for(var b=f._howls[C]._getSoundIds(),S=0;S<b.length;S++){var x=f._howls[C]._soundById(b[S]);x&&x._node&&!x._node._unlocked&&(x._node._unlocked=!0,x._node.load())}f._autoResume();var R=f.ctx.createBufferSource();R.buffer=f._scratchBuffer,R.connect(f.ctx.destination),typeof R.start>"u"?R.noteOn(0):R.start(0),typeof f.ctx.resume=="function"&&f.ctx.resume(),R.onended=function(){R.disconnect(0),f._audioUnlocked=!0,document.removeEventListener("touchstart",c,!0),document.removeEventListener("touchend",c,!0),document.removeEventListener("click",c,!0),document.removeEventListener("keydown",c,!0);for(var O=0;O<f._howls.length;O++)f._howls[O]._emit("unlock")}};return document.addEventListener("touchstart",c,!0),document.addEventListener("touchend",c,!0),document.addEventListener("click",c,!0),document.addEventListener("keydown",c,!0),f}},_obtainHtml5Audio:function(){var f=this||ct;if(f._html5AudioPool.length)return f._html5AudioPool.pop();var c=new Audio().play();return c&&typeof Promise<"u"&&(c instanceof Promise||typeof c.then=="function")&&c.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(f){var c=this||ct;return f._unlocked&&c._html5AudioPool.push(f),c},_autoSuspend:function(){var f=this;if(!(!f.autoSuspend||!f.ctx||typeof f.ctx.suspend>"u"||!ct.usingWebAudio)){for(var c=0;c<f._howls.length;c++)if(f._howls[c]._webAudio){for(var g=0;g<f._howls[c]._sounds.length;g++)if(!f._howls[c]._sounds[g]._paused)return f}return f._suspendTimer&&clearTimeout(f._suspendTimer),f._suspendTimer=setTimeout(function(){if(f.autoSuspend){f._suspendTimer=null,f.state="suspending";var m=function(){f.state="suspended",f._resumeAfterSuspend&&(delete f._resumeAfterSuspend,f._autoResume())};f.ctx.suspend().then(m,m)}},3e4),f}},_autoResume:function(){var f=this;if(!(!f.ctx||typeof f.ctx.resume>"u"||!ct.usingWebAudio))return f.state==="running"&&f.ctx.state!=="interrupted"&&f._suspendTimer?(clearTimeout(f._suspendTimer),f._suspendTimer=null):f.state==="suspended"||f.state==="running"&&f.ctx.state==="interrupted"?(f.ctx.resume().then(function(){f.state="running";for(var c=0;c<f._howls.length;c++)f._howls[c]._emit("resume")}),f._suspendTimer&&(clearTimeout(f._suspendTimer),f._suspendTimer=null)):f.state==="suspending"&&(f._resumeAfterSuspend=!0),f}};var ct=new Ce,le=function(f){var c=this;if(!f.src||f.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}c.init(f)};le.prototype={init:function(f){var c=this;return ct.ctx||ae(),c._autoplay=f.autoplay||!1,c._format=typeof f.format!="string"?f.format:[f.format],c._html5=f.html5||!1,c._muted=f.mute||!1,c._loop=f.loop||!1,c._pool=f.pool||5,c._preload=typeof f.preload=="boolean"||f.preload==="metadata"?f.preload:!0,c._rate=f.rate||1,c._sprite=f.sprite||{},c._src=typeof f.src!="string"?f.src:[f.src],c._volume=f.volume!==void 0?f.volume:1,c._xhr={method:f.xhr&&f.xhr.method?f.xhr.method:"GET",headers:f.xhr&&f.xhr.headers?f.xhr.headers:null,withCredentials:f.xhr&&f.xhr.withCredentials?f.xhr.withCredentials:!1},c._duration=0,c._state="unloaded",c._sounds=[],c._endTimers={},c._queue=[],c._playLock=!1,c._onend=f.onend?[{fn:f.onend}]:[],c._onfade=f.onfade?[{fn:f.onfade}]:[],c._onload=f.onload?[{fn:f.onload}]:[],c._onloaderror=f.onloaderror?[{fn:f.onloaderror}]:[],c._onplayerror=f.onplayerror?[{fn:f.onplayerror}]:[],c._onpause=f.onpause?[{fn:f.onpause}]:[],c._onplay=f.onplay?[{fn:f.onplay}]:[],c._onstop=f.onstop?[{fn:f.onstop}]:[],c._onmute=f.onmute?[{fn:f.onmute}]:[],c._onvolume=f.onvolume?[{fn:f.onvolume}]:[],c._onrate=f.onrate?[{fn:f.onrate}]:[],c._onseek=f.onseek?[{fn:f.onseek}]:[],c._onunlock=f.onunlock?[{fn:f.onunlock}]:[],c._onresume=[],c._webAudio=ct.usingWebAudio&&!c._html5,typeof ct.ctx<"u"&&ct.ctx&&ct.autoUnlock&&ct._unlockAudio(),ct._howls.push(c),c._autoplay&&c._queue.push({event:"play",action:function(){c.play()}}),c._preload&&c._preload!=="none"&&c.load(),c},load:function(){var f=this,c=null;if(ct.noAudio){f._emit("loaderror",null,"No audio support.");return}typeof f._src=="string"&&(f._src=[f._src]);for(var g=0;g<f._src.length;g++){var m,C;if(f._format&&f._format[g])m=f._format[g];else{if(C=f._src[g],typeof C!="string"){f._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}m=/^data:audio\/([^;,]+);/i.exec(C),m||(m=/\.([^.]+)$/.exec(C.split("?",1)[0])),m&&(m=m[1].toLowerCase())}if(m||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),m&&ct.codecs(m)){c=f._src[g];break}}if(!c){f._emit("loaderror",null,"No codec support for selected audio sources.");return}return f._src=c,f._state="loading",window.location.protocol==="https:"&&c.slice(0,5)==="http:"&&(f._html5=!0,f._webAudio=!1),new ce(f),f._webAudio&&mi(f),f},play:function(f,c){var g=this,m=null;if(typeof f=="number")m=f,f=null;else{if(typeof f=="string"&&g._state==="loaded"&&!g._sprite[f])return null;if(typeof f>"u"&&(f="__default",!g._playLock)){for(var C=0,b=0;b<g._sounds.length;b++)g._sounds[b]._paused&&!g._sounds[b]._ended&&(C++,m=g._sounds[b]._id);C===1?f=null:m=null}}var S=m?g._soundById(m):g._inactiveSound();if(!S)return null;if(m&&!f&&(f=S._sprite||"__default"),g._state!=="loaded"){S._sprite=f,S._ended=!1;var x=S._id;return g._queue.push({event:"play",action:function(){g.play(x)}}),x}if(m&&!S._paused)return c||g._loadQueue("play"),S._id;g._webAudio&&ct._autoResume();var R=Math.max(0,S._seek>0?S._seek:g._sprite[f][0]/1e3),O=Math.max(0,(g._sprite[f][0]+g._sprite[f][1])/1e3-R),E=O*1e3/Math.abs(S._rate),V=g._sprite[f][0]/1e3,j=(g._sprite[f][0]+g._sprite[f][1])/1e3;S._sprite=f,S._ended=!1;var tt=function(){S._paused=!1,S._seek=R,S._start=V,S._stop=j,S._loop=!!(S._loop||g._sprite[f][2])};if(R>=j){g._ended(S);return}var K=S._node;if(g._webAudio){var J=function(){g._playLock=!1,tt(),g._refreshBuffer(S);var st=S._muted||g._muted?0:S._volume;K.gain.setValueAtTime(st,ct.ctx.currentTime),S._playStart=ct.ctx.currentTime,typeof K.bufferSource.start>"u"?S._loop?K.bufferSource.noteGrainOn(0,R,86400):K.bufferSource.noteGrainOn(0,R,O):S._loop?K.bufferSource.start(0,R,86400):K.bufferSource.start(0,R,O),E!==1/0&&(g._endTimers[S._id]=setTimeout(g._ended.bind(g,S),E)),c||setTimeout(function(){g._emit("play",S._id),g._loadQueue()},0)};ct.state==="running"&&ct.ctx.state!=="interrupted"?J():(g._playLock=!0,g.once("resume",J),g._clearTimer(S._id))}else{var Z=function(){K.currentTime=R,K.muted=S._muted||g._muted||ct._muted||K.muted,K.volume=S._volume*ct.volume(),K.playbackRate=S._rate;try{var st=K.play();if(st&&typeof Promise<"u"&&(st instanceof Promise||typeof st.then=="function")?(g._playLock=!0,tt(),st.then(function(){g._playLock=!1,K._unlocked=!0,c?g._loadQueue():g._emit("play",S._id)}).catch(function(){g._playLock=!1,g._emit("playerror",S._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),S._ended=!0,S._paused=!0})):c||(g._playLock=!1,tt(),g._emit("play",S._id)),K.playbackRate=S._rate,K.paused){g._emit("playerror",S._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}f!=="__default"||S._loop?g._endTimers[S._id]=setTimeout(g._ended.bind(g,S),E):(g._endTimers[S._id]=function(){g._ended(S),K.removeEventListener("ended",g._endTimers[S._id],!1)},K.addEventListener("ended",g._endTimers[S._id],!1))}catch(dt){g._emit("playerror",S._id,dt)}};K.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(K.src=g._src,K.load());var ht=window&&window.ejecta||!K.readyState&&ct._navigator.isCocoonJS;if(K.readyState>=3||ht)Z();else{g._playLock=!0,g._state="loading";var at=function(){g._state="loaded",Z(),K.removeEventListener(ct._canPlayEvent,at,!1)};K.addEventListener(ct._canPlayEvent,at,!1),g._clearTimer(S._id)}}return S._id},pause:function(f){var c=this;if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"pause",action:function(){c.pause(f)}}),c;for(var g=c._getSoundIds(f),m=0;m<g.length;m++){c._clearTimer(g[m]);var C=c._soundById(g[m]);if(C&&!C._paused&&(C._seek=c.seek(g[m]),C._rateSeek=0,C._paused=!0,c._stopFade(g[m]),C._node))if(c._webAudio){if(!C._node.bufferSource)continue;typeof C._node.bufferSource.stop>"u"?C._node.bufferSource.noteOff(0):C._node.bufferSource.stop(0),c._cleanBuffer(C._node)}else(!isNaN(C._node.duration)||C._node.duration===1/0)&&C._node.pause();arguments[1]||c._emit("pause",C?C._id:null)}return c},stop:function(f,c){var g=this;if(g._state!=="loaded"||g._playLock)return g._queue.push({event:"stop",action:function(){g.stop(f)}}),g;for(var m=g._getSoundIds(f),C=0;C<m.length;C++){g._clearTimer(m[C]);var b=g._soundById(m[C]);b&&(b._seek=b._start||0,b._rateSeek=0,b._paused=!0,b._ended=!0,g._stopFade(m[C]),b._node&&(g._webAudio?b._node.bufferSource&&(typeof b._node.bufferSource.stop>"u"?b._node.bufferSource.noteOff(0):b._node.bufferSource.stop(0),g._cleanBuffer(b._node)):(!isNaN(b._node.duration)||b._node.duration===1/0)&&(b._node.currentTime=b._start||0,b._node.pause(),b._node.duration===1/0&&g._clearSound(b._node))),c||g._emit("stop",b._id))}return g},mute:function(f,c){var g=this;if(g._state!=="loaded"||g._playLock)return g._queue.push({event:"mute",action:function(){g.mute(f,c)}}),g;if(typeof c>"u")if(typeof f=="boolean")g._muted=f;else return g._muted;for(var m=g._getSoundIds(c),C=0;C<m.length;C++){var b=g._soundById(m[C]);b&&(b._muted=f,b._interval&&g._stopFade(b._id),g._webAudio&&b._node?b._node.gain.setValueAtTime(f?0:b._volume,ct.ctx.currentTime):b._node&&(b._node.muted=ct._muted?!0:f),g._emit("mute",b._id))}return g},volume:function(){var f=this,c=arguments,g,m;if(c.length===0)return f._volume;if(c.length===1||c.length===2&&typeof c[1]>"u"){var C=f._getSoundIds(),b=C.indexOf(c[0]);b>=0?m=parseInt(c[0],10):g=parseFloat(c[0])}else c.length>=2&&(g=parseFloat(c[0]),m=parseInt(c[1],10));var S;if(typeof g<"u"&&g>=0&&g<=1){if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"volume",action:function(){f.volume.apply(f,c)}}),f;typeof m>"u"&&(f._volume=g),m=f._getSoundIds(m);for(var x=0;x<m.length;x++)S=f._soundById(m[x]),S&&(S._volume=g,c[2]||f._stopFade(m[x]),f._webAudio&&S._node&&!S._muted?S._node.gain.setValueAtTime(g,ct.ctx.currentTime):S._node&&!S._muted&&(S._node.volume=g*ct.volume()),f._emit("volume",S._id))}else return S=m?f._soundById(m):f._sounds[0],S?S._volume:0;return f},fade:function(f,c,g,m){var C=this;if(C._state!=="loaded"||C._playLock)return C._queue.push({event:"fade",action:function(){C.fade(f,c,g,m)}}),C;f=Math.min(Math.max(0,parseFloat(f)),1),c=Math.min(Math.max(0,parseFloat(c)),1),g=parseFloat(g),C.volume(f,m);for(var b=C._getSoundIds(m),S=0;S<b.length;S++){var x=C._soundById(b[S]);if(x){if(m||C._stopFade(b[S]),C._webAudio&&!x._muted){var R=ct.ctx.currentTime,O=R+g/1e3;x._volume=f,x._node.gain.setValueAtTime(f,R),x._node.gain.linearRampToValueAtTime(c,O)}C._startFadeInterval(x,f,c,g,b[S],typeof m>"u")}}return C},_startFadeInterval:function(f,c,g,m,C,b){var S=this,x=c,R=g-c,O=Math.abs(R/.01),E=Math.max(4,O>0?m/O:m),V=Date.now();f._fadeTo=g,f._interval=setInterval(function(){var j=(Date.now()-V)/m;V=Date.now(),x+=R*j,x=Math.round(x*100)/100,R<0?x=Math.max(g,x):x=Math.min(g,x),S._webAudio?f._volume=x:S.volume(x,f._id,!0),b&&(S._volume=x),(g<c&&x<=g||g>c&&x>=g)&&(clearInterval(f._interval),f._interval=null,f._fadeTo=null,S.volume(g,f._id),S._emit("fade",f._id))},E)},_stopFade:function(f){var c=this,g=c._soundById(f);return g&&g._interval&&(c._webAudio&&g._node.gain.cancelScheduledValues(ct.ctx.currentTime),clearInterval(g._interval),g._interval=null,c.volume(g._fadeTo,f),g._fadeTo=null,c._emit("fade",f)),c},loop:function(){var f=this,c=arguments,g,m,C;if(c.length===0)return f._loop;if(c.length===1)if(typeof c[0]=="boolean")g=c[0],f._loop=g;else return C=f._soundById(parseInt(c[0],10)),C?C._loop:!1;else c.length===2&&(g=c[0],m=parseInt(c[1],10));for(var b=f._getSoundIds(m),S=0;S<b.length;S++)C=f._soundById(b[S]),C&&(C._loop=g,f._webAudio&&C._node&&C._node.bufferSource&&(C._node.bufferSource.loop=g,g&&(C._node.bufferSource.loopStart=C._start||0,C._node.bufferSource.loopEnd=C._stop,f.playing(b[S])&&(f.pause(b[S],!0),f.play(b[S],!0)))));return f},rate:function(){var f=this,c=arguments,g,m;if(c.length===0)m=f._sounds[0]._id;else if(c.length===1){var C=f._getSoundIds(),b=C.indexOf(c[0]);b>=0?m=parseInt(c[0],10):g=parseFloat(c[0])}else c.length===2&&(g=parseFloat(c[0]),m=parseInt(c[1],10));var S;if(typeof g=="number"){if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"rate",action:function(){f.rate.apply(f,c)}}),f;typeof m>"u"&&(f._rate=g),m=f._getSoundIds(m);for(var x=0;x<m.length;x++)if(S=f._soundById(m[x]),S){f.playing(m[x])&&(S._rateSeek=f.seek(m[x]),S._playStart=f._webAudio?ct.ctx.currentTime:S._playStart),S._rate=g,f._webAudio&&S._node&&S._node.bufferSource?S._node.bufferSource.playbackRate.setValueAtTime(g,ct.ctx.currentTime):S._node&&(S._node.playbackRate=g);var R=f.seek(m[x]),O=(f._sprite[S._sprite][0]+f._sprite[S._sprite][1])/1e3-R,E=O*1e3/Math.abs(S._rate);(f._endTimers[m[x]]||!S._paused)&&(f._clearTimer(m[x]),f._endTimers[m[x]]=setTimeout(f._ended.bind(f,S),E)),f._emit("rate",S._id)}}else return S=f._soundById(m),S?S._rate:f._rate;return f},seek:function(){var f=this,c=arguments,g,m;if(c.length===0)f._sounds.length&&(m=f._sounds[0]._id);else if(c.length===1){var C=f._getSoundIds(),b=C.indexOf(c[0]);b>=0?m=parseInt(c[0],10):f._sounds.length&&(m=f._sounds[0]._id,g=parseFloat(c[0]))}else c.length===2&&(g=parseFloat(c[0]),m=parseInt(c[1],10));if(typeof m>"u")return 0;if(typeof g=="number"&&(f._state!=="loaded"||f._playLock))return f._queue.push({event:"seek",action:function(){f.seek.apply(f,c)}}),f;var S=f._soundById(m);if(S)if(typeof g=="number"&&g>=0){var x=f.playing(m);x&&f.pause(m,!0),S._seek=g,S._ended=!1,f._clearTimer(m),!f._webAudio&&S._node&&!isNaN(S._node.duration)&&(S._node.currentTime=g);var R=function(){x&&f.play(m,!0),f._emit("seek",m)};if(x&&!f._webAudio){var O=function(){f._playLock?setTimeout(O,0):R()};setTimeout(O,0)}else R()}else if(f._webAudio){var E=f.playing(m)?ct.ctx.currentTime-S._playStart:0,V=S._rateSeek?S._rateSeek-S._seek:0;return S._seek+(V+E*Math.abs(S._rate))}else return S._node.currentTime;return f},playing:function(f){var c=this;if(typeof f=="number"){var g=c._soundById(f);return g?!g._paused:!1}for(var m=0;m<c._sounds.length;m++)if(!c._sounds[m]._paused)return!0;return!1},duration:function(f){var c=this,g=c._duration,m=c._soundById(f);return m&&(g=c._sprite[m._sprite][1]/1e3),g},state:function(){return this._state},unload:function(){for(var f=this,c=f._sounds,g=0;g<c.length;g++)c[g]._paused||f.stop(c[g]._id),f._webAudio||(f._clearSound(c[g]._node),c[g]._node.removeEventListener("error",c[g]._errorFn,!1),c[g]._node.removeEventListener(ct._canPlayEvent,c[g]._loadFn,!1),c[g]._node.removeEventListener("ended",c[g]._endFn,!1),ct._releaseHtml5Audio(c[g]._node)),delete c[g]._node,f._clearTimer(c[g]._id);var m=ct._howls.indexOf(f);m>=0&&ct._howls.splice(m,1);var C=!0;for(g=0;g<ct._howls.length;g++)if(ct._howls[g]._src===f._src||f._src.indexOf(ct._howls[g]._src)>=0){C=!1;break}return Kt&&C&&delete Kt[f._src],ct.noAudio=!1,f._state="unloaded",f._sounds=[],f=null,null},on:function(f,c,g,m){var C=this,b=C["_on"+f];return typeof c=="function"&&b.push(m?{id:g,fn:c,once:m}:{id:g,fn:c}),C},off:function(f,c,g){var m=this,C=m["_on"+f],b=0;if(typeof c=="number"&&(g=c,c=null),c||g)for(b=0;b<C.length;b++){var S=g===C[b].id;if(c===C[b].fn&&S||!c&&S){C.splice(b,1);break}}else if(f)m["_on"+f]=[];else{var x=Object.keys(m);for(b=0;b<x.length;b++)x[b].indexOf("_on")===0&&Array.isArray(m[x[b]])&&(m[x[b]]=[])}return m},once:function(f,c,g){var m=this;return m.on(f,c,g,1),m},_emit:function(f,c,g){for(var m=this,C=m["_on"+f],b=C.length-1;b>=0;b--)(!C[b].id||C[b].id===c||f==="load")&&(setTimeout((function(S){S.call(this,c,g)}).bind(m,C[b].fn),0),C[b].once&&m.off(f,C[b].fn,C[b].id));return m._loadQueue(f),m},_loadQueue:function(f){var c=this;if(c._queue.length>0){var g=c._queue[0];g.event===f&&(c._queue.shift(),c._loadQueue()),f||g.action()}return c},_ended:function(f){var c=this,g=f._sprite;if(!c._webAudio&&f._node&&!f._node.paused&&!f._node.ended&&f._node.currentTime<f._stop)return setTimeout(c._ended.bind(c,f),100),c;var m=!!(f._loop||c._sprite[g][2]);if(c._emit("end",f._id),!c._webAudio&&m&&c.stop(f._id,!0).play(f._id),c._webAudio&&m){c._emit("play",f._id),f._seek=f._start||0,f._rateSeek=0,f._playStart=ct.ctx.currentTime;var C=(f._stop-f._start)*1e3/Math.abs(f._rate);c._endTimers[f._id]=setTimeout(c._ended.bind(c,f),C)}return c._webAudio&&!m&&(f._paused=!0,f._ended=!0,f._seek=f._start||0,f._rateSeek=0,c._clearTimer(f._id),c._cleanBuffer(f._node),ct._autoSuspend()),!c._webAudio&&!m&&c.stop(f._id,!0),c},_clearTimer:function(f){var c=this;if(c._endTimers[f]){if(typeof c._endTimers[f]!="function")clearTimeout(c._endTimers[f]);else{var g=c._soundById(f);g&&g._node&&g._node.removeEventListener("ended",c._endTimers[f],!1)}delete c._endTimers[f]}return c},_soundById:function(f){for(var c=this,g=0;g<c._sounds.length;g++)if(f===c._sounds[g]._id)return c._sounds[g];return null},_inactiveSound:function(){var f=this;f._drain();for(var c=0;c<f._sounds.length;c++)if(f._sounds[c]._ended)return f._sounds[c].reset();return new ce(f)},_drain:function(){var f=this,c=f._pool,g=0,m=0;if(!(f._sounds.length<c)){for(m=0;m<f._sounds.length;m++)f._sounds[m]._ended&&g++;for(m=f._sounds.length-1;m>=0;m--){if(g<=c)return;f._sounds[m]._ended&&(f._webAudio&&f._sounds[m]._node&&f._sounds[m]._node.disconnect(0),f._sounds.splice(m,1),g--)}}},_getSoundIds:function(f){var c=this;if(typeof f>"u"){for(var g=[],m=0;m<c._sounds.length;m++)g.push(c._sounds[m]._id);return g}else return[f]},_refreshBuffer:function(f){var c=this;return f._node.bufferSource=ct.ctx.createBufferSource(),f._node.bufferSource.buffer=Kt[c._src],f._panner?f._node.bufferSource.connect(f._panner):f._node.bufferSource.connect(f._node),f._node.bufferSource.loop=f._loop,f._loop&&(f._node.bufferSource.loopStart=f._start||0,f._node.bufferSource.loopEnd=f._stop||0),f._node.bufferSource.playbackRate.setValueAtTime(f._rate,ct.ctx.currentTime),c},_cleanBuffer:function(f){var c=this,g=ct._navigator&&ct._navigator.vendor.indexOf("Apple")>=0;if(!f.bufferSource)return c;if(ct._scratchBuffer&&f.bufferSource&&(f.bufferSource.onended=null,f.bufferSource.disconnect(0),g))try{f.bufferSource.buffer=ct._scratchBuffer}catch{}return f.bufferSource=null,c},_clearSound:function(f){var c=/MSIE |Trident\//.test(ct._navigator&&ct._navigator.userAgent);c||(f.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var ce=function(f){this._parent=f,this.init()};ce.prototype={init:function(){var f=this,c=f._parent;return f._muted=c._muted,f._loop=c._loop,f._volume=c._volume,f._rate=c._rate,f._seek=0,f._paused=!0,f._ended=!0,f._sprite="__default",f._id=++ct._counter,c._sounds.push(f),f.create(),f},create:function(){var f=this,c=f._parent,g=ct._muted||f._muted||f._parent._muted?0:f._volume;return c._webAudio?(f._node=typeof ct.ctx.createGain>"u"?ct.ctx.createGainNode():ct.ctx.createGain(),f._node.gain.setValueAtTime(g,ct.ctx.currentTime),f._node.paused=!0,f._node.connect(ct.masterGain)):ct.noAudio||(f._node=ct._obtainHtml5Audio(),f._errorFn=f._errorListener.bind(f),f._node.addEventListener("error",f._errorFn,!1),f._loadFn=f._loadListener.bind(f),f._node.addEventListener(ct._canPlayEvent,f._loadFn,!1),f._endFn=f._endListener.bind(f),f._node.addEventListener("ended",f._endFn,!1),f._node.src=c._src,f._node.preload=c._preload===!0?"auto":c._preload,f._node.volume=g*ct.volume(),f._node.load()),f},reset:function(){var f=this,c=f._parent;return f._muted=c._muted,f._loop=c._loop,f._volume=c._volume,f._rate=c._rate,f._seek=0,f._rateSeek=0,f._paused=!0,f._ended=!0,f._sprite="__default",f._id=++ct._counter,f},_errorListener:function(){var f=this;f._parent._emit("loaderror",f._id,f._node.error?f._node.error.code:0),f._node.removeEventListener("error",f._errorFn,!1)},_loadListener:function(){var f=this,c=f._parent;c._duration=Math.ceil(f._node.duration*10)/10,Object.keys(c._sprite).length===0&&(c._sprite={__default:[0,c._duration*1e3]}),c._state!=="loaded"&&(c._state="loaded",c._emit("load"),c._loadQueue()),f._node.removeEventListener(ct._canPlayEvent,f._loadFn,!1)},_endListener:function(){var f=this,c=f._parent;c._duration===1/0&&(c._duration=Math.ceil(f._node.duration*10)/10,c._sprite.__default[1]===1/0&&(c._sprite.__default[1]=c._duration*1e3),c._ended(f)),f._node.removeEventListener("ended",f._endFn,!1)}};var Kt={},mi=function(f){var c=f._src;if(Kt[c]){f._duration=Kt[c].duration,oi(f);return}if(/^data:[^;]+;base64,/.test(c)){for(var g=atob(c.split(",")[1]),m=new Uint8Array(g.length),C=0;C<g.length;++C)m[C]=g.charCodeAt(C);Se(m.buffer,f)}else{var b=new XMLHttpRequest;b.open(f._xhr.method,c,!0),b.withCredentials=f._xhr.withCredentials,b.responseType="arraybuffer",f._xhr.headers&&Object.keys(f._xhr.headers).forEach(function(S){b.setRequestHeader(S,f._xhr.headers[S])}),b.onload=function(){var S=(b.status+"")[0];if(S!=="0"&&S!=="2"&&S!=="3"){f._emit("loaderror",null,"Failed loading audio file with status: "+b.status+".");return}Se(b.response,f)},b.onerror=function(){f._webAudio&&(f._html5=!0,f._webAudio=!1,f._sounds=[],delete Kt[c],f.load())},vi(b)}},vi=function(f){try{f.send()}catch{f.onerror()}},Se=function(f,c){var g=function(){c._emit("loaderror",null,"Decoding audio data failed.")},m=function(C){C&&c._sounds.length>0?(Kt[c._src]=C,oi(c,C)):g()};typeof Promise<"u"&&ct.ctx.decodeAudioData.length===1?ct.ctx.decodeAudioData(f).then(m).catch(g):ct.ctx.decodeAudioData(f,m,g)},oi=function(f,c){c&&!f._duration&&(f._duration=c.duration),Object.keys(f._sprite).length===0&&(f._sprite={__default:[0,f._duration*1e3]}),f._state!=="loaded"&&(f._state="loaded",f._emit("load"),f._loadQueue())},ae=function(){if(ct.usingWebAudio){try{typeof AudioContext<"u"?ct.ctx=new AudioContext:typeof webkitAudioContext<"u"?ct.ctx=new webkitAudioContext:ct.usingWebAudio=!1}catch{ct.usingWebAudio=!1}ct.ctx||(ct.usingWebAudio=!1);var f=/iP(hone|od|ad)/.test(ct._navigator&&ct._navigator.platform),c=ct._navigator&&ct._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),g=c?parseInt(c[1],10):null;if(f&&g&&g<9){var m=/safari/.test(ct._navigator&&ct._navigator.userAgent.toLowerCase());ct._navigator&&!m&&(ct.usingWebAudio=!1)}ct.usingWebAudio&&(ct.masterGain=typeof ct.ctx.createGain>"u"?ct.ctx.createGainNode():ct.ctx.createGain(),ct.masterGain.gain.setValueAtTime(ct._muted?0:ct._volume,ct.ctx.currentTime),ct.masterGain.connect(ct.ctx.destination)),ct._setup()}};_i(Ce,ct,le,ce);/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Barcode Reader JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 9.6.21 (js 20230803)
 * @fileoverview Dynamsoft JavaScript Library for Barcode Reader
 * More info on DBR JS: https://www.dynamsoft.com/barcode-reader/sdk-javascript/
 */const Xt=typeof self>"u",we=Xt?{}:self;let $t,Gt,ne,ue,At;if(typeof navigator<"u"&&($t=navigator,Gt=$t.userAgent,ne=$t.platform,ue=$t.mediaDevices),!Xt){const f={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:$t.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},c={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:ne,search:"Win"},Mac:{str:ne},Linux:{str:ne}};let g="unknownBrowser",m=0,C="unknownOS";for(let b in f){const S=f[b]||{};let x=S.str||Gt,R=S.search||b,O=S.verStr||Gt,E=S.verSearch||b;if(E instanceof Array||(E=[E]),x.indexOf(R)!=-1){g=b;for(let V of E){let j=O.indexOf(V);if(j!=-1){m=parseFloat(O.substring(j+V.length+1));break}}break}}for(let b in c){const S=c[b]||{};let x=S.str||Gt,R=S.search||b;if(x.indexOf(R)!=-1){C=b;break}}C=="Linux"&&Gt.indexOf("Windows NT")!=-1&&(C="HarmonyOS"),At={browser:g,version:m,OS:C}}Xt&&(At={browser:"ssr",version:0,OS:"ssr"});const yi=typeof WebAssembly<"u"&&Gt&&!(/Safari/.test(Gt)&&!/Chrome/.test(Gt)&&/\(.+\s11_2_([2-6]).*\)/.test(Gt)),Ci=!(typeof Worker>"u"),ai=!(!ue||!ue.getUserMedia),bi=async()=>{let f=!1;if(ai)try{(await ue.getUserMedia({video:!0})).getTracks().forEach(c=>{c.stop()}),f=!0}catch{}return f};At.browser==="Chrome"&&At.version>66||At.browser==="Safari"&&At.version>13||At.browser==="OPR"&&At.version>43||At.browser==="Edge"&&At.version;const Si=(()=>{if(!Xt&&document.currentScript){let f=document.currentScript.src,c=f.indexOf("?");if(c!=-1)f=f.substring(0,c);else{let g=f.indexOf("#");g!=-1&&(f=f.substring(0,g))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})(),te=" is not allowed to change after `createInstance` or `loadWasm` is called.",wi=!Xt&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID"))||"",xi=!Xt&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword")||"",xe=f=>{if(f==null)f=[];else{f=f instanceof Array?[...f]:[f];for(let c=0;c<f.length;++c){if(!Xt){let g=document.createElement("a");g.href=f[c],f[c]=g.href}f[c].endsWith("/")||(f[c]+="/")}}return f};var Ot,de,ve,Jt,fe;(function(f){f[f.IPF_Binary=0]="IPF_Binary",f[f.IPF_BinaryInverted=1]="IPF_BinaryInverted",f[f.IPF_GrayScaled=2]="IPF_GrayScaled",f[f.IPF_NV21=3]="IPF_NV21",f[f.IPF_RGB_565=4]="IPF_RGB_565",f[f.IPF_RGB_555=5]="IPF_RGB_555",f[f.IPF_RGB_888=6]="IPF_RGB_888",f[f.IPF_ARGB_8888=7]="IPF_ARGB_8888",f[f.IPF_RGB_161616=8]="IPF_RGB_161616",f[f.IPF_ARGB_16161616=9]="IPF_ARGB_16161616",f[f.IPF_ABGR_8888=10]="IPF_ABGR_8888",f[f.IPF_ABGR_16161616=11]="IPF_ABGR_16161616",f[f.IPF_BGR_888=12]="IPF_BGR_888"})(Ot||(Ot={})),function(f){f[f.DBR_SYSTEM_EXCEPTION=1]="DBR_SYSTEM_EXCEPTION",f[f.DBR_SUCCESS=0]="DBR_SUCCESS",f[f.DBR_UNKNOWN=-1e4]="DBR_UNKNOWN",f[f.DBR_NO_MEMORY=-10001]="DBR_NO_MEMORY",f[f.DBR_NULL_REFERENCE=-10002]="DBR_NULL_REFERENCE",f[f.DBR_LICENSE_INVALID=-10003]="DBR_LICENSE_INVALID",f[f.DBR_LICENSE_EXPIRED=-10004]="DBR_LICENSE_EXPIRED",f[f.DBR_FILE_NOT_FOUND=-10005]="DBR_FILE_NOT_FOUND",f[f.DBR_FILETYPE_NOT_SUPPORTED=-10006]="DBR_FILETYPE_NOT_SUPPORTED",f[f.DBR_BPP_NOT_SUPPORTED=-10007]="DBR_BPP_NOT_SUPPORTED",f[f.DBR_INDEX_INVALID=-10008]="DBR_INDEX_INVALID",f[f.DBR_BARCODE_FORMAT_INVALID=-10009]="DBR_BARCODE_FORMAT_INVALID",f[f.DBR_CUSTOM_REGION_INVALID=-10010]="DBR_CUSTOM_REGION_INVALID",f[f.DBR_MAX_BARCODE_NUMBER_INVALID=-10011]="DBR_MAX_BARCODE_NUMBER_INVALID",f[f.DBR_IMAGE_READ_FAILED=-10012]="DBR_IMAGE_READ_FAILED",f[f.DBR_TIFF_READ_FAILED=-10013]="DBR_TIFF_READ_FAILED",f[f.DBR_QR_LICENSE_INVALID=-10016]="DBR_QR_LICENSE_INVALID",f[f.DBR_1D_LICENSE_INVALID=-10017]="DBR_1D_LICENSE_INVALID",f[f.DBR_DIB_BUFFER_INVALID=-10018]="DBR_DIB_BUFFER_INVALID",f[f.DBR_PDF417_LICENSE_INVALID=-10019]="DBR_PDF417_LICENSE_INVALID",f[f.DBR_DATAMATRIX_LICENSE_INVALID=-10020]="DBR_DATAMATRIX_LICENSE_INVALID",f[f.DBR_PDF_READ_FAILED=-10021]="DBR_PDF_READ_FAILED",f[f.DBR_PDF_DLL_MISSING=-10022]="DBR_PDF_DLL_MISSING",f[f.DBR_PAGE_NUMBER_INVALID=-10023]="DBR_PAGE_NUMBER_INVALID",f[f.DBR_CUSTOM_SIZE_INVALID=-10024]="DBR_CUSTOM_SIZE_INVALID",f[f.DBR_CUSTOM_MODULESIZE_INVALID=-10025]="DBR_CUSTOM_MODULESIZE_INVALID",f[f.DBR_RECOGNITION_TIMEOUT=-10026]="DBR_RECOGNITION_TIMEOUT",f[f.DBR_JSON_PARSE_FAILED=-10030]="DBR_JSON_PARSE_FAILED",f[f.DBR_JSON_TYPE_INVALID=-10031]="DBR_JSON_TYPE_INVALID",f[f.DBR_JSON_KEY_INVALID=-10032]="DBR_JSON_KEY_INVALID",f[f.DBR_JSON_VALUE_INVALID=-10033]="DBR_JSON_VALUE_INVALID",f[f.DBR_JSON_NAME_KEY_MISSING=-10034]="DBR_JSON_NAME_KEY_MISSING",f[f.DBR_JSON_NAME_VALUE_DUPLICATED=-10035]="DBR_JSON_NAME_VALUE_DUPLICATED",f[f.DBR_TEMPLATE_NAME_INVALID=-10036]="DBR_TEMPLATE_NAME_INVALID",f[f.DBR_JSON_NAME_REFERENCE_INVALID=-10037]="DBR_JSON_NAME_REFERENCE_INVALID",f[f.DBR_PARAMETER_VALUE_INVALID=-10038]="DBR_PARAMETER_VALUE_INVALID",f[f.DBR_DOMAIN_NOT_MATCHED=-10039]="DBR_DOMAIN_NOT_MATCHED",f[f.DBR_RESERVEDINFO_NOT_MATCHED=-10040]="DBR_RESERVEDINFO_NOT_MATCHED",f[f.DBR_AZTEC_LICENSE_INVALID=-10041]="DBR_AZTEC_LICENSE_INVALID",f[f.DBR_LICENSE_DLL_MISSING=-10042]="DBR_LICENSE_DLL_MISSING",f[f.DBR_LICENSEKEY_NOT_MATCHED=-10043]="DBR_LICENSEKEY_NOT_MATCHED",f[f.DBR_REQUESTED_FAILED=-10044]="DBR_REQUESTED_FAILED",f[f.DBR_LICENSE_INIT_FAILED=-10045]="DBR_LICENSE_INIT_FAILED",f[f.DBR_PATCHCODE_LICENSE_INVALID=-10046]="DBR_PATCHCODE_LICENSE_INVALID",f[f.DBR_POSTALCODE_LICENSE_INVALID=-10047]="DBR_POSTALCODE_LICENSE_INVALID",f[f.DBR_DPM_LICENSE_INVALID=-10048]="DBR_DPM_LICENSE_INVALID",f[f.DBR_FRAME_DECODING_THREAD_EXISTS=-10049]="DBR_FRAME_DECODING_THREAD_EXISTS",f[f.DBR_STOP_DECODING_THREAD_FAILED=-10050]="DBR_STOP_DECODING_THREAD_FAILED",f[f.DBR_SET_MODE_ARGUMENT_ERROR=-10051]="DBR_SET_MODE_ARGUMENT_ERROR",f[f.DBR_LICENSE_CONTENT_INVALID=-10052]="DBR_LICENSE_CONTENT_INVALID",f[f.DBR_LICENSE_KEY_INVALID=-10053]="DBR_LICENSE_KEY_INVALID",f[f.DBR_LICENSE_DEVICE_RUNS_OUT=-10054]="DBR_LICENSE_DEVICE_RUNS_OUT",f[f.DBR_GET_MODE_ARGUMENT_ERROR=-10055]="DBR_GET_MODE_ARGUMENT_ERROR",f[f.DBR_IRT_LICENSE_INVALID=-10056]="DBR_IRT_LICENSE_INVALID",f[f.DBR_MAXICODE_LICENSE_INVALID=-10057]="DBR_MAXICODE_LICENSE_INVALID",f[f.DBR_GS1_DATABAR_LICENSE_INVALID=-10058]="DBR_GS1_DATABAR_LICENSE_INVALID",f[f.DBR_GS1_COMPOSITE_LICENSE_INVALID=-10059]="DBR_GS1_COMPOSITE_LICENSE_INVALID",f[f.DBR_PANORAMA_LICENSE_INVALID=-10060]="DBR_PANORAMA_LICENSE_INVALID",f[f.DBR_DOTCODE_LICENSE_INVALID=-10061]="DBR_DOTCODE_LICENSE_INVALID",f[f.DBR_PHARMACODE_LICENSE_INVALID=-10062]="DBR_PHARMACODE_LICENSE_INVALID",f[f.DBR_IMAGE_ORIENTATION_INVALID=-10063]="DBR_IMAGE_ORIENTATION_INVALID",f[f.DMERR_NO_LICENSE=-2e4]="DMERR_NO_LICENSE",f[f.DMERR_LICENSE_SYNC_FAILED=-20003]="DMERR_LICENSE_SYNC_FAILED",f[f.DMERR_TRIAL_LICENSE=-20010]="DMERR_TRIAL_LICENSE",f[f.DMERR_FAILED_TO_REACH_LTS=-20200]="DMERR_FAILED_TO_REACH_LTS"}(de||(de={})),function(f){f[f.IMRDT_IMAGE=1]="IMRDT_IMAGE",f[f.IMRDT_CONTOUR=2]="IMRDT_CONTOUR",f[f.IMRDT_LINESEGMENT=4]="IMRDT_LINESEGMENT",f[f.IMRDT_LOCALIZATIONRESULT=8]="IMRDT_LOCALIZATIONRESULT",f[f.IMRDT_REGIONOFINTEREST=16]="IMRDT_REGIONOFINTEREST",f[f.IMRDT_QUADRILATERAL=32]="IMRDT_QUADRILATERAL"}(ve||(ve={})),function(f){f[f.BF_ALL=-29360129]="BF_ALL",f[f.BF_ONED=3147775]="BF_ONED",f[f.BF_GS1_DATABAR=260096]="BF_GS1_DATABAR",f[f.BF_CODE_39=1]="BF_CODE_39",f[f.BF_CODE_128=2]="BF_CODE_128",f[f.BF_CODE_93=4]="BF_CODE_93",f[f.BF_CODABAR=8]="BF_CODABAR",f[f.BF_ITF=16]="BF_ITF",f[f.BF_EAN_13=32]="BF_EAN_13",f[f.BF_EAN_8=64]="BF_EAN_8",f[f.BF_UPC_A=128]="BF_UPC_A",f[f.BF_UPC_E=256]="BF_UPC_E",f[f.BF_INDUSTRIAL_25=512]="BF_INDUSTRIAL_25",f[f.BF_CODE_39_EXTENDED=1024]="BF_CODE_39_EXTENDED",f[f.BF_GS1_DATABAR_OMNIDIRECTIONAL=2048]="BF_GS1_DATABAR_OMNIDIRECTIONAL",f[f.BF_GS1_DATABAR_TRUNCATED=4096]="BF_GS1_DATABAR_TRUNCATED",f[f.BF_GS1_DATABAR_STACKED=8192]="BF_GS1_DATABAR_STACKED",f[f.BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL=16384]="BF_GS1_DATABAR_STACKED_OMNIDIRECTIONAL",f[f.BF_GS1_DATABAR_EXPANDED=32768]="BF_GS1_DATABAR_EXPANDED",f[f.BF_GS1_DATABAR_EXPANDED_STACKED=65536]="BF_GS1_DATABAR_EXPANDED_STACKED",f[f.BF_GS1_DATABAR_LIMITED=131072]="BF_GS1_DATABAR_LIMITED",f[f.BF_PATCHCODE=262144]="BF_PATCHCODE",f[f.BF_PDF417=33554432]="BF_PDF417",f[f.BF_QR_CODE=67108864]="BF_QR_CODE",f[f.BF_DATAMATRIX=134217728]="BF_DATAMATRIX",f[f.BF_AZTEC=268435456]="BF_AZTEC",f[f.BF_MAXICODE=536870912]="BF_MAXICODE",f[f.BF_MICRO_QR=1073741824]="BF_MICRO_QR",f[f.BF_MICRO_PDF417=524288]="BF_MICRO_PDF417",f[f.BF_GS1_COMPOSITE=-2147483648]="BF_GS1_COMPOSITE",f[f.BF_MSI_CODE=1048576]="BF_MSI_CODE",f[f.BF_CODE_11=2097152]="BF_CODE_11",f[f.BF_NULL=0]="BF_NULL"}(Jt||(Jt={})),function(f){f[f.IRT_NO_RESULT=0]="IRT_NO_RESULT",f[f.IRT_ORIGINAL_IMAGE=1]="IRT_ORIGINAL_IMAGE",f[f.IRT_COLOUR_CLUSTERED_IMAGE=2]="IRT_COLOUR_CLUSTERED_IMAGE",f[f.IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE=4]="IRT_COLOUR_CONVERTED_GRAYSCALE_IMAGE",f[f.IRT_TRANSFORMED_GRAYSCALE_IMAGE=8]="IRT_TRANSFORMED_GRAYSCALE_IMAGE",f[f.IRT_PREDETECTED_REGION=16]="IRT_PREDETECTED_REGION",f[f.IRT_PREPROCESSED_IMAGE=32]="IRT_PREPROCESSED_IMAGE",f[f.IRT_BINARIZED_IMAGE=64]="IRT_BINARIZED_IMAGE",f[f.IRT_TEXT_ZONE=128]="IRT_TEXT_ZONE",f[f.IRT_CONTOUR=256]="IRT_CONTOUR",f[f.IRT_LINE_SEGMENT=512]="IRT_LINE_SEGMENT",f[f.IRT_FORM=1024]="IRT_FORM",f[f.IRT_SEGMENTATION_BLOCK=2048]="IRT_SEGMENTATION_BLOCK",f[f.IRT_TYPED_BARCODE_ZONE=4096]="IRT_TYPED_BARCODE_ZONE",f[f.IRT_PREDETECTED_QUADRILATERAL=8192]="IRT_PREDETECTED_QUADRILATERAL"}(fe||(fe={}));const Te=f=>f&&typeof f=="object"&&typeof f.then=="function";let hi=class extends Promise{constructor(c){let g,m;super((C,b)=>{g=C,m=b}),this._s="pending",this.resolve=C=>{this.isPending&&(Te(C)?this.task=C:(this._s="fulfilled",g(C)))},this.reject=C=>{this.isPending&&(this._s="rejected",m(C))},this.task=c}get status(){return this._s}get isPending(){return this._s==="pending"}get isFulfilled(){return this._s==="fulfilled"}get isRejected(){return this._s==="rejected"}get task(){return this._task}set task(c){let g;this._task=c,Te(c)?g=c:typeof c=="function"&&(g=new Promise(c)),g&&(async()=>{try{const m=await g;c===this._task&&this.resolve(m)}catch(m){c===this._task&&this.reject(m)}})()}get isEmpty(){return this._task==null}};const me=["iPhone","iPad","Android","HarmonyOS"].includes(At.OS)?2048:4096;class z{constructor(){this._instanceID=void 0,this._ifSaveOriginalImageInACanvas=!1,this.oriCanvas=null,this.oriCanvasData=null,this.canvas=null,this.bFilterRegionInJs=!1,this._region=null,this._timeStartDecode=null,this._timeEnterInnerDBR=null,this._timeGetMessage=null,this.decodeRecords={},this.bDestroyed=!1,this._lastErrorCode=0,this._lastErrorString="",this._lastInnerDecodeDuration=0,this.intervalTime=0,this._intervalGetVideoFrame=0,this.array_getFrameTimeCost=[],this.array_decodeFrameTimeCost=[],this._indexCurrentDecodingFrame=0,this._arrPolygons=[],this._bPauseScan=!1,this._intervalDetectVideoPause=1e3,this._soundSource="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",this.bPlaySoundOnSuccessfulRead=!1,this.bVibrateOnSuccessfulRead=!1,this.vibrateDuration=300,this.captureAndDecodeInParallel=!0,this.autoSuggestTip=!1,this.suggestTipFrameArray=[],this.suggestTipFrameLimit=[5,3],this.noIntermediateResultsCount=0,this.noIntermediateResultsTipLimit=100,this.tinyBarcodeTipModuleSizeLimit=3,this.hugeBarcodeTipLimit=.9,this.autoZoomInFrameArray=[],this.autoZoomInFrameLimit=[5,3],this.autoZoomInStepRate=1/3,this.autoZoomInMaxStep=1.5,this.autoZoomInMaxTimes=5,this.autoZoomInMinStep=Math.pow(10,1/this.autoZoomInMaxTimes),this.autoZoomInIdealModuleSize=6,this.autoZoomOutFrameCount=0,this.autoZoomOutFrameLimit=3,this.autoZoomOutStepRate=1/3,this.autoZoomOutMinValue=1,this.autoZoomOutMinStep=2,this.autoZoomOutStepRate_2=.05,this.autoZoomOutMinValue_2=2,this.frameArrayInIdealZoom=[],this.frameLimitInIdealZoom=[5,3],this.enableZoomOutInIdealZoom=!1,this.nextActionInIdealZoom="focus",this.autoFocusFrameArray=[],this.autoFocusFrameLimit=[5,3],this.autoZoomIdealArea=[0,.05],this.autoZoomTargetBorder=.9,this.autoZoomDetectionArea=.5,this.autoZoom=!1,this.autoFocus=!1,this._resultHighlightingDuration=-1,this._dce=null,this._imgSource=null,this._maxCvsSideLength=me,this._promiseStartScan=null,this.beepSound=new le({src:[this._soundSource],onplayerror:(c,g)=>{console.warn(`Sound '${c}' playback failure: ${g}`)}})}static get version(){return this._version}static get license(){return this._license}static set license(c){((g,m)=>{const C=g;if(!C._pLoad.isEmpty)throw new Error("`license`"+te);C._license=m})(z,c)}static get productKeys(){return this._license}static set productKeys(c){z.license=c}static get handshakeCode(){return this._license}static set handshakeCode(c){z.license=c}static get organizationID(){return this._license}static set organizationID(c){z.license=c}static set sessionPassword(c){((g,m)=>{const C=g;if(!C._pLoad.isEmpty)throw new Error("`sessionPassword`"+te);C._sessionPassword=m})(z,c)}static get sessionPassword(){return this._sessionPassword}static async detectEnvironment(){return await(async()=>({wasm:yi,worker:Ci,getUserMedia:ai,camera:await bi(),browser:At.browser,version:At.version,OS:At.OS}))()}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(c){if(!this._pLoad.isEmpty)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` or `loadWasm` is called.");z._engineResourcePath=(g=>{if(g==null&&(g="./"),!Xt){let m=document.createElement("a");m.href=g,g=m.href}return g.endsWith("/")||(g+="/"),g})(c)}static get licenseServer(){return this._licenseServer}static set licenseServer(c){((g,m)=>{const C=g;if(!C._pLoad.isEmpty)throw new Error("`licenseServer`"+te);C._licenseServer=xe(m)})(z,c)}static get deviceFriendlyName(){return this._deviceFriendlyName}static set deviceFriendlyName(c){((g,m)=>{const C=g;if(!C._pLoad.isEmpty)throw new Error("`deviceFriendlyName`"+te);C._deviceFriendlyName=m||""})(z,c)}static get _bUseFullFeature(){return this.__bUseFullFeature}static set _bUseFullFeature(c){if(!this._pLoad.isEmpty)throw new Error("`_bUseFullFeature` is not allowed to change after `createInstance` or `loadWasm` is called.");z.__bUseFullFeature=c}static isImageSource(c){return!(!c||typeof c!="object"||Array.isArray(c))&&"getImage"in c}static isDSImage(c){return!(!c||typeof c!="object"||Array.isArray(c))&&"data"in c&&"width"in c&&"height"in c&&"pixelFormat"in c}static isDCEFrame(c){return!(!c||typeof c!="object"||Array.isArray(c))&&"data"in c&&"region"in c&&"sx"in c&&"sy"in c&&"width"in c&&"height"in c&&("colorMode"in c||"pixelFormat"in c)&&"timeSpent"in c&&"timeStamp"in c&&"isCropped"in c&&"toCanvas"in c&&"_sWidth"in c&&"_sHeight"in c&&"_bUseWebGL"in c}get ifSaveOriginalImageInACanvas(){return this._ifSaveOriginalImageInACanvas}set ifSaveOriginalImageInACanvas(c){this._ifSaveOriginalImageInACanvas=c}getOriginalImageInACanvas(){return!this.oriCanvas&&this.oriCanvasData?this.oriCanvasData.toCanvas():this.oriCanvas}set region(c){this._region=c,this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0}get region(){return this._region}static isWasmLoaded(){return this._pLoad.isFulfilled}isContextDestroyed(){return this.bDestroyed}static get lastErrorCode(){return this._lastErrorCode}static get lastErrorString(){return this._lastErrorString}get lastErrorCode(){return this._lastErrorCode}get lastErrorString(){return this._lastErrorString}static get defaultUIElementURL(){var c;return(c=z._defaultUIElementURL)===null||c===void 0?void 0:c.replace("@engineResourcePath/",z.engineResourcePath)}static set defaultUIElementURL(c){z._defaultUIElementURL=c}static _fireHTTPSWarnning(){z.onWarning&&location&&location.protocol!=="https:"&&setTimeout(()=>{z.onWarning&&z.onWarning({id:2,message:"Not connected via SSL (HTTPS), the SDK may not work correctly."})},0)}get soundSource(){return this._soundSource}set soundSource(c){this._soundSource=c,this.beepSound=new le({src:[this._soundSource],onplayerror:(g,m)=>{console.warn(`Sound '${g}' playback failure: ${m}`)}})}get whenToPlaySoundforSuccessfulRead(){return this.bPlaySoundOnSuccessfulRead===!0?"frame":this.bPlaySoundOnSuccessfulRead?this.bPlaySoundOnSuccessfulRead:"never"}set whenToPlaySoundforSuccessfulRead(c){this.bPlaySoundOnSuccessfulRead=c!=="never"&&c}get whenToVibrateforSuccessfulRead(){return this.bVibrateOnSuccessfulRead===!0?"frame":this.bVibrateOnSuccessfulRead?this.bVibrateOnSuccessfulRead:"never"}set whenToVibrateforSuccessfulRead(c){this.bVibrateOnSuccessfulRead=c!=="never"&&c}set dce(c){this._dce=c}get dce(){return!this._dce||this._dce.isDisposed||this._dce.disposed?null:this._dce}set maxCvsSideLength(c){this._maxCvsSideLength=c,this._dceControler&&this._dceControler.setDisiredValue(this,"maxCvsSideLength",c)}get maxCvsSideLength(){return this._maxCvsSideLength}async _registerDCEControler(){if(!this.dce)return;z._onLog&&z._onLog("_registerDCEControler()");const c=this.dce;this._dceControler=c._createControler();const g=this._dceControler;g.register(this),g.setDisiredValue(this,"refreshInterval",200),g.setDisiredValue(this,"maxCvsSideLength",this._maxCvsSideLength),this._styleIdBeforeVerification=this.dce.createDrawingStyle({fillStyle:"rgba(248,252,0,0.2)",strokeStyle:"transparent",paintMode:"strokeAndFill"});try{}catch(b){b.name==="ReferenceError"&&window&&(window.ResizeObserver=void 0)}const m=c.getUIElement(),C=this.dce.constructor;if(C._defaultUIElementURL==="@engineResourcePath/dce.ui.html")try{m?m===g._innerSetUI&&(await c.setUIElement(`${C.engineResourcePath}dce.ui.html`),g._innerSetUI=c.getUIElement()):(await c.setUIElement(`${C.engineResourcePath}dbr.ui.html`),g._innerSetUI=c.getUIElement())}catch{await c.setUIElement(C.defaultUIElementURL)}else m||await c.setUIElement(C.defaultUIElementURL);this.callbackCameraChange=()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackResolutionChange=()=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0},this.callbackCameraClose=()=>{this.stopScanning(!0),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._bPauseScan=!1},this.callbackSingleFrameAcquired=async b=>{this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null);let S=await this._decode_DCEFrame(b,{bCopyData:!1}),x=null;if(S&&S.length){const{sx:R,sy:O,width:E,height:V,_sWidth:j,_sHeight:tt}=b;x=S.map(K=>({localizationResult:JSON.parse(JSON.stringify(K.localizationResult))})),z.recalculateResultLocation(x,R,O,j,tt,E,V)}if(this._drawResults(x,S),await this.clearMapDecodeRecord(),this.onImageRead&&this.dce.isOpen()&&!this._bPauseScan){let R=this._cloneDecodeResults(S);this.onImageRead(R)}if(this.onUniqueRead&&this.dce.isOpen()&&!this._bPauseScan)for(let R of S)this.onUniqueRead(R.barcodeText,this._cloneDecodeResults(R))},c.on("cameraChange",this.callbackCameraChange),c.on("resolutionChange",this.callbackResolutionChange),c.on("cameraClose",this.callbackCameraClose),c.on("singleFrameAcquired",this.callbackSingleFrameAcquired)}_logoutDCEControler(){this.dce&&this._dceControler&&(z._onLog&&z._onLog("_logoutDCEControler()"),this._dceControler.logout(this),this.dce.off("cameraChange",this.callbackCameraChange),this.dce.off("resolutionChange",this.callbackResolutionChange),this.dce.off("cameraClose",this.callbackCameraClose),this.dce.off("singleFrameAcquired",this.callbackSingleFrameAcquired),this._dceControler=null,this.dce=null)}async setImageSource(c,g){if(c==null)return this._imgSource=null,this._logoutDCEControler(),void(this._drawingItemNamespace=null);if(c&&c.isCameraEnhancer)this.dce=c,await this._registerDCEControler(),this._imgSource=null;else{if(!z.isImageSource(c))throw new Error("Invalid value.");this._logoutDCEControler(),this._imgSource=c}g&&g.resultsHighlightBaseShapes&&(this._drawingItemNamespace=g.resultsHighlightBaseShapes)}static async loadWasm(){if(this._pLoad.isEmpty){let{lt:c,l:g,ls:m,sp:C,rmk:b}=(S=>{const x=S;if(x._pLoad.isEmpty){let R,O,E=x._license||"",V=JSON.parse(JSON.stringify(x._licenseServer)),j=x._sessionPassword,tt=0;if(E.startsWith("t")||E.startsWith("f"))tt=0;else if(E.length===0||E.startsWith("P")||E.startsWith("L")||E.startsWith("Y")||E.startsWith("A"))tt=1;else{tt=2;const K=E.indexOf(":");if(K!=-1&&(E=E.substring(K+1)),E.startsWith("DLS2")){let J;try{let Z=E.substring(4);Z=atob(Z),J=JSON.parse(Z)}catch{throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}if(E=J.handshakeCode?J.handshakeCode:J.organizationID?J.organizationID:"",typeof E=="number"&&(E=JSON.stringify(E)),V.length===0){let Z=[];J.mainServerURL&&(Z[0]=J.mainServerURL),J.standbyServerURL&&(Z[1]=J.standbyServerURL),V=xe(Z)}!j&&J.sessionPassword&&(j=J.sessionPassword),R=J.remark}(E==="200001"||E.startsWith("200001-"))&&(V&&V.length||(E="")),E||(tt=1)}if(tt&&(we.crypto||(O="Please upgrade your browser to support online key."),we.crypto.subtle||(O="Require https to use online key in this browser.")),O){if(tt!==1)throw new Error(O);tt=0,console.warn(O),x._lastErrorCode=-1,x._lastErrorString=O}return tt===1&&(E="",console.warn("Applying for a public trial license ...")),{lt:tt,l:E,ls:V,sp:j,rmk:R}}throw new Error("Can't preprocess license again"+te)})(z);this._pLoad.task=async(S,x)=>{let R=z.engineResourcePath+z._workerName;z.engineResourcePath.startsWith(location.origin)||(R=await fetch(R).then(O=>O.blob()).then(O=>URL.createObjectURL(O))),z._dbrWorker=new Worker(R),z._dbrWorker.onerror=O=>{let E=new Error(O.message);x(E)},z._dbrWorker.onmessage=async O=>{let E=O.data?O.data:O;switch(E.type){case"log":z._onLog&&z._onLog(E.message);break;case"load":{E.message&&(E.message=E.message.replace("(https://www.dynamsoft.com/purchase-center/)","(https://www.dynamsoft.com/store/dynamsoft-barcode-reader/#javascript)"));let V,j=!1;c===1&&(j=!0,E.message||(E.message="Using a temporary license. [Register for a 30-day trial license >>>](https://www.dynamsoft.com/customer/license/trialLicense?product=dbr&deploymenttype=browser)")),E.success?(z._dbrWorker.onerror=null,z._version=E.version+"(JS "+z._jsVersion+"."+z._jsEditVersion+")",z._onLog&&z._onLog("load dbr worker success"),E.message&&console.warn(E.message)):(V=new Error(E.message),V.stack=E.stack+`
`+V.stack,V.ltsErrorCode=E.ltsErrorCode,j||E.ltsErrorCode==111&&E.message.toLowerCase().indexOf("trial license")!=-1&&(j=!0)),j&&z.showDialog(E.success?"warn":"error",E.message),E.success?S():x(V);break}case"task":{let V=E.id,j=E.body;try{z._taskCallbackMap.get(V)(j),z._taskCallbackMap.delete(V)}catch(tt){throw z._taskCallbackMap.delete(V),tt}break}default:z._onLog&&z._onLog(O)}},z._dbrWorker.postMessage({type:"loadWasm",engineResourcePath:z.engineResourcePath,bUseFullFeature:z._bUseFullFeature,bd:z._bWasmDebug,v:z._jsVersion,brtk:!!c,bptk:c===1,l:g,dm:location.origin.startsWith("http")?location.origin:"https://localhost",os:At,cv:z.authCacheVersion,fn:z.deviceFriendlyName,ls:m,sp:C,rmk:b})}}await this._pLoad}static async showDialog(c,g){await(async(m,C,b)=>{if(!m._bNeverShowDialog)try{let S=await fetch(m.engineResourcePath+"dls.license.dialog.html");if(!S.ok)throw Error("Get license dialog fail. Network Error: "+S.statusText);let x=await S.text();if(!x.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let R=document.createElement("div");R.innerHTML=x;let O=[];for(let at=0;at<R.childElementCount;++at){let st=R.children[at];st instanceof HTMLStyleElement&&(O.push(st),document.head.append(st))}let E=R.childElementCount==1?R.children[0]:R;E.remove();let V,j,tt,K,J,Z=[E],ht=E.children;for(let at of ht)Z.push(at);for(let at=0;at<Z.length;++at)for(let st of Z[at].children)Z.push(st);for(let at of Z)if(!V&&at.classList.contains("dls-license-mask"))V=at,at.addEventListener("click",st=>{if(at==st.target){E.remove();for(let dt of O)dt.remove()}});else if(!j&&at.classList.contains("dls-license-icon-close"))j=at,at.addEventListener("click",()=>{E.remove();for(let st of O)st.remove()});else if(!tt&&at.classList.contains("dls-license-icon-error"))tt=at,C!="error"&&at.remove();else if(!K&&at.classList.contains("dls-license-icon-warn"))K=at,C!="warn"&&at.remove();else if(!J&&at.classList.contains("dls-license-msg-content")){J=at;let st=b;for(;st;){let dt=st.indexOf("["),gt=st.indexOf("]",dt),pt=st.indexOf("(",gt),vt=st.indexOf(")",pt);if(dt==-1||gt==-1||pt==-1||vt==-1){at.appendChild(new Text(st));break}dt>0&&at.appendChild(new Text(st.substring(0,dt)));let d=document.createElement("a"),mt=st.substring(dt+1,gt);d.innerText=mt;let Ct=st.substring(pt+1,vt);d.setAttribute("href",Ct),d.setAttribute("target","_blank"),at.appendChild(d),st=st.substring(vt+1)}}document.body.appendChild(E)}catch(S){m._onLog&&m._onLog(S.message||S)}})(this,c,g)}static async createInstanceInWorker(c=!1){return await z.loadWasm(),await new Promise((g,m)=>{let C=z._nextTaskID++;z._taskCallbackMap.set(C,b=>{if(b.success)return g(b.instanceID);{let S=new Error(b.message);return S.stack=b.stack+`
`+S.stack,m(S)}}),z._dbrWorker.postMessage({type:"createInstance",id:C,bScanner:c})})}static async createInstance(){const c=new z;return c._instanceID=await z.createInstanceInWorker(),z._fireHTTPSWarnning(),c}async clearMapDecodeRecord(){return await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success)return c();{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"clearMapDecodeRecord",id:m,instanceID:this._instanceID})})}async decode(c){z._onLog&&z._onLog("decode(source: any)"),z._onLog&&(this._timeStartDecode=Date.now());{let g={};return!this.region||this.region instanceof Array||(g.region=JSON.parse(JSON.stringify(this.region))),c instanceof Blob?await this._decode_Blob(c,g):c instanceof ArrayBuffer?await this._decode_ArrayBuffer(c,g):c instanceof Uint8Array||c instanceof Uint8ClampedArray?await this._decode_Uint8Array(c,g):c instanceof HTMLImageElement||typeof ImageBitmap<"u"&&c instanceof ImageBitmap?await this._decode_Image(c,g):c instanceof HTMLCanvasElement?await this._decode_Canvas(c,g):c instanceof HTMLVideoElement?await this._decode_Video(c,g):typeof c=="string"?c.substring(0,11)=="data:image/"?await this._decode_Base64(c,g):await this._decode_Url(c,g):z.isDCEFrame(c)?(g.bCopyData=!0,await this._decode_DCEFrame(c,g)):z.isDSImage(c)?(g.bCopyData=!0,await this._decode_DSImage(c,g)):await Promise.reject(TypeError("'_decode(source, config)': Type of 'source' should be 'Blob', 'ArrayBuffer', 'Uint8Array', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement', 'String(base64 with image mime)' or 'String(url)'."))}}async decodeBase64String(c){let g={};return!this.region||this.region instanceof Array||(g.region=JSON.parse(JSON.stringify(this.region))),this._decode_Base64(c,g)}async decodeUrl(c){let g={};return!this.region||this.region instanceof Array||(g.region=JSON.parse(JSON.stringify(this.region))),this._decode_Url(c,g)}async _decodeBuffer_Uint8Array(c,g,m,C,b,S,x){return await new Promise((R,O)=>{let E=z._nextTaskID++;z._taskCallbackMap.set(E,V=>{if(V.success){let j,tt=z._onLog?Date.now():0;z._onLog&&z._onLog("worker return result: "+tt),this._lastInnerDecodeDuration=V.duration;try{j=this._handleRetJsonString(V.decodeReturn)}catch(K){return O(K)}if(z._onLog){let K=Date.now();z._onLog("DBR getting message from worker timestamp: "+tt),z._onLog("From DBR staring decoding to entering worker costs: "+(this._timeEnterInnerDBR-this._timeStartDecode)),z._onLog("From DBR entering worker to returning message from worker costs: "+(tt-this._timeEnterInnerDBR)),z._onLog("Handling results from DBR worker costs: "+(K-tt)),z._onLog("Total decoding image costs: "+(K-this._timeStartDecode))}return R(j)}{let j=new Error(V.message);return j.stack=V.stack+`
`+j.stack,O(j)}}),this._timeEnterInnerDBR=Date.now(),z._onLog&&z._onLog("Sending buffer to worker timestamp:"+this._timeEnterInnerDBR),z._dbrWorker.postMessage({type:"decodeBuffer",id:E,instanceID:this._instanceID,body:{buffer:c,width:g,height:m,stride:C,format:b,orientation:S,config:x}},[c.buffer]),z._onLog&&x&&x.timeStamp&&z._onLog("Delay of decoding image: "+(this._timeEnterInnerDBR-x.timeStamp))})}async _decodeBuffer_Blob(c,g,m,C,b,S,x){z._onLog&&z._onLog("_decodeBuffer_Blob(buffer,width,height,stride,format)");const R=c.arrayBuffer?await c.arrayBuffer():await new Promise((O,E)=>{let V=new FileReader;V.readAsArrayBuffer(c),V.onload=()=>{O(V.result)},V.onerror=()=>{E(V.error)}});return await this._decodeBuffer_Uint8Array(new Uint8Array(R),g,m,C,b,S,x)}async decodeBuffer(c,g,m,C,b,S,x){let R;return z._onLog&&z._onLog("decodeBuffer(buffer,width,height,stride,format)"),z._onLog&&(this._timeStartDecode=Date.now()),c instanceof Uint8Array||c instanceof Uint8ClampedArray?R=await this._decodeBuffer_Uint8Array(c,g,m,C,b,S,x):c instanceof ArrayBuffer?R=await this._decodeBuffer_Uint8Array(new Uint8Array(c),g,m,C,b,S,x):c instanceof Blob&&(R=await this._decodeBuffer_Blob(c,g,m,C,b,S,x)),R}async _decodeFileInMemory_Uint8Array(c){return await new Promise((g,m)=>{let C=z._nextTaskID++;z._taskCallbackMap.set(C,b=>{if(b.success){let S;this._lastInnerDecodeDuration=b.duration;try{S=this._handleRetJsonString(b.decodeReturn)}catch(x){return m(x)}return g(S)}{let S=new Error(b.message);return S.stack=b.stack+`
`+S.stack,m(S)}}),z._dbrWorker.postMessage({type:"decodeFileInMemory",id:C,instanceID:this._instanceID,body:{bytes:c}})})}async getRuntimeSettings(){return await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success){let b=JSON.parse(C.results);return this.userDefinedRegion!=null&&(b.region=JSON.parse(JSON.stringify(this.userDefinedRegion))),c(b)}{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"getRuntimeSettings",id:m,instanceID:this._instanceID})})}async updateRuntimeSettings(c){let g;if(typeof c=="string")if(c=="speed"){let m=await this.getRuntimeSettings();await this.resetRuntimeSettings(),g=await this.getRuntimeSettings(),g.barcodeFormatIds=m.barcodeFormatIds,g.barcodeFormatIds_2=m.barcodeFormatIds_2,g.region=m.region,g.deblurLevel=3,g.expectedBarcodesCount=0,g.localizationModes=[2,0,0,0,0,0,0,0]}else if(c=="balance"){let m=await this.getRuntimeSettings();await this.resetRuntimeSettings(),g=await this.getRuntimeSettings(),g.barcodeFormatIds=m.barcodeFormatIds,g.barcodeFormatIds_2=m.barcodeFormatIds_2,g.region=m.region,g.deblurLevel=5,g.expectedBarcodesCount=512,g.localizationModes=[2,16,0,0,0,0,0,0]}else if(c=="coverage"){let m=await this.getRuntimeSettings();await this.resetRuntimeSettings(),g=await this.getRuntimeSettings(),g.barcodeFormatIds=m.barcodeFormatIds,g.barcodeFormatIds_2=m.barcodeFormatIds_2,g.region=m.region}else if(c=="dense"){let m=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,g=await this.getRuntimeSettings(),g.barcodeFormatIds=m.barcodeFormatIds,g.barcodeFormatIds_2=m.barcodeFormatIds_2,g.region=m.region,g.deblurLevel=9,g.expectedBarcodesCount=0,g.localizationModes=[2,8,0,0,0,0,0,0]}else if(c=="distance"){let m=await this.getRuntimeSettings();await this.resetRuntimeSettings(),this.maxCvsSideLength=4096,g=await this.getRuntimeSettings(),g.barcodeFormatIds=m.barcodeFormatIds,g.barcodeFormatIds_2=m.barcodeFormatIds_2,g.region=m.region,g.deblurLevel=3,g.expectedBarcodesCount=0,g.localizationModes=[2,8,0,0,0,0,0,0]}else g=JSON.parse(c);else{if(typeof c!="object")throw TypeError("'UpdateRuntimeSettings(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");if(g=JSON.parse(JSON.stringify(c)),g.region instanceof Array){let m=g.region;[m.regionLeft,m.regionTop,m.regionLeft,m.regionBottom,m.regionMeasuredByPercentage].some(C=>C!==void 0)&&(g.region={regionLeft:m.regionLeft||0,regionTop:m.regionTop||0,regionRight:m.regionRight||0,regionBottom:m.regionBottom||0,regionMeasuredByPercentage:m.regionMeasuredByPercentage||0})}}if(!z._bUseFullFeature){if(g.barcodeFormatIds&~(Jt.BF_ONED|Jt.BF_QR_CODE|Jt.BF_PDF417|Jt.BF_DATAMATRIX)||g.barcodeFormatIds_2!=0)throw Error("Some of the specified barcode formats are not supported in the compact version. Please try the full-featured version.");if(g.intermediateResultTypes!=0)throw Error("Intermediate results is not supported in the compact version. Please try the full-featured version.")}if(this.bFilterRegionInJs){let m=g.region;if(m instanceof Array)throw Error("The `region` of type `Array` is only allowed in `BarcodeScanner`.");this.userDefinedRegion=JSON.parse(JSON.stringify(m)),(m.regionLeft||m.regionTop||m.regionRight||m.regionBottom||m.regionMeasuredByPercentage)&&(m.regionLeft||m.regionTop||m.regionRight!=100||m.regionBottom!=100||!m.regionMeasuredByPercentage)?this.region=m:this.region=null,g.region={regionLeft:0,regionTop:0,regionRight:0,regionBottom:0,regionMeasuredByPercentage:0}}else this.userDefinedRegion=null,this.region=null;return(this.autoZoom||this.autoFocus)&&(g.intermediateResultTypes|=fe.IRT_TYPED_BARCODE_ZONE),await new Promise((m,C)=>{let b=z._nextTaskID++;z._taskCallbackMap.set(b,S=>{if(S.success){try{this._handleRetJsonString(S.updateReturn)}catch(x){C(x)}return m()}{let x=new Error(S.message);return x.stack=S.stack+`
`+x.stack,C(x)}}),z._dbrWorker.postMessage({type:"updateRuntimeSettings",id:b,instanceID:this._instanceID,body:{settings:JSON.stringify(g)}})})}async resetRuntimeSettings(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=me,await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success)return c();{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"resetRuntimeSettings",id:m,instanceID:this._instanceID})})}async _resetRuntimeSettingsToCppDefault(){return this.userDefinedRegion=null,this.region=null,this.maxCvsSideLength=me,await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success)return c();{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"resetRuntimeSettingsToCppDefault",id:m,instanceID:this._instanceID})})}async outputRuntimeSettingsToString(){if(!z._bUseFullFeature)throw Error("outputRuntimeSettingsToString() is not supported in the compact version. Please try the full-featured version.");return await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success)return c(C.results);{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"outputRuntimeSettingsToString",id:m,instanceID:this._instanceID})})}async initRuntimeSettingsWithString(c){if(!z._bUseFullFeature)throw Error("initRuntimeSettingsWithString() is not supported in the compact version. Please try the full-featured version.");if(typeof c=="string")c=c;else{if(typeof c!="object")throw TypeError("'initRuntimeSettingstWithString(settings)': Type of 'settings' should be 'string' or 'PlainObject'.");c=JSON.stringify(c)}return await new Promise((g,m)=>{let C=z._nextTaskID++;z._taskCallbackMap.set(C,b=>{if(b.success){try{this._handleRetJsonString(b.initReturn)}catch(S){m(S)}return g()}{let S=new Error(b.message);return S.stack=b.stack+`
`+S.stack,m(S)}}),z._dbrWorker.postMessage({type:"initRuntimeSettingsWithString",id:C,instanceID:this._instanceID,body:{settings:c}})})}async _decode_Blob(c,g){z._onLog&&z._onLog("_decode_Blob(blob: Blob)");let m=null,C=null;if(typeof createImageBitmap<"u")try{m=await createImageBitmap(c)}catch{}m||(C=await function(S){return new Promise((x,R)=>{let O=URL.createObjectURL(S),E=new Image;E.dbrObjUrl=O,E.src=O,E.onload=()=>{x(E)},E.onerror=V=>{R(new Error("Can't convert blob to image : "+(V instanceof Event?V.type:V)))}})}(c));let b=await this._decode_Image(m||C,g);return m&&m.close(),b}async _decode_ArrayBuffer(c,g){return await this._decode_Blob(new Blob([c]),g)}async _decode_Uint8Array(c,g){return await this._decode_Blob(new Blob([c]),g)}async _decode_Image(c,g){z._onLog&&z._onLog("_decode_Image(image: HTMLImageElement|ImageBitmap)"),g=g||{};let m,C,b=c instanceof HTMLImageElement?c.naturalWidth:c.width,S=c instanceof HTMLImageElement?c.naturalHeight:c.height,x=Math.max(b,S);if(x>this._maxCvsSideLength){let E=this._maxCvsSideLength/x;m=Math.round(b*E),C=Math.round(S*E)}else m=b,C=S;this.canvas||(this.canvas=document.createElement("canvas"));const R=this.canvas;R.width===m&&R.height===C||(R.width=m,R.height=C),R.ctx2d||(R.ctx2d=R.getContext("2d",{willReadFrequently:!0})),R.ctx2d.drawImage(c,0,0,b,S,0,0,m,C),c.dbrObjUrl&&URL.revokeObjectURL(c.dbrObjUrl);let O=await this._decode_Canvas(R,g);if(this.ifSaveOriginalImageInACanvas){const E=document.createElement("canvas");E.width=c.width,E.height=c.height,E.getContext("2d").drawImage(c,0,0),this.oriCanvas=E,this.oriCanvasData=null}return z.recalculateResultLocation(O,0,0,b,S,m,C),O}async _decode_Canvas(c,g){if(z._onLog&&z._onLog("_decode_Canvas(canvas:HTMLCanvasElement)"),c.crossOrigin&&c.crossOrigin!="anonymous")throw"cors";if(c.width===0||c.height===0)throw Error("The width or height of the 'canvas' is 0.");this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=c,this.oriCanvasData=null);let m=(c.ctx2d||c.getContext("2d",{willReadFrequently:!0})).getImageData(0,0,c.width,c.height).data;return await this._decodeBuffer_Uint8Array(m,c.width,c.height,4*c.width,Ot.IPF_ABGR_8888,0,g)}async _decode_Video(c,g){if(z._onLog&&z._onLog("_decode_Video(video)"),!(c instanceof HTMLVideoElement))throw TypeError("'_decode_Video(video [, config] )': Type of 'video' should be 'HTMLVideoElement'.");if(c.crossOrigin&&c.crossOrigin!="anonymous")throw"cors";g=g||{};let m,C,b=c.videoWidth,S=c.videoHeight,x=Math.max(b,S);if(x>this._maxCvsSideLength){let E=this._maxCvsSideLength/x;m=Math.round(b*E),C=Math.round(S*E)}else m=b,C=S;this.canvas||(this.canvas=document.createElement("canvas"));const R=this.canvas;R.width===m&&R.height===C||(R.width=m,R.height=C),R.ctx2d||(R.ctx2d=R.getContext("2d",{willReadFrequently:!0})),R.ctx2d.drawImage(c,0,0,b,S,0,0,m,C);let O=await this._decode_Canvas(R,g);if(this.ifSaveOriginalImageInACanvas){const E=document.createElement("canvas");E.width=c.videoWidth,E.height=c.videoHeight,E.getContext("2d").drawImage(c,0,0),this.oriCanvas=E,this.oriCanvasData=null}return z.recalculateResultLocation(O,0,0,b,S,m,C),O}async _decode_DCEFrame(c,g){if(z._onLog&&z._onLog("_decode_DCEFrame(dceFrame)"),!z.isDCEFrame(c))return[];let m=[];this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:c.width,height:c.height,colorMode:c.colorMode,pixelFormat:c.pixelFormat,data:new Uint8Array(c.data),toCanvas:c.toCanvas});const{width:C,height:b,colorMode:S,pixelFormat:x,stride:R,timeStamp:O}=c;let E;E=g&&g.bCopyData?new Uint8Array(c.data):c.data;let V=null;if(g?(V=JSON.parse(JSON.stringify(g)),V.timeStamp=O):V={timeStamp:O},x&&R)if(x==="grey")m=await this._decodeBuffer_Uint8Array(E,C,b,R,Ot.IPF_GrayScaled,0,V);else if(x==="rgba")m=await this._decodeBuffer_Uint8Array(E,C,b,R,Ot.IPF_ABGR_8888,0,V);else{if(x!=="bgra")throw new Error(`Pixel format '${x}' is not supported to decode.`);m=await this._decodeBuffer_Uint8Array(E,C,b,R,Ot.IPF_ARGB_8888,0,V)}else if(S==="grey")m=await this._decodeBuffer_Uint8Array(E,C,b,C,Ot.IPF_GrayScaled,0,V);else if(S==="rgba")m=await this._decodeBuffer_Uint8Array(E,C,b,4*C,Ot.IPF_ABGR_8888,0,V);else{if(S!=="bgra")throw new Error(`Color mode '${S}' is not supported to decode.`);m=await this._decodeBuffer_Uint8Array(E,C,b,4*C,Ot.IPF_ARGB_8888,0,V)}return m}async _decode_DSImage(c,g){if(z._onLog&&z._onLog("_decode_DSImage(dsImage)"),!z.isDSImage(c))return null;this.ifSaveOriginalImageInACanvas&&(this.oriCanvas=null,this.oriCanvasData={width:c.width,height:c.height,pixelFormat:c.pixelFormat.toLowerCase(),data:new Uint8Array(c.data),toCanvas:function(){const O=document.createElement("canvas");let E;switch(O.width=this.width,O.height=this.height,this.pixelFormat){case"grey":E=new Uint8ClampedArray(this.width*this.height*4);for(let j=0;j<E.length;j+=4)E[j]=this.data[j/4],E[j+1]=this.data[j/4],E[j+2]=this.data[j/4],E[j+3]=255;break;case"rgb":E=new Uint8ClampedArray(this.width*this.height*4);for(let j=0;j<E.length;j+=4)E[j]=this.data[j],E[j+1]=this.data[j+1],E[j+2]=this.data[j+2],E[j+3]=255;break;case"bgr":E=new Uint8ClampedArray(this.width*this.height*4);for(let j=0;j<E.length;j+=4)E[j]=this.data[j],E[j+1]=this.data[j+1],E[j+2]=this.data[j+2],E[j+3]=255;break;case"rgba":case"bgra":E=new Uint8ClampedArray(this.data);break;default:throw new Error("The content of 2D Canvas is currently limited to the sRGB color space.")}const V=new ImageData(E,this.width,this.height);return O.getContext("2d").putImageData(V,0,0),O}});const{width:m,height:C}=c;let b,S,x,R=c.pixelFormat.toLowerCase();switch(b=g&&g.bCopyData?new Uint8Array(c.data):c.data,R){case"grey":x=Ot.IPF_GrayScaled,S=m;break;case"rgb":x=Ot.IPF_BGR_888,S=3*m;break;case"bgr":x=Ot.IPF_RGB_888,S=3*m;break;case"rgba":x=Ot.IPF_ABGR_8888,S=4*m;break;case"bgra":x=Ot.IPF_ARGB_8888,S=4*m;break;default:throw new Error("The pixel format is not supported to decode.")}return await this._decodeBuffer_Uint8Array(b,m,C,S,x,0,g)}async _decode_Base64(c,g){if(z._onLog&&z._onLog("_decode_Base64(base64Str)"),typeof c!="string")return Promise.reject("'_decode_Base64(base64Str, config)': Type of 'base64Str' should be 'string'.");c.substring(0,11)=="data:image/"&&(c=c.substring(c.indexOf(",")+1));{let m=atob(c),C=m.length,b=new Uint8Array(C);for(;C--;)b[C]=m.charCodeAt(C);return await this._decode_Blob(new Blob([b]),g)}}async _decode_Url(c,g){if(z._onLog&&z._onLog("_decode_Url(url)"),typeof c!="string")throw TypeError("'_decode_Url(url, config)': Type of 'url' should be 'string'.");c=c;{let m=await new Promise((C,b)=>{let S=new XMLHttpRequest;S.open("GET",c,!0),S.responseType="blob",S.send(),S.onloadend=async()=>{C(S.response)},S.onerror=()=>{b(new Error("Network Error: "+S.statusText))}});return await this._decode_Blob(m,g)}}async _decode_FilePath(c,g){throw z._onLog&&z._onLog("_decode_FilePath(path)"),Error("'_decode_FilePath(path, config)': The method is only supported in node environment.")}static recalculateResultLocation(c,g,m,C,b,S,x){if(c.length>0)for(let R of c){let O=R.localizationResult;O.resultCoordinateType==2&&(O.x1*=.01*S,O.x2*=.01*S,O.x3*=.01*S,O.x4*=.01*S,O.y1*=.01*x,O.y2*=.01*x,O.y3*=.01*x,O.y4*=.01*x);let E=S/C,V=x/b;O.x1=O.x1/E+g,O.x2=O.x2/E+g,O.x3=O.x3/E+g,O.x4=O.x4/E+g,O.y1=O.y1/V+m,O.y2=O.y2/V+m,O.y3=O.y3/V+m,O.y4=O.y4/V+m,O.resultCoordinateType==2&&(O.x1*=100/C,O.x2*=100/C,O.x3*=100/C,O.x4*=100/C,O.y1*=100/b,O.y2*=100/b,O.y3*=100/b,O.y4*=100/b),O.x1=Math.round(O.x1),O.x2=Math.round(O.x2),O.x3=Math.round(O.x3),O.x4=Math.round(O.x4),O.y1=Math.round(O.y1),O.y2=Math.round(O.y2),O.y3=Math.round(O.y3),O.y4=Math.round(O.y4)}}static BarcodeReaderException(c,g){let m,C=de.DBR_UNKNOWN;return typeof c=="number"?(C=c,m=new Error(g)):m=new Error(c),m.code=C,m}_handleRetJsonString(c){let g=de;if(c.textResults){for(let m=0;m<c.textResults.length;m++){let C=c.textResults[m];try{let b=C.barcodeText,S="";for(let x=0;x<b.length;x++)S+=String.fromCharCode(b[x]);try{C.barcodeText=decodeURIComponent(escape(S))}catch{C.barcodeText=S}}catch{C.barcodeText=""}if(C.exception!=null){z._setWarnnedEx.has(C.exception)||(z._setWarnnedEx.add(C.exception),console.warn(C.exception));let b={};C.exception.split(";").forEach(S=>{let x=S.indexOf(":");b[S.substring(0,x)]=S.substring(x+1)}),C.exception=b}}return c.decodeRecords?this.decodeRecords=c.decodeRecords:this.decodeRecords={},this._lastErrorCode=c.exception,this._lastErrorString=c.description,c.exception&&!z._setWarnnedEx.has(c.description)&&(z._setWarnnedEx.add(c.description),console.warn(c.description)),c.textResults}if(c.exception==g.DBR_SUCCESS)return c.data;throw z.BarcodeReaderException(c.exception,c.description)}async setModeArgument(c,g,m,C){return await new Promise((b,S)=>{let x=z._nextTaskID++;z._taskCallbackMap.set(x,R=>{if(R.success){try{this._handleRetJsonString(R.setReturn)}catch(O){return S(O)}return b()}{let O=new Error(R.message);return O.stack=R.stack+`
`+O.stack,S(O)}}),z._dbrWorker.postMessage({type:"setModeArgument",id:x,instanceID:this._instanceID,body:{modeName:c,index:g,argumentName:m,argumentValue:C}})})}async getModeArgument(c,g,m){return await new Promise((C,b)=>{let S=z._nextTaskID++;z._taskCallbackMap.set(S,x=>{if(x.success){let R;try{R=this._handleRetJsonString(x.getReturn)}catch(O){return b(O)}return C(R)}{let R=new Error(x.message);return R.stack=x.stack+`
`+R.stack,b(R)}}),z._dbrWorker.postMessage({type:"getModeArgument",id:S,instanceID:this._instanceID,body:{modeName:c,index:g,argumentName:m}})})}async getIntermediateResults(){return await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success)return c(C.results);{let b=new Error(C.message);return b.stack=C.stack+`
`+b.stack,g(b)}}),z._dbrWorker.postMessage({type:"getIntermediateResults",id:m,instanceID:this._instanceID})})}async getIntermediateCanvas(){let c=await this.getIntermediateResults(),g=[];for(let m of c)if(m.dataType==ve.IMRDT_IMAGE)for(let C of m.results){const b=C.bytes;let S;switch(z._onLog&&z._onLog(" "+b.length+" "+b.byteLength+" "+C.width+" "+C.height+" "+C.stride+" "+C.format),C.format){case Ot.IPF_ABGR_8888:S=new Uint8ClampedArray(b);break;case Ot.IPF_RGB_888:{const O=b.length/3;S=new Uint8ClampedArray(4*O);for(let E=0;E<O;++E)S[4*E]=b[3*E+2],S[4*E+1]=b[3*E+1],S[4*E+2]=b[3*E],S[4*E+3]=255;break}case Ot.IPF_GrayScaled:{const O=b.length;S=new Uint8ClampedArray(4*O);for(let E=0;E<O;E++)S[4*E]=S[4*E+1]=S[4*E+2]=b[E],S[4*E+3]=255;break}case Ot.IPF_Binary:case Ot.IPF_BinaryInverted:{const O=b.length,E=C.width,V=C.height,j=C.stride;S=new Uint8ClampedArray(E*V*4);for(let tt=0;tt<O;tt++){let K=b[tt],J=tt%j*8,Z=Math.floor(tt/j);for(let ht=0;ht<8;ht++){let at=J+ht,st=4*(Z*E+at);if(at>=E)break;S[st]=S[st+1]=S[st+2]=(128&K)/128*255,S[st+3]=255,K<<=1}}break}default:console.warn("unknow intermediate image",C)}if(!S)continue;let x=new ImageData(S,C.width,C.height),R=document.createElement("canvas");R.width=C.width,R.height=C.height,R.getContext("2d").putImageData(x,0,0),g.push(R)}return g}async getScanSettings(){return await new Promise((c,g)=>{let m=z._nextTaskID++;z._taskCallbackMap.set(m,C=>{if(C.success){let b=C.results;return b.intervalTime=this.intervalTime,b.whenToPlaySoundforSuccessfulRead=this.whenToPlaySoundforSuccessfulRead,b.soundOnSuccessfullRead=this.soundSource,b.whenToVibrateforSuccessfulRead=this.whenToVibrateforSuccessfulRead,b.vibrateDuration=this.vibrateDuration,b.captureAndDecodeInParallel=this.captureAndDecodeInParallel,b.autoZoom=this.autoZoom,b.autoFocus=this.autoFocus,b.autoSuggestTip=this.autoSuggestTip,c(b)}{let b=new Error(C.message);return b.stack+=`
`+C.stack,g(b)}}),z._dbrWorker.postMessage({type:"getScanSettings",id:m,instanceID:this._instanceID})})}async updateScanSettings(c){if(!c)return;const g=JSON.parse(JSON.stringify(c));if(g.autoZoom||g.autoFocus||g.autoSuggestTip){if(!z._bUseFullFeature)throw new Error("'autoZoom', 'autoFocus' and 'autoSuggestTip' are not supported in the compact version. Please try the full-featured version.");const m=await this.getRuntimeSettings();m.intermediateResultTypes|=fe.IRT_TYPED_BARCODE_ZONE,await this.updateRuntimeSettings(m)}return g.hasOwnProperty("intervalTime")&&(this.intervalTime=Math.max(g.intervalTime,0),delete g.intervalTime),g.hasOwnProperty("whenToPlaySoundforSuccessfulRead")&&(this.whenToPlaySoundforSuccessfulRead=g.whenToPlaySoundforSuccessfulRead,delete g.whenToPlaySoundforSuccessfulRead),g.hasOwnProperty("soundOnSuccessfullRead")&&(this.soundSource=g.soundOnSuccessfullRead,delete g.soundOnSuccessfullRead),g.hasOwnProperty("whenToVibrateforSuccessfulRead")&&(this.whenToVibrateforSuccessfulRead=g.whenToVibrateforSuccessfulRead,delete g.whenToVibrateforSuccessfulRead),g.hasOwnProperty("vibrateDuration")&&(this.vibrateDuration=g.vibrateDuration,delete g.vibrateDuration),g.hasOwnProperty("captureAndDecodeInParallel")&&(this.captureAndDecodeInParallel=g.captureAndDecodeInParallel,delete g.captureAndDecodeInParallel),g.hasOwnProperty("autoZoom")&&(this.autoZoom&&this.autoZoom!=g.autoZoom&&this.dce&&this.dce.setZoom({factor:1}).catch(()=>{}),this.autoZoom=g.autoZoom,delete g.autoZoom),g.hasOwnProperty("autoFocus")&&(this.autoFocus=g.autoFocus,this.dce&&this.dce.setFocus({mode:"continuous"}).catch(()=>{}),delete g.autoFocus),g.hasOwnProperty("autoSuggestTip")&&(this.autoSuggestTip=g.autoSuggestTip,delete g.autoFocus),await new Promise((m,C)=>{let b=z._nextTaskID++;z._taskCallbackMap.set(b,S=>{if(S.success)return m();{let x=new Error(S.message);return x.stack+=`
`+S.stack,C(x)}}),z._dbrWorker.postMessage({type:"updateScanSettings",id:b,instanceID:this._instanceID,body:{settings:g}})})}_cloneDecodeResults(c){if(c instanceof Array){let g=[];for(let m of c)g.push(this._cloneDecodeResults(m));return g}return JSON.parse(JSON.stringify(c,(C,b)=>C=="oriVideoCanvas"||C=="searchRegionCanvas"?void 0:b))}async _loopReadVideo(){if(this.bDestroyed)return this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),void this._drawResults(null);if(this.dce&&!this.dce.isOpen())return this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),void await this.clearMapDecodeRecord();if(!this.dce&&!this._imgSource||this._bPauseScan)return z._onLog&&z._onLog("Scan is paused, or imageSource is not set. Ask in 1s."),await this.clearMapDecodeRecord(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this._intervalDetectVideoPause));z._onLog&&z._onLog("======= once read ======="),z._onLog&&(this._timeStartDecode=Date.now());let c=null,g=null;if(this.dce)c=this._getVideoFrame();else if(this._imgSource&&(g=await this._imgSource.getImage(),!z.isDSImage(g)))throw new Error("Invalid DSImage.");if(!c&&!g)return z._onLog&&z._onLog("Get invalid frame."),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),void(this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},0));(async()=>{let m=[];if(c){m=await this._decode_DCEFrame(c,{bScanner:!0,bCopyData:!1});let C=null;if(m&&m.length){const{sx:b,sy:S,width:x,height:R,_sWidth:O,_sHeight:E}=c;C=m.map(V=>({resultState:V.resultState,localizationResult:JSON.parse(JSON.stringify(V.localizationResult))})),z.recalculateResultLocation(C,b,S,O,E,x,R)}this._resultHighlightingDuration==0?this._drawResults(null):this._drawResults(C,m),this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._resultHighlightingDuration>0&&(this._clearResultsCanvasTimeoutId=setTimeout(()=>{this.bDestroyed||this._drawResults(null)},this._resultHighlightingDuration))}else g&&(m=await this._decode_DSImage(g,{bScanner:!0,bCopyData:!1}));return m})().then(m=>{if(z._onLog&&z._onLog(m),this.dce&&this.captureAndDecodeInParallel){let C=this.array_decodeFrameTimeCost,b=this.array_getFrameTimeCost;const S=()=>{let x=0;if(b&&b.length){let R=Math.min(...C),O=Math.max(...b);R&&O&&(x=R-O)}else x=0;return x>0?x:0};(()=>{for(;C.length>=5;)C.shift();C.push(this._lastInnerDecodeDuration)})(),this._intervalGetVideoFrame=S()+this.intervalTime}if((this.dce&&this.dce.isOpen()||this._imgSource)&&!this._bPauseScan){if(this.bPlaySoundOnSuccessfulRead&&m.length){let C=!1;this.bPlaySoundOnSuccessfulRead===!0||this.bPlaySoundOnSuccessfulRead==="frame"?C=m.some(b=>b.resultState>=0):this.bPlaySoundOnSuccessfulRead==="unique"&&(C=m.some(b=>b.resultState==0)),C&&this.beepSound&&(this.beepSound.stop(),this.beepSound.play())}if(navigator.vibrate&&this.bVibrateOnSuccessfulRead&&m.length){let C=!1;if(this.bVibrateOnSuccessfulRead===!0||this.bVibrateOnSuccessfulRead==="frame"?C=m.some(b=>b.resultState>=0):this.bVibrateOnSuccessfulRead==="unique"&&(C=m.some(b=>b.resultState==0)),C)try{navigator.vibrate(this.vibrateDuration)}catch(b){console.warn("Vibration not allowed. User interaction required: "+(b.message||b))}}if(this.onImageRead){m=m.filter(b=>b.resultState>=0);const C=this._cloneDecodeResults(m);this.onImageRead(C)}if(this.onUniqueRead){m=m.filter(b=>b.resultState==0);const C=this._cloneDecodeResults(m);for(let b of C)this.onUniqueRead(b.barcodeText,b)}}this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.intervalTime?this._loopReadVideoTimeoutId=setTimeout(()=>{this._loopReadVideo()},this.intervalTime):this._loopReadVideo()}).catch(m=>{this.dce&&this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),z._onLog&&z._onLog(m.message||m),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},Math.max(this.intervalTime,1e3)),m.message=="platform error"||console.warn(m.message)})}_getVideoFrame(){if(!this.dce)return null;let c;if(this.captureAndDecodeInParallel){if(z._onLog&&z._onLog("Get frame in parallel."),this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",this._intervalGetVideoFrame),!this.dce.numberOfFramesInBuffer)return this._dceControler&&this._dceControler.setDisiredValue(this,"loopInterval",0),null;c=this.dce.getFrameFromBuffer(),(m=>{if(!m)return;let C=m.timeSpent,b=this.array_getFrameTimeCost;for(;b.length>=5;)b.shift();b.push(C)})(c)}else z._onLog&&z._onLog("Get frame in serial."),this._dceControler&&this._dceControler.setDisiredAction(this,"stopFetchingLoop"),c=this.dce.getFrame();return c}_drawResults(c,g){if(!this.dce||this.dce.disposed||this._bPauseScan||!this._drawingItemNamespace||!this._drawingItemNamespace.DT_Polygon)return;if(!this._dbrDrawingLayer){if(!this.dce.isOpen()||!(this.dce.singleFrameMode||this.dce.video&&this.dce._videoTrack))return;this._dbrDrawingLayer=this.dce.getDrawingLayer(3)}const m=this._dbrDrawingLayer;c||(c=[]);let C=this._arrPolygons;for(let b=0;b<c.length;b++){let S,x=c[b].localizationResult;C[b]?(S=C[b],m.hasDrawingItem(S)||m.addDrawingItem(S),S.set("vertices",[{x:x.x1,y:x.y1},{x:x.x2,y:x.y2},{x:x.x3,y:x.y3},{x:x.x4,y:x.y4}]),(S.set||S.setAttribute).call(S,"vertices",[{x:x.x1,y:x.y1},{x:x.x2,y:x.y2},{x:x.x3,y:x.y3},{x:x.x4,y:x.y4}])):(S=new this._drawingItemNamespace.DT_Polygon([{x:x.x1,y:x.y1},{x:x.x2,y:x.y2},{x:x.x3,y:x.y3},{x:x.x4,y:x.y4}]),m.addDrawingItem(S),C[b]=S),c[b].resultState===-1?(S.styleId=this._styleIdBeforeVerification,S._mapStyle.set("default",this.dce.getDrawingStyle(this._styleIdBeforeVerification)),S._mapStyle.set("selected",this.dce.getDrawingStyle(this._styleIdBeforeVerification))):(S.styleId=null,S._mapStyle.set("default",this.dce.getDrawingStyle(3)),S._mapStyle.set("selected",this.dce.getDrawingStyle(7))),g&&g[b]?S.addNote({name:"Barcode_Result",content:g[b]},!0):S.addNote({name:"Barcode_Result",content:c[b]},!0)}for(let b=c.length;b<C.length;b++)C[b].deleteNote("Barcode_Result"),m.removeDrawingItem(C[b]);m.renderAll()}async startScanning(c){if(!this.dce&&!this._imgSource)throw new Error("'imageSource' is not set. call 'setImageSource()' before 'startScanning()'.");if(this._promiseStartScan&&this._promiseStartScan.isPending)return this._promiseStartScan;this._promiseStartScan=new hi;let g=null;if(this.dce){if(this.dce.isOpen())if(c&&this.dce.appendAndShowUI(),this.dce.playCallbackInfo)g=JSON.parse(JSON.stringify(this.dce.playCallbackInfo));else{const m=this.dce.getSelectedCamera();g={width:this.dce.video.videoWidth,height:this.dce.video.videoHeight,deviceId:m&&m.deviceId}}else if(g=await this.dce.open(c),!this._promiseStartScan)return null;this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"close"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}return this._bPauseScan=!1,this.dce&&this.dce.singleFrameMode||(this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout(()=>{this.dce&&(this.dce.startFetchingLoop(),this._dceControler&&this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"})),this._loopReadVideo()},0)),this._promiseStartScan.resolve(g),g}stopScanning(c){this.dce&&(this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),this._drawResults(null),this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"close",[c]))),this._bPauseScan=!0,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this.array_decodeFrameTimeCost.length=0,this.array_getFrameTimeCost.length=0,this._intervalGetVideoFrame=0,this._promiseStartScan=null}pauseScanning(c){if(this._clearResultsCanvasTimeoutId&&clearTimeout(this._clearResultsCanvasTimeoutId),c&&c.keepResultsHighlighted||this._drawResults(null),this._bPauseScan=!0,this.dce){if(this.dce.singleFrameMode)throw new Error("'pauseScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this._dceControler&&(this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!1),this.dce.ifShowScanRegionLaser||this.dce.hideScanRegionLaser(),this._dceControler.setDisiredAction(this,"stopFetchingLoop"))}}resumeScanning(){if(this._bPauseScan=!1,this.dce){if(this.dce.singleFrameMode)throw new Error("'resumeScanning()' is unavailable when property 'singleFrameMode' of the 'CameraEnhancer' instance is true.");this.dce.startFetchingLoop(),this._dceControler&&(this._dceControler.clearUserDisiredAction({user:this,actionName:"stopFetchingLoop"}),this._dceControler.setDisiredValue(this,"ifShowScanRegionLaser",!0),this.dce.ifShowScanRegionLaser&&this.dce.showScanRegionLaser())}}destroyContext(){if(z._onLog&&z._onLog("destroyContext()"),this.bDestroyed)return;this.bDestroyed=!0,(this.dce||this._promiseStartScan)&&this.stopScanning(),this.setImageSource(null);let c=z._nextTaskID++;z._taskCallbackMap.set(c,g=>{if(!g.success){let m=new Error(g.message);throw m.stack=g.stack+`
`+m.stack,m}}),z._dbrWorker.postMessage({type:"destroyContext",id:c,instanceID:this._instanceID})}}z._jsVersion="9.6.21",z._jsEditVersion="20230803",z._version=`loading...(JS ${z._jsVersion}.${z._jsEditVersion})`,z._license=wi,z._sessionPassword=xi,z.browserInfo=At,z._workerName=`dbr-${z._jsVersion}.browser.worker.js`,z._engineResourcePath=Si,z._licenseServer=[],z._deviceFriendlyName="",z._isShowRelDecodeTimeInResults=!1,z._bWasmDebug=!1,z._bNeverShowDialog=!1,z.__bUseFullFeature=!0,z._nextTaskID=0,z._taskCallbackMap=new Map,z._pLoad=new hi,z._lastErrorCode=0,z._lastErrorString="",z._setWarnnedEx=new Set,z._defaultUIElementURL="@engineResourcePath/dbr.ui.html";var Ti={653:(f,c,g)=>{var m,C,b,S,x,R,O,E,V,j,tt,K,J,Z,ht,at,st,dt,gt,pt,vt,d=d||{version:"5.2.1"};if(c.fabric=d,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?d.document=document:d.document=document.implementation.createHTMLDocument(""),d.window=window;else{var mt=new(g(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;d.document=mt.document,d.jsdomImplForWrapper=g(898).implForWrapper,d.nodeCanvas=g(245).Canvas,d.window=mt,DOMParser=d.window.DOMParser}function Ct(n,i){var r=n.canvas,o=i.targetCanvas,t=o.getContext("2d");t.translate(0,o.height),t.scale(1,-1);var e=r.height-o.height;t.drawImage(r,0,e,o.width,o.height,0,0,o.width,o.height)}function It(n,i){var r=i.targetCanvas.getContext("2d"),o=i.destinationWidth,t=i.destinationHeight,e=o*t*4,s=new Uint8Array(this.imageBuffer,0,e),l=new Uint8ClampedArray(this.imageBuffer,0,e);n.readPixels(0,0,o,t,n.RGBA,n.UNSIGNED_BYTE,s);var a=new ImageData(l,o,t);r.putImageData(a,0,0)}d.isTouchSupported="ontouchstart"in d.window||"ontouchstart"in d.document||d.window&&d.window.navigator&&d.window.navigator.maxTouchPoints>0,d.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",d.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],d.DPI=96,d.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",d.commaWsp="(?:\\s+,?\\s*|,\\s*)",d.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,d.reNonWord=/[ \n\.,;!\?\-]/,d.fontPaths={},d.iMatrix=[1,0,0,1,0,0],d.svgNS="http://www.w3.org/2000/svg",d.perfLimitSizeTotal=2097152,d.maxCacheSideLimit=4096,d.minCacheSideLimit=256,d.charWidthsCache={},d.textureSize=2048,d.disableStyleCopyPaste=!1,d.enableGLFiltering=!0,d.devicePixelRatio=d.window.devicePixelRatio||d.window.webkitDevicePixelRatio||d.window.mozDevicePixelRatio||1,d.browserShadowBlurConstant=1,d.arcToSegmentsCache={},d.boundsOfCurveCache={},d.cachesBoundsOfCurve=!0,d.forceGLPutImageData=!1,d.initFilterBackend=function(){return d.enableGLFiltering&&d.isWebglSupported&&d.isWebglSupported(d.textureSize)?(console.log("max texture size: "+d.maxTextureSize),new d.WebglFilterBackend({tileSize:d.textureSize})):d.Canvas2dFilterBackend?new d.Canvas2dFilterBackend:void 0},typeof document<"u"&&typeof window<"u"&&(window.fabric=d),function(){function n(r,o){if(this.__eventListeners[r]){var t=this.__eventListeners[r];o?t[t.indexOf(o)]=!1:d.util.array.fill(t,!1)}}function i(r,o){var t=(function(){o.apply(this,arguments),this.off(r,t)}).bind(this);this.on(r,t)}d.Observable={fire:function(r,o){if(!this.__eventListeners)return this;var t=this.__eventListeners[r];if(!t)return this;for(var e=0,s=t.length;e<s;e++)t[e]&&t[e].call(this,o||{});return this.__eventListeners[r]=t.filter(function(l){return l!==!1}),this},on:function(r,o){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var t in r)this.on(t,r[t]);else this.__eventListeners[r]||(this.__eventListeners[r]=[]),this.__eventListeners[r].push(o);return this},once:function(r,o){if(arguments.length===1)for(var t in r)i.call(this,t,r[t]);else i.call(this,r,o);return this},off:function(r,o){if(!this.__eventListeners)return this;if(arguments.length===0)for(r in this.__eventListeners)n.call(this,r);else if(arguments.length===1&&typeof arguments[0]=="object")for(var t in r)n.call(this,t,r[t]);else n.call(this,r,o);return this}}}(),d.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var n=0,i=arguments.length;n<i;n++)this._onObjectAdded(arguments[n]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(n,i,r){var o=this._objects;return r?o[i]=n:o.splice(i,0,n),this._onObjectAdded&&this._onObjectAdded(n),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var n,i=this._objects,r=!1,o=0,t=arguments.length;o<t;o++)(n=i.indexOf(arguments[o]))!==-1&&(r=!0,i.splice(n,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[o]));return this.renderOnAddRemove&&r&&this.requestRenderAll(),this},forEachObject:function(n,i){for(var r=this.getObjects(),o=0,t=r.length;o<t;o++)n.call(i,r[o],o,r);return this},getObjects:function(n){return n===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===n})},item:function(n){return this._objects[n]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(n,i){return this._objects.indexOf(n)>-1||!!i&&this._objects.some(function(r){return typeof r.contains=="function"&&r.contains(n,!0)})},complexity:function(){return this._objects.reduce(function(n,i){return n+(i.complexity?i.complexity():0)},0)}},d.CommonMethods={_setOptions:function(n){for(var i in n)this.set(i,n[i])},_initGradient:function(n,i){!n||!n.colorStops||n instanceof d.Gradient||this.set(i,new d.Gradient(n))},_initPattern:function(n,i,r){!n||!n.source||n instanceof d.Pattern?r&&r():this.set(i,new d.Pattern(n,r))},_setObject:function(n){for(var i in n)this._set(i,n[i])},set:function(n,i){return typeof n=="object"?this._setObject(n):this._set(n,i),this},_set:function(n,i){this[n]=i},toggle:function(n){var i=this.get(n);return typeof i=="boolean"&&this.set(n,!i),this},get:function(n){return this[n]}},m=c,C=Math.sqrt,b=Math.atan2,S=Math.pow,x=Math.PI/180,R=Math.PI/2,d.util={cos:function(n){if(n===0)return 1;switch(n<0&&(n=-n),n/R){case 1:case 3:return 0;case 2:return-1}return Math.cos(n)},sin:function(n){if(n===0)return 0;var i=1;switch(n<0&&(i=-1),n/R){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(n)},removeFromArray:function(n,i){var r=n.indexOf(i);return r!==-1&&n.splice(r,1),n},getRandomInt:function(n,i){return Math.floor(Math.random()*(i-n+1))+n},degreesToRadians:function(n){return n*x},radiansToDegrees:function(n){return n/x},rotatePoint:function(n,i,r){var o=new d.Point(n.x-i.x,n.y-i.y),t=d.util.rotateVector(o,r);return new d.Point(t.x,t.y).addEquals(i)},rotateVector:function(n,i){var r=d.util.sin(i),o=d.util.cos(i);return{x:n.x*o-n.y*r,y:n.x*r+n.y*o}},createVector:function(n,i){return new d.Point(i.x-n.x,i.y-n.y)},calcAngleBetweenVectors:function(n,i){return Math.acos((n.x*i.x+n.y*i.y)/(Math.hypot(n.x,n.y)*Math.hypot(i.x,i.y)))},getHatVector:function(n){return new d.Point(n.x,n.y).multiply(1/Math.hypot(n.x,n.y))},getBisector:function(n,i,r){var o=d.util.createVector(n,i),t=d.util.createVector(n,r),e=d.util.calcAngleBetweenVectors(o,t),s=e*(d.util.calcAngleBetweenVectors(d.util.rotateVector(o,e),t)===0?1:-1)/2;return{vector:d.util.getHatVector(d.util.rotateVector(o,s)),angle:e}},projectStrokeOnPoints:function(n,i,r){var o=[],t=i.strokeWidth/2,e=i.strokeUniform?new d.Point(1/i.scaleX,1/i.scaleY):new d.Point(1,1),s=function(l){var a=t/Math.hypot(l.x,l.y);return new d.Point(l.x*a*e.x,l.y*a*e.y)};return n.length<=1||n.forEach(function(l,a){var h,u,p=new d.Point(l.x,l.y);a===0?(u=n[a+1],h=r?s(d.util.createVector(u,p)).addEquals(p):n[n.length-1]):a===n.length-1?(h=n[a-1],u=r?s(d.util.createVector(h,p)).addEquals(p):n[0]):(h=n[a-1],u=n[a+1]);var _,y,v=d.util.getBisector(p,h,u),w=v.vector,T=v.angle;if(i.strokeLineJoin==="miter"&&(_=-t/Math.sin(T/2),y=new d.Point(w.x*_*e.x,w.y*_*e.y),Math.hypot(y.x,y.y)/t<=i.strokeMiterLimit))return o.push(p.add(y)),void o.push(p.subtract(y));_=-t*Math.SQRT2,y=new d.Point(w.x*_*e.x,w.y*_*e.y),o.push(p.add(y)),o.push(p.subtract(y))}),o},transformPoint:function(n,i,r){return r?new d.Point(i[0]*n.x+i[2]*n.y,i[1]*n.x+i[3]*n.y):new d.Point(i[0]*n.x+i[2]*n.y+i[4],i[1]*n.x+i[3]*n.y+i[5])},makeBoundingBoxFromPoints:function(n,i){if(i)for(var r=0;r<n.length;r++)n[r]=d.util.transformPoint(n[r],i);var o=[n[0].x,n[1].x,n[2].x,n[3].x],t=d.util.array.min(o),e=d.util.array.max(o)-t,s=[n[0].y,n[1].y,n[2].y,n[3].y],l=d.util.array.min(s);return{left:t,top:l,width:e,height:d.util.array.max(s)-l}},invertTransform:function(n){var i=1/(n[0]*n[3]-n[1]*n[2]),r=[i*n[3],-i*n[1],-i*n[2],i*n[0]],o=d.util.transformPoint({x:n[4],y:n[5]},r,!0);return r[4]=-o.x,r[5]=-o.y,r},toFixed:function(n,i){return parseFloat(Number(n).toFixed(i))},parseUnit:function(n,i){var r=/\D{0,2}$/.exec(n),o=parseFloat(n);switch(i||(i=d.Text.DEFAULT_SVG_FONT_SIZE),r[0]){case"mm":return o*d.DPI/25.4;case"cm":return o*d.DPI/2.54;case"in":return o*d.DPI;case"pt":return o*d.DPI/72;case"pc":return o*d.DPI/72*12;case"em":return o*i;default:return o}},falseFunction:function(){return!1},getKlass:function(n,i){return n=d.util.string.camelize(n.charAt(0).toUpperCase()+n.slice(1)),d.util.resolveNamespace(i)[n]},getSvgAttributes:function(n){var i=["instantiated_by_use","style","id","class"];switch(n){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(n){if(!n)return d;var i,r=n.split("."),o=r.length,t=m||d.window;for(i=0;i<o;++i)t=t[r[i]];return t},loadImage:function(n,i,r,o){if(n){var t=d.util.createImage(),e=function(){i&&i.call(r,t,!1),t=t.onload=t.onerror=null};t.onload=e,t.onerror=function(){d.log("Error loading "+t.src),i&&i.call(r,null,!0),t=t.onload=t.onerror=null},n.indexOf("data")!==0&&o!=null&&(t.crossOrigin=o),n.substring(0,14)==="data:image/svg"&&(t.onload=null,d.util.loadImageInDom(t,e)),t.src=n}else i&&i.call(r,n)},loadImageInDom:function(n,i){var r=d.document.createElement("div");r.style.width=r.style.height="1px",r.style.left=r.style.top="-100%",r.style.position="absolute",r.appendChild(n),d.document.querySelector("body").appendChild(r),n.onload=function(){i(),r.parentNode.removeChild(r),r=null}},enlivenObjects:function(n,i,r,o){var t=[],e=0,s=(n=n||[]).length;function l(){++e===s&&i&&i(t.filter(function(a){return a}))}s?n.forEach(function(a,h){a&&a.type?d.util.getKlass(a.type,r).fromObject(a,function(u,p){p||(t[h]=u),o&&o(a,u,p),l()}):l()}):i&&i(t)},enlivenObjectEnlivables:function(n,i,r){var o=d.Object.ENLIVEN_PROPS.filter(function(t){return!!n[t]});d.util.enlivenObjects(o.map(function(t){return n[t]}),function(t){var e={};o.forEach(function(s,l){e[s]=t[l],i&&(i[s]=t[l])}),r&&r(e)})},enlivenPatterns:function(n,i){function r(){++t===e&&i&&i(o)}var o=[],t=0,e=(n=n||[]).length;e?n.forEach(function(s,l){s&&s.source?new d.Pattern(s,function(a){o[l]=a,r()}):(o[l]=s,r())}):i&&i(o)},groupSVGElements:function(n,i,r){var o;return n&&n.length===1?n[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),o=new d.Group(n,i),r!==void 0&&(o.sourcePath=r),o)},populateWithProperties:function(n,i,r){if(r&&Array.isArray(r))for(var o=0,t=r.length;o<t;o++)r[o]in n&&(i[r[o]]=n[r[o]])},createCanvasElement:function(){return d.document.createElement("canvas")},copyCanvasElement:function(n){var i=d.util.createCanvasElement();return i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0),i},toDataURL:function(n,i,r){return n.toDataURL("image/"+i,r)},createImage:function(){return d.document.createElement("img")},multiplyTransformMatrices:function(n,i,r){return[n[0]*i[0]+n[2]*i[1],n[1]*i[0]+n[3]*i[1],n[0]*i[2]+n[2]*i[3],n[1]*i[2]+n[3]*i[3],r?0:n[0]*i[4]+n[2]*i[5]+n[4],r?0:n[1]*i[4]+n[3]*i[5]+n[5]]},qrDecompose:function(n){var i=b(n[1],n[0]),r=S(n[0],2)+S(n[1],2),o=C(r),t=(n[0]*n[3]-n[2]*n[1])/o,e=b(n[0]*n[2]+n[1]*n[3],r);return{angle:i/x,scaleX:o,scaleY:t,skewX:e/x,skewY:0,translateX:n[4],translateY:n[5]}},calcRotateMatrix:function(n){if(!n.angle)return d.iMatrix.concat();var i=d.util.degreesToRadians(n.angle),r=d.util.cos(i),o=d.util.sin(i);return[r,o,-o,r,0,0]},calcDimensionsMatrix:function(n){var i=n.scaleX===void 0?1:n.scaleX,r=n.scaleY===void 0?1:n.scaleY,o=[n.flipX?-i:i,0,0,n.flipY?-r:r,0,0],t=d.util.multiplyTransformMatrices,e=d.util.degreesToRadians;return n.skewX&&(o=t(o,[1,0,Math.tan(e(n.skewX)),1],!0)),n.skewY&&(o=t(o,[1,Math.tan(e(n.skewY)),0,1],!0)),o},composeMatrix:function(n){var i=[1,0,0,1,n.translateX||0,n.translateY||0],r=d.util.multiplyTransformMatrices;return n.angle&&(i=r(i,d.util.calcRotateMatrix(n))),(n.scaleX!==1||n.scaleY!==1||n.skewX||n.skewY||n.flipX||n.flipY)&&(i=r(i,d.util.calcDimensionsMatrix(n))),i},resetObjectTransform:function(n){n.scaleX=1,n.scaleY=1,n.skewX=0,n.skewY=0,n.flipX=!1,n.flipY=!1,n.rotate(0)},saveObjectTransform:function(n){return{scaleX:n.scaleX,scaleY:n.scaleY,skewX:n.skewX,skewY:n.skewY,angle:n.angle,left:n.left,flipX:n.flipX,flipY:n.flipY,top:n.top}},isTransparent:function(n,i,r,o){o>0&&(i>o?i-=o:i=0,r>o?r-=o:r=0);var t,e=!0,s=n.getImageData(i,r,2*o||1,2*o||1),l=s.data.length;for(t=3;t<l&&(e=s.data[t]<=0)!=0;t+=4);return s=null,e},parsePreserveAspectRatioAttribute:function(n){var i,r="meet",o=n.split(" ");return o&&o.length&&((r=o.pop())!=="meet"&&r!=="slice"?(i=r,r="meet"):o.length&&(i=o.pop())),{meetOrSlice:r,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(n){(n=(n||"").toLowerCase())?d.charWidthsCache[n]&&delete d.charWidthsCache[n]:d.charWidthsCache={}},limitDimsByArea:function(n,i){var r=Math.sqrt(i*n),o=Math.floor(i/r);return{x:Math.floor(r),y:o}},capValue:function(n,i,r){return Math.max(n,Math.min(i,r))},findScaleToFit:function(n,i){return Math.min(i.width/n.width,i.height/n.height)},findScaleToCover:function(n,i){return Math.max(i.width/n.width,i.height/n.height)},matrixToSVG:function(n){return"matrix("+n.map(function(i){return d.util.toFixed(i,d.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(n,i){var r=d.util.invertTransform(i),o=d.util.multiplyTransformMatrices(r,n.calcOwnMatrix());d.util.applyTransformToObject(n,o)},addTransformToObject:function(n,i){d.util.applyTransformToObject(n,d.util.multiplyTransformMatrices(i,n.calcOwnMatrix()))},applyTransformToObject:function(n,i){var r=d.util.qrDecompose(i),o=new d.Point(r.translateX,r.translateY);n.flipX=!1,n.flipY=!1,n.set("scaleX",r.scaleX),n.set("scaleY",r.scaleY),n.skewX=r.skewX,n.skewY=r.skewY,n.angle=r.angle,n.setPositionByOrigin(o,"center","center")},sizeAfterTransform:function(n,i,r){var o=n/2,t=i/2,e=[{x:-o,y:-t},{x:o,y:-t},{x:-o,y:t},{x:o,y:t}],s=d.util.calcDimensionsMatrix(r),l=d.util.makeBoundingBoxFromPoints(e,s);return{x:l.width,y:l.height}},mergeClipPaths:function(n,i){var r=n,o=i;r.inverted&&!o.inverted&&(r=i,o=n),d.util.applyTransformToObject(o,d.util.multiplyTransformMatrices(d.util.invertTransform(r.calcTransformMatrix()),o.calcTransformMatrix()));var t=r.inverted&&o.inverted;return t&&(r.inverted=o.inverted=!1),new d.Group([r],{clipPath:o,inverted:t})}},function(){var n=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},r={m:"l",M:"L"};function o(y,v,w,T,P,L,W,N,B,D,A){var k=d.util.cos(y),G=d.util.sin(y),H=d.util.cos(v),M=d.util.sin(v),I=w*P*H-T*L*M+W,F=T*P*H+w*L*M+N;return["C",D+B*(-w*P*G-T*L*k),A+B*(-T*P*G+w*L*k),I+B*(w*P*M+T*L*H),F+B*(T*P*M-w*L*H),I,F]}function t(y,v,w,T){var P=Math.atan2(v,y),L=Math.atan2(T,w);return L>=P?L-P:2*Math.PI-(P-L)}function e(y,v,w){for(var T=w[1],P=w[2],L=w[3],W=w[4],N=w[5],B=function(k,G,H,M,I,F,X){var U=Math.PI,Y=X*U/180,it=d.util.sin(Y),Q=d.util.cos(Y),q=0,et=0,$=-Q*k*.5-it*G*.5,rt=-Q*G*.5+it*k*.5,ot=(H=Math.abs(H))*H,nt=(M=Math.abs(M))*M,ut=rt*rt,ft=$*$,bt=ot*nt-ot*ut-nt*ft,Tt=0;if(bt<0){var Rt=Math.sqrt(1-bt/(ot*nt));H*=Rt,M*=Rt}else Tt=(I===F?-1:1)*Math.sqrt(bt/(ot*ut+nt*ft));var _t=Tt*H*rt/M,St=-Tt*M*$/H,Ft=Q*_t-it*St+.5*k,Mt=it*_t+Q*St+.5*G,Dt=t(1,0,($-_t)/H,(rt-St)/M),Pt=t(($-_t)/H,(rt-St)/M,(-$-_t)/H,(-rt-St)/M);F===0&&Pt>0?Pt-=2*U:F===1&&Pt<0&&(Pt+=2*U);for(var Qt=Math.ceil(Math.abs(Pt/U*2)),Vt=[],Bt=Pt/Qt,_e=8/3*Math.sin(Bt/4)*Math.sin(Bt/4)/Math.sin(Bt/2),Yt=Dt+Bt,jt=0;jt<Qt;jt++)Vt[jt]=o(Dt,Yt,Q,it,H,M,Ft,Mt,_e,q,et),q=Vt[jt][5],et=Vt[jt][6],Dt=Yt,Yt+=Bt;return Vt}(w[6]-y,w[7]-v,T,P,W,N,L),D=0,A=B.length;D<A;D++)B[D][1]+=y,B[D][2]+=v,B[D][3]+=y,B[D][4]+=v,B[D][5]+=y,B[D][6]+=v;return B}function s(y,v,w,T){return Math.sqrt((w-y)*(w-y)+(T-v)*(T-v))}function l(y,v,w,T,P,L,W,N){return function(B){var D,A=(D=B)*D*D,k=function(M){return 3*M*M*(1-M)}(B),G=function(M){return 3*M*(1-M)*(1-M)}(B),H=function(M){return(1-M)*(1-M)*(1-M)}(B);return{x:W*A+P*k+w*G+y*H,y:N*A+L*k+T*G+v*H}}}function a(y,v,w,T,P,L,W,N){return function(B){var D=1-B,A=3*D*D*(w-y)+6*D*B*(P-w)+3*B*B*(W-P),k=3*D*D*(T-v)+6*D*B*(L-T)+3*B*B*(N-L);return Math.atan2(k,A)}}function h(y,v,w,T,P,L){return function(W){var N,B=(N=W)*N,D=function(k){return 2*k*(1-k)}(W),A=function(k){return(1-k)*(1-k)}(W);return{x:P*B+w*D+y*A,y:L*B+T*D+v*A}}}function u(y,v,w,T,P,L){return function(W){var N=1-W,B=2*N*(w-y)+2*W*(P-w),D=2*N*(T-v)+2*W*(L-T);return Math.atan2(D,B)}}function p(y,v,w){var T,P,L={x:v,y:w},W=0;for(P=1;P<=100;P+=1)T=y(P/100),W+=s(L.x,L.y,T.x,T.y),L=T;return W}function _(y){for(var v,w,T,P,L=0,W=y.length,N=0,B=0,D=0,A=0,k=[],G=0;G<W;G++){switch(T={x:N,y:B,command:(v=y[G])[0]},v[0]){case"M":T.length=0,D=N=v[1],A=B=v[2];break;case"L":T.length=s(N,B,v[1],v[2]),N=v[1],B=v[2];break;case"C":w=l(N,B,v[1],v[2],v[3],v[4],v[5],v[6]),P=a(N,B,v[1],v[2],v[3],v[4],v[5],v[6]),T.iterator=w,T.angleFinder=P,T.length=p(w,N,B),N=v[5],B=v[6];break;case"Q":w=h(N,B,v[1],v[2],v[3],v[4]),P=u(N,B,v[1],v[2],v[3],v[4]),T.iterator=w,T.angleFinder=P,T.length=p(w,N,B),N=v[3],B=v[4];break;case"Z":case"z":T.destX=D,T.destY=A,T.length=s(N,B,D,A),N=D,B=A}L+=T.length,k.push(T)}return k.push({length:L,x:N,y:B}),k}d.util.joinPath=function(y){return y.map(function(v){return v.join(" ")}).join(" ")},d.util.parsePath=function(y){var v,w,T,P,L,W=[],N=[],B=d.rePathCommand,D="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",A="("+D+")"+d.commaWsp,k="([01])"+d.commaWsp+"?",G=new RegExp(A+"?"+A+"?"+A+k+k+A+"?("+D+")","g");if(!y||!y.match)return W;for(var H,M=0,I=(L=y.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;M<I;M++){P=(v=L[M]).slice(1).trim(),N.length=0;var F=v.charAt(0);if(H=[F],F.toLowerCase()==="a")for(var X;X=G.exec(P);)for(var U=1;U<X.length;U++)N.push(X[U]);else for(;T=B.exec(P);)N.push(T[0]);U=0;for(var Y=N.length;U<Y;U++)w=parseFloat(N[U]),isNaN(w)||H.push(w);var it=i[F.toLowerCase()],Q=r[F]||F;if(H.length-1>it)for(var q=1,et=H.length;q<et;q+=it)W.push([F].concat(H.slice(q,q+it))),F=Q;else W.push(H)}return W},d.util.makePathSimpler=function(y){var v,w,T,P,L,W,N=0,B=0,D=y.length,A=0,k=0,G=[];for(w=0;w<D;++w){switch(T=!1,(v=y[w].slice(0))[0]){case"l":v[0]="L",v[1]+=N,v[2]+=B;case"L":N=v[1],B=v[2];break;case"h":v[1]+=N;case"H":v[0]="L",v[2]=B,N=v[1];break;case"v":v[1]+=B;case"V":v[0]="L",B=v[1],v[1]=N,v[2]=B;break;case"m":v[0]="M",v[1]+=N,v[2]+=B;case"M":N=v[1],B=v[2],A=v[1],k=v[2];break;case"c":v[0]="C",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B,v[5]+=N,v[6]+=B;case"C":L=v[3],W=v[4],N=v[5],B=v[6];break;case"s":v[0]="S",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B;case"S":P==="C"?(L=2*N-L,W=2*B-W):(L=N,W=B),N=v[3],B=v[4],v[0]="C",v[5]=v[3],v[6]=v[4],v[3]=v[1],v[4]=v[2],v[1]=L,v[2]=W,L=v[3],W=v[4];break;case"q":v[0]="Q",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B;case"Q":L=v[1],W=v[2],N=v[3],B=v[4];break;case"t":v[0]="T",v[1]+=N,v[2]+=B;case"T":P==="Q"?(L=2*N-L,W=2*B-W):(L=N,W=B),v[0]="Q",N=v[1],B=v[2],v[1]=L,v[2]=W,v[3]=N,v[4]=B;break;case"a":v[0]="A",v[6]+=N,v[7]+=B;case"A":T=!0,G=G.concat(e(N,B,v)),N=v[6],B=v[7];break;case"z":case"Z":N=A,B=k}T||G.push(v),P=v[0]}return G},d.util.getSmoothPathFromPoints=function(y,v){var w,T=[],P=new d.Point(y[0].x,y[0].y),L=new d.Point(y[1].x,y[1].y),W=y.length,N=1,B=0,D=W>2;for(v=v||0,D&&(N=y[2].x<L.x?-1:y[2].x===L.x?0:1,B=y[2].y<L.y?-1:y[2].y===L.y?0:1),T.push(["M",P.x-N*v,P.y-B*v]),w=1;w<W;w++){if(!P.eq(L)){var A=P.midPointFrom(L);T.push(["Q",P.x,P.y,A.x,A.y])}P=y[w],w+1<y.length&&(L=y[w+1])}return D&&(N=P.x>y[w-2].x?1:P.x===y[w-2].x?0:-1,B=P.y>y[w-2].y?1:P.y===y[w-2].y?0:-1),T.push(["L",P.x+N*v,P.y+B*v]),T},d.util.getPathSegmentsInfo=_,d.util.getBoundsOfCurve=function(y,v,w,T,P,L,W,N){var B;if(d.cachesBoundsOfCurve&&(B=n.call(arguments),d.boundsOfCurveCache[B]))return d.boundsOfCurveCache[B];var D,A,k,G,H,M,I,F,X=Math.sqrt,U=Math.min,Y=Math.max,it=Math.abs,Q=[],q=[[],[]];A=6*y-12*w+6*P,D=-3*y+9*w-9*P+3*W,k=3*w-3*y;for(var et=0;et<2;++et)if(et>0&&(A=6*v-12*T+6*L,D=-3*v+9*T-9*L+3*N,k=3*T-3*v),it(D)<1e-12){if(it(A)<1e-12)continue;0<(G=-k/A)&&G<1&&Q.push(G)}else(I=A*A-4*k*D)<0||(0<(H=(-A+(F=X(I)))/(2*D))&&H<1&&Q.push(H),0<(M=(-A-F)/(2*D))&&M<1&&Q.push(M));for(var $,rt,ot,nt=Q.length,ut=nt;nt--;)$=(ot=1-(G=Q[nt]))*ot*ot*y+3*ot*ot*G*w+3*ot*G*G*P+G*G*G*W,q[0][nt]=$,rt=ot*ot*ot*v+3*ot*ot*G*T+3*ot*G*G*L+G*G*G*N,q[1][nt]=rt;q[0][ut]=y,q[1][ut]=v,q[0][ut+1]=W,q[1][ut+1]=N;var ft=[{x:U.apply(null,q[0]),y:U.apply(null,q[1])},{x:Y.apply(null,q[0]),y:Y.apply(null,q[1])}];return d.cachesBoundsOfCurve&&(d.boundsOfCurveCache[B]=ft),ft},d.util.getPointOnPath=function(y,v,w){w||(w=_(y));for(var T=0;v-w[T].length>0&&T<w.length-2;)v-=w[T].length,T++;var P,L=w[T],W=v/L.length,N=L.command,B=y[T];switch(N){case"M":return{x:L.x,y:L.y,angle:0};case"Z":case"z":return(P=new d.Point(L.x,L.y).lerp(new d.Point(L.destX,L.destY),W)).angle=Math.atan2(L.destY-L.y,L.destX-L.x),P;case"L":return(P=new d.Point(L.x,L.y).lerp(new d.Point(B[1],B[2]),W)).angle=Math.atan2(B[2]-L.y,B[1]-L.x),P;case"C":case"Q":return function(D,A){for(var k,G,H,M=0,I=0,F=D.iterator,X={x:D.x,y:D.y},U=.01,Y=D.angleFinder;I<A&&U>1e-4;)k=F(M),H=M,(G=s(X.x,X.y,k.x,k.y))+I>A?(M-=U,U/=2):(X=k,M+=U,I+=G);return k.angle=Y(H),k}(L,v)}},d.util.transformPath=function(y,v,w){return w&&(v=d.util.multiplyTransformMatrices(v,[1,0,0,1,-w.x,-w.y])),y.map(function(T){for(var P=T.slice(0),L={},W=1;W<T.length-1;W+=2)L.x=T[W],L.y=T[W+1],L=d.util.transformPoint(L,v),P[W]=L.x,P[W+1]=L.y;return P})}}(),function(){var n=Array.prototype.slice;function i(r,o,t){if(r&&r.length!==0){var e=r.length-1,s=o?r[e][o]:r[e];if(o)for(;e--;)t(r[e][o],s)&&(s=r[e][o]);else for(;e--;)t(r[e],s)&&(s=r[e]);return s}}d.util.array={fill:function(r,o){for(var t=r.length;t--;)r[t]=o;return r},invoke:function(r,o){for(var t=n.call(arguments,2),e=[],s=0,l=r.length;s<l;s++)e[s]=t.length?r[s][o].apply(r[s],t):r[s][o].call(r[s]);return e},min:function(r,o){return i(r,o,function(t,e){return t<e})},max:function(r,o){return i(r,o,function(t,e){return t>=e})}}}(),function(){function n(i,r,o){if(o)if(!d.isLikelyNode&&r instanceof Element)i=r;else if(r instanceof Array){i=[];for(var t=0,e=r.length;t<e;t++)i[t]=n({},r[t],o)}else if(r&&typeof r=="object")for(var s in r)s==="canvas"||s==="group"?i[s]=null:r.hasOwnProperty(s)&&(i[s]=n({},r[s],o));else i=r;else for(var s in r)i[s]=r[s];return i}d.util.object={extend:n,clone:function(i,r){return n({},i,r)}},d.util.object.extend(d.util,d.Observable)}(),function(){function n(i,r){var o=i.charCodeAt(r);if(isNaN(o))return"";if(o<55296||o>57343)return i.charAt(r);if(55296<=o&&o<=56319){if(i.length<=r+1)throw"High surrogate without following low surrogate";var t=i.charCodeAt(r+1);if(56320>t||t>57343)throw"High surrogate without following low surrogate";return i.charAt(r)+i.charAt(r+1)}if(r===0)throw"Low surrogate without preceding high surrogate";var e=i.charCodeAt(r-1);if(55296>e||e>56319)throw"Low surrogate without preceding high surrogate";return!1}d.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(r,o){return o?o.toUpperCase():""})},capitalize:function(i,r){return i.charAt(0).toUpperCase()+(r?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var r,o=0,t=[];for(o=0;o<i.length;o++)(r=n(i,o))!==!1&&t.push(r);return t}}}(),function(){var n=Array.prototype.slice,i=function(){},r=function(){for(var s in{toString:1})if(s==="toString")return!1;return!0}(),o=function(s,l,a){for(var h in l)h in s.prototype&&typeof s.prototype[h]=="function"&&(l[h]+"").indexOf("callSuper")>-1?s.prototype[h]=function(u){return function(){var p=this.constructor.superclass;this.constructor.superclass=a;var _=l[u].apply(this,arguments);if(this.constructor.superclass=p,u!=="initialize")return _}}(h):s.prototype[h]=l[h],r&&(l.toString!==Object.prototype.toString&&(s.prototype.toString=l.toString),l.valueOf!==Object.prototype.valueOf&&(s.prototype.valueOf=l.valueOf))};function t(){}function e(s){for(var l=null,a=this;a.constructor.superclass;){var h=a.constructor.superclass.prototype[s];if(a[s]!==h){l=h;break}a=a.constructor.superclass.prototype}return l?arguments.length>1?l.apply(this,n.call(arguments,1)):l.call(this):console.log("tried to callSuper "+s+", method not found in prototype chain",this)}d.util.createClass=function(){var s=null,l=n.call(arguments,0);function a(){this.initialize.apply(this,arguments)}typeof l[0]=="function"&&(s=l.shift()),a.superclass=s,a.subclasses=[],s&&(t.prototype=s.prototype,a.prototype=new t,s.subclasses.push(a));for(var h=0,u=l.length;h<u;h++)o(a,l[h],s);return a.prototype.initialize||(a.prototype.initialize=i),a.prototype.constructor=a,a.prototype.callSuper=e,a}}(),O=!!d.document.createElement("div").attachEvent,E=["touchstart","touchmove","touchend"],d.util.addListener=function(n,i,r,o){n&&n.addEventListener(i,r,!O&&o)},d.util.removeListener=function(n,i,r,o){n&&n.removeEventListener(i,r,!O&&o)},d.util.getPointer=function(n){var i=n.target,r=d.util.getScrollLeftTop(i),o=function(t){var e=t.changedTouches;return e&&e[0]?e[0]:t}(n);return{x:o.clientX+r.left,y:o.clientY+r.top}},d.util.isTouchEvent=function(n){return E.indexOf(n.type)>-1||n.pointerType==="touch"},j=typeof(V=d.document.createElement("div")).style.opacity=="string",tt=typeof V.style.filter=="string",K=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,J=function(n){return n},j?J=function(n,i){return n.style.opacity=i,n}:tt&&(J=function(n,i){var r=n.style;return n.currentStyle&&!n.currentStyle.hasLayout&&(r.zoom=1),K.test(r.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",r.filter=r.filter.replace(K,i)):r.filter+=" alpha(opacity="+100*i+")",n}),d.util.setStyle=function(n,i){var r=n.style;if(!r)return n;if(typeof i=="string")return n.style.cssText+=";"+i,i.indexOf("opacity")>-1?J(n,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):n;for(var o in i)o==="opacity"?J(n,i[o]):r[o==="float"||o==="cssFloat"?r.styleFloat===void 0?"cssFloat":"styleFloat":o]=i[o];return n},function(){var n,i,r,o,t=Array.prototype.slice,e=function(a){return t.call(a,0)};try{n=e(d.document.childNodes)instanceof Array}catch{}function s(a,h){var u=d.document.createElement(a);for(var p in h)p==="class"?u.className=h[p]:p==="for"?u.htmlFor=h[p]:u.setAttribute(p,h[p]);return u}function l(a){for(var h=0,u=0,p=d.document.documentElement,_=d.document.body||{scrollLeft:0,scrollTop:0};a&&(a.parentNode||a.host)&&((a=a.parentNode||a.host)===d.document?(h=_.scrollLeft||p.scrollLeft||0,u=_.scrollTop||p.scrollTop||0):(h+=a.scrollLeft||0,u+=a.scrollTop||0),a.nodeType!==1||a.style.position!=="fixed"););return{left:h,top:u}}n||(e=function(a){for(var h=new Array(a.length),u=a.length;u--;)h[u]=a[u];return h}),i=d.document.defaultView&&d.document.defaultView.getComputedStyle?function(a,h){var u=d.document.defaultView.getComputedStyle(a,null);return u?u[h]:void 0}:function(a,h){var u=a.style[h];return!u&&a.currentStyle&&(u=a.currentStyle[h]),u},r=d.document.documentElement.style,o="userSelect"in r?"userSelect":"MozUserSelect"in r?"MozUserSelect":"WebkitUserSelect"in r?"WebkitUserSelect":"KhtmlUserSelect"in r?"KhtmlUserSelect":"",d.util.makeElementUnselectable=function(a){return a.onselectstart!==void 0&&(a.onselectstart=d.util.falseFunction),o?a.style[o]="none":typeof a.unselectable=="string"&&(a.unselectable="on"),a},d.util.makeElementSelectable=function(a){return a.onselectstart!==void 0&&(a.onselectstart=null),o?a.style[o]="":typeof a.unselectable=="string"&&(a.unselectable=""),a},d.util.setImageSmoothing=function(a,h){a.imageSmoothingEnabled=a.imageSmoothingEnabled||a.webkitImageSmoothingEnabled||a.mozImageSmoothingEnabled||a.msImageSmoothingEnabled||a.oImageSmoothingEnabled,a.imageSmoothingEnabled=h},d.util.getById=function(a){return typeof a=="string"?d.document.getElementById(a):a},d.util.toArray=e,d.util.addClass=function(a,h){a&&(" "+a.className+" ").indexOf(" "+h+" ")===-1&&(a.className+=(a.className?" ":"")+h)},d.util.makeElement=s,d.util.wrapElement=function(a,h,u){return typeof h=="string"&&(h=s(h,u)),a.parentNode&&a.parentNode.replaceChild(h,a),h.appendChild(a),h},d.util.getScrollLeftTop=l,d.util.getElementOffset=function(a){var h,u,p=a&&a.ownerDocument,_={left:0,top:0},y={left:0,top:0},v={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!p)return y;for(var w in v)y[v[w]]+=parseInt(i(a,w),10)||0;return h=p.documentElement,a.getBoundingClientRect!==void 0&&(_=a.getBoundingClientRect()),u=l(a),{left:_.left+u.left-(h.clientLeft||0)+y.left,top:_.top+u.top-(h.clientTop||0)+y.top}},d.util.getNodeCanvas=function(a){var h=d.jsdomImplForWrapper(a);return h._canvas||h._image},d.util.cleanUpJsdomNode=function(a){if(d.isLikelyNode){var h=d.jsdomImplForWrapper(a);h&&(h._image=null,h._canvas=null,h._currentSrc=null,h._attributes=null,h._classList=null)}}}(),function(){function n(){}d.util.request=function(i,r){r||(r={});var o=r.method?r.method.toUpperCase():"GET",t=r.onComplete||function(){},e=new d.window.XMLHttpRequest,s=r.body||r.parameters;return e.onreadystatechange=function(){e.readyState===4&&(t(e),e.onreadystatechange=n)},o==="GET"&&(s=null,typeof r.parameters=="string"&&(i=function(l,a){return l+(/\?/.test(l)?"&":"?")+a}(i,r.parameters))),e.open(o,i,!0),o!=="POST"&&o!=="PUT"||e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(s),e}}(),d.log=console.log,d.warn=console.warn,function(){var n=d.util.object.extend,i=d.util.object.clone,r=[];function o(){return!1}function t(a,h,u,p){return-u*Math.cos(a/p*(Math.PI/2))+u+h}d.util.object.extend(r,{cancelAll:function(){var a=this.splice(0);return a.forEach(function(h){h.cancel()}),a},cancelByCanvas:function(a){if(!a)return[];var h=this.filter(function(u){return typeof u.target=="object"&&u.target.canvas===a});return h.forEach(function(u){u.cancel()}),h},cancelByTarget:function(a){var h=this.findAnimationsByTarget(a);return h.forEach(function(u){u.cancel()}),h},findAnimationIndex:function(a){return this.indexOf(this.findAnimation(a))},findAnimation:function(a){return this.find(function(h){return h.cancel===a})},findAnimationsByTarget:function(a){return a?this.filter(function(h){return h.target===a}):[]}});var e=d.window.requestAnimationFrame||d.window.webkitRequestAnimationFrame||d.window.mozRequestAnimationFrame||d.window.oRequestAnimationFrame||d.window.msRequestAnimationFrame||function(a){return d.window.setTimeout(a,1e3/60)},s=d.window.cancelAnimationFrame||d.window.clearTimeout;function l(){return e.apply(d.window,arguments)}d.util.animate=function(a){a||(a={});var h,u=!1,p=function(){var _=d.runningAnimations.indexOf(h);return _>-1&&d.runningAnimations.splice(_,1)[0]};return h=n(i(a),{cancel:function(){return u=!0,p()},currentValue:"startValue"in a?a.startValue:0,completionRate:0,durationRate:0}),d.runningAnimations.push(h),l(function(_){var y,v=_||+new Date,w=a.duration||500,T=v+w,P=a.onChange||o,L=a.abort||o,W=a.onComplete||o,N=a.easing||t,B="startValue"in a&&a.startValue.length>0,D="startValue"in a?a.startValue:0,A="endValue"in a?a.endValue:100,k=a.byValue||(B?D.map(function(G,H){return A[H]-D[H]}):A-D);a.onStart&&a.onStart(),function G(H){var M=(y=H||+new Date)>T?w:y-v,I=M/w,F=B?D.map(function(U,Y){return N(M,D[Y],k[Y],w)}):N(M,D,k,w),X=Math.abs(B?(F[0]-D[0])/k[0]:(F-D)/k);if(h.currentValue=B?F.slice():F,h.completionRate=X,h.durationRate=I,!u){if(!L(F,X,I))return y>T?(h.currentValue=B?A.slice():A,h.completionRate=1,h.durationRate=1,P(B?A.slice():A,1,1),W(A,1,1),void p()):(P(F,X,I),void l(G));p()}}(v)}),h.cancel},d.util.requestAnimFrame=l,d.util.cancelAnimFrame=function(){return s.apply(d.window,arguments)},d.runningAnimations=r}(),function(){function n(i,r,o){var t="rgba("+parseInt(i[0]+o*(r[0]-i[0]),10)+","+parseInt(i[1]+o*(r[1]-i[1]),10)+","+parseInt(i[2]+o*(r[2]-i[2]),10);return(t+=","+(i&&r?parseFloat(i[3]+o*(r[3]-i[3])):1))+")"}d.util.animateColor=function(i,r,o,t){var e=new d.Color(i).getSource(),s=new d.Color(r).getSource(),l=t.onComplete,a=t.onChange;return t=t||{},d.util.animate(d.util.object.extend(t,{duration:o||500,startValue:e,endValue:s,byValue:s,easing:function(h,u,p,_){return n(u,p,t.colorEasing?t.colorEasing(h,_):1-Math.cos(h/_*(Math.PI/2)))},onComplete:function(h,u,p){if(l)return l(n(s,s,0),u,p)},onChange:function(h,u,p){if(a){if(Array.isArray(h))return a(n(h,h,0),u,p);a(h,u,p)}}}))}}(),function(){function n(t,e,s,l){return t<Math.abs(e)?(t=e,l=s/4):l=e===0&&t===0?s/(2*Math.PI)*Math.asin(1):s/(2*Math.PI)*Math.asin(e/t),{a:t,c:e,p:s,s:l}}function i(t,e,s){return t.a*Math.pow(2,10*(e-=1))*Math.sin((e*s-t.s)*(2*Math.PI)/t.p)}function r(t,e,s,l){return s-o(l-t,0,s,l)+e}function o(t,e,s,l){return(t/=l)<1/2.75?s*(7.5625*t*t)+e:t<2/2.75?s*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?s*(7.5625*(t-=2.25/2.75)*t+.9375)+e:s*(7.5625*(t-=2.625/2.75)*t+.984375)+e}d.util.ease={easeInQuad:function(t,e,s,l){return s*(t/=l)*t+e},easeOutQuad:function(t,e,s,l){return-s*(t/=l)*(t-2)+e},easeInOutQuad:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t+e:-s/2*(--t*(t-2)-1)+e},easeInCubic:function(t,e,s,l){return s*(t/=l)*t*t+e},easeOutCubic:function(t,e,s,l){return s*((t=t/l-1)*t*t+1)+e},easeInOutCubic:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t+e:s/2*((t-=2)*t*t+2)+e},easeInQuart:function(t,e,s,l){return s*(t/=l)*t*t*t+e},easeOutQuart:function(t,e,s,l){return-s*((t=t/l-1)*t*t*t-1)+e},easeInOutQuart:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t*t+e:-s/2*((t-=2)*t*t*t-2)+e},easeInQuint:function(t,e,s,l){return s*(t/=l)*t*t*t*t+e},easeOutQuint:function(t,e,s,l){return s*((t=t/l-1)*t*t*t*t+1)+e},easeInOutQuint:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t*t*t+e:s/2*((t-=2)*t*t*t*t+2)+e},easeInSine:function(t,e,s,l){return-s*Math.cos(t/l*(Math.PI/2))+s+e},easeOutSine:function(t,e,s,l){return s*Math.sin(t/l*(Math.PI/2))+e},easeInOutSine:function(t,e,s,l){return-s/2*(Math.cos(Math.PI*t/l)-1)+e},easeInExpo:function(t,e,s,l){return t===0?e:s*Math.pow(2,10*(t/l-1))+e},easeOutExpo:function(t,e,s,l){return t===l?e+s:s*(1-Math.pow(2,-10*t/l))+e},easeInOutExpo:function(t,e,s,l){return t===0?e:t===l?e+s:(t/=l/2)<1?s/2*Math.pow(2,10*(t-1))+e:s/2*(2-Math.pow(2,-10*--t))+e},easeInCirc:function(t,e,s,l){return-s*(Math.sqrt(1-(t/=l)*t)-1)+e},easeOutCirc:function(t,e,s,l){return s*Math.sqrt(1-(t=t/l-1)*t)+e},easeInOutCirc:function(t,e,s,l){return(t/=l/2)<1?-s/2*(Math.sqrt(1-t*t)-1)+e:s/2*(Math.sqrt(1-(t-=2)*t)+1)+e},easeInElastic:function(t,e,s,l){var a=0;return t===0?e:(t/=l)==1?e+s:(a||(a=.3*l),-i(n(s,s,a,1.70158),t,l)+e)},easeOutElastic:function(t,e,s,l){var a=0;if(t===0)return e;if((t/=l)==1)return e+s;a||(a=.3*l);var h=n(s,s,a,1.70158);return h.a*Math.pow(2,-10*t)*Math.sin((t*l-h.s)*(2*Math.PI)/h.p)+h.c+e},easeInOutElastic:function(t,e,s,l){var a=0;if(t===0)return e;if((t/=l/2)==2)return e+s;a||(a=l*(.3*1.5));var h=n(s,s,a,1.70158);return t<1?-.5*i(h,t,l)+e:h.a*Math.pow(2,-10*(t-=1))*Math.sin((t*l-h.s)*(2*Math.PI)/h.p)*.5+h.c+e},easeInBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),s*(t/=l)*t*((a+1)*t-a)+e},easeOutBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),s*((t=t/l-1)*t*((a+1)*t+a)+1)+e},easeInOutBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),(t/=l/2)<1?s/2*(t*t*((1+(a*=1.525))*t-a))+e:s/2*((t-=2)*t*((1+(a*=1.525))*t+a)+2)+e},easeInBounce:r,easeOutBounce:o,easeInOutBounce:function(t,e,s,l){return t<l/2?.5*r(2*t,0,s,l)+e:.5*o(2*t-l,0,s,l)+.5*s+e}}}(),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t=i.util.toFixed,e=i.util.parseUnit,s=i.util.multiplyTransformMatrices,l={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},a={stroke:"strokeOpacity",fill:"fillOpacity"},h="font-size",u="clip-path";function p(D){return D in l?l[D]:D}function _(D,A,k,G){var H,M=Array.isArray(A);if(D!=="fill"&&D!=="stroke"||A!=="none"){if(D==="strokeUniform")return A==="non-scaling-stroke";if(D==="strokeDashArray")A=A==="none"?null:A.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(D==="transformMatrix")A=k&&k.transformMatrix?s(k.transformMatrix,i.parseTransformAttribute(A)):i.parseTransformAttribute(A);else if(D==="visible")A=A!=="none"&&A!=="hidden",k&&k.visible===!1&&(A=!1);else if(D==="opacity")A=parseFloat(A),k&&k.opacity!==void 0&&(A*=k.opacity);else if(D==="textAnchor")A=A==="start"?"left":A==="end"?"right":"center";else if(D==="charSpacing")H=e(A,G)/G*1e3;else if(D==="paintFirst"){var I=A.indexOf("fill"),F=A.indexOf("stroke");A="fill",(I>-1&&F>-1&&F<I||I===-1&&F>-1)&&(A="stroke")}else{if(D==="href"||D==="xlink:href"||D==="font")return A;if(D==="imageSmoothing")return A==="optimizeQuality";H=M?A.map(e):e(A,G)}}else A="";return!M&&isNaN(H)?A:H}function y(D){return new RegExp("^("+D.join("|")+")\\b","i")}function v(D,A){var k,G,H,M,I=[];for(H=0,M=A.length;H<M;H++)k=A[H],G=D.getElementsByTagName(k),I=I.concat(Array.prototype.slice.call(G));return I}function w(D,A){var k,G=!0;return(k=T(D,A.pop()))&&A.length&&(G=function(H,M){for(var I,F=!0;H.parentNode&&H.parentNode.nodeType===1&&M.length;)F&&(I=M.pop()),F=T(H=H.parentNode,I);return M.length===0}(D,A)),k&&G&&A.length===0}function T(D,A){var k,G,H=D.nodeName,M=D.getAttribute("class"),I=D.getAttribute("id");if(k=new RegExp("^"+H,"i"),A=A.replace(k,""),I&&A.length&&(k=new RegExp("#"+I+"(?![a-zA-Z\\-]+)","i"),A=A.replace(k,"")),M&&A.length)for(G=(M=M.split(" ")).length;G--;)k=new RegExp("\\."+M[G]+"(?![a-zA-Z\\-]+)","i"),A=A.replace(k,"");return A.length===0}function P(D,A){var k;if(D.getElementById&&(k=D.getElementById(A)),k)return k;var G,H,M,I=D.getElementsByTagName("*");for(H=0,M=I.length;H<M;H++)if(A===(G=I[H]).getAttribute("id"))return G}i.svgValidTagNamesRegEx=y(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=y(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=y(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=y(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function D(F,X,U){F[U]=Math.tan(i.util.degreesToRadians(X[0]))}var A=i.iMatrix,k=i.reNum,G=i.commaWsp,H="(?:(?:(matrix)\\s*\\(\\s*("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+k+")(?:"+G+"("+k+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+k+")(?:"+G+"("+k+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+k+")(?:"+G+"("+k+")"+G+"("+k+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+k+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+k+")\\s*\\)))",M=new RegExp("^\\s*(?:(?:"+H+"(?:"+G+"*"+H+")*)?)\\s*$"),I=new RegExp(H,"g");return function(F){var X=A.concat(),U=[];if(!F||F&&!M.test(F))return X;F.replace(I,function(it){var Q=new RegExp(H).exec(it).filter(function($){return!!$}),q=Q[1],et=Q.slice(2).map(parseFloat);switch(q){case"translate":(function($,rt){$[4]=rt[0],rt.length===2&&($[5]=rt[1])})(X,et);break;case"rotate":et[0]=i.util.degreesToRadians(et[0]),function($,rt){var ot=i.util.cos(rt[0]),nt=i.util.sin(rt[0]),ut=0,ft=0;rt.length===3&&(ut=rt[1],ft=rt[2]),$[0]=ot,$[1]=nt,$[2]=-nt,$[3]=ot,$[4]=ut-(ot*ut-nt*ft),$[5]=ft-(nt*ut+ot*ft)}(X,et);break;case"scale":(function($,rt){var ot=rt[0],nt=rt.length===2?rt[1]:rt[0];$[0]=ot,$[3]=nt})(X,et);break;case"skewX":D(X,et,2);break;case"skewY":D(X,et,1);break;case"matrix":X=et}U.push(X.concat()),X=A.concat()});for(var Y=U[0];U.length>1;)U.shift(),Y=i.util.multiplyTransformMatrices(Y,U[0]);return Y}}();var L=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function W(D){if(!i.svgViewBoxElementsRegEx.test(D.nodeName))return{};var A,k,G,H,M,I,F=D.getAttribute("viewBox"),X=1,U=1,Y=D.getAttribute("width"),it=D.getAttribute("height"),Q=D.getAttribute("x")||0,q=D.getAttribute("y")||0,et=D.getAttribute("preserveAspectRatio")||"",$=!F||!(F=F.match(L)),rt=!Y||!it||Y==="100%"||it==="100%",ot=$&&rt,nt={},ut="",ft=0,bt=0;if(nt.width=0,nt.height=0,nt.toBeParsed=ot,$&&(Q||q)&&D.parentNode&&D.parentNode.nodeName!=="#document"&&(ut=" translate("+e(Q)+" "+e(q)+") ",M=(D.getAttribute("transform")||"")+ut,D.setAttribute("transform",M),D.removeAttribute("x"),D.removeAttribute("y")),ot)return nt;if($)return nt.width=e(Y),nt.height=e(it),nt;if(A=-parseFloat(F[1]),k=-parseFloat(F[2]),G=parseFloat(F[3]),H=parseFloat(F[4]),nt.minX=A,nt.minY=k,nt.viewBoxWidth=G,nt.viewBoxHeight=H,rt?(nt.width=G,nt.height=H):(nt.width=e(Y),nt.height=e(it),X=nt.width/G,U=nt.height/H),(et=i.util.parsePreserveAspectRatioAttribute(et)).alignX!=="none"&&(et.meetOrSlice==="meet"&&(U=X=X>U?U:X),et.meetOrSlice==="slice"&&(U=X=X>U?X:U),ft=nt.width-G*X,bt=nt.height-H*X,et.alignX==="Mid"&&(ft/=2),et.alignY==="Mid"&&(bt/=2),et.alignX==="Min"&&(ft=0),et.alignY==="Min"&&(bt=0)),X===1&&U===1&&A===0&&k===0&&Q===0&&q===0)return nt;if((Q||q)&&D.parentNode.nodeName!=="#document"&&(ut=" translate("+e(Q)+" "+e(q)+") "),M=ut+" matrix("+X+" 0 0 "+U+" "+(A*X+ft)+" "+(k*U+bt)+") ",D.nodeName==="svg"){for(I=D.ownerDocument.createElementNS(i.svgNS,"g");D.firstChild;)I.appendChild(D.firstChild);D.appendChild(I)}else(I=D).removeAttribute("x"),I.removeAttribute("y"),M=I.getAttribute("transform")+M;return I.setAttribute("transform",M),nt}function N(D,A){var k="xlink:href",G=P(D,A.getAttribute(k).slice(1));if(G&&G.getAttribute(k)&&N(D,G),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(M){G&&!A.hasAttribute(M)&&G.hasAttribute(M)&&A.setAttribute(M,G.getAttribute(M))}),!A.children.length)for(var H=G.cloneNode(!0);H.firstChild;)A.appendChild(H.firstChild);A.removeAttribute(k)}i.parseSVGDocument=function(D,A,k,G){if(D){(function(Q){for(var q=v(Q,["use","svg:use"]),et=0;q.length&&et<q.length;){var $=q[et],rt=$.getAttribute("xlink:href")||$.getAttribute("href");if(rt===null)return;var ot,nt,ut,ft,bt=rt.slice(1),Tt=$.getAttribute("x")||0,Rt=$.getAttribute("y")||0,_t=P(Q,bt).cloneNode(!0),St=(_t.getAttribute("transform")||"")+" translate("+Tt+", "+Rt+")",Ft=q.length,Mt=i.svgNS;if(W(_t),/^svg$/i.test(_t.nodeName)){var Dt=_t.ownerDocument.createElementNS(Mt,"g");for(nt=0,ft=(ut=_t.attributes).length;nt<ft;nt++)ot=ut.item(nt),Dt.setAttributeNS(Mt,ot.nodeName,ot.nodeValue);for(;_t.firstChild;)Dt.appendChild(_t.firstChild);_t=Dt}for(nt=0,ft=(ut=$.attributes).length;nt<ft;nt++)(ot=ut.item(nt)).nodeName!=="x"&&ot.nodeName!=="y"&&ot.nodeName!=="xlink:href"&&ot.nodeName!=="href"&&(ot.nodeName==="transform"?St=ot.nodeValue+" "+St:_t.setAttribute(ot.nodeName,ot.nodeValue));_t.setAttribute("transform",St),_t.setAttribute("instantiated_by_use","1"),_t.removeAttribute("id"),$.parentNode.replaceChild(_t,$),q.length===Ft&&et++}})(D);var H,M,I=i.Object.__uid++,F=W(D),X=i.util.toArray(D.getElementsByTagName("*"));if(F.crossOrigin=G&&G.crossOrigin,F.svgUid=I,X.length===0&&i.isLikelyNode){var U=[];for(H=0,M=(X=D.selectNodes('//*[name(.)!="svg"]')).length;H<M;H++)U[H]=X[H];X=U}var Y=X.filter(function(Q){return W(Q),i.svgValidTagNamesRegEx.test(Q.nodeName.replace("svg:",""))&&!function(q,et){for(;q&&(q=q.parentNode);)if(q.nodeName&&et.test(q.nodeName.replace("svg:",""))&&!q.getAttribute("instantiated_by_use"))return!0;return!1}(Q,i.svgInvalidAncestorsRegEx)});if(!Y||Y&&!Y.length)A&&A([],{});else{var it={};X.filter(function(Q){return Q.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Q){var q=Q.getAttribute("id");it[q]=i.util.toArray(Q.getElementsByTagName("*")).filter(function(et){return i.svgValidTagNamesRegEx.test(et.nodeName.replace("svg:",""))})}),i.gradientDefs[I]=i.getGradientDefs(D),i.cssRules[I]=i.getCSSRules(D),i.clipPaths[I]=it,i.parseElements(Y,function(Q,q){A&&(A(Q,F,q,X),delete i.gradientDefs[I],delete i.cssRules[I],delete i.clipPaths[I])},o(F),k,G)}}};var B=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");r(i,{parseFontDeclaration:function(D,A){var k=D.match(B);if(k){var G=k[1],H=k[3],M=k[4],I=k[5],F=k[6];G&&(A.fontStyle=G),H&&(A.fontWeight=isNaN(parseFloat(H))?H:parseFloat(H)),M&&(A.fontSize=e(M)),F&&(A.fontFamily=F),I&&(A.lineHeight=I==="normal"?1:I)}},getGradientDefs:function(D){var A,k=v(D,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),G=0,H={};for(G=k.length;G--;)(A=k[G]).getAttribute("xlink:href")&&N(D,A),H[A.getAttribute("id")]=A;return H},parseAttributes:function(D,A,k){if(D){var G,H,M,I={};k===void 0&&(k=D.getAttribute("svgUid")),D.parentNode&&i.svgValidParentsRegEx.test(D.parentNode.nodeName)&&(I=i.parseAttributes(D.parentNode,A,k));var F=A.reduce(function(et,$){return(G=D.getAttribute($))&&(et[$]=G),et},{}),X=r(function(et,$){var rt={};for(var ot in i.cssRules[$])if(w(et,ot.split(" ")))for(var nt in i.cssRules[$][ot])rt[nt]=i.cssRules[$][ot][nt];return rt}(D,k),i.parseStyleAttribute(D));F=r(F,X),X[u]&&D.setAttribute(u,X[u]),H=M=I.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,F[h]&&(F[h]=H=e(F[h],M));var U,Y,it={};for(var Q in F)Y=_(U=p(Q),F[Q],I,H),it[U]=Y;it&&it.font&&i.parseFontDeclaration(it.font,it);var q=r(I,it);return i.svgValidParentsRegEx.test(D.nodeName)?q:function(et){for(var $ in a)if(et[a[$]]!==void 0&&et[$]!==""){if(et[$]===void 0){if(!i.Object.prototype[$])continue;et[$]=i.Object.prototype[$]}if(et[$].indexOf("url(")!==0){var rt=new i.Color(et[$]);et[$]=rt.setAlpha(t(rt.getAlpha()*et[a[$]],2)).toRgba()}}return et}(q)}},parseElements:function(D,A,k,G,H){new i.ElementsParser(D,A,k,G,H).parse()},parseStyleAttribute:function(D){var A={},k=D.getAttribute("style");return k&&(typeof k=="string"?function(G,H){var M,I;G.replace(/;\s*$/,"").split(";").forEach(function(F){var X=F.split(":");M=X[0].trim().toLowerCase(),I=X[1].trim(),H[M]=I})}(k,A):function(G,H){var M,I;for(var F in G)G[F]!==void 0&&(M=F.toLowerCase(),I=G[F],H[M]=I)}(k,A)),A},parsePointsAttribute:function(D){if(!D)return null;var A,k,G=[];for(A=0,k=(D=(D=D.replace(/,/g," ").trim()).split(/\s+/)).length;A<k;A+=2)G.push({x:parseFloat(D[A]),y:parseFloat(D[A+1])});return G},getCSSRules:function(D){var A,k,G=D.getElementsByTagName("style"),H={};for(A=0,k=G.length;A<k;A++){var M=G[A].textContent;(M=M.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&M.split("}").filter(function(I){return I.trim()}).forEach(function(I){var F=I.split("{"),X={},U=F[1].trim().split(";").filter(function(q){return q.trim()});for(A=0,k=U.length;A<k;A++){var Y=U[A].split(":"),it=Y[0].trim(),Q=Y[1].trim();X[it]=Q}(I=F[0].trim()).split(",").forEach(function(q){(q=q.replace(/^svg/i,"").trim())!==""&&(H[q]?i.util.object.extend(H[q],X):H[q]=i.util.object.clone(X))})})}return H},loadSVGFromURL:function(D,A,k,G){D=D.replace(/^\n\s*/,"").trim(),new i.util.request(D,{method:"get",onComplete:function(H){var M=H.responseXML;if(!M||!M.documentElement)return A&&A(null),!1;i.parseSVGDocument(M.documentElement,function(I,F,X,U){A&&A(I,F,X,U)},k,G)}})},loadSVGFromString:function(D,A,k,G){var H=new i.window.DOMParser().parseFromString(D.trim(),"text/xml");i.parseSVGDocument(H.documentElement,function(M,I,F,X){A(M,I,F,X)},k,G)}})}(c),d.ElementsParser=function(n,i,r,o,t,e){this.elements=n,this.callback=i,this.options=r,this.reviver=o,this.svgUid=r&&r.svgUid||0,this.parsingOptions=t,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=e},(Z=d.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},Z.createObjects=function(){var n=this;this.elements.forEach(function(i,r){i.setAttribute("svgUid",n.svgUid),n.createObject(i,r)})},Z.findTag=function(n){return d[d.util.string.capitalize(n.tagName.replace("svg:",""))]},Z.createObject=function(n,i){var r=this.findTag(n);if(r&&r.fromElement)try{r.fromElement(n,this.createCallback(i,n),this.options)}catch(o){d.log(o)}else this.checkIfDone()},Z.createCallback=function(n,i){var r=this;return function(o){var t;r.resolveGradient(o,i,"fill"),r.resolveGradient(o,i,"stroke"),o instanceof d.Image&&o._originalElement&&(t=o.parsePreserveAspectRatioAttribute(i)),o._removeTransformMatrix(t),r.resolveClipPath(o,i),r.reviver&&r.reviver(i,o),r.instances[n]=o,r.checkIfDone()}},Z.extractPropertyDefinition=function(n,i,r){var o=n[i],t=this.regexUrl;if(t.test(o)){t.lastIndex=0;var e=t.exec(o)[1];return t.lastIndex=0,d[r][this.svgUid][e]}},Z.resolveGradient=function(n,i,r){var o=this.extractPropertyDefinition(n,r,"gradientDefs");if(o){var t=i.getAttribute(r+"-opacity"),e=d.Gradient.fromElement(o,n,t,this.options);n.set(r,e)}},Z.createClipPathCallback=function(n,i){return function(r){r._removeTransformMatrix(),r.fillRule=r.clipRule,i.push(r)}},Z.resolveClipPath=function(n,i){var r,o,t,e,s=this.extractPropertyDefinition(n,"clipPath","clipPaths");if(s){t=[],o=d.util.invertTransform(n.calcTransformMatrix());for(var l=s[0].parentNode,a=i;a.parentNode&&a.getAttribute("clip-path")!==n.clipPath;)a=a.parentNode;a.parentNode.appendChild(l);for(var h=0;h<s.length;h++)r=s[h],this.findTag(r).fromElement(r,this.createClipPathCallback(n,t),this.options);s=t.length===1?t[0]:new d.Group(t),e=d.util.multiplyTransformMatrices(o,s.calcTransformMatrix()),s.clipPath&&this.resolveClipPath(s,a);var u=d.util.qrDecompose(e);s.flipX=!1,s.flipY=!1,s.set("scaleX",u.scaleX),s.set("scaleY",u.scaleY),s.angle=u.angle,s.skewX=u.skewX,s.skewY=0,s.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),n.clipPath=s}else delete n.clipPath},Z.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(n){return n!=null}),this.callback(this.instances,this.elements))},function(n){var i=n.fabric||(n.fabric={});function r(o,t){this.x=o,this.y=t}i.Point?i.warn("fabric.Point is already defined"):(i.Point=r,r.prototype={type:"point",constructor:r,add:function(o){return new r(this.x+o.x,this.y+o.y)},addEquals:function(o){return this.x+=o.x,this.y+=o.y,this},scalarAdd:function(o){return new r(this.x+o,this.y+o)},scalarAddEquals:function(o){return this.x+=o,this.y+=o,this},subtract:function(o){return new r(this.x-o.x,this.y-o.y)},subtractEquals:function(o){return this.x-=o.x,this.y-=o.y,this},scalarSubtract:function(o){return new r(this.x-o,this.y-o)},scalarSubtractEquals:function(o){return this.x-=o,this.y-=o,this},multiply:function(o){return new r(this.x*o,this.y*o)},multiplyEquals:function(o){return this.x*=o,this.y*=o,this},divide:function(o){return new r(this.x/o,this.y/o)},divideEquals:function(o){return this.x/=o,this.y/=o,this},eq:function(o){return this.x===o.x&&this.y===o.y},lt:function(o){return this.x<o.x&&this.y<o.y},lte:function(o){return this.x<=o.x&&this.y<=o.y},gt:function(o){return this.x>o.x&&this.y>o.y},gte:function(o){return this.x>=o.x&&this.y>=o.y},lerp:function(o,t){return t===void 0&&(t=.5),t=Math.max(Math.min(1,t),0),new r(this.x+(o.x-this.x)*t,this.y+(o.y-this.y)*t)},distanceFrom:function(o){var t=this.x-o.x,e=this.y-o.y;return Math.sqrt(t*t+e*e)},midPointFrom:function(o){return this.lerp(o)},min:function(o){return new r(Math.min(this.x,o.x),Math.min(this.y,o.y))},max:function(o){return new r(Math.max(this.x,o.x),Math.max(this.y,o.y))},toString:function(){return this.x+","+this.y},setXY:function(o,t){return this.x=o,this.y=t,this},setX:function(o){return this.x=o,this},setY:function(o){return this.y=o,this},setFromPoint:function(o){return this.x=o.x,this.y=o.y,this},swap:function(o){var t=this.x,e=this.y;this.x=o.x,this.y=o.y,o.x=t,o.y=e},clone:function(){return new r(this.x,this.y)}})}(c),function(n){var i=n.fabric||(n.fabric={});function r(o){this.status=o,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=r,i.Intersection.prototype={constructor:r,appendPoint:function(o){return this.points.push(o),this},appendPoints:function(o){return this.points=this.points.concat(o),this}},i.Intersection.intersectLineLine=function(o,t,e,s){var l,a=(s.x-e.x)*(o.y-e.y)-(s.y-e.y)*(o.x-e.x),h=(t.x-o.x)*(o.y-e.y)-(t.y-o.y)*(o.x-e.x),u=(s.y-e.y)*(t.x-o.x)-(s.x-e.x)*(t.y-o.y);if(u!==0){var p=a/u,_=h/u;0<=p&&p<=1&&0<=_&&_<=1?(l=new r("Intersection")).appendPoint(new i.Point(o.x+p*(t.x-o.x),o.y+p*(t.y-o.y))):l=new r}else l=new r(a===0||h===0?"Coincident":"Parallel");return l},i.Intersection.intersectLinePolygon=function(o,t,e){var s,l,a,h,u=new r,p=e.length;for(h=0;h<p;h++)s=e[h],l=e[(h+1)%p],a=r.intersectLineLine(o,t,s,l),u.appendPoints(a.points);return u.points.length>0&&(u.status="Intersection"),u},i.Intersection.intersectPolygonPolygon=function(o,t){var e,s=new r,l=o.length;for(e=0;e<l;e++){var a=o[e],h=o[(e+1)%l],u=r.intersectLinePolygon(a,h,t);s.appendPoints(u.points)}return s.points.length>0&&(s.status="Intersection"),s},i.Intersection.intersectPolygonRectangle=function(o,t,e){var s=t.min(e),l=t.max(e),a=new i.Point(l.x,s.y),h=new i.Point(s.x,l.y),u=r.intersectLinePolygon(s,a,o),p=r.intersectLinePolygon(a,l,o),_=r.intersectLinePolygon(l,h,o),y=r.intersectLinePolygon(h,s,o),v=new r;return v.appendPoints(u.points),v.appendPoints(p.points),v.appendPoints(_.points),v.appendPoints(y.points),v.points.length>0&&(v.status="Intersection"),v})}(c),function(n){var i=n.fabric||(n.fabric={});function r(t){t?this._tryParsingColor(t):this.setSource([0,0,0,1])}function o(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}i.Color?i.warn("fabric.Color is already defined."):(i.Color=r,i.Color.prototype={_tryParsingColor:function(t){var e;t in r.colorNameMap&&(t=r.colorNameMap[t]),t==="transparent"&&(e=[255,255,255,0]),e||(e=r.sourceFromHex(t)),e||(e=r.sourceFromRgb(t)),e||(e=r.sourceFromHsl(t)),e||(e=[0,0,0,1]),e&&this.setSource(e)},_rgbToHsl:function(t,e,s){t/=255,e/=255,s/=255;var l,a,h,u=i.util.array.max([t,e,s]),p=i.util.array.min([t,e,s]);if(h=(u+p)/2,u===p)l=a=0;else{var _=u-p;switch(a=h>.5?_/(2-u-p):_/(u+p),u){case t:l=(e-s)/_+(e<s?6:0);break;case e:l=(s-t)/_+2;break;case s:l=(t-e)/_+4}l/=6}return[Math.round(360*l),Math.round(100*a),Math.round(100*h)]},getSource:function(){return this._source},setSource:function(t){this._source=t},toRgb:function(){var t=this.getSource();return"rgb("+t[0]+","+t[1]+","+t[2]+")"},toRgba:function(){var t=this.getSource();return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"},toHsl:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"},toHsla:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsla("+e[0]+","+e[1]+"%,"+e[2]+"%,"+t[3]+")"},toHex:function(){var t,e,s,l=this.getSource();return t=(t=l[0].toString(16)).length===1?"0"+t:t,e=(e=l[1].toString(16)).length===1?"0"+e:e,s=(s=l[2].toString(16)).length===1?"0"+s:s,t.toUpperCase()+e.toUpperCase()+s.toUpperCase()},toHexa:function(){var t,e=this.getSource();return t=(t=(t=Math.round(255*e[3])).toString(16)).length===1?"0"+t:t,this.toHex()+t.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(t){var e=this.getSource();return e[3]=t,this.setSource(e),this},toGrayscale:function(){var t=this.getSource(),e=parseInt((.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),10),s=t[3];return this.setSource([e,e,e,s]),this},toBlackWhite:function(t){var e=this.getSource(),s=(.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),l=e[3];return t=t||127,s=Number(s)<Number(t)?0:255,this.setSource([s,s,s,l]),this},overlayWith:function(t){t instanceof r||(t=new r(t));var e,s=[],l=this.getAlpha(),a=this.getSource(),h=t.getSource();for(e=0;e<3;e++)s.push(Math.round(.5*a[e]+.5*h[e]));return s[3]=l,this.setSource(s),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(t){return r.fromSource(r.sourceFromRgb(t))},i.Color.sourceFromRgb=function(t){var e=t.match(r.reRGBa);if(e){var s=parseInt(e[1],10)/(/%$/.test(e[1])?100:1)*(/%$/.test(e[1])?255:1),l=parseInt(e[2],10)/(/%$/.test(e[2])?100:1)*(/%$/.test(e[2])?255:1),a=parseInt(e[3],10)/(/%$/.test(e[3])?100:1)*(/%$/.test(e[3])?255:1);return[parseInt(s,10),parseInt(l,10),parseInt(a,10),e[4]?parseFloat(e[4]):1]}},i.Color.fromRgba=r.fromRgb,i.Color.fromHsl=function(t){return r.fromSource(r.sourceFromHsl(t))},i.Color.sourceFromHsl=function(t){var e=t.match(r.reHSLa);if(e){var s,l,a,h=(parseFloat(e[1])%360+360)%360/360,u=parseFloat(e[2])/(/%$/.test(e[2])?100:1),p=parseFloat(e[3])/(/%$/.test(e[3])?100:1);if(u===0)s=l=a=p;else{var _=p<=.5?p*(u+1):p+u-p*u,y=2*p-_;s=o(y,_,h+1/3),l=o(y,_,h),a=o(y,_,h-1/3)}return[Math.round(255*s),Math.round(255*l),Math.round(255*a),e[4]?parseFloat(e[4]):1]}},i.Color.fromHsla=r.fromHsl,i.Color.fromHex=function(t){return r.fromSource(r.sourceFromHex(t))},i.Color.sourceFromHex=function(t){if(t.match(r.reHex)){var e=t.slice(t.indexOf("#")+1),s=e.length===3||e.length===4,l=e.length===8||e.length===4,a=s?e.charAt(0)+e.charAt(0):e.substring(0,2),h=s?e.charAt(1)+e.charAt(1):e.substring(2,4),u=s?e.charAt(2)+e.charAt(2):e.substring(4,6),p=l?s?e.charAt(3)+e.charAt(3):e.substring(6,8):"FF";return[parseInt(a,16),parseInt(h,16),parseInt(u,16),parseFloat((parseInt(p,16)/255).toFixed(2))]}},i.Color.fromSource=function(t){var e=new r;return e.setSource(t),e})}(c),function(n){var i=n.fabric||(n.fabric={}),r=["e","se","s","sw","w","nw","n","ne","e"],o=["ns","nesw","ew","nwse"],t={},e="left",s="top",l="right",a="bottom",h="center",u={top:a,bottom:s,left:l,right:e,center:h},p=i.util.radiansToDegrees,_=Math.sign||function(M){return(M>0)-(M<0)||+M};function y(M,I){var F=M.angle+p(Math.atan2(I.y,I.x))+360;return Math.round(F%360/45)}function v(M,I){var F=I.transform.target,X=F.canvas,U=i.util.object.clone(I);U.target=F,X&&X.fire("object:"+M,U),F.fire(M,I)}function w(M,I){var F=I.canvas,X=M[F.uniScaleKey];return F.uniformScaling&&!X||!F.uniformScaling&&X}function T(M){return M.originX===h&&M.originY===h}function P(M,I,F){var X=M.lockScalingX,U=M.lockScalingY;return!((!X||!U)&&(I||!X&&!U||!F)&&(!X||I!=="x")&&(!U||I!=="y"))}function L(M,I,F,X){return{e:M,transform:I,pointer:{x:F,y:X}}}function W(M){return function(I,F,X,U){var Y=F.target,it=Y.getCenterPoint(),Q=Y.translateToOriginPoint(it,F.originX,F.originY),q=M(I,F,X,U);return Y.setPositionByOrigin(Q,F.originX,F.originY),q}}function N(M,I){return function(F,X,U,Y){var it=I(F,X,U,Y);return it&&v(M,L(F,X,U,Y)),it}}function B(M,I,F,X,U){var Y=M.target,it=Y.controls[M.corner],Q=Y.canvas.getZoom(),q=Y.padding/Q,et=Y.toLocalPoint(new i.Point(X,U),I,F);return et.x>=q&&(et.x-=q),et.x<=-q&&(et.x+=q),et.y>=q&&(et.y-=q),et.y<=q&&(et.y+=q),et.x-=it.offsetX,et.y-=it.offsetY,et}function D(M){return M.flipX!==M.flipY}function A(M,I,F,X,U){if(M[I]!==0){var Y=U/M._getTransformedDimensions()[X]*M[F];M.set(F,Y)}}function k(M,I,F,X){var U,Y=I.target,it=Y._getTransformedDimensions(0,Y.skewY),Q=B(I,I.originX,I.originY,F,X),q=Math.abs(2*Q.x)-it.x,et=Y.skewX;q<2?U=0:(U=p(Math.atan2(q/Y.scaleX,it.y/Y.scaleY)),I.originX===e&&I.originY===a&&(U=-U),I.originX===l&&I.originY===s&&(U=-U),D(Y)&&(U=-U));var $=et!==U;if($){var rt=Y._getTransformedDimensions().y;Y.set("skewX",U),A(Y,"skewY","scaleY","y",rt)}return $}function G(M,I,F,X){var U,Y=I.target,it=Y._getTransformedDimensions(Y.skewX,0),Q=B(I,I.originX,I.originY,F,X),q=Math.abs(2*Q.y)-it.y,et=Y.skewY;q<2?U=0:(U=p(Math.atan2(q/Y.scaleY,it.x/Y.scaleX)),I.originX===e&&I.originY===a&&(U=-U),I.originX===l&&I.originY===s&&(U=-U),D(Y)&&(U=-U));var $=et!==U;if($){var rt=Y._getTransformedDimensions().x;Y.set("skewY",U),A(Y,"skewX","scaleX","x",rt)}return $}function H(M,I,F,X,U){U=U||{};var Y,it,Q,q,et,$,rt=I.target,ot=rt.lockScalingX,nt=rt.lockScalingY,ut=U.by,ft=w(M,rt),bt=P(rt,ut,ft),Tt=I.gestureScale;if(bt)return!1;if(Tt)it=I.scaleX*Tt,Q=I.scaleY*Tt;else{if(Y=B(I,I.originX,I.originY,F,X),et=ut!=="y"?_(Y.x):1,$=ut!=="x"?_(Y.y):1,I.signX||(I.signX=et),I.signY||(I.signY=$),rt.lockScalingFlip&&(I.signX!==et||I.signY!==$))return!1;if(q=rt._getTransformedDimensions(),ft&&!ut){var Rt=Math.abs(Y.x)+Math.abs(Y.y),_t=I.original,St=Rt/(Math.abs(q.x*_t.scaleX/rt.scaleX)+Math.abs(q.y*_t.scaleY/rt.scaleY));it=_t.scaleX*St,Q=_t.scaleY*St}else it=Math.abs(Y.x*rt.scaleX/q.x),Q=Math.abs(Y.y*rt.scaleY/q.y);T(I)&&(it*=2,Q*=2),I.signX!==et&&ut!=="y"&&(I.originX=u[I.originX],it*=-1,I.signX=et),I.signY!==$&&ut!=="x"&&(I.originY=u[I.originY],Q*=-1,I.signY=$)}var Ft=rt.scaleX,Mt=rt.scaleY;return ut?(ut==="x"&&rt.set("scaleX",it),ut==="y"&&rt.set("scaleY",Q)):(!ot&&rt.set("scaleX",it),!nt&&rt.set("scaleY",Q)),Ft!==rt.scaleX||Mt!==rt.scaleY}t.scaleCursorStyleHandler=function(M,I,F){var X=w(M,F),U="";if(I.x!==0&&I.y===0?U="x":I.x===0&&I.y!==0&&(U="y"),P(F,U,X))return"not-allowed";var Y=y(F,I);return r[Y]+"-resize"},t.skewCursorStyleHandler=function(M,I,F){var X="not-allowed";if(I.x!==0&&F.lockSkewingY||I.y!==0&&F.lockSkewingX)return X;var U=y(F,I)%4;return o[U]+"-resize"},t.scaleSkewCursorStyleHandler=function(M,I,F){return M[F.canvas.altActionKey]?t.skewCursorStyleHandler(M,I,F):t.scaleCursorStyleHandler(M,I,F)},t.rotationWithSnapping=N("rotating",W(function(M,I,F,X){var U=I,Y=U.target,it=Y.translateToOriginPoint(Y.getCenterPoint(),U.originX,U.originY);if(Y.lockRotation)return!1;var Q,q=Math.atan2(U.ey-it.y,U.ex-it.x),et=Math.atan2(X-it.y,F-it.x),$=p(et-q+U.theta);if(Y.snapAngle>0){var rt=Y.snapAngle,ot=Y.snapThreshold||rt,nt=Math.ceil($/rt)*rt,ut=Math.floor($/rt)*rt;Math.abs($-ut)<ot?$=ut:Math.abs($-nt)<ot&&($=nt)}return $<0&&($=360+$),$%=360,Q=Y.angle!==$,Y.angle=$,Q})),t.scalingEqually=N("scaling",W(function(M,I,F,X){return H(M,I,F,X)})),t.scalingX=N("scaling",W(function(M,I,F,X){return H(M,I,F,X,{by:"x"})})),t.scalingY=N("scaling",W(function(M,I,F,X){return H(M,I,F,X,{by:"y"})})),t.scalingYOrSkewingX=function(M,I,F,X){return M[I.target.canvas.altActionKey]?t.skewHandlerX(M,I,F,X):t.scalingY(M,I,F,X)},t.scalingXOrSkewingY=function(M,I,F,X){return M[I.target.canvas.altActionKey]?t.skewHandlerY(M,I,F,X):t.scalingX(M,I,F,X)},t.changeWidth=N("resizing",W(function(M,I,F,X){var U=I.target,Y=B(I,I.originX,I.originY,F,X),it=U.strokeWidth/(U.strokeUniform?U.scaleX:1),Q=T(I)?2:1,q=U.width,et=Math.abs(Y.x*Q/U.scaleX)-it;return U.set("width",Math.max(et,0)),q!==et})),t.skewHandlerX=function(M,I,F,X){var U,Y=I.target,it=Y.skewX,Q=I.originY;return!Y.lockSkewingX&&(it===0?U=B(I,h,h,F,X).x>0?e:l:(it>0&&(U=Q===s?e:l),it<0&&(U=Q===s?l:e),D(Y)&&(U=U===e?l:e)),I.originX=U,N("skewing",W(k))(M,I,F,X))},t.skewHandlerY=function(M,I,F,X){var U,Y=I.target,it=Y.skewY,Q=I.originX;return!Y.lockSkewingY&&(it===0?U=B(I,h,h,F,X).y>0?s:a:(it>0&&(U=Q===e?s:a),it<0&&(U=Q===e?a:s),D(Y)&&(U=U===s?a:s)),I.originY=U,N("skewing",W(G))(M,I,F,X))},t.dragHandler=function(M,I,F,X){var U=I.target,Y=F-I.offsetX,it=X-I.offsetY,Q=!U.get("lockMovementX")&&U.left!==Y,q=!U.get("lockMovementY")&&U.top!==it;return Q&&U.set("left",Y),q&&U.set("top",it),(Q||q)&&v("moving",L(M,I,F,X)),Q||q},t.scaleOrSkewActionName=function(M,I,F){var X=M[F.canvas.altActionKey];return I.x===0?X?"skewX":"scaleY":I.y===0?X?"skewY":"scaleX":void 0},t.rotationStyleHandler=function(M,I,F){return F.lockRotation?"not-allowed":I.cursorStyle},t.fireEvent=v,t.wrapWithFixedAnchor=W,t.wrapWithFireEvent=N,t.getLocalPoint=B,i.controlsUtils=t}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.degreesToRadians,o=i.controlsUtils;o.renderCircleControl=function(t,e,s,l,a){l=l||{};var h,u=this.sizeX||l.cornerSize||a.cornerSize,p=this.sizeY||l.cornerSize||a.cornerSize,_=l.transparentCorners!==void 0?l.transparentCorners:a.transparentCorners,y=_?"stroke":"fill",v=!_&&(l.cornerStrokeColor||a.cornerStrokeColor),w=e,T=s;t.save(),t.fillStyle=l.cornerColor||a.cornerColor,t.strokeStyle=l.cornerStrokeColor||a.cornerStrokeColor,u>p?(h=u,t.scale(1,p/u),T=s*u/p):p>u?(h=p,t.scale(u/p,1),w=e*p/u):h=u,t.lineWidth=1,t.beginPath(),t.arc(w,T,h/2,0,2*Math.PI,!1),t[y](),v&&t.stroke(),t.restore()},o.renderSquareControl=function(t,e,s,l,a){l=l||{};var h=this.sizeX||l.cornerSize||a.cornerSize,u=this.sizeY||l.cornerSize||a.cornerSize,p=l.transparentCorners!==void 0?l.transparentCorners:a.transparentCorners,_=p?"stroke":"fill",y=!p&&(l.cornerStrokeColor||a.cornerStrokeColor),v=h/2,w=u/2;t.save(),t.fillStyle=l.cornerColor||a.cornerColor,t.strokeStyle=l.cornerStrokeColor||a.cornerStrokeColor,t.lineWidth=1,t.translate(e,s),t.rotate(r(a.angle)),t[_+"Rect"](-v,-w,h,u),y&&t.strokeRect(-v,-w,h,u),t.restore()}}(c),function(n){var i=n.fabric||(n.fabric={});i.Control=function(r){for(var o in r)this[o]=r[o]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(r,o){return o.cursorStyle},getActionName:function(r,o){return o.actionName},getVisibility:function(r,o){var t=r._controlsVisibility;return t&&t[o]!==void 0?t[o]:this.visible},setVisibility:function(r){this.visible=r},positionHandler:function(r,o){return i.util.transformPoint({x:this.x*r.x+this.offsetX,y:this.y*r.y+this.offsetY},o)},calcCornerCoords:function(r,o,t,e,s){var l,a,h,u,p=s?this.touchSizeX:this.sizeX,_=s?this.touchSizeY:this.sizeY;if(p&&_&&p!==_){var y=Math.atan2(_,p),v=Math.sqrt(p*p+_*_)/2,w=y-i.util.degreesToRadians(r),T=Math.PI/2-y-i.util.degreesToRadians(r);l=v*i.util.cos(w),a=v*i.util.sin(w),h=v*i.util.cos(T),u=v*i.util.sin(T)}else v=.7071067812*(p&&_?p:o),w=i.util.degreesToRadians(45-r),l=h=v*i.util.cos(w),a=u=v*i.util.sin(w);return{tl:{x:t-u,y:e-h},tr:{x:t+l,y:e-a},bl:{x:t-l,y:e+a},br:{x:t+u,y:e+h}}},render:function(r,o,t,e,s){((e=e||{}).cornerStyle||s.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,r,o,t,e,s):i.controlsUtils.renderSquareControl.call(this,r,o,t,e,s)}}}(c),function(){function n(r,o){var t,e,s,l,a=r.getAttribute("style"),h=r.getAttribute("offset")||0;if(h=(h=parseFloat(h)/(/%$/.test(h)?100:1))<0?0:h>1?1:h,a){var u=a.split(/\s*;\s*/);for(u[u.length-1]===""&&u.pop(),l=u.length;l--;){var p=u[l].split(/\s*:\s*/),_=p[0].trim(),y=p[1].trim();_==="stop-color"?t=y:_==="stop-opacity"&&(s=y)}}return t||(t=r.getAttribute("stop-color")||"rgb(0,0,0)"),s||(s=r.getAttribute("stop-opacity")),e=(t=new d.Color(t)).getAlpha(),s=isNaN(parseFloat(s))?1:parseFloat(s),s*=e*o,{offset:h,color:t.toRgb(),opacity:s}}var i=d.util.object.clone;d.Gradient=d.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(r){r||(r={}),r.coords||(r.coords={});var o,t=this;Object.keys(r).forEach(function(e){t[e]=r[e]}),this.id?this.id+="_"+d.Object.__uid++:this.id=d.Object.__uid++,o={x1:r.coords.x1||0,y1:r.coords.y1||0,x2:r.coords.x2||0,y2:r.coords.y2||0},this.type==="radial"&&(o.r1=r.coords.r1||0,o.r2=r.coords.r2||0),this.coords=o,this.colorStops=r.colorStops.slice()},addColorStop:function(r){for(var o in r){var t=new d.Color(r[o]);this.colorStops.push({offset:parseFloat(o),color:t.toRgb(),opacity:t.getAlpha()})}return this},toObject:function(r){var o={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return d.util.populateWithProperties(this,o,r),o},toSVG:function(r,o){var t,e,s,l,a=i(this.coords,!0),h=(o=o||{},i(this.colorStops,!0)),u=a.r1>a.r2,p=this.gradientTransform?this.gradientTransform.concat():d.iMatrix.concat(),_=-this.offsetX,y=-this.offsetY,v=!!o.additionalTransform,w=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(h.sort(function(W,N){return W.offset-N.offset}),w==="objectBoundingBox"?(_/=r.width,y/=r.height):(_+=r.width/2,y+=r.height/2),r.type==="path"&&this.gradientUnits!=="percentage"&&(_-=r.pathOffset.x,y-=r.pathOffset.y),p[4]-=_,p[5]-=y,l='id="SVGID_'+this.id+'" gradientUnits="'+w+'"',l+=' gradientTransform="'+(v?o.additionalTransform+" ":"")+d.util.matrixToSVG(p)+'" ',this.type==="linear"?s=["<linearGradient ",l,' x1="',a.x1,'" y1="',a.y1,'" x2="',a.x2,'" y2="',a.y2,`">
`]:this.type==="radial"&&(s=["<radialGradient ",l,' cx="',u?a.x1:a.x2,'" cy="',u?a.y1:a.y2,'" r="',u?a.r1:a.r2,'" fx="',u?a.x2:a.x1,'" fy="',u?a.y2:a.y1,`">
`]),this.type==="radial"){if(u)for((h=h.concat()).reverse(),t=0,e=h.length;t<e;t++)h[t].offset=1-h[t].offset;var T=Math.min(a.r1,a.r2);if(T>0){var P=T/Math.max(a.r1,a.r2);for(t=0,e=h.length;t<e;t++)h[t].offset+=P*(1-h[t].offset)}}for(t=0,e=h.length;t<e;t++){var L=h[t];s.push("<stop ",'offset="',100*L.offset+"%",'" style="stop-color:',L.color,L.opacity!==void 0?";stop-opacity: "+L.opacity:";",`"/>
`)}return s.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),s.join("")},toLive:function(r){var o,t,e,s=d.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?o=r.createLinearGradient(s.x1,s.y1,s.x2,s.y2):this.type==="radial"&&(o=r.createRadialGradient(s.x1,s.y1,s.r1,s.x2,s.y2,s.r2)),t=0,e=this.colorStops.length;t<e;t++){var l=this.colorStops[t].color,a=this.colorStops[t].opacity,h=this.colorStops[t].offset;a!==void 0&&(l=new d.Color(l).setAlpha(a).toRgba()),o.addColorStop(h,l)}return o}}}),d.util.object.extend(d.Gradient,{fromElement:function(r,o,t,e){var s=parseFloat(t)/(/%$/.test(t)?100:1);s=s<0?0:s>1?1:s,isNaN(s)&&(s=1);var l,a,h,u,p=r.getElementsByTagName("stop"),_=r.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",y=r.getAttribute("gradientTransform")||"",v=[],w=0,T=0;for(r.nodeName==="linearGradient"||r.nodeName==="LINEARGRADIENT"?(l="linear",a=function(P){return{x1:P.getAttribute("x1")||0,y1:P.getAttribute("y1")||0,x2:P.getAttribute("x2")||"100%",y2:P.getAttribute("y2")||0}}(r)):(l="radial",a=function(P){return{x1:P.getAttribute("fx")||P.getAttribute("cx")||"50%",y1:P.getAttribute("fy")||P.getAttribute("cy")||"50%",r1:0,x2:P.getAttribute("cx")||"50%",y2:P.getAttribute("cy")||"50%",r2:P.getAttribute("r")||"50%"}}(r)),h=p.length;h--;)v.push(n(p[h],s));return u=d.parseTransformAttribute(y),function(P,L,W,N){var B,D;Object.keys(L).forEach(function(A){(B=L[A])==="Infinity"?D=1:B==="-Infinity"?D=0:(D=parseFloat(L[A],10),typeof B=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(B)&&(D*=.01,N==="pixels"&&(A!=="x1"&&A!=="x2"&&A!=="r2"||(D*=W.viewBoxWidth||W.width),A!=="y1"&&A!=="y2"||(D*=W.viewBoxHeight||W.height)))),L[A]=D})}(0,a,e,_),_==="pixels"&&(w=-o.left,T=-o.top),new d.Gradient({id:r.getAttribute("id"),type:l,coords:a,colorStops:v,gradientUnits:_,gradientTransform:u,offsetX:w,offsetY:T})}})}(),ht=d.util.toFixed,d.Pattern=d.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(n,i){if(n||(n={}),this.id=d.Object.__uid++,this.setOptions(n),!n.source||n.source&&typeof n.source!="string")i&&i(this);else{var r=this;this.source=d.util.createImage(),d.util.loadImage(n.source,function(o,t){r.source=o,i&&i(r,t)},null,this.crossOrigin)}},toObject:function(n){var i,r,o=d.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),r={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:ht(this.offsetX,o),offsetY:ht(this.offsetY,o),patternTransform:this.patternTransform?this.patternTransform.concat():null},d.util.populateWithProperties(this,r,n),r},toSVG:function(n){var i=typeof this.source=="function"?this.source():this.source,r=i.width/n.width,o=i.height/n.height,t=this.offsetX/n.width,e=this.offsetY/n.height,s="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(o=1,e&&(o+=Math.abs(e))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(r=1,t&&(r+=Math.abs(t))),i.src?s=i.src:i.toDataURL&&(s=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+t+'" y="'+e+'" width="'+r+'" height="'+o+`">
<image x="0" y="0" width="`+i.width+'" height="'+i.height+'" xlink:href="'+s+`"></image>
</pattern>
`},setOptions:function(n){for(var i in n)this[i]=n[i]},toLive:function(n){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":n.createPattern(i,this.repeat)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(o){for(var t in typeof o=="string"&&(o=this._parseShadow(o)),o)this[t]=o[t];this.id=i.Object.__uid++},_parseShadow:function(o){var t=o.trim(),e=i.Shadow.reOffsetsAndBlur.exec(t)||[];return{color:(t.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(e[1],10)||0,offsetY:parseFloat(e[2],10)||0,blur:parseFloat(e[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(o){var t=40,e=40,s=i.Object.NUM_FRACTION_DIGITS,l=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-o.angle)),a=new i.Color(this.color);return o.width&&o.height&&(t=100*r((Math.abs(l.x)+this.blur)/o.width,s)+20,e=100*r((Math.abs(l.y)+this.blur)/o.height,s)+20),o.flipX&&(l.x*=-1),o.flipY&&(l.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+e+'%" height="'+(100+2*e)+'%" x="-'+t+'%" width="'+(100+2*t)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+r(this.blur?this.blur/2:0,s)+`"></feGaussianBlur>
	<feOffset dx="`+r(l.x,s)+'" dy="'+r(l.y,s)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+a.toRgb()+'" flood-opacity="'+a.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var o={},t=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(e){this[e]!==t[e]&&(o[e]=this[e])},this),o}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(c),function(){if(d.StaticCanvas)d.warn("fabric.StaticCanvas is already defined.");else{var n=d.util.object.extend,i=d.util.getElementOffset,r=d.util.removeFromArray,o=d.util.toFixed,t=d.util.transformPoint,e=d.util.invertTransform,s=d.util.getNodeCanvas,l=d.util.createCanvasElement,a=new Error("Could not initialize `canvas` element");d.StaticCanvas=d.util.createClass(d.CommonMethods,{initialize:function(h,u){u||(u={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(h,u)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:d.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(h,u){var p=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(h),this._initOptions(u),this.interactive||this._initRetinaScaling(),u.overlayImage&&this.setOverlayImage(u.overlayImage,p),u.backgroundImage&&this.setBackgroundImage(u.backgroundImage,p),u.backgroundColor&&this.setBackgroundColor(u.backgroundColor,p),u.overlayColor&&this.setOverlayColor(u.overlayColor,p),this.calcOffset()},_isRetinaScaling:function(){return d.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,d.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var h=d.devicePixelRatio;this.__initRetinaScaling(h,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(h,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(h,u,p){u.setAttribute("width",this.width*h),u.setAttribute("height",this.height*h),p.scale(h,h)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(h,u,p){return this.__setBgOverlayImage("overlayImage",h,u,p)},setBackgroundImage:function(h,u,p){return this.__setBgOverlayImage("backgroundImage",h,u,p)},setOverlayColor:function(h,u){return this.__setBgOverlayColor("overlayColor",h,u)},setBackgroundColor:function(h,u){return this.__setBgOverlayColor("backgroundColor",h,u)},__setBgOverlayImage:function(h,u,p,_){return typeof u=="string"?d.util.loadImage(u,function(y,v){if(y){var w=new d.Image(y,_);this[h]=w,w.canvas=this}p&&p(y,v)},this,_&&_.crossOrigin):(_&&u.setOptions(_),this[h]=u,u&&(u.canvas=this),p&&p(u,!1)),this},__setBgOverlayColor:function(h,u,p){return this[h]=u,this._initGradient(u,h),this._initPattern(u,h,p),this},_createCanvasElement:function(){var h=l();if(!h||(h.style||(h.style={}),h.getContext===void 0))throw a;return h},_initOptions:function(h){var u=this.lowerCanvasEl;this._setOptions(h),this.width=this.width||parseInt(u.width,10)||0,this.height=this.height||parseInt(u.height,10)||0,this.lowerCanvasEl.style&&(u.width=this.width,u.height=this.height,u.style.width=this.width+"px",u.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(h){h&&h.getContext?this.lowerCanvasEl=h:this.lowerCanvasEl=d.util.getById(h)||this._createCanvasElement(),d.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(h,u){return this.setDimensions({width:h},u)},setHeight:function(h,u){return this.setDimensions({height:h},u)},setDimensions:function(h,u){var p;for(var _ in u=u||{},h)p=h[_],u.cssOnly||(this._setBackstoreDimension(_,h[_]),p+="px",this.hasLostContext=!0),u.backstoreOnly||this._setCssDimension(_,p);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),u.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(h,u){return this.lowerCanvasEl[h]=u,this.upperCanvasEl&&(this.upperCanvasEl[h]=u),this.cacheCanvasEl&&(this.cacheCanvasEl[h]=u),this[h]=u,this},_setCssDimension:function(h,u){return this.lowerCanvasEl.style[h]=u,this.upperCanvasEl&&(this.upperCanvasEl.style[h]=u),this.wrapperEl&&(this.wrapperEl.style[h]=u),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(h){var u,p,_,y=this._activeObject,v=this.backgroundImage,w=this.overlayImage;for(this.viewportTransform=h,p=0,_=this._objects.length;p<_;p++)(u=this._objects[p]).group||u.setCoords(!0);return y&&y.setCoords(),v&&v.setCoords(!0),w&&w.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(h,u){var p=h,_=this.viewportTransform.slice(0);h=t(h,e(this.viewportTransform)),_[0]=u,_[3]=u;var y=t(h,_);return _[4]+=p.x-y.x,_[5]+=p.y-y.y,this.setViewportTransform(_)},setZoom:function(h){return this.zoomToPoint(new d.Point(0,0),h),this},absolutePan:function(h){var u=this.viewportTransform.slice(0);return u[4]=-h.x,u[5]=-h.y,this.setViewportTransform(u)},relativePan:function(h){return this.absolutePan(new d.Point(-h.x-this.viewportTransform[4],-h.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(h){this.stateful&&h.setupState(),h._set("canvas",this),h.setCoords(),this.fire("object:added",{target:h}),h.fire("added")},_onObjectRemoved:function(h){this.fire("object:removed",{target:h}),h.fire("removed"),delete h.canvas},clearContext:function(h){return h.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var h=this.contextContainer;return this.renderCanvas(h,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=d.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var h={},u=this.width,p=this.height,_=e(this.viewportTransform);return h.tl=t({x:0,y:0},_),h.br=t({x:u,y:p},_),h.tr=new d.Point(h.br.x,h.tl.y),h.bl=new d.Point(h.tl.x,h.br.y),this.vptCoords=h,h},cancelRequestedRender:function(){this.isRendering&&(d.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(h,u){var p=this.viewportTransform,_=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(h),d.util.setImageSmoothing(h,this.imageSmoothingEnabled),this.fire("before:render",{ctx:h}),this._renderBackground(h),h.save(),h.transform(p[0],p[1],p[2],p[3],p[4],p[5]),this._renderObjects(h,u),h.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(h),_&&(_.canvas=this,_.shouldCache(),_._transformDone=!0,_.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(h)),this._renderOverlay(h),this.controlsAboveOverlay&&this.interactive&&this.drawControls(h),this.fire("after:render",{ctx:h})},drawClipPathOnCanvas:function(h){var u=this.viewportTransform,p=this.clipPath;h.save(),h.transform(u[0],u[1],u[2],u[3],u[4],u[5]),h.globalCompositeOperation="destination-in",p.transform(h),h.scale(1/p.zoomX,1/p.zoomY),h.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),h.restore()},_renderObjects:function(h,u){var p,_;for(p=0,_=u.length;p<_;++p)u[p]&&u[p].render(h)},_renderBackgroundOrOverlay:function(h,u){var p=this[u+"Color"],_=this[u+"Image"],y=this.viewportTransform,v=this[u+"Vpt"];if(p||_){if(p){h.save(),h.beginPath(),h.moveTo(0,0),h.lineTo(this.width,0),h.lineTo(this.width,this.height),h.lineTo(0,this.height),h.closePath(),h.fillStyle=p.toLive?p.toLive(h,this):p,v&&h.transform(y[0],y[1],y[2],y[3],y[4],y[5]),h.transform(1,0,0,1,p.offsetX||0,p.offsetY||0);var w=p.gradientTransform||p.patternTransform;w&&h.transform(w[0],w[1],w[2],w[3],w[4],w[5]),h.fill(),h.restore()}_&&(h.save(),v&&h.transform(y[0],y[1],y[2],y[3],y[4],y[5]),_.render(h),h.restore())}},_renderBackground:function(h){this._renderBackgroundOrOverlay(h,"background")},_renderOverlay:function(h){this._renderBackgroundOrOverlay(h,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new d.Point(this.width/2,this.height/2)},centerObjectH:function(h){return this._centerObject(h,new d.Point(this.getCenterPoint().x,h.getCenterPoint().y))},centerObjectV:function(h){return this._centerObject(h,new d.Point(h.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(h){var u=this.getCenterPoint();return this._centerObject(h,u)},viewportCenterObject:function(h){var u=this.getVpCenter();return this._centerObject(h,u)},viewportCenterObjectH:function(h){var u=this.getVpCenter();return this._centerObject(h,new d.Point(u.x,h.getCenterPoint().y)),this},viewportCenterObjectV:function(h){var u=this.getVpCenter();return this._centerObject(h,new d.Point(h.getCenterPoint().x,u.y))},getVpCenter:function(){var h=this.getCenterPoint(),u=e(this.viewportTransform);return t(h,u)},_centerObject:function(h,u){return h.setPositionByOrigin(u,"center","center"),h.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(h){return this.toDatalessObject(h)},toObject:function(h){return this._toObjectMethod("toObject",h)},toDatalessObject:function(h){return this._toObjectMethod("toDatalessObject",h)},_toObjectMethod:function(h,u){var p=this.clipPath,_={version:d.version,objects:this._toObjects(h,u)};return p&&!p.excludeFromExport&&(_.clipPath=this._toObject(this.clipPath,h,u)),n(_,this.__serializeBgOverlay(h,u)),d.util.populateWithProperties(this,_,u),_},_toObjects:function(h,u){return this._objects.filter(function(p){return!p.excludeFromExport}).map(function(p){return this._toObject(p,h,u)},this)},_toObject:function(h,u,p){var _;this.includeDefaultValues||(_=h.includeDefaultValues,h.includeDefaultValues=!1);var y=h[u](p);return this.includeDefaultValues||(h.includeDefaultValues=_),y},__serializeBgOverlay:function(h,u){var p={},_=this.backgroundImage,y=this.overlayImage,v=this.backgroundColor,w=this.overlayColor;return v&&v.toObject?v.excludeFromExport||(p.background=v.toObject(u)):v&&(p.background=v),w&&w.toObject?w.excludeFromExport||(p.overlay=w.toObject(u)):w&&(p.overlay=w),_&&!_.excludeFromExport&&(p.backgroundImage=this._toObject(_,h,u)),y&&!y.excludeFromExport&&(p.overlayImage=this._toObject(y,h,u)),p},svgViewportTransformation:!0,toSVG:function(h,u){h||(h={}),h.reviver=u;var p=[];return this._setSVGPreamble(p,h),this._setSVGHeader(p,h),this.clipPath&&p.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(p,"background"),this._setSVGBgOverlayImage(p,"backgroundImage",u),this._setSVGObjects(p,u),this.clipPath&&p.push(`</g>
`),this._setSVGBgOverlayColor(p,"overlay"),this._setSVGBgOverlayImage(p,"overlayImage",u),p.push("</svg>"),p.join("")},_setSVGPreamble:function(h,u){u.suppressPreamble||h.push('<?xml version="1.0" encoding="',u.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(h,u){var p,_=u.width||this.width,y=u.height||this.height,v='viewBox="0 0 '+this.width+" "+this.height+'" ',w=d.Object.NUM_FRACTION_DIGITS;u.viewBox?v='viewBox="'+u.viewBox.x+" "+u.viewBox.y+" "+u.viewBox.width+" "+u.viewBox.height+'" ':this.svgViewportTransformation&&(p=this.viewportTransform,v='viewBox="'+o(-p[4]/p[0],w)+" "+o(-p[5]/p[3],w)+" "+o(this.width/p[0],w)+" "+o(this.height/p[3],w)+'" '),h.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',_,'" ','height="',y,'" ',v,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",d.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(u),`</defs>
`)},createSVGClipPathMarkup:function(h){var u=this.clipPath;return u?(u.clipPathId="CLIPPATH_"+d.Object.__uid++,'<clipPath id="'+u.clipPathId+`" >
`+this.clipPath.toClipPathSVG(h.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var h=this;return["background","overlay"].map(function(u){var p=h[u+"Color"];if(p&&p.toLive){var _=h[u+"Vpt"],y=h.viewportTransform,v={width:h.width/(_?y[0]:1),height:h.height/(_?y[3]:1)};return p.toSVG(v,{additionalTransform:_?d.util.matrixToSVG(y):""})}}).join("")},createSVGFontFacesMarkup:function(){var h,u,p,_,y,v,w,T,P="",L={},W=d.fontPaths,N=[];for(this._objects.forEach(function D(A){N.push(A),A._objects&&A._objects.forEach(D)}),w=0,T=N.length;w<T;w++)if(u=(h=N[w]).fontFamily,h.type.indexOf("text")!==-1&&!L[u]&&W[u]&&(L[u]=!0,h.styles))for(y in p=h.styles)for(v in _=p[y])!L[u=_[v].fontFamily]&&W[u]&&(L[u]=!0);for(var B in L)P+=[`		@font-face {
`,"			font-family: '",B,`';
`,"			src: url('",W[B],`');
`,`		}
`].join("");return P&&(P=['	<style type="text/css">',`<![CDATA[
`,P,"]]>",`</style>
`].join("")),P},_setSVGObjects:function(h,u){var p,_,y,v=this._objects;for(_=0,y=v.length;_<y;_++)(p=v[_]).excludeFromExport||this._setSVGObject(h,p,u)},_setSVGObject:function(h,u,p){h.push(u.toSVG(p))},_setSVGBgOverlayImage:function(h,u,p){this[u]&&!this[u].excludeFromExport&&this[u].toSVG&&h.push(this[u].toSVG(p))},_setSVGBgOverlayColor:function(h,u){var p=this[u+"Color"],_=this.viewportTransform,y=this.width,v=this.height;if(p)if(p.toLive){var w=p.repeat,T=d.util.invertTransform(_),P=this[u+"Vpt"]?d.util.matrixToSVG(T):"";h.push('<rect transform="'+P+" translate(",y/2,",",v/2,')"',' x="',p.offsetX-y/2,'" y="',p.offsetY-v/2,'" ','width="',w==="repeat-y"||w==="no-repeat"?p.source.width:y,'" height="',w==="repeat-x"||w==="no-repeat"?p.source.height:v,'" fill="url(#SVGID_'+p.id+')"',`></rect>
`)}else h.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',p,'"',`></rect>
`)},sendToBack:function(h){if(!h)return this;var u,p,_,y=this._activeObject;if(h===y&&h.type==="activeSelection")for(u=(_=y._objects).length;u--;)p=_[u],r(this._objects,p),this._objects.unshift(p);else r(this._objects,h),this._objects.unshift(h);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(h){if(!h)return this;var u,p,_,y=this._activeObject;if(h===y&&h.type==="activeSelection")for(_=y._objects,u=0;u<_.length;u++)p=_[u],r(this._objects,p),this._objects.push(p);else r(this._objects,h),this._objects.push(h);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(h,u){if(!h)return this;var p,_,y,v,w,T=this._activeObject,P=0;if(h===T&&h.type==="activeSelection")for(w=T._objects,p=0;p<w.length;p++)_=w[p],(y=this._objects.indexOf(_))>0+P&&(v=y-1,r(this._objects,_),this._objects.splice(v,0,_)),P++;else(y=this._objects.indexOf(h))!==0&&(v=this._findNewLowerIndex(h,y,u),r(this._objects,h),this._objects.splice(v,0,h));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(h,u,p){var _,y;if(p){for(_=u,y=u-1;y>=0;--y)if(h.intersectsWithObject(this._objects[y])||h.isContainedWithinObject(this._objects[y])||this._objects[y].isContainedWithinObject(h)){_=y;break}}else _=u-1;return _},bringForward:function(h,u){if(!h)return this;var p,_,y,v,w,T=this._activeObject,P=0;if(h===T&&h.type==="activeSelection")for(p=(w=T._objects).length;p--;)_=w[p],(y=this._objects.indexOf(_))<this._objects.length-1-P&&(v=y+1,r(this._objects,_),this._objects.splice(v,0,_)),P++;else(y=this._objects.indexOf(h))!==this._objects.length-1&&(v=this._findNewUpperIndex(h,y,u),r(this._objects,h),this._objects.splice(v,0,h));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(h,u,p){var _,y,v;if(p){for(_=u,y=u+1,v=this._objects.length;y<v;++y)if(h.intersectsWithObject(this._objects[y])||h.isContainedWithinObject(this._objects[y])||this._objects[y].isContainedWithinObject(h)){_=y;break}}else _=u+1;return _},moveTo:function(h,u){return r(this._objects,h),this._objects.splice(u,0,h),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(d.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(h){h.dispose&&h.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),d.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),d.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),n(d.StaticCanvas.prototype,d.Observable),n(d.StaticCanvas.prototype,d.Collection),n(d.StaticCanvas.prototype,d.DataURLExporter),n(d.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(h){var u=l();if(!u||!u.getContext)return null;var p=u.getContext("2d");return p&&h==="setLineDash"?p.setLineDash!==void 0:null}}),d.StaticCanvas.prototype.toJSON=d.StaticCanvas.prototype.toObject,d.isLikelyNode&&(d.StaticCanvas.prototype.createPNGStream=function(){var h=s(this.lowerCanvasEl);return h&&h.createPNGStream()},d.StaticCanvas.prototype.createJPEGStream=function(h){var u=s(this.lowerCanvasEl);return u&&u.createJPEGStream(h)})}}(),d.BaseBrush=d.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(n){n.strokeStyle=this.color,n.lineWidth=this.width,n.lineCap=this.strokeLineCap,n.miterLimit=this.strokeMiterLimit,n.lineJoin=this.strokeLineJoin,n.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(n){var i=this.canvas.viewportTransform;n.save(),n.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var n=this.canvas,i=this.shadow,r=n.contextTop,o=n.getZoom();n&&n._isRetinaScaling()&&(o*=d.devicePixelRatio),r.shadowColor=i.color,r.shadowBlur=i.blur*o,r.shadowOffsetX=i.offsetX*o,r.shadowOffsetY=i.offsetY*o}},needsFullRender:function(){return new d.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var n=this.canvas.contextTop;n.shadowColor="",n.shadowBlur=n.shadowOffsetX=n.shadowOffsetY=0},_isOutSideCanvas:function(n){return n.x<0||n.x>this.canvas.getWidth()||n.y<0||n.y>this.canvas.getHeight()}}),d.PencilBrush=d.util.createClass(d.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(n){this.canvas=n,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(n,i,r){var o=i.midPointFrom(r);return n.quadraticCurveTo(i.x,i.y,o.x,o.y),o},onMouseDown:function(n,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(n),this._captureDrawingPath(n),this._render())},onMouseMove:function(n,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(n))&&this._captureDrawingPath(n)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var r=this._points,o=r.length,t=this.canvas.contextTop;this._saveAndTransform(t),this.oldEnd&&(t.beginPath(),t.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(t,r[o-2],r[o-1],!0),t.stroke(),t.restore()}},onMouseUp:function(n){return!this.canvas._isMainEvent(n.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(n){var i=new d.Point(n.x,n.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(n){return!(this._points.length>1&&n.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(n),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(n){var i=new d.Point(n.x,n.y);return this._addPoint(i)},_render:function(n){var i,r,o=this._points[0],t=this._points[1];if(n=n||this.canvas.contextTop,this._saveAndTransform(n),n.beginPath(),this._points.length===2&&o.x===t.x&&o.y===t.y){var e=this.width/1e3;o=new d.Point(o.x,o.y),t=new d.Point(t.x,t.y),o.x-=e,t.x+=e}for(n.moveTo(o.x,o.y),i=1,r=this._points.length;i<r;i++)this._drawSegment(n,o,t),o=this._points[i],t=this._points[i+1];n.lineTo(o.x,o.y),n.stroke(),n.restore()},convertPointsToSVGPath:function(n){var i=this.width/1e3;return d.util.getSmoothPathFromPoints(n,i)},_isEmptySVGPath:function(n){return d.util.joinPath(n)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(n){var i=new d.Path(n,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new d.Shadow(this.shadow)),i},decimatePoints:function(n,i){if(n.length<=2)return n;var r,o=this.canvas.getZoom(),t=Math.pow(i/o,2),e=n.length-1,s=n[0],l=[s];for(r=1;r<e-1;r++)Math.pow(s.x-n[r].x,2)+Math.pow(s.y-n[r].y,2)>=t&&(s=n[r],l.push(s));return l.push(n[e]),l},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var n=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(n))this.canvas.requestRenderAll();else{var i=this.createPath(n);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),d.CircleBrush=d.util.createClass(d.BaseBrush,{width:10,initialize:function(n){this.canvas=n,this.points=[]},drawDot:function(n){var i=this.addPoint(n),r=this.canvas.contextTop;this._saveAndTransform(r),this.dot(r,i),r.restore()},dot:function(n,i){n.fillStyle=i.fill,n.beginPath(),n.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),n.closePath(),n.fill()},onMouseDown:function(n){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(n)},_render:function(){var n,i,r=this.canvas.contextTop,o=this.points;for(this._saveAndTransform(r),n=0,i=o.length;n<i;n++)this.dot(r,o[n]);r.restore()},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(n),this._render()):this.drawDot(n))},onMouseUp:function(){var n,i,r=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var o=[];for(n=0,i=this.points.length;n<i;n++){var t=this.points[n],e=new d.Circle({radius:t.radius,left:t.x,top:t.y,originX:"center",originY:"center",fill:t.fill});this.shadow&&(e.shadow=new d.Shadow(this.shadow)),o.push(e)}var s=new d.Group(o);s.canvas=this.canvas,this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.fire("path:created",{path:s}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=r,this.canvas.requestRenderAll()},addPoint:function(n){var i=new d.Point(n.x,n.y),r=d.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,o=new d.Color(this.color).setAlpha(d.util.getRandomInt(0,100)/100).toRgba();return i.radius=r,i.fill=o,this.points.push(i),i}}),d.SprayBrush=d.util.createClass(d.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(n){this.canvas=n,this.sprayChunks=[]},onMouseDown:function(n){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(n),this.render(this.sprayChunkPoints)},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.addSprayChunk(n),this.render(this.sprayChunkPoints))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],r=0,o=this.sprayChunks.length;r<o;r++)for(var t=this.sprayChunks[r],e=0,s=t.length;e<s;e++){var l=new d.Rect({width:t[e].width,height:t[e].width,left:t[e].x+1,top:t[e].y+1,originX:"center",originY:"center",fill:this.color});i.push(l)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var a=new d.Group(i);this.shadow&&a.set("shadow",new d.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:a}),this.canvas.add(a),this.canvas.fire("path:created",{path:a}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},_getOptimizedRects:function(n){var i,r,o,t={};for(r=0,o=n.length;r<o;r++)t[i=n[r].left+""+n[r].top]||(t[i]=n[r]);var e=[];for(i in t)e.push(t[i]);return e},render:function(n){var i,r,o=this.canvas.contextTop;for(o.fillStyle=this.color,this._saveAndTransform(o),i=0,r=n.length;i<r;i++){var t=n[i];t.opacity!==void 0&&(o.globalAlpha=t.opacity),o.fillRect(t.x,t.y,t.width,t.width)}o.restore()},_render:function(){var n,i,r=this.canvas.contextTop;for(r.fillStyle=this.color,this._saveAndTransform(r),n=0,i=this.sprayChunks.length;n<i;n++)this.render(this.sprayChunks[n]);r.restore()},addSprayChunk:function(n){this.sprayChunkPoints=[];var i,r,o,t,e=this.width/2;for(t=0;t<this.density;t++){i=d.util.getRandomInt(n.x-e,n.x+e),r=d.util.getRandomInt(n.y-e,n.y+e),o=this.dotWidthVariance?d.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var s=new d.Point(i,r);s.width=o,this.randomOpacity&&(s.opacity=d.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(s)}this.sprayChunks.push(this.sprayChunkPoints)}}),d.PatternBrush=d.util.createClass(d.PencilBrush,{getPatternSrc:function(){var n=d.util.createCanvasElement(),i=n.getContext("2d");return n.width=n.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),n},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(n){return n.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(n){this.callSuper("_setBrushStyles",n),n.strokeStyle=this.getPattern(n)},createPath:function(n){var i=this.callSuper("createPath",n),r=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new d.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-r.x,offsetY:-r.y}),i}}),function(){var n=d.util.getPointer,i=d.util.degreesToRadians,r=d.util.isTouchEvent;for(var o in d.Canvas=d.util.createClass(d.StaticCanvas,{initialize:function(t,e){e||(e={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=d.PencilBrush&&new d.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var t,e,s,l=this.getActiveObjects();if(l.length>0&&!this.preserveObjectStacking){e=[],s=[];for(var a=0,h=this._objects.length;a<h;a++)t=this._objects[a],l.indexOf(t)===-1?e.push(t):s.push(t);l.length>1&&(this._activeObject._objects=s),e.push.apply(e,s)}else e=this._objects;return e},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var t=this.contextContainer;return this.renderCanvas(t,this._chooseObjectsToRender()),this},renderTopLayer:function(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()},renderTop:function(){var t=this.contextTop;return this.clearContext(t),this.renderTopLayer(t),this.fire("after:render"),this},_normalizePointer:function(t,e){var s=t.calcTransformMatrix(),l=d.util.invertTransform(s),a=this.restorePointerVpt(e);return d.util.transformPoint(a,l)},isTargetTransparent:function(t,e,s){if(t.shouldCache()&&t._cacheCanvas&&t!==this._activeObject){var l=this._normalizePointer(t,{x:e,y:s}),a=Math.max(t.cacheTranslationX+l.x*t.zoomX,0),h=Math.max(t.cacheTranslationY+l.y*t.zoomY,0);return d.util.isTransparent(t._cacheContext,Math.round(a),Math.round(h),this.targetFindTolerance)}var u=this.contextCache,p=t.selectionBackgroundColor,_=this.viewportTransform;return t.selectionBackgroundColor="",this.clearContext(u),u.save(),u.transform(_[0],_[1],_[2],_[3],_[4],_[5]),t.render(u),u.restore(),t.selectionBackgroundColor=p,d.util.isTransparent(u,e,s,this.targetFindTolerance)},_isSelectionKeyPressed:function(t){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(e){return t[e]===!0}):t[this.selectionKey]},_shouldClearSelection:function(t,e){var s=this.getActiveObjects(),l=this._activeObject;return!e||e&&l&&s.length>1&&s.indexOf(e)===-1&&l!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&l&&l!==e},_shouldCenterTransform:function(t,e,s){var l;if(t)return e==="scale"||e==="scaleX"||e==="scaleY"||e==="resizing"?l=this.centeredScaling||t.centeredScaling:e==="rotate"&&(l=this.centeredRotation||t.centeredRotation),l?!s:s},_getOriginFromCorner:function(t,e){var s={x:t.originX,y:t.originY};return e==="ml"||e==="tl"||e==="bl"?s.x="right":e!=="mr"&&e!=="tr"&&e!=="br"||(s.x="left"),e==="tl"||e==="mt"||e==="tr"?s.y="bottom":e!=="bl"&&e!=="mb"&&e!=="br"||(s.y="top"),s},_getActionFromCorner:function(t,e,s,l){if(!e||!t)return"drag";var a=l.controls[e];return a.getActionName(s,a,l)},_setupCurrentTransform:function(t,e,s){if(e){var l=this.getPointer(t),a=e.__corner,h=e.controls[a],u=s&&a?h.getActionHandler(t,e,h):d.controlsUtils.dragHandler,p=this._getActionFromCorner(s,a,t,e),_=this._getOriginFromCorner(e,a),y=t[this.centeredKey],v={target:e,action:p,actionHandler:u,corner:a,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:l.x-e.left,offsetY:l.y-e.top,originX:_.x,originY:_.y,ex:l.x,ey:l.y,lastX:l.x,lastY:l.y,theta:i(e.angle),width:e.width*e.scaleX,shiftKey:t.shiftKey,altKey:y,original:d.util.saveObjectTransform(e)};this._shouldCenterTransform(e,p,y)&&(v.originX="center",v.originY="center"),v.original.originX=_.x,v.original.originY=_.y,this._currentTransform=v,this._beforeTransform(t)}},setCursor:function(t){this.upperCanvasEl.style.cursor=t},_drawSelection:function(t){var e=this._groupSelector,s=new d.Point(e.ex,e.ey),l=d.util.transformPoint(s,this.viewportTransform),a=new d.Point(e.ex+e.left,e.ey+e.top),h=d.util.transformPoint(a,this.viewportTransform),u=Math.min(l.x,h.x),p=Math.min(l.y,h.y),_=Math.max(l.x,h.x),y=Math.max(l.y,h.y),v=this.selectionLineWidth/2;this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(u,p,_-u,y-p)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,u+=v,p+=v,_-=v,y-=v,d.Object.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(u,p,_-u,y-p))},findTarget:function(t,e){if(!this.skipTargetFind){var s,l,a=this.getPointer(t,!0),h=this._activeObject,u=this.getActiveObjects(),p=r(t),_=u.length>1&&!e||u.length===1;if(this.targets=[],_&&h._findTargetCorner(a,p)||u.length>1&&!e&&h===this._searchPossibleTargets([h],a))return h;if(u.length===1&&h===this._searchPossibleTargets([h],a)){if(!this.preserveObjectStacking)return h;s=h,l=this.targets,this.targets=[]}var y=this._searchPossibleTargets(this._objects,a);return t[this.altSelectionKey]&&y&&s&&y!==s&&(y=s,this.targets=l),y}},_checkTarget:function(t,e,s){if(e&&e.visible&&e.evented&&e.containsPoint(t)&&(!this.perPixelTargetFind&&!e.perPixelTargetFind||e.isEditing||!this.isTargetTransparent(e,s.x,s.y)))return!0},_searchPossibleTargets:function(t,e){for(var s,l,a=t.length;a--;){var h=t[a],u=h.group?this._normalizePointer(h.group,e):e;if(this._checkTarget(u,h,e)){(s=t[a]).subTargetCheck&&s instanceof d.Group&&(l=this._searchPossibleTargets(s._objects,e))&&this.targets.push(l);break}}return s},restorePointerVpt:function(t){return d.util.transformPoint(t,d.util.invertTransform(this.viewportTransform))},getPointer:function(t,e){if(this._absolutePointer&&!e)return this._absolutePointer;if(this._pointer&&e)return this._pointer;var s,l=n(t),a=this.upperCanvasEl,h=a.getBoundingClientRect(),u=h.width||0,p=h.height||0;u&&p||("top"in h&&"bottom"in h&&(p=Math.abs(h.top-h.bottom)),"right"in h&&"left"in h&&(u=Math.abs(h.right-h.left))),this.calcOffset(),l.x=l.x-this._offset.left,l.y=l.y-this._offset.top,e||(l=this.restorePointerVpt(l));var _=this.getRetinaScaling();return _!==1&&(l.x/=_,l.y/=_),s=u===0||p===0?{width:1,height:1}:{width:a.width/u,height:a.height/p},{x:l.x*s.width,y:l.y*s.height}},_createUpperCanvas:function(){var t=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),e=this.lowerCanvasEl,s=this.upperCanvasEl;s?s.className="":(s=this._createCanvasElement(),this.upperCanvasEl=s),d.util.addClass(s,"upper-canvas "+t),this.wrapperEl.appendChild(s),this._copyCanvasStyle(e,s),this._applyCanvasStyle(s),this.contextTop=s.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=d.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),d.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),d.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(t){var e=this.width||t.width,s=this.height||t.height;d.util.setStyle(t,{position:"absolute",width:e+"px",height:s+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),t.width=e,t.height=s,d.util.makeElementUnselectable(t)},_copyCanvasStyle:function(t,e){e.style.cssText=t.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var t=this._activeObject;return t?t.type==="activeSelection"&&t._objects?t._objects.slice(0):[t]:[]},_onObjectRemoved:function(t){t===this._activeObject&&(this.fire("before:selection:cleared",{target:t}),this._discardActiveObject(),this.fire("selection:cleared",{target:t}),t.fire("deselected")),t===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",t)},_fireSelectionEvents:function(t,e){var s=!1,l=this.getActiveObjects(),a=[],h=[];t.forEach(function(u){l.indexOf(u)===-1&&(s=!0,u.fire("deselected",{e,target:u}),h.push(u))}),l.forEach(function(u){t.indexOf(u)===-1&&(s=!0,u.fire("selected",{e,target:u}),a.push(u))}),t.length>0&&l.length>0?s&&this.fire("selection:updated",{e,selected:a,deselected:h}):l.length>0?this.fire("selection:created",{e,selected:a}):t.length>0&&this.fire("selection:cleared",{e,deselected:h})},setActiveObject:function(t,e){var s=this.getActiveObjects();return this._setActiveObject(t,e),this._fireSelectionEvents(s,e),this},_setActiveObject:function(t,e){return this._activeObject!==t&&!!this._discardActiveObject(e,t)&&!t.onSelect({e})&&(this._activeObject=t,!0)},_discardActiveObject:function(t,e){var s=this._activeObject;if(s){if(s.onDeselect({e:t,object:e}))return!1;this._activeObject=null}return!0},discardActiveObject:function(t){var e=this.getActiveObjects(),s=this.getActiveObject();return e.length&&this.fire("before:selection:cleared",{target:s,e:t}),this._discardActiveObject(t),this._fireSelectionEvents(e,t),this},dispose:function(){var t=this.wrapperEl;return this.removeListeners(),t.removeChild(this.upperCanvasEl),t.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(e){d.util.cleanUpJsdomNode(this[e]),this[e]=void 0}).bind(this)),t.parentNode&&t.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,d.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(t){var e=this._activeObject;e&&e._renderControls(t)},_toObject:function(t,e,s){var l=this._realizeGroupTransformOnObject(t),a=this.callSuper("_toObject",t,e,s);return this._unwindGroupTransformOnObject(t,l),a},_realizeGroupTransformOnObject:function(t){if(t.group&&t.group.type==="activeSelection"&&this._activeObject===t.group){var e={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(s){e[s]=t[s]}),d.util.addTransformToObject(t,this._activeObject.calcOwnMatrix()),e}return null},_unwindGroupTransformOnObject:function(t,e){e&&t.set(e)},_setSVGObject:function(t,e,s){var l=this._realizeGroupTransformOnObject(e);this.callSuper("_setSVGObject",t,e,s),this._unwindGroupTransformOnObject(e,l)},setViewportTransform:function(t){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),d.StaticCanvas.prototype.setViewportTransform.call(this,t)}}),d.StaticCanvas)o!=="prototype"&&(d.Canvas[o]=d.StaticCanvas[o])}(),function(){var n=d.util.addListener,i=d.util.removeListener,r={passive:!1};function o(t,e){return t.button&&t.button===e-1}d.util.object.extend(d.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(n,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(t,e){var s=this.upperCanvasEl,l=this._getEventPrefix();t(d.window,"resize",this._onResize),t(s,l+"down",this._onMouseDown),t(s,l+"move",this._onMouseMove,r),t(s,l+"out",this._onMouseOut),t(s,l+"enter",this._onMouseEnter),t(s,"wheel",this._onMouseWheel),t(s,"contextmenu",this._onContextMenu),t(s,"dblclick",this._onDoubleClick),t(s,"dragover",this._onDragOver),t(s,"dragenter",this._onDragEnter),t(s,"dragleave",this._onDragLeave),t(s,"drop",this._onDrop),this.enablePointerEvents||t(s,"touchstart",this._onTouchStart,r),typeof eventjs<"u"&&e in eventjs&&(eventjs[e](s,"gesture",this._onGesture),eventjs[e](s,"drag",this._onDrag),eventjs[e](s,"orientation",this._onOrientationChange),eventjs[e](s,"shake",this._onShake),eventjs[e](s,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var t=this._getEventPrefix();i(d.document,t+"up",this._onMouseUp),i(d.document,"touchend",this._onTouchEnd,r),i(d.document,t+"move",this._onMouseMove,r),i(d.document,"touchmove",this._onMouseMove,r)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(t,e){this.__onTransformGesture&&this.__onTransformGesture(t,e)},_onDrag:function(t,e){this.__onDrag&&this.__onDrag(t,e)},_onMouseWheel:function(t){this.__onMouseWheel(t)},_onMouseOut:function(t){var e=this._hoveredTarget;this.fire("mouse:out",{target:e,e:t}),this._hoveredTarget=null,e&&e.fire("mouseout",{e:t});var s=this;this._hoveredTargets.forEach(function(l){s.fire("mouse:out",{target:e,e:t}),l&&e.fire("mouseout",{e:t})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(l){l.isEditing&&l.hiddenTextarea.focus()})},_onMouseEnter:function(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",{target:null,e:t}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(t,e){this.__onOrientationChange&&this.__onOrientationChange(t,e)},_onShake:function(t,e){this.__onShake&&this.__onShake(t,e)},_onLongPress:function(t,e){this.__onLongPress&&this.__onLongPress(t,e)},_onDragOver:function(t){t.preventDefault();var e=this._simpleEventHandler("dragover",t);this._fireEnterLeaveEvents(e,t)},_onDrop:function(t){return this._simpleEventHandler("drop:before",t),this._simpleEventHandler("drop",t)},_onContextMenu:function(t){return this.stopContextMenu&&(t.stopPropagation(),t.preventDefault()),!1},_onDoubleClick:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"dblclick"),this._resetTransformEventData(t)},getPointerId:function(t){var e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1},_isMainEvent:function(t){return t.isPrimary===!0||t.isPrimary!==!1&&(t.type==="touchend"&&t.touches.length===0||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(t){t.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();n(d.document,"touchend",this._onTouchEnd,r),n(d.document,"touchmove",this._onMouseMove,r),i(e,s+"down",this._onMouseDown)},_onMouseDown:function(t){this.__onMouseDown(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();i(e,s+"move",this._onMouseMove,r),n(d.document,s+"up",this._onMouseUp),n(d.document,s+"move",this._onMouseMove,r)},_onTouchEnd:function(t){if(!(t.touches.length>0)){this.__onMouseUp(t),this._resetTransformEventData(),this.mainTouchId=null;var e=this._getEventPrefix();i(d.document,"touchend",this._onTouchEnd,r),i(d.document,"touchmove",this._onMouseMove,r);var s=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){n(s.upperCanvasEl,e+"down",s._onMouseDown),s._willAddMouseDown=0},400)}},_onMouseUp:function(t){this.__onMouseUp(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();this._isMainEvent(t)&&(i(d.document,s+"up",this._onMouseUp),i(d.document,s+"move",this._onMouseMove,r),n(e,s+"move",this._onMouseMove,r))},_onMouseMove:function(t){!this.allowTouchScrolling&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)},_onResize:function(){this.calcOffset()},_shouldRender:function(t){var e=this._activeObject;return!!(!!e!=!!t||e&&t&&e!==t)||(e&&e.isEditing,!1)},__onMouseUp:function(t){var e,s=this._currentTransform,l=this._groupSelector,a=!1,h=!l||l.left===0&&l.top===0;if(this._cacheTransformEventData(t),e=this._target,this._handleEvent(t,"up:before"),o(t,3))this.fireRightClick&&this._handleEvent(t,"up",3,h);else{if(o(t,2))return this.fireMiddleClick&&this._handleEvent(t,"up",2,h),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(t);else if(this._isMainEvent(t)){if(s&&(this._finalizeCurrentTransform(t),a=s.actionPerformed),!h){var u=e===this._activeObject;this._maybeGroupObjects(t),a||(a=this._shouldRender(e)||!u&&e===this._activeObject)}var p,_;if(e){if(p=e._findTargetCorner(this.getPointer(t,!0),d.util.isTouchEvent(t)),e.selectable&&e!==this._activeObject&&e.activeOn==="up")this.setActiveObject(e,t),a=!0;else{var y=e.controls[p],v=y&&y.getMouseUpHandler(t,e,y);v&&v(t,s,(_=this.getPointer(t)).x,_.y)}e.isMoving=!1}if(s&&(s.target!==e||s.corner!==p)){var w=s.target&&s.target.controls[s.corner],T=w&&w.getMouseUpHandler(t,e,y);_=_||this.getPointer(t),T&&T(t,s,_.x,_.y)}this._setCursorFromEvent(t,e),this._handleEvent(t,"up",1,h),this._groupSelector=null,this._currentTransform=null,e&&(e.__corner=0),a?this.requestRenderAll():h||this.renderTop()}}},_simpleEventHandler:function(t,e){var s=this.findTarget(e),l=this.targets,a={e,target:s,subTargets:l};if(this.fire(t,a),s&&s.fire(t,a),!l)return s;for(var h=0;h<l.length;h++)l[h].fire(t,a);return s},_handleEvent:function(t,e,s,l){var a=this._target,h=this.targets||[],u={e:t,target:a,subTargets:h,button:s||1,isClick:l||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};e==="up"&&(u.currentTarget=this.findTarget(t),u.currentSubTargets=this.targets),this.fire("mouse:"+e,u),a&&a.fire("mouse"+e,u);for(var p=0;p<h.length;p++)h[p].fire("mouse"+e,u)},_finalizeCurrentTransform:function(t){var e=this._currentTransform,s=e.target,l={e:t,target:s,transform:e,action:e.action};s._scaling&&(s._scaling=!1),s.setCoords(),(e.actionPerformed||this.stateful&&s.hasStateChanged())&&this._fire("modified",l)},_onMouseDownInDrawingMode:function(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(t).requestRenderAll();var e=this.getPointer(t);this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down")},_onMouseMoveInDrawingMode:function(t){if(this._isCurrentlyDrawing){var e=this.getPointer(t);this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")},_onMouseUpInDrawingMode:function(t){var e=this.getPointer(t);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:t,pointer:e}),this._handleEvent(t,"up")},__onMouseDown:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"down:before");var e=this._target;if(o(t,3))this.fireRightClick&&this._handleEvent(t,"down",3);else if(o(t,2))this.fireMiddleClick&&this._handleEvent(t,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(t);else if(this._isMainEvent(t)&&!this._currentTransform){var s=this._pointer;this._previousPointer=s;var l=this._shouldRender(e),a=this._shouldGroup(t,e);if(this._shouldClearSelection(t,e)?this.discardActiveObject(t):a&&(this._handleGrouping(t,e),e=this._activeObject),!this.selection||e&&(e.selectable||e.isEditing||e===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),e){var h=e===this._activeObject;e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);var u=e._findTargetCorner(this.getPointer(t,!0),d.util.isTouchEvent(t));if(e.__corner=u,e===this._activeObject&&(u||!a)){this._setupCurrentTransform(t,e,h);var p=e.controls[u],_=(s=this.getPointer(t),p&&p.getMouseDownHandler(t,e,p));_&&_(t,this._currentTransform,s.x,s.y)}}this._handleEvent(t,"down"),(l||a)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(t){this._resetTransformEventData(),this._pointer=this.getPointer(t,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)||null},_beforeTransform:function(t){var e=this._currentTransform;this.stateful&&e.target.saveState(),this.fire("before:transform",{e:t,transform:e})},__onMouseMove:function(t){var e,s;if(this._handleEvent(t,"move:before"),this._cacheTransformEventData(t),this.isDrawingMode)this._onMouseMoveInDrawingMode(t);else if(this._isMainEvent(t)){var l=this._groupSelector;l?(s=this._absolutePointer,l.left=s.x-l.ex,l.top=s.y-l.ey,this.renderTop()):this._currentTransform?this._transformObject(t):(e=this.findTarget(t)||null,this._setCursorFromEvent(t,e),this._fireOverOutEvents(e,t)),this._handleEvent(t,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(t,e){var s=this._hoveredTarget,l=this._hoveredTargets,a=this.targets,h=Math.max(l.length,a.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:s,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var u=0;u<h;u++)this.fireSyntheticInOutEvents(a[u],e,{oldTarget:l[u],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=t,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(t,e){var s=this._draggedoverTarget,l=this._hoveredTargets,a=this.targets,h=Math.max(l.length,a.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:s,evtOut:"dragleave",evtIn:"dragenter"});for(var u=0;u<h;u++)this.fireSyntheticInOutEvents(a[u],e,{oldTarget:l[u],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=t},fireSyntheticInOutEvents:function(t,e,s){var l,a,h,u=s.oldTarget,p=u!==t,_=s.canvasEvtIn,y=s.canvasEvtOut;p&&(l={e,target:t,previousTarget:u},a={e,target:u,nextTarget:t}),h=t&&p,u&&p&&(y&&this.fire(y,a),u.fire(s.evtOut,a)),h&&(_&&this.fire(_,l),t.fire(s.evtIn,l))},__onMouseWheel:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()},_transformObject:function(t){var e=this.getPointer(t),s=this._currentTransform;s.reset=!1,s.shiftKey=t.shiftKey,s.altKey=t[this.centeredKey],this._performTransformAction(t,s,e),s.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(t,e,s){var l=s.x,a=s.y,h=e.action,u=!1,p=e.actionHandler;p&&(u=p(t,e,l,a)),h==="drag"&&u&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||u},_fire:d.controlsUtils.fireEvent,_setCursorFromEvent:function(t,e){if(!e)return this.setCursor(this.defaultCursor),!1;var s=e.hoverCursor||this.hoverCursor,l=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,a=(!l||!l.contains(e))&&e._findTargetCorner(this.getPointer(t,!0));a?this.setCursor(this.getCornerCursor(a,e,t)):(e.subTargetCheck&&this.targets.concat().reverse().map(function(h){s=h.hoverCursor||s}),this.setCursor(s))},getCornerCursor:function(t,e,s){var l=e.controls[t];return l.cursorStyleHandler(s,l,e)}})}(),at=Math.min,st=Math.max,d.util.object.extend(d.Canvas.prototype,{_shouldGroup:function(n,i){var r=this._activeObject;return r&&this._isSelectionKeyPressed(n)&&i&&i.selectable&&this.selection&&(r!==i||r.type==="activeSelection")&&!i.onSelect({e:n})},_handleGrouping:function(n,i){var r=this._activeObject;r.__corner||(i!==r||(i=this.findTarget(n,!0))&&i.selectable)&&(r&&r.type==="activeSelection"?this._updateActiveSelection(i,n):this._createActiveSelection(i,n))},_updateActiveSelection:function(n,i){var r=this._activeObject,o=r._objects.slice(0);r.contains(n)?(r.removeWithUpdate(n),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat(),r.size()===1&&this._setActiveObject(r.item(0),i)):(r.addWithUpdate(n),this._hoveredTarget=r,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(o,i)},_createActiveSelection:function(n,i){var r=this.getActiveObjects(),o=this._createGroup(n);this._hoveredTarget=o,this._setActiveObject(o,i),this._fireSelectionEvents(r,i)},_createGroup:function(n){var i=this._objects,r=i.indexOf(this._activeObject)<i.indexOf(n)?[this._activeObject,n]:[n,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new d.ActiveSelection(r,{canvas:this})},_groupSelectedObjects:function(n){var i,r=this._collectObjects(n);r.length===1?this.setActiveObject(r[0],n):r.length>1&&(i=new d.ActiveSelection(r.reverse(),{canvas:this}),this.setActiveObject(i,n))},_collectObjects:function(n){for(var i,r=[],o=this._groupSelector.ex,t=this._groupSelector.ey,e=o+this._groupSelector.left,s=t+this._groupSelector.top,l=new d.Point(at(o,e),at(t,s)),a=new d.Point(st(o,e),st(t,s)),h=!this.selectionFullyContained,u=o===e&&t===s,p=this._objects.length;p--&&!((i=this._objects[p])&&i.selectable&&i.visible&&(h&&i.intersectsWithRect(l,a,!0)||i.isContainedWithinRect(l,a,!0)||h&&i.containsPoint(l,null,!0)||h&&i.containsPoint(a,null,!0))&&(r.push(i),u)););return r.length>1&&(r=r.filter(function(_){return!_.onSelect({e:n})})),r},_maybeGroupObjects:function(n){this.selection&&this._groupSelector&&this._groupSelectedObjects(n),this.setCursor(this.defaultCursor),this._groupSelector=null}}),d.util.object.extend(d.StaticCanvas.prototype,{toDataURL:function(n){n||(n={});var i=n.format||"png",r=n.quality||1,o=(n.multiplier||1)*(n.enableRetinaScaling?this.getRetinaScaling():1),t=this.toCanvasElement(o,n);return d.util.toDataURL(t,i,r)},toCanvasElement:function(n,i){n=n||1;var r=((i=i||{}).width||this.width)*n,o=(i.height||this.height)*n,t=this.getZoom(),e=this.width,s=this.height,l=t*n,a=this.viewportTransform,h=(a[4]-(i.left||0))*n,u=(a[5]-(i.top||0))*n,p=this.interactive,_=[l,0,0,l,h,u],y=this.enableRetinaScaling,v=d.util.createCanvasElement(),w=this.contextTop;return v.width=r,v.height=o,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=_,this.width=r,this.height=o,this.calcViewportBoundaries(),this.renderCanvas(v.getContext("2d"),this._objects),this.viewportTransform=a,this.width=e,this.height=s,this.calcViewportBoundaries(),this.interactive=p,this.enableRetinaScaling=y,this.contextTop=w,v}}),d.util.object.extend(d.StaticCanvas.prototype,{loadFromJSON:function(n,i,r){if(n){var o=typeof n=="string"?JSON.parse(n):d.util.object.clone(n),t=this,e=o.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete o.clipPath,this._enlivenObjects(o.objects,function(l){t.clear(),t._setBgOverlay(o,function(){e?t._enlivenObjects([e],function(a){t.clipPath=a[0],t.__setupCanvas.call(t,o,l,s,i)}):t.__setupCanvas.call(t,o,l,s,i)})},r),this}},__setupCanvas:function(n,i,r,o){var t=this;i.forEach(function(e,s){t.insertAt(e,s)}),this.renderOnAddRemove=r,delete n.objects,delete n.backgroundImage,delete n.overlayImage,delete n.background,delete n.overlay,this._setOptions(n),this.renderAll(),o&&o()},_setBgOverlay:function(n,i){var r={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(n.backgroundImage||n.overlayImage||n.background||n.overlay){var o=function(){r.backgroundImage&&r.overlayImage&&r.backgroundColor&&r.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",n.backgroundImage,r,o),this.__setBgOverlay("overlayImage",n.overlayImage,r,o),this.__setBgOverlay("backgroundColor",n.background,r,o),this.__setBgOverlay("overlayColor",n.overlay,r,o)}else i&&i()},__setBgOverlay:function(n,i,r,o){var t=this;if(!i)return r[n]=!0,void(o&&o());n==="backgroundImage"||n==="overlayImage"?d.util.enlivenObjects([i],function(e){t[n]=e[0],r[n]=!0,o&&o()}):this["set"+d.util.string.capitalize(n,!0)](i,function(){r[n]=!0,o&&o()})},_enlivenObjects:function(n,i,r){n&&n.length!==0?d.util.enlivenObjects(n,function(o){i&&i(o)},null,r):i&&i([])},_toDataURL:function(n,i){this.clone(function(r){i(r.toDataURL(n))})},_toDataURLWithMultiplier:function(n,i,r){this.clone(function(o){r(o.toDataURLWithMultiplier(n,i))})},clone:function(n,i){var r=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(o){o.loadFromJSON(r,function(){n&&n(o)})})},cloneWithoutData:function(n){var i=d.util.createCanvasElement();i.width=this.width,i.height=this.height;var r=new d.Canvas(i);this.backgroundImage?(r.setBackgroundImage(this.backgroundImage.src,function(){r.renderAll(),n&&n(r)}),r.backgroundImageOpacity=this.backgroundImageOpacity,r.backgroundImageStretch=this.backgroundImageStretch):n&&n(r)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t=i.util.toFixed,e=i.util.string.capitalize,s=i.util.degreesToRadians,l=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:l,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(a){a&&this.setOptions(a)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(a){var h=i.perfLimitSizeTotal,u=a.width,p=a.height,_=i.maxCacheSideLimit,y=i.minCacheSideLimit;if(u<=_&&p<=_&&u*p<=h)return u<y&&(a.width=y),p<y&&(a.height=y),a;var v=u/p,w=i.util.limitDimsByArea(v,h),T=i.util.capValue,P=T(y,w.x,_),L=T(y,w.y,_);return u>P&&(a.zoomX/=u/P,a.width=P,a.capped=!0),p>L&&(a.zoomY/=p/L,a.height=L,a.capped=!0),a},_getCacheCanvasDimensions:function(){var a=this.getTotalObjectScaling(),h=this._getTransformedDimensions(0,0),u=h.x*a.scaleX/this.scaleX,p=h.y*a.scaleY/this.scaleY;return{width:u+2,height:p+2,zoomX:a.scaleX,zoomY:a.scaleY,x:u,y:p}},_updateCacheCanvas:function(){var a=this.canvas;if(this.noScaleCache&&a&&a._currentTransform){var h=a._currentTransform.target,u=a._currentTransform.action;if(this===h&&u.slice&&u.slice(0,5)==="scale")return!1}var p,_,y=this._cacheCanvas,v=this._limitCacheSize(this._getCacheCanvasDimensions()),w=i.minCacheSideLimit,T=v.width,P=v.height,L=v.zoomX,W=v.zoomY,N=T!==this.cacheWidth||P!==this.cacheHeight,B=this.zoomX!==L||this.zoomY!==W,D=N||B,A=0,k=0,G=!1;if(N){var H=this._cacheCanvas.width,M=this._cacheCanvas.height,I=T>H||P>M;G=I||(T<.9*H||P<.9*M)&&H>w&&M>w,I&&!v.capped&&(T>w||P>w)&&(A=.1*T,k=.1*P)}return this instanceof i.Text&&this.path&&(D=!0,G=!0,A+=this.getHeightOfLine(0)*this.zoomX,k+=this.getHeightOfLine(0)*this.zoomY),!!D&&(G?(y.width=Math.ceil(T+A),y.height=Math.ceil(P+k)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,y.width,y.height)),p=v.x/2,_=v.y/2,this.cacheTranslationX=Math.round(y.width/2-p)+p,this.cacheTranslationY=Math.round(y.height/2-_)+_,this.cacheWidth=T,this.cacheHeight=P,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(L,W),this.zoomX=L,this.zoomY=W,!0)},setOptions:function(a){this._setOptions(a),this._initGradient(a.fill,"fill"),this._initGradient(a.stroke,"stroke"),this._initPattern(a.fill,"fill"),this._initPattern(a.stroke,"stroke")},transform:function(a){var h=this.group&&!this.group._transformDone||this.group&&this.canvas&&a===this.canvas.contextTop,u=this.calcTransformMatrix(!h);a.transform(u[0],u[1],u[2],u[3],u[4],u[5])},toObject:function(a){var h=i.Object.NUM_FRACTION_DIGITS,u={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:t(this.left,h),top:t(this.top,h),width:t(this.width,h),height:t(this.height,h),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:t(this.strokeWidth,h),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:t(this.strokeMiterLimit,h),scaleX:t(this.scaleX,h),scaleY:t(this.scaleY,h),angle:t(this.angle,h),flipX:this.flipX,flipY:this.flipY,opacity:t(this.opacity,h),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:t(this.skewX,h),skewY:t(this.skewY,h)};return this.clipPath&&!this.clipPath.excludeFromExport&&(u.clipPath=this.clipPath.toObject(a),u.clipPath.inverted=this.clipPath.inverted,u.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,u,a),this.includeDefaultValues||(u=this._removeDefaultValues(u)),u},toDatalessObject:function(a){return this.toObject(a)},_removeDefaultValues:function(a){var h=i.util.getKlass(a.type).prototype;return h.stateProperties.forEach(function(u){u!=="left"&&u!=="top"&&(a[u]===h[u]&&delete a[u],Array.isArray(a[u])&&Array.isArray(h[u])&&a[u].length===0&&h[u].length===0&&delete a[u])}),a},toString:function(){return"#<fabric."+e(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var a=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(a.scaleX),scaleY:Math.abs(a.scaleY)}},getTotalObjectScaling:function(){var a=this.getObjectScaling(),h=a.scaleX,u=a.scaleY;if(this.canvas){var p=this.canvas.getZoom(),_=this.canvas.getRetinaScaling();h*=p*_,u*=p*_}return{scaleX:h,scaleY:u}},getObjectOpacity:function(){var a=this.opacity;return this.group&&(a*=this.group.getObjectOpacity()),a},_set:function(a,h){var u=a==="scaleX"||a==="scaleY",p=this[a]!==h,_=!1;return u&&(h=this._constrainScale(h)),a==="scaleX"&&h<0?(this.flipX=!this.flipX,h*=-1):a==="scaleY"&&h<0?(this.flipY=!this.flipY,h*=-1):a!=="shadow"||!h||h instanceof i.Shadow?a==="dirty"&&this.group&&this.group.set("dirty",h):h=new i.Shadow(h),this[a]=h,p&&(_=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(a)>-1?(this.dirty=!0,_&&this.group.set("dirty",!0)):_&&this.stateProperties.indexOf(a)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(a){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(a.save(),this._setupCompositeOperation(a),this.drawSelectionBackground(a),this.transform(a),this._setOpacity(a),this._setShadow(a,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(a)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(a),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),a.restore())},renderCache:function(a){a=a||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,a.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(a,h){if(a.save(),h.inverted?a.globalCompositeOperation="destination-out":a.globalCompositeOperation="destination-in",h.absolutePositioned){var u=i.util.invertTransform(this.calcTransformMatrix());a.transform(u[0],u[1],u[2],u[3],u[4],u[5])}h.transform(a),a.scale(1/h.zoomX,1/h.zoomY),a.drawImage(h._cacheCanvas,-h.cacheTranslationX,-h.cacheTranslationY),a.restore()},drawObject:function(a,h){var u=this.fill,p=this.stroke;h?(this.fill="black",this.stroke="",this._setClippingProperties(a)):this._renderBackground(a),this._render(a),this._drawClipPath(a,this.clipPath),this.fill=u,this.stroke=p},_drawClipPath:function(a,h){h&&(h.canvas=this.canvas,h.shouldCache(),h._transformDone=!0,h.renderCache({forClipping:!0}),this.drawClipPathOnCache(a,h))},drawCacheOnCanvas:function(a){a.scale(1/this.zoomX,1/this.zoomY),a.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(a){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!a&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!a){var h=this.cacheWidth/this.zoomX,u=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-h/2,-u/2,h,u)}return!0}return!1},_renderBackground:function(a){if(this.backgroundColor){var h=this._getNonTransformedDimensions();a.fillStyle=this.backgroundColor,a.fillRect(-h.x/2,-h.y/2,h.x,h.y),this._removeShadow(a)}},_setOpacity:function(a){this.group&&!this.group._transformDone?a.globalAlpha=this.getObjectOpacity():a.globalAlpha*=this.opacity},_setStrokeStyles:function(a,h){var u=h.stroke;u&&(a.lineWidth=h.strokeWidth,a.lineCap=h.strokeLineCap,a.lineDashOffset=h.strokeDashOffset,a.lineJoin=h.strokeLineJoin,a.miterLimit=h.strokeMiterLimit,u.toLive?u.gradientUnits==="percentage"||u.gradientTransform||u.patternTransform?this._applyPatternForTransformedGradient(a,u):(a.strokeStyle=u.toLive(a,this),this._applyPatternGradientTransform(a,u)):a.strokeStyle=h.stroke)},_setFillStyles:function(a,h){var u=h.fill;u&&(u.toLive?(a.fillStyle=u.toLive(a,this),this._applyPatternGradientTransform(a,h.fill)):a.fillStyle=u)},_setClippingProperties:function(a){a.globalAlpha=1,a.strokeStyle="transparent",a.fillStyle="#000000"},_setLineDash:function(a,h){h&&h.length!==0&&(1&h.length&&h.push.apply(h,h),a.setLineDash(h))},_renderControls:function(a,h){var u,p,_,y=this.getViewportTransform(),v=this.calcTransformMatrix();p=(h=h||{}).hasBorders!==void 0?h.hasBorders:this.hasBorders,_=h.hasControls!==void 0?h.hasControls:this.hasControls,v=i.util.multiplyTransformMatrices(y,v),u=i.util.qrDecompose(v),a.save(),a.translate(u.translateX,u.translateY),a.lineWidth=1*this.borderScaleFactor,this.group||(a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(u.angle-=180),a.rotate(s(this.group?u.angle:this.angle)),h.forActiveSelection||this.group?p&&this.drawBordersInGroup(a,u,h):p&&this.drawBorders(a,h),_&&this.drawControls(a,h),a.restore()},_setShadow:function(a){if(this.shadow){var h,u=this.shadow,p=this.canvas,_=p&&p.viewportTransform[0]||1,y=p&&p.viewportTransform[3]||1;h=u.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p&&p._isRetinaScaling()&&(_*=i.devicePixelRatio,y*=i.devicePixelRatio),a.shadowColor=u.color,a.shadowBlur=u.blur*i.browserShadowBlurConstant*(_+y)*(h.scaleX+h.scaleY)/4,a.shadowOffsetX=u.offsetX*_*h.scaleX,a.shadowOffsetY=u.offsetY*y*h.scaleY}},_removeShadow:function(a){this.shadow&&(a.shadowColor="",a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0)},_applyPatternGradientTransform:function(a,h){if(!h||!h.toLive)return{offsetX:0,offsetY:0};var u=h.gradientTransform||h.patternTransform,p=-this.width/2+h.offsetX||0,_=-this.height/2+h.offsetY||0;return h.gradientUnits==="percentage"?a.transform(this.width,0,0,this.height,p,_):a.transform(1,0,0,1,p,_),u&&a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),{offsetX:p,offsetY:_}},_renderPaintInOrder:function(a){this.paintFirst==="stroke"?(this._renderStroke(a),this._renderFill(a)):(this._renderFill(a),this._renderStroke(a))},_render:function(){},_renderFill:function(a){this.fill&&(a.save(),this._setFillStyles(a,this),this.fillRule==="evenodd"?a.fill("evenodd"):a.fill(),a.restore())},_renderStroke:function(a){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(a),a.save(),this.strokeUniform&&this.group){var h=this.getObjectScaling();a.scale(1/h.scaleX,1/h.scaleY)}else this.strokeUniform&&a.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(a,this.strokeDashArray),this._setStrokeStyles(a,this),a.stroke(),a.restore()}},_applyPatternForTransformedGradient:function(a,h){var u,p=this._limitCacheSize(this._getCacheCanvasDimensions()),_=i.util.createCanvasElement(),y=this.canvas.getRetinaScaling(),v=p.x/this.scaleX/y,w=p.y/this.scaleY/y;_.width=v,_.height=w,(u=_.getContext("2d")).beginPath(),u.moveTo(0,0),u.lineTo(v,0),u.lineTo(v,w),u.lineTo(0,w),u.closePath(),u.translate(v/2,w/2),u.scale(p.zoomX/this.scaleX/y,p.zoomY/this.scaleY/y),this._applyPatternGradientTransform(u,h),u.fillStyle=h.toLive(a),u.fill(),a.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),a.scale(y*this.scaleX/p.zoomX,y*this.scaleY/p.zoomY),a.strokeStyle=u.createPattern(_,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var a=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",a.scaleX),this.set("scaleY",a.scaleY),this.angle=a.angle,this.skewX=a.skewX,this.skewY=0}},_removeTransformMatrix:function(a){var h=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),h=i.util.transformPoint(h,this.transformMatrix)),this.transformMatrix=null,a&&(this.scaleX*=a.scaleX,this.scaleY*=a.scaleY,this.cropX=a.cropX,this.cropY=a.cropY,h.x+=a.offsetLeft,h.y+=a.offsetTop,this.width=a.width,this.height=a.height),this.setPositionByOrigin(h,"center","center")},clone:function(a,h){var u=this.toObject(h);this.constructor.fromObject?this.constructor.fromObject(u,a):i.Object._fromObject("Object",u,a)},cloneAsImage:function(a,h){var u=this.toCanvasElement(h);return a&&a(new i.Image(u)),this},toCanvasElement:function(a){a||(a={});var h=i.util,u=h.saveObjectTransform(this),p=this.group,_=this.shadow,y=Math.abs,v=(a.multiplier||1)*(a.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,a.withoutTransform&&h.resetObjectTransform(this),a.withoutShadow&&(this.shadow=null);var w,T,P,L,W=i.util.createCanvasElement(),N=this.getBoundingRect(!0,!0),B=this.shadow,D={x:0,y:0};B&&(T=B.blur,w=B.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),D.x=2*Math.round(y(B.offsetX)+T)*y(w.scaleX),D.y=2*Math.round(y(B.offsetY)+T)*y(w.scaleY)),P=N.width+D.x,L=N.height+D.y,W.width=Math.ceil(P),W.height=Math.ceil(L);var A=new i.StaticCanvas(W,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});a.format==="jpeg"&&(A.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(A.width/2,A.height/2),"center","center");var k=this.canvas;A.add(this);var G=A.toCanvasElement(v||1,a);return this.shadow=_,this.set("canvas",k),p&&(this.group=p),this.set(u).setCoords(),A._objects=[],A.dispose(),A=null,G},toDataURL:function(a){return a||(a={}),i.util.toDataURL(this.toCanvasElement(a),a.format||"png",a.quality||1)},isType:function(a){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===a},complexity:function(){return 1},toJSON:function(a){return this.toObject(a)},rotate:function(a){var h=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return h&&this._setOriginToCenter(),this.set("angle",a),h&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(a,h){h=h||this.canvas.getPointer(a);var u=new i.Point(h.x,h.y),p=this._getLeftTopCoords();return this.angle&&(u=i.util.rotatePoint(u,p,s(-this.angle))),{x:u.x-p.x,y:u.y-p.y}},_setupCompositeOperation:function(a){this.globalCompositeOperation&&(a.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),r(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(a,h,u,p){var _=i[a];h=o(h,!0),i.util.enlivenPatterns([h.fill,h.stroke],function(y){y[0]!==void 0&&(h.fill=y[0]),y[1]!==void 0&&(h.stroke=y[1]),i.util.enlivenObjectEnlivables(h,h,function(){var v=p?new _(h[p],h):new _(h);u&&u(v)})})},i.Object.__uid=0)}(c),dt=d.util.degreesToRadians,gt={left:-.5,center:0,right:.5},pt={top:-.5,center:0,bottom:.5},d.util.object.extend(d.Object.prototype,{translateToGivenOrigin:function(n,i,r,o,t){var e,s,l,a=n.x,h=n.y;return typeof i=="string"?i=gt[i]:i-=.5,typeof o=="string"?o=gt[o]:o-=.5,typeof r=="string"?r=pt[r]:r-=.5,typeof t=="string"?t=pt[t]:t-=.5,s=t-r,((e=o-i)||s)&&(l=this._getTransformedDimensions(),a=n.x+e*l.x,h=n.y+s*l.y),new d.Point(a,h)},translateToCenterPoint:function(n,i,r){var o=this.translateToGivenOrigin(n,i,r,"center","center");return this.angle?d.util.rotatePoint(o,n,dt(this.angle)):o},translateToOriginPoint:function(n,i,r){var o=this.translateToGivenOrigin(n,"center","center",i,r);return this.angle?d.util.rotatePoint(o,n,dt(this.angle)):o},getCenterPoint:function(){var n=new d.Point(this.left,this.top);return this.translateToCenterPoint(n,this.originX,this.originY)},getPointByOrigin:function(n,i){var r=this.getCenterPoint();return this.translateToOriginPoint(r,n,i)},toLocalPoint:function(n,i,r){var o,t,e=this.getCenterPoint();return o=i!==void 0&&r!==void 0?this.translateToGivenOrigin(e,"center","center",i,r):new d.Point(this.left,this.top),t=new d.Point(n.x,n.y),this.angle&&(t=d.util.rotatePoint(t,e,-dt(this.angle))),t.subtractEquals(o)},setPositionByOrigin:function(n,i,r){var o=this.translateToCenterPoint(n,i,r),t=this.translateToOriginPoint(o,this.originX,this.originY);this.set("left",t.x),this.set("top",t.y)},adjustPosition:function(n){var i,r,o=dt(this.angle),t=this.getScaledWidth(),e=d.util.cos(o)*t,s=d.util.sin(o)*t;i=typeof this.originX=="string"?gt[this.originX]:this.originX-.5,r=typeof n=="string"?gt[n]:n-.5,this.left+=e*(r-i),this.top+=s*(r-i),this.setCoords(),this.originX=n},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var n=this.getCenterPoint();this.originX="center",this.originY="center",this.left=n.x,this.top=n.y},_resetOrigin:function(){var n=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=n.x,this.top=n.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var n=d.util,i=n.degreesToRadians,r=n.multiplyTransformMatrices,o=n.transformPoint;n.object.extend(d.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(t,e){return e?t?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),t?this.aCoords:this.lineCoords)},getCoords:function(t,e){return s=this._getCoords(t,e),[new d.Point(s.tl.x,s.tl.y),new d.Point(s.tr.x,s.tr.y),new d.Point(s.br.x,s.br.y),new d.Point(s.bl.x,s.bl.y)];var s},intersectsWithRect:function(t,e,s,l){var a=this.getCoords(s,l);return d.Intersection.intersectPolygonRectangle(a,t,e).status==="Intersection"},intersectsWithObject:function(t,e,s){return d.Intersection.intersectPolygonPolygon(this.getCoords(e,s),t.getCoords(e,s)).status==="Intersection"||t.isContainedWithinObject(this,e,s)||this.isContainedWithinObject(t,e,s)},isContainedWithinObject:function(t,e,s){for(var l=this.getCoords(e,s),a=e?t.aCoords:t.lineCoords,h=0,u=t._getImageLines(a);h<4;h++)if(!t.containsPoint(l[h],u))return!1;return!0},isContainedWithinRect:function(t,e,s,l){var a=this.getBoundingRect(s,l);return a.left>=t.x&&a.left+a.width<=e.x&&a.top>=t.y&&a.top+a.height<=e.y},containsPoint:function(t,e,s,l){var a=this._getCoords(s,l),h=(e=e||this._getImageLines(a),this._findCrossPoints(t,e));return h!==0&&h%2==1},isOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.getCoords(!0,t).some(function(l){return l.x<=s.x&&l.x>=e.x&&l.y<=s.y&&l.y>=e.y})||!!this.intersectsWithRect(e,s,!0,t)||this._containsCenterOfCanvas(e,s,t)},_containsCenterOfCanvas:function(t,e,s){var l={x:(t.x+e.x)/2,y:(t.y+e.y)/2};return!!this.containsPoint(l,null,!0,s)},isPartiallyOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.intersectsWithRect(e,s,!0,t)||this.getCoords(!0,t).every(function(l){return(l.x>=s.x||l.x<=e.x)&&(l.y>=s.y||l.y<=e.y)})&&this._containsCenterOfCanvas(e,s,t)},_getImageLines:function(t){return{topline:{o:t.tl,d:t.tr},rightline:{o:t.tr,d:t.br},bottomline:{o:t.br,d:t.bl},leftline:{o:t.bl,d:t.tl}}},_findCrossPoints:function(t,e){var s,l,a,h=0;for(var u in e)if(!((a=e[u]).o.y<t.y&&a.d.y<t.y||a.o.y>=t.y&&a.d.y>=t.y||(a.o.x===a.d.x&&a.o.x>=t.x?l=a.o.x:(s=(a.d.y-a.o.y)/(a.d.x-a.o.x),l=-(t.y-0*t.x-(a.o.y-s*a.o.x))/(0-s)),l>=t.x&&(h+=1),h!==2)))break;return h},getBoundingRect:function(t,e){var s=this.getCoords(t,e);return n.makeBoundingBoxFromPoints(s)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t},scale:function(t){return this._set("scaleX",t),this._set("scaleY",t),this.setCoords()},scaleToWidth:function(t,e){var s=this.getBoundingRect(e).width/this.getScaledWidth();return this.scale(t/this.width/s)},scaleToHeight:function(t,e){var s=this.getBoundingRect(e).height/this.getScaledHeight();return this.scale(t/this.height/s)},calcLineCoords:function(){var t=this.getViewportTransform(),e=this.padding,s=i(this.angle),l=n.cos(s)*e,a=n.sin(s)*e,h=l+a,u=l-a,p=this.calcACoords(),_={tl:o(p.tl,t),tr:o(p.tr,t),bl:o(p.bl,t),br:o(p.br,t)};return e&&(_.tl.x-=u,_.tl.y-=h,_.tr.x+=h,_.tr.y-=u,_.bl.x-=h,_.bl.y+=u,_.br.x+=u,_.br.y+=h),_},calcOCoords:function(){var t=this._calcRotateMatrix(),e=this._calcTranslateMatrix(),s=this.getViewportTransform(),l=r(s,e),a=r(l,t),h=(a=r(a,[1/s[0],0,0,1/s[3],0,0]),this._calculateCurrentDimensions()),u={};return this.forEachControl(function(p,_,y){u[_]=p.positionHandler(h,a,y)}),u},calcACoords:function(){var t=this._calcRotateMatrix(),e=this._calcTranslateMatrix(),s=r(e,t),l=this._getTransformedDimensions(),a=l.x/2,h=l.y/2;return{tl:o({x:-a,y:-h},s),tr:o({x:a,y:-h},s),bl:o({x:-a,y:h},s),br:o({x:a,y:h},s)}},setCoords:function(t){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),t||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return n.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var t=this.getCenterPoint();return[1,0,0,1,t.x,t.y]},transformMatrixKey:function(t){var e="_",s="";return!t&&this.group&&(s=this.group.transformMatrixKey(t)+e),s+this.top+e+this.left+e+this.scaleX+e+this.scaleY+e+this.skewX+e+this.skewY+e+this.angle+e+this.originX+e+this.originY+e+this.width+e+this.height+e+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(t){var e=this.calcOwnMatrix();if(t||!this.group)return e;var s=this.transformMatrixKey(t),l=this.matrixCache||(this.matrixCache={});return l.key===s?l.value:(this.group&&(e=r(this.group.calcTransformMatrix(!1),e)),l.key=s,l.value=e,e)},calcOwnMatrix:function(){var t=this.transformMatrixKey(!0),e=this.ownMatrixCache||(this.ownMatrixCache={});if(e.key===t)return e.value;var s=this._calcTranslateMatrix(),l={angle:this.angle,translateX:s[4],translateY:s[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return e.key=t,e.value=n.composeMatrix(l),e.value},_getNonTransformedDimensions:function(){var t=this.strokeWidth;return{x:this.width+t,y:this.height+t}},_getTransformedDimensions:function(t,e){t===void 0&&(t=this.skewX),e===void 0&&(e=this.skewY);var s,l,a,h=t===0&&e===0;if(this.strokeUniform?(l=this.width,a=this.height):(l=(s=this._getNonTransformedDimensions()).x,a=s.y),h)return this._finalizeDimensions(l*this.scaleX,a*this.scaleY);var u=n.sizeAfterTransform(l,a,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:t,skewY:e});return this._finalizeDimensions(u.x,u.y)},_finalizeDimensions:function(t,e){return this.strokeUniform?{x:t+this.strokeWidth,y:e+this.strokeWidth}:{x:t,y:e}},_calculateCurrentDimensions:function(){var t=this.getViewportTransform(),e=this._getTransformedDimensions();return o(e,t,!0).scalarAdd(2*this.padding)}})}(),d.util.object.extend(d.Object.prototype,{sendToBack:function(){return this.group?d.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?d.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(n){return this.group?d.StaticCanvas.prototype.sendBackwards.call(this.group,this,n):this.canvas&&this.canvas.sendBackwards(this,n),this},bringForward:function(n){return this.group?d.StaticCanvas.prototype.bringForward.call(this.group,this,n):this.canvas&&this.canvas.bringForward(this,n),this},moveTo:function(n){return this.group&&this.group.type!=="activeSelection"?d.StaticCanvas.prototype.moveTo.call(this.group,this,n):this.canvas&&this.canvas.moveTo(this,n),this}}),function(){function n(r,o){if(o){if(o.toLive)return r+": url(#SVGID_"+o.id+"); ";var t=new d.Color(o),e=r+": "+t.toRgb()+"; ",s=t.getAlpha();return s!==1&&(e+=r+"-opacity: "+s.toString()+"; "),e}return r+": none; "}var i=d.util.toFixed;d.util.object.extend(d.Object.prototype,{getSvgStyles:function(r){var o=this.fillRule?this.fillRule:"nonzero",t=this.strokeWidth?this.strokeWidth:"0",e=this.strokeDashArray?this.strokeDashArray.join(" "):"none",s=this.strokeDashOffset?this.strokeDashOffset:"0",l=this.strokeLineCap?this.strokeLineCap:"butt",a=this.strokeLineJoin?this.strokeLineJoin:"miter",h=this.strokeMiterLimit?this.strokeMiterLimit:"4",u=this.opacity!==void 0?this.opacity:"1",p=this.visible?"":" visibility: hidden;",_=r?"":this.getSvgFilter(),y=n("fill",this.fill);return[n("stroke",this.stroke),"stroke-width: ",t,"; ","stroke-dasharray: ",e,"; ","stroke-linecap: ",l,"; ","stroke-dashoffset: ",s,"; ","stroke-linejoin: ",a,"; ","stroke-miterlimit: ",h,"; ",y,"fill-rule: ",o,"; ","opacity: ",u,";",_,p].join("")},getSvgSpanStyles:function(r,o){var t="; ",e=r.fontFamily?"font-family: "+(r.fontFamily.indexOf("'")===-1&&r.fontFamily.indexOf('"')===-1?"'"+r.fontFamily+"'":r.fontFamily)+t:"",s=r.strokeWidth?"stroke-width: "+r.strokeWidth+t:"",l=r.fontSize?"font-size: "+r.fontSize+"px"+t:"",a=r.fontStyle?"font-style: "+r.fontStyle+t:"",h=r.fontWeight?"font-weight: "+r.fontWeight+t:"",u=r.fill?n("fill",r.fill):"",p=r.stroke?n("stroke",r.stroke):"",_=this.getSvgTextDecoration(r);return _&&(_="text-decoration: "+_+t),[p,s,e,l,a,h,_,u,r.deltaY?"baseline-shift: "+-r.deltaY+"; ":"",o?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(r){return["overline","underline","line-through"].filter(function(o){return r[o.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(r,o){var t=r?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+d.util.matrixToSVG(t)+(o||"")+'" '},_setSVGBg:function(r){if(this.backgroundColor){var o=d.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,o),'" y="',i(-this.height/2,o),'" width="',i(this.width,o),'" height="',i(this.height,o),`"></rect>
`)}},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(r),{reviver:r})},toClipPathSVG:function(r){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(r),{reviver:r})},_createBaseClipPathSVGMarkup:function(r,o){var t=(o=o||{}).reviver,e=o.additionalTransform||"",s=[this.getSvgTransform(!0,e),this.getSvgCommons()].join(""),l=r.indexOf("COMMON_PARTS");return r[l]=s,t?t(r.join("")):r.join("")},_createBaseSVGMarkup:function(r,o){var t,e,s=(o=o||{}).noStyle,l=o.reviver,a=s?"":'style="'+this.getSvgStyles()+'" ',h=o.withShadow?'style="'+this.getSvgFilter()+'" ':"",u=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",_=u&&u.absolutePositioned,y=this.stroke,v=this.fill,w=this.shadow,T=[],P=r.indexOf("COMMON_PARTS"),L=o.additionalTransform;return u&&(u.clipPathId="CLIPPATH_"+d.Object.__uid++,e='<clipPath id="'+u.clipPathId+`" >
`+u.toClipPathSVG(l)+`</clipPath>
`),_&&T.push("<g ",h,this.getSvgCommons(),` >
`),T.push("<g ",this.getSvgTransform(!1),_?"":h+this.getSvgCommons(),` >
`),t=[a,p,s?"":this.addPaintOrder()," ",L?'transform="'+L+'" ':""].join(""),r[P]=t,v&&v.toLive&&T.push(v.toSVG(this)),y&&y.toLive&&T.push(y.toSVG(this)),w&&T.push(w.toSVG(this)),u&&T.push(e),T.push(r.join("")),T.push(`</g>
`),_&&T.push(`</g>
`),l?l(T.join("")):T.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var n=d.util.object.extend,i="stateProperties";function r(t,e,s){var l={};s.forEach(function(a){l[a]=t[a]}),n(t[e],l,!0)}function o(t,e,s){if(t===e)return!0;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(var l=0,a=t.length;l<a;l++)if(!o(t[l],e[l]))return!1;return!0}if(t&&typeof t=="object"){var h,u=Object.keys(t);if(!e||typeof e!="object"||!s&&u.length!==Object.keys(e).length)return!1;for(l=0,a=u.length;l<a;l++)if((h=u[l])!=="canvas"&&h!=="group"&&!o(t[h],e[h]))return!1;return!0}}d.util.object.extend(d.Object.prototype,{hasStateChanged:function(t){var e="_"+(t=t||i);return Object.keys(this[e]).length<this[t].length||!o(this[e],this,!0)},saveState:function(t){var e=t&&t.propertySet||i,s="_"+e;return this[s]?(r(this,s,this[e]),t&&t.stateProperties&&r(this,s,t.stateProperties),this):this.setupState(t)},setupState:function(t){var e=(t=t||{}).propertySet||i;return t.propertySet=e,this["_"+e]={},this.saveState(t),this}})}(),function(){var n=d.util.degreesToRadians;d.util.object.extend(d.Object.prototype,{_findTargetCorner:function(i,r){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var o,t,e,s=i.x,l=i.y,a=Object.keys(this.oCoords),h=a.length-1;for(this.__corner=0;h>=0;h--)if(e=a[h],this.isControlVisible(e)&&(t=this._getImageLines(r?this.oCoords[e].touchCorner:this.oCoords[e].corner),(o=this._findCrossPoints({x:s,y:l},t))!==0&&o%2==1))return this.__corner=e,e;return!1},forEachControl:function(i){for(var r in this.controls)i(this.controls[r],r,this)},_setCornerCoords:function(){var i=this.oCoords;for(var r in i){var o=this.controls[r];i[r].corner=o.calcCornerCoords(this.angle,this.cornerSize,i[r].x,i[r].y,!1),i[r].touchCorner=o.calcCornerCoords(this.angle,this.touchCornerSize,i[r].x,i[r].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var r=this.getCenterPoint(),o=this._calculateCurrentDimensions(),t=this.canvas.viewportTransform;return i.translate(r.x,r.y),i.scale(1/t[0],1/t[3]),i.rotate(n(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-o.x/2,-o.y/2,o.x,o.y),i.restore(),this},drawBorders:function(i,r){r=r||{};var o=this._calculateCurrentDimensions(),t=this.borderScaleFactor,e=o.x+t,s=o.y+t,l=r.hasControls!==void 0?r.hasControls:this.hasControls,a=!1;return i.save(),i.strokeStyle=r.borderColor||this.borderColor,this._setLineDash(i,r.borderDashArray||this.borderDashArray),i.strokeRect(-e/2,-s/2,e,s),l&&(i.beginPath(),this.forEachControl(function(h,u,p){h.withConnection&&h.getVisibility(p,u)&&(a=!0,i.moveTo(h.x*e,h.y*s),i.lineTo(h.x*e+h.offsetX,h.y*s+h.offsetY))}),a&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,r,o){o=o||{};var t=d.util.sizeAfterTransform(this.width,this.height,r),e=this.strokeWidth,s=this.strokeUniform,l=this.borderScaleFactor,a=t.x+e*(s?this.canvas.getZoom():r.scaleX)+l,h=t.y+e*(s?this.canvas.getZoom():r.scaleY)+l;return i.save(),this._setLineDash(i,o.borderDashArray||this.borderDashArray),i.strokeStyle=o.borderColor||this.borderColor,i.strokeRect(-a/2,-h/2,a,h),i.restore(),this},drawControls:function(i,r){r=r||{},i.save();var o,t,e=this.canvas.getRetinaScaling();return i.setTransform(e,0,0,e,0,0),i.strokeStyle=i.fillStyle=r.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=r.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,r.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(o=this.group.calcTransformMatrix()),this.forEachControl(function(s,l,a){t=a.oCoords[l],s.getVisibility(a,l)&&(o&&(t=d.util.transformPoint(t,o)),s.render(i,t.x,t.y,r,a))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,r){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=r,this},setControlsVisibility:function(i){for(var r in i||(i={}),i)this.setControlVisible(r,i[r]);return this},onDeselect:function(){},onSelect:function(){}})}(),d.util.object.extend(d.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(s){n.set("left",s),e.requestRenderAll(),t()},onComplete:function(){n.setCoords(),o()}})},fxCenterObjectV:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(s){n.set("top",s),e.requestRenderAll(),t()},onComplete:function(){n.setCoords(),o()}})},fxRemove:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(s){n.set("opacity",s),e.requestRenderAll(),t()},onComplete:function(){e.remove(n),o()}})}}),d.util.object.extend(d.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var n,i,r=[],o=[];for(n in arguments[0])r.push(n);for(var t=0,e=r.length;t<e;t++)n=r[t],i=t!==e-1,o.push(this._animate(n,arguments[0][n],arguments[1],i));return o}return this._animate.apply(this,arguments)},_animate:function(n,i,r,o){var t,e=this;i=i.toString(),r=r?d.util.object.clone(r):{},~n.indexOf(".")&&(t=n.split("."));var s=e.colorProperties.indexOf(n)>-1||t&&e.colorProperties.indexOf(t[1])>-1,l=t?this.get(t[0])[t[1]]:this.get(n);"from"in r||(r.from=l),s||(i=~i.indexOf("=")?l+parseFloat(i.replace("=","")):parseFloat(i));var a={target:this,startValue:r.from,endValue:i,byValue:r.by,easing:r.easing,duration:r.duration,abort:r.abort&&function(h,u,p){return r.abort.call(e,h,u,p)},onChange:function(h,u,p){t?e[t[0]][t[1]]=h:e.set(n,h),o||r.onChange&&r.onChange(h,u,p)},onComplete:function(h,u,p){o||(e.setCoords(),r.onComplete&&r.onComplete(h,u,p))}};return s?d.util.animateColor(a.startValue,a.endValue,a.duration,a):d.util.animate(a)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t={x1:1,x2:1,y1:1,y2:1};function e(s,l){var a=s.origin,h=s.axis1,u=s.axis2,p=s.dimension,_=l.nearest,y=l.center,v=l.farthest;return function(){switch(this.get(a)){case _:return Math.min(this.get(h),this.get(u));case y:return Math.min(this.get(h),this.get(u))+.5*this.get(p);case v:return Math.max(this.get(h),this.get(u))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(s,l){s||(s=[0,0,0,0]),this.callSuper("initialize",l),this.set("x1",s[0]),this.set("y1",s[1]),this.set("x2",s[2]),this.set("y2",s[3]),this._setWidthHeight(l)},_setWidthHeight:function(s){s||(s={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in s?s.left:this._getLeftToOriginX(),this.top="top"in s?s.top:this._getTopToOriginY()},_set:function(s,l){return this.callSuper("_set",s,l),t[s]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:e({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:e({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(s){s.beginPath();var l=this.calcLinePoints();s.moveTo(l.x1,l.y1),s.lineTo(l.x2,l.y2),s.lineWidth=this.strokeWidth;var a=s.strokeStyle;s.strokeStyle=this.stroke||s.fillStyle,this.stroke&&this._renderStroke(s),s.strokeStyle=a},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(s){return r(this.callSuper("toObject",s),this.calcLinePoints())},_getNonTransformedDimensions:function(){var s=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(s.y-=this.strokeWidth),this.height===0&&(s.x-=this.strokeWidth)),s},calcLinePoints:function(){var s=this.x1<=this.x2?-1:1,l=this.y1<=this.y2?-1:1,a=s*this.width*.5,h=l*this.height*.5;return{x1:a,x2:s*this.width*-.5,y1:h,y2:l*this.height*-.5}},_toSVG:function(){var s=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',s.x1,'" y1="',s.y1,'" x2="',s.x2,'" y2="',s.y2,`" />
`]}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(s,l,a){a=a||{};var h=i.parseAttributes(s,i.Line.ATTRIBUTE_NAMES),u=[h.x1||0,h.y1||0,h.x2||0,h.y2||0];l(new i.Line(u,r(h,a)))},i.Line.fromObject=function(s,l){var a=o(s,!0);a.points=[s.x1,s.y1,s.x2,s.y2],i.Object._fromObject("Line",a,function(h){delete h.points,l&&l(h)},"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(o,t){return this.callSuper("_set",o,t),o==="radius"&&this.setRadius(t),this},toObject:function(o){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(o))},_toSVG:function(){var o,t=(this.endAngle-this.startAngle)%360;if(t===0)o=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,`" />
`];else{var e=r(this.startAngle),s=r(this.endAngle),l=this.radius;o=['<path d="M '+i.util.cos(e)*l+" "+i.util.sin(e)*l," A "+l+" "+l," 0 ",+(t>180?"1":"0")+" 1"," "+i.util.cos(s)*l+" "+i.util.sin(s)*l,'" ',"COMMON_PARTS",` />
`]}return o},_render:function(o){o.beginPath(),o.arc(0,0,this.radius,r(this.startAngle),r(this.endAngle),!1),this._renderPaintInOrder(o)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(o){return this.radius=o,this.set("width",2*o).set("height",2*o)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(o,t){var e,s=i.parseAttributes(o,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(e=s)&&e.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");s.left=(s.left||0)-s.radius,s.top=(s.top||0)-s.radius,t(new i.Circle(s))},i.Circle.fromObject=function(o,t){i.Object._fromObject("Circle",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(r){var o=this.width/2,t=this.height/2;r.beginPath(),r.moveTo(-o,t),r.lineTo(0,-t),r.lineTo(o,t),r.closePath(),this._renderPaintInOrder(r)},_toSVG:function(){var r=this.width/2,o=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-r+" "+o,"0 "+-o,r+" "+o].join(","),'" />']}}),i.Triangle.fromObject=function(r,o){return i.Object._fromObject("Triangle",r,o)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this.set("rx",o&&o.rx||0),this.set("ry",o&&o.ry||0)},_set:function(o,t){switch(this.callSuper("_set",o,t),o){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(o){o.beginPath(),o.save(),o.transform(1,0,0,this.ry/this.rx,0,0),o.arc(0,0,this.rx,0,r,!1),o.restore(),this._renderPaintInOrder(o)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(o,t){var e=i.parseAttributes(o,i.Ellipse.ATTRIBUTE_NAMES);e.left=(e.left||0)-e.rx,e.top=(e.top||0)-e.ry,t(new i.Ellipse(e))},i.Ellipse.fromObject=function(o,t){i.Object._fromObject("Ellipse",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(o){var t=this.rx?Math.min(this.rx,this.width/2):0,e=this.ry?Math.min(this.ry,this.height/2):0,s=this.width,l=this.height,a=-this.width/2,h=-this.height/2,u=t!==0||e!==0,p=.4477152502;o.beginPath(),o.moveTo(a+t,h),o.lineTo(a+s-t,h),u&&o.bezierCurveTo(a+s-p*t,h,a+s,h+p*e,a+s,h+e),o.lineTo(a+s,h+l-e),u&&o.bezierCurveTo(a+s,h+l-p*e,a+s-p*t,h+l,a+s-t,h+l),o.lineTo(a+t,h+l),u&&o.bezierCurveTo(a+p*t,h+l,a,h+l-p*e,a,h+l-e),o.lineTo(a,h+e),u&&o.bezierCurveTo(a,h+p*e,a+p*t,h,a+t,h),o.closePath(),this._renderPaintInOrder(o)},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(o,t,e){if(!o)return t(null);e=e||{};var s=i.parseAttributes(o,i.Rect.ATTRIBUTE_NAMES);s.left=s.left||0,s.top=s.top||0,s.height=s.height||0,s.width=s.width||0;var l=new i.Rect(r(e?i.util.object.clone(e):{},s));l.visible=l.visible&&l.width>0&&l.height>0,t(l)},i.Rect.fromObject=function(o,t){return i.Object._fromObject("Rect",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.array.min,t=i.util.array.max,e=i.util.toFixed,s=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(l,a){a=a||{},this.points=l||[],this.callSuper("initialize",a),this._setPositionDimensions(a)},_projectStrokeOnPoints:function(){return s(this.points,this,!0)},_setPositionDimensions:function(l){var a,h=this._calcDimensions(l),u=this.exactBoundingBox?this.strokeWidth:0;this.width=h.width-u,this.height=h.height-u,l.fromSVG||(a=this.translateToGivenOrigin({x:h.left-this.strokeWidth/2+u/2,y:h.top-this.strokeWidth/2+u/2},"left","top",this.originX,this.originY)),l.left===void 0&&(this.left=l.fromSVG?h.left:a.x),l.top===void 0&&(this.top=l.fromSVG?h.top:a.y),this.pathOffset={x:h.left+this.width/2+u/2,y:h.top+this.height/2+u/2}},_calcDimensions:function(){var l=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,a=o(l,"x")||0,h=o(l,"y")||0;return{left:a,top:h,width:(t(l,"x")||0)-a,height:(t(l,"y")||0)-h}},toObject:function(l){return r(this.callSuper("toObject",l),{points:this.points.concat()})},_toSVG:function(){for(var l=[],a=this.pathOffset.x,h=this.pathOffset.y,u=i.Object.NUM_FRACTION_DIGITS,p=0,_=this.points.length;p<_;p++)l.push(e(this.points[p].x-a,u),",",e(this.points[p].y-h,u)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',l.join(""),`" />
`]},commonRender:function(l){var a,h=this.points.length,u=this.pathOffset.x,p=this.pathOffset.y;if(!h||isNaN(this.points[h-1].y))return!1;l.beginPath(),l.moveTo(this.points[0].x-u,this.points[0].y-p);for(var _=0;_<h;_++)a=this.points[_],l.lineTo(a.x-u,a.y-p);return!0},_render:function(l){this.commonRender(l)&&this._renderPaintInOrder(l)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(l){return function(a,h,u){if(!a)return h(null);u||(u={});var p=i.parsePointsAttribute(a.getAttribute("points")),_=i.parseAttributes(a,i[l].ATTRIBUTE_NAMES);_.fromSVG=!0,h(new i[l](p,r(_,u)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(l,a){return i.Object._fromObject("Polyline",l,a,"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return r(this.points,this)},_render:function(o){this.commonRender(o)&&(o.closePath(),this._renderPaintInOrder(o))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(o,t){i.Object._fromObject("Polygon",o,t,"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.array.min,o=i.util.array.max,t=i.util.object.extend,e=i.util.object.clone,s=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(l,a){delete(a=e(a||{})).path,this.callSuper("initialize",a),this._setPath(l||[],a)},_setPath:function(l,a){this.path=i.util.makePathSimpler(Array.isArray(l)?l:i.util.parsePath(l)),i.Polyline.prototype._setPositionDimensions.call(this,a||{})},_renderPathCommands:function(l){var a,h=0,u=0,p=0,_=0,y=0,v=0,w=-this.pathOffset.x,T=-this.pathOffset.y;l.beginPath();for(var P=0,L=this.path.length;P<L;++P)switch((a=this.path[P])[0]){case"L":p=a[1],_=a[2],l.lineTo(p+w,_+T);break;case"M":h=p=a[1],u=_=a[2],l.moveTo(p+w,_+T);break;case"C":p=a[5],_=a[6],y=a[3],v=a[4],l.bezierCurveTo(a[1]+w,a[2]+T,y+w,v+T,p+w,_+T);break;case"Q":l.quadraticCurveTo(a[1]+w,a[2]+T,a[3]+w,a[4]+T),p=a[3],_=a[4],y=a[1],v=a[2];break;case"z":case"Z":p=h,_=u,l.closePath()}},_render:function(l){this._renderPathCommands(l),this._renderPaintInOrder(l)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(l){return t(this.callSuper("toObject",l),{path:this.path.map(function(a){return a.slice()})})},toDatalessObject:function(l){var a=this.toObject(["sourcePath"].concat(l));return a.sourcePath&&delete a.path,a},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var l=i.Object.NUM_FRACTION_DIGITS;return" translate("+s(-this.pathOffset.x,l)+", "+s(-this.pathOffset.y,l)+")"},toClipPathSVG:function(l){var a=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:l,additionalTransform:a})},toSVG:function(l){var a=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:l,additionalTransform:a})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var l,a,h=[],u=[],p=0,_=0,y=0,v=0,w=0,T=this.path.length;w<T;++w){switch((l=this.path[w])[0]){case"L":y=l[1],v=l[2],a=[];break;case"M":p=y=l[1],_=v=l[2],a=[];break;case"C":a=i.util.getBoundsOfCurve(y,v,l[1],l[2],l[3],l[4],l[5],l[6]),y=l[5],v=l[6];break;case"Q":a=i.util.getBoundsOfCurve(y,v,l[1],l[2],l[1],l[2],l[3],l[4]),y=l[3],v=l[4];break;case"z":case"Z":y=p,v=_}a.forEach(function(W){h.push(W.x),u.push(W.y)}),h.push(y),u.push(v)}var P=r(h)||0,L=r(u)||0;return{left:P,top:L,width:(o(h)||0)-P,height:(o(u)||0)-L}}}),i.Path.fromObject=function(l,a){if(typeof l.sourcePath=="string"){var h=l.sourcePath;i.loadSVGFromURL(h,function(u){var p=u[0];p.setOptions(l),a&&a(p)})}else i.Object._fromObject("Path",l,a,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(l,a,h){var u=i.parseAttributes(l,i.Path.ATTRIBUTE_NAMES);u.fromSVG=!0,a(new i.Path(u.d,t(u,h)))})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.array.min,o=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(t,e,s){e=e||{},this._objects=[],s&&this.callSuper("initialize",e),this._objects=t||[];for(var l=this._objects.length;l--;)this._objects[l].group=this;if(s)this._updateObjectsACoords();else{var a=e&&e.centerPoint;e.originX!==void 0&&(this.originX=e.originX),e.originY!==void 0&&(this.originY=e.originY),a||this._calcBounds(),this._updateObjectsCoords(a),delete e.centerPoint,this.callSuper("initialize",e)}this.setCoords()},_updateObjectsACoords:function(){for(var t=this._objects.length;t--;)this._objects[t].setCoords(!0)},_updateObjectsCoords:function(t){t=t||this.getCenterPoint();for(var e=this._objects.length;e--;)this._updateObjectCoords(this._objects[e],t)},_updateObjectCoords:function(t,e){var s=t.left,l=t.top;t.set({left:s-e.x,top:l-e.y}),t.group=this,t.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(t){var e=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),t&&(e&&i.util.removeTransformFromObject(t,this.group.calcTransformMatrix()),this._objects.push(t),t.group=this,t._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,e?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(t){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(t),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(t){this.dirty=!0,t.group=this,t._set("canvas",this.canvas)},_onObjectRemoved:function(t){this.dirty=!0,delete t.group},_set:function(t,e){var s=this._objects.length;if(this.useSetOnGroup)for(;s--;)this._objects[s].setOnGroup(t,e);if(t==="canvas")for(;s--;)this._objects[s]._set(t,e);i.Object.prototype._set.call(this,t,e)},toObject:function(t){var e=this.includeDefaultValues,s=this._objects.filter(function(a){return!a.excludeFromExport}).map(function(a){var h=a.includeDefaultValues;a.includeDefaultValues=e;var u=a.toObject(t);return a.includeDefaultValues=h,u}),l=i.Object.prototype.toObject.call(this,t);return l.objects=s,l},toDatalessObject:function(t){var e,s=this.sourcePath;if(s)e=s;else{var l=this.includeDefaultValues;e=this._objects.map(function(h){var u=h.includeDefaultValues;h.includeDefaultValues=l;var p=h.toDatalessObject(t);return h.includeDefaultValues=u,p})}var a=i.Object.prototype.toDatalessObject.call(this,t);return a.objects=e,a},render:function(t){this._transformDone=!0,this.callSuper("render",t),this._transformDone=!1},shouldCache:function(){var t=i.Object.prototype.shouldCache.call(this);if(t){for(var e=0,s=this._objects.length;e<s;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var t=0,e=this._objects.length;t<e;t++)if(this._objects[t].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(t){for(var e=0,s=this._objects.length;e<s;e++)this._objects[e].render(t);this._drawClipPath(t,this.clipPath)},isCacheDirty:function(t){if(this.callSuper("isCacheDirty",t))return!0;if(!this.statefullCache)return!1;for(var e=0,s=this._objects.length;e<s;e++)if(this._objects[e].isCacheDirty(!0)){if(this._cacheCanvas){var l=this.cacheWidth/this.zoomX,a=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-l/2,-a/2,l,a)}return!0}return!1},_restoreObjectsState:function(){var t=this.calcOwnMatrix();return this._objects.forEach(function(e){i.util.addTransformToObject(e,t),delete e.group,e.setCoords()}),this},destroy:function(){return this._objects.forEach(function(t){t.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(t){t.dispose&&t.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var t=this._objects,e=this.canvas;this._objects=[];var s=this.toObject();delete s.objects;var l=new i.ActiveSelection([]);return l.set(s),l.type="activeSelection",e.remove(this),t.forEach(function(a){a.group=l,a.dirty=!0,e.add(a)}),l.canvas=e,l._objects=t,e._activeObject=l,l.setCoords(),l}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(t){t.setCoords(!0)}),this},_calcBounds:function(t){for(var e,s,l,a,h=[],u=[],p=["tr","br","bl","tl"],_=0,y=this._objects.length,v=p.length;_<y;++_){for(l=(e=this._objects[_]).calcACoords(),a=0;a<v;a++)s=p[a],h.push(l[s].x),u.push(l[s].y);e.aCoords=l}this._getBounds(h,u,t)},_getBounds:function(t,e,s){var l=new i.Point(r(t),r(e)),a=new i.Point(o(t),o(e)),h=l.y||0,u=l.x||0,p=a.x-l.x||0,_=a.y-l.y||0;this.width=p,this.height=_,s||this.setPositionByOrigin({x:u,y:h},"left","top")},_toSVG:function(t){for(var e=["<g ","COMMON_PARTS",` >
`],s=0,l=this._objects.length;s<l;s++)e.push("		",this._objects[s].toSVG(t));return e.push(`</g>
`),e},getSvgStyles:function(){var t=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")},toClipPathSVG:function(t){for(var e=[],s=0,l=this._objects.length;s<l;s++)e.push("	",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}}),i.Group.fromObject=function(t,e){var s=t.objects,l=i.util.object.clone(t,!0);delete l.objects,typeof s!="string"?i.util.enlivenObjects(s,function(a){var h=i.util.object.clone(t,!0);delete h.objects,i.util.enlivenObjectEnlivables(t,h,function(){e&&e(new i.Group(a,h,!0))})}):i.loadSVGFromURL(s,function(a){var h=i.util.groupSVGElements(a,t,s);h.set(l),e&&e(h)})})}(c),function(n){var i=n.fabric||(n.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(r,o){o=o||{},this._objects=r||[];for(var t=this._objects.length;t--;)this._objects[t].group=this;o.originX&&(this.originX=o.originX),o.originY&&(this.originY=o.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,o),this.setCoords()},toGroup:function(){var r=this._objects.concat();this._objects=[];var o=i.Object.prototype.toObject.call(this),t=new i.Group([]);if(delete o.type,t.set(o),r.forEach(function(s){s.canvas.remove(s),s.group=t}),t._objects=r,!this.canvas)return t;var e=this.canvas;return e.add(t),e._activeObject=t,t.setCoords(),t},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(r,o,t){r.save(),r.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",r,o),(t=t||{}).hasControls===void 0&&(t.hasControls=!1),t.forActiveSelection=!0;for(var e=0,s=this._objects.length;e<s;e++)this._objects[e]._renderControls(r,t);r.restore()}}),i.ActiveSelection.fromObject=function(r,o){i.util.enlivenObjects(r.objects,function(t){delete r.objects,o&&o(new i.ActiveSelection(t,r,!0))})})}(c),function(n){var i=d.util.object.extend;n.fabric||(n.fabric={}),n.fabric.Image?d.warn("fabric.Image is already defined."):(d.Image=d.util.createClass(d.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:d.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:d.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(r,o){o||(o={}),this.filters=[],this.cacheKey="texture"+d.Object.__uid++,this.callSuper("initialize",o),this._initElement(r,o)},getElement:function(){return this._element||{}},setElement:function(r,o){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=r,this._originalElement=r,this._initConfig(o),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(r){var o=d.filterBackend;o&&o.evictCachesForKey&&o.evictCachesForKey(r)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(r){d.util.cleanUpJsdomNode(this[r]),this[r]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var r=this.getElement();return{width:r.naturalWidth||r.width,height:r.naturalHeight||r.height}},_stroke:function(r){if(this.stroke&&this.strokeWidth!==0){var o=this.width/2,t=this.height/2;r.beginPath(),r.moveTo(-o,-t),r.lineTo(o,-t),r.lineTo(o,t),r.lineTo(-o,t),r.lineTo(-o,-t),r.closePath()}},toObject:function(r){var o=[];this.filters.forEach(function(e){e&&o.push(e.toObject())});var t=i(this.callSuper("toObject",["cropX","cropY"].concat(r)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:o});return this.resizeFilter&&(t.resizeFilter=this.resizeFilter.toObject()),t},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var r,o=[],t=[],e=this._element,s=-this.width/2,l=-this.height/2,a="",h="";if(!e)return[];if(this.hasCrop()){var u=d.Object.__uid++;o.push('<clipPath id="imageCrop_'+u+`">
`,'	<rect x="'+s+'" y="'+l+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),a=' clip-path="url(#imageCrop_'+u+')" '}if(this.imageSmoothing||(h='" image-rendering="optimizeSpeed'),t.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',s-this.cropX,'" y="',l-this.cropY,'" width="',e.width||e.naturalWidth,'" height="',e.height||e.height,h,'"',a,`></image>
`),this.stroke||this.strokeDashArray){var p=this.fill;this.fill=null,r=["	<rect ",'x="',s,'" y="',l,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=p}return this.paintFirst!=="fill"?o.concat(r,t):o.concat(t,r)},getSrc:function(r){var o=r?this._element:this._originalElement;return o?o.toDataURL?o.toDataURL():this.srcFromAttribute?o.getAttribute("src"):o.src:this.src||""},setSrc:function(r,o,t){return d.util.loadImage(r,function(e,s){this.setElement(e,t),this._setWidthHeight(),o&&o(this,s)},this,t&&t.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var r=this.resizeFilter,o=this.minimumScaleTrigger,t=this.getTotalObjectScaling(),e=t.scaleX,s=t.scaleY,l=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!r||e>o&&s>o)return this._element=l,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=e,void(this._lastScaleY=s);d.filterBackend||(d.filterBackend=d.initFilterBackend());var a=d.util.createCanvasElement(),h=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,u=l.width,p=l.height;a.width=u,a.height=p,this._element=a,this._lastScaleX=r.scaleX=e,this._lastScaleY=r.scaleY=s,d.filterBackend.applyFilters([r],l,u,p,this._element,h),this._filterScalingX=a.width/this._originalElement.width,this._filterScalingY=a.height/this._originalElement.height},applyFilters:function(r){if(r=(r=r||this.filters||[]).filter(function(l){return l&&!l.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),r.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var o=this._originalElement,t=o.naturalWidth||o.width,e=o.naturalHeight||o.height;if(this._element===this._originalElement){var s=d.util.createCanvasElement();s.width=t,s.height=e,this._element=s,this._filteredEl=s}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,t,e),this._lastScaleX=1,this._lastScaleY=1;return d.filterBackend||(d.filterBackend=d.initFilterBackend()),d.filterBackend.applyFilters(r,this._originalElement,t,e,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(r){d.util.setImageSmoothing(r,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(r),this._renderPaintInOrder(r)},drawCacheOnCanvas:function(r){d.util.setImageSmoothing(r,this.imageSmoothing),d.Object.prototype.drawCacheOnCanvas.call(this,r)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(r){var o=this._element;if(o){var t=this._filterScalingX,e=this._filterScalingY,s=this.width,l=this.height,a=Math.min,h=Math.max,u=h(this.cropX,0),p=h(this.cropY,0),_=o.naturalWidth||o.width,y=o.naturalHeight||o.height,v=u*t,w=p*e,T=a(s*t,_-v),P=a(l*e,y-w),L=-s/2,W=-l/2,N=a(s,_/t-u),B=a(l,y/e-p);o&&r.drawImage(o,v,w,T,P,L,W,N,B)}},_needsResize:function(){var r=this.getTotalObjectScaling();return r.scaleX!==this._lastScaleX||r.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(r,o){this.setElement(d.util.getById(r),o),d.util.addClass(this.getElement(),d.Image.CSS_CANVAS)},_initConfig:function(r){r||(r={}),this.setOptions(r),this._setWidthHeight(r)},_initFilters:function(r,o){r&&r.length?d.util.enlivenObjects(r,function(t){o&&o(t)},"fabric.Image.filters"):o&&o()},_setWidthHeight:function(r){r||(r={});var o=this.getElement();this.width=r.width||o.naturalWidth||o.width||0,this.height=r.height||o.naturalHeight||o.height||0},parsePreserveAspectRatioAttribute:function(){var r,o=d.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),t=this._element.width,e=this._element.height,s=1,l=1,a=0,h=0,u=0,p=0,_=this.width,y=this.height,v={width:_,height:y};return!o||o.alignX==="none"&&o.alignY==="none"?(s=_/t,l=y/e):(o.meetOrSlice==="meet"&&(r=(_-t*(s=l=d.util.findScaleToFit(this._element,v)))/2,o.alignX==="Min"&&(a=-r),o.alignX==="Max"&&(a=r),r=(y-e*l)/2,o.alignY==="Min"&&(h=-r),o.alignY==="Max"&&(h=r)),o.meetOrSlice==="slice"&&(r=t-_/(s=l=d.util.findScaleToCover(this._element,v)),o.alignX==="Mid"&&(u=r/2),o.alignX==="Max"&&(u=r),r=e-y/l,o.alignY==="Mid"&&(p=r/2),o.alignY==="Max"&&(p=r),t=_/s,e=y/l)),{width:t,height:e,scaleX:s,scaleY:l,offsetLeft:a,offsetTop:h,cropX:u,cropY:p}}}),d.Image.CSS_CANVAS="canvas-img",d.Image.prototype.getSvgSrc=d.Image.prototype.getSrc,d.Image.fromObject=function(r,o){var t=d.util.object.clone(r);d.util.loadImage(t.src,function(e,s){s?o&&o(null,!0):d.Image.prototype._initFilters.call(t,t.filters,function(l){t.filters=l||[],d.Image.prototype._initFilters.call(t,[t.resizeFilter],function(a){t.resizeFilter=a[0],d.util.enlivenObjectEnlivables(t,t,function(){var h=new d.Image(e,t);o(h,!1)})})})},null,t.crossOrigin)},d.Image.fromURL=function(r,o,t){d.util.loadImage(r,function(e,s){o&&o(new d.Image(e,t),s)},null,t&&t.crossOrigin)},d.Image.ATTRIBUTE_NAMES=d.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),d.Image.fromElement=function(r,o,t){var e=d.parseAttributes(r,d.Image.ATTRIBUTE_NAMES);d.Image.fromURL(e["xlink:href"],o,i(t?d.util.object.clone(t):{},e))})}(c),d.util.object.extend(d.Object.prototype,{_getAngleValueForStraighten:function(){var n=this.angle%360;return n>0?90*Math.round((n-1)/90):90*Math.round(n/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(n){var i=function(){},r=(n=n||{}).onComplete||i,o=n.onChange||i,t=this;return d.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(e){t.rotate(e),o()},onComplete:function(){t.setCoords(),r()}})}}),d.util.object.extend(d.StaticCanvas.prototype,{straightenObject:function(n){return n.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(n){return n.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function n(r,o){var t="precision "+o+` float;
void main(){}`,e=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(e,t),r.compileShader(e),!!r.getShaderParameter(e,r.COMPILE_STATUS)}function i(r){r&&r.tileSize&&(this.tileSize=r.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}d.isWebglSupported=function(r){if(d.isLikelyNode)return!1;r=r||d.WebglFilterBackend.prototype.tileSize;var o=document.createElement("canvas"),t=o.getContext("webgl")||o.getContext("experimental-webgl"),e=!1;if(t){d.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),e=d.maxTextureSize>=r;for(var s=["highp","mediump","lowp"],l=0;l<3;l++)if(n(t,s[l])){d.webGlPrecision=s[l];break}}return this.isSupported=e,e},d.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(r,o){this.dispose(),this.createWebGLCanvas(r,o),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(r,o)},chooseFastestCopyGLTo2DMethod:function(r,o){var t,e=window.performance!==void 0;try{new ImageData(1,1),t=!0}catch{t=!1}var s=typeof ArrayBuffer<"u",l=typeof Uint8ClampedArray<"u";if(e&&t&&s&&l){var a=d.util.createCanvasElement(),h=new ArrayBuffer(r*o*4);if(d.forceGLPutImageData)return this.imageBuffer=h,void(this.copyGLTo2D=It);var u,p,_={imageBuffer:h,destinationWidth:r,destinationHeight:o,targetCanvas:a};a.width=r,a.height=o,u=window.performance.now(),Ct.call(_,this.gl,_),p=window.performance.now()-u,u=window.performance.now(),It.call(_,this.gl,_),p>window.performance.now()-u?(this.imageBuffer=h,this.copyGLTo2D=It):this.copyGLTo2D=Ct}},createWebGLCanvas:function(r,o){var t=d.util.createCanvasElement();t.width=r,t.height=o;var e={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},s=t.getContext("webgl",e);s||(s=t.getContext("experimental-webgl",e)),s&&(s.clearColor(0,0,0,0),this.canvas=t,this.gl=s)},applyFilters:function(r,o,t,e,s,l){var a,h=this.gl;l&&(a=this.getCachedTexture(l,o));var u={originalWidth:o.width||o.originalWidth,originalHeight:o.height||o.originalHeight,sourceWidth:t,sourceHeight:e,destinationWidth:t,destinationHeight:e,context:h,sourceTexture:this.createTexture(h,t,e,!a&&o),targetTexture:this.createTexture(h,t,e),originalTexture:a||this.createTexture(h,t,e,!a&&o),passes:r.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:s},p=h.createFramebuffer();return h.bindFramebuffer(h.FRAMEBUFFER,p),r.forEach(function(_){_&&_.applyTo(u)}),function(_){var y=_.targetCanvas,v=y.width,w=y.height,T=_.destinationWidth,P=_.destinationHeight;v===T&&w===P||(y.width=T,y.height=P)}(u),this.copyGLTo2D(h,u),h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(u.sourceTexture),h.deleteTexture(u.targetTexture),h.deleteFramebuffer(p),s.getContext("2d").setTransform(1,0,0,1,0,0),u},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(r,o,t,e){var s=r.createTexture();return r.bindTexture(r.TEXTURE_2D,s),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),e?r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,t,0,r.RGBA,r.UNSIGNED_BYTE,null),s},getCachedTexture:function(r,o){if(this.textureCache[r])return this.textureCache[r];var t=this.createTexture(this.gl,o.width,o.height,o);return this.textureCache[r]=t,t},evictCachesForKey:function(r){this.textureCache[r]&&(this.gl.deleteTexture(this.textureCache[r]),delete this.textureCache[r])},copyGLTo2D:Ct,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var r=this.gl,o={renderer:"",vendor:""};if(!r)return o;var t=r.getExtension("WEBGL_debug_renderer_info");if(t){var e=r.getParameter(t.UNMASKED_RENDERER_WEBGL),s=r.getParameter(t.UNMASKED_VENDOR_WEBGL);e&&(o.renderer=e.toLowerCase()),s&&(o.vendor=s.toLowerCase())}return this.gpuInfo=o,o}}}(),function(){var n=function(){};function i(){}d.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:n,dispose:n,clearWebGLCaches:n,resources:{},applyFilters:function(r,o,t,e,s){var l=s.getContext("2d");l.drawImage(o,0,0,t,e);var a={sourceWidth:t,sourceHeight:e,imageData:l.getImageData(0,0,t,e),originalEl:o,originalImageData:l.getImageData(0,0,t,e),canvasEl:s,ctx:l,filterBackend:this};return r.forEach(function(h){h.applyTo(a)}),a.imageData.width===t&&a.imageData.height===e||(s.width=a.imageData.width,s.height=a.imageData.height),l.putImageData(a.imageData,0,0),a}}}(),d.Image=d.Image||{},d.Image.filters=d.Image.filters||{},d.Image.filters.BaseFilter=d.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(n){n&&this.setOptions(n)},setOptions:function(n){for(var i in n)this[i]=n[i]},createProgram:function(n,i,r){i=i||this.fragmentSource,r=r||this.vertexSource,d.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+d.webGlPrecision+" float"));var o=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(o,r),n.compileShader(o),!n.getShaderParameter(o,n.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+n.getShaderInfoLog(o));var t=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(t,i),n.compileShader(t),!n.getShaderParameter(t,n.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+n.getShaderInfoLog(t));var e=n.createProgram();if(n.attachShader(e,o),n.attachShader(e,t),n.linkProgram(e),!n.getProgramParameter(e,n.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+n.getProgramInfoLog(e));var s=this.getAttributeLocations(n,e),l=this.getUniformLocations(n,e)||{};return l.uStepW=n.getUniformLocation(e,"uStepW"),l.uStepH=n.getUniformLocation(e,"uStepH"),{program:e,attributeLocations:s,uniformLocations:l}},getAttributeLocations:function(n,i){return{aPosition:n.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(n,i,r){var o=i.aPosition,t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.enableVertexAttribArray(o),n.vertexAttribPointer(o,2,n.FLOAT,!1,0,0),n.bufferData(n.ARRAY_BUFFER,r,n.STATIC_DRAW)},_setupFrameBuffer:function(n){var i,r,o=n.context;n.passes>1?(i=n.destinationWidth,r=n.destinationHeight,n.sourceWidth===i&&n.sourceHeight===r||(o.deleteTexture(n.targetTexture),n.targetTexture=n.filterBackend.createTexture(o,i,r)),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,n.targetTexture,0)):(o.bindFramebuffer(o.FRAMEBUFFER,null),o.finish())},_swapTextures:function(n){n.passes--,n.pass++;var i=n.targetTexture;n.targetTexture=n.sourceTexture,n.sourceTexture=i},isNeutralState:function(){var n=this.mainParameter,i=d.Image.filters[this.type].prototype;if(n){if(Array.isArray(i[n])){for(var r=i[n].length;r--;)if(this[n][r]!==i[n][r])return!1;return!0}return i[n]===this[n]}return!1},applyTo:function(n){n.webgl?(this._setupFrameBuffer(n),this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},retrieveShader:function(n){return n.programCache.hasOwnProperty(this.type)||(n.programCache[this.type]=this.createProgram(n.context)),n.programCache[this.type]},applyToWebGL:function(n){var i=n.context,r=this.retrieveShader(n);n.pass===0&&n.originalTexture?i.bindTexture(i.TEXTURE_2D,n.originalTexture):i.bindTexture(i.TEXTURE_2D,n.sourceTexture),i.useProgram(r.program),this.sendAttributeData(i,r.attributeLocations,n.aPosition),i.uniform1f(r.uniformLocations.uStepW,1/n.sourceWidth),i.uniform1f(r.uniformLocations.uStepH,1/n.sourceHeight),this.sendUniformData(i,r.uniformLocations),i.viewport(0,0,n.destinationWidth,n.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(n,i,r){n.activeTexture(r),n.bindTexture(n.TEXTURE_2D,i),n.activeTexture(n.TEXTURE0)},unbindAdditionalTexture:function(n,i){n.activeTexture(i),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(n){this[this.mainParameter]=n},sendUniformData:function(){},createHelpLayer:function(n){if(!n.helpLayer){var i=document.createElement("canvas");i.width=n.sourceWidth,i.height=n.sourceHeight,n.helpLayer=i}},toObject:function(){var n={type:this.type},i=this.mainParameter;return i&&(n[i]=this[i]),n},toJSON:function(){return this.toObject()}}),d.Image.filters.BaseFilter.fromObject=function(n,i){var r=new d.Image.filters[n.type](n);return i&&i(r),r},function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.ColorMatrix=o(r.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(t){this.callSuper("initialize",t),this.matrix=this.matrix.slice(0)},applyTo2d:function(t){var e,s,l,a,h,u=t.imageData.data,p=u.length,_=this.matrix,y=this.colorsOnly;for(h=0;h<p;h+=4)e=u[h],s=u[h+1],l=u[h+2],y?(u[h]=e*_[0]+s*_[1]+l*_[2]+255*_[4],u[h+1]=e*_[5]+s*_[6]+l*_[7]+255*_[9],u[h+2]=e*_[10]+s*_[11]+l*_[12]+255*_[14]):(a=u[h+3],u[h]=e*_[0]+s*_[1]+l*_[2]+a*_[3]+255*_[4],u[h+1]=e*_[5]+s*_[6]+l*_[7]+a*_[8]+255*_[9],u[h+2]=e*_[10]+s*_[11]+l*_[12]+a*_[13]+255*_[14],u[h+3]=e*_[15]+s*_[16]+l*_[17]+a*_[18]+255*_[19])},getUniformLocations:function(t,e){return{uColorMatrix:t.getUniformLocation(e,"uColorMatrix"),uConstants:t.getUniformLocation(e,"uConstants")}},sendUniformData:function(t,e){var s=this.matrix,l=[s[0],s[1],s[2],s[3],s[5],s[6],s[7],s[8],s[10],s[11],s[12],s[13],s[15],s[16],s[17],s[18]],a=[s[4],s[9],s[14],s[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,l),t.uniform4fv(e.uConstants,a)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Brightness=o(r.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(t){if(this.brightness!==0){var e,s=t.imageData.data,l=s.length,a=Math.round(255*this.brightness);for(e=0;e<l;e+=4)s[e]=s[e]+a,s[e+1]=s[e+1]+a,s[e+2]=s[e+2]+a}},getUniformLocations:function(t,e){return{uBrightness:t.getUniformLocation(e,"uBrightness")}},sendUniformData:function(t,e){t.uniform1f(e.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.Convolute=t(o.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(e){var s=Math.sqrt(this.matrix.length),l=this.type+"_"+s+"_"+(this.opaque?1:0),a=this.fragmentSource[l];return e.programCache.hasOwnProperty(l)||(e.programCache[l]=this.createProgram(e.context,a)),e.programCache[l]},applyTo2d:function(e){var s,l,a,h,u,p,_,y,v,w,T,P,L,W=e.imageData,N=W.data,B=this.matrix,D=Math.round(Math.sqrt(B.length)),A=Math.floor(D/2),k=W.width,G=W.height,H=e.ctx.createImageData(k,G),M=H.data,I=this.opaque?1:0;for(T=0;T<G;T++)for(w=0;w<k;w++){for(u=4*(T*k+w),s=0,l=0,a=0,h=0,L=0;L<D;L++)for(P=0;P<D;P++)p=w+P-A,(_=T+L-A)<0||_>=G||p<0||p>=k||(y=4*(_*k+p),v=B[L*D+P],s+=N[y]*v,l+=N[y+1]*v,a+=N[y+2]*v,I||(h+=N[y+3]*v));M[u]=s,M[u+1]=l,M[u+2]=a,M[u+3]=I?N[u+3]:h}e.imageData=H},getUniformLocations:function(e,s){return{uMatrix:e.getUniformLocation(s,"uMatrix"),uOpaque:e.getUniformLocation(s,"uOpaque"),uHalfSize:e.getUniformLocation(s,"uHalfSize"),uSize:e.getUniformLocation(s,"uSize")}},sendUniformData:function(e,s){e.uniform1fv(s.uMatrix,this.matrix)},toObject:function(){return r(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Grayscale=o(r.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(t){var e,s,l=t.imageData.data,a=l.length,h=this.mode;for(e=0;e<a;e+=4)h==="average"?s=(l[e]+l[e+1]+l[e+2])/3:h==="lightness"?s=(Math.min(l[e],l[e+1],l[e+2])+Math.max(l[e],l[e+1],l[e+2]))/2:h==="luminosity"&&(s=.21*l[e]+.72*l[e+1]+.07*l[e+2]),l[e]=s,l[e+1]=s,l[e+2]=s},retrieveShader:function(t){var e=this.type+"_"+this.mode;if(!t.programCache.hasOwnProperty(e)){var s=this.fragmentSource[this.mode];t.programCache[e]=this.createProgram(t.context,s)}return t.programCache[e]},getUniformLocations:function(t,e){return{uMode:t.getUniformLocation(e,"uMode")}},sendUniformData:function(t,e){t.uniform1i(e.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Invert=o(r.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(t){var e,s=t.imageData.data,l=s.length;for(e=0;e<l;e+=4)s[e]=255-s[e],s[e+1]=255-s[e+1],s[e+2]=255-s[e+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(t,e){return{uInvert:t.getUniformLocation(e,"uInvert")}},sendUniformData:function(t,e){t.uniform1i(e.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.Noise=t(o.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(e){if(this.noise!==0){var s,l,a=e.imageData.data,h=a.length,u=this.noise;for(s=0,h=a.length;s<h;s+=4)l=(.5-Math.random())*u,a[s]+=l,a[s+1]+=l,a[s+2]+=l}},getUniformLocations:function(e,s){return{uNoise:e.getUniformLocation(s,"uNoise"),uSeed:e.getUniformLocation(s,"uSeed")}},sendUniformData:function(e,s){e.uniform1f(s.uNoise,this.noise/255),e.uniform1f(s.uSeed,Math.random())},toObject:function(){return r(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Pixelate=o(r.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(t){var e,s,l,a,h,u,p,_,y,v,w,T=t.imageData,P=T.data,L=T.height,W=T.width;for(s=0;s<L;s+=this.blocksize)for(l=0;l<W;l+=this.blocksize)for(a=P[e=4*s*W+4*l],h=P[e+1],u=P[e+2],p=P[e+3],v=Math.min(s+this.blocksize,L),w=Math.min(l+this.blocksize,W),_=s;_<v;_++)for(y=l;y<w;y++)P[e=4*_*W+4*y]=a,P[e+1]=h,P[e+2]=u,P[e+3]=p},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(t,e){return{uBlocksize:t.getUniformLocation(e,"uBlocksize"),uStepW:t.getUniformLocation(e,"uStepW"),uStepH:t.getUniformLocation(e,"uStepH")}},sendUniformData:function(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.RemoveColor=t(o.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(e){var s,l,a,h,u=e.imageData.data,p=255*this.distance,_=new i.Color(this.color).getSource(),y=[_[0]-p,_[1]-p,_[2]-p],v=[_[0]+p,_[1]+p,_[2]+p];for(s=0;s<u.length;s+=4)l=u[s],a=u[s+1],h=u[s+2],l>y[0]&&a>y[1]&&h>y[2]&&l<v[0]&&a<v[1]&&h<v[2]&&(u[s+3]=0)},getUniformLocations:function(e,s){return{uLow:e.getUniformLocation(s,"uLow"),uHigh:e.getUniformLocation(s,"uHigh")}},sendUniformData:function(e,s){var l=new i.Color(this.color).getSource(),a=parseFloat(this.distance),h=[0+l[0]/255-a,0+l[1]/255-a,0+l[2]/255-a,1],u=[l[0]/255+a,l[1]/255+a,l[2]/255+a,1];e.uniform4fv(s.uLow,h),e.uniform4fv(s.uHigh,u)},toObject:function(){return r(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass,t={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var e in t)r[e]=o(r.ColorMatrix,{type:e,matrix:t[e],mainParameter:!1,colorsOnly:!0}),i.Image.filters[e].fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendColor=o(r.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(t){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[t]+`}
}`},retrieveShader:function(t){var e,s=this.type+"_"+this.mode;return t.programCache.hasOwnProperty(s)||(e=this.buildSource(this.mode),t.programCache[s]=this.createProgram(t.context,e)),t.programCache[s]},applyTo2d:function(t){var e,s,l,a,h,u,p,_=t.imageData.data,y=_.length,v=1-this.alpha;e=(p=new i.Color(this.color).getSource())[0]*this.alpha,s=p[1]*this.alpha,l=p[2]*this.alpha;for(var w=0;w<y;w+=4)switch(a=_[w],h=_[w+1],u=_[w+2],this.mode){case"multiply":_[w]=a*e/255,_[w+1]=h*s/255,_[w+2]=u*l/255;break;case"screen":_[w]=255-(255-a)*(255-e)/255,_[w+1]=255-(255-h)*(255-s)/255,_[w+2]=255-(255-u)*(255-l)/255;break;case"add":_[w]=a+e,_[w+1]=h+s,_[w+2]=u+l;break;case"diff":case"difference":_[w]=Math.abs(a-e),_[w+1]=Math.abs(h-s),_[w+2]=Math.abs(u-l);break;case"subtract":_[w]=a-e,_[w+1]=h-s,_[w+2]=u-l;break;case"darken":_[w]=Math.min(a,e),_[w+1]=Math.min(h,s),_[w+2]=Math.min(u,l);break;case"lighten":_[w]=Math.max(a,e),_[w+1]=Math.max(h,s),_[w+2]=Math.max(u,l);break;case"overlay":_[w]=e<128?2*a*e/255:255-2*(255-a)*(255-e)/255,_[w+1]=s<128?2*h*s/255:255-2*(255-h)*(255-s)/255,_[w+2]=l<128?2*u*l/255:255-2*(255-u)*(255-l)/255;break;case"exclusion":_[w]=e+a-2*e*a/255,_[w+1]=s+h-2*s*h/255,_[w+2]=l+u-2*l*u/255;break;case"tint":_[w]=e+a*v,_[w+1]=s+h*v,_[w+2]=l+u*v}},getUniformLocations:function(t,e){return{uColor:t.getUniformLocation(e,"uColor")}},sendUniformData:function(t,e){var s=new i.Color(this.color).getSource();s[0]=this.alpha*s[0]/255,s[1]=this.alpha*s[1]/255,s[2]=this.alpha*s[2]/255,s[3]=this.alpha,t.uniform4fv(e.uColor,s)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendImage=o(r.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(t){var e=this.type+"_"+this.mode,s=this.fragmentSource[this.mode];return t.programCache.hasOwnProperty(e)||(t.programCache[e]=this.createProgram(t.context,s)),t.programCache[e]},applyToWebGL:function(t){var e=t.context,s=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,s,e.TEXTURE1),this.callSuper("applyToWebGL",t),this.unbindAdditionalTexture(e,e.TEXTURE1)},createTexture:function(t,e){return t.getCachedTexture(e.cacheKey,e._element)},calculateMatrix:function(){var t=this.image,e=t._element.width,s=t._element.height;return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/s,1]},applyTo2d:function(t){var e,s,l,a,h,u,p,_,y,v,w,T=t.imageData,P=t.filterBackend.resources,L=T.data,W=L.length,N=T.width,B=T.height,D=this.image;P.blendImage||(P.blendImage=i.util.createCanvasElement()),v=(y=P.blendImage).getContext("2d"),y.width!==N||y.height!==B?(y.width=N,y.height=B):v.clearRect(0,0,N,B),v.setTransform(D.scaleX,0,0,D.scaleY,D.left,D.top),v.drawImage(D._element,0,0,N,B),w=v.getImageData(0,0,N,B).data;for(var A=0;A<W;A+=4)switch(h=L[A],u=L[A+1],p=L[A+2],_=L[A+3],e=w[A],s=w[A+1],l=w[A+2],a=w[A+3],this.mode){case"multiply":L[A]=h*e/255,L[A+1]=u*s/255,L[A+2]=p*l/255,L[A+3]=_*a/255;break;case"mask":L[A+3]=a}},getUniformLocations:function(t,e){return{uTransformMatrix:t.getUniformLocation(e,"uTransformMatrix"),uImage:t.getUniformLocation(e,"uImage")}},sendUniformData:function(t,e){var s=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,s)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(t,e){i.Image.fromObject(t.image,function(s){var l=i.util.object.clone(t);l.image=s,e(new i.Image.filters.BlendImage(l))})}}(c),function(n){var i=n.fabric||(n.fabric={}),r=Math.pow,o=Math.floor,t=Math.sqrt,e=Math.abs,s=Math.round,l=Math.sin,a=Math.ceil,h=i.Image.filters,u=i.util.createClass;h.Resize=u(h.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(p,_){return{uDelta:p.getUniformLocation(_,"uDelta"),uTaps:p.getUniformLocation(_,"uTaps")}},sendUniformData:function(p,_){p.uniform2fv(_.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),p.uniform1fv(_.uTaps,this.taps)},retrieveShader:function(p){var _=this.getFilterWindow(),y=this.type+"_"+_;if(!p.programCache.hasOwnProperty(y)){var v=this.generateShader(_);p.programCache[y]=this.createProgram(p.context,v)}return p.programCache[y]},getFilterWindow:function(){var p=this.tempScale;return Math.ceil(this.lanczosLobes/p)},getTaps:function(){for(var p=this.lanczosCreate(this.lanczosLobes),_=this.tempScale,y=this.getFilterWindow(),v=new Array(y),w=1;w<=y;w++)v[w-1]=p(w*_);return v},generateShader:function(p){for(var _=new Array(p),y=this.fragmentSourceTOP,v=1;v<=p;v++)_[v-1]=v+".0 * uDelta";return y+="uniform float uTaps["+p+`];
`,y+=`void main() {
`,y+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,y+=`  float sum = 1.0;
`,_.forEach(function(w,T){y+="  color += texture2D(uTexture, vTexCoord + "+w+") * uTaps["+T+`];
`,y+="  color += texture2D(uTexture, vTexCoord - "+w+") * uTaps["+T+`];
`,y+="  sum += 2.0 * uTaps["+T+`];
`}),y+=`  gl_FragColor = color / sum;
`,y+="}"},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(p){p.webgl?(p.passes++,this.width=p.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=p.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),p.destinationWidth=this.dW,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceWidth=p.destinationWidth,this.height=p.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),p.destinationHeight=this.dH,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceHeight=p.destinationHeight):this.applyTo2d(p)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(p){return function(_){if(_>=p||_<=-p)return 0;if(_<11920929e-14&&_>-11920929e-14)return 1;var y=(_*=Math.PI)/p;return l(_)/_*l(y)/y}},applyTo2d:function(p){var _=p.imageData,y=this.scaleX,v=this.scaleY;this.rcpScaleX=1/y,this.rcpScaleY=1/v;var w,T=_.width,P=_.height,L=s(T*y),W=s(P*v);this.resizeType==="sliceHack"?w=this.sliceByTwo(p,T,P,L,W):this.resizeType==="hermite"?w=this.hermiteFastResize(p,T,P,L,W):this.resizeType==="bilinear"?w=this.bilinearFiltering(p,T,P,L,W):this.resizeType==="lanczos"&&(w=this.lanczosResize(p,T,P,L,W)),p.imageData=w},sliceByTwo:function(p,_,y,v,w){var T,P,L=p.imageData,W=.5,N=!1,B=!1,D=_*W,A=y*W,k=i.filterBackend.resources,G=0,H=0,M=_,I=0;for(k.sliceByTwo||(k.sliceByTwo=document.createElement("canvas")),((T=k.sliceByTwo).width<1.5*_||T.height<y)&&(T.width=1.5*_,T.height=y),(P=T.getContext("2d")).clearRect(0,0,1.5*_,y),P.putImageData(L,0,0),v=o(v),w=o(w);!N||!B;)_=D,y=A,v<o(D*W)?D=o(D*W):(D=v,N=!0),w<o(A*W)?A=o(A*W):(A=w,B=!0),P.drawImage(T,G,H,_,y,M,I,D,A),G=M,H=I,I+=A;return P.getImageData(G,H,v,w)},lanczosResize:function(p,_,y,v,w){var T=p.imageData.data,P=p.ctx.createImageData(v,w),L=P.data,W=this.lanczosCreate(this.lanczosLobes),N=this.rcpScaleX,B=this.rcpScaleY,D=2/this.rcpScaleX,A=2/this.rcpScaleY,k=a(N*this.lanczosLobes/2),G=a(B*this.lanczosLobes/2),H={},M={},I={};return function F(X){var U,Y,it,Q,q,et,$,rt,ot,nt,ut;for(M.x=(X+.5)*N,I.x=o(M.x),U=0;U<w;U++){for(M.y=(U+.5)*B,I.y=o(M.y),q=0,et=0,$=0,rt=0,ot=0,Y=I.x-k;Y<=I.x+k;Y++)if(!(Y<0||Y>=_)){nt=o(1e3*e(Y-M.x)),H[nt]||(H[nt]={});for(var ft=I.y-G;ft<=I.y+G;ft++)ft<0||ft>=y||(ut=o(1e3*e(ft-M.y)),H[nt][ut]||(H[nt][ut]=W(t(r(nt*D,2)+r(ut*A,2))/1e3)),(it=H[nt][ut])>0&&(q+=it,et+=it*T[Q=4*(ft*_+Y)],$+=it*T[Q+1],rt+=it*T[Q+2],ot+=it*T[Q+3]))}L[Q=4*(U*v+X)]=et/q,L[Q+1]=$/q,L[Q+2]=rt/q,L[Q+3]=ot/q}return++X<v?F(X):P}(0)},bilinearFiltering:function(p,_,y,v,w){var T,P,L,W,N,B,D,A,k,G=0,H=this.rcpScaleX,M=this.rcpScaleY,I=4*(_-1),F=p.imageData.data,X=p.ctx.createImageData(v,w),U=X.data;for(L=0;L<w;L++)for(W=0;W<v;W++)for(N=H*W-(T=o(H*W)),B=M*L-(P=o(M*L)),k=4*(P*_+T),D=0;D<4;D++)A=F[k+D]*(1-N)*(1-B)+F[k+4+D]*N*(1-B)+F[k+I+D]*B*(1-N)+F[k+I+4+D]*N*B,U[G++]=A;return X},hermiteFastResize:function(p,_,y,v,w){for(var T=this.rcpScaleX,P=this.rcpScaleY,L=a(T/2),W=a(P/2),N=p.imageData.data,B=p.ctx.createImageData(v,w),D=B.data,A=0;A<w;A++)for(var k=0;k<v;k++){for(var G=4*(k+A*v),H=0,M=0,I=0,F=0,X=0,U=0,Y=0,it=(A+.5)*P,Q=o(A*P);Q<(A+1)*P;Q++)for(var q=e(it-(Q+.5))/W,et=(k+.5)*T,$=q*q,rt=o(k*T);rt<(k+1)*T;rt++){var ot=e(et-(rt+.5))/L,nt=t($+ot*ot);nt>1&&nt<-1||(H=2*nt*nt*nt-3*nt*nt+1)>0&&(Y+=H*N[3+(ot=4*(rt+Q*_))],I+=H,N[ot+3]<255&&(H=H*N[ot+3]/250),F+=H*N[ot],X+=H*N[ot+1],U+=H*N[ot+2],M+=H)}D[G]=F/M,D[G+1]=X/M,D[G+2]=U/M,D[G+3]=Y/I}return B},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Contrast=o(r.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(t){if(this.contrast!==0){var e,s=t.imageData.data,l=s.length,a=Math.floor(255*this.contrast),h=259*(a+255)/(255*(259-a));for(e=0;e<l;e+=4)s[e]=h*(s[e]-128)+128,s[e+1]=h*(s[e+1]-128)+128,s[e+2]=h*(s[e+2]-128)+128}},getUniformLocations:function(t,e){return{uContrast:t.getUniformLocation(e,"uContrast")}},sendUniformData:function(t,e){t.uniform1f(e.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Saturation=o(r.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(t){if(this.saturation!==0){var e,s,l=t.imageData.data,a=l.length,h=-this.saturation;for(e=0;e<a;e+=4)s=Math.max(l[e],l[e+1],l[e+2]),l[e]+=s!==l[e]?(s-l[e])*h:0,l[e+1]+=s!==l[e+1]?(s-l[e+1])*h:0,l[e+2]+=s!==l[e+2]?(s-l[e+2])*h:0}},getUniformLocations:function(t,e){return{uSaturation:t.getUniformLocation(e,"uSaturation")}},sendUniformData:function(t,e){t.uniform1f(e.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Vibrance=o(r.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(t){if(this.vibrance!==0){var e,s,l,a,h=t.imageData.data,u=h.length,p=-this.vibrance;for(e=0;e<u;e+=4)s=Math.max(h[e],h[e+1],h[e+2]),l=(h[e]+h[e+1]+h[e+2])/3,a=2*Math.abs(s-l)/255*p,h[e]+=s!==h[e]?(s-h[e])*a:0,h[e+1]+=s!==h[e+1]?(s-h[e+1])*a:0,h[e+2]+=s!==h[e+2]?(s-h[e+2])*a:0}},getUniformLocations:function(t,e){return{uVibrance:t.getUniformLocation(e,"uVibrance")}},sendUniformData:function(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Blur=o(r.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(t){t.webgl?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)},applyTo2d:function(t){t.imageData=this.simpleBlur(t)},simpleBlur:function(t){var e,s,l=t.filterBackend.resources,a=t.imageData.width,h=t.imageData.height;l.blurLayer1||(l.blurLayer1=i.util.createCanvasElement(),l.blurLayer2=i.util.createCanvasElement()),e=l.blurLayer1,s=l.blurLayer2,e.width===a&&e.height===h||(s.width=e.width=a,s.height=e.height=h);var u,p,_,y,v=e.getContext("2d"),w=s.getContext("2d"),T=.06*this.blur*.5;for(v.putImageData(t.imageData,0,0),w.clearRect(0,0,a,h),y=-15;y<=15;y++)_=T*(p=y/15)*a+(u=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(e,_,u),v.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);for(y=-15;y<=15;y++)_=T*(p=y/15)*h+(u=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(e,u,_),v.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);t.ctx.drawImage(e,0,0);var P=t.ctx.getImageData(0,0,e.width,e.height);return v.globalAlpha=1,v.clearRect(0,0,e.width,e.height),P},getUniformLocations:function(t,e){return{delta:t.getUniformLocation(e,"uDelta")}},sendUniformData:function(t,e){var s=this.chooseRightDelta();t.uniform2fv(e.delta,s)},chooseRightDelta:function(){var t,e=1,s=[0,0];return this.horizontal?this.aspectRatio>1&&(e=1/this.aspectRatio):this.aspectRatio<1&&(e=this.aspectRatio),t=e*this.blur*.12,this.horizontal?s[0]=t:s[1]=t,s}}),r.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Gamma=o(r.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(t){this.gamma=[1,1,1],r.BaseFilter.prototype.initialize.call(this,t)},applyTo2d:function(t){var e,s=t.imageData.data,l=this.gamma,a=s.length,h=1/l[0],u=1/l[1],p=1/l[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),e=0,a=256;e<a;e++)this.rVals[e]=255*Math.pow(e/255,h),this.gVals[e]=255*Math.pow(e/255,u),this.bVals[e]=255*Math.pow(e/255,p);for(e=0,a=s.length;e<a;e+=4)s[e]=this.rVals[s[e]],s[e+1]=this.gVals[s[e+1]],s[e+2]=this.bVals[s[e+2]]},getUniformLocations:function(t,e){return{uGamma:t.getUniformLocation(e,"uGamma")}},sendUniformData:function(t,e){t.uniform3fv(e.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Composed=o(r.BaseFilter,{type:"Composed",subFilters:[],initialize:function(t){this.callSuper("initialize",t),this.subFilters=this.subFilters.slice(0)},applyTo:function(t){t.passes+=this.subFilters.length-1,this.subFilters.forEach(function(e){e.applyTo(t)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(t){return t.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(t){return!t.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(t,e){var s=(t.subFilters||[]).map(function(a){return new i.Image.filters[a.type](a)}),l=new i.Image.filters.Composed({subFilters:s});return e&&e(l),l}}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.HueRotation=o(r.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var t=this.rotation*Math.PI,e=i.util.cos(t),s=i.util.sin(t),l=1/3,a=Math.sqrt(l)*s,h=1-e;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=e+h/3,this.matrix[1]=l*h-a,this.matrix[2]=l*h+a,this.matrix[5]=l*h+a,this.matrix[6]=e+l*h,this.matrix[7]=l*h-a,this.matrix[10]=l*h-a,this.matrix[11]=l*h+a,this.matrix[12]=e+l*h},isNeutralState:function(t){return this.calculateMatrix(),r.BaseFilter.prototype.isNeutralState.call(this,t)},applyTo:function(t){this.calculateMatrix(),r.BaseFilter.prototype.applyTo.call(this,t)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var o="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(o),cacheProperties:i.Object.prototype.cacheProperties.concat(o),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(t,e){this.styles=e&&e.styles||{},this.text=t,this.__skipDimension=!0,this.callSuper("initialize",e),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var t=this.path;t&&(t.segmentsInfo=i.util.getPathSegmentsInfo(t.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var t,e,s,l,a,h,u,p=0,_=this._textLines.length;p<_;p++)if((this.textAlign==="justify"||p!==_-1&&!this.isEndOfWrapping(p))&&(l=0,a=this._textLines[p],(e=this.getLineWidth(p))<this.width&&(u=this.textLines[p].match(this._reSpacesAndTabs)))){s=u.length,t=(this.width-e)/s;for(var y=0,v=a.length;y<=v;y++)h=this.__charBounds[p][y],this._reSpaceAndTab.test(a[y])?(h.width+=t,h.kernedWidth+=t,h.left+=l,l+=t):h.left+=l}},isEndOfWrapping:function(t){return t===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var t=this.callSuper("_getCacheCanvasDimensions"),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t},_render:function(t){var e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")},_renderText:function(t){this.paintFirst==="stroke"?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))},_setTextStyles:function(t,e,s){if(t.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":t.textBaseline="middle";break;case"ascender":t.textBaseline="top";break;case"descender":t.textBaseline="bottom"}t.font=this._getFontDeclaration(e,s)},calcTextWidth:function(){for(var t=this.getLineWidth(0),e=1,s=this._textLines.length;e<s;e++){var l=this.getLineWidth(e);l>t&&(t=l)}return t},_renderTextLine:function(t,e,s,l,a,h){this._renderChars(t,e,s,l,a,h)},_renderTextLinesBackground:function(t){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var e,s,l,a,h,u,p,_=t.fillStyle,y=this._getLeftOffset(),v=this._getTopOffset(),w=0,T=0,P=this.path,L=0,W=this._textLines.length;L<W;L++)if(e=this.getHeightOfLine(L),this.textBackgroundColor||this.styleHas("textBackgroundColor",L)){l=this._textLines[L],s=this._getLineLeftOffset(L),T=0,w=0,a=this.getValueOfPropertyAt(L,0,"textBackgroundColor");for(var N=0,B=l.length;N<B;N++)h=this.__charBounds[L][N],u=this.getValueOfPropertyAt(L,N,"textBackgroundColor"),P?(t.save(),t.translate(h.renderLeft,h.renderTop),t.rotate(h.angle),t.fillStyle=u,u&&t.fillRect(-h.width/2,-e/this.lineHeight*(1-this._fontSizeFraction),h.width,e/this.lineHeight),t.restore()):u!==a?(p=y+s+w,this.direction==="rtl"&&(p=this.width-p-T),t.fillStyle=a,a&&t.fillRect(p,v,T,e/this.lineHeight),w=h.left,T=h.width,a=u):T+=h.kernedWidth;u&&!P&&(p=y+s+w,this.direction==="rtl"&&(p=this.width-p-T),t.fillStyle=u,t.fillRect(p,v,T,e/this.lineHeight)),v+=e}else v+=e;t.fillStyle=_,this._removeShadow(t)}},getFontCache:function(t){var e=t.fontFamily.toLowerCase();i.charWidthsCache[e]||(i.charWidthsCache[e]={});var s=i.charWidthsCache[e],l=t.fontStyle.toLowerCase()+"_"+(t.fontWeight+"").toLowerCase();return s[l]||(s[l]={}),s[l]},_measureChar:function(t,e,s,l){var a,h,u,p,_=this.getFontCache(e),y=s+t,v=this._getFontDeclaration(e)===this._getFontDeclaration(l),w=e.fontSize/this.CACHE_FONT_SIZE;if(s&&_[s]!==void 0&&(u=_[s]),_[t]!==void 0&&(p=a=_[t]),v&&_[y]!==void 0&&(p=(h=_[y])-u),a===void 0||u===void 0||h===void 0){var T=this.getMeasuringContext();this._setTextStyles(T,e,!0)}return a===void 0&&(p=a=T.measureText(t).width,_[t]=a),u===void 0&&v&&s&&(u=T.measureText(s).width,_[s]=u),v&&h===void 0&&(h=T.measureText(y).width,_[y]=h,p=h-u),{width:a*w,kernedWidth:p*w}},getHeightOfChar:function(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")},measureLine:function(t){var e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e},_measureLine:function(t){var e,s,l,a,h,u,p=0,_=this._textLines[t],y=new Array(_.length),v=0,w=this.path,T=this.pathSide==="right";for(this.__charBounds[t]=y,e=0;e<_.length;e++)s=_[e],a=this._getGraphemeBox(s,t,e,l),y[e]=a,p+=a.kernedWidth,l=s;if(y[e]={left:a?a.left+a.width:0,width:0,kernedWidth:0,height:this.fontSize},w){switch(u=w.segmentsInfo[w.segmentsInfo.length-1].length,(h=i.util.getPointOnPath(w.path,0,w.segmentsInfo)).x+=w.pathOffset.x,h.y+=w.pathOffset.y,this.textAlign){case"left":v=T?u-p:0;break;case"center":v=(u-p)/2;break;case"right":v=T?0:u-p}for(v+=this.pathStartOffset*(T?-1:1),e=T?_.length-1:0;T?e>=0:e<_.length;T?e--:e++)a=y[e],v>u?v%=u:v<0&&(v+=u),this._setGraphemeOnPath(v,a,h),v+=a.kernedWidth}return{width:p,numOfSpaces:0}},_setGraphemeOnPath:function(t,e,s){var l=t+e.kernedWidth/2,a=this.path,h=i.util.getPointOnPath(a.path,l,a.segmentsInfo);e.renderLeft=h.x-s.x,e.renderTop=h.y-s.y,e.angle=h.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(t,e,s,l,a){var h,u=this.getCompleteStyleDeclaration(e,s),p=l?this.getCompleteStyleDeclaration(e,s-1):{},_=this._measureChar(t,u,l,p),y=_.kernedWidth,v=_.width;this.charSpacing!==0&&(v+=h=this._getWidthOfCharSpacing(),y+=h);var w={width:v,left:0,height:u.fontSize,kernedWidth:y,deltaY:u.deltaY};if(s>0&&!a){var T=this.__charBounds[e][s-1];w.left=T.left+T.width+_.kernedWidth-_.width}return w},getHeightOfLine:function(t){if(this.__lineHeights[t])return this.__lineHeights[t];for(var e=this._textLines[t],s=this.getHeightOfChar(t,0),l=1,a=e.length;l<a;l++)s=Math.max(this.getHeightOfChar(t,l),s);return this.__lineHeights[t]=s*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var t,e=0,s=0,l=this._textLines.length;s<l;s++)t=this.getHeightOfLine(s),e+=s===l-1?t/this.lineHeight:t;return e},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(t,e){t.save();for(var s=0,l=this._getLeftOffset(),a=this._getTopOffset(),h=0,u=this._textLines.length;h<u;h++){var p=this.getHeightOfLine(h),_=p/this.lineHeight,y=this._getLineLeftOffset(h);this._renderTextLine(e,t,this._textLines[h],l+y,a+s+_,h),s+=p}t.restore()},_renderTextFill:function(t){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(t,"fillText")},_renderTextStroke:function(t){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())},_renderChars:function(t,e,s,l,a,h){var u,p,_,y,v,w=this.getHeightOfLine(h),T=this.textAlign.indexOf("justify")!==-1,P="",L=0,W=this.path,N=!T&&this.charSpacing===0&&this.isEmptyStyles(h)&&!W,B=this.direction==="ltr",D=this.direction==="ltr"?1:-1,A=e.canvas.getAttribute("dir");if(e.save(),A!==this.direction&&(e.canvas.setAttribute("dir",B?"ltr":"rtl"),e.direction=B?"ltr":"rtl",e.textAlign=B?"left":"right"),a-=w*this._fontSizeFraction/this.lineHeight,N)return this._renderChar(t,e,h,0,s.join(""),l,a,w),void e.restore();for(var k=0,G=s.length-1;k<=G;k++)y=k===G||this.charSpacing||W,P+=s[k],_=this.__charBounds[h][k],L===0?(l+=D*(_.kernedWidth-_.width),L+=_.width):L+=_.kernedWidth,T&&!y&&this._reSpaceAndTab.test(s[k])&&(y=!0),y||(u=u||this.getCompleteStyleDeclaration(h,k),p=this.getCompleteStyleDeclaration(h,k+1),y=this._hasStyleChanged(u,p)),y&&(W?(e.save(),e.translate(_.renderLeft,_.renderTop),e.rotate(_.angle),this._renderChar(t,e,h,k,P,-L/2,0,w),e.restore()):(v=l,this._renderChar(t,e,h,k,P,v,a,w)),P="",u=p,l+=D*L,L=0);e.restore()},_applyPatternGradientTransformText:function(t){var e,s=i.util.createCanvasElement(),l=this.width+this.strokeWidth,a=this.height+this.strokeWidth;return s.width=l,s.height=a,(e=s.getContext("2d")).beginPath(),e.moveTo(0,0),e.lineTo(l,0),e.lineTo(l,a),e.lineTo(0,a),e.closePath(),e.translate(l/2,a/2),e.fillStyle=t.toLive(e),this._applyPatternGradientTransform(e,t),e.fill(),e.createPattern(s,"no-repeat")},handleFiller:function(t,e,s){var l,a;return s.toLive?s.gradientUnits==="percentage"||s.gradientTransform||s.patternTransform?(l=-this.width/2,a=-this.height/2,t.translate(l,a),t[e]=this._applyPatternGradientTransformText(s),{offsetX:l,offsetY:a}):(t[e]=s.toLive(t,this),this._applyPatternGradientTransform(t,s)):(t[e]=s,{offsetX:0,offsetY:0})},_setStrokeStyles:function(t,e){return t.lineWidth=e.strokeWidth,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",e.stroke)},_setFillStyles:function(t,e){return this.handleFiller(t,"fillStyle",e.fill)},_renderChar:function(t,e,s,l,a,h,u){var p,_,y=this._getStyleDeclaration(s,l),v=this.getCompleteStyleDeclaration(s,l),w=t==="fillText"&&v.fill,T=t==="strokeText"&&v.stroke&&v.strokeWidth;(T||w)&&(e.save(),w&&(p=this._setFillStyles(e,v)),T&&(_=this._setStrokeStyles(e,v)),e.font=this._getFontDeclaration(v),y&&y.textBackgroundColor&&this._removeShadow(e),y&&y.deltaY&&(u+=y.deltaY),w&&e.fillText(a,h-p.offsetX,u-p.offsetY),T&&e.strokeText(a,h-_.offsetX,u-_.offsetY),e.restore())},setSuperscript:function(t,e){return this._setScript(t,e,this.superscript)},setSubscript:function(t,e){return this._setScript(t,e,this.subscript)},_setScript:function(t,e,s){var l=this.get2DCursorLocation(t,!0),a=this.getValueOfPropertyAt(l.lineIndex,l.charIndex,"fontSize"),h=this.getValueOfPropertyAt(l.lineIndex,l.charIndex,"deltaY"),u={fontSize:a*s.size,deltaY:h+a*s.baseline};return this.setSelectionStyles(u,t,e),this},_hasStyleChanged:function(t,e){return t.fill!==e.fill||t.stroke!==e.stroke||t.strokeWidth!==e.strokeWidth||t.fontSize!==e.fontSize||t.fontFamily!==e.fontFamily||t.fontWeight!==e.fontWeight||t.fontStyle!==e.fontStyle||t.deltaY!==e.deltaY},_hasStyleChangedForSvg:function(t,e){return this._hasStyleChanged(t,e)||t.overline!==e.overline||t.underline!==e.underline||t.linethrough!==e.linethrough},_getLineLeftOffset:function(t){var e=this.getLineWidth(t),s=this.width-e,l=this.textAlign,a=this.direction,h=0,u=this.isEndOfWrapping(t);return l==="justify"||l==="justify-center"&&!u||l==="justify-right"&&!u||l==="justify-left"&&!u?0:(l==="center"&&(h=s/2),l==="right"&&(h=s),l==="justify-center"&&(h=s/2),l==="justify-right"&&(h=s),a==="rtl"&&(h-=s),h)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var t=this._forceClearCache;return t||(t=this.hasStateChanged("_dimensionAffectingProps")),t&&(this.dirty=!0,this._forceClearCache=!1),t},getLineWidth:function(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];var e=this.measureLine(t).width;return this.__lineWidths[t]=e,e},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(t,e,s){var l=this._getStyleDeclaration(t,e);return l&&l[s]!==void 0?l[s]:this[s]},_renderTextDecoration:function(t,e){if(this[e]||this.styleHas(e)){for(var s,l,a,h,u,p,_,y,v,w,T,P,L,W,N,B,D=this._getLeftOffset(),A=this._getTopOffset(),k=this.path,G=this._getWidthOfCharSpacing(),H=this.offsets[e],M=0,I=this._textLines.length;M<I;M++)if(s=this.getHeightOfLine(M),this[e]||this.styleHas(e,M)){_=this._textLines[M],W=s/this.lineHeight,h=this._getLineLeftOffset(M),w=0,T=0,y=this.getValueOfPropertyAt(M,0,e),B=this.getValueOfPropertyAt(M,0,"fill"),v=A+W*(1-this._fontSizeFraction),l=this.getHeightOfChar(M,0),u=this.getValueOfPropertyAt(M,0,"deltaY");for(var F=0,X=_.length;F<X;F++)if(P=this.__charBounds[M][F],L=this.getValueOfPropertyAt(M,F,e),N=this.getValueOfPropertyAt(M,F,"fill"),a=this.getHeightOfChar(M,F),p=this.getValueOfPropertyAt(M,F,"deltaY"),k&&L&&N)t.save(),t.fillStyle=B,t.translate(P.renderLeft,P.renderTop),t.rotate(P.angle),t.fillRect(-P.kernedWidth/2,H*a+p,P.kernedWidth,this.fontSize/15),t.restore();else if((L!==y||N!==B||a!==l||p!==u)&&T>0){var U=D+h+w;this.direction==="rtl"&&(U=this.width-U-T),y&&B&&(t.fillStyle=B,t.fillRect(U,v+H*l+u,T,this.fontSize/15)),w=P.left,T=P.width,y=L,B=N,l=a,u=p}else T+=P.kernedWidth;U=D+h+w,this.direction==="rtl"&&(U=this.width-U-T),t.fillStyle=N,L&&N&&t.fillRect(U,v+H*l+u,T-G,this.fontSize/15),A+=s}else A+=s;this._removeShadow(t)}},_getFontDeclaration:function(t,e){var s=t||this,l=this.fontFamily,a=i.Text.genericFonts.indexOf(l.toLowerCase())>-1,h=l===void 0||l.indexOf("'")>-1||l.indexOf(",")>-1||l.indexOf('"')>-1||a?s.fontFamily:'"'+s.fontFamily+'"';return[i.isLikelyNode?s.fontWeight:s.fontStyle,i.isLikelyNode?s.fontStyle:s.fontWeight,e?this.CACHE_FONT_SIZE+"px":s.fontSize+"px",h].join(" ")},render:function(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",t)))},_splitTextIntoLines:function(t){for(var e=t.split(this._reNewline),s=new Array(e.length),l=[`
`],a=[],h=0;h<e.length;h++)s[h]=i.util.string.graphemeSplit(e[h]),a=a.concat(s[h],l);return a.pop(),{_unwrappedLines:s,lines:e,graphemeText:a,graphemeLines:s}},toObject:function(t){var e=o.concat(t),s=this.callSuper("toObject",e);return s.styles=r(this.styles,!0),s.path&&(s.path=this.path.toObject()),s},set:function(t,e){this.callSuper("set",t,e);var s=!1,l=!1;if(typeof t=="object")for(var a in t)a==="path"&&this.setPathInfo(),s=s||this._dimensionAffectingProps.indexOf(a)!==-1,l=l||a==="path";else s=this._dimensionAffectingProps.indexOf(t)!==-1,l=t==="path";return l&&this.setPathInfo(),s&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(t,e,s){if(!t)return e(null);var l=i.parseAttributes(t,i.Text.ATTRIBUTE_NAMES),a=l.textAnchor||"left";if((s=i.util.object.extend(s?r(s):{},l)).top=s.top||0,s.left=s.left||0,l.textDecoration){var h=l.textDecoration;h.indexOf("underline")!==-1&&(s.underline=!0),h.indexOf("overline")!==-1&&(s.overline=!0),h.indexOf("line-through")!==-1&&(s.linethrough=!0),delete s.textDecoration}"dx"in l&&(s.left+=l.dx),"dy"in l&&(s.top+=l.dy),"fontSize"in s||(s.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var u="";"textContent"in t?u=t.textContent:"firstChild"in t&&t.firstChild!==null&&"data"in t.firstChild&&t.firstChild.data!==null&&(u=t.firstChild.data),u=u.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var p=s.strokeWidth;s.strokeWidth=0;var _=new i.Text(u,s),y=_.getScaledHeight()/_.height,v=((_.height+_.strokeWidth)*_.lineHeight-_.height)*y,w=_.getScaledHeight()+v,T=0;a==="center"&&(T=_.getScaledWidth()/2),a==="right"&&(T=_.getScaledWidth()),_.set({left:_.left-T,top:_.top-(w-_.fontSize*(.07+_._fontSizeFraction))/_.lineHeight,strokeWidth:p!==void 0?p:1}),e(_)},i.Text.fromObject=function(t,e){var s=r(t),l=t.path;return delete s.path,i.Object._fromObject("Text",s,function(a){l?i.Object._fromObject("Path",l,function(h){a.set("path",h),e(a)},"path"):e(a)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(c),d.util.object.extend(d.Text.prototype,{isEmptyStyles:function(n){if(!this.styles||n!==void 0&&!this.styles[n])return!0;var i=n===void 0?this.styles:{line:this.styles[n]};for(var r in i)for(var o in i[r])for(var t in i[r][o])return!1;return!0},styleHas:function(n,i){if(!this.styles||!n||n===""||i!==void 0&&!this.styles[i])return!1;var r=i===void 0?this.styles:{0:this.styles[i]};for(var o in r)for(var t in r[o])if(r[o][t][n]!==void 0)return!0;return!1},cleanStyle:function(n){if(!this.styles||!n||n==="")return!1;var i,r,o=this.styles,t=0,e=!0,s=0;for(var l in o){for(var a in i=0,o[l]){var h;t++,(h=o[l][a]).hasOwnProperty(n)?(r?h[n]!==r&&(e=!1):r=h[n],h[n]===this[n]&&delete h[n]):e=!1,Object.keys(h).length!==0?i++:delete o[l][a]}i===0&&delete o[l]}for(var u=0;u<this._textLines.length;u++)s+=this._textLines[u].length;e&&t===s&&(this[n]=r,this.removeStyle(n))},removeStyle:function(n){if(this.styles&&n&&n!==""){var i,r,o,t=this.styles;for(r in t){for(o in i=t[r])delete i[o][n],Object.keys(i[o]).length===0&&delete i[o];Object.keys(i).length===0&&delete t[r]}}},_extendStyles:function(n,i){var r=this.get2DCursorLocation(n);this._getLineStyle(r.lineIndex)||this._setLineStyle(r.lineIndex),this._getStyleDeclaration(r.lineIndex,r.charIndex)||this._setStyleDeclaration(r.lineIndex,r.charIndex,{}),d.util.object.extend(this._getStyleDeclaration(r.lineIndex,r.charIndex),i)},get2DCursorLocation:function(n,i){n===void 0&&(n=this.selectionStart);for(var r=i?this._unwrappedTextLines:this._textLines,o=r.length,t=0;t<o;t++){if(n<=r[t].length)return{lineIndex:t,charIndex:n};n-=r[t].length+this.missingNewlineOffset(t)}return{lineIndex:t-1,charIndex:r[t-1].length<n?r[t-1].length:n}},getSelectionStyles:function(n,i,r){n===void 0&&(n=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||n);for(var o=[],t=n;t<i;t++)o.push(this.getStyleAtPosition(t,r));return o},getStyleAtPosition:function(n,i){var r=this.get2DCursorLocation(n);return(i?this.getCompleteStyleDeclaration(r.lineIndex,r.charIndex):this._getStyleDeclaration(r.lineIndex,r.charIndex))||{}},setSelectionStyles:function(n,i,r){i===void 0&&(i=this.selectionStart||0),r===void 0&&(r=this.selectionEnd||i);for(var o=i;o<r;o++)this._extendStyles(o,n);return this._forceClearCache=!0,this},_getStyleDeclaration:function(n,i){var r=this.styles&&this.styles[n];return r?r[i]:null},getCompleteStyleDeclaration:function(n,i){for(var r,o=this._getStyleDeclaration(n,i)||{},t={},e=0;e<this._styleProperties.length;e++)t[r=this._styleProperties[e]]=o[r]===void 0?this[r]:o[r];return t},_setStyleDeclaration:function(n,i,r){this.styles[n][i]=r},_deleteStyleDeclaration:function(n,i){delete this.styles[n][i]},_getLineStyle:function(n){return!!this.styles[n]},_setLineStyle:function(n){this.styles[n]={}},_deleteLineStyle:function(n){delete this.styles[n]}}),function(){function n(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}d.IText=d.util.createClass(d.Text,d.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,r){this.callSuper("initialize",i,r),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,r){this[i]!==r&&(this._fireSelectionChanged(),this[i]=r),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var r=this.canvas.contextTop,o=this.canvas.viewportTransform;r.save(),r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this.transform(r),this._clearTextArea(r),i||r.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),r=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,r):this.renderSelection(i,r),r.restore()}},_clearTextArea:function(i){var r=this.width+4,o=this.height+4;i.clearRect(-r/2,-o/2,r,o)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var r=this._getLeftOffset(),o=this._getTopOffset(),t=this._getCursorBoundariesOffsets(i);return{left:r,top:o,leftOffset:t.left,topOffset:t.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var r,o,t,e,s=0,l=0,a=this.get2DCursorLocation(i);t=a.charIndex,o=a.lineIndex;for(var h=0;h<o;h++)s+=this.getHeightOfLine(h);r=this._getLineLeftOffset(o);var u=this.__charBounds[o][t];return u&&(l=u.left),this.charSpacing!==0&&t===this._textLines[o].length&&(l-=this._getWidthOfCharSpacing()),e={top:s,left:r+(l>0?l:0)},this.direction==="rtl"&&(e.left*=-1),this.cursorOffsetCache=e,this.cursorOffsetCache},renderCursor:function(i,r){var o=this.get2DCursorLocation(),t=o.lineIndex,e=o.charIndex>0?o.charIndex-1:0,s=this.getValueOfPropertyAt(t,e,"fontSize"),l=this.scaleX*this.canvas.getZoom(),a=this.cursorWidth/l,h=i.topOffset,u=this.getValueOfPropertyAt(t,e,"deltaY");h+=(1-this._fontSizeFraction)*this.getHeightOfLine(t)/this.lineHeight-s*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,r),r.fillStyle=this.cursorColor||this.getValueOfPropertyAt(t,e,"fill"),r.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,r.fillRect(i.left+i.leftOffset-a/2,h+i.top+u,a,s)},renderSelection:function(i,r){for(var o=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,t=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,e=this.textAlign.indexOf("justify")!==-1,s=this.get2DCursorLocation(o),l=this.get2DCursorLocation(t),a=s.lineIndex,h=l.lineIndex,u=s.charIndex<0?0:s.charIndex,p=l.charIndex<0?0:l.charIndex,_=a;_<=h;_++){var y,v=this._getLineLeftOffset(_)||0,w=this.getHeightOfLine(_),T=0,P=0;if(_===a&&(T=this.__charBounds[a][u].left),_>=a&&_<h)P=e&&!this.isEndOfWrapping(_)?this.width:this.getLineWidth(_)||5;else if(_===h)if(p===0)P=this.__charBounds[h][p].left;else{var L=this._getWidthOfCharSpacing();P=this.__charBounds[h][p-1].left+this.__charBounds[h][p-1].width-L}y=w,(this.lineHeight<1||_===h&&this.lineHeight>1)&&(w/=this.lineHeight);var W=i.left+v+T,N=P-T,B=w,D=0;this.inCompositionMode?(r.fillStyle=this.compositionColor||"black",B=1,D=w):r.fillStyle=this.selectionColor,this.direction==="rtl"&&(W=this.width-W-N),r.fillRect(W,i.top+i.topOffset+D,N,B),i.topOffset+=y}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),r=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:r}}}),d.IText.fromObject=function(i,r){if(n(i),i.styles)for(var o in i.styles)for(var t in i.styles[o])n(i.styles[o][t]);d.Object._fromObject("IText",i,r,"text")}}(),vt=d.util.object.clone,d.util.object.extend(d.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var n=this;this.on("added",function(){var i=n.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,n._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(n))})},initRemovedHandler:function(){var n=this;this.on("removed",function(){var i=n.canvas;i&&(i._iTextInstances=i._iTextInstances||[],d.util.removeFromArray(i._iTextInstances,n),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,n._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(n){n._mouseUpITextHandler=function(){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.__isMousedown=!1})},n.on("mouse:up",n._mouseUpITextHandler)},_removeCanvasHandlers:function(n){n.off("mouse:up",n._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(n,i,r,o){var t;return t={isAborted:!1,abort:function(){this.isAborted=!0}},n.animate("_currentCursorOpacity",i,{duration:r,onComplete:function(){t.isAborted||n[o]()},onChange:function(){n.canvas&&n.selectionStart===n.selectionEnd&&n.renderCursorOrSelection()},abort:function(){return t.isAborted}}),t},_onTickComplete:function(){var n=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){n._currentTickCompleteState=n._animateCursor(n,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(n){var i=this,r=n?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},r)},abortCursorAnimation:function(){var n=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,n&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(n){var i=0,r=n-1;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)i++,r--;for(;/\S/.test(this._text[r])&&r>-1;)i++,r--;return n-i},findWordBoundaryRight:function(n){var i=0,r=n;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)i++,r++;for(;/\S/.test(this._text[r])&&r<this._text.length;)i++,r++;return n+i},findLineBoundaryLeft:function(n){for(var i=0,r=n-1;!/\n/.test(this._text[r])&&r>-1;)i++,r--;return n-i},findLineBoundaryRight:function(n){for(var i=0,r=n;!/\n/.test(this._text[r])&&r<this._text.length;)i++,r++;return n+i},searchWordBoundary:function(n,i){for(var r=this._text,o=this._reSpace.test(r[n])?n-1:n,t=r[o],e=d.reNonWord;!e.test(t)&&o>0&&o<r.length;)t=r[o+=i];return e.test(t)&&(o+=i===1?0:1),o},selectWord:function(n){n=n||this.selectionStart;var i=this.searchWordBoundary(n,-1),r=this.searchWordBoundary(n,1);this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(n){n=n||this.selectionStart;var i=this.findLineBoundaryLeft(n),r=this.findLineBoundaryRight(n);return this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(n){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(n),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(n){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(n){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(n.e),r=this.selectionStart,o=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&r!==o||r!==i&&o!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===r&&this.selectionEnd===o||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(n,i,r){var o=r.slice(0,n),t=d.util.string.graphemeSplit(o).length;if(n===i)return{selectionStart:t,selectionEnd:t};var e=r.slice(n,i);return{selectionStart:t,selectionEnd:t+d.util.string.graphemeSplit(e).length}},fromGraphemeToStringSelection:function(n,i,r){var o=r.slice(0,n).join("").length;return n===i?{selectionStart:o,selectionEnd:o}:{selectionStart:o,selectionEnd:o+r.slice(n,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var n=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=n.selectionStart,this.hiddenTextarea.selectionEnd=n.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var n=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=n.selectionEnd,this.inCompositionMode||(this.selectionStart=n.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var n=this._calcTextareaPosition();this.hiddenTextarea.style.left=n.left,this.hiddenTextarea.style.top=n.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var n=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(n),r=this.get2DCursorLocation(n),o=r.lineIndex,t=r.charIndex,e=this.getValueOfPropertyAt(o,t,"fontSize")*this.lineHeight,s=i.leftOffset,l=this.calcTransformMatrix(),a={x:i.left+s,y:i.top+i.topOffset+e},h=this.canvas.getRetinaScaling(),u=this.canvas.upperCanvasEl,p=u.width/h,_=u.height/h,y=p-e,v=_-e,w=u.clientWidth/p,T=u.clientHeight/_;return a=d.util.transformPoint(a,l),(a=d.util.transformPoint(a,this.canvas.viewportTransform)).x*=w,a.y*=T,a.x<0&&(a.x=0),a.x>y&&(a.x=y),a.y<0&&(a.y=0),a.y>v&&(a.y=v),a.x+=this.canvas._offset.left,a.y+=this.canvas._offset.top,{left:a.x+"px",top:a.y+"px",fontSize:e+"px",charHeight:e}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var n=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),n&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),n&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var n in this.styles)this._textLines[n]||delete this.styles[n]},removeStyleFromTo:function(n,i){var r,o,t=this.get2DCursorLocation(n,!0),e=this.get2DCursorLocation(i,!0),s=t.lineIndex,l=t.charIndex,a=e.lineIndex,h=e.charIndex;if(s!==a){if(this.styles[s])for(r=l;r<this._unwrappedTextLines[s].length;r++)delete this.styles[s][r];if(this.styles[a])for(r=h;r<this._unwrappedTextLines[a].length;r++)(o=this.styles[a][r])&&(this.styles[s]||(this.styles[s]={}),this.styles[s][l+r-h]=o);for(r=s+1;r<=a;r++)delete this.styles[r];this.shiftLineStyles(a,s-a)}else if(this.styles[s]){o=this.styles[s];var u,p,_=h-l;for(r=l;r<h;r++)delete o[r];for(p in this.styles[s])(u=parseInt(p,10))>=h&&(o[u-_]=o[p],delete o[p])}},shiftLineStyles:function(n,i){var r=vt(this.styles);for(var o in this.styles){var t=parseInt(o,10);t>n&&(this.styles[t+i]=r[t],r[t-i]||delete this.styles[t])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(n,i,r,o){var t,e={},s=!1,l=this._unwrappedTextLines[n].length===i;for(var a in r||(r=1),this.shiftLineStyles(n,r),this.styles[n]&&(t=this.styles[n][i===0?i:i-1]),this.styles[n]){var h=parseInt(a,10);h>=i&&(s=!0,e[h-i]=this.styles[n][a],l&&i===0||delete this.styles[n][a])}var u=!1;for(s&&!l&&(this.styles[n+r]=e,u=!0),u&&r--;r>0;)o&&o[r-1]?this.styles[n+r]={0:vt(o[r-1])}:t?this.styles[n+r]={0:vt(t)}:delete this.styles[n+r],r--;this._forceClearCache=!0},insertCharStyleObject:function(n,i,r,o){this.styles||(this.styles={});var t=this.styles[n],e=t?vt(t):{};for(var s in r||(r=1),e){var l=parseInt(s,10);l>=i&&(t[l+r]=e[l],e[l-r]||delete t[l])}if(this._forceClearCache=!0,o)for(;r--;)Object.keys(o[r]).length&&(this.styles[n]||(this.styles[n]={}),this.styles[n][i+r]=vt(o[r]));else if(t)for(var a=t[i?i-1:1];a&&r--;)this.styles[n][i+r]=vt(a)},insertNewStyleBlock:function(n,i,r){for(var o=this.get2DCursorLocation(i,!0),t=[0],e=0,s=0;s<n.length;s++)n[s]===`
`?t[++e]=0:t[e]++;for(t[0]>0&&(this.insertCharStyleObject(o.lineIndex,o.charIndex,t[0],r),r=r&&r.slice(t[0]+1)),e&&this.insertNewlineStyleObject(o.lineIndex,o.charIndex+t[0],e),s=1;s<e;s++)t[s]>0?this.insertCharStyleObject(o.lineIndex+s,0,t[s],r):r&&this.styles[o.lineIndex+s]&&r[0]&&(this.styles[o.lineIndex+s][0]=r[0]),r=r&&r.slice(t[s]+1);t[s]>0&&this.insertCharStyleObject(o.lineIndex+s,0,t[s],r)},setSelectionStartEndWithShift:function(n,i,r){r<=n?(i===n?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=n),this.selectionStart=r):r>n&&r<i?this._selectionDirection==="right"?this.selectionEnd=r:this.selectionStart=r:(i===n?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=r)},setSelectionInBoundaries:function(){var n=this.text.length;this.selectionStart>n?this.selectionStart=n:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>n?this.selectionEnd=n:this.selectionEnd<0&&(this.selectionEnd=0)}}),d.util.object.extend(d.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(n){if(this.canvas){this.__newClickTime=+new Date;var i=n.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",n),this._stopEvent(n.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(n){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===n.x&&this.__lastPointer.y===n.y},_stopEvent:function(n){n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(n){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(n.e))},tripleClickHandler:function(n){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(n.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(n.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(n){if(this.__isMousedown=!1,!(!this.editable||this.group||n.transform&&n.transform.actionPerformed||n.e.button&&n.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(n.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(n){var i=this.getSelectionStartFromPointer(n),r=this.selectionStart,o=this.selectionEnd;n.shiftKey?this.setSelectionStartEndWithShift(r,o,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(n){for(var i,r=this.getLocalPointer(n),o=0,t=0,e=0,s=0,l=0,a=0,h=this._textLines.length;a<h&&e<=r.y;a++)e+=this.getHeightOfLine(a)*this.scaleY,l=a,a>0&&(s+=this._textLines[a-1].length+this.missingNewlineOffset(a-1));t=this._getLineLeftOffset(l)*this.scaleX,i=this._textLines[l],this.direction==="rtl"&&(r.x=this.width*this.scaleX-r.x+t);for(var u=0,p=i.length;u<p&&(o=t,(t+=this.__charBounds[l][u].kernedWidth*this.scaleX)<=r.x);u++)s++;return this._getNewSelectionStartFromOffset(r,o,t,s,p)},_getNewSelectionStartFromOffset:function(n,i,r,o,t){var e=n.x-i,s=r-n.x,l=o+(s>e||s<0?0:1);return this.flipX&&(l=t-l),l>this._text.length&&(l=this._text.length),l}}),d.util.object.extend(d.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=d.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var n=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+n.top+"; left: "+n.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingｰtop: "+n.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):d.document.body.appendChild(this.hiddenTextarea),d.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),d.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),d.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),d.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),d.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),d.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(d.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(n){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(n.keyCode in i)this[i[n.keyCode]](n);else{if(!(n.keyCode in this.ctrlKeysMapDown)||!n.ctrlKey&&!n.metaKey)return;this[this.ctrlKeysMapDown[n.keyCode]](n)}n.stopImmediatePropagation(),n.preventDefault(),n.keyCode>=33&&n.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(n){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:n.keyCode in this.ctrlKeysMapUp&&(n.ctrlKey||n.metaKey)&&(this[this.ctrlKeysMapUp[n.keyCode]](n),n.stopImmediatePropagation(),n.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(n){var i=this.fromPaste;if(this.fromPaste=!1,n&&n.stopPropagation(),this.isEditing){var r,o,t,e,s,l=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,a=this._text.length,h=l.length,u=h-a,p=this.selectionStart,_=this.selectionEnd,y=p!==_;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var v=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),w=p>v.selectionStart;y?(r=this._text.slice(p,_),u+=_-p):h<a&&(r=w?this._text.slice(_+u,_):this._text.slice(p,p-u)),o=l.slice(v.selectionEnd-u,v.selectionEnd),r&&r.length&&(o.length&&(t=this.getSelectionStyles(p,p+1,!1),t=o.map(function(){return t[0]})),y?(e=p,s=_):w?(e=_-r.length,s=_):(e=_,s=_+r.length),this.removeStyleFromTo(e,s)),o.length&&(i&&o.join("")===d.copiedText&&!d.disableStyleCopyPaste&&(t=d.copiedTextStyle),this.insertNewStyleBlock(o,p,t)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(n){this.compositionStart=n.target.selectionStart,this.compositionEnd=n.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(d.copiedText=this.getSelectedText(),d.disableStyleCopyPaste?d.copiedTextStyle=null:d.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(n){return n&&n.clipboardData||d.window.clipboardData},_getWidthBeforeCursor:function(n,i){var r,o=this._getLineLeftOffset(n);return i>0&&(o+=(r=this.__charBounds[n][i-1]).left+r.width),o},getDownCursorOffset:function(n,i){var r=this._getSelectionForOffset(n,i),o=this.get2DCursorLocation(r),t=o.lineIndex;if(t===this._textLines.length-1||n.metaKey||n.keyCode===34)return this._text.length-r;var e=o.charIndex,s=this._getWidthBeforeCursor(t,e),l=this._getIndexOnLine(t+1,s);return this._textLines[t].slice(e).length+l+1+this.missingNewlineOffset(t)},_getSelectionForOffset:function(n,i){return n.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(n,i){var r=this._getSelectionForOffset(n,i),o=this.get2DCursorLocation(r),t=o.lineIndex;if(t===0||n.metaKey||n.keyCode===33)return-r;var e=o.charIndex,s=this._getWidthBeforeCursor(t,e),l=this._getIndexOnLine(t-1,s),a=this._textLines[t].slice(0,e),h=this.missingNewlineOffset(t-1);return-this._textLines[t-1].length+l-a.length+(1-h)},_getIndexOnLine:function(n,i){for(var r,o,t=this._textLines[n],e=this._getLineLeftOffset(n),s=0,l=0,a=t.length;l<a;l++)if((e+=r=this.__charBounds[n][l].width)>i){o=!0;var h=e-r,u=e,p=Math.abs(h-i);s=Math.abs(u-i)<p?l:l-1;break}return o||(s=t.length-1),s},moveCursorDown:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",n)},moveCursorUp:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",n)},_moveCursorUpOrDown:function(n,i){var r=this["get"+n+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(r):this.moveCursorWithoutShift(r),r!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(n){var i=this._selectionDirection==="left"?this.selectionStart+n:this.selectionEnd+n;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),n!==0},moveCursorWithoutShift:function(n){return n<0?(this.selectionStart+=n,this.selectionEnd=this.selectionStart):(this.selectionEnd+=n,this.selectionStart=this.selectionEnd),n!==0},moveCursorLeft:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",n)},_move:function(n,i,r){var o;if(n.altKey)o=this["findWordBoundary"+r](this[i]);else{if(!n.metaKey&&n.keyCode!==35&&n.keyCode!==36)return this[i]+=r==="Left"?-1:1,!0;o=this["findLineBoundary"+r](this[i])}if(typeof o!==void 0&&this[i]!==o)return this[i]=o,!0},_moveLeft:function(n,i){return this._move(n,i,"Left")},_moveRight:function(n,i){return this._move(n,i,"Right")},moveCursorLeftWithoutShift:function(n){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(n,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(n){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(n,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(n,"selectionStart")):void 0},moveCursorRight:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",n)},_moveCursorLeftOrRight:function(n,i){var r="moveCursor"+n+"With";this._currentCursorOpacity=1,i.shiftKey?r+="Shift":r+="outShift",this[r](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(n){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(n,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(n,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(n){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(n,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(n,i){i===void 0&&(i=n+1),this.removeStyleFromTo(n,i),this._text.splice(n,i-n),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(n,i,r,o){o===void 0&&(o=r),o>r&&this.removeStyleFromTo(r,o);var t=d.util.string.graphemeSplit(n);this.insertNewStyleBlock(t,r,i),this._text=[].concat(this._text.slice(0,r),t,this._text.slice(o)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var n=d.util.toFixed,i=/  +/g;d.util.object.extend(d.Text.prototype,{_toSVG:function(){var r=this._getSVGLeftTopOffsets(),o=this._getSVGTextAndBg(r.textTop,r.textLeft);return this._wrapSVGTextAndBg(o)},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(),{reviver:r,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(r){var o=this.getSvgTextDecoration(this);return[r.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",o?'text-decoration="'+o+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",r.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(r,o){var t,e=[],s=[],l=r;this._setSVGBg(s);for(var a=0,h=this._textLines.length;a<h;a++)t=this._getLineLeftOffset(a),(this.textBackgroundColor||this.styleHas("textBackgroundColor",a))&&this._setSVGTextLineBg(s,a,o+t,l),this._setSVGTextLineText(e,a,o+t,l),l+=this.getHeightOfLine(a);return{textSpans:e,textBgRects:s}},_createTextCharSpan:function(r,o,t,e){var s=r!==r.trim()||r.match(i),l=this.getSvgSpanStyles(o,s),a=l?'style="'+l+'"':"",h=o.deltaY,u="",p=d.Object.NUM_FRACTION_DIGITS;return h&&(u=' dy="'+n(h,p)+'" '),['<tspan x="',n(t,p),'" y="',n(e,p),'" ',u,a,">",d.util.string.escapeXml(r),"</tspan>"].join("")},_setSVGTextLineText:function(r,o,t,e){var s,l,a,h,u,p=this.getHeightOfLine(o),_=this.textAlign.indexOf("justify")!==-1,y="",v=0,w=this._textLines[o];e+=p*(1-this._fontSizeFraction)/this.lineHeight;for(var T=0,P=w.length-1;T<=P;T++)u=T===P||this.charSpacing,y+=w[T],a=this.__charBounds[o][T],v===0?(t+=a.kernedWidth-a.width,v+=a.width):v+=a.kernedWidth,_&&!u&&this._reSpaceAndTab.test(w[T])&&(u=!0),u||(s=s||this.getCompleteStyleDeclaration(o,T),l=this.getCompleteStyleDeclaration(o,T+1),u=this._hasStyleChangedForSvg(s,l)),u&&(h=this._getStyleDeclaration(o,T)||{},r.push(this._createTextCharSpan(y,h,t,e)),y="",s=l,t+=v,v=0)},_pushTextBgRect:function(r,o,t,e,s,l){var a=d.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(o),' x="',n(t,a),'" y="',n(e,a),'" width="',n(s,a),'" height="',n(l,a),`"></rect>
`)},_setSVGTextLineBg:function(r,o,t,e){for(var s,l,a=this._textLines[o],h=this.getHeightOfLine(o)/this.lineHeight,u=0,p=0,_=this.getValueOfPropertyAt(o,0,"textBackgroundColor"),y=0,v=a.length;y<v;y++)s=this.__charBounds[o][y],(l=this.getValueOfPropertyAt(o,y,"textBackgroundColor"))!==_?(_&&this._pushTextBgRect(r,_,t+p,e,u,h),p=s.left,u=s.width,_=l):u+=s.kernedWidth;l&&this._pushTextBgRect(r,l,t+p,e,u,h)},_getFillAttributes:function(r){var o=r&&typeof r=="string"?new d.Color(r):"";return o&&o.getSource()&&o.getAlpha()!==1?'opacity="'+o.getAlpha()+'" fill="'+o.setAlpha(1).toRgb()+'"':'fill="'+r+'"'},_getSVGLineTopOffset:function(r){for(var o,t=0,e=0;e<r;e++)t+=this.getHeightOfLine(e);return o=this.getHeightOfLine(e),{lineTop:t,offset:(this._fontSizeMult-this._fontSizeFraction)*o/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(r){return d.Object.prototype.getSvgStyles.call(this,r)+" white-space: pre;"}})}(),function(n){var i=n.fabric||(n.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(r){for(var o=0,t=0,e=0,s={},l=0;l<r.graphemeLines.length;l++)r.graphemeText[e]===`
`&&l>0?(t=0,e++,o++):!this.splitByGrapheme&&this._reSpaceAndTab.test(r.graphemeText[e])&&l>0&&(t++,e++),s[l]={line:o,offset:t},e+=r.graphemeLines[l].length,t+=r.graphemeLines[l].length;return s},styleHas:function(r,o){if(this._styleMap&&!this.isWrapping){var t=this._styleMap[o];t&&(o=t.line)}return i.Text.prototype.styleHas.call(this,r,o)},isEmptyStyles:function(r){if(!this.styles)return!0;var o,t,e=0,s=!1,l=this._styleMap[r],a=this._styleMap[r+1];for(var h in l&&(r=l.line,e=l.offset),a&&(s=a.line===r,o=a.offset),t=r===void 0?this.styles:{line:this.styles[r]})for(var u in t[h])if(u>=e&&(!s||u<o))for(var p in t[h][u])return!1;return!0},_getStyleDeclaration:function(r,o){if(this._styleMap&&!this.isWrapping){var t=this._styleMap[r];if(!t)return null;r=t.line,o=t.offset+o}return this.callSuper("_getStyleDeclaration",r,o)},_setStyleDeclaration:function(r,o,t){var e=this._styleMap[r];r=e.line,o=e.offset+o,this.styles[r][o]=t},_deleteStyleDeclaration:function(r,o){var t=this._styleMap[r];r=t.line,o=t.offset+o,delete this.styles[r][o]},_getLineStyle:function(r){var o=this._styleMap[r];return!!this.styles[o.line]},_setLineStyle:function(r){var o=this._styleMap[r];this.styles[o.line]={}},_wrapText:function(r,o){var t,e=[];for(this.isWrapping=!0,t=0;t<r.length;t++)e=e.concat(this._wrapLine(r[t],t,o));return this.isWrapping=!1,e},_measureWord:function(r,o,t){var e,s=0;t=t||0;for(var l=0,a=r.length;l<a;l++)s+=this._getGraphemeBox(r[l],o,l+t,e,!0).kernedWidth,e=r[l];return s},_wrapLine:function(r,o,t,e){var s=0,l=this.splitByGrapheme,a=[],h=[],u=l?i.util.string.graphemeSplit(r):r.split(this._wordJoiners),p="",_=0,y=l?"":" ",v=0,w=0,T=0,P=!0,L=this._getWidthOfCharSpacing();e=e||0,u.length===0&&u.push([]),t-=e;for(var W=0;W<u.length;W++)p=l?u[W]:i.util.string.graphemeSplit(u[W]),v=this._measureWord(p,o,_),_+=p.length,(s+=w+v-L)>t&&!P?(a.push(h),h=[],s=v,P=!0):s+=L,P||l||h.push(y),h=h.concat(p),w=l?0:this._measureWord([y],o,_),_++,P=!1,v>T&&(T=v);return W&&a.push(h),T+e>this.dynamicMinWidth&&(this.dynamicMinWidth=T-L+e),a},isEndOfWrapping:function(r){return!this._styleMap[r+1]||this._styleMap[r+1].line!==this._styleMap[r].line},missingNewlineOffset:function(r){return this.splitByGrapheme?this.isEndOfWrapping(r)?1:0:1},_splitTextIntoLines:function(r){for(var o=i.Text.prototype._splitTextIntoLines.call(this,r),t=this._wrapText(o.lines,this.width),e=new Array(t.length),s=0;s<t.length;s++)e[s]=t[s].join("");return o.lines=e,o.graphemeLines=t,o},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var r={};for(var o in this._styleMap)this._textLines[o]&&(r[this._styleMap[o].line]=1);for(var o in this.styles)r[o]||delete this.styles[o]},toObject:function(r){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(r))}}),i.Textbox.fromObject=function(r,o){return i.Object._fromObject("Textbox",r,o,"text")}}(c),function(){var n=d.controlsUtils,i=n.scaleSkewCursorStyleHandler,r=n.scaleCursorStyleHandler,o=n.scalingEqually,t=n.scalingYOrSkewingX,e=n.scalingXOrSkewingY,s=n.scaleOrSkewActionName,l=d.Object.prototype.controls;if(l.ml=new d.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:e,getActionName:s}),l.mr=new d.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:e,getActionName:s}),l.mb=new d.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:t,getActionName:s}),l.mt=new d.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:t,getActionName:s}),l.tl=new d.Control({x:-.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),l.tr=new d.Control({x:.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),l.bl=new d.Control({x:-.5,y:.5,cursorStyleHandler:r,actionHandler:o}),l.br=new d.Control({x:.5,y:.5,cursorStyleHandler:r,actionHandler:o}),l.mtr=new d.Control({x:0,y:-.5,actionHandler:n.rotationWithSnapping,cursorStyleHandler:n.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),d.Textbox){var a=d.Textbox.prototype.controls={};a.mtr=l.mtr,a.tr=l.tr,a.br=l.br,a.tl=l.tl,a.bl=l.bl,a.mt=l.mt,a.mb=l.mb,a.mr=new d.Control({x:.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),a.ml=new d.Control({x:-.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},Oe={};function zt(f){var c=Oe[f];if(c!==void 0)return c.exports;var g=Oe[f]={exports:{}};return Ti[f](g,g.exports,zt),g.exports}zt.d=(f,c)=>{for(var g in c)zt.o(c,g)&&!zt.o(f,g)&&Object.defineProperty(f,g,{enumerable:!0,get:c[g]})},zt.o=(f,c)=>Object.prototype.hasOwnProperty.call(f,c);var li={};(()=>{let f;zt.d(li,{R:()=>f}),f=typeof document<"u"&&typeof window<"u"?zt(653).fabric:{version:"5.2.1"}})();var xt=li.R;/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.3.5 (js 20230801)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */const be=typeof self>"u";let ee,ie,se,ye,Nt;if(typeof navigator<"u"&&(ee=navigator,ie=ee.userAgent,se=ee.platform,ye=ee.mediaDevices),!be){const f={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:ee.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},c={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:se,search:"Win"},Mac:{str:se},Linux:{str:se}};let g="unknownBrowser",m=0,C="unknownOS";for(let b in f){const S=f[b]||{};let x=S.str||ie,R=S.search||b,O=S.verStr||ie,E=S.verSearch||b;if(E instanceof Array||(E=[E]),x.indexOf(R)!=-1){g=b;for(let V of E){let j=O.indexOf(V);if(j!=-1){m=parseFloat(O.substring(j+V.length+1));break}}break}}for(let b in c){const S=c[b]||{};let x=S.str||ie,R=S.search||b;if(x.indexOf(R)!=-1){C=b;break}}C=="Linux"&&ie.indexOf("Windows NT")!=-1&&(C="HarmonyOS"),Nt={browser:g,version:m,OS:C}}be&&(Nt={browser:"ssr",version:0,OS:"ssr"});!ye||ye.getUserMedia;Nt.browser==="Chrome"&&Nt.version>66||Nt.browser==="Safari"&&Nt.version>13||Nt.browser==="OPR"&&Nt.version>43||Nt.browser==="Edge"&&Nt.version;(()=>{if(!be&&document.currentScript){let f=document.currentScript.src,c=f.indexOf("?");if(c!=-1)f=f.substring(0,c);else{let g=f.indexOf("#");g!=-1&&(f=f.substring(0,g))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})();typeof document<"u"&&typeof window<"u"&&(xt.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(xt.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(f){f.dispose&&f.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),xt.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},xt.Object.prototype.transparentCorners=!1,xt.Object.prototype.cornerSize=20,xt.Object.prototype.touchCornerSize=100,xt.Object.prototype.cornerColor="rgb(254,142,20)",xt.Object.prototype.cornerStyle="circle",xt.Object.prototype.strokeUniform=!0,xt.Object.prototype.hasBorders=!1,xt.Canvas.prototype.containerClass="",xt.Canvas.prototype.getPointer=function(f,c){if(this._absolutePointer&&!c)return this._absolutePointer;if(this._pointer&&c)return this._pointer;var g,m=this.upperCanvasEl,C=xt.util.getPointer(f,m),b=m.getBoundingClientRect(),S=b.width||0,x=b.height||0;S&&x||("top"in b&&"bottom"in b&&(x=Math.abs(b.top-b.bottom)),"right"in b&&"left"in b&&(S=Math.abs(b.right-b.left))),this.calcOffset(),C.x=C.x-this._offset.left,C.y=C.y-this._offset.top,c||(C=this.restorePointerVpt(C));var R=this.getRetinaScaling();if(R!==1&&(C.x/=R,C.y/=R),S!==0&&x!==0){var O=window.getComputedStyle(m).objectFit,E=m.width,V=m.height,j=S,tt=x;g={width:E/j,height:V/tt};var K,J,Z=E/V,ht=j/tt;return O==="contain"?Z>ht?(K=j,J=j/Z,{x:C.x*g.width,y:(C.y-(tt-J)/2)*g.width}):(K=tt*Z,J=tt,{x:(C.x-(j-K)/2)*g.height,y:C.y*g.height}):O==="cover"?Z>ht?{x:(E-g.height*j)/2+C.x*g.height,y:C.y*g.height}:{x:C.x*g.width,y:(V-g.width*tt)/2+C.y*g.width}:{x:C.x*g.width,y:C.y*g.height}}return g={width:1,height:1},{x:C.x*g.width,y:C.y*g.height}},xt.Canvas.prototype._onTouchStart=function(f){var c=this.findTarget(f);!this.allowTouchScrolling&&f.cancelable&&f.preventDefault&&f.preventDefault(),c&&f.cancelable&&f.preventDefault&&f.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(f)),this.__onMouseDown(f),this._resetTransformEventData();var g=this.upperCanvasEl,m=this._getEventPrefix();xt.util.addListener(xt.document,"touchend",this._onTouchEnd,{passive:!1}),xt.util.addListener(xt.document,"touchmove",this._onMouseMove,{passive:!1}),xt.util.removeListener(g,m+"down",this._onMouseDown)},xt.Textbox.prototype._wrapLine=function(f,c,g,m){const C=f.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),b=!(!C||!C.length);var S=0,x=this.splitByGrapheme||b,R=[],O=[],E=x?xt.util.string.graphemeSplit(f):f.split(this._wordJoiners),V="",j=0,tt=x?"":" ",K=0,J=0,Z=0,ht=!0,at=this._getWidthOfCharSpacing();m=m||0,E.length===0&&E.push([]),g-=m;for(var st=0;st<E.length;st++)V=x?E[st]:xt.util.string.graphemeSplit(E[st]),K=this._measureWord(V,c,j),j+=V.length,(S+=J+K-at)>g&&!ht?(R.push(O),O=[],S=K,ht=!0):S+=at,ht||x||O.push(tt),O=O.concat(V),J=x?0:this._measureWord([tt],c,j),j++,ht=!1,K>Z&&(Z=K);return st&&R.push(O),Z+m>this.dynamicMinWidth&&(this.dynamicMinWidth=Z-at+m),R});var Ee;(function(f){f.GREY="grey",f.GREY32="grey32",f.RGBA="rgba",f.RBGA="rbga",f.GRBA="grba",f.GBRA="gbra",f.BRGA="brga",f.BGRA="bgra"})(Ee||(Ee={}));var Ae,De,Ie,Re,Me,Pe,Le,ke,Fe,Be,je,Ne,Ue,Ve,Ge,We,He,Xe,Ye,ze,qe,Ke,Je,Ze,Qe,$e;(function(f){f[f.BICM_DARK_ON_LIGHT=1]="BICM_DARK_ON_LIGHT",f[f.BICM_LIGHT_ON_DARK=2]="BICM_LIGHT_ON_DARK",f[f.BICM_DARK_ON_DARK=4]="BICM_DARK_ON_DARK",f[f.BICM_LIGHT_ON_LIGHT=8]="BICM_LIGHT_ON_LIGHT",f[f.BICM_DARK_LIGHT_MIXED=16]="BICM_DARK_LIGHT_MIXED",f[f.BICM_DARK_ON_LIGHT_DARK_SURROUNDING=32]="BICM_DARK_ON_LIGHT_DARK_SURROUNDING",f[f.BICM_SKIP=0]="BICM_SKIP",f[f.BICM_REV=2147483648]="BICM_REV"})(Ae||(Ae={})),function(f){f[f.BCM_AUTO=1]="BCM_AUTO",f[f.BCM_GENERAL=2]="BCM_GENERAL",f[f.BCM_SKIP=0]="BCM_SKIP",f[f.BCM_REV=2147483648]="BCM_REV"}(De||(De={})),function(f){f[f.BF2_NULL=0]="BF2_NULL",f[f.BF2_POSTALCODE=32505856]="BF2_POSTALCODE",f[f.BF2_NONSTANDARD_BARCODE=1]="BF2_NONSTANDARD_BARCODE",f[f.BF2_USPSINTELLIGENTMAIL=1048576]="BF2_USPSINTELLIGENTMAIL",f[f.BF2_POSTNET=2097152]="BF2_POSTNET",f[f.BF2_PLANET=4194304]="BF2_PLANET",f[f.BF2_AUSTRALIANPOST=8388608]="BF2_AUSTRALIANPOST",f[f.BF2_RM4SCC=16777216]="BF2_RM4SCC",f[f.BF2_DOTCODE=2]="BF2_DOTCODE",f[f.BF2_PHARMACODE_ONE_TRACK=4]="BF2_PHARMACODE_ONE_TRACK",f[f.BF2_PHARMACODE_TWO_TRACK=8]="BF2_PHARMACODE_TWO_TRACK",f[f.BF2_PHARMACODE=12]="BF2_PHARMACODE",f[f.BF2_ALL=-1]="BF2_ALL"}(Ie||(Ie={})),function(f){f[f.BM_AUTO=1]="BM_AUTO",f[f.BM_LOCAL_BLOCK=2]="BM_LOCAL_BLOCK",f[f.BM_SKIP=0]="BM_SKIP",f[f.BM_THRESHOLD=4]="BM_THRESHOLD",f[f.BM_REV=2147483648]="BM_REV"}(Re||(Re={})),function(f){f[f.ECCM_CONTRAST=1]="ECCM_CONTRAST"}(Me||(Me={})),function(f){f[f.CFM_GENERAL=1]="CFM_GENERAL"}(Pe||(Pe={})),function(f){f[f.CCM_AUTO=1]="CCM_AUTO",f[f.CCM_GENERAL_HSV=2]="CCM_GENERAL_HSV",f[f.CCM_SKIP=0]="CCM_SKIP",f[f.CCM_REV=2147483648]="CCM_REV"}(Le||(Le={})),function(f){f[f.CICM_GENERAL=1]="CICM_GENERAL",f[f.CICM_SKIP=0]="CICM_SKIP",f[f.CICM_REV=2147483648]="CICM_REV"}(ke||(ke={})),function(f){f[f.CM_IGNORE=1]="CM_IGNORE",f[f.CM_OVERWRITE=2]="CM_OVERWRITE"}(Fe||(Fe={})),function(f){f[f.DM_SKIP=0]="DM_SKIP",f[f.DM_DIRECT_BINARIZATION=1]="DM_DIRECT_BINARIZATION",f[f.DM_THRESHOLD_BINARIZATION=2]="DM_THRESHOLD_BINARIZATION",f[f.DM_GRAY_EQUALIZATION=4]="DM_GRAY_EQUALIZATION",f[f.DM_SMOOTHING=8]="DM_SMOOTHING",f[f.DM_MORPHING=16]="DM_MORPHING",f[f.DM_DEEP_ANALYSIS=32]="DM_DEEP_ANALYSIS",f[f.DM_SHARPENING=64]="DM_SHARPENING",f[f.DM_BASED_ON_LOC_BIN=128]="DM_BASED_ON_LOC_BIN",f[f.DM_SHARPENING_SMOOTHING=256]="DM_SHARPENING_SMOOTHING"}(Be||(Be={})),function(f){f[f.DRM_AUTO=1]="DRM_AUTO",f[f.DRM_GENERAL=2]="DRM_GENERAL",f[f.DRM_BROAD_WARP=4]="DRM_BROAD_WARP",f[f.DRM_LOCAL_REFERENCE=8]="DRM_LOCAL_REFERENCE",f[f.DRM_DEWRINKLE=16]="DRM_DEWRINKLE",f[f.DRM_SKIP=0]="DRM_SKIP",f[f.DRM_REV=2147483648]="DRM_REV"}(je||(je={})),function(f){f[f.DPMCRM_AUTO=1]="DPMCRM_AUTO",f[f.DPMCRM_GENERAL=2]="DPMCRM_GENERAL",f[f.DPMCRM_SKIP=0]="DPMCRM_SKIP",f[f.DPMCRM_REV=2147483648]="DPMCRM_REV"}(Ne||(Ne={})),function(f){f[f.GTM_INVERTED=1]="GTM_INVERTED",f[f.GTM_ORIGINAL=2]="GTM_ORIGINAL",f[f.GTM_SKIP=0]="GTM_SKIP",f[f.GTM_REV=2147483648]="GTM_REV"}(Ue||(Ue={})),function(f){f[f.IPM_AUTO=1]="IPM_AUTO",f[f.IPM_GENERAL=2]="IPM_GENERAL",f[f.IPM_GRAY_EQUALIZE=4]="IPM_GRAY_EQUALIZE",f[f.IPM_GRAY_SMOOTH=8]="IPM_GRAY_SMOOTH",f[f.IPM_SHARPEN_SMOOTH=16]="IPM_SHARPEN_SMOOTH",f[f.IPM_MORPHOLOGY=32]="IPM_MORPHOLOGY",f[f.IPM_SKIP=0]="IPM_SKIP",f[f.IPM_REV=2147483648]="IPM_REV"}(Ve||(Ve={})),function(f){f[f.IRSM_MEMORY=1]="IRSM_MEMORY",f[f.IRSM_FILESYSTEM=2]="IRSM_FILESYSTEM",f[f.IRSM_BOTH=4]="IRSM_BOTH"}(Ge||(Ge={})),function(f){f[f.LM_SKIP=0]="LM_SKIP",f[f.LM_AUTO=1]="LM_AUTO",f[f.LM_CONNECTED_BLOCKS=2]="LM_CONNECTED_BLOCKS",f[f.LM_LINES=8]="LM_LINES",f[f.LM_STATISTICS=4]="LM_STATISTICS",f[f.LM_SCAN_DIRECTLY=16]="LM_SCAN_DIRECTLY",f[f.LM_STATISTICS_MARKS=32]="LM_STATISTICS_MARKS",f[f.LM_STATISTICS_POSTAL_CODE=64]="LM_STATISTICS_POSTAL_CODE",f[f.LM_CENTRE=128]="LM_CENTRE",f[f.LM_ONED_FAST_SCAN=256]="LM_ONED_FAST_SCAN",f[f.LM_REV=2147483648]="LM_REV"}(We||(We={})),function(f){f[f.PDFRM_RASTER=1]="PDFRM_RASTER",f[f.PDFRM_AUTO=2]="PDFRM_AUTO",f[f.PDFRM_VECTOR=4]="PDFRM_VECTOR",f[f.PDFRM_REV=2147483648]="PDFRM_REV"}(He||(He={})),function(f){f[f.QRECL_ERROR_CORRECTION_H=0]="QRECL_ERROR_CORRECTION_H",f[f.QRECL_ERROR_CORRECTION_L=1]="QRECL_ERROR_CORRECTION_L",f[f.QRECL_ERROR_CORRECTION_M=2]="QRECL_ERROR_CORRECTION_M",f[f.QRECL_ERROR_CORRECTION_Q=3]="QRECL_ERROR_CORRECTION_Q"}(Xe||(Xe={})),function(f){f[f.RPM_AUTO=1]="RPM_AUTO",f[f.RPM_GENERAL=2]="RPM_GENERAL",f[f.RPM_GENERAL_RGB_CONTRAST=4]="RPM_GENERAL_RGB_CONTRAST",f[f.RPM_GENERAL_GRAY_CONTRAST=8]="RPM_GENERAL_GRAY_CONTRAST",f[f.RPM_GENERAL_HSV_CONTRAST=16]="RPM_GENERAL_HSV_CONTRAST",f[f.RPM_SKIP=0]="RPM_SKIP",f[f.RPM_REV=2147483648]="RPM_REV"}(Ye||(Ye={})),function(f){f[f.RCT_PIXEL=1]="RCT_PIXEL",f[f.RCT_PERCENTAGE=2]="RCT_PERCENTAGE"}(ze||(ze={})),function(f){f[f.RT_STANDARD_TEXT=0]="RT_STANDARD_TEXT",f[f.RT_RAW_TEXT=1]="RT_RAW_TEXT",f[f.RT_CANDIDATE_TEXT=2]="RT_CANDIDATE_TEXT",f[f.RT_PARTIAL_TEXT=3]="RT_PARTIAL_TEXT"}(qe||(qe={})),function(f){f[f.SUM_AUTO=1]="SUM_AUTO",f[f.SUM_LINEAR_INTERPOLATION=2]="SUM_LINEAR_INTERPOLATION",f[f.SUM_NEAREST_NEIGHBOUR_INTERPOLATION=4]="SUM_NEAREST_NEIGHBOUR_INTERPOLATION",f[f.SUM_SKIP=0]="SUM_SKIP",f[f.SUM_REV=2147483648]="SUM_REV"}(Ke||(Ke={})),function(f){f[f.TP_REGION_PREDETECTED=1]="TP_REGION_PREDETECTED",f[f.TP_IMAGE_PREPROCESSED=2]="TP_IMAGE_PREPROCESSED",f[f.TP_IMAGE_BINARIZED=4]="TP_IMAGE_BINARIZED",f[f.TP_BARCODE_LOCALIZED=8]="TP_BARCODE_LOCALIZED",f[f.TP_BARCODE_TYPE_DETERMINED=16]="TP_BARCODE_TYPE_DETERMINED",f[f.TP_BARCODE_RECOGNIZED=32]="TP_BARCODE_RECOGNIZED"}(Je||(Je={})),function(f){f[f.TFM_AUTO=1]="TFM_AUTO",f[f.TFM_GENERAL_CONTOUR=2]="TFM_GENERAL_CONTOUR",f[f.TFM_SKIP=0]="TFM_SKIP",f[f.TFM_REV=2147483648]="TFM_REV"}(Ze||(Ze={})),function(f){f[f.TROM_CONFIDENCE=1]="TROM_CONFIDENCE",f[f.TROM_POSITION=2]="TROM_POSITION",f[f.TROM_FORMAT=4]="TROM_FORMAT",f[f.TROM_SKIP=0]="TROM_SKIP",f[f.TROM_REV=2147483648]="TROM_REV"}(Qe||(Qe={})),function(f){f[f.TDM_AUTO=1]="TDM_AUTO",f[f.TDM_GENERAL_WIDTH_CONCENTRATION=2]="TDM_GENERAL_WIDTH_CONCENTRATION",f[f.TDM_SKIP=0]="TDM_SKIP",f[f.TDM_REV=2147483648]="TDM_REV"}($e||($e={}));/*! For license information please see fabric.js.LICENSE.txt */var Oi={653:(f,c,g)=>{var m,C,b,S,x,R,O,E,V,j,tt,K,J,Z,ht,at,st,dt,gt,pt,vt,d=d||{version:"5.2.1"};if(c.fabric=d,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?d.document=document:d.document=document.implementation.createHTMLDocument(""),d.window=window;else{var mt=new(g(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;d.document=mt.document,d.jsdomImplForWrapper=g(898).implForWrapper,d.nodeCanvas=g(245).Canvas,d.window=mt,DOMParser=d.window.DOMParser}function Ct(n,i){var r=n.canvas,o=i.targetCanvas,t=o.getContext("2d");t.translate(0,o.height),t.scale(1,-1);var e=r.height-o.height;t.drawImage(r,0,e,o.width,o.height,0,0,o.width,o.height)}function It(n,i){var r=i.targetCanvas.getContext("2d"),o=i.destinationWidth,t=i.destinationHeight,e=o*t*4,s=new Uint8Array(this.imageBuffer,0,e),l=new Uint8ClampedArray(this.imageBuffer,0,e);n.readPixels(0,0,o,t,n.RGBA,n.UNSIGNED_BYTE,s);var a=new ImageData(l,o,t);r.putImageData(a,0,0)}d.isTouchSupported="ontouchstart"in d.window||"ontouchstart"in d.document||d.window&&d.window.navigator&&d.window.navigator.maxTouchPoints>0,d.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",d.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],d.DPI=96,d.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",d.commaWsp="(?:\\s+,?\\s*|,\\s*)",d.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,d.reNonWord=/[ \n\.,;!\?\-]/,d.fontPaths={},d.iMatrix=[1,0,0,1,0,0],d.svgNS="http://www.w3.org/2000/svg",d.perfLimitSizeTotal=2097152,d.maxCacheSideLimit=4096,d.minCacheSideLimit=256,d.charWidthsCache={},d.textureSize=2048,d.disableStyleCopyPaste=!1,d.enableGLFiltering=!0,d.devicePixelRatio=d.window.devicePixelRatio||d.window.webkitDevicePixelRatio||d.window.mozDevicePixelRatio||1,d.browserShadowBlurConstant=1,d.arcToSegmentsCache={},d.boundsOfCurveCache={},d.cachesBoundsOfCurve=!0,d.forceGLPutImageData=!1,d.initFilterBackend=function(){return d.enableGLFiltering&&d.isWebglSupported&&d.isWebglSupported(d.textureSize)?(console.log("max texture size: "+d.maxTextureSize),new d.WebglFilterBackend({tileSize:d.textureSize})):d.Canvas2dFilterBackend?new d.Canvas2dFilterBackend:void 0},typeof document<"u"&&typeof window<"u"&&(window.fabric=d),function(){function n(r,o){if(this.__eventListeners[r]){var t=this.__eventListeners[r];o?t[t.indexOf(o)]=!1:d.util.array.fill(t,!1)}}function i(r,o){var t=(function(){o.apply(this,arguments),this.off(r,t)}).bind(this);this.on(r,t)}d.Observable={fire:function(r,o){if(!this.__eventListeners)return this;var t=this.__eventListeners[r];if(!t)return this;for(var e=0,s=t.length;e<s;e++)t[e]&&t[e].call(this,o||{});return this.__eventListeners[r]=t.filter(function(l){return l!==!1}),this},on:function(r,o){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var t in r)this.on(t,r[t]);else this.__eventListeners[r]||(this.__eventListeners[r]=[]),this.__eventListeners[r].push(o);return this},once:function(r,o){if(arguments.length===1)for(var t in r)i.call(this,t,r[t]);else i.call(this,r,o);return this},off:function(r,o){if(!this.__eventListeners)return this;if(arguments.length===0)for(r in this.__eventListeners)n.call(this,r);else if(arguments.length===1&&typeof arguments[0]=="object")for(var t in r)n.call(this,t,r[t]);else n.call(this,r,o);return this}}}(),d.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var n=0,i=arguments.length;n<i;n++)this._onObjectAdded(arguments[n]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(n,i,r){var o=this._objects;return r?o[i]=n:o.splice(i,0,n),this._onObjectAdded&&this._onObjectAdded(n),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var n,i=this._objects,r=!1,o=0,t=arguments.length;o<t;o++)(n=i.indexOf(arguments[o]))!==-1&&(r=!0,i.splice(n,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[o]));return this.renderOnAddRemove&&r&&this.requestRenderAll(),this},forEachObject:function(n,i){for(var r=this.getObjects(),o=0,t=r.length;o<t;o++)n.call(i,r[o],o,r);return this},getObjects:function(n){return n===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===n})},item:function(n){return this._objects[n]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(n,i){return this._objects.indexOf(n)>-1||!!i&&this._objects.some(function(r){return typeof r.contains=="function"&&r.contains(n,!0)})},complexity:function(){return this._objects.reduce(function(n,i){return n+(i.complexity?i.complexity():0)},0)}},d.CommonMethods={_setOptions:function(n){for(var i in n)this.set(i,n[i])},_initGradient:function(n,i){!n||!n.colorStops||n instanceof d.Gradient||this.set(i,new d.Gradient(n))},_initPattern:function(n,i,r){!n||!n.source||n instanceof d.Pattern?r&&r():this.set(i,new d.Pattern(n,r))},_setObject:function(n){for(var i in n)this._set(i,n[i])},set:function(n,i){return typeof n=="object"?this._setObject(n):this._set(n,i),this},_set:function(n,i){this[n]=i},toggle:function(n){var i=this.get(n);return typeof i=="boolean"&&this.set(n,!i),this},get:function(n){return this[n]}},m=c,C=Math.sqrt,b=Math.atan2,S=Math.pow,x=Math.PI/180,R=Math.PI/2,d.util={cos:function(n){if(n===0)return 1;switch(n<0&&(n=-n),n/R){case 1:case 3:return 0;case 2:return-1}return Math.cos(n)},sin:function(n){if(n===0)return 0;var i=1;switch(n<0&&(i=-1),n/R){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(n)},removeFromArray:function(n,i){var r=n.indexOf(i);return r!==-1&&n.splice(r,1),n},getRandomInt:function(n,i){return Math.floor(Math.random()*(i-n+1))+n},degreesToRadians:function(n){return n*x},radiansToDegrees:function(n){return n/x},rotatePoint:function(n,i,r){var o=new d.Point(n.x-i.x,n.y-i.y),t=d.util.rotateVector(o,r);return new d.Point(t.x,t.y).addEquals(i)},rotateVector:function(n,i){var r=d.util.sin(i),o=d.util.cos(i);return{x:n.x*o-n.y*r,y:n.x*r+n.y*o}},createVector:function(n,i){return new d.Point(i.x-n.x,i.y-n.y)},calcAngleBetweenVectors:function(n,i){return Math.acos((n.x*i.x+n.y*i.y)/(Math.hypot(n.x,n.y)*Math.hypot(i.x,i.y)))},getHatVector:function(n){return new d.Point(n.x,n.y).multiply(1/Math.hypot(n.x,n.y))},getBisector:function(n,i,r){var o=d.util.createVector(n,i),t=d.util.createVector(n,r),e=d.util.calcAngleBetweenVectors(o,t),s=e*(d.util.calcAngleBetweenVectors(d.util.rotateVector(o,e),t)===0?1:-1)/2;return{vector:d.util.getHatVector(d.util.rotateVector(o,s)),angle:e}},projectStrokeOnPoints:function(n,i,r){var o=[],t=i.strokeWidth/2,e=i.strokeUniform?new d.Point(1/i.scaleX,1/i.scaleY):new d.Point(1,1),s=function(l){var a=t/Math.hypot(l.x,l.y);return new d.Point(l.x*a*e.x,l.y*a*e.y)};return n.length<=1||n.forEach(function(l,a){var h,u,p=new d.Point(l.x,l.y);a===0?(u=n[a+1],h=r?s(d.util.createVector(u,p)).addEquals(p):n[n.length-1]):a===n.length-1?(h=n[a-1],u=r?s(d.util.createVector(h,p)).addEquals(p):n[0]):(h=n[a-1],u=n[a+1]);var _,y,v=d.util.getBisector(p,h,u),w=v.vector,T=v.angle;if(i.strokeLineJoin==="miter"&&(_=-t/Math.sin(T/2),y=new d.Point(w.x*_*e.x,w.y*_*e.y),Math.hypot(y.x,y.y)/t<=i.strokeMiterLimit))return o.push(p.add(y)),void o.push(p.subtract(y));_=-t*Math.SQRT2,y=new d.Point(w.x*_*e.x,w.y*_*e.y),o.push(p.add(y)),o.push(p.subtract(y))}),o},transformPoint:function(n,i,r){return r?new d.Point(i[0]*n.x+i[2]*n.y,i[1]*n.x+i[3]*n.y):new d.Point(i[0]*n.x+i[2]*n.y+i[4],i[1]*n.x+i[3]*n.y+i[5])},makeBoundingBoxFromPoints:function(n,i){if(i)for(var r=0;r<n.length;r++)n[r]=d.util.transformPoint(n[r],i);var o=[n[0].x,n[1].x,n[2].x,n[3].x],t=d.util.array.min(o),e=d.util.array.max(o)-t,s=[n[0].y,n[1].y,n[2].y,n[3].y],l=d.util.array.min(s);return{left:t,top:l,width:e,height:d.util.array.max(s)-l}},invertTransform:function(n){var i=1/(n[0]*n[3]-n[1]*n[2]),r=[i*n[3],-i*n[1],-i*n[2],i*n[0]],o=d.util.transformPoint({x:n[4],y:n[5]},r,!0);return r[4]=-o.x,r[5]=-o.y,r},toFixed:function(n,i){return parseFloat(Number(n).toFixed(i))},parseUnit:function(n,i){var r=/\D{0,2}$/.exec(n),o=parseFloat(n);switch(i||(i=d.Text.DEFAULT_SVG_FONT_SIZE),r[0]){case"mm":return o*d.DPI/25.4;case"cm":return o*d.DPI/2.54;case"in":return o*d.DPI;case"pt":return o*d.DPI/72;case"pc":return o*d.DPI/72*12;case"em":return o*i;default:return o}},falseFunction:function(){return!1},getKlass:function(n,i){return n=d.util.string.camelize(n.charAt(0).toUpperCase()+n.slice(1)),d.util.resolveNamespace(i)[n]},getSvgAttributes:function(n){var i=["instantiated_by_use","style","id","class"];switch(n){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(n){if(!n)return d;var i,r=n.split("."),o=r.length,t=m||d.window;for(i=0;i<o;++i)t=t[r[i]];return t},loadImage:function(n,i,r,o){if(n){var t=d.util.createImage(),e=function(){i&&i.call(r,t,!1),t=t.onload=t.onerror=null};t.onload=e,t.onerror=function(){d.log("Error loading "+t.src),i&&i.call(r,null,!0),t=t.onload=t.onerror=null},n.indexOf("data")!==0&&o!=null&&(t.crossOrigin=o),n.substring(0,14)==="data:image/svg"&&(t.onload=null,d.util.loadImageInDom(t,e)),t.src=n}else i&&i.call(r,n)},loadImageInDom:function(n,i){var r=d.document.createElement("div");r.style.width=r.style.height="1px",r.style.left=r.style.top="-100%",r.style.position="absolute",r.appendChild(n),d.document.querySelector("body").appendChild(r),n.onload=function(){i(),r.parentNode.removeChild(r),r=null}},enlivenObjects:function(n,i,r,o){var t=[],e=0,s=(n=n||[]).length;function l(){++e===s&&i&&i(t.filter(function(a){return a}))}s?n.forEach(function(a,h){a&&a.type?d.util.getKlass(a.type,r).fromObject(a,function(u,p){p||(t[h]=u),o&&o(a,u,p),l()}):l()}):i&&i(t)},enlivenObjectEnlivables:function(n,i,r){var o=d.Object.ENLIVEN_PROPS.filter(function(t){return!!n[t]});d.util.enlivenObjects(o.map(function(t){return n[t]}),function(t){var e={};o.forEach(function(s,l){e[s]=t[l],i&&(i[s]=t[l])}),r&&r(e)})},enlivenPatterns:function(n,i){function r(){++t===e&&i&&i(o)}var o=[],t=0,e=(n=n||[]).length;e?n.forEach(function(s,l){s&&s.source?new d.Pattern(s,function(a){o[l]=a,r()}):(o[l]=s,r())}):i&&i(o)},groupSVGElements:function(n,i,r){var o;return n&&n.length===1?n[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),o=new d.Group(n,i),r!==void 0&&(o.sourcePath=r),o)},populateWithProperties:function(n,i,r){if(r&&Array.isArray(r))for(var o=0,t=r.length;o<t;o++)r[o]in n&&(i[r[o]]=n[r[o]])},createCanvasElement:function(){return d.document.createElement("canvas")},copyCanvasElement:function(n){var i=d.util.createCanvasElement();return i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0),i},toDataURL:function(n,i,r){return n.toDataURL("image/"+i,r)},createImage:function(){return d.document.createElement("img")},multiplyTransformMatrices:function(n,i,r){return[n[0]*i[0]+n[2]*i[1],n[1]*i[0]+n[3]*i[1],n[0]*i[2]+n[2]*i[3],n[1]*i[2]+n[3]*i[3],r?0:n[0]*i[4]+n[2]*i[5]+n[4],r?0:n[1]*i[4]+n[3]*i[5]+n[5]]},qrDecompose:function(n){var i=b(n[1],n[0]),r=S(n[0],2)+S(n[1],2),o=C(r),t=(n[0]*n[3]-n[2]*n[1])/o,e=b(n[0]*n[2]+n[1]*n[3],r);return{angle:i/x,scaleX:o,scaleY:t,skewX:e/x,skewY:0,translateX:n[4],translateY:n[5]}},calcRotateMatrix:function(n){if(!n.angle)return d.iMatrix.concat();var i=d.util.degreesToRadians(n.angle),r=d.util.cos(i),o=d.util.sin(i);return[r,o,-o,r,0,0]},calcDimensionsMatrix:function(n){var i=n.scaleX===void 0?1:n.scaleX,r=n.scaleY===void 0?1:n.scaleY,o=[n.flipX?-i:i,0,0,n.flipY?-r:r,0,0],t=d.util.multiplyTransformMatrices,e=d.util.degreesToRadians;return n.skewX&&(o=t(o,[1,0,Math.tan(e(n.skewX)),1],!0)),n.skewY&&(o=t(o,[1,Math.tan(e(n.skewY)),0,1],!0)),o},composeMatrix:function(n){var i=[1,0,0,1,n.translateX||0,n.translateY||0],r=d.util.multiplyTransformMatrices;return n.angle&&(i=r(i,d.util.calcRotateMatrix(n))),(n.scaleX!==1||n.scaleY!==1||n.skewX||n.skewY||n.flipX||n.flipY)&&(i=r(i,d.util.calcDimensionsMatrix(n))),i},resetObjectTransform:function(n){n.scaleX=1,n.scaleY=1,n.skewX=0,n.skewY=0,n.flipX=!1,n.flipY=!1,n.rotate(0)},saveObjectTransform:function(n){return{scaleX:n.scaleX,scaleY:n.scaleY,skewX:n.skewX,skewY:n.skewY,angle:n.angle,left:n.left,flipX:n.flipX,flipY:n.flipY,top:n.top}},isTransparent:function(n,i,r,o){o>0&&(i>o?i-=o:i=0,r>o?r-=o:r=0);var t,e=!0,s=n.getImageData(i,r,2*o||1,2*o||1),l=s.data.length;for(t=3;t<l&&(e=s.data[t]<=0)!=0;t+=4);return s=null,e},parsePreserveAspectRatioAttribute:function(n){var i,r="meet",o=n.split(" ");return o&&o.length&&((r=o.pop())!=="meet"&&r!=="slice"?(i=r,r="meet"):o.length&&(i=o.pop())),{meetOrSlice:r,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(n){(n=(n||"").toLowerCase())?d.charWidthsCache[n]&&delete d.charWidthsCache[n]:d.charWidthsCache={}},limitDimsByArea:function(n,i){var r=Math.sqrt(i*n),o=Math.floor(i/r);return{x:Math.floor(r),y:o}},capValue:function(n,i,r){return Math.max(n,Math.min(i,r))},findScaleToFit:function(n,i){return Math.min(i.width/n.width,i.height/n.height)},findScaleToCover:function(n,i){return Math.max(i.width/n.width,i.height/n.height)},matrixToSVG:function(n){return"matrix("+n.map(function(i){return d.util.toFixed(i,d.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(n,i){var r=d.util.invertTransform(i),o=d.util.multiplyTransformMatrices(r,n.calcOwnMatrix());d.util.applyTransformToObject(n,o)},addTransformToObject:function(n,i){d.util.applyTransformToObject(n,d.util.multiplyTransformMatrices(i,n.calcOwnMatrix()))},applyTransformToObject:function(n,i){var r=d.util.qrDecompose(i),o=new d.Point(r.translateX,r.translateY);n.flipX=!1,n.flipY=!1,n.set("scaleX",r.scaleX),n.set("scaleY",r.scaleY),n.skewX=r.skewX,n.skewY=r.skewY,n.angle=r.angle,n.setPositionByOrigin(o,"center","center")},sizeAfterTransform:function(n,i,r){var o=n/2,t=i/2,e=[{x:-o,y:-t},{x:o,y:-t},{x:-o,y:t},{x:o,y:t}],s=d.util.calcDimensionsMatrix(r),l=d.util.makeBoundingBoxFromPoints(e,s);return{x:l.width,y:l.height}},mergeClipPaths:function(n,i){var r=n,o=i;r.inverted&&!o.inverted&&(r=i,o=n),d.util.applyTransformToObject(o,d.util.multiplyTransformMatrices(d.util.invertTransform(r.calcTransformMatrix()),o.calcTransformMatrix()));var t=r.inverted&&o.inverted;return t&&(r.inverted=o.inverted=!1),new d.Group([r],{clipPath:o,inverted:t})}},function(){var n=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},r={m:"l",M:"L"};function o(y,v,w,T,P,L,W,N,B,D,A){var k=d.util.cos(y),G=d.util.sin(y),H=d.util.cos(v),M=d.util.sin(v),I=w*P*H-T*L*M+W,F=T*P*H+w*L*M+N;return["C",D+B*(-w*P*G-T*L*k),A+B*(-T*P*G+w*L*k),I+B*(w*P*M+T*L*H),F+B*(T*P*M-w*L*H),I,F]}function t(y,v,w,T){var P=Math.atan2(v,y),L=Math.atan2(T,w);return L>=P?L-P:2*Math.PI-(P-L)}function e(y,v,w){for(var T=w[1],P=w[2],L=w[3],W=w[4],N=w[5],B=function(k,G,H,M,I,F,X){var U=Math.PI,Y=X*U/180,it=d.util.sin(Y),Q=d.util.cos(Y),q=0,et=0,$=-Q*k*.5-it*G*.5,rt=-Q*G*.5+it*k*.5,ot=(H=Math.abs(H))*H,nt=(M=Math.abs(M))*M,ut=rt*rt,ft=$*$,bt=ot*nt-ot*ut-nt*ft,Tt=0;if(bt<0){var Rt=Math.sqrt(1-bt/(ot*nt));H*=Rt,M*=Rt}else Tt=(I===F?-1:1)*Math.sqrt(bt/(ot*ut+nt*ft));var _t=Tt*H*rt/M,St=-Tt*M*$/H,Ft=Q*_t-it*St+.5*k,Mt=it*_t+Q*St+.5*G,Dt=t(1,0,($-_t)/H,(rt-St)/M),Pt=t(($-_t)/H,(rt-St)/M,(-$-_t)/H,(-rt-St)/M);F===0&&Pt>0?Pt-=2*U:F===1&&Pt<0&&(Pt+=2*U);for(var Qt=Math.ceil(Math.abs(Pt/U*2)),Vt=[],Bt=Pt/Qt,_e=8/3*Math.sin(Bt/4)*Math.sin(Bt/4)/Math.sin(Bt/2),Yt=Dt+Bt,jt=0;jt<Qt;jt++)Vt[jt]=o(Dt,Yt,Q,it,H,M,Ft,Mt,_e,q,et),q=Vt[jt][5],et=Vt[jt][6],Dt=Yt,Yt+=Bt;return Vt}(w[6]-y,w[7]-v,T,P,W,N,L),D=0,A=B.length;D<A;D++)B[D][1]+=y,B[D][2]+=v,B[D][3]+=y,B[D][4]+=v,B[D][5]+=y,B[D][6]+=v;return B}function s(y,v,w,T){return Math.sqrt((w-y)*(w-y)+(T-v)*(T-v))}function l(y,v,w,T,P,L,W,N){return function(B){var D,A=(D=B)*D*D,k=function(M){return 3*M*M*(1-M)}(B),G=function(M){return 3*M*(1-M)*(1-M)}(B),H=function(M){return(1-M)*(1-M)*(1-M)}(B);return{x:W*A+P*k+w*G+y*H,y:N*A+L*k+T*G+v*H}}}function a(y,v,w,T,P,L,W,N){return function(B){var D=1-B,A=3*D*D*(w-y)+6*D*B*(P-w)+3*B*B*(W-P),k=3*D*D*(T-v)+6*D*B*(L-T)+3*B*B*(N-L);return Math.atan2(k,A)}}function h(y,v,w,T,P,L){return function(W){var N,B=(N=W)*N,D=function(k){return 2*k*(1-k)}(W),A=function(k){return(1-k)*(1-k)}(W);return{x:P*B+w*D+y*A,y:L*B+T*D+v*A}}}function u(y,v,w,T,P,L){return function(W){var N=1-W,B=2*N*(w-y)+2*W*(P-w),D=2*N*(T-v)+2*W*(L-T);return Math.atan2(D,B)}}function p(y,v,w){var T,P,L={x:v,y:w},W=0;for(P=1;P<=100;P+=1)T=y(P/100),W+=s(L.x,L.y,T.x,T.y),L=T;return W}function _(y){for(var v,w,T,P,L=0,W=y.length,N=0,B=0,D=0,A=0,k=[],G=0;G<W;G++){switch(T={x:N,y:B,command:(v=y[G])[0]},v[0]){case"M":T.length=0,D=N=v[1],A=B=v[2];break;case"L":T.length=s(N,B,v[1],v[2]),N=v[1],B=v[2];break;case"C":w=l(N,B,v[1],v[2],v[3],v[4],v[5],v[6]),P=a(N,B,v[1],v[2],v[3],v[4],v[5],v[6]),T.iterator=w,T.angleFinder=P,T.length=p(w,N,B),N=v[5],B=v[6];break;case"Q":w=h(N,B,v[1],v[2],v[3],v[4]),P=u(N,B,v[1],v[2],v[3],v[4]),T.iterator=w,T.angleFinder=P,T.length=p(w,N,B),N=v[3],B=v[4];break;case"Z":case"z":T.destX=D,T.destY=A,T.length=s(N,B,D,A),N=D,B=A}L+=T.length,k.push(T)}return k.push({length:L,x:N,y:B}),k}d.util.joinPath=function(y){return y.map(function(v){return v.join(" ")}).join(" ")},d.util.parsePath=function(y){var v,w,T,P,L,W=[],N=[],B=d.rePathCommand,D="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",A="("+D+")"+d.commaWsp,k="([01])"+d.commaWsp+"?",G=new RegExp(A+"?"+A+"?"+A+k+k+A+"?("+D+")","g");if(!y||!y.match)return W;for(var H,M=0,I=(L=y.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;M<I;M++){P=(v=L[M]).slice(1).trim(),N.length=0;var F=v.charAt(0);if(H=[F],F.toLowerCase()==="a")for(var X;X=G.exec(P);)for(var U=1;U<X.length;U++)N.push(X[U]);else for(;T=B.exec(P);)N.push(T[0]);U=0;for(var Y=N.length;U<Y;U++)w=parseFloat(N[U]),isNaN(w)||H.push(w);var it=i[F.toLowerCase()],Q=r[F]||F;if(H.length-1>it)for(var q=1,et=H.length;q<et;q+=it)W.push([F].concat(H.slice(q,q+it))),F=Q;else W.push(H)}return W},d.util.makePathSimpler=function(y){var v,w,T,P,L,W,N=0,B=0,D=y.length,A=0,k=0,G=[];for(w=0;w<D;++w){switch(T=!1,(v=y[w].slice(0))[0]){case"l":v[0]="L",v[1]+=N,v[2]+=B;case"L":N=v[1],B=v[2];break;case"h":v[1]+=N;case"H":v[0]="L",v[2]=B,N=v[1];break;case"v":v[1]+=B;case"V":v[0]="L",B=v[1],v[1]=N,v[2]=B;break;case"m":v[0]="M",v[1]+=N,v[2]+=B;case"M":N=v[1],B=v[2],A=v[1],k=v[2];break;case"c":v[0]="C",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B,v[5]+=N,v[6]+=B;case"C":L=v[3],W=v[4],N=v[5],B=v[6];break;case"s":v[0]="S",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B;case"S":P==="C"?(L=2*N-L,W=2*B-W):(L=N,W=B),N=v[3],B=v[4],v[0]="C",v[5]=v[3],v[6]=v[4],v[3]=v[1],v[4]=v[2],v[1]=L,v[2]=W,L=v[3],W=v[4];break;case"q":v[0]="Q",v[1]+=N,v[2]+=B,v[3]+=N,v[4]+=B;case"Q":L=v[1],W=v[2],N=v[3],B=v[4];break;case"t":v[0]="T",v[1]+=N,v[2]+=B;case"T":P==="Q"?(L=2*N-L,W=2*B-W):(L=N,W=B),v[0]="Q",N=v[1],B=v[2],v[1]=L,v[2]=W,v[3]=N,v[4]=B;break;case"a":v[0]="A",v[6]+=N,v[7]+=B;case"A":T=!0,G=G.concat(e(N,B,v)),N=v[6],B=v[7];break;case"z":case"Z":N=A,B=k}T||G.push(v),P=v[0]}return G},d.util.getSmoothPathFromPoints=function(y,v){var w,T=[],P=new d.Point(y[0].x,y[0].y),L=new d.Point(y[1].x,y[1].y),W=y.length,N=1,B=0,D=W>2;for(v=v||0,D&&(N=y[2].x<L.x?-1:y[2].x===L.x?0:1,B=y[2].y<L.y?-1:y[2].y===L.y?0:1),T.push(["M",P.x-N*v,P.y-B*v]),w=1;w<W;w++){if(!P.eq(L)){var A=P.midPointFrom(L);T.push(["Q",P.x,P.y,A.x,A.y])}P=y[w],w+1<y.length&&(L=y[w+1])}return D&&(N=P.x>y[w-2].x?1:P.x===y[w-2].x?0:-1,B=P.y>y[w-2].y?1:P.y===y[w-2].y?0:-1),T.push(["L",P.x+N*v,P.y+B*v]),T},d.util.getPathSegmentsInfo=_,d.util.getBoundsOfCurve=function(y,v,w,T,P,L,W,N){var B;if(d.cachesBoundsOfCurve&&(B=n.call(arguments),d.boundsOfCurveCache[B]))return d.boundsOfCurveCache[B];var D,A,k,G,H,M,I,F,X=Math.sqrt,U=Math.min,Y=Math.max,it=Math.abs,Q=[],q=[[],[]];A=6*y-12*w+6*P,D=-3*y+9*w-9*P+3*W,k=3*w-3*y;for(var et=0;et<2;++et)if(et>0&&(A=6*v-12*T+6*L,D=-3*v+9*T-9*L+3*N,k=3*T-3*v),it(D)<1e-12){if(it(A)<1e-12)continue;0<(G=-k/A)&&G<1&&Q.push(G)}else(I=A*A-4*k*D)<0||(0<(H=(-A+(F=X(I)))/(2*D))&&H<1&&Q.push(H),0<(M=(-A-F)/(2*D))&&M<1&&Q.push(M));for(var $,rt,ot,nt=Q.length,ut=nt;nt--;)$=(ot=1-(G=Q[nt]))*ot*ot*y+3*ot*ot*G*w+3*ot*G*G*P+G*G*G*W,q[0][nt]=$,rt=ot*ot*ot*v+3*ot*ot*G*T+3*ot*G*G*L+G*G*G*N,q[1][nt]=rt;q[0][ut]=y,q[1][ut]=v,q[0][ut+1]=W,q[1][ut+1]=N;var ft=[{x:U.apply(null,q[0]),y:U.apply(null,q[1])},{x:Y.apply(null,q[0]),y:Y.apply(null,q[1])}];return d.cachesBoundsOfCurve&&(d.boundsOfCurveCache[B]=ft),ft},d.util.getPointOnPath=function(y,v,w){w||(w=_(y));for(var T=0;v-w[T].length>0&&T<w.length-2;)v-=w[T].length,T++;var P,L=w[T],W=v/L.length,N=L.command,B=y[T];switch(N){case"M":return{x:L.x,y:L.y,angle:0};case"Z":case"z":return(P=new d.Point(L.x,L.y).lerp(new d.Point(L.destX,L.destY),W)).angle=Math.atan2(L.destY-L.y,L.destX-L.x),P;case"L":return(P=new d.Point(L.x,L.y).lerp(new d.Point(B[1],B[2]),W)).angle=Math.atan2(B[2]-L.y,B[1]-L.x),P;case"C":case"Q":return function(D,A){for(var k,G,H,M=0,I=0,F=D.iterator,X={x:D.x,y:D.y},U=.01,Y=D.angleFinder;I<A&&U>1e-4;)k=F(M),H=M,(G=s(X.x,X.y,k.x,k.y))+I>A?(M-=U,U/=2):(X=k,M+=U,I+=G);return k.angle=Y(H),k}(L,v)}},d.util.transformPath=function(y,v,w){return w&&(v=d.util.multiplyTransformMatrices(v,[1,0,0,1,-w.x,-w.y])),y.map(function(T){for(var P=T.slice(0),L={},W=1;W<T.length-1;W+=2)L.x=T[W],L.y=T[W+1],L=d.util.transformPoint(L,v),P[W]=L.x,P[W+1]=L.y;return P})}}(),function(){var n=Array.prototype.slice;function i(r,o,t){if(r&&r.length!==0){var e=r.length-1,s=o?r[e][o]:r[e];if(o)for(;e--;)t(r[e][o],s)&&(s=r[e][o]);else for(;e--;)t(r[e],s)&&(s=r[e]);return s}}d.util.array={fill:function(r,o){for(var t=r.length;t--;)r[t]=o;return r},invoke:function(r,o){for(var t=n.call(arguments,2),e=[],s=0,l=r.length;s<l;s++)e[s]=t.length?r[s][o].apply(r[s],t):r[s][o].call(r[s]);return e},min:function(r,o){return i(r,o,function(t,e){return t<e})},max:function(r,o){return i(r,o,function(t,e){return t>=e})}}}(),function(){function n(i,r,o){if(o)if(!d.isLikelyNode&&r instanceof Element)i=r;else if(r instanceof Array){i=[];for(var t=0,e=r.length;t<e;t++)i[t]=n({},r[t],o)}else if(r&&typeof r=="object")for(var s in r)s==="canvas"||s==="group"?i[s]=null:r.hasOwnProperty(s)&&(i[s]=n({},r[s],o));else i=r;else for(var s in r)i[s]=r[s];return i}d.util.object={extend:n,clone:function(i,r){return n({},i,r)}},d.util.object.extend(d.util,d.Observable)}(),function(){function n(i,r){var o=i.charCodeAt(r);if(isNaN(o))return"";if(o<55296||o>57343)return i.charAt(r);if(55296<=o&&o<=56319){if(i.length<=r+1)throw"High surrogate without following low surrogate";var t=i.charCodeAt(r+1);if(56320>t||t>57343)throw"High surrogate without following low surrogate";return i.charAt(r)+i.charAt(r+1)}if(r===0)throw"Low surrogate without preceding high surrogate";var e=i.charCodeAt(r-1);if(55296>e||e>56319)throw"Low surrogate without preceding high surrogate";return!1}d.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(r,o){return o?o.toUpperCase():""})},capitalize:function(i,r){return i.charAt(0).toUpperCase()+(r?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var r,o=0,t=[];for(o=0;o<i.length;o++)(r=n(i,o))!==!1&&t.push(r);return t}}}(),function(){var n=Array.prototype.slice,i=function(){},r=function(){for(var s in{toString:1})if(s==="toString")return!1;return!0}(),o=function(s,l,a){for(var h in l)h in s.prototype&&typeof s.prototype[h]=="function"&&(l[h]+"").indexOf("callSuper")>-1?s.prototype[h]=function(u){return function(){var p=this.constructor.superclass;this.constructor.superclass=a;var _=l[u].apply(this,arguments);if(this.constructor.superclass=p,u!=="initialize")return _}}(h):s.prototype[h]=l[h],r&&(l.toString!==Object.prototype.toString&&(s.prototype.toString=l.toString),l.valueOf!==Object.prototype.valueOf&&(s.prototype.valueOf=l.valueOf))};function t(){}function e(s){for(var l=null,a=this;a.constructor.superclass;){var h=a.constructor.superclass.prototype[s];if(a[s]!==h){l=h;break}a=a.constructor.superclass.prototype}return l?arguments.length>1?l.apply(this,n.call(arguments,1)):l.call(this):console.log("tried to callSuper "+s+", method not found in prototype chain",this)}d.util.createClass=function(){var s=null,l=n.call(arguments,0);function a(){this.initialize.apply(this,arguments)}typeof l[0]=="function"&&(s=l.shift()),a.superclass=s,a.subclasses=[],s&&(t.prototype=s.prototype,a.prototype=new t,s.subclasses.push(a));for(var h=0,u=l.length;h<u;h++)o(a,l[h],s);return a.prototype.initialize||(a.prototype.initialize=i),a.prototype.constructor=a,a.prototype.callSuper=e,a}}(),O=!!d.document.createElement("div").attachEvent,E=["touchstart","touchmove","touchend"],d.util.addListener=function(n,i,r,o){n&&n.addEventListener(i,r,!O&&o)},d.util.removeListener=function(n,i,r,o){n&&n.removeEventListener(i,r,!O&&o)},d.util.getPointer=function(n){var i=n.target,r=d.util.getScrollLeftTop(i),o=function(t){var e=t.changedTouches;return e&&e[0]?e[0]:t}(n);return{x:o.clientX+r.left,y:o.clientY+r.top}},d.util.isTouchEvent=function(n){return E.indexOf(n.type)>-1||n.pointerType==="touch"},j=typeof(V=d.document.createElement("div")).style.opacity=="string",tt=typeof V.style.filter=="string",K=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,J=function(n){return n},j?J=function(n,i){return n.style.opacity=i,n}:tt&&(J=function(n,i){var r=n.style;return n.currentStyle&&!n.currentStyle.hasLayout&&(r.zoom=1),K.test(r.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",r.filter=r.filter.replace(K,i)):r.filter+=" alpha(opacity="+100*i+")",n}),d.util.setStyle=function(n,i){var r=n.style;if(!r)return n;if(typeof i=="string")return n.style.cssText+=";"+i,i.indexOf("opacity")>-1?J(n,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):n;for(var o in i)o==="opacity"?J(n,i[o]):r[o==="float"||o==="cssFloat"?r.styleFloat===void 0?"cssFloat":"styleFloat":o]=i[o];return n},function(){var n,i,r,o,t=Array.prototype.slice,e=function(a){return t.call(a,0)};try{n=e(d.document.childNodes)instanceof Array}catch{}function s(a,h){var u=d.document.createElement(a);for(var p in h)p==="class"?u.className=h[p]:p==="for"?u.htmlFor=h[p]:u.setAttribute(p,h[p]);return u}function l(a){for(var h=0,u=0,p=d.document.documentElement,_=d.document.body||{scrollLeft:0,scrollTop:0};a&&(a.parentNode||a.host)&&((a=a.parentNode||a.host)===d.document?(h=_.scrollLeft||p.scrollLeft||0,u=_.scrollTop||p.scrollTop||0):(h+=a.scrollLeft||0,u+=a.scrollTop||0),a.nodeType!==1||a.style.position!=="fixed"););return{left:h,top:u}}n||(e=function(a){for(var h=new Array(a.length),u=a.length;u--;)h[u]=a[u];return h}),i=d.document.defaultView&&d.document.defaultView.getComputedStyle?function(a,h){var u=d.document.defaultView.getComputedStyle(a,null);return u?u[h]:void 0}:function(a,h){var u=a.style[h];return!u&&a.currentStyle&&(u=a.currentStyle[h]),u},r=d.document.documentElement.style,o="userSelect"in r?"userSelect":"MozUserSelect"in r?"MozUserSelect":"WebkitUserSelect"in r?"WebkitUserSelect":"KhtmlUserSelect"in r?"KhtmlUserSelect":"",d.util.makeElementUnselectable=function(a){return a.onselectstart!==void 0&&(a.onselectstart=d.util.falseFunction),o?a.style[o]="none":typeof a.unselectable=="string"&&(a.unselectable="on"),a},d.util.makeElementSelectable=function(a){return a.onselectstart!==void 0&&(a.onselectstart=null),o?a.style[o]="":typeof a.unselectable=="string"&&(a.unselectable=""),a},d.util.setImageSmoothing=function(a,h){a.imageSmoothingEnabled=a.imageSmoothingEnabled||a.webkitImageSmoothingEnabled||a.mozImageSmoothingEnabled||a.msImageSmoothingEnabled||a.oImageSmoothingEnabled,a.imageSmoothingEnabled=h},d.util.getById=function(a){return typeof a=="string"?d.document.getElementById(a):a},d.util.toArray=e,d.util.addClass=function(a,h){a&&(" "+a.className+" ").indexOf(" "+h+" ")===-1&&(a.className+=(a.className?" ":"")+h)},d.util.makeElement=s,d.util.wrapElement=function(a,h,u){return typeof h=="string"&&(h=s(h,u)),a.parentNode&&a.parentNode.replaceChild(h,a),h.appendChild(a),h},d.util.getScrollLeftTop=l,d.util.getElementOffset=function(a){var h,u,p=a&&a.ownerDocument,_={left:0,top:0},y={left:0,top:0},v={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!p)return y;for(var w in v)y[v[w]]+=parseInt(i(a,w),10)||0;return h=p.documentElement,a.getBoundingClientRect!==void 0&&(_=a.getBoundingClientRect()),u=l(a),{left:_.left+u.left-(h.clientLeft||0)+y.left,top:_.top+u.top-(h.clientTop||0)+y.top}},d.util.getNodeCanvas=function(a){var h=d.jsdomImplForWrapper(a);return h._canvas||h._image},d.util.cleanUpJsdomNode=function(a){if(d.isLikelyNode){var h=d.jsdomImplForWrapper(a);h&&(h._image=null,h._canvas=null,h._currentSrc=null,h._attributes=null,h._classList=null)}}}(),function(){function n(){}d.util.request=function(i,r){r||(r={});var o=r.method?r.method.toUpperCase():"GET",t=r.onComplete||function(){},e=new d.window.XMLHttpRequest,s=r.body||r.parameters;return e.onreadystatechange=function(){e.readyState===4&&(t(e),e.onreadystatechange=n)},o==="GET"&&(s=null,typeof r.parameters=="string"&&(i=function(l,a){return l+(/\?/.test(l)?"&":"?")+a}(i,r.parameters))),e.open(o,i,!0),o!=="POST"&&o!=="PUT"||e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(s),e}}(),d.log=console.log,d.warn=console.warn,function(){var n=d.util.object.extend,i=d.util.object.clone,r=[];function o(){return!1}function t(a,h,u,p){return-u*Math.cos(a/p*(Math.PI/2))+u+h}d.util.object.extend(r,{cancelAll:function(){var a=this.splice(0);return a.forEach(function(h){h.cancel()}),a},cancelByCanvas:function(a){if(!a)return[];var h=this.filter(function(u){return typeof u.target=="object"&&u.target.canvas===a});return h.forEach(function(u){u.cancel()}),h},cancelByTarget:function(a){var h=this.findAnimationsByTarget(a);return h.forEach(function(u){u.cancel()}),h},findAnimationIndex:function(a){return this.indexOf(this.findAnimation(a))},findAnimation:function(a){return this.find(function(h){return h.cancel===a})},findAnimationsByTarget:function(a){return a?this.filter(function(h){return h.target===a}):[]}});var e=d.window.requestAnimationFrame||d.window.webkitRequestAnimationFrame||d.window.mozRequestAnimationFrame||d.window.oRequestAnimationFrame||d.window.msRequestAnimationFrame||function(a){return d.window.setTimeout(a,1e3/60)},s=d.window.cancelAnimationFrame||d.window.clearTimeout;function l(){return e.apply(d.window,arguments)}d.util.animate=function(a){a||(a={});var h,u=!1,p=function(){var _=d.runningAnimations.indexOf(h);return _>-1&&d.runningAnimations.splice(_,1)[0]};return h=n(i(a),{cancel:function(){return u=!0,p()},currentValue:"startValue"in a?a.startValue:0,completionRate:0,durationRate:0}),d.runningAnimations.push(h),l(function(_){var y,v=_||+new Date,w=a.duration||500,T=v+w,P=a.onChange||o,L=a.abort||o,W=a.onComplete||o,N=a.easing||t,B="startValue"in a&&a.startValue.length>0,D="startValue"in a?a.startValue:0,A="endValue"in a?a.endValue:100,k=a.byValue||(B?D.map(function(G,H){return A[H]-D[H]}):A-D);a.onStart&&a.onStart(),function G(H){var M=(y=H||+new Date)>T?w:y-v,I=M/w,F=B?D.map(function(U,Y){return N(M,D[Y],k[Y],w)}):N(M,D,k,w),X=Math.abs(B?(F[0]-D[0])/k[0]:(F-D)/k);if(h.currentValue=B?F.slice():F,h.completionRate=X,h.durationRate=I,!u){if(!L(F,X,I))return y>T?(h.currentValue=B?A.slice():A,h.completionRate=1,h.durationRate=1,P(B?A.slice():A,1,1),W(A,1,1),void p()):(P(F,X,I),void l(G));p()}}(v)}),h.cancel},d.util.requestAnimFrame=l,d.util.cancelAnimFrame=function(){return s.apply(d.window,arguments)},d.runningAnimations=r}(),function(){function n(i,r,o){var t="rgba("+parseInt(i[0]+o*(r[0]-i[0]),10)+","+parseInt(i[1]+o*(r[1]-i[1]),10)+","+parseInt(i[2]+o*(r[2]-i[2]),10);return(t+=","+(i&&r?parseFloat(i[3]+o*(r[3]-i[3])):1))+")"}d.util.animateColor=function(i,r,o,t){var e=new d.Color(i).getSource(),s=new d.Color(r).getSource(),l=t.onComplete,a=t.onChange;return t=t||{},d.util.animate(d.util.object.extend(t,{duration:o||500,startValue:e,endValue:s,byValue:s,easing:function(h,u,p,_){return n(u,p,t.colorEasing?t.colorEasing(h,_):1-Math.cos(h/_*(Math.PI/2)))},onComplete:function(h,u,p){if(l)return l(n(s,s,0),u,p)},onChange:function(h,u,p){if(a){if(Array.isArray(h))return a(n(h,h,0),u,p);a(h,u,p)}}}))}}(),function(){function n(t,e,s,l){return t<Math.abs(e)?(t=e,l=s/4):l=e===0&&t===0?s/(2*Math.PI)*Math.asin(1):s/(2*Math.PI)*Math.asin(e/t),{a:t,c:e,p:s,s:l}}function i(t,e,s){return t.a*Math.pow(2,10*(e-=1))*Math.sin((e*s-t.s)*(2*Math.PI)/t.p)}function r(t,e,s,l){return s-o(l-t,0,s,l)+e}function o(t,e,s,l){return(t/=l)<1/2.75?s*(7.5625*t*t)+e:t<2/2.75?s*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?s*(7.5625*(t-=2.25/2.75)*t+.9375)+e:s*(7.5625*(t-=2.625/2.75)*t+.984375)+e}d.util.ease={easeInQuad:function(t,e,s,l){return s*(t/=l)*t+e},easeOutQuad:function(t,e,s,l){return-s*(t/=l)*(t-2)+e},easeInOutQuad:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t+e:-s/2*(--t*(t-2)-1)+e},easeInCubic:function(t,e,s,l){return s*(t/=l)*t*t+e},easeOutCubic:function(t,e,s,l){return s*((t=t/l-1)*t*t+1)+e},easeInOutCubic:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t+e:s/2*((t-=2)*t*t+2)+e},easeInQuart:function(t,e,s,l){return s*(t/=l)*t*t*t+e},easeOutQuart:function(t,e,s,l){return-s*((t=t/l-1)*t*t*t-1)+e},easeInOutQuart:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t*t+e:-s/2*((t-=2)*t*t*t-2)+e},easeInQuint:function(t,e,s,l){return s*(t/=l)*t*t*t*t+e},easeOutQuint:function(t,e,s,l){return s*((t=t/l-1)*t*t*t*t+1)+e},easeInOutQuint:function(t,e,s,l){return(t/=l/2)<1?s/2*t*t*t*t*t+e:s/2*((t-=2)*t*t*t*t+2)+e},easeInSine:function(t,e,s,l){return-s*Math.cos(t/l*(Math.PI/2))+s+e},easeOutSine:function(t,e,s,l){return s*Math.sin(t/l*(Math.PI/2))+e},easeInOutSine:function(t,e,s,l){return-s/2*(Math.cos(Math.PI*t/l)-1)+e},easeInExpo:function(t,e,s,l){return t===0?e:s*Math.pow(2,10*(t/l-1))+e},easeOutExpo:function(t,e,s,l){return t===l?e+s:s*(1-Math.pow(2,-10*t/l))+e},easeInOutExpo:function(t,e,s,l){return t===0?e:t===l?e+s:(t/=l/2)<1?s/2*Math.pow(2,10*(t-1))+e:s/2*(2-Math.pow(2,-10*--t))+e},easeInCirc:function(t,e,s,l){return-s*(Math.sqrt(1-(t/=l)*t)-1)+e},easeOutCirc:function(t,e,s,l){return s*Math.sqrt(1-(t=t/l-1)*t)+e},easeInOutCirc:function(t,e,s,l){return(t/=l/2)<1?-s/2*(Math.sqrt(1-t*t)-1)+e:s/2*(Math.sqrt(1-(t-=2)*t)+1)+e},easeInElastic:function(t,e,s,l){var a=0;return t===0?e:(t/=l)==1?e+s:(a||(a=.3*l),-i(n(s,s,a,1.70158),t,l)+e)},easeOutElastic:function(t,e,s,l){var a=0;if(t===0)return e;if((t/=l)==1)return e+s;a||(a=.3*l);var h=n(s,s,a,1.70158);return h.a*Math.pow(2,-10*t)*Math.sin((t*l-h.s)*(2*Math.PI)/h.p)+h.c+e},easeInOutElastic:function(t,e,s,l){var a=0;if(t===0)return e;if((t/=l/2)==2)return e+s;a||(a=l*(.3*1.5));var h=n(s,s,a,1.70158);return t<1?-.5*i(h,t,l)+e:h.a*Math.pow(2,-10*(t-=1))*Math.sin((t*l-h.s)*(2*Math.PI)/h.p)*.5+h.c+e},easeInBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),s*(t/=l)*t*((a+1)*t-a)+e},easeOutBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),s*((t=t/l-1)*t*((a+1)*t+a)+1)+e},easeInOutBack:function(t,e,s,l,a){return a===void 0&&(a=1.70158),(t/=l/2)<1?s/2*(t*t*((1+(a*=1.525))*t-a))+e:s/2*((t-=2)*t*((1+(a*=1.525))*t+a)+2)+e},easeInBounce:r,easeOutBounce:o,easeInOutBounce:function(t,e,s,l){return t<l/2?.5*r(2*t,0,s,l)+e:.5*o(2*t-l,0,s,l)+.5*s+e}}}(),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t=i.util.toFixed,e=i.util.parseUnit,s=i.util.multiplyTransformMatrices,l={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},a={stroke:"strokeOpacity",fill:"fillOpacity"},h="font-size",u="clip-path";function p(D){return D in l?l[D]:D}function _(D,A,k,G){var H,M=Array.isArray(A);if(D!=="fill"&&D!=="stroke"||A!=="none"){if(D==="strokeUniform")return A==="non-scaling-stroke";if(D==="strokeDashArray")A=A==="none"?null:A.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(D==="transformMatrix")A=k&&k.transformMatrix?s(k.transformMatrix,i.parseTransformAttribute(A)):i.parseTransformAttribute(A);else if(D==="visible")A=A!=="none"&&A!=="hidden",k&&k.visible===!1&&(A=!1);else if(D==="opacity")A=parseFloat(A),k&&k.opacity!==void 0&&(A*=k.opacity);else if(D==="textAnchor")A=A==="start"?"left":A==="end"?"right":"center";else if(D==="charSpacing")H=e(A,G)/G*1e3;else if(D==="paintFirst"){var I=A.indexOf("fill"),F=A.indexOf("stroke");A="fill",(I>-1&&F>-1&&F<I||I===-1&&F>-1)&&(A="stroke")}else{if(D==="href"||D==="xlink:href"||D==="font")return A;if(D==="imageSmoothing")return A==="optimizeQuality";H=M?A.map(e):e(A,G)}}else A="";return!M&&isNaN(H)?A:H}function y(D){return new RegExp("^("+D.join("|")+")\\b","i")}function v(D,A){var k,G,H,M,I=[];for(H=0,M=A.length;H<M;H++)k=A[H],G=D.getElementsByTagName(k),I=I.concat(Array.prototype.slice.call(G));return I}function w(D,A){var k,G=!0;return(k=T(D,A.pop()))&&A.length&&(G=function(H,M){for(var I,F=!0;H.parentNode&&H.parentNode.nodeType===1&&M.length;)F&&(I=M.pop()),F=T(H=H.parentNode,I);return M.length===0}(D,A)),k&&G&&A.length===0}function T(D,A){var k,G,H=D.nodeName,M=D.getAttribute("class"),I=D.getAttribute("id");if(k=new RegExp("^"+H,"i"),A=A.replace(k,""),I&&A.length&&(k=new RegExp("#"+I+"(?![a-zA-Z\\-]+)","i"),A=A.replace(k,"")),M&&A.length)for(G=(M=M.split(" ")).length;G--;)k=new RegExp("\\."+M[G]+"(?![a-zA-Z\\-]+)","i"),A=A.replace(k,"");return A.length===0}function P(D,A){var k;if(D.getElementById&&(k=D.getElementById(A)),k)return k;var G,H,M,I=D.getElementsByTagName("*");for(H=0,M=I.length;H<M;H++)if(A===(G=I[H]).getAttribute("id"))return G}i.svgValidTagNamesRegEx=y(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=y(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=y(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=y(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function D(F,X,U){F[U]=Math.tan(i.util.degreesToRadians(X[0]))}var A=i.iMatrix,k=i.reNum,G=i.commaWsp,H="(?:(?:(matrix)\\s*\\(\\s*("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")"+G+"("+k+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+k+")(?:"+G+"("+k+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+k+")(?:"+G+"("+k+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+k+")(?:"+G+"("+k+")"+G+"("+k+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+k+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+k+")\\s*\\)))",M=new RegExp("^\\s*(?:(?:"+H+"(?:"+G+"*"+H+")*)?)\\s*$"),I=new RegExp(H,"g");return function(F){var X=A.concat(),U=[];if(!F||F&&!M.test(F))return X;F.replace(I,function(it){var Q=new RegExp(H).exec(it).filter(function($){return!!$}),q=Q[1],et=Q.slice(2).map(parseFloat);switch(q){case"translate":(function($,rt){$[4]=rt[0],rt.length===2&&($[5]=rt[1])})(X,et);break;case"rotate":et[0]=i.util.degreesToRadians(et[0]),function($,rt){var ot=i.util.cos(rt[0]),nt=i.util.sin(rt[0]),ut=0,ft=0;rt.length===3&&(ut=rt[1],ft=rt[2]),$[0]=ot,$[1]=nt,$[2]=-nt,$[3]=ot,$[4]=ut-(ot*ut-nt*ft),$[5]=ft-(nt*ut+ot*ft)}(X,et);break;case"scale":(function($,rt){var ot=rt[0],nt=rt.length===2?rt[1]:rt[0];$[0]=ot,$[3]=nt})(X,et);break;case"skewX":D(X,et,2);break;case"skewY":D(X,et,1);break;case"matrix":X=et}U.push(X.concat()),X=A.concat()});for(var Y=U[0];U.length>1;)U.shift(),Y=i.util.multiplyTransformMatrices(Y,U[0]);return Y}}();var L=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function W(D){if(!i.svgViewBoxElementsRegEx.test(D.nodeName))return{};var A,k,G,H,M,I,F=D.getAttribute("viewBox"),X=1,U=1,Y=D.getAttribute("width"),it=D.getAttribute("height"),Q=D.getAttribute("x")||0,q=D.getAttribute("y")||0,et=D.getAttribute("preserveAspectRatio")||"",$=!F||!(F=F.match(L)),rt=!Y||!it||Y==="100%"||it==="100%",ot=$&&rt,nt={},ut="",ft=0,bt=0;if(nt.width=0,nt.height=0,nt.toBeParsed=ot,$&&(Q||q)&&D.parentNode&&D.parentNode.nodeName!=="#document"&&(ut=" translate("+e(Q)+" "+e(q)+") ",M=(D.getAttribute("transform")||"")+ut,D.setAttribute("transform",M),D.removeAttribute("x"),D.removeAttribute("y")),ot)return nt;if($)return nt.width=e(Y),nt.height=e(it),nt;if(A=-parseFloat(F[1]),k=-parseFloat(F[2]),G=parseFloat(F[3]),H=parseFloat(F[4]),nt.minX=A,nt.minY=k,nt.viewBoxWidth=G,nt.viewBoxHeight=H,rt?(nt.width=G,nt.height=H):(nt.width=e(Y),nt.height=e(it),X=nt.width/G,U=nt.height/H),(et=i.util.parsePreserveAspectRatioAttribute(et)).alignX!=="none"&&(et.meetOrSlice==="meet"&&(U=X=X>U?U:X),et.meetOrSlice==="slice"&&(U=X=X>U?X:U),ft=nt.width-G*X,bt=nt.height-H*X,et.alignX==="Mid"&&(ft/=2),et.alignY==="Mid"&&(bt/=2),et.alignX==="Min"&&(ft=0),et.alignY==="Min"&&(bt=0)),X===1&&U===1&&A===0&&k===0&&Q===0&&q===0)return nt;if((Q||q)&&D.parentNode.nodeName!=="#document"&&(ut=" translate("+e(Q)+" "+e(q)+") "),M=ut+" matrix("+X+" 0 0 "+U+" "+(A*X+ft)+" "+(k*U+bt)+") ",D.nodeName==="svg"){for(I=D.ownerDocument.createElementNS(i.svgNS,"g");D.firstChild;)I.appendChild(D.firstChild);D.appendChild(I)}else(I=D).removeAttribute("x"),I.removeAttribute("y"),M=I.getAttribute("transform")+M;return I.setAttribute("transform",M),nt}function N(D,A){var k="xlink:href",G=P(D,A.getAttribute(k).slice(1));if(G&&G.getAttribute(k)&&N(D,G),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(M){G&&!A.hasAttribute(M)&&G.hasAttribute(M)&&A.setAttribute(M,G.getAttribute(M))}),!A.children.length)for(var H=G.cloneNode(!0);H.firstChild;)A.appendChild(H.firstChild);A.removeAttribute(k)}i.parseSVGDocument=function(D,A,k,G){if(D){(function(Q){for(var q=v(Q,["use","svg:use"]),et=0;q.length&&et<q.length;){var $=q[et],rt=$.getAttribute("xlink:href")||$.getAttribute("href");if(rt===null)return;var ot,nt,ut,ft,bt=rt.slice(1),Tt=$.getAttribute("x")||0,Rt=$.getAttribute("y")||0,_t=P(Q,bt).cloneNode(!0),St=(_t.getAttribute("transform")||"")+" translate("+Tt+", "+Rt+")",Ft=q.length,Mt=i.svgNS;if(W(_t),/^svg$/i.test(_t.nodeName)){var Dt=_t.ownerDocument.createElementNS(Mt,"g");for(nt=0,ft=(ut=_t.attributes).length;nt<ft;nt++)ot=ut.item(nt),Dt.setAttributeNS(Mt,ot.nodeName,ot.nodeValue);for(;_t.firstChild;)Dt.appendChild(_t.firstChild);_t=Dt}for(nt=0,ft=(ut=$.attributes).length;nt<ft;nt++)(ot=ut.item(nt)).nodeName!=="x"&&ot.nodeName!=="y"&&ot.nodeName!=="xlink:href"&&ot.nodeName!=="href"&&(ot.nodeName==="transform"?St=ot.nodeValue+" "+St:_t.setAttribute(ot.nodeName,ot.nodeValue));_t.setAttribute("transform",St),_t.setAttribute("instantiated_by_use","1"),_t.removeAttribute("id"),$.parentNode.replaceChild(_t,$),q.length===Ft&&et++}})(D);var H,M,I=i.Object.__uid++,F=W(D),X=i.util.toArray(D.getElementsByTagName("*"));if(F.crossOrigin=G&&G.crossOrigin,F.svgUid=I,X.length===0&&i.isLikelyNode){var U=[];for(H=0,M=(X=D.selectNodes('//*[name(.)!="svg"]')).length;H<M;H++)U[H]=X[H];X=U}var Y=X.filter(function(Q){return W(Q),i.svgValidTagNamesRegEx.test(Q.nodeName.replace("svg:",""))&&!function(q,et){for(;q&&(q=q.parentNode);)if(q.nodeName&&et.test(q.nodeName.replace("svg:",""))&&!q.getAttribute("instantiated_by_use"))return!0;return!1}(Q,i.svgInvalidAncestorsRegEx)});if(!Y||Y&&!Y.length)A&&A([],{});else{var it={};X.filter(function(Q){return Q.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Q){var q=Q.getAttribute("id");it[q]=i.util.toArray(Q.getElementsByTagName("*")).filter(function(et){return i.svgValidTagNamesRegEx.test(et.nodeName.replace("svg:",""))})}),i.gradientDefs[I]=i.getGradientDefs(D),i.cssRules[I]=i.getCSSRules(D),i.clipPaths[I]=it,i.parseElements(Y,function(Q,q){A&&(A(Q,F,q,X),delete i.gradientDefs[I],delete i.cssRules[I],delete i.clipPaths[I])},o(F),k,G)}}};var B=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");r(i,{parseFontDeclaration:function(D,A){var k=D.match(B);if(k){var G=k[1],H=k[3],M=k[4],I=k[5],F=k[6];G&&(A.fontStyle=G),H&&(A.fontWeight=isNaN(parseFloat(H))?H:parseFloat(H)),M&&(A.fontSize=e(M)),F&&(A.fontFamily=F),I&&(A.lineHeight=I==="normal"?1:I)}},getGradientDefs:function(D){var A,k=v(D,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),G=0,H={};for(G=k.length;G--;)(A=k[G]).getAttribute("xlink:href")&&N(D,A),H[A.getAttribute("id")]=A;return H},parseAttributes:function(D,A,k){if(D){var G,H,M,I={};k===void 0&&(k=D.getAttribute("svgUid")),D.parentNode&&i.svgValidParentsRegEx.test(D.parentNode.nodeName)&&(I=i.parseAttributes(D.parentNode,A,k));var F=A.reduce(function(et,$){return(G=D.getAttribute($))&&(et[$]=G),et},{}),X=r(function(et,$){var rt={};for(var ot in i.cssRules[$])if(w(et,ot.split(" ")))for(var nt in i.cssRules[$][ot])rt[nt]=i.cssRules[$][ot][nt];return rt}(D,k),i.parseStyleAttribute(D));F=r(F,X),X[u]&&D.setAttribute(u,X[u]),H=M=I.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,F[h]&&(F[h]=H=e(F[h],M));var U,Y,it={};for(var Q in F)Y=_(U=p(Q),F[Q],I,H),it[U]=Y;it&&it.font&&i.parseFontDeclaration(it.font,it);var q=r(I,it);return i.svgValidParentsRegEx.test(D.nodeName)?q:function(et){for(var $ in a)if(et[a[$]]!==void 0&&et[$]!==""){if(et[$]===void 0){if(!i.Object.prototype[$])continue;et[$]=i.Object.prototype[$]}if(et[$].indexOf("url(")!==0){var rt=new i.Color(et[$]);et[$]=rt.setAlpha(t(rt.getAlpha()*et[a[$]],2)).toRgba()}}return et}(q)}},parseElements:function(D,A,k,G,H){new i.ElementsParser(D,A,k,G,H).parse()},parseStyleAttribute:function(D){var A={},k=D.getAttribute("style");return k&&(typeof k=="string"?function(G,H){var M,I;G.replace(/;\s*$/,"").split(";").forEach(function(F){var X=F.split(":");M=X[0].trim().toLowerCase(),I=X[1].trim(),H[M]=I})}(k,A):function(G,H){var M,I;for(var F in G)G[F]!==void 0&&(M=F.toLowerCase(),I=G[F],H[M]=I)}(k,A)),A},parsePointsAttribute:function(D){if(!D)return null;var A,k,G=[];for(A=0,k=(D=(D=D.replace(/,/g," ").trim()).split(/\s+/)).length;A<k;A+=2)G.push({x:parseFloat(D[A]),y:parseFloat(D[A+1])});return G},getCSSRules:function(D){var A,k,G=D.getElementsByTagName("style"),H={};for(A=0,k=G.length;A<k;A++){var M=G[A].textContent;(M=M.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&M.split("}").filter(function(I){return I.trim()}).forEach(function(I){var F=I.split("{"),X={},U=F[1].trim().split(";").filter(function(q){return q.trim()});for(A=0,k=U.length;A<k;A++){var Y=U[A].split(":"),it=Y[0].trim(),Q=Y[1].trim();X[it]=Q}(I=F[0].trim()).split(",").forEach(function(q){(q=q.replace(/^svg/i,"").trim())!==""&&(H[q]?i.util.object.extend(H[q],X):H[q]=i.util.object.clone(X))})})}return H},loadSVGFromURL:function(D,A,k,G){D=D.replace(/^\n\s*/,"").trim(),new i.util.request(D,{method:"get",onComplete:function(H){var M=H.responseXML;if(!M||!M.documentElement)return A&&A(null),!1;i.parseSVGDocument(M.documentElement,function(I,F,X,U){A&&A(I,F,X,U)},k,G)}})},loadSVGFromString:function(D,A,k,G){var H=new i.window.DOMParser().parseFromString(D.trim(),"text/xml");i.parseSVGDocument(H.documentElement,function(M,I,F,X){A(M,I,F,X)},k,G)}})}(c),d.ElementsParser=function(n,i,r,o,t,e){this.elements=n,this.callback=i,this.options=r,this.reviver=o,this.svgUid=r&&r.svgUid||0,this.parsingOptions=t,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=e},(Z=d.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},Z.createObjects=function(){var n=this;this.elements.forEach(function(i,r){i.setAttribute("svgUid",n.svgUid),n.createObject(i,r)})},Z.findTag=function(n){return d[d.util.string.capitalize(n.tagName.replace("svg:",""))]},Z.createObject=function(n,i){var r=this.findTag(n);if(r&&r.fromElement)try{r.fromElement(n,this.createCallback(i,n),this.options)}catch(o){d.log(o)}else this.checkIfDone()},Z.createCallback=function(n,i){var r=this;return function(o){var t;r.resolveGradient(o,i,"fill"),r.resolveGradient(o,i,"stroke"),o instanceof d.Image&&o._originalElement&&(t=o.parsePreserveAspectRatioAttribute(i)),o._removeTransformMatrix(t),r.resolveClipPath(o,i),r.reviver&&r.reviver(i,o),r.instances[n]=o,r.checkIfDone()}},Z.extractPropertyDefinition=function(n,i,r){var o=n[i],t=this.regexUrl;if(t.test(o)){t.lastIndex=0;var e=t.exec(o)[1];return t.lastIndex=0,d[r][this.svgUid][e]}},Z.resolveGradient=function(n,i,r){var o=this.extractPropertyDefinition(n,r,"gradientDefs");if(o){var t=i.getAttribute(r+"-opacity"),e=d.Gradient.fromElement(o,n,t,this.options);n.set(r,e)}},Z.createClipPathCallback=function(n,i){return function(r){r._removeTransformMatrix(),r.fillRule=r.clipRule,i.push(r)}},Z.resolveClipPath=function(n,i){var r,o,t,e,s=this.extractPropertyDefinition(n,"clipPath","clipPaths");if(s){t=[],o=d.util.invertTransform(n.calcTransformMatrix());for(var l=s[0].parentNode,a=i;a.parentNode&&a.getAttribute("clip-path")!==n.clipPath;)a=a.parentNode;a.parentNode.appendChild(l);for(var h=0;h<s.length;h++)r=s[h],this.findTag(r).fromElement(r,this.createClipPathCallback(n,t),this.options);s=t.length===1?t[0]:new d.Group(t),e=d.util.multiplyTransformMatrices(o,s.calcTransformMatrix()),s.clipPath&&this.resolveClipPath(s,a);var u=d.util.qrDecompose(e);s.flipX=!1,s.flipY=!1,s.set("scaleX",u.scaleX),s.set("scaleY",u.scaleY),s.angle=u.angle,s.skewX=u.skewX,s.skewY=0,s.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),n.clipPath=s}else delete n.clipPath},Z.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(n){return n!=null}),this.callback(this.instances,this.elements))},function(n){var i=n.fabric||(n.fabric={});function r(o,t){this.x=o,this.y=t}i.Point?i.warn("fabric.Point is already defined"):(i.Point=r,r.prototype={type:"point",constructor:r,add:function(o){return new r(this.x+o.x,this.y+o.y)},addEquals:function(o){return this.x+=o.x,this.y+=o.y,this},scalarAdd:function(o){return new r(this.x+o,this.y+o)},scalarAddEquals:function(o){return this.x+=o,this.y+=o,this},subtract:function(o){return new r(this.x-o.x,this.y-o.y)},subtractEquals:function(o){return this.x-=o.x,this.y-=o.y,this},scalarSubtract:function(o){return new r(this.x-o,this.y-o)},scalarSubtractEquals:function(o){return this.x-=o,this.y-=o,this},multiply:function(o){return new r(this.x*o,this.y*o)},multiplyEquals:function(o){return this.x*=o,this.y*=o,this},divide:function(o){return new r(this.x/o,this.y/o)},divideEquals:function(o){return this.x/=o,this.y/=o,this},eq:function(o){return this.x===o.x&&this.y===o.y},lt:function(o){return this.x<o.x&&this.y<o.y},lte:function(o){return this.x<=o.x&&this.y<=o.y},gt:function(o){return this.x>o.x&&this.y>o.y},gte:function(o){return this.x>=o.x&&this.y>=o.y},lerp:function(o,t){return t===void 0&&(t=.5),t=Math.max(Math.min(1,t),0),new r(this.x+(o.x-this.x)*t,this.y+(o.y-this.y)*t)},distanceFrom:function(o){var t=this.x-o.x,e=this.y-o.y;return Math.sqrt(t*t+e*e)},midPointFrom:function(o){return this.lerp(o)},min:function(o){return new r(Math.min(this.x,o.x),Math.min(this.y,o.y))},max:function(o){return new r(Math.max(this.x,o.x),Math.max(this.y,o.y))},toString:function(){return this.x+","+this.y},setXY:function(o,t){return this.x=o,this.y=t,this},setX:function(o){return this.x=o,this},setY:function(o){return this.y=o,this},setFromPoint:function(o){return this.x=o.x,this.y=o.y,this},swap:function(o){var t=this.x,e=this.y;this.x=o.x,this.y=o.y,o.x=t,o.y=e},clone:function(){return new r(this.x,this.y)}})}(c),function(n){var i=n.fabric||(n.fabric={});function r(o){this.status=o,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=r,i.Intersection.prototype={constructor:r,appendPoint:function(o){return this.points.push(o),this},appendPoints:function(o){return this.points=this.points.concat(o),this}},i.Intersection.intersectLineLine=function(o,t,e,s){var l,a=(s.x-e.x)*(o.y-e.y)-(s.y-e.y)*(o.x-e.x),h=(t.x-o.x)*(o.y-e.y)-(t.y-o.y)*(o.x-e.x),u=(s.y-e.y)*(t.x-o.x)-(s.x-e.x)*(t.y-o.y);if(u!==0){var p=a/u,_=h/u;0<=p&&p<=1&&0<=_&&_<=1?(l=new r("Intersection")).appendPoint(new i.Point(o.x+p*(t.x-o.x),o.y+p*(t.y-o.y))):l=new r}else l=new r(a===0||h===0?"Coincident":"Parallel");return l},i.Intersection.intersectLinePolygon=function(o,t,e){var s,l,a,h,u=new r,p=e.length;for(h=0;h<p;h++)s=e[h],l=e[(h+1)%p],a=r.intersectLineLine(o,t,s,l),u.appendPoints(a.points);return u.points.length>0&&(u.status="Intersection"),u},i.Intersection.intersectPolygonPolygon=function(o,t){var e,s=new r,l=o.length;for(e=0;e<l;e++){var a=o[e],h=o[(e+1)%l],u=r.intersectLinePolygon(a,h,t);s.appendPoints(u.points)}return s.points.length>0&&(s.status="Intersection"),s},i.Intersection.intersectPolygonRectangle=function(o,t,e){var s=t.min(e),l=t.max(e),a=new i.Point(l.x,s.y),h=new i.Point(s.x,l.y),u=r.intersectLinePolygon(s,a,o),p=r.intersectLinePolygon(a,l,o),_=r.intersectLinePolygon(l,h,o),y=r.intersectLinePolygon(h,s,o),v=new r;return v.appendPoints(u.points),v.appendPoints(p.points),v.appendPoints(_.points),v.appendPoints(y.points),v.points.length>0&&(v.status="Intersection"),v})}(c),function(n){var i=n.fabric||(n.fabric={});function r(t){t?this._tryParsingColor(t):this.setSource([0,0,0,1])}function o(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}i.Color?i.warn("fabric.Color is already defined."):(i.Color=r,i.Color.prototype={_tryParsingColor:function(t){var e;t in r.colorNameMap&&(t=r.colorNameMap[t]),t==="transparent"&&(e=[255,255,255,0]),e||(e=r.sourceFromHex(t)),e||(e=r.sourceFromRgb(t)),e||(e=r.sourceFromHsl(t)),e||(e=[0,0,0,1]),e&&this.setSource(e)},_rgbToHsl:function(t,e,s){t/=255,e/=255,s/=255;var l,a,h,u=i.util.array.max([t,e,s]),p=i.util.array.min([t,e,s]);if(h=(u+p)/2,u===p)l=a=0;else{var _=u-p;switch(a=h>.5?_/(2-u-p):_/(u+p),u){case t:l=(e-s)/_+(e<s?6:0);break;case e:l=(s-t)/_+2;break;case s:l=(t-e)/_+4}l/=6}return[Math.round(360*l),Math.round(100*a),Math.round(100*h)]},getSource:function(){return this._source},setSource:function(t){this._source=t},toRgb:function(){var t=this.getSource();return"rgb("+t[0]+","+t[1]+","+t[2]+")"},toRgba:function(){var t=this.getSource();return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"},toHsl:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"},toHsla:function(){var t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return"hsla("+e[0]+","+e[1]+"%,"+e[2]+"%,"+t[3]+")"},toHex:function(){var t,e,s,l=this.getSource();return t=(t=l[0].toString(16)).length===1?"0"+t:t,e=(e=l[1].toString(16)).length===1?"0"+e:e,s=(s=l[2].toString(16)).length===1?"0"+s:s,t.toUpperCase()+e.toUpperCase()+s.toUpperCase()},toHexa:function(){var t,e=this.getSource();return t=(t=(t=Math.round(255*e[3])).toString(16)).length===1?"0"+t:t,this.toHex()+t.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(t){var e=this.getSource();return e[3]=t,this.setSource(e),this},toGrayscale:function(){var t=this.getSource(),e=parseInt((.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),10),s=t[3];return this.setSource([e,e,e,s]),this},toBlackWhite:function(t){var e=this.getSource(),s=(.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),l=e[3];return t=t||127,s=Number(s)<Number(t)?0:255,this.setSource([s,s,s,l]),this},overlayWith:function(t){t instanceof r||(t=new r(t));var e,s=[],l=this.getAlpha(),a=this.getSource(),h=t.getSource();for(e=0;e<3;e++)s.push(Math.round(.5*a[e]+.5*h[e]));return s[3]=l,this.setSource(s),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(t){return r.fromSource(r.sourceFromRgb(t))},i.Color.sourceFromRgb=function(t){var e=t.match(r.reRGBa);if(e){var s=parseInt(e[1],10)/(/%$/.test(e[1])?100:1)*(/%$/.test(e[1])?255:1),l=parseInt(e[2],10)/(/%$/.test(e[2])?100:1)*(/%$/.test(e[2])?255:1),a=parseInt(e[3],10)/(/%$/.test(e[3])?100:1)*(/%$/.test(e[3])?255:1);return[parseInt(s,10),parseInt(l,10),parseInt(a,10),e[4]?parseFloat(e[4]):1]}},i.Color.fromRgba=r.fromRgb,i.Color.fromHsl=function(t){return r.fromSource(r.sourceFromHsl(t))},i.Color.sourceFromHsl=function(t){var e=t.match(r.reHSLa);if(e){var s,l,a,h=(parseFloat(e[1])%360+360)%360/360,u=parseFloat(e[2])/(/%$/.test(e[2])?100:1),p=parseFloat(e[3])/(/%$/.test(e[3])?100:1);if(u===0)s=l=a=p;else{var _=p<=.5?p*(u+1):p+u-p*u,y=2*p-_;s=o(y,_,h+1/3),l=o(y,_,h),a=o(y,_,h-1/3)}return[Math.round(255*s),Math.round(255*l),Math.round(255*a),e[4]?parseFloat(e[4]):1]}},i.Color.fromHsla=r.fromHsl,i.Color.fromHex=function(t){return r.fromSource(r.sourceFromHex(t))},i.Color.sourceFromHex=function(t){if(t.match(r.reHex)){var e=t.slice(t.indexOf("#")+1),s=e.length===3||e.length===4,l=e.length===8||e.length===4,a=s?e.charAt(0)+e.charAt(0):e.substring(0,2),h=s?e.charAt(1)+e.charAt(1):e.substring(2,4),u=s?e.charAt(2)+e.charAt(2):e.substring(4,6),p=l?s?e.charAt(3)+e.charAt(3):e.substring(6,8):"FF";return[parseInt(a,16),parseInt(h,16),parseInt(u,16),parseFloat((parseInt(p,16)/255).toFixed(2))]}},i.Color.fromSource=function(t){var e=new r;return e.setSource(t),e})}(c),function(n){var i=n.fabric||(n.fabric={}),r=["e","se","s","sw","w","nw","n","ne","e"],o=["ns","nesw","ew","nwse"],t={},e="left",s="top",l="right",a="bottom",h="center",u={top:a,bottom:s,left:l,right:e,center:h},p=i.util.radiansToDegrees,_=Math.sign||function(M){return(M>0)-(M<0)||+M};function y(M,I){var F=M.angle+p(Math.atan2(I.y,I.x))+360;return Math.round(F%360/45)}function v(M,I){var F=I.transform.target,X=F.canvas,U=i.util.object.clone(I);U.target=F,X&&X.fire("object:"+M,U),F.fire(M,I)}function w(M,I){var F=I.canvas,X=M[F.uniScaleKey];return F.uniformScaling&&!X||!F.uniformScaling&&X}function T(M){return M.originX===h&&M.originY===h}function P(M,I,F){var X=M.lockScalingX,U=M.lockScalingY;return!((!X||!U)&&(I||!X&&!U||!F)&&(!X||I!=="x")&&(!U||I!=="y"))}function L(M,I,F,X){return{e:M,transform:I,pointer:{x:F,y:X}}}function W(M){return function(I,F,X,U){var Y=F.target,it=Y.getCenterPoint(),Q=Y.translateToOriginPoint(it,F.originX,F.originY),q=M(I,F,X,U);return Y.setPositionByOrigin(Q,F.originX,F.originY),q}}function N(M,I){return function(F,X,U,Y){var it=I(F,X,U,Y);return it&&v(M,L(F,X,U,Y)),it}}function B(M,I,F,X,U){var Y=M.target,it=Y.controls[M.corner],Q=Y.canvas.getZoom(),q=Y.padding/Q,et=Y.toLocalPoint(new i.Point(X,U),I,F);return et.x>=q&&(et.x-=q),et.x<=-q&&(et.x+=q),et.y>=q&&(et.y-=q),et.y<=q&&(et.y+=q),et.x-=it.offsetX,et.y-=it.offsetY,et}function D(M){return M.flipX!==M.flipY}function A(M,I,F,X,U){if(M[I]!==0){var Y=U/M._getTransformedDimensions()[X]*M[F];M.set(F,Y)}}function k(M,I,F,X){var U,Y=I.target,it=Y._getTransformedDimensions(0,Y.skewY),Q=B(I,I.originX,I.originY,F,X),q=Math.abs(2*Q.x)-it.x,et=Y.skewX;q<2?U=0:(U=p(Math.atan2(q/Y.scaleX,it.y/Y.scaleY)),I.originX===e&&I.originY===a&&(U=-U),I.originX===l&&I.originY===s&&(U=-U),D(Y)&&(U=-U));var $=et!==U;if($){var rt=Y._getTransformedDimensions().y;Y.set("skewX",U),A(Y,"skewY","scaleY","y",rt)}return $}function G(M,I,F,X){var U,Y=I.target,it=Y._getTransformedDimensions(Y.skewX,0),Q=B(I,I.originX,I.originY,F,X),q=Math.abs(2*Q.y)-it.y,et=Y.skewY;q<2?U=0:(U=p(Math.atan2(q/Y.scaleY,it.x/Y.scaleX)),I.originX===e&&I.originY===a&&(U=-U),I.originX===l&&I.originY===s&&(U=-U),D(Y)&&(U=-U));var $=et!==U;if($){var rt=Y._getTransformedDimensions().x;Y.set("skewY",U),A(Y,"skewX","scaleX","x",rt)}return $}function H(M,I,F,X,U){U=U||{};var Y,it,Q,q,et,$,rt=I.target,ot=rt.lockScalingX,nt=rt.lockScalingY,ut=U.by,ft=w(M,rt),bt=P(rt,ut,ft),Tt=I.gestureScale;if(bt)return!1;if(Tt)it=I.scaleX*Tt,Q=I.scaleY*Tt;else{if(Y=B(I,I.originX,I.originY,F,X),et=ut!=="y"?_(Y.x):1,$=ut!=="x"?_(Y.y):1,I.signX||(I.signX=et),I.signY||(I.signY=$),rt.lockScalingFlip&&(I.signX!==et||I.signY!==$))return!1;if(q=rt._getTransformedDimensions(),ft&&!ut){var Rt=Math.abs(Y.x)+Math.abs(Y.y),_t=I.original,St=Rt/(Math.abs(q.x*_t.scaleX/rt.scaleX)+Math.abs(q.y*_t.scaleY/rt.scaleY));it=_t.scaleX*St,Q=_t.scaleY*St}else it=Math.abs(Y.x*rt.scaleX/q.x),Q=Math.abs(Y.y*rt.scaleY/q.y);T(I)&&(it*=2,Q*=2),I.signX!==et&&ut!=="y"&&(I.originX=u[I.originX],it*=-1,I.signX=et),I.signY!==$&&ut!=="x"&&(I.originY=u[I.originY],Q*=-1,I.signY=$)}var Ft=rt.scaleX,Mt=rt.scaleY;return ut?(ut==="x"&&rt.set("scaleX",it),ut==="y"&&rt.set("scaleY",Q)):(!ot&&rt.set("scaleX",it),!nt&&rt.set("scaleY",Q)),Ft!==rt.scaleX||Mt!==rt.scaleY}t.scaleCursorStyleHandler=function(M,I,F){var X=w(M,F),U="";if(I.x!==0&&I.y===0?U="x":I.x===0&&I.y!==0&&(U="y"),P(F,U,X))return"not-allowed";var Y=y(F,I);return r[Y]+"-resize"},t.skewCursorStyleHandler=function(M,I,F){var X="not-allowed";if(I.x!==0&&F.lockSkewingY||I.y!==0&&F.lockSkewingX)return X;var U=y(F,I)%4;return o[U]+"-resize"},t.scaleSkewCursorStyleHandler=function(M,I,F){return M[F.canvas.altActionKey]?t.skewCursorStyleHandler(M,I,F):t.scaleCursorStyleHandler(M,I,F)},t.rotationWithSnapping=N("rotating",W(function(M,I,F,X){var U=I,Y=U.target,it=Y.translateToOriginPoint(Y.getCenterPoint(),U.originX,U.originY);if(Y.lockRotation)return!1;var Q,q=Math.atan2(U.ey-it.y,U.ex-it.x),et=Math.atan2(X-it.y,F-it.x),$=p(et-q+U.theta);if(Y.snapAngle>0){var rt=Y.snapAngle,ot=Y.snapThreshold||rt,nt=Math.ceil($/rt)*rt,ut=Math.floor($/rt)*rt;Math.abs($-ut)<ot?$=ut:Math.abs($-nt)<ot&&($=nt)}return $<0&&($=360+$),$%=360,Q=Y.angle!==$,Y.angle=$,Q})),t.scalingEqually=N("scaling",W(function(M,I,F,X){return H(M,I,F,X)})),t.scalingX=N("scaling",W(function(M,I,F,X){return H(M,I,F,X,{by:"x"})})),t.scalingY=N("scaling",W(function(M,I,F,X){return H(M,I,F,X,{by:"y"})})),t.scalingYOrSkewingX=function(M,I,F,X){return M[I.target.canvas.altActionKey]?t.skewHandlerX(M,I,F,X):t.scalingY(M,I,F,X)},t.scalingXOrSkewingY=function(M,I,F,X){return M[I.target.canvas.altActionKey]?t.skewHandlerY(M,I,F,X):t.scalingX(M,I,F,X)},t.changeWidth=N("resizing",W(function(M,I,F,X){var U=I.target,Y=B(I,I.originX,I.originY,F,X),it=U.strokeWidth/(U.strokeUniform?U.scaleX:1),Q=T(I)?2:1,q=U.width,et=Math.abs(Y.x*Q/U.scaleX)-it;return U.set("width",Math.max(et,0)),q!==et})),t.skewHandlerX=function(M,I,F,X){var U,Y=I.target,it=Y.skewX,Q=I.originY;return!Y.lockSkewingX&&(it===0?U=B(I,h,h,F,X).x>0?e:l:(it>0&&(U=Q===s?e:l),it<0&&(U=Q===s?l:e),D(Y)&&(U=U===e?l:e)),I.originX=U,N("skewing",W(k))(M,I,F,X))},t.skewHandlerY=function(M,I,F,X){var U,Y=I.target,it=Y.skewY,Q=I.originX;return!Y.lockSkewingY&&(it===0?U=B(I,h,h,F,X).y>0?s:a:(it>0&&(U=Q===e?s:a),it<0&&(U=Q===e?a:s),D(Y)&&(U=U===s?a:s)),I.originY=U,N("skewing",W(G))(M,I,F,X))},t.dragHandler=function(M,I,F,X){var U=I.target,Y=F-I.offsetX,it=X-I.offsetY,Q=!U.get("lockMovementX")&&U.left!==Y,q=!U.get("lockMovementY")&&U.top!==it;return Q&&U.set("left",Y),q&&U.set("top",it),(Q||q)&&v("moving",L(M,I,F,X)),Q||q},t.scaleOrSkewActionName=function(M,I,F){var X=M[F.canvas.altActionKey];return I.x===0?X?"skewX":"scaleY":I.y===0?X?"skewY":"scaleX":void 0},t.rotationStyleHandler=function(M,I,F){return F.lockRotation?"not-allowed":I.cursorStyle},t.fireEvent=v,t.wrapWithFixedAnchor=W,t.wrapWithFireEvent=N,t.getLocalPoint=B,i.controlsUtils=t}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.degreesToRadians,o=i.controlsUtils;o.renderCircleControl=function(t,e,s,l,a){l=l||{};var h,u=this.sizeX||l.cornerSize||a.cornerSize,p=this.sizeY||l.cornerSize||a.cornerSize,_=l.transparentCorners!==void 0?l.transparentCorners:a.transparentCorners,y=_?"stroke":"fill",v=!_&&(l.cornerStrokeColor||a.cornerStrokeColor),w=e,T=s;t.save(),t.fillStyle=l.cornerColor||a.cornerColor,t.strokeStyle=l.cornerStrokeColor||a.cornerStrokeColor,u>p?(h=u,t.scale(1,p/u),T=s*u/p):p>u?(h=p,t.scale(u/p,1),w=e*p/u):h=u,t.lineWidth=1,t.beginPath(),t.arc(w,T,h/2,0,2*Math.PI,!1),t[y](),v&&t.stroke(),t.restore()},o.renderSquareControl=function(t,e,s,l,a){l=l||{};var h=this.sizeX||l.cornerSize||a.cornerSize,u=this.sizeY||l.cornerSize||a.cornerSize,p=l.transparentCorners!==void 0?l.transparentCorners:a.transparentCorners,_=p?"stroke":"fill",y=!p&&(l.cornerStrokeColor||a.cornerStrokeColor),v=h/2,w=u/2;t.save(),t.fillStyle=l.cornerColor||a.cornerColor,t.strokeStyle=l.cornerStrokeColor||a.cornerStrokeColor,t.lineWidth=1,t.translate(e,s),t.rotate(r(a.angle)),t[_+"Rect"](-v,-w,h,u),y&&t.strokeRect(-v,-w,h,u),t.restore()}}(c),function(n){var i=n.fabric||(n.fabric={});i.Control=function(r){for(var o in r)this[o]=r[o]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(r,o){return o.cursorStyle},getActionName:function(r,o){return o.actionName},getVisibility:function(r,o){var t=r._controlsVisibility;return t&&t[o]!==void 0?t[o]:this.visible},setVisibility:function(r){this.visible=r},positionHandler:function(r,o){return i.util.transformPoint({x:this.x*r.x+this.offsetX,y:this.y*r.y+this.offsetY},o)},calcCornerCoords:function(r,o,t,e,s){var l,a,h,u,p=s?this.touchSizeX:this.sizeX,_=s?this.touchSizeY:this.sizeY;if(p&&_&&p!==_){var y=Math.atan2(_,p),v=Math.sqrt(p*p+_*_)/2,w=y-i.util.degreesToRadians(r),T=Math.PI/2-y-i.util.degreesToRadians(r);l=v*i.util.cos(w),a=v*i.util.sin(w),h=v*i.util.cos(T),u=v*i.util.sin(T)}else v=.7071067812*(p&&_?p:o),w=i.util.degreesToRadians(45-r),l=h=v*i.util.cos(w),a=u=v*i.util.sin(w);return{tl:{x:t-u,y:e-h},tr:{x:t+l,y:e-a},bl:{x:t-l,y:e+a},br:{x:t+u,y:e+h}}},render:function(r,o,t,e,s){((e=e||{}).cornerStyle||s.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,r,o,t,e,s):i.controlsUtils.renderSquareControl.call(this,r,o,t,e,s)}}}(c),function(){function n(r,o){var t,e,s,l,a=r.getAttribute("style"),h=r.getAttribute("offset")||0;if(h=(h=parseFloat(h)/(/%$/.test(h)?100:1))<0?0:h>1?1:h,a){var u=a.split(/\s*;\s*/);for(u[u.length-1]===""&&u.pop(),l=u.length;l--;){var p=u[l].split(/\s*:\s*/),_=p[0].trim(),y=p[1].trim();_==="stop-color"?t=y:_==="stop-opacity"&&(s=y)}}return t||(t=r.getAttribute("stop-color")||"rgb(0,0,0)"),s||(s=r.getAttribute("stop-opacity")),e=(t=new d.Color(t)).getAlpha(),s=isNaN(parseFloat(s))?1:parseFloat(s),s*=e*o,{offset:h,color:t.toRgb(),opacity:s}}var i=d.util.object.clone;d.Gradient=d.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(r){r||(r={}),r.coords||(r.coords={});var o,t=this;Object.keys(r).forEach(function(e){t[e]=r[e]}),this.id?this.id+="_"+d.Object.__uid++:this.id=d.Object.__uid++,o={x1:r.coords.x1||0,y1:r.coords.y1||0,x2:r.coords.x2||0,y2:r.coords.y2||0},this.type==="radial"&&(o.r1=r.coords.r1||0,o.r2=r.coords.r2||0),this.coords=o,this.colorStops=r.colorStops.slice()},addColorStop:function(r){for(var o in r){var t=new d.Color(r[o]);this.colorStops.push({offset:parseFloat(o),color:t.toRgb(),opacity:t.getAlpha()})}return this},toObject:function(r){var o={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return d.util.populateWithProperties(this,o,r),o},toSVG:function(r,o){var t,e,s,l,a=i(this.coords,!0),h=(o=o||{},i(this.colorStops,!0)),u=a.r1>a.r2,p=this.gradientTransform?this.gradientTransform.concat():d.iMatrix.concat(),_=-this.offsetX,y=-this.offsetY,v=!!o.additionalTransform,w=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(h.sort(function(W,N){return W.offset-N.offset}),w==="objectBoundingBox"?(_/=r.width,y/=r.height):(_+=r.width/2,y+=r.height/2),r.type==="path"&&this.gradientUnits!=="percentage"&&(_-=r.pathOffset.x,y-=r.pathOffset.y),p[4]-=_,p[5]-=y,l='id="SVGID_'+this.id+'" gradientUnits="'+w+'"',l+=' gradientTransform="'+(v?o.additionalTransform+" ":"")+d.util.matrixToSVG(p)+'" ',this.type==="linear"?s=["<linearGradient ",l,' x1="',a.x1,'" y1="',a.y1,'" x2="',a.x2,'" y2="',a.y2,`">
`]:this.type==="radial"&&(s=["<radialGradient ",l,' cx="',u?a.x1:a.x2,'" cy="',u?a.y1:a.y2,'" r="',u?a.r1:a.r2,'" fx="',u?a.x2:a.x1,'" fy="',u?a.y2:a.y1,`">
`]),this.type==="radial"){if(u)for((h=h.concat()).reverse(),t=0,e=h.length;t<e;t++)h[t].offset=1-h[t].offset;var T=Math.min(a.r1,a.r2);if(T>0){var P=T/Math.max(a.r1,a.r2);for(t=0,e=h.length;t<e;t++)h[t].offset+=P*(1-h[t].offset)}}for(t=0,e=h.length;t<e;t++){var L=h[t];s.push("<stop ",'offset="',100*L.offset+"%",'" style="stop-color:',L.color,L.opacity!==void 0?";stop-opacity: "+L.opacity:";",`"/>
`)}return s.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),s.join("")},toLive:function(r){var o,t,e,s=d.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?o=r.createLinearGradient(s.x1,s.y1,s.x2,s.y2):this.type==="radial"&&(o=r.createRadialGradient(s.x1,s.y1,s.r1,s.x2,s.y2,s.r2)),t=0,e=this.colorStops.length;t<e;t++){var l=this.colorStops[t].color,a=this.colorStops[t].opacity,h=this.colorStops[t].offset;a!==void 0&&(l=new d.Color(l).setAlpha(a).toRgba()),o.addColorStop(h,l)}return o}}}),d.util.object.extend(d.Gradient,{fromElement:function(r,o,t,e){var s=parseFloat(t)/(/%$/.test(t)?100:1);s=s<0?0:s>1?1:s,isNaN(s)&&(s=1);var l,a,h,u,p=r.getElementsByTagName("stop"),_=r.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",y=r.getAttribute("gradientTransform")||"",v=[],w=0,T=0;for(r.nodeName==="linearGradient"||r.nodeName==="LINEARGRADIENT"?(l="linear",a=function(P){return{x1:P.getAttribute("x1")||0,y1:P.getAttribute("y1")||0,x2:P.getAttribute("x2")||"100%",y2:P.getAttribute("y2")||0}}(r)):(l="radial",a=function(P){return{x1:P.getAttribute("fx")||P.getAttribute("cx")||"50%",y1:P.getAttribute("fy")||P.getAttribute("cy")||"50%",r1:0,x2:P.getAttribute("cx")||"50%",y2:P.getAttribute("cy")||"50%",r2:P.getAttribute("r")||"50%"}}(r)),h=p.length;h--;)v.push(n(p[h],s));return u=d.parseTransformAttribute(y),function(P,L,W,N){var B,D;Object.keys(L).forEach(function(A){(B=L[A])==="Infinity"?D=1:B==="-Infinity"?D=0:(D=parseFloat(L[A],10),typeof B=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(B)&&(D*=.01,N==="pixels"&&(A!=="x1"&&A!=="x2"&&A!=="r2"||(D*=W.viewBoxWidth||W.width),A!=="y1"&&A!=="y2"||(D*=W.viewBoxHeight||W.height)))),L[A]=D})}(0,a,e,_),_==="pixels"&&(w=-o.left,T=-o.top),new d.Gradient({id:r.getAttribute("id"),type:l,coords:a,colorStops:v,gradientUnits:_,gradientTransform:u,offsetX:w,offsetY:T})}})}(),ht=d.util.toFixed,d.Pattern=d.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(n,i){if(n||(n={}),this.id=d.Object.__uid++,this.setOptions(n),!n.source||n.source&&typeof n.source!="string")i&&i(this);else{var r=this;this.source=d.util.createImage(),d.util.loadImage(n.source,function(o,t){r.source=o,i&&i(r,t)},null,this.crossOrigin)}},toObject:function(n){var i,r,o=d.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),r={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:ht(this.offsetX,o),offsetY:ht(this.offsetY,o),patternTransform:this.patternTransform?this.patternTransform.concat():null},d.util.populateWithProperties(this,r,n),r},toSVG:function(n){var i=typeof this.source=="function"?this.source():this.source,r=i.width/n.width,o=i.height/n.height,t=this.offsetX/n.width,e=this.offsetY/n.height,s="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(o=1,e&&(o+=Math.abs(e))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(r=1,t&&(r+=Math.abs(t))),i.src?s=i.src:i.toDataURL&&(s=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+t+'" y="'+e+'" width="'+r+'" height="'+o+`">
<image x="0" y="0" width="`+i.width+'" height="'+i.height+'" xlink:href="'+s+`"></image>
</pattern>
`},setOptions:function(n){for(var i in n)this[i]=n[i]},toLive:function(n){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":n.createPattern(i,this.repeat)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(o){for(var t in typeof o=="string"&&(o=this._parseShadow(o)),o)this[t]=o[t];this.id=i.Object.__uid++},_parseShadow:function(o){var t=o.trim(),e=i.Shadow.reOffsetsAndBlur.exec(t)||[];return{color:(t.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(e[1],10)||0,offsetY:parseFloat(e[2],10)||0,blur:parseFloat(e[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(o){var t=40,e=40,s=i.Object.NUM_FRACTION_DIGITS,l=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-o.angle)),a=new i.Color(this.color);return o.width&&o.height&&(t=100*r((Math.abs(l.x)+this.blur)/o.width,s)+20,e=100*r((Math.abs(l.y)+this.blur)/o.height,s)+20),o.flipX&&(l.x*=-1),o.flipY&&(l.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+e+'%" height="'+(100+2*e)+'%" x="-'+t+'%" width="'+(100+2*t)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+r(this.blur?this.blur/2:0,s)+`"></feGaussianBlur>
	<feOffset dx="`+r(l.x,s)+'" dy="'+r(l.y,s)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+a.toRgb()+'" flood-opacity="'+a.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var o={},t=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(e){this[e]!==t[e]&&(o[e]=this[e])},this),o}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(c),function(){if(d.StaticCanvas)d.warn("fabric.StaticCanvas is already defined.");else{var n=d.util.object.extend,i=d.util.getElementOffset,r=d.util.removeFromArray,o=d.util.toFixed,t=d.util.transformPoint,e=d.util.invertTransform,s=d.util.getNodeCanvas,l=d.util.createCanvasElement,a=new Error("Could not initialize `canvas` element");d.StaticCanvas=d.util.createClass(d.CommonMethods,{initialize:function(h,u){u||(u={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(h,u)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:d.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(h,u){var p=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(h),this._initOptions(u),this.interactive||this._initRetinaScaling(),u.overlayImage&&this.setOverlayImage(u.overlayImage,p),u.backgroundImage&&this.setBackgroundImage(u.backgroundImage,p),u.backgroundColor&&this.setBackgroundColor(u.backgroundColor,p),u.overlayColor&&this.setOverlayColor(u.overlayColor,p),this.calcOffset()},_isRetinaScaling:function(){return d.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,d.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var h=d.devicePixelRatio;this.__initRetinaScaling(h,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(h,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(h,u,p){u.setAttribute("width",this.width*h),u.setAttribute("height",this.height*h),p.scale(h,h)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(h,u,p){return this.__setBgOverlayImage("overlayImage",h,u,p)},setBackgroundImage:function(h,u,p){return this.__setBgOverlayImage("backgroundImage",h,u,p)},setOverlayColor:function(h,u){return this.__setBgOverlayColor("overlayColor",h,u)},setBackgroundColor:function(h,u){return this.__setBgOverlayColor("backgroundColor",h,u)},__setBgOverlayImage:function(h,u,p,_){return typeof u=="string"?d.util.loadImage(u,function(y,v){if(y){var w=new d.Image(y,_);this[h]=w,w.canvas=this}p&&p(y,v)},this,_&&_.crossOrigin):(_&&u.setOptions(_),this[h]=u,u&&(u.canvas=this),p&&p(u,!1)),this},__setBgOverlayColor:function(h,u,p){return this[h]=u,this._initGradient(u,h),this._initPattern(u,h,p),this},_createCanvasElement:function(){var h=l();if(!h||(h.style||(h.style={}),h.getContext===void 0))throw a;return h},_initOptions:function(h){var u=this.lowerCanvasEl;this._setOptions(h),this.width=this.width||parseInt(u.width,10)||0,this.height=this.height||parseInt(u.height,10)||0,this.lowerCanvasEl.style&&(u.width=this.width,u.height=this.height,u.style.width=this.width+"px",u.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(h){h&&h.getContext?this.lowerCanvasEl=h:this.lowerCanvasEl=d.util.getById(h)||this._createCanvasElement(),d.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(h,u){return this.setDimensions({width:h},u)},setHeight:function(h,u){return this.setDimensions({height:h},u)},setDimensions:function(h,u){var p;for(var _ in u=u||{},h)p=h[_],u.cssOnly||(this._setBackstoreDimension(_,h[_]),p+="px",this.hasLostContext=!0),u.backstoreOnly||this._setCssDimension(_,p);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),u.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(h,u){return this.lowerCanvasEl[h]=u,this.upperCanvasEl&&(this.upperCanvasEl[h]=u),this.cacheCanvasEl&&(this.cacheCanvasEl[h]=u),this[h]=u,this},_setCssDimension:function(h,u){return this.lowerCanvasEl.style[h]=u,this.upperCanvasEl&&(this.upperCanvasEl.style[h]=u),this.wrapperEl&&(this.wrapperEl.style[h]=u),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(h){var u,p,_,y=this._activeObject,v=this.backgroundImage,w=this.overlayImage;for(this.viewportTransform=h,p=0,_=this._objects.length;p<_;p++)(u=this._objects[p]).group||u.setCoords(!0);return y&&y.setCoords(),v&&v.setCoords(!0),w&&w.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(h,u){var p=h,_=this.viewportTransform.slice(0);h=t(h,e(this.viewportTransform)),_[0]=u,_[3]=u;var y=t(h,_);return _[4]+=p.x-y.x,_[5]+=p.y-y.y,this.setViewportTransform(_)},setZoom:function(h){return this.zoomToPoint(new d.Point(0,0),h),this},absolutePan:function(h){var u=this.viewportTransform.slice(0);return u[4]=-h.x,u[5]=-h.y,this.setViewportTransform(u)},relativePan:function(h){return this.absolutePan(new d.Point(-h.x-this.viewportTransform[4],-h.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(h){this.stateful&&h.setupState(),h._set("canvas",this),h.setCoords(),this.fire("object:added",{target:h}),h.fire("added")},_onObjectRemoved:function(h){this.fire("object:removed",{target:h}),h.fire("removed"),delete h.canvas},clearContext:function(h){return h.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var h=this.contextContainer;return this.renderCanvas(h,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=d.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var h={},u=this.width,p=this.height,_=e(this.viewportTransform);return h.tl=t({x:0,y:0},_),h.br=t({x:u,y:p},_),h.tr=new d.Point(h.br.x,h.tl.y),h.bl=new d.Point(h.tl.x,h.br.y),this.vptCoords=h,h},cancelRequestedRender:function(){this.isRendering&&(d.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(h,u){var p=this.viewportTransform,_=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(h),d.util.setImageSmoothing(h,this.imageSmoothingEnabled),this.fire("before:render",{ctx:h}),this._renderBackground(h),h.save(),h.transform(p[0],p[1],p[2],p[3],p[4],p[5]),this._renderObjects(h,u),h.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(h),_&&(_.canvas=this,_.shouldCache(),_._transformDone=!0,_.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(h)),this._renderOverlay(h),this.controlsAboveOverlay&&this.interactive&&this.drawControls(h),this.fire("after:render",{ctx:h})},drawClipPathOnCanvas:function(h){var u=this.viewportTransform,p=this.clipPath;h.save(),h.transform(u[0],u[1],u[2],u[3],u[4],u[5]),h.globalCompositeOperation="destination-in",p.transform(h),h.scale(1/p.zoomX,1/p.zoomY),h.drawImage(p._cacheCanvas,-p.cacheTranslationX,-p.cacheTranslationY),h.restore()},_renderObjects:function(h,u){var p,_;for(p=0,_=u.length;p<_;++p)u[p]&&u[p].render(h)},_renderBackgroundOrOverlay:function(h,u){var p=this[u+"Color"],_=this[u+"Image"],y=this.viewportTransform,v=this[u+"Vpt"];if(p||_){if(p){h.save(),h.beginPath(),h.moveTo(0,0),h.lineTo(this.width,0),h.lineTo(this.width,this.height),h.lineTo(0,this.height),h.closePath(),h.fillStyle=p.toLive?p.toLive(h,this):p,v&&h.transform(y[0],y[1],y[2],y[3],y[4],y[5]),h.transform(1,0,0,1,p.offsetX||0,p.offsetY||0);var w=p.gradientTransform||p.patternTransform;w&&h.transform(w[0],w[1],w[2],w[3],w[4],w[5]),h.fill(),h.restore()}_&&(h.save(),v&&h.transform(y[0],y[1],y[2],y[3],y[4],y[5]),_.render(h),h.restore())}},_renderBackground:function(h){this._renderBackgroundOrOverlay(h,"background")},_renderOverlay:function(h){this._renderBackgroundOrOverlay(h,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new d.Point(this.width/2,this.height/2)},centerObjectH:function(h){return this._centerObject(h,new d.Point(this.getCenterPoint().x,h.getCenterPoint().y))},centerObjectV:function(h){return this._centerObject(h,new d.Point(h.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(h){var u=this.getCenterPoint();return this._centerObject(h,u)},viewportCenterObject:function(h){var u=this.getVpCenter();return this._centerObject(h,u)},viewportCenterObjectH:function(h){var u=this.getVpCenter();return this._centerObject(h,new d.Point(u.x,h.getCenterPoint().y)),this},viewportCenterObjectV:function(h){var u=this.getVpCenter();return this._centerObject(h,new d.Point(h.getCenterPoint().x,u.y))},getVpCenter:function(){var h=this.getCenterPoint(),u=e(this.viewportTransform);return t(h,u)},_centerObject:function(h,u){return h.setPositionByOrigin(u,"center","center"),h.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(h){return this.toDatalessObject(h)},toObject:function(h){return this._toObjectMethod("toObject",h)},toDatalessObject:function(h){return this._toObjectMethod("toDatalessObject",h)},_toObjectMethod:function(h,u){var p=this.clipPath,_={version:d.version,objects:this._toObjects(h,u)};return p&&!p.excludeFromExport&&(_.clipPath=this._toObject(this.clipPath,h,u)),n(_,this.__serializeBgOverlay(h,u)),d.util.populateWithProperties(this,_,u),_},_toObjects:function(h,u){return this._objects.filter(function(p){return!p.excludeFromExport}).map(function(p){return this._toObject(p,h,u)},this)},_toObject:function(h,u,p){var _;this.includeDefaultValues||(_=h.includeDefaultValues,h.includeDefaultValues=!1);var y=h[u](p);return this.includeDefaultValues||(h.includeDefaultValues=_),y},__serializeBgOverlay:function(h,u){var p={},_=this.backgroundImage,y=this.overlayImage,v=this.backgroundColor,w=this.overlayColor;return v&&v.toObject?v.excludeFromExport||(p.background=v.toObject(u)):v&&(p.background=v),w&&w.toObject?w.excludeFromExport||(p.overlay=w.toObject(u)):w&&(p.overlay=w),_&&!_.excludeFromExport&&(p.backgroundImage=this._toObject(_,h,u)),y&&!y.excludeFromExport&&(p.overlayImage=this._toObject(y,h,u)),p},svgViewportTransformation:!0,toSVG:function(h,u){h||(h={}),h.reviver=u;var p=[];return this._setSVGPreamble(p,h),this._setSVGHeader(p,h),this.clipPath&&p.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(p,"background"),this._setSVGBgOverlayImage(p,"backgroundImage",u),this._setSVGObjects(p,u),this.clipPath&&p.push(`</g>
`),this._setSVGBgOverlayColor(p,"overlay"),this._setSVGBgOverlayImage(p,"overlayImage",u),p.push("</svg>"),p.join("")},_setSVGPreamble:function(h,u){u.suppressPreamble||h.push('<?xml version="1.0" encoding="',u.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(h,u){var p,_=u.width||this.width,y=u.height||this.height,v='viewBox="0 0 '+this.width+" "+this.height+'" ',w=d.Object.NUM_FRACTION_DIGITS;u.viewBox?v='viewBox="'+u.viewBox.x+" "+u.viewBox.y+" "+u.viewBox.width+" "+u.viewBox.height+'" ':this.svgViewportTransformation&&(p=this.viewportTransform,v='viewBox="'+o(-p[4]/p[0],w)+" "+o(-p[5]/p[3],w)+" "+o(this.width/p[0],w)+" "+o(this.height/p[3],w)+'" '),h.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',_,'" ','height="',y,'" ',v,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",d.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(u),`</defs>
`)},createSVGClipPathMarkup:function(h){var u=this.clipPath;return u?(u.clipPathId="CLIPPATH_"+d.Object.__uid++,'<clipPath id="'+u.clipPathId+`" >
`+this.clipPath.toClipPathSVG(h.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var h=this;return["background","overlay"].map(function(u){var p=h[u+"Color"];if(p&&p.toLive){var _=h[u+"Vpt"],y=h.viewportTransform,v={width:h.width/(_?y[0]:1),height:h.height/(_?y[3]:1)};return p.toSVG(v,{additionalTransform:_?d.util.matrixToSVG(y):""})}}).join("")},createSVGFontFacesMarkup:function(){var h,u,p,_,y,v,w,T,P="",L={},W=d.fontPaths,N=[];for(this._objects.forEach(function D(A){N.push(A),A._objects&&A._objects.forEach(D)}),w=0,T=N.length;w<T;w++)if(u=(h=N[w]).fontFamily,h.type.indexOf("text")!==-1&&!L[u]&&W[u]&&(L[u]=!0,h.styles))for(y in p=h.styles)for(v in _=p[y])!L[u=_[v].fontFamily]&&W[u]&&(L[u]=!0);for(var B in L)P+=[`		@font-face {
`,"			font-family: '",B,`';
`,"			src: url('",W[B],`');
`,`		}
`].join("");return P&&(P=['	<style type="text/css">',`<![CDATA[
`,P,"]]>",`</style>
`].join("")),P},_setSVGObjects:function(h,u){var p,_,y,v=this._objects;for(_=0,y=v.length;_<y;_++)(p=v[_]).excludeFromExport||this._setSVGObject(h,p,u)},_setSVGObject:function(h,u,p){h.push(u.toSVG(p))},_setSVGBgOverlayImage:function(h,u,p){this[u]&&!this[u].excludeFromExport&&this[u].toSVG&&h.push(this[u].toSVG(p))},_setSVGBgOverlayColor:function(h,u){var p=this[u+"Color"],_=this.viewportTransform,y=this.width,v=this.height;if(p)if(p.toLive){var w=p.repeat,T=d.util.invertTransform(_),P=this[u+"Vpt"]?d.util.matrixToSVG(T):"";h.push('<rect transform="'+P+" translate(",y/2,",",v/2,')"',' x="',p.offsetX-y/2,'" y="',p.offsetY-v/2,'" ','width="',w==="repeat-y"||w==="no-repeat"?p.source.width:y,'" height="',w==="repeat-x"||w==="no-repeat"?p.source.height:v,'" fill="url(#SVGID_'+p.id+')"',`></rect>
`)}else h.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',p,'"',`></rect>
`)},sendToBack:function(h){if(!h)return this;var u,p,_,y=this._activeObject;if(h===y&&h.type==="activeSelection")for(u=(_=y._objects).length;u--;)p=_[u],r(this._objects,p),this._objects.unshift(p);else r(this._objects,h),this._objects.unshift(h);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(h){if(!h)return this;var u,p,_,y=this._activeObject;if(h===y&&h.type==="activeSelection")for(_=y._objects,u=0;u<_.length;u++)p=_[u],r(this._objects,p),this._objects.push(p);else r(this._objects,h),this._objects.push(h);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(h,u){if(!h)return this;var p,_,y,v,w,T=this._activeObject,P=0;if(h===T&&h.type==="activeSelection")for(w=T._objects,p=0;p<w.length;p++)_=w[p],(y=this._objects.indexOf(_))>0+P&&(v=y-1,r(this._objects,_),this._objects.splice(v,0,_)),P++;else(y=this._objects.indexOf(h))!==0&&(v=this._findNewLowerIndex(h,y,u),r(this._objects,h),this._objects.splice(v,0,h));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(h,u,p){var _,y;if(p){for(_=u,y=u-1;y>=0;--y)if(h.intersectsWithObject(this._objects[y])||h.isContainedWithinObject(this._objects[y])||this._objects[y].isContainedWithinObject(h)){_=y;break}}else _=u-1;return _},bringForward:function(h,u){if(!h)return this;var p,_,y,v,w,T=this._activeObject,P=0;if(h===T&&h.type==="activeSelection")for(p=(w=T._objects).length;p--;)_=w[p],(y=this._objects.indexOf(_))<this._objects.length-1-P&&(v=y+1,r(this._objects,_),this._objects.splice(v,0,_)),P++;else(y=this._objects.indexOf(h))!==this._objects.length-1&&(v=this._findNewUpperIndex(h,y,u),r(this._objects,h),this._objects.splice(v,0,h));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(h,u,p){var _,y,v;if(p){for(_=u,y=u+1,v=this._objects.length;y<v;++y)if(h.intersectsWithObject(this._objects[y])||h.isContainedWithinObject(this._objects[y])||this._objects[y].isContainedWithinObject(h)){_=y;break}}else _=u+1;return _},moveTo:function(h,u){return r(this._objects,h),this._objects.splice(u,0,h),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(d.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(h){h.dispose&&h.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),d.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),d.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),n(d.StaticCanvas.prototype,d.Observable),n(d.StaticCanvas.prototype,d.Collection),n(d.StaticCanvas.prototype,d.DataURLExporter),n(d.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(h){var u=l();if(!u||!u.getContext)return null;var p=u.getContext("2d");return p&&h==="setLineDash"?p.setLineDash!==void 0:null}}),d.StaticCanvas.prototype.toJSON=d.StaticCanvas.prototype.toObject,d.isLikelyNode&&(d.StaticCanvas.prototype.createPNGStream=function(){var h=s(this.lowerCanvasEl);return h&&h.createPNGStream()},d.StaticCanvas.prototype.createJPEGStream=function(h){var u=s(this.lowerCanvasEl);return u&&u.createJPEGStream(h)})}}(),d.BaseBrush=d.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(n){n.strokeStyle=this.color,n.lineWidth=this.width,n.lineCap=this.strokeLineCap,n.miterLimit=this.strokeMiterLimit,n.lineJoin=this.strokeLineJoin,n.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(n){var i=this.canvas.viewportTransform;n.save(),n.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var n=this.canvas,i=this.shadow,r=n.contextTop,o=n.getZoom();n&&n._isRetinaScaling()&&(o*=d.devicePixelRatio),r.shadowColor=i.color,r.shadowBlur=i.blur*o,r.shadowOffsetX=i.offsetX*o,r.shadowOffsetY=i.offsetY*o}},needsFullRender:function(){return new d.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var n=this.canvas.contextTop;n.shadowColor="",n.shadowBlur=n.shadowOffsetX=n.shadowOffsetY=0},_isOutSideCanvas:function(n){return n.x<0||n.x>this.canvas.getWidth()||n.y<0||n.y>this.canvas.getHeight()}}),d.PencilBrush=d.util.createClass(d.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(n){this.canvas=n,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(n,i,r){var o=i.midPointFrom(r);return n.quadraticCurveTo(i.x,i.y,o.x,o.y),o},onMouseDown:function(n,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(n),this._captureDrawingPath(n),this._render())},onMouseMove:function(n,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(n))&&this._captureDrawingPath(n)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var r=this._points,o=r.length,t=this.canvas.contextTop;this._saveAndTransform(t),this.oldEnd&&(t.beginPath(),t.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(t,r[o-2],r[o-1],!0),t.stroke(),t.restore()}},onMouseUp:function(n){return!this.canvas._isMainEvent(n.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(n){var i=new d.Point(n.x,n.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(n){return!(this._points.length>1&&n.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(n),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(n){var i=new d.Point(n.x,n.y);return this._addPoint(i)},_render:function(n){var i,r,o=this._points[0],t=this._points[1];if(n=n||this.canvas.contextTop,this._saveAndTransform(n),n.beginPath(),this._points.length===2&&o.x===t.x&&o.y===t.y){var e=this.width/1e3;o=new d.Point(o.x,o.y),t=new d.Point(t.x,t.y),o.x-=e,t.x+=e}for(n.moveTo(o.x,o.y),i=1,r=this._points.length;i<r;i++)this._drawSegment(n,o,t),o=this._points[i],t=this._points[i+1];n.lineTo(o.x,o.y),n.stroke(),n.restore()},convertPointsToSVGPath:function(n){var i=this.width/1e3;return d.util.getSmoothPathFromPoints(n,i)},_isEmptySVGPath:function(n){return d.util.joinPath(n)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(n){var i=new d.Path(n,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new d.Shadow(this.shadow)),i},decimatePoints:function(n,i){if(n.length<=2)return n;var r,o=this.canvas.getZoom(),t=Math.pow(i/o,2),e=n.length-1,s=n[0],l=[s];for(r=1;r<e-1;r++)Math.pow(s.x-n[r].x,2)+Math.pow(s.y-n[r].y,2)>=t&&(s=n[r],l.push(s));return l.push(n[e]),l},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var n=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(n))this.canvas.requestRenderAll();else{var i=this.createPath(n);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),d.CircleBrush=d.util.createClass(d.BaseBrush,{width:10,initialize:function(n){this.canvas=n,this.points=[]},drawDot:function(n){var i=this.addPoint(n),r=this.canvas.contextTop;this._saveAndTransform(r),this.dot(r,i),r.restore()},dot:function(n,i){n.fillStyle=i.fill,n.beginPath(),n.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),n.closePath(),n.fill()},onMouseDown:function(n){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(n)},_render:function(){var n,i,r=this.canvas.contextTop,o=this.points;for(this._saveAndTransform(r),n=0,i=o.length;n<i;n++)this.dot(r,o[n]);r.restore()},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(n),this._render()):this.drawDot(n))},onMouseUp:function(){var n,i,r=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var o=[];for(n=0,i=this.points.length;n<i;n++){var t=this.points[n],e=new d.Circle({radius:t.radius,left:t.x,top:t.y,originX:"center",originY:"center",fill:t.fill});this.shadow&&(e.shadow=new d.Shadow(this.shadow)),o.push(e)}var s=new d.Group(o);s.canvas=this.canvas,this.canvas.fire("before:path:created",{path:s}),this.canvas.add(s),this.canvas.fire("path:created",{path:s}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=r,this.canvas.requestRenderAll()},addPoint:function(n){var i=new d.Point(n.x,n.y),r=d.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,o=new d.Color(this.color).setAlpha(d.util.getRandomInt(0,100)/100).toRgba();return i.radius=r,i.fill=o,this.points.push(i),i}}),d.SprayBrush=d.util.createClass(d.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(n){this.canvas=n,this.sprayChunks=[]},onMouseDown:function(n){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(n),this.render(this.sprayChunkPoints)},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.addSprayChunk(n),this.render(this.sprayChunkPoints))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],r=0,o=this.sprayChunks.length;r<o;r++)for(var t=this.sprayChunks[r],e=0,s=t.length;e<s;e++){var l=new d.Rect({width:t[e].width,height:t[e].width,left:t[e].x+1,top:t[e].y+1,originX:"center",originY:"center",fill:this.color});i.push(l)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var a=new d.Group(i);this.shadow&&a.set("shadow",new d.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:a}),this.canvas.add(a),this.canvas.fire("path:created",{path:a}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},_getOptimizedRects:function(n){var i,r,o,t={};for(r=0,o=n.length;r<o;r++)t[i=n[r].left+""+n[r].top]||(t[i]=n[r]);var e=[];for(i in t)e.push(t[i]);return e},render:function(n){var i,r,o=this.canvas.contextTop;for(o.fillStyle=this.color,this._saveAndTransform(o),i=0,r=n.length;i<r;i++){var t=n[i];t.opacity!==void 0&&(o.globalAlpha=t.opacity),o.fillRect(t.x,t.y,t.width,t.width)}o.restore()},_render:function(){var n,i,r=this.canvas.contextTop;for(r.fillStyle=this.color,this._saveAndTransform(r),n=0,i=this.sprayChunks.length;n<i;n++)this.render(this.sprayChunks[n]);r.restore()},addSprayChunk:function(n){this.sprayChunkPoints=[];var i,r,o,t,e=this.width/2;for(t=0;t<this.density;t++){i=d.util.getRandomInt(n.x-e,n.x+e),r=d.util.getRandomInt(n.y-e,n.y+e),o=this.dotWidthVariance?d.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var s=new d.Point(i,r);s.width=o,this.randomOpacity&&(s.opacity=d.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(s)}this.sprayChunks.push(this.sprayChunkPoints)}}),d.PatternBrush=d.util.createClass(d.PencilBrush,{getPatternSrc:function(){var n=d.util.createCanvasElement(),i=n.getContext("2d");return n.width=n.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),n},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(n){return n.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(n){this.callSuper("_setBrushStyles",n),n.strokeStyle=this.getPattern(n)},createPath:function(n){var i=this.callSuper("createPath",n),r=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new d.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-r.x,offsetY:-r.y}),i}}),function(){var n=d.util.getPointer,i=d.util.degreesToRadians,r=d.util.isTouchEvent;for(var o in d.Canvas=d.util.createClass(d.StaticCanvas,{initialize:function(t,e){e||(e={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=d.PencilBrush&&new d.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var t,e,s,l=this.getActiveObjects();if(l.length>0&&!this.preserveObjectStacking){e=[],s=[];for(var a=0,h=this._objects.length;a<h;a++)t=this._objects[a],l.indexOf(t)===-1?e.push(t):s.push(t);l.length>1&&(this._activeObject._objects=s),e.push.apply(e,s)}else e=this._objects;return e},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var t=this.contextContainer;return this.renderCanvas(t,this._chooseObjectsToRender()),this},renderTopLayer:function(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()},renderTop:function(){var t=this.contextTop;return this.clearContext(t),this.renderTopLayer(t),this.fire("after:render"),this},_normalizePointer:function(t,e){var s=t.calcTransformMatrix(),l=d.util.invertTransform(s),a=this.restorePointerVpt(e);return d.util.transformPoint(a,l)},isTargetTransparent:function(t,e,s){if(t.shouldCache()&&t._cacheCanvas&&t!==this._activeObject){var l=this._normalizePointer(t,{x:e,y:s}),a=Math.max(t.cacheTranslationX+l.x*t.zoomX,0),h=Math.max(t.cacheTranslationY+l.y*t.zoomY,0);return d.util.isTransparent(t._cacheContext,Math.round(a),Math.round(h),this.targetFindTolerance)}var u=this.contextCache,p=t.selectionBackgroundColor,_=this.viewportTransform;return t.selectionBackgroundColor="",this.clearContext(u),u.save(),u.transform(_[0],_[1],_[2],_[3],_[4],_[5]),t.render(u),u.restore(),t.selectionBackgroundColor=p,d.util.isTransparent(u,e,s,this.targetFindTolerance)},_isSelectionKeyPressed:function(t){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(e){return t[e]===!0}):t[this.selectionKey]},_shouldClearSelection:function(t,e){var s=this.getActiveObjects(),l=this._activeObject;return!e||e&&l&&s.length>1&&s.indexOf(e)===-1&&l!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&l&&l!==e},_shouldCenterTransform:function(t,e,s){var l;if(t)return e==="scale"||e==="scaleX"||e==="scaleY"||e==="resizing"?l=this.centeredScaling||t.centeredScaling:e==="rotate"&&(l=this.centeredRotation||t.centeredRotation),l?!s:s},_getOriginFromCorner:function(t,e){var s={x:t.originX,y:t.originY};return e==="ml"||e==="tl"||e==="bl"?s.x="right":e!=="mr"&&e!=="tr"&&e!=="br"||(s.x="left"),e==="tl"||e==="mt"||e==="tr"?s.y="bottom":e!=="bl"&&e!=="mb"&&e!=="br"||(s.y="top"),s},_getActionFromCorner:function(t,e,s,l){if(!e||!t)return"drag";var a=l.controls[e];return a.getActionName(s,a,l)},_setupCurrentTransform:function(t,e,s){if(e){var l=this.getPointer(t),a=e.__corner,h=e.controls[a],u=s&&a?h.getActionHandler(t,e,h):d.controlsUtils.dragHandler,p=this._getActionFromCorner(s,a,t,e),_=this._getOriginFromCorner(e,a),y=t[this.centeredKey],v={target:e,action:p,actionHandler:u,corner:a,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:l.x-e.left,offsetY:l.y-e.top,originX:_.x,originY:_.y,ex:l.x,ey:l.y,lastX:l.x,lastY:l.y,theta:i(e.angle),width:e.width*e.scaleX,shiftKey:t.shiftKey,altKey:y,original:d.util.saveObjectTransform(e)};this._shouldCenterTransform(e,p,y)&&(v.originX="center",v.originY="center"),v.original.originX=_.x,v.original.originY=_.y,this._currentTransform=v,this._beforeTransform(t)}},setCursor:function(t){this.upperCanvasEl.style.cursor=t},_drawSelection:function(t){var e=this._groupSelector,s=new d.Point(e.ex,e.ey),l=d.util.transformPoint(s,this.viewportTransform),a=new d.Point(e.ex+e.left,e.ey+e.top),h=d.util.transformPoint(a,this.viewportTransform),u=Math.min(l.x,h.x),p=Math.min(l.y,h.y),_=Math.max(l.x,h.x),y=Math.max(l.y,h.y),v=this.selectionLineWidth/2;this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(u,p,_-u,y-p)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,u+=v,p+=v,_-=v,y-=v,d.Object.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(u,p,_-u,y-p))},findTarget:function(t,e){if(!this.skipTargetFind){var s,l,a=this.getPointer(t,!0),h=this._activeObject,u=this.getActiveObjects(),p=r(t),_=u.length>1&&!e||u.length===1;if(this.targets=[],_&&h._findTargetCorner(a,p)||u.length>1&&!e&&h===this._searchPossibleTargets([h],a))return h;if(u.length===1&&h===this._searchPossibleTargets([h],a)){if(!this.preserveObjectStacking)return h;s=h,l=this.targets,this.targets=[]}var y=this._searchPossibleTargets(this._objects,a);return t[this.altSelectionKey]&&y&&s&&y!==s&&(y=s,this.targets=l),y}},_checkTarget:function(t,e,s){if(e&&e.visible&&e.evented&&e.containsPoint(t)&&(!this.perPixelTargetFind&&!e.perPixelTargetFind||e.isEditing||!this.isTargetTransparent(e,s.x,s.y)))return!0},_searchPossibleTargets:function(t,e){for(var s,l,a=t.length;a--;){var h=t[a],u=h.group?this._normalizePointer(h.group,e):e;if(this._checkTarget(u,h,e)){(s=t[a]).subTargetCheck&&s instanceof d.Group&&(l=this._searchPossibleTargets(s._objects,e))&&this.targets.push(l);break}}return s},restorePointerVpt:function(t){return d.util.transformPoint(t,d.util.invertTransform(this.viewportTransform))},getPointer:function(t,e){if(this._absolutePointer&&!e)return this._absolutePointer;if(this._pointer&&e)return this._pointer;var s,l=n(t),a=this.upperCanvasEl,h=a.getBoundingClientRect(),u=h.width||0,p=h.height||0;u&&p||("top"in h&&"bottom"in h&&(p=Math.abs(h.top-h.bottom)),"right"in h&&"left"in h&&(u=Math.abs(h.right-h.left))),this.calcOffset(),l.x=l.x-this._offset.left,l.y=l.y-this._offset.top,e||(l=this.restorePointerVpt(l));var _=this.getRetinaScaling();return _!==1&&(l.x/=_,l.y/=_),s=u===0||p===0?{width:1,height:1}:{width:a.width/u,height:a.height/p},{x:l.x*s.width,y:l.y*s.height}},_createUpperCanvas:function(){var t=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),e=this.lowerCanvasEl,s=this.upperCanvasEl;s?s.className="":(s=this._createCanvasElement(),this.upperCanvasEl=s),d.util.addClass(s,"upper-canvas "+t),this.wrapperEl.appendChild(s),this._copyCanvasStyle(e,s),this._applyCanvasStyle(s),this.contextTop=s.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=d.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),d.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),d.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(t){var e=this.width||t.width,s=this.height||t.height;d.util.setStyle(t,{position:"absolute",width:e+"px",height:s+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),t.width=e,t.height=s,d.util.makeElementUnselectable(t)},_copyCanvasStyle:function(t,e){e.style.cssText=t.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var t=this._activeObject;return t?t.type==="activeSelection"&&t._objects?t._objects.slice(0):[t]:[]},_onObjectRemoved:function(t){t===this._activeObject&&(this.fire("before:selection:cleared",{target:t}),this._discardActiveObject(),this.fire("selection:cleared",{target:t}),t.fire("deselected")),t===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",t)},_fireSelectionEvents:function(t,e){var s=!1,l=this.getActiveObjects(),a=[],h=[];t.forEach(function(u){l.indexOf(u)===-1&&(s=!0,u.fire("deselected",{e,target:u}),h.push(u))}),l.forEach(function(u){t.indexOf(u)===-1&&(s=!0,u.fire("selected",{e,target:u}),a.push(u))}),t.length>0&&l.length>0?s&&this.fire("selection:updated",{e,selected:a,deselected:h}):l.length>0?this.fire("selection:created",{e,selected:a}):t.length>0&&this.fire("selection:cleared",{e,deselected:h})},setActiveObject:function(t,e){var s=this.getActiveObjects();return this._setActiveObject(t,e),this._fireSelectionEvents(s,e),this},_setActiveObject:function(t,e){return this._activeObject!==t&&!!this._discardActiveObject(e,t)&&!t.onSelect({e})&&(this._activeObject=t,!0)},_discardActiveObject:function(t,e){var s=this._activeObject;if(s){if(s.onDeselect({e:t,object:e}))return!1;this._activeObject=null}return!0},discardActiveObject:function(t){var e=this.getActiveObjects(),s=this.getActiveObject();return e.length&&this.fire("before:selection:cleared",{target:s,e:t}),this._discardActiveObject(t),this._fireSelectionEvents(e,t),this},dispose:function(){var t=this.wrapperEl;return this.removeListeners(),t.removeChild(this.upperCanvasEl),t.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(e){d.util.cleanUpJsdomNode(this[e]),this[e]=void 0}).bind(this)),t.parentNode&&t.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,d.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(t){var e=this._activeObject;e&&e._renderControls(t)},_toObject:function(t,e,s){var l=this._realizeGroupTransformOnObject(t),a=this.callSuper("_toObject",t,e,s);return this._unwindGroupTransformOnObject(t,l),a},_realizeGroupTransformOnObject:function(t){if(t.group&&t.group.type==="activeSelection"&&this._activeObject===t.group){var e={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(s){e[s]=t[s]}),d.util.addTransformToObject(t,this._activeObject.calcOwnMatrix()),e}return null},_unwindGroupTransformOnObject:function(t,e){e&&t.set(e)},_setSVGObject:function(t,e,s){var l=this._realizeGroupTransformOnObject(e);this.callSuper("_setSVGObject",t,e,s),this._unwindGroupTransformOnObject(e,l)},setViewportTransform:function(t){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),d.StaticCanvas.prototype.setViewportTransform.call(this,t)}}),d.StaticCanvas)o!=="prototype"&&(d.Canvas[o]=d.StaticCanvas[o])}(),function(){var n=d.util.addListener,i=d.util.removeListener,r={passive:!1};function o(t,e){return t.button&&t.button===e-1}d.util.object.extend(d.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(n,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(t,e){var s=this.upperCanvasEl,l=this._getEventPrefix();t(d.window,"resize",this._onResize),t(s,l+"down",this._onMouseDown),t(s,l+"move",this._onMouseMove,r),t(s,l+"out",this._onMouseOut),t(s,l+"enter",this._onMouseEnter),t(s,"wheel",this._onMouseWheel),t(s,"contextmenu",this._onContextMenu),t(s,"dblclick",this._onDoubleClick),t(s,"dragover",this._onDragOver),t(s,"dragenter",this._onDragEnter),t(s,"dragleave",this._onDragLeave),t(s,"drop",this._onDrop),this.enablePointerEvents||t(s,"touchstart",this._onTouchStart,r),typeof eventjs<"u"&&e in eventjs&&(eventjs[e](s,"gesture",this._onGesture),eventjs[e](s,"drag",this._onDrag),eventjs[e](s,"orientation",this._onOrientationChange),eventjs[e](s,"shake",this._onShake),eventjs[e](s,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var t=this._getEventPrefix();i(d.document,t+"up",this._onMouseUp),i(d.document,"touchend",this._onTouchEnd,r),i(d.document,t+"move",this._onMouseMove,r),i(d.document,"touchmove",this._onMouseMove,r)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(t,e){this.__onTransformGesture&&this.__onTransformGesture(t,e)},_onDrag:function(t,e){this.__onDrag&&this.__onDrag(t,e)},_onMouseWheel:function(t){this.__onMouseWheel(t)},_onMouseOut:function(t){var e=this._hoveredTarget;this.fire("mouse:out",{target:e,e:t}),this._hoveredTarget=null,e&&e.fire("mouseout",{e:t});var s=this;this._hoveredTargets.forEach(function(l){s.fire("mouse:out",{target:e,e:t}),l&&e.fire("mouseout",{e:t})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(l){l.isEditing&&l.hiddenTextarea.focus()})},_onMouseEnter:function(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",{target:null,e:t}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(t,e){this.__onOrientationChange&&this.__onOrientationChange(t,e)},_onShake:function(t,e){this.__onShake&&this.__onShake(t,e)},_onLongPress:function(t,e){this.__onLongPress&&this.__onLongPress(t,e)},_onDragOver:function(t){t.preventDefault();var e=this._simpleEventHandler("dragover",t);this._fireEnterLeaveEvents(e,t)},_onDrop:function(t){return this._simpleEventHandler("drop:before",t),this._simpleEventHandler("drop",t)},_onContextMenu:function(t){return this.stopContextMenu&&(t.stopPropagation(),t.preventDefault()),!1},_onDoubleClick:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"dblclick"),this._resetTransformEventData(t)},getPointerId:function(t){var e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1},_isMainEvent:function(t){return t.isPrimary===!0||t.isPrimary!==!1&&(t.type==="touchend"&&t.touches.length===0||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(t){t.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();n(d.document,"touchend",this._onTouchEnd,r),n(d.document,"touchmove",this._onMouseMove,r),i(e,s+"down",this._onMouseDown)},_onMouseDown:function(t){this.__onMouseDown(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();i(e,s+"move",this._onMouseMove,r),n(d.document,s+"up",this._onMouseUp),n(d.document,s+"move",this._onMouseMove,r)},_onTouchEnd:function(t){if(!(t.touches.length>0)){this.__onMouseUp(t),this._resetTransformEventData(),this.mainTouchId=null;var e=this._getEventPrefix();i(d.document,"touchend",this._onTouchEnd,r),i(d.document,"touchmove",this._onMouseMove,r);var s=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){n(s.upperCanvasEl,e+"down",s._onMouseDown),s._willAddMouseDown=0},400)}},_onMouseUp:function(t){this.__onMouseUp(t),this._resetTransformEventData();var e=this.upperCanvasEl,s=this._getEventPrefix();this._isMainEvent(t)&&(i(d.document,s+"up",this._onMouseUp),i(d.document,s+"move",this._onMouseMove,r),n(e,s+"move",this._onMouseMove,r))},_onMouseMove:function(t){!this.allowTouchScrolling&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)},_onResize:function(){this.calcOffset()},_shouldRender:function(t){var e=this._activeObject;return!!(!!e!=!!t||e&&t&&e!==t)||(e&&e.isEditing,!1)},__onMouseUp:function(t){var e,s=this._currentTransform,l=this._groupSelector,a=!1,h=!l||l.left===0&&l.top===0;if(this._cacheTransformEventData(t),e=this._target,this._handleEvent(t,"up:before"),o(t,3))this.fireRightClick&&this._handleEvent(t,"up",3,h);else{if(o(t,2))return this.fireMiddleClick&&this._handleEvent(t,"up",2,h),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(t);else if(this._isMainEvent(t)){if(s&&(this._finalizeCurrentTransform(t),a=s.actionPerformed),!h){var u=e===this._activeObject;this._maybeGroupObjects(t),a||(a=this._shouldRender(e)||!u&&e===this._activeObject)}var p,_;if(e){if(p=e._findTargetCorner(this.getPointer(t,!0),d.util.isTouchEvent(t)),e.selectable&&e!==this._activeObject&&e.activeOn==="up")this.setActiveObject(e,t),a=!0;else{var y=e.controls[p],v=y&&y.getMouseUpHandler(t,e,y);v&&v(t,s,(_=this.getPointer(t)).x,_.y)}e.isMoving=!1}if(s&&(s.target!==e||s.corner!==p)){var w=s.target&&s.target.controls[s.corner],T=w&&w.getMouseUpHandler(t,e,y);_=_||this.getPointer(t),T&&T(t,s,_.x,_.y)}this._setCursorFromEvent(t,e),this._handleEvent(t,"up",1,h),this._groupSelector=null,this._currentTransform=null,e&&(e.__corner=0),a?this.requestRenderAll():h||this.renderTop()}}},_simpleEventHandler:function(t,e){var s=this.findTarget(e),l=this.targets,a={e,target:s,subTargets:l};if(this.fire(t,a),s&&s.fire(t,a),!l)return s;for(var h=0;h<l.length;h++)l[h].fire(t,a);return s},_handleEvent:function(t,e,s,l){var a=this._target,h=this.targets||[],u={e:t,target:a,subTargets:h,button:s||1,isClick:l||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};e==="up"&&(u.currentTarget=this.findTarget(t),u.currentSubTargets=this.targets),this.fire("mouse:"+e,u),a&&a.fire("mouse"+e,u);for(var p=0;p<h.length;p++)h[p].fire("mouse"+e,u)},_finalizeCurrentTransform:function(t){var e=this._currentTransform,s=e.target,l={e:t,target:s,transform:e,action:e.action};s._scaling&&(s._scaling=!1),s.setCoords(),(e.actionPerformed||this.stateful&&s.hasStateChanged())&&this._fire("modified",l)},_onMouseDownInDrawingMode:function(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(t).requestRenderAll();var e=this.getPointer(t);this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down")},_onMouseMoveInDrawingMode:function(t){if(this._isCurrentlyDrawing){var e=this.getPointer(t);this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")},_onMouseUpInDrawingMode:function(t){var e=this.getPointer(t);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:t,pointer:e}),this._handleEvent(t,"up")},__onMouseDown:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"down:before");var e=this._target;if(o(t,3))this.fireRightClick&&this._handleEvent(t,"down",3);else if(o(t,2))this.fireMiddleClick&&this._handleEvent(t,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(t);else if(this._isMainEvent(t)&&!this._currentTransform){var s=this._pointer;this._previousPointer=s;var l=this._shouldRender(e),a=this._shouldGroup(t,e);if(this._shouldClearSelection(t,e)?this.discardActiveObject(t):a&&(this._handleGrouping(t,e),e=this._activeObject),!this.selection||e&&(e.selectable||e.isEditing||e===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),e){var h=e===this._activeObject;e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);var u=e._findTargetCorner(this.getPointer(t,!0),d.util.isTouchEvent(t));if(e.__corner=u,e===this._activeObject&&(u||!a)){this._setupCurrentTransform(t,e,h);var p=e.controls[u],_=(s=this.getPointer(t),p&&p.getMouseDownHandler(t,e,p));_&&_(t,this._currentTransform,s.x,s.y)}}this._handleEvent(t,"down"),(l||a)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(t){this._resetTransformEventData(),this._pointer=this.getPointer(t,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)||null},_beforeTransform:function(t){var e=this._currentTransform;this.stateful&&e.target.saveState(),this.fire("before:transform",{e:t,transform:e})},__onMouseMove:function(t){var e,s;if(this._handleEvent(t,"move:before"),this._cacheTransformEventData(t),this.isDrawingMode)this._onMouseMoveInDrawingMode(t);else if(this._isMainEvent(t)){var l=this._groupSelector;l?(s=this._absolutePointer,l.left=s.x-l.ex,l.top=s.y-l.ey,this.renderTop()):this._currentTransform?this._transformObject(t):(e=this.findTarget(t)||null,this._setCursorFromEvent(t,e),this._fireOverOutEvents(e,t)),this._handleEvent(t,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(t,e){var s=this._hoveredTarget,l=this._hoveredTargets,a=this.targets,h=Math.max(l.length,a.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:s,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var u=0;u<h;u++)this.fireSyntheticInOutEvents(a[u],e,{oldTarget:l[u],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=t,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(t,e){var s=this._draggedoverTarget,l=this._hoveredTargets,a=this.targets,h=Math.max(l.length,a.length);this.fireSyntheticInOutEvents(t,e,{oldTarget:s,evtOut:"dragleave",evtIn:"dragenter"});for(var u=0;u<h;u++)this.fireSyntheticInOutEvents(a[u],e,{oldTarget:l[u],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=t},fireSyntheticInOutEvents:function(t,e,s){var l,a,h,u=s.oldTarget,p=u!==t,_=s.canvasEvtIn,y=s.canvasEvtOut;p&&(l={e,target:t,previousTarget:u},a={e,target:u,nextTarget:t}),h=t&&p,u&&p&&(y&&this.fire(y,a),u.fire(s.evtOut,a)),h&&(_&&this.fire(_,l),t.fire(s.evtIn,l))},__onMouseWheel:function(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()},_transformObject:function(t){var e=this.getPointer(t),s=this._currentTransform;s.reset=!1,s.shiftKey=t.shiftKey,s.altKey=t[this.centeredKey],this._performTransformAction(t,s,e),s.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(t,e,s){var l=s.x,a=s.y,h=e.action,u=!1,p=e.actionHandler;p&&(u=p(t,e,l,a)),h==="drag"&&u&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||u},_fire:d.controlsUtils.fireEvent,_setCursorFromEvent:function(t,e){if(!e)return this.setCursor(this.defaultCursor),!1;var s=e.hoverCursor||this.hoverCursor,l=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,a=(!l||!l.contains(e))&&e._findTargetCorner(this.getPointer(t,!0));a?this.setCursor(this.getCornerCursor(a,e,t)):(e.subTargetCheck&&this.targets.concat().reverse().map(function(h){s=h.hoverCursor||s}),this.setCursor(s))},getCornerCursor:function(t,e,s){var l=e.controls[t];return l.cursorStyleHandler(s,l,e)}})}(),at=Math.min,st=Math.max,d.util.object.extend(d.Canvas.prototype,{_shouldGroup:function(n,i){var r=this._activeObject;return r&&this._isSelectionKeyPressed(n)&&i&&i.selectable&&this.selection&&(r!==i||r.type==="activeSelection")&&!i.onSelect({e:n})},_handleGrouping:function(n,i){var r=this._activeObject;r.__corner||(i!==r||(i=this.findTarget(n,!0))&&i.selectable)&&(r&&r.type==="activeSelection"?this._updateActiveSelection(i,n):this._createActiveSelection(i,n))},_updateActiveSelection:function(n,i){var r=this._activeObject,o=r._objects.slice(0);r.contains(n)?(r.removeWithUpdate(n),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat(),r.size()===1&&this._setActiveObject(r.item(0),i)):(r.addWithUpdate(n),this._hoveredTarget=r,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(o,i)},_createActiveSelection:function(n,i){var r=this.getActiveObjects(),o=this._createGroup(n);this._hoveredTarget=o,this._setActiveObject(o,i),this._fireSelectionEvents(r,i)},_createGroup:function(n){var i=this._objects,r=i.indexOf(this._activeObject)<i.indexOf(n)?[this._activeObject,n]:[n,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new d.ActiveSelection(r,{canvas:this})},_groupSelectedObjects:function(n){var i,r=this._collectObjects(n);r.length===1?this.setActiveObject(r[0],n):r.length>1&&(i=new d.ActiveSelection(r.reverse(),{canvas:this}),this.setActiveObject(i,n))},_collectObjects:function(n){for(var i,r=[],o=this._groupSelector.ex,t=this._groupSelector.ey,e=o+this._groupSelector.left,s=t+this._groupSelector.top,l=new d.Point(at(o,e),at(t,s)),a=new d.Point(st(o,e),st(t,s)),h=!this.selectionFullyContained,u=o===e&&t===s,p=this._objects.length;p--&&!((i=this._objects[p])&&i.selectable&&i.visible&&(h&&i.intersectsWithRect(l,a,!0)||i.isContainedWithinRect(l,a,!0)||h&&i.containsPoint(l,null,!0)||h&&i.containsPoint(a,null,!0))&&(r.push(i),u)););return r.length>1&&(r=r.filter(function(_){return!_.onSelect({e:n})})),r},_maybeGroupObjects:function(n){this.selection&&this._groupSelector&&this._groupSelectedObjects(n),this.setCursor(this.defaultCursor),this._groupSelector=null}}),d.util.object.extend(d.StaticCanvas.prototype,{toDataURL:function(n){n||(n={});var i=n.format||"png",r=n.quality||1,o=(n.multiplier||1)*(n.enableRetinaScaling?this.getRetinaScaling():1),t=this.toCanvasElement(o,n);return d.util.toDataURL(t,i,r)},toCanvasElement:function(n,i){n=n||1;var r=((i=i||{}).width||this.width)*n,o=(i.height||this.height)*n,t=this.getZoom(),e=this.width,s=this.height,l=t*n,a=this.viewportTransform,h=(a[4]-(i.left||0))*n,u=(a[5]-(i.top||0))*n,p=this.interactive,_=[l,0,0,l,h,u],y=this.enableRetinaScaling,v=d.util.createCanvasElement(),w=this.contextTop;return v.width=r,v.height=o,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=_,this.width=r,this.height=o,this.calcViewportBoundaries(),this.renderCanvas(v.getContext("2d"),this._objects),this.viewportTransform=a,this.width=e,this.height=s,this.calcViewportBoundaries(),this.interactive=p,this.enableRetinaScaling=y,this.contextTop=w,v}}),d.util.object.extend(d.StaticCanvas.prototype,{loadFromJSON:function(n,i,r){if(n){var o=typeof n=="string"?JSON.parse(n):d.util.object.clone(n),t=this,e=o.clipPath,s=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete o.clipPath,this._enlivenObjects(o.objects,function(l){t.clear(),t._setBgOverlay(o,function(){e?t._enlivenObjects([e],function(a){t.clipPath=a[0],t.__setupCanvas.call(t,o,l,s,i)}):t.__setupCanvas.call(t,o,l,s,i)})},r),this}},__setupCanvas:function(n,i,r,o){var t=this;i.forEach(function(e,s){t.insertAt(e,s)}),this.renderOnAddRemove=r,delete n.objects,delete n.backgroundImage,delete n.overlayImage,delete n.background,delete n.overlay,this._setOptions(n),this.renderAll(),o&&o()},_setBgOverlay:function(n,i){var r={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(n.backgroundImage||n.overlayImage||n.background||n.overlay){var o=function(){r.backgroundImage&&r.overlayImage&&r.backgroundColor&&r.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",n.backgroundImage,r,o),this.__setBgOverlay("overlayImage",n.overlayImage,r,o),this.__setBgOverlay("backgroundColor",n.background,r,o),this.__setBgOverlay("overlayColor",n.overlay,r,o)}else i&&i()},__setBgOverlay:function(n,i,r,o){var t=this;if(!i)return r[n]=!0,void(o&&o());n==="backgroundImage"||n==="overlayImage"?d.util.enlivenObjects([i],function(e){t[n]=e[0],r[n]=!0,o&&o()}):this["set"+d.util.string.capitalize(n,!0)](i,function(){r[n]=!0,o&&o()})},_enlivenObjects:function(n,i,r){n&&n.length!==0?d.util.enlivenObjects(n,function(o){i&&i(o)},null,r):i&&i([])},_toDataURL:function(n,i){this.clone(function(r){i(r.toDataURL(n))})},_toDataURLWithMultiplier:function(n,i,r){this.clone(function(o){r(o.toDataURLWithMultiplier(n,i))})},clone:function(n,i){var r=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(o){o.loadFromJSON(r,function(){n&&n(o)})})},cloneWithoutData:function(n){var i=d.util.createCanvasElement();i.width=this.width,i.height=this.height;var r=new d.Canvas(i);this.backgroundImage?(r.setBackgroundImage(this.backgroundImage.src,function(){r.renderAll(),n&&n(r)}),r.backgroundImageOpacity=this.backgroundImageOpacity,r.backgroundImageStretch=this.backgroundImageStretch):n&&n(r)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t=i.util.toFixed,e=i.util.string.capitalize,s=i.util.degreesToRadians,l=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:l,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(a){a&&this.setOptions(a)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(a){var h=i.perfLimitSizeTotal,u=a.width,p=a.height,_=i.maxCacheSideLimit,y=i.minCacheSideLimit;if(u<=_&&p<=_&&u*p<=h)return u<y&&(a.width=y),p<y&&(a.height=y),a;var v=u/p,w=i.util.limitDimsByArea(v,h),T=i.util.capValue,P=T(y,w.x,_),L=T(y,w.y,_);return u>P&&(a.zoomX/=u/P,a.width=P,a.capped=!0),p>L&&(a.zoomY/=p/L,a.height=L,a.capped=!0),a},_getCacheCanvasDimensions:function(){var a=this.getTotalObjectScaling(),h=this._getTransformedDimensions(0,0),u=h.x*a.scaleX/this.scaleX,p=h.y*a.scaleY/this.scaleY;return{width:u+2,height:p+2,zoomX:a.scaleX,zoomY:a.scaleY,x:u,y:p}},_updateCacheCanvas:function(){var a=this.canvas;if(this.noScaleCache&&a&&a._currentTransform){var h=a._currentTransform.target,u=a._currentTransform.action;if(this===h&&u.slice&&u.slice(0,5)==="scale")return!1}var p,_,y=this._cacheCanvas,v=this._limitCacheSize(this._getCacheCanvasDimensions()),w=i.minCacheSideLimit,T=v.width,P=v.height,L=v.zoomX,W=v.zoomY,N=T!==this.cacheWidth||P!==this.cacheHeight,B=this.zoomX!==L||this.zoomY!==W,D=N||B,A=0,k=0,G=!1;if(N){var H=this._cacheCanvas.width,M=this._cacheCanvas.height,I=T>H||P>M;G=I||(T<.9*H||P<.9*M)&&H>w&&M>w,I&&!v.capped&&(T>w||P>w)&&(A=.1*T,k=.1*P)}return this instanceof i.Text&&this.path&&(D=!0,G=!0,A+=this.getHeightOfLine(0)*this.zoomX,k+=this.getHeightOfLine(0)*this.zoomY),!!D&&(G?(y.width=Math.ceil(T+A),y.height=Math.ceil(P+k)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,y.width,y.height)),p=v.x/2,_=v.y/2,this.cacheTranslationX=Math.round(y.width/2-p)+p,this.cacheTranslationY=Math.round(y.height/2-_)+_,this.cacheWidth=T,this.cacheHeight=P,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(L,W),this.zoomX=L,this.zoomY=W,!0)},setOptions:function(a){this._setOptions(a),this._initGradient(a.fill,"fill"),this._initGradient(a.stroke,"stroke"),this._initPattern(a.fill,"fill"),this._initPattern(a.stroke,"stroke")},transform:function(a){var h=this.group&&!this.group._transformDone||this.group&&this.canvas&&a===this.canvas.contextTop,u=this.calcTransformMatrix(!h);a.transform(u[0],u[1],u[2],u[3],u[4],u[5])},toObject:function(a){var h=i.Object.NUM_FRACTION_DIGITS,u={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:t(this.left,h),top:t(this.top,h),width:t(this.width,h),height:t(this.height,h),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:t(this.strokeWidth,h),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:t(this.strokeMiterLimit,h),scaleX:t(this.scaleX,h),scaleY:t(this.scaleY,h),angle:t(this.angle,h),flipX:this.flipX,flipY:this.flipY,opacity:t(this.opacity,h),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:t(this.skewX,h),skewY:t(this.skewY,h)};return this.clipPath&&!this.clipPath.excludeFromExport&&(u.clipPath=this.clipPath.toObject(a),u.clipPath.inverted=this.clipPath.inverted,u.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,u,a),this.includeDefaultValues||(u=this._removeDefaultValues(u)),u},toDatalessObject:function(a){return this.toObject(a)},_removeDefaultValues:function(a){var h=i.util.getKlass(a.type).prototype;return h.stateProperties.forEach(function(u){u!=="left"&&u!=="top"&&(a[u]===h[u]&&delete a[u],Array.isArray(a[u])&&Array.isArray(h[u])&&a[u].length===0&&h[u].length===0&&delete a[u])}),a},toString:function(){return"#<fabric."+e(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var a=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(a.scaleX),scaleY:Math.abs(a.scaleY)}},getTotalObjectScaling:function(){var a=this.getObjectScaling(),h=a.scaleX,u=a.scaleY;if(this.canvas){var p=this.canvas.getZoom(),_=this.canvas.getRetinaScaling();h*=p*_,u*=p*_}return{scaleX:h,scaleY:u}},getObjectOpacity:function(){var a=this.opacity;return this.group&&(a*=this.group.getObjectOpacity()),a},_set:function(a,h){var u=a==="scaleX"||a==="scaleY",p=this[a]!==h,_=!1;return u&&(h=this._constrainScale(h)),a==="scaleX"&&h<0?(this.flipX=!this.flipX,h*=-1):a==="scaleY"&&h<0?(this.flipY=!this.flipY,h*=-1):a!=="shadow"||!h||h instanceof i.Shadow?a==="dirty"&&this.group&&this.group.set("dirty",h):h=new i.Shadow(h),this[a]=h,p&&(_=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(a)>-1?(this.dirty=!0,_&&this.group.set("dirty",!0)):_&&this.stateProperties.indexOf(a)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(a){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(a.save(),this._setupCompositeOperation(a),this.drawSelectionBackground(a),this.transform(a),this._setOpacity(a),this._setShadow(a,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(a)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(a),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),a.restore())},renderCache:function(a){a=a||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,a.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(a,h){if(a.save(),h.inverted?a.globalCompositeOperation="destination-out":a.globalCompositeOperation="destination-in",h.absolutePositioned){var u=i.util.invertTransform(this.calcTransformMatrix());a.transform(u[0],u[1],u[2],u[3],u[4],u[5])}h.transform(a),a.scale(1/h.zoomX,1/h.zoomY),a.drawImage(h._cacheCanvas,-h.cacheTranslationX,-h.cacheTranslationY),a.restore()},drawObject:function(a,h){var u=this.fill,p=this.stroke;h?(this.fill="black",this.stroke="",this._setClippingProperties(a)):this._renderBackground(a),this._render(a),this._drawClipPath(a,this.clipPath),this.fill=u,this.stroke=p},_drawClipPath:function(a,h){h&&(h.canvas=this.canvas,h.shouldCache(),h._transformDone=!0,h.renderCache({forClipping:!0}),this.drawClipPathOnCache(a,h))},drawCacheOnCanvas:function(a){a.scale(1/this.zoomX,1/this.zoomY),a.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(a){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!a&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!a){var h=this.cacheWidth/this.zoomX,u=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-h/2,-u/2,h,u)}return!0}return!1},_renderBackground:function(a){if(this.backgroundColor){var h=this._getNonTransformedDimensions();a.fillStyle=this.backgroundColor,a.fillRect(-h.x/2,-h.y/2,h.x,h.y),this._removeShadow(a)}},_setOpacity:function(a){this.group&&!this.group._transformDone?a.globalAlpha=this.getObjectOpacity():a.globalAlpha*=this.opacity},_setStrokeStyles:function(a,h){var u=h.stroke;u&&(a.lineWidth=h.strokeWidth,a.lineCap=h.strokeLineCap,a.lineDashOffset=h.strokeDashOffset,a.lineJoin=h.strokeLineJoin,a.miterLimit=h.strokeMiterLimit,u.toLive?u.gradientUnits==="percentage"||u.gradientTransform||u.patternTransform?this._applyPatternForTransformedGradient(a,u):(a.strokeStyle=u.toLive(a,this),this._applyPatternGradientTransform(a,u)):a.strokeStyle=h.stroke)},_setFillStyles:function(a,h){var u=h.fill;u&&(u.toLive?(a.fillStyle=u.toLive(a,this),this._applyPatternGradientTransform(a,h.fill)):a.fillStyle=u)},_setClippingProperties:function(a){a.globalAlpha=1,a.strokeStyle="transparent",a.fillStyle="#000000"},_setLineDash:function(a,h){h&&h.length!==0&&(1&h.length&&h.push.apply(h,h),a.setLineDash(h))},_renderControls:function(a,h){var u,p,_,y=this.getViewportTransform(),v=this.calcTransformMatrix();p=(h=h||{}).hasBorders!==void 0?h.hasBorders:this.hasBorders,_=h.hasControls!==void 0?h.hasControls:this.hasControls,v=i.util.multiplyTransformMatrices(y,v),u=i.util.qrDecompose(v),a.save(),a.translate(u.translateX,u.translateY),a.lineWidth=1*this.borderScaleFactor,this.group||(a.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(u.angle-=180),a.rotate(s(this.group?u.angle:this.angle)),h.forActiveSelection||this.group?p&&this.drawBordersInGroup(a,u,h):p&&this.drawBorders(a,h),_&&this.drawControls(a,h),a.restore()},_setShadow:function(a){if(this.shadow){var h,u=this.shadow,p=this.canvas,_=p&&p.viewportTransform[0]||1,y=p&&p.viewportTransform[3]||1;h=u.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),p&&p._isRetinaScaling()&&(_*=i.devicePixelRatio,y*=i.devicePixelRatio),a.shadowColor=u.color,a.shadowBlur=u.blur*i.browserShadowBlurConstant*(_+y)*(h.scaleX+h.scaleY)/4,a.shadowOffsetX=u.offsetX*_*h.scaleX,a.shadowOffsetY=u.offsetY*y*h.scaleY}},_removeShadow:function(a){this.shadow&&(a.shadowColor="",a.shadowBlur=a.shadowOffsetX=a.shadowOffsetY=0)},_applyPatternGradientTransform:function(a,h){if(!h||!h.toLive)return{offsetX:0,offsetY:0};var u=h.gradientTransform||h.patternTransform,p=-this.width/2+h.offsetX||0,_=-this.height/2+h.offsetY||0;return h.gradientUnits==="percentage"?a.transform(this.width,0,0,this.height,p,_):a.transform(1,0,0,1,p,_),u&&a.transform(u[0],u[1],u[2],u[3],u[4],u[5]),{offsetX:p,offsetY:_}},_renderPaintInOrder:function(a){this.paintFirst==="stroke"?(this._renderStroke(a),this._renderFill(a)):(this._renderFill(a),this._renderStroke(a))},_render:function(){},_renderFill:function(a){this.fill&&(a.save(),this._setFillStyles(a,this),this.fillRule==="evenodd"?a.fill("evenodd"):a.fill(),a.restore())},_renderStroke:function(a){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(a),a.save(),this.strokeUniform&&this.group){var h=this.getObjectScaling();a.scale(1/h.scaleX,1/h.scaleY)}else this.strokeUniform&&a.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(a,this.strokeDashArray),this._setStrokeStyles(a,this),a.stroke(),a.restore()}},_applyPatternForTransformedGradient:function(a,h){var u,p=this._limitCacheSize(this._getCacheCanvasDimensions()),_=i.util.createCanvasElement(),y=this.canvas.getRetinaScaling(),v=p.x/this.scaleX/y,w=p.y/this.scaleY/y;_.width=v,_.height=w,(u=_.getContext("2d")).beginPath(),u.moveTo(0,0),u.lineTo(v,0),u.lineTo(v,w),u.lineTo(0,w),u.closePath(),u.translate(v/2,w/2),u.scale(p.zoomX/this.scaleX/y,p.zoomY/this.scaleY/y),this._applyPatternGradientTransform(u,h),u.fillStyle=h.toLive(a),u.fill(),a.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),a.scale(y*this.scaleX/p.zoomX,y*this.scaleY/p.zoomY),a.strokeStyle=u.createPattern(_,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var a=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",a.scaleX),this.set("scaleY",a.scaleY),this.angle=a.angle,this.skewX=a.skewX,this.skewY=0}},_removeTransformMatrix:function(a){var h=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),h=i.util.transformPoint(h,this.transformMatrix)),this.transformMatrix=null,a&&(this.scaleX*=a.scaleX,this.scaleY*=a.scaleY,this.cropX=a.cropX,this.cropY=a.cropY,h.x+=a.offsetLeft,h.y+=a.offsetTop,this.width=a.width,this.height=a.height),this.setPositionByOrigin(h,"center","center")},clone:function(a,h){var u=this.toObject(h);this.constructor.fromObject?this.constructor.fromObject(u,a):i.Object._fromObject("Object",u,a)},cloneAsImage:function(a,h){var u=this.toCanvasElement(h);return a&&a(new i.Image(u)),this},toCanvasElement:function(a){a||(a={});var h=i.util,u=h.saveObjectTransform(this),p=this.group,_=this.shadow,y=Math.abs,v=(a.multiplier||1)*(a.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,a.withoutTransform&&h.resetObjectTransform(this),a.withoutShadow&&(this.shadow=null);var w,T,P,L,W=i.util.createCanvasElement(),N=this.getBoundingRect(!0,!0),B=this.shadow,D={x:0,y:0};B&&(T=B.blur,w=B.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),D.x=2*Math.round(y(B.offsetX)+T)*y(w.scaleX),D.y=2*Math.round(y(B.offsetY)+T)*y(w.scaleY)),P=N.width+D.x,L=N.height+D.y,W.width=Math.ceil(P),W.height=Math.ceil(L);var A=new i.StaticCanvas(W,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});a.format==="jpeg"&&(A.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(A.width/2,A.height/2),"center","center");var k=this.canvas;A.add(this);var G=A.toCanvasElement(v||1,a);return this.shadow=_,this.set("canvas",k),p&&(this.group=p),this.set(u).setCoords(),A._objects=[],A.dispose(),A=null,G},toDataURL:function(a){return a||(a={}),i.util.toDataURL(this.toCanvasElement(a),a.format||"png",a.quality||1)},isType:function(a){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===a},complexity:function(){return 1},toJSON:function(a){return this.toObject(a)},rotate:function(a){var h=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return h&&this._setOriginToCenter(),this.set("angle",a),h&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(a,h){h=h||this.canvas.getPointer(a);var u=new i.Point(h.x,h.y),p=this._getLeftTopCoords();return this.angle&&(u=i.util.rotatePoint(u,p,s(-this.angle))),{x:u.x-p.x,y:u.y-p.y}},_setupCompositeOperation:function(a){this.globalCompositeOperation&&(a.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),r(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(a,h,u,p){var _=i[a];h=o(h,!0),i.util.enlivenPatterns([h.fill,h.stroke],function(y){y[0]!==void 0&&(h.fill=y[0]),y[1]!==void 0&&(h.stroke=y[1]),i.util.enlivenObjectEnlivables(h,h,function(){var v=p?new _(h[p],h):new _(h);u&&u(v)})})},i.Object.__uid=0)}(c),dt=d.util.degreesToRadians,gt={left:-.5,center:0,right:.5},pt={top:-.5,center:0,bottom:.5},d.util.object.extend(d.Object.prototype,{translateToGivenOrigin:function(n,i,r,o,t){var e,s,l,a=n.x,h=n.y;return typeof i=="string"?i=gt[i]:i-=.5,typeof o=="string"?o=gt[o]:o-=.5,typeof r=="string"?r=pt[r]:r-=.5,typeof t=="string"?t=pt[t]:t-=.5,s=t-r,((e=o-i)||s)&&(l=this._getTransformedDimensions(),a=n.x+e*l.x,h=n.y+s*l.y),new d.Point(a,h)},translateToCenterPoint:function(n,i,r){var o=this.translateToGivenOrigin(n,i,r,"center","center");return this.angle?d.util.rotatePoint(o,n,dt(this.angle)):o},translateToOriginPoint:function(n,i,r){var o=this.translateToGivenOrigin(n,"center","center",i,r);return this.angle?d.util.rotatePoint(o,n,dt(this.angle)):o},getCenterPoint:function(){var n=new d.Point(this.left,this.top);return this.translateToCenterPoint(n,this.originX,this.originY)},getPointByOrigin:function(n,i){var r=this.getCenterPoint();return this.translateToOriginPoint(r,n,i)},toLocalPoint:function(n,i,r){var o,t,e=this.getCenterPoint();return o=i!==void 0&&r!==void 0?this.translateToGivenOrigin(e,"center","center",i,r):new d.Point(this.left,this.top),t=new d.Point(n.x,n.y),this.angle&&(t=d.util.rotatePoint(t,e,-dt(this.angle))),t.subtractEquals(o)},setPositionByOrigin:function(n,i,r){var o=this.translateToCenterPoint(n,i,r),t=this.translateToOriginPoint(o,this.originX,this.originY);this.set("left",t.x),this.set("top",t.y)},adjustPosition:function(n){var i,r,o=dt(this.angle),t=this.getScaledWidth(),e=d.util.cos(o)*t,s=d.util.sin(o)*t;i=typeof this.originX=="string"?gt[this.originX]:this.originX-.5,r=typeof n=="string"?gt[n]:n-.5,this.left+=e*(r-i),this.top+=s*(r-i),this.setCoords(),this.originX=n},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var n=this.getCenterPoint();this.originX="center",this.originY="center",this.left=n.x,this.top=n.y},_resetOrigin:function(){var n=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=n.x,this.top=n.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var n=d.util,i=n.degreesToRadians,r=n.multiplyTransformMatrices,o=n.transformPoint;n.object.extend(d.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(t,e){return e?t?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),t?this.aCoords:this.lineCoords)},getCoords:function(t,e){return s=this._getCoords(t,e),[new d.Point(s.tl.x,s.tl.y),new d.Point(s.tr.x,s.tr.y),new d.Point(s.br.x,s.br.y),new d.Point(s.bl.x,s.bl.y)];var s},intersectsWithRect:function(t,e,s,l){var a=this.getCoords(s,l);return d.Intersection.intersectPolygonRectangle(a,t,e).status==="Intersection"},intersectsWithObject:function(t,e,s){return d.Intersection.intersectPolygonPolygon(this.getCoords(e,s),t.getCoords(e,s)).status==="Intersection"||t.isContainedWithinObject(this,e,s)||this.isContainedWithinObject(t,e,s)},isContainedWithinObject:function(t,e,s){for(var l=this.getCoords(e,s),a=e?t.aCoords:t.lineCoords,h=0,u=t._getImageLines(a);h<4;h++)if(!t.containsPoint(l[h],u))return!1;return!0},isContainedWithinRect:function(t,e,s,l){var a=this.getBoundingRect(s,l);return a.left>=t.x&&a.left+a.width<=e.x&&a.top>=t.y&&a.top+a.height<=e.y},containsPoint:function(t,e,s,l){var a=this._getCoords(s,l),h=(e=e||this._getImageLines(a),this._findCrossPoints(t,e));return h!==0&&h%2==1},isOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.getCoords(!0,t).some(function(l){return l.x<=s.x&&l.x>=e.x&&l.y<=s.y&&l.y>=e.y})||!!this.intersectsWithRect(e,s,!0,t)||this._containsCenterOfCanvas(e,s,t)},_containsCenterOfCanvas:function(t,e,s){var l={x:(t.x+e.x)/2,y:(t.y+e.y)/2};return!!this.containsPoint(l,null,!0,s)},isPartiallyOnScreen:function(t){if(!this.canvas)return!1;var e=this.canvas.vptCoords.tl,s=this.canvas.vptCoords.br;return!!this.intersectsWithRect(e,s,!0,t)||this.getCoords(!0,t).every(function(l){return(l.x>=s.x||l.x<=e.x)&&(l.y>=s.y||l.y<=e.y)})&&this._containsCenterOfCanvas(e,s,t)},_getImageLines:function(t){return{topline:{o:t.tl,d:t.tr},rightline:{o:t.tr,d:t.br},bottomline:{o:t.br,d:t.bl},leftline:{o:t.bl,d:t.tl}}},_findCrossPoints:function(t,e){var s,l,a,h=0;for(var u in e)if(!((a=e[u]).o.y<t.y&&a.d.y<t.y||a.o.y>=t.y&&a.d.y>=t.y||(a.o.x===a.d.x&&a.o.x>=t.x?l=a.o.x:(s=(a.d.y-a.o.y)/(a.d.x-a.o.x),l=-(t.y-0*t.x-(a.o.y-s*a.o.x))/(0-s)),l>=t.x&&(h+=1),h!==2)))break;return h},getBoundingRect:function(t,e){var s=this.getCoords(t,e);return n.makeBoundingBoxFromPoints(s)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t},scale:function(t){return this._set("scaleX",t),this._set("scaleY",t),this.setCoords()},scaleToWidth:function(t,e){var s=this.getBoundingRect(e).width/this.getScaledWidth();return this.scale(t/this.width/s)},scaleToHeight:function(t,e){var s=this.getBoundingRect(e).height/this.getScaledHeight();return this.scale(t/this.height/s)},calcLineCoords:function(){var t=this.getViewportTransform(),e=this.padding,s=i(this.angle),l=n.cos(s)*e,a=n.sin(s)*e,h=l+a,u=l-a,p=this.calcACoords(),_={tl:o(p.tl,t),tr:o(p.tr,t),bl:o(p.bl,t),br:o(p.br,t)};return e&&(_.tl.x-=u,_.tl.y-=h,_.tr.x+=h,_.tr.y-=u,_.bl.x-=h,_.bl.y+=u,_.br.x+=u,_.br.y+=h),_},calcOCoords:function(){var t=this._calcRotateMatrix(),e=this._calcTranslateMatrix(),s=this.getViewportTransform(),l=r(s,e),a=r(l,t),h=(a=r(a,[1/s[0],0,0,1/s[3],0,0]),this._calculateCurrentDimensions()),u={};return this.forEachControl(function(p,_,y){u[_]=p.positionHandler(h,a,y)}),u},calcACoords:function(){var t=this._calcRotateMatrix(),e=this._calcTranslateMatrix(),s=r(e,t),l=this._getTransformedDimensions(),a=l.x/2,h=l.y/2;return{tl:o({x:-a,y:-h},s),tr:o({x:a,y:-h},s),bl:o({x:-a,y:h},s),br:o({x:a,y:h},s)}},setCoords:function(t){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),t||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return n.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var t=this.getCenterPoint();return[1,0,0,1,t.x,t.y]},transformMatrixKey:function(t){var e="_",s="";return!t&&this.group&&(s=this.group.transformMatrixKey(t)+e),s+this.top+e+this.left+e+this.scaleX+e+this.scaleY+e+this.skewX+e+this.skewY+e+this.angle+e+this.originX+e+this.originY+e+this.width+e+this.height+e+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(t){var e=this.calcOwnMatrix();if(t||!this.group)return e;var s=this.transformMatrixKey(t),l=this.matrixCache||(this.matrixCache={});return l.key===s?l.value:(this.group&&(e=r(this.group.calcTransformMatrix(!1),e)),l.key=s,l.value=e,e)},calcOwnMatrix:function(){var t=this.transformMatrixKey(!0),e=this.ownMatrixCache||(this.ownMatrixCache={});if(e.key===t)return e.value;var s=this._calcTranslateMatrix(),l={angle:this.angle,translateX:s[4],translateY:s[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return e.key=t,e.value=n.composeMatrix(l),e.value},_getNonTransformedDimensions:function(){var t=this.strokeWidth;return{x:this.width+t,y:this.height+t}},_getTransformedDimensions:function(t,e){t===void 0&&(t=this.skewX),e===void 0&&(e=this.skewY);var s,l,a,h=t===0&&e===0;if(this.strokeUniform?(l=this.width,a=this.height):(l=(s=this._getNonTransformedDimensions()).x,a=s.y),h)return this._finalizeDimensions(l*this.scaleX,a*this.scaleY);var u=n.sizeAfterTransform(l,a,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:t,skewY:e});return this._finalizeDimensions(u.x,u.y)},_finalizeDimensions:function(t,e){return this.strokeUniform?{x:t+this.strokeWidth,y:e+this.strokeWidth}:{x:t,y:e}},_calculateCurrentDimensions:function(){var t=this.getViewportTransform(),e=this._getTransformedDimensions();return o(e,t,!0).scalarAdd(2*this.padding)}})}(),d.util.object.extend(d.Object.prototype,{sendToBack:function(){return this.group?d.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?d.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(n){return this.group?d.StaticCanvas.prototype.sendBackwards.call(this.group,this,n):this.canvas&&this.canvas.sendBackwards(this,n),this},bringForward:function(n){return this.group?d.StaticCanvas.prototype.bringForward.call(this.group,this,n):this.canvas&&this.canvas.bringForward(this,n),this},moveTo:function(n){return this.group&&this.group.type!=="activeSelection"?d.StaticCanvas.prototype.moveTo.call(this.group,this,n):this.canvas&&this.canvas.moveTo(this,n),this}}),function(){function n(r,o){if(o){if(o.toLive)return r+": url(#SVGID_"+o.id+"); ";var t=new d.Color(o),e=r+": "+t.toRgb()+"; ",s=t.getAlpha();return s!==1&&(e+=r+"-opacity: "+s.toString()+"; "),e}return r+": none; "}var i=d.util.toFixed;d.util.object.extend(d.Object.prototype,{getSvgStyles:function(r){var o=this.fillRule?this.fillRule:"nonzero",t=this.strokeWidth?this.strokeWidth:"0",e=this.strokeDashArray?this.strokeDashArray.join(" "):"none",s=this.strokeDashOffset?this.strokeDashOffset:"0",l=this.strokeLineCap?this.strokeLineCap:"butt",a=this.strokeLineJoin?this.strokeLineJoin:"miter",h=this.strokeMiterLimit?this.strokeMiterLimit:"4",u=this.opacity!==void 0?this.opacity:"1",p=this.visible?"":" visibility: hidden;",_=r?"":this.getSvgFilter(),y=n("fill",this.fill);return[n("stroke",this.stroke),"stroke-width: ",t,"; ","stroke-dasharray: ",e,"; ","stroke-linecap: ",l,"; ","stroke-dashoffset: ",s,"; ","stroke-linejoin: ",a,"; ","stroke-miterlimit: ",h,"; ",y,"fill-rule: ",o,"; ","opacity: ",u,";",_,p].join("")},getSvgSpanStyles:function(r,o){var t="; ",e=r.fontFamily?"font-family: "+(r.fontFamily.indexOf("'")===-1&&r.fontFamily.indexOf('"')===-1?"'"+r.fontFamily+"'":r.fontFamily)+t:"",s=r.strokeWidth?"stroke-width: "+r.strokeWidth+t:"",l=r.fontSize?"font-size: "+r.fontSize+"px"+t:"",a=r.fontStyle?"font-style: "+r.fontStyle+t:"",h=r.fontWeight?"font-weight: "+r.fontWeight+t:"",u=r.fill?n("fill",r.fill):"",p=r.stroke?n("stroke",r.stroke):"",_=this.getSvgTextDecoration(r);return _&&(_="text-decoration: "+_+t),[p,s,e,l,a,h,_,u,r.deltaY?"baseline-shift: "+-r.deltaY+"; ":"",o?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(r){return["overline","underline","line-through"].filter(function(o){return r[o.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(r,o){var t=r?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+d.util.matrixToSVG(t)+(o||"")+'" '},_setSVGBg:function(r){if(this.backgroundColor){var o=d.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,o),'" y="',i(-this.height/2,o),'" width="',i(this.width,o),'" height="',i(this.height,o),`"></rect>
`)}},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(r),{reviver:r})},toClipPathSVG:function(r){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(r),{reviver:r})},_createBaseClipPathSVGMarkup:function(r,o){var t=(o=o||{}).reviver,e=o.additionalTransform||"",s=[this.getSvgTransform(!0,e),this.getSvgCommons()].join(""),l=r.indexOf("COMMON_PARTS");return r[l]=s,t?t(r.join("")):r.join("")},_createBaseSVGMarkup:function(r,o){var t,e,s=(o=o||{}).noStyle,l=o.reviver,a=s?"":'style="'+this.getSvgStyles()+'" ',h=o.withShadow?'style="'+this.getSvgFilter()+'" ':"",u=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",_=u&&u.absolutePositioned,y=this.stroke,v=this.fill,w=this.shadow,T=[],P=r.indexOf("COMMON_PARTS"),L=o.additionalTransform;return u&&(u.clipPathId="CLIPPATH_"+d.Object.__uid++,e='<clipPath id="'+u.clipPathId+`" >
`+u.toClipPathSVG(l)+`</clipPath>
`),_&&T.push("<g ",h,this.getSvgCommons(),` >
`),T.push("<g ",this.getSvgTransform(!1),_?"":h+this.getSvgCommons(),` >
`),t=[a,p,s?"":this.addPaintOrder()," ",L?'transform="'+L+'" ':""].join(""),r[P]=t,v&&v.toLive&&T.push(v.toSVG(this)),y&&y.toLive&&T.push(y.toSVG(this)),w&&T.push(w.toSVG(this)),u&&T.push(e),T.push(r.join("")),T.push(`</g>
`),_&&T.push(`</g>
`),l?l(T.join("")):T.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var n=d.util.object.extend,i="stateProperties";function r(t,e,s){var l={};s.forEach(function(a){l[a]=t[a]}),n(t[e],l,!0)}function o(t,e,s){if(t===e)return!0;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(var l=0,a=t.length;l<a;l++)if(!o(t[l],e[l]))return!1;return!0}if(t&&typeof t=="object"){var h,u=Object.keys(t);if(!e||typeof e!="object"||!s&&u.length!==Object.keys(e).length)return!1;for(l=0,a=u.length;l<a;l++)if((h=u[l])!=="canvas"&&h!=="group"&&!o(t[h],e[h]))return!1;return!0}}d.util.object.extend(d.Object.prototype,{hasStateChanged:function(t){var e="_"+(t=t||i);return Object.keys(this[e]).length<this[t].length||!o(this[e],this,!0)},saveState:function(t){var e=t&&t.propertySet||i,s="_"+e;return this[s]?(r(this,s,this[e]),t&&t.stateProperties&&r(this,s,t.stateProperties),this):this.setupState(t)},setupState:function(t){var e=(t=t||{}).propertySet||i;return t.propertySet=e,this["_"+e]={},this.saveState(t),this}})}(),function(){var n=d.util.degreesToRadians;d.util.object.extend(d.Object.prototype,{_findTargetCorner:function(i,r){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var o,t,e,s=i.x,l=i.y,a=Object.keys(this.oCoords),h=a.length-1;for(this.__corner=0;h>=0;h--)if(e=a[h],this.isControlVisible(e)&&(t=this._getImageLines(r?this.oCoords[e].touchCorner:this.oCoords[e].corner),(o=this._findCrossPoints({x:s,y:l},t))!==0&&o%2==1))return this.__corner=e,e;return!1},forEachControl:function(i){for(var r in this.controls)i(this.controls[r],r,this)},_setCornerCoords:function(){var i=this.oCoords;for(var r in i){var o=this.controls[r];i[r].corner=o.calcCornerCoords(this.angle,this.cornerSize,i[r].x,i[r].y,!1),i[r].touchCorner=o.calcCornerCoords(this.angle,this.touchCornerSize,i[r].x,i[r].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var r=this.getCenterPoint(),o=this._calculateCurrentDimensions(),t=this.canvas.viewportTransform;return i.translate(r.x,r.y),i.scale(1/t[0],1/t[3]),i.rotate(n(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-o.x/2,-o.y/2,o.x,o.y),i.restore(),this},drawBorders:function(i,r){r=r||{};var o=this._calculateCurrentDimensions(),t=this.borderScaleFactor,e=o.x+t,s=o.y+t,l=r.hasControls!==void 0?r.hasControls:this.hasControls,a=!1;return i.save(),i.strokeStyle=r.borderColor||this.borderColor,this._setLineDash(i,r.borderDashArray||this.borderDashArray),i.strokeRect(-e/2,-s/2,e,s),l&&(i.beginPath(),this.forEachControl(function(h,u,p){h.withConnection&&h.getVisibility(p,u)&&(a=!0,i.moveTo(h.x*e,h.y*s),i.lineTo(h.x*e+h.offsetX,h.y*s+h.offsetY))}),a&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,r,o){o=o||{};var t=d.util.sizeAfterTransform(this.width,this.height,r),e=this.strokeWidth,s=this.strokeUniform,l=this.borderScaleFactor,a=t.x+e*(s?this.canvas.getZoom():r.scaleX)+l,h=t.y+e*(s?this.canvas.getZoom():r.scaleY)+l;return i.save(),this._setLineDash(i,o.borderDashArray||this.borderDashArray),i.strokeStyle=o.borderColor||this.borderColor,i.strokeRect(-a/2,-h/2,a,h),i.restore(),this},drawControls:function(i,r){r=r||{},i.save();var o,t,e=this.canvas.getRetinaScaling();return i.setTransform(e,0,0,e,0,0),i.strokeStyle=i.fillStyle=r.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=r.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,r.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(o=this.group.calcTransformMatrix()),this.forEachControl(function(s,l,a){t=a.oCoords[l],s.getVisibility(a,l)&&(o&&(t=d.util.transformPoint(t,o)),s.render(i,t.x,t.y,r,a))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,r){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=r,this},setControlsVisibility:function(i){for(var r in i||(i={}),i)this.setControlVisible(r,i[r]);return this},onDeselect:function(){},onSelect:function(){}})}(),d.util.object.extend(d.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(s){n.set("left",s),e.requestRenderAll(),t()},onComplete:function(){n.setCoords(),o()}})},fxCenterObjectV:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(s){n.set("top",s),e.requestRenderAll(),t()},onComplete:function(){n.setCoords(),o()}})},fxRemove:function(n,i){var r=function(){},o=(i=i||{}).onComplete||r,t=i.onChange||r,e=this;return d.util.animate({target:this,startValue:n.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(s){n.set("opacity",s),e.requestRenderAll(),t()},onComplete:function(){e.remove(n),o()}})}}),d.util.object.extend(d.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var n,i,r=[],o=[];for(n in arguments[0])r.push(n);for(var t=0,e=r.length;t<e;t++)n=r[t],i=t!==e-1,o.push(this._animate(n,arguments[0][n],arguments[1],i));return o}return this._animate.apply(this,arguments)},_animate:function(n,i,r,o){var t,e=this;i=i.toString(),r=r?d.util.object.clone(r):{},~n.indexOf(".")&&(t=n.split("."));var s=e.colorProperties.indexOf(n)>-1||t&&e.colorProperties.indexOf(t[1])>-1,l=t?this.get(t[0])[t[1]]:this.get(n);"from"in r||(r.from=l),s||(i=~i.indexOf("=")?l+parseFloat(i.replace("=","")):parseFloat(i));var a={target:this,startValue:r.from,endValue:i,byValue:r.by,easing:r.easing,duration:r.duration,abort:r.abort&&function(h,u,p){return r.abort.call(e,h,u,p)},onChange:function(h,u,p){t?e[t[0]][t[1]]=h:e.set(n,h),o||r.onChange&&r.onChange(h,u,p)},onComplete:function(h,u,p){o||(e.setCoords(),r.onComplete&&r.onComplete(h,u,p))}};return s?d.util.animateColor(a.startValue,a.endValue,a.duration,a):d.util.animate(a)}}),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.object.clone,t={x1:1,x2:1,y1:1,y2:1};function e(s,l){var a=s.origin,h=s.axis1,u=s.axis2,p=s.dimension,_=l.nearest,y=l.center,v=l.farthest;return function(){switch(this.get(a)){case _:return Math.min(this.get(h),this.get(u));case y:return Math.min(this.get(h),this.get(u))+.5*this.get(p);case v:return Math.max(this.get(h),this.get(u))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(s,l){s||(s=[0,0,0,0]),this.callSuper("initialize",l),this.set("x1",s[0]),this.set("y1",s[1]),this.set("x2",s[2]),this.set("y2",s[3]),this._setWidthHeight(l)},_setWidthHeight:function(s){s||(s={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in s?s.left:this._getLeftToOriginX(),this.top="top"in s?s.top:this._getTopToOriginY()},_set:function(s,l){return this.callSuper("_set",s,l),t[s]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:e({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:e({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(s){s.beginPath();var l=this.calcLinePoints();s.moveTo(l.x1,l.y1),s.lineTo(l.x2,l.y2),s.lineWidth=this.strokeWidth;var a=s.strokeStyle;s.strokeStyle=this.stroke||s.fillStyle,this.stroke&&this._renderStroke(s),s.strokeStyle=a},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(s){return r(this.callSuper("toObject",s),this.calcLinePoints())},_getNonTransformedDimensions:function(){var s=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(s.y-=this.strokeWidth),this.height===0&&(s.x-=this.strokeWidth)),s},calcLinePoints:function(){var s=this.x1<=this.x2?-1:1,l=this.y1<=this.y2?-1:1,a=s*this.width*.5,h=l*this.height*.5;return{x1:a,x2:s*this.width*-.5,y1:h,y2:l*this.height*-.5}},_toSVG:function(){var s=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',s.x1,'" y1="',s.y1,'" x2="',s.x2,'" y2="',s.y2,`" />
`]}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(s,l,a){a=a||{};var h=i.parseAttributes(s,i.Line.ATTRIBUTE_NAMES),u=[h.x1||0,h.y1||0,h.x2||0,h.y2||0];l(new i.Line(u,r(h,a)))},i.Line.fromObject=function(s,l){var a=o(s,!0);a.points=[s.x1,s.y1,s.x2,s.y2],i.Object._fromObject("Line",a,function(h){delete h.points,l&&l(h)},"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(o,t){return this.callSuper("_set",o,t),o==="radius"&&this.setRadius(t),this},toObject:function(o){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(o))},_toSVG:function(){var o,t=(this.endAngle-this.startAngle)%360;if(t===0)o=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,`" />
`];else{var e=r(this.startAngle),s=r(this.endAngle),l=this.radius;o=['<path d="M '+i.util.cos(e)*l+" "+i.util.sin(e)*l," A "+l+" "+l," 0 ",+(t>180?"1":"0")+" 1"," "+i.util.cos(s)*l+" "+i.util.sin(s)*l,'" ',"COMMON_PARTS",` />
`]}return o},_render:function(o){o.beginPath(),o.arc(0,0,this.radius,r(this.startAngle),r(this.endAngle),!1),this._renderPaintInOrder(o)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(o){return this.radius=o,this.set("width",2*o).set("height",2*o)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(o,t){var e,s=i.parseAttributes(o,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(e=s)&&e.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");s.left=(s.left||0)-s.radius,s.top=(s.top||0)-s.radius,t(new i.Circle(s))},i.Circle.fromObject=function(o,t){i.Object._fromObject("Circle",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(r){var o=this.width/2,t=this.height/2;r.beginPath(),r.moveTo(-o,t),r.lineTo(0,-t),r.lineTo(o,t),r.closePath(),this._renderPaintInOrder(r)},_toSVG:function(){var r=this.width/2,o=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-r+" "+o,"0 "+-o,r+" "+o].join(","),'" />']}}),i.Triangle.fromObject=function(r,o){return i.Object._fromObject("Triangle",r,o)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this.set("rx",o&&o.rx||0),this.set("ry",o&&o.ry||0)},_set:function(o,t){switch(this.callSuper("_set",o,t),o){case"rx":this.rx=t,this.set("width",2*t);break;case"ry":this.ry=t,this.set("height",2*t)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(o){o.beginPath(),o.save(),o.transform(1,0,0,this.ry/this.rx,0,0),o.arc(0,0,this.rx,0,r,!1),o.restore(),this._renderPaintInOrder(o)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(o,t){var e=i.parseAttributes(o,i.Ellipse.ATTRIBUTE_NAMES);e.left=(e.left||0)-e.rx,e.top=(e.top||0)-e.ry,t(new i.Ellipse(e))},i.Ellipse.fromObject=function(o,t){i.Object._fromObject("Ellipse",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(o){this.callSuper("initialize",o),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(o){var t=this.rx?Math.min(this.rx,this.width/2):0,e=this.ry?Math.min(this.ry,this.height/2):0,s=this.width,l=this.height,a=-this.width/2,h=-this.height/2,u=t!==0||e!==0,p=.4477152502;o.beginPath(),o.moveTo(a+t,h),o.lineTo(a+s-t,h),u&&o.bezierCurveTo(a+s-p*t,h,a+s,h+p*e,a+s,h+e),o.lineTo(a+s,h+l-e),u&&o.bezierCurveTo(a+s,h+l-p*e,a+s-p*t,h+l,a+s-t,h+l),o.lineTo(a+t,h+l),u&&o.bezierCurveTo(a+p*t,h+l,a,h+l-p*e,a,h+l-e),o.lineTo(a,h+e),u&&o.bezierCurveTo(a,h+p*e,a+p*t,h,a+t,h),o.closePath(),this._renderPaintInOrder(o)},toObject:function(o){return this.callSuper("toObject",["rx","ry"].concat(o))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(o,t,e){if(!o)return t(null);e=e||{};var s=i.parseAttributes(o,i.Rect.ATTRIBUTE_NAMES);s.left=s.left||0,s.top=s.top||0,s.height=s.height||0,s.width=s.width||0;var l=new i.Rect(r(e?i.util.object.clone(e):{},s));l.visible=l.visible&&l.width>0&&l.height>0,t(l)},i.Rect.fromObject=function(o,t){return i.Object._fromObject("Rect",o,t)})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.util.array.min,t=i.util.array.max,e=i.util.toFixed,s=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(l,a){a=a||{},this.points=l||[],this.callSuper("initialize",a),this._setPositionDimensions(a)},_projectStrokeOnPoints:function(){return s(this.points,this,!0)},_setPositionDimensions:function(l){var a,h=this._calcDimensions(l),u=this.exactBoundingBox?this.strokeWidth:0;this.width=h.width-u,this.height=h.height-u,l.fromSVG||(a=this.translateToGivenOrigin({x:h.left-this.strokeWidth/2+u/2,y:h.top-this.strokeWidth/2+u/2},"left","top",this.originX,this.originY)),l.left===void 0&&(this.left=l.fromSVG?h.left:a.x),l.top===void 0&&(this.top=l.fromSVG?h.top:a.y),this.pathOffset={x:h.left+this.width/2+u/2,y:h.top+this.height/2+u/2}},_calcDimensions:function(){var l=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,a=o(l,"x")||0,h=o(l,"y")||0;return{left:a,top:h,width:(t(l,"x")||0)-a,height:(t(l,"y")||0)-h}},toObject:function(l){return r(this.callSuper("toObject",l),{points:this.points.concat()})},_toSVG:function(){for(var l=[],a=this.pathOffset.x,h=this.pathOffset.y,u=i.Object.NUM_FRACTION_DIGITS,p=0,_=this.points.length;p<_;p++)l.push(e(this.points[p].x-a,u),",",e(this.points[p].y-h,u)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',l.join(""),`" />
`]},commonRender:function(l){var a,h=this.points.length,u=this.pathOffset.x,p=this.pathOffset.y;if(!h||isNaN(this.points[h-1].y))return!1;l.beginPath(),l.moveTo(this.points[0].x-u,this.points[0].y-p);for(var _=0;_<h;_++)a=this.points[_],l.lineTo(a.x-u,a.y-p);return!0},_render:function(l){this.commonRender(l)&&this._renderPaintInOrder(l)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(l){return function(a,h,u){if(!a)return h(null);u||(u={});var p=i.parsePointsAttribute(a.getAttribute("points")),_=i.parseAttributes(a,i[l].ATTRIBUTE_NAMES);_.fromSVG=!0,h(new i[l](p,r(_,u)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(l,a){return i.Object._fromObject("Polyline",l,a,"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return r(this.points,this)},_render:function(o){this.commonRender(o)&&(o.closePath(),this._renderPaintInOrder(o))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(o,t){i.Object._fromObject("Polygon",o,t,"points")})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.array.min,o=i.util.array.max,t=i.util.object.extend,e=i.util.object.clone,s=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(l,a){delete(a=e(a||{})).path,this.callSuper("initialize",a),this._setPath(l||[],a)},_setPath:function(l,a){this.path=i.util.makePathSimpler(Array.isArray(l)?l:i.util.parsePath(l)),i.Polyline.prototype._setPositionDimensions.call(this,a||{})},_renderPathCommands:function(l){var a,h=0,u=0,p=0,_=0,y=0,v=0,w=-this.pathOffset.x,T=-this.pathOffset.y;l.beginPath();for(var P=0,L=this.path.length;P<L;++P)switch((a=this.path[P])[0]){case"L":p=a[1],_=a[2],l.lineTo(p+w,_+T);break;case"M":h=p=a[1],u=_=a[2],l.moveTo(p+w,_+T);break;case"C":p=a[5],_=a[6],y=a[3],v=a[4],l.bezierCurveTo(a[1]+w,a[2]+T,y+w,v+T,p+w,_+T);break;case"Q":l.quadraticCurveTo(a[1]+w,a[2]+T,a[3]+w,a[4]+T),p=a[3],_=a[4],y=a[1],v=a[2];break;case"z":case"Z":p=h,_=u,l.closePath()}},_render:function(l){this._renderPathCommands(l),this._renderPaintInOrder(l)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(l){return t(this.callSuper("toObject",l),{path:this.path.map(function(a){return a.slice()})})},toDatalessObject:function(l){var a=this.toObject(["sourcePath"].concat(l));return a.sourcePath&&delete a.path,a},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var l=i.Object.NUM_FRACTION_DIGITS;return" translate("+s(-this.pathOffset.x,l)+", "+s(-this.pathOffset.y,l)+")"},toClipPathSVG:function(l){var a=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:l,additionalTransform:a})},toSVG:function(l){var a=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:l,additionalTransform:a})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var l,a,h=[],u=[],p=0,_=0,y=0,v=0,w=0,T=this.path.length;w<T;++w){switch((l=this.path[w])[0]){case"L":y=l[1],v=l[2],a=[];break;case"M":p=y=l[1],_=v=l[2],a=[];break;case"C":a=i.util.getBoundsOfCurve(y,v,l[1],l[2],l[3],l[4],l[5],l[6]),y=l[5],v=l[6];break;case"Q":a=i.util.getBoundsOfCurve(y,v,l[1],l[2],l[1],l[2],l[3],l[4]),y=l[3],v=l[4];break;case"z":case"Z":y=p,v=_}a.forEach(function(W){h.push(W.x),u.push(W.y)}),h.push(y),u.push(v)}var P=r(h)||0,L=r(u)||0;return{left:P,top:L,width:(o(h)||0)-P,height:(o(u)||0)-L}}}),i.Path.fromObject=function(l,a){if(typeof l.sourcePath=="string"){var h=l.sourcePath;i.loadSVGFromURL(h,function(u){var p=u[0];p.setOptions(l),a&&a(p)})}else i.Object._fromObject("Path",l,a,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(l,a,h){var u=i.parseAttributes(l,i.Path.ATTRIBUTE_NAMES);u.fromSVG=!0,a(new i.Path(u.d,t(u,h)))})}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.array.min,o=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(t,e,s){e=e||{},this._objects=[],s&&this.callSuper("initialize",e),this._objects=t||[];for(var l=this._objects.length;l--;)this._objects[l].group=this;if(s)this._updateObjectsACoords();else{var a=e&&e.centerPoint;e.originX!==void 0&&(this.originX=e.originX),e.originY!==void 0&&(this.originY=e.originY),a||this._calcBounds(),this._updateObjectsCoords(a),delete e.centerPoint,this.callSuper("initialize",e)}this.setCoords()},_updateObjectsACoords:function(){for(var t=this._objects.length;t--;)this._objects[t].setCoords(!0)},_updateObjectsCoords:function(t){t=t||this.getCenterPoint();for(var e=this._objects.length;e--;)this._updateObjectCoords(this._objects[e],t)},_updateObjectCoords:function(t,e){var s=t.left,l=t.top;t.set({left:s-e.x,top:l-e.y}),t.group=this,t.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(t){var e=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),t&&(e&&i.util.removeTransformFromObject(t,this.group.calcTransformMatrix()),this._objects.push(t),t.group=this,t._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,e?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(t){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(t),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(t){this.dirty=!0,t.group=this,t._set("canvas",this.canvas)},_onObjectRemoved:function(t){this.dirty=!0,delete t.group},_set:function(t,e){var s=this._objects.length;if(this.useSetOnGroup)for(;s--;)this._objects[s].setOnGroup(t,e);if(t==="canvas")for(;s--;)this._objects[s]._set(t,e);i.Object.prototype._set.call(this,t,e)},toObject:function(t){var e=this.includeDefaultValues,s=this._objects.filter(function(a){return!a.excludeFromExport}).map(function(a){var h=a.includeDefaultValues;a.includeDefaultValues=e;var u=a.toObject(t);return a.includeDefaultValues=h,u}),l=i.Object.prototype.toObject.call(this,t);return l.objects=s,l},toDatalessObject:function(t){var e,s=this.sourcePath;if(s)e=s;else{var l=this.includeDefaultValues;e=this._objects.map(function(h){var u=h.includeDefaultValues;h.includeDefaultValues=l;var p=h.toDatalessObject(t);return h.includeDefaultValues=u,p})}var a=i.Object.prototype.toDatalessObject.call(this,t);return a.objects=e,a},render:function(t){this._transformDone=!0,this.callSuper("render",t),this._transformDone=!1},shouldCache:function(){var t=i.Object.prototype.shouldCache.call(this);if(t){for(var e=0,s=this._objects.length;e<s;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var t=0,e=this._objects.length;t<e;t++)if(this._objects[t].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(t){for(var e=0,s=this._objects.length;e<s;e++)this._objects[e].render(t);this._drawClipPath(t,this.clipPath)},isCacheDirty:function(t){if(this.callSuper("isCacheDirty",t))return!0;if(!this.statefullCache)return!1;for(var e=0,s=this._objects.length;e<s;e++)if(this._objects[e].isCacheDirty(!0)){if(this._cacheCanvas){var l=this.cacheWidth/this.zoomX,a=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-l/2,-a/2,l,a)}return!0}return!1},_restoreObjectsState:function(){var t=this.calcOwnMatrix();return this._objects.forEach(function(e){i.util.addTransformToObject(e,t),delete e.group,e.setCoords()}),this},destroy:function(){return this._objects.forEach(function(t){t.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(t){t.dispose&&t.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var t=this._objects,e=this.canvas;this._objects=[];var s=this.toObject();delete s.objects;var l=new i.ActiveSelection([]);return l.set(s),l.type="activeSelection",e.remove(this),t.forEach(function(a){a.group=l,a.dirty=!0,e.add(a)}),l.canvas=e,l._objects=t,e._activeObject=l,l.setCoords(),l}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(t){t.setCoords(!0)}),this},_calcBounds:function(t){for(var e,s,l,a,h=[],u=[],p=["tr","br","bl","tl"],_=0,y=this._objects.length,v=p.length;_<y;++_){for(l=(e=this._objects[_]).calcACoords(),a=0;a<v;a++)s=p[a],h.push(l[s].x),u.push(l[s].y);e.aCoords=l}this._getBounds(h,u,t)},_getBounds:function(t,e,s){var l=new i.Point(r(t),r(e)),a=new i.Point(o(t),o(e)),h=l.y||0,u=l.x||0,p=a.x-l.x||0,_=a.y-l.y||0;this.width=p,this.height=_,s||this.setPositionByOrigin({x:u,y:h},"left","top")},_toSVG:function(t){for(var e=["<g ","COMMON_PARTS",` >
`],s=0,l=this._objects.length;s<l;s++)e.push("		",this._objects[s].toSVG(t));return e.push(`</g>
`),e},getSvgStyles:function(){var t=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")},toClipPathSVG:function(t){for(var e=[],s=0,l=this._objects.length;s<l;s++)e.push("	",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}}),i.Group.fromObject=function(t,e){var s=t.objects,l=i.util.object.clone(t,!0);delete l.objects,typeof s!="string"?i.util.enlivenObjects(s,function(a){var h=i.util.object.clone(t,!0);delete h.objects,i.util.enlivenObjectEnlivables(t,h,function(){e&&e(new i.Group(a,h,!0))})}):i.loadSVGFromURL(s,function(a){var h=i.util.groupSVGElements(a,t,s);h.set(l),e&&e(h)})})}(c),function(n){var i=n.fabric||(n.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(r,o){o=o||{},this._objects=r||[];for(var t=this._objects.length;t--;)this._objects[t].group=this;o.originX&&(this.originX=o.originX),o.originY&&(this.originY=o.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,o),this.setCoords()},toGroup:function(){var r=this._objects.concat();this._objects=[];var o=i.Object.prototype.toObject.call(this),t=new i.Group([]);if(delete o.type,t.set(o),r.forEach(function(s){s.canvas.remove(s),s.group=t}),t._objects=r,!this.canvas)return t;var e=this.canvas;return e.add(t),e._activeObject=t,t.setCoords(),t},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(r,o,t){r.save(),r.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",r,o),(t=t||{}).hasControls===void 0&&(t.hasControls=!1),t.forActiveSelection=!0;for(var e=0,s=this._objects.length;e<s;e++)this._objects[e]._renderControls(r,t);r.restore()}}),i.ActiveSelection.fromObject=function(r,o){i.util.enlivenObjects(r.objects,function(t){delete r.objects,o&&o(new i.ActiveSelection(t,r,!0))})})}(c),function(n){var i=d.util.object.extend;n.fabric||(n.fabric={}),n.fabric.Image?d.warn("fabric.Image is already defined."):(d.Image=d.util.createClass(d.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:d.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:d.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(r,o){o||(o={}),this.filters=[],this.cacheKey="texture"+d.Object.__uid++,this.callSuper("initialize",o),this._initElement(r,o)},getElement:function(){return this._element||{}},setElement:function(r,o){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=r,this._originalElement=r,this._initConfig(o),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(r){var o=d.filterBackend;o&&o.evictCachesForKey&&o.evictCachesForKey(r)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(r){d.util.cleanUpJsdomNode(this[r]),this[r]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var r=this.getElement();return{width:r.naturalWidth||r.width,height:r.naturalHeight||r.height}},_stroke:function(r){if(this.stroke&&this.strokeWidth!==0){var o=this.width/2,t=this.height/2;r.beginPath(),r.moveTo(-o,-t),r.lineTo(o,-t),r.lineTo(o,t),r.lineTo(-o,t),r.lineTo(-o,-t),r.closePath()}},toObject:function(r){var o=[];this.filters.forEach(function(e){e&&o.push(e.toObject())});var t=i(this.callSuper("toObject",["cropX","cropY"].concat(r)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:o});return this.resizeFilter&&(t.resizeFilter=this.resizeFilter.toObject()),t},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var r,o=[],t=[],e=this._element,s=-this.width/2,l=-this.height/2,a="",h="";if(!e)return[];if(this.hasCrop()){var u=d.Object.__uid++;o.push('<clipPath id="imageCrop_'+u+`">
`,'	<rect x="'+s+'" y="'+l+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),a=' clip-path="url(#imageCrop_'+u+')" '}if(this.imageSmoothing||(h='" image-rendering="optimizeSpeed'),t.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',s-this.cropX,'" y="',l-this.cropY,'" width="',e.width||e.naturalWidth,'" height="',e.height||e.height,h,'"',a,`></image>
`),this.stroke||this.strokeDashArray){var p=this.fill;this.fill=null,r=["	<rect ",'x="',s,'" y="',l,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=p}return this.paintFirst!=="fill"?o.concat(r,t):o.concat(t,r)},getSrc:function(r){var o=r?this._element:this._originalElement;return o?o.toDataURL?o.toDataURL():this.srcFromAttribute?o.getAttribute("src"):o.src:this.src||""},setSrc:function(r,o,t){return d.util.loadImage(r,function(e,s){this.setElement(e,t),this._setWidthHeight(),o&&o(this,s)},this,t&&t.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var r=this.resizeFilter,o=this.minimumScaleTrigger,t=this.getTotalObjectScaling(),e=t.scaleX,s=t.scaleY,l=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!r||e>o&&s>o)return this._element=l,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=e,void(this._lastScaleY=s);d.filterBackend||(d.filterBackend=d.initFilterBackend());var a=d.util.createCanvasElement(),h=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,u=l.width,p=l.height;a.width=u,a.height=p,this._element=a,this._lastScaleX=r.scaleX=e,this._lastScaleY=r.scaleY=s,d.filterBackend.applyFilters([r],l,u,p,this._element,h),this._filterScalingX=a.width/this._originalElement.width,this._filterScalingY=a.height/this._originalElement.height},applyFilters:function(r){if(r=(r=r||this.filters||[]).filter(function(l){return l&&!l.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),r.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var o=this._originalElement,t=o.naturalWidth||o.width,e=o.naturalHeight||o.height;if(this._element===this._originalElement){var s=d.util.createCanvasElement();s.width=t,s.height=e,this._element=s,this._filteredEl=s}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,t,e),this._lastScaleX=1,this._lastScaleY=1;return d.filterBackend||(d.filterBackend=d.initFilterBackend()),d.filterBackend.applyFilters(r,this._originalElement,t,e,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(r){d.util.setImageSmoothing(r,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(r),this._renderPaintInOrder(r)},drawCacheOnCanvas:function(r){d.util.setImageSmoothing(r,this.imageSmoothing),d.Object.prototype.drawCacheOnCanvas.call(this,r)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(r){var o=this._element;if(o){var t=this._filterScalingX,e=this._filterScalingY,s=this.width,l=this.height,a=Math.min,h=Math.max,u=h(this.cropX,0),p=h(this.cropY,0),_=o.naturalWidth||o.width,y=o.naturalHeight||o.height,v=u*t,w=p*e,T=a(s*t,_-v),P=a(l*e,y-w),L=-s/2,W=-l/2,N=a(s,_/t-u),B=a(l,y/e-p);o&&r.drawImage(o,v,w,T,P,L,W,N,B)}},_needsResize:function(){var r=this.getTotalObjectScaling();return r.scaleX!==this._lastScaleX||r.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(r,o){this.setElement(d.util.getById(r),o),d.util.addClass(this.getElement(),d.Image.CSS_CANVAS)},_initConfig:function(r){r||(r={}),this.setOptions(r),this._setWidthHeight(r)},_initFilters:function(r,o){r&&r.length?d.util.enlivenObjects(r,function(t){o&&o(t)},"fabric.Image.filters"):o&&o()},_setWidthHeight:function(r){r||(r={});var o=this.getElement();this.width=r.width||o.naturalWidth||o.width||0,this.height=r.height||o.naturalHeight||o.height||0},parsePreserveAspectRatioAttribute:function(){var r,o=d.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),t=this._element.width,e=this._element.height,s=1,l=1,a=0,h=0,u=0,p=0,_=this.width,y=this.height,v={width:_,height:y};return!o||o.alignX==="none"&&o.alignY==="none"?(s=_/t,l=y/e):(o.meetOrSlice==="meet"&&(r=(_-t*(s=l=d.util.findScaleToFit(this._element,v)))/2,o.alignX==="Min"&&(a=-r),o.alignX==="Max"&&(a=r),r=(y-e*l)/2,o.alignY==="Min"&&(h=-r),o.alignY==="Max"&&(h=r)),o.meetOrSlice==="slice"&&(r=t-_/(s=l=d.util.findScaleToCover(this._element,v)),o.alignX==="Mid"&&(u=r/2),o.alignX==="Max"&&(u=r),r=e-y/l,o.alignY==="Mid"&&(p=r/2),o.alignY==="Max"&&(p=r),t=_/s,e=y/l)),{width:t,height:e,scaleX:s,scaleY:l,offsetLeft:a,offsetTop:h,cropX:u,cropY:p}}}),d.Image.CSS_CANVAS="canvas-img",d.Image.prototype.getSvgSrc=d.Image.prototype.getSrc,d.Image.fromObject=function(r,o){var t=d.util.object.clone(r);d.util.loadImage(t.src,function(e,s){s?o&&o(null,!0):d.Image.prototype._initFilters.call(t,t.filters,function(l){t.filters=l||[],d.Image.prototype._initFilters.call(t,[t.resizeFilter],function(a){t.resizeFilter=a[0],d.util.enlivenObjectEnlivables(t,t,function(){var h=new d.Image(e,t);o(h,!1)})})})},null,t.crossOrigin)},d.Image.fromURL=function(r,o,t){d.util.loadImage(r,function(e,s){o&&o(new d.Image(e,t),s)},null,t&&t.crossOrigin)},d.Image.ATTRIBUTE_NAMES=d.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),d.Image.fromElement=function(r,o,t){var e=d.parseAttributes(r,d.Image.ATTRIBUTE_NAMES);d.Image.fromURL(e["xlink:href"],o,i(t?d.util.object.clone(t):{},e))})}(c),d.util.object.extend(d.Object.prototype,{_getAngleValueForStraighten:function(){var n=this.angle%360;return n>0?90*Math.round((n-1)/90):90*Math.round(n/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(n){var i=function(){},r=(n=n||{}).onComplete||i,o=n.onChange||i,t=this;return d.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(e){t.rotate(e),o()},onComplete:function(){t.setCoords(),r()}})}}),d.util.object.extend(d.StaticCanvas.prototype,{straightenObject:function(n){return n.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(n){return n.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function n(r,o){var t="precision "+o+` float;
void main(){}`,e=r.createShader(r.FRAGMENT_SHADER);return r.shaderSource(e,t),r.compileShader(e),!!r.getShaderParameter(e,r.COMPILE_STATUS)}function i(r){r&&r.tileSize&&(this.tileSize=r.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}d.isWebglSupported=function(r){if(d.isLikelyNode)return!1;r=r||d.WebglFilterBackend.prototype.tileSize;var o=document.createElement("canvas"),t=o.getContext("webgl")||o.getContext("experimental-webgl"),e=!1;if(t){d.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),e=d.maxTextureSize>=r;for(var s=["highp","mediump","lowp"],l=0;l<3;l++)if(n(t,s[l])){d.webGlPrecision=s[l];break}}return this.isSupported=e,e},d.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(r,o){this.dispose(),this.createWebGLCanvas(r,o),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(r,o)},chooseFastestCopyGLTo2DMethod:function(r,o){var t,e=window.performance!==void 0;try{new ImageData(1,1),t=!0}catch{t=!1}var s=typeof ArrayBuffer<"u",l=typeof Uint8ClampedArray<"u";if(e&&t&&s&&l){var a=d.util.createCanvasElement(),h=new ArrayBuffer(r*o*4);if(d.forceGLPutImageData)return this.imageBuffer=h,void(this.copyGLTo2D=It);var u,p,_={imageBuffer:h,destinationWidth:r,destinationHeight:o,targetCanvas:a};a.width=r,a.height=o,u=window.performance.now(),Ct.call(_,this.gl,_),p=window.performance.now()-u,u=window.performance.now(),It.call(_,this.gl,_),p>window.performance.now()-u?(this.imageBuffer=h,this.copyGLTo2D=It):this.copyGLTo2D=Ct}},createWebGLCanvas:function(r,o){var t=d.util.createCanvasElement();t.width=r,t.height=o;var e={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},s=t.getContext("webgl",e);s||(s=t.getContext("experimental-webgl",e)),s&&(s.clearColor(0,0,0,0),this.canvas=t,this.gl=s)},applyFilters:function(r,o,t,e,s,l){var a,h=this.gl;l&&(a=this.getCachedTexture(l,o));var u={originalWidth:o.width||o.originalWidth,originalHeight:o.height||o.originalHeight,sourceWidth:t,sourceHeight:e,destinationWidth:t,destinationHeight:e,context:h,sourceTexture:this.createTexture(h,t,e,!a&&o),targetTexture:this.createTexture(h,t,e),originalTexture:a||this.createTexture(h,t,e,!a&&o),passes:r.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:s},p=h.createFramebuffer();return h.bindFramebuffer(h.FRAMEBUFFER,p),r.forEach(function(_){_&&_.applyTo(u)}),function(_){var y=_.targetCanvas,v=y.width,w=y.height,T=_.destinationWidth,P=_.destinationHeight;v===T&&w===P||(y.width=T,y.height=P)}(u),this.copyGLTo2D(h,u),h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(u.sourceTexture),h.deleteTexture(u.targetTexture),h.deleteFramebuffer(p),s.getContext("2d").setTransform(1,0,0,1,0,0),u},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(r,o,t,e){var s=r.createTexture();return r.bindTexture(r.TEXTURE_2D,s),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),e?r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,t,0,r.RGBA,r.UNSIGNED_BYTE,null),s},getCachedTexture:function(r,o){if(this.textureCache[r])return this.textureCache[r];var t=this.createTexture(this.gl,o.width,o.height,o);return this.textureCache[r]=t,t},evictCachesForKey:function(r){this.textureCache[r]&&(this.gl.deleteTexture(this.textureCache[r]),delete this.textureCache[r])},copyGLTo2D:Ct,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var r=this.gl,o={renderer:"",vendor:""};if(!r)return o;var t=r.getExtension("WEBGL_debug_renderer_info");if(t){var e=r.getParameter(t.UNMASKED_RENDERER_WEBGL),s=r.getParameter(t.UNMASKED_VENDOR_WEBGL);e&&(o.renderer=e.toLowerCase()),s&&(o.vendor=s.toLowerCase())}return this.gpuInfo=o,o}}}(),function(){var n=function(){};function i(){}d.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:n,dispose:n,clearWebGLCaches:n,resources:{},applyFilters:function(r,o,t,e,s){var l=s.getContext("2d");l.drawImage(o,0,0,t,e);var a={sourceWidth:t,sourceHeight:e,imageData:l.getImageData(0,0,t,e),originalEl:o,originalImageData:l.getImageData(0,0,t,e),canvasEl:s,ctx:l,filterBackend:this};return r.forEach(function(h){h.applyTo(a)}),a.imageData.width===t&&a.imageData.height===e||(s.width=a.imageData.width,s.height=a.imageData.height),l.putImageData(a.imageData,0,0),a}}}(),d.Image=d.Image||{},d.Image.filters=d.Image.filters||{},d.Image.filters.BaseFilter=d.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(n){n&&this.setOptions(n)},setOptions:function(n){for(var i in n)this[i]=n[i]},createProgram:function(n,i,r){i=i||this.fragmentSource,r=r||this.vertexSource,d.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+d.webGlPrecision+" float"));var o=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(o,r),n.compileShader(o),!n.getShaderParameter(o,n.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+n.getShaderInfoLog(o));var t=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(t,i),n.compileShader(t),!n.getShaderParameter(t,n.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+n.getShaderInfoLog(t));var e=n.createProgram();if(n.attachShader(e,o),n.attachShader(e,t),n.linkProgram(e),!n.getProgramParameter(e,n.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+n.getProgramInfoLog(e));var s=this.getAttributeLocations(n,e),l=this.getUniformLocations(n,e)||{};return l.uStepW=n.getUniformLocation(e,"uStepW"),l.uStepH=n.getUniformLocation(e,"uStepH"),{program:e,attributeLocations:s,uniformLocations:l}},getAttributeLocations:function(n,i){return{aPosition:n.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(n,i,r){var o=i.aPosition,t=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,t),n.enableVertexAttribArray(o),n.vertexAttribPointer(o,2,n.FLOAT,!1,0,0),n.bufferData(n.ARRAY_BUFFER,r,n.STATIC_DRAW)},_setupFrameBuffer:function(n){var i,r,o=n.context;n.passes>1?(i=n.destinationWidth,r=n.destinationHeight,n.sourceWidth===i&&n.sourceHeight===r||(o.deleteTexture(n.targetTexture),n.targetTexture=n.filterBackend.createTexture(o,i,r)),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,n.targetTexture,0)):(o.bindFramebuffer(o.FRAMEBUFFER,null),o.finish())},_swapTextures:function(n){n.passes--,n.pass++;var i=n.targetTexture;n.targetTexture=n.sourceTexture,n.sourceTexture=i},isNeutralState:function(){var n=this.mainParameter,i=d.Image.filters[this.type].prototype;if(n){if(Array.isArray(i[n])){for(var r=i[n].length;r--;)if(this[n][r]!==i[n][r])return!1;return!0}return i[n]===this[n]}return!1},applyTo:function(n){n.webgl?(this._setupFrameBuffer(n),this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},retrieveShader:function(n){return n.programCache.hasOwnProperty(this.type)||(n.programCache[this.type]=this.createProgram(n.context)),n.programCache[this.type]},applyToWebGL:function(n){var i=n.context,r=this.retrieveShader(n);n.pass===0&&n.originalTexture?i.bindTexture(i.TEXTURE_2D,n.originalTexture):i.bindTexture(i.TEXTURE_2D,n.sourceTexture),i.useProgram(r.program),this.sendAttributeData(i,r.attributeLocations,n.aPosition),i.uniform1f(r.uniformLocations.uStepW,1/n.sourceWidth),i.uniform1f(r.uniformLocations.uStepH,1/n.sourceHeight),this.sendUniformData(i,r.uniformLocations),i.viewport(0,0,n.destinationWidth,n.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(n,i,r){n.activeTexture(r),n.bindTexture(n.TEXTURE_2D,i),n.activeTexture(n.TEXTURE0)},unbindAdditionalTexture:function(n,i){n.activeTexture(i),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(n){this[this.mainParameter]=n},sendUniformData:function(){},createHelpLayer:function(n){if(!n.helpLayer){var i=document.createElement("canvas");i.width=n.sourceWidth,i.height=n.sourceHeight,n.helpLayer=i}},toObject:function(){var n={type:this.type},i=this.mainParameter;return i&&(n[i]=this[i]),n},toJSON:function(){return this.toObject()}}),d.Image.filters.BaseFilter.fromObject=function(n,i){var r=new d.Image.filters[n.type](n);return i&&i(r),r},function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.ColorMatrix=o(r.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(t){this.callSuper("initialize",t),this.matrix=this.matrix.slice(0)},applyTo2d:function(t){var e,s,l,a,h,u=t.imageData.data,p=u.length,_=this.matrix,y=this.colorsOnly;for(h=0;h<p;h+=4)e=u[h],s=u[h+1],l=u[h+2],y?(u[h]=e*_[0]+s*_[1]+l*_[2]+255*_[4],u[h+1]=e*_[5]+s*_[6]+l*_[7]+255*_[9],u[h+2]=e*_[10]+s*_[11]+l*_[12]+255*_[14]):(a=u[h+3],u[h]=e*_[0]+s*_[1]+l*_[2]+a*_[3]+255*_[4],u[h+1]=e*_[5]+s*_[6]+l*_[7]+a*_[8]+255*_[9],u[h+2]=e*_[10]+s*_[11]+l*_[12]+a*_[13]+255*_[14],u[h+3]=e*_[15]+s*_[16]+l*_[17]+a*_[18]+255*_[19])},getUniformLocations:function(t,e){return{uColorMatrix:t.getUniformLocation(e,"uColorMatrix"),uConstants:t.getUniformLocation(e,"uConstants")}},sendUniformData:function(t,e){var s=this.matrix,l=[s[0],s[1],s[2],s[3],s[5],s[6],s[7],s[8],s[10],s[11],s[12],s[13],s[15],s[16],s[17],s[18]],a=[s[4],s[9],s[14],s[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,l),t.uniform4fv(e.uConstants,a)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Brightness=o(r.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(t){if(this.brightness!==0){var e,s=t.imageData.data,l=s.length,a=Math.round(255*this.brightness);for(e=0;e<l;e+=4)s[e]=s[e]+a,s[e+1]=s[e+1]+a,s[e+2]=s[e+2]+a}},getUniformLocations:function(t,e){return{uBrightness:t.getUniformLocation(e,"uBrightness")}},sendUniformData:function(t,e){t.uniform1f(e.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.Convolute=t(o.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(e){var s=Math.sqrt(this.matrix.length),l=this.type+"_"+s+"_"+(this.opaque?1:0),a=this.fragmentSource[l];return e.programCache.hasOwnProperty(l)||(e.programCache[l]=this.createProgram(e.context,a)),e.programCache[l]},applyTo2d:function(e){var s,l,a,h,u,p,_,y,v,w,T,P,L,W=e.imageData,N=W.data,B=this.matrix,D=Math.round(Math.sqrt(B.length)),A=Math.floor(D/2),k=W.width,G=W.height,H=e.ctx.createImageData(k,G),M=H.data,I=this.opaque?1:0;for(T=0;T<G;T++)for(w=0;w<k;w++){for(u=4*(T*k+w),s=0,l=0,a=0,h=0,L=0;L<D;L++)for(P=0;P<D;P++)p=w+P-A,(_=T+L-A)<0||_>=G||p<0||p>=k||(y=4*(_*k+p),v=B[L*D+P],s+=N[y]*v,l+=N[y+1]*v,a+=N[y+2]*v,I||(h+=N[y+3]*v));M[u]=s,M[u+1]=l,M[u+2]=a,M[u+3]=I?N[u+3]:h}e.imageData=H},getUniformLocations:function(e,s){return{uMatrix:e.getUniformLocation(s,"uMatrix"),uOpaque:e.getUniformLocation(s,"uOpaque"),uHalfSize:e.getUniformLocation(s,"uHalfSize"),uSize:e.getUniformLocation(s,"uSize")}},sendUniformData:function(e,s){e.uniform1fv(s.uMatrix,this.matrix)},toObject:function(){return r(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Grayscale=o(r.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(t){var e,s,l=t.imageData.data,a=l.length,h=this.mode;for(e=0;e<a;e+=4)h==="average"?s=(l[e]+l[e+1]+l[e+2])/3:h==="lightness"?s=(Math.min(l[e],l[e+1],l[e+2])+Math.max(l[e],l[e+1],l[e+2]))/2:h==="luminosity"&&(s=.21*l[e]+.72*l[e+1]+.07*l[e+2]),l[e]=s,l[e+1]=s,l[e+2]=s},retrieveShader:function(t){var e=this.type+"_"+this.mode;if(!t.programCache.hasOwnProperty(e)){var s=this.fragmentSource[this.mode];t.programCache[e]=this.createProgram(t.context,s)}return t.programCache[e]},getUniformLocations:function(t,e){return{uMode:t.getUniformLocation(e,"uMode")}},sendUniformData:function(t,e){t.uniform1i(e.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Invert=o(r.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(t){var e,s=t.imageData.data,l=s.length;for(e=0;e<l;e+=4)s[e]=255-s[e],s[e+1]=255-s[e+1],s[e+2]=255-s[e+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(t,e){return{uInvert:t.getUniformLocation(e,"uInvert")}},sendUniformData:function(t,e){t.uniform1i(e.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.Noise=t(o.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(e){if(this.noise!==0){var s,l,a=e.imageData.data,h=a.length,u=this.noise;for(s=0,h=a.length;s<h;s+=4)l=(.5-Math.random())*u,a[s]+=l,a[s+1]+=l,a[s+2]+=l}},getUniformLocations:function(e,s){return{uNoise:e.getUniformLocation(s,"uNoise"),uSeed:e.getUniformLocation(s,"uSeed")}},sendUniformData:function(e,s){e.uniform1f(s.uNoise,this.noise/255),e.uniform1f(s.uSeed,Math.random())},toObject:function(){return r(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Pixelate=o(r.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(t){var e,s,l,a,h,u,p,_,y,v,w,T=t.imageData,P=T.data,L=T.height,W=T.width;for(s=0;s<L;s+=this.blocksize)for(l=0;l<W;l+=this.blocksize)for(a=P[e=4*s*W+4*l],h=P[e+1],u=P[e+2],p=P[e+3],v=Math.min(s+this.blocksize,L),w=Math.min(l+this.blocksize,W),_=s;_<v;_++)for(y=l;y<w;y++)P[e=4*_*W+4*y]=a,P[e+1]=h,P[e+2]=u,P[e+3]=p},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(t,e){return{uBlocksize:t.getUniformLocation(e,"uBlocksize"),uStepW:t.getUniformLocation(e,"uStepW"),uStepH:t.getUniformLocation(e,"uStepH")}},sendUniformData:function(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.extend,o=i.Image.filters,t=i.util.createClass;o.RemoveColor=t(o.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(e){var s,l,a,h,u=e.imageData.data,p=255*this.distance,_=new i.Color(this.color).getSource(),y=[_[0]-p,_[1]-p,_[2]-p],v=[_[0]+p,_[1]+p,_[2]+p];for(s=0;s<u.length;s+=4)l=u[s],a=u[s+1],h=u[s+2],l>y[0]&&a>y[1]&&h>y[2]&&l<v[0]&&a<v[1]&&h<v[2]&&(u[s+3]=0)},getUniformLocations:function(e,s){return{uLow:e.getUniformLocation(s,"uLow"),uHigh:e.getUniformLocation(s,"uHigh")}},sendUniformData:function(e,s){var l=new i.Color(this.color).getSource(),a=parseFloat(this.distance),h=[0+l[0]/255-a,0+l[1]/255-a,0+l[2]/255-a,1],u=[l[0]/255+a,l[1]/255+a,l[2]/255+a,1];e.uniform4fv(s.uLow,h),e.uniform4fv(s.uHigh,u)},toObject:function(){return r(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass,t={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var e in t)r[e]=o(r.ColorMatrix,{type:e,matrix:t[e],mainParameter:!1,colorsOnly:!0}),i.Image.filters[e].fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendColor=o(r.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(t){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[t]+`}
}`},retrieveShader:function(t){var e,s=this.type+"_"+this.mode;return t.programCache.hasOwnProperty(s)||(e=this.buildSource(this.mode),t.programCache[s]=this.createProgram(t.context,e)),t.programCache[s]},applyTo2d:function(t){var e,s,l,a,h,u,p,_=t.imageData.data,y=_.length,v=1-this.alpha;e=(p=new i.Color(this.color).getSource())[0]*this.alpha,s=p[1]*this.alpha,l=p[2]*this.alpha;for(var w=0;w<y;w+=4)switch(a=_[w],h=_[w+1],u=_[w+2],this.mode){case"multiply":_[w]=a*e/255,_[w+1]=h*s/255,_[w+2]=u*l/255;break;case"screen":_[w]=255-(255-a)*(255-e)/255,_[w+1]=255-(255-h)*(255-s)/255,_[w+2]=255-(255-u)*(255-l)/255;break;case"add":_[w]=a+e,_[w+1]=h+s,_[w+2]=u+l;break;case"diff":case"difference":_[w]=Math.abs(a-e),_[w+1]=Math.abs(h-s),_[w+2]=Math.abs(u-l);break;case"subtract":_[w]=a-e,_[w+1]=h-s,_[w+2]=u-l;break;case"darken":_[w]=Math.min(a,e),_[w+1]=Math.min(h,s),_[w+2]=Math.min(u,l);break;case"lighten":_[w]=Math.max(a,e),_[w+1]=Math.max(h,s),_[w+2]=Math.max(u,l);break;case"overlay":_[w]=e<128?2*a*e/255:255-2*(255-a)*(255-e)/255,_[w+1]=s<128?2*h*s/255:255-2*(255-h)*(255-s)/255,_[w+2]=l<128?2*u*l/255:255-2*(255-u)*(255-l)/255;break;case"exclusion":_[w]=e+a-2*e*a/255,_[w+1]=s+h-2*s*h/255,_[w+2]=l+u-2*l*u/255;break;case"tint":_[w]=e+a*v,_[w+1]=s+h*v,_[w+2]=l+u*v}},getUniformLocations:function(t,e){return{uColor:t.getUniformLocation(e,"uColor")}},sendUniformData:function(t,e){var s=new i.Color(this.color).getSource();s[0]=this.alpha*s[0]/255,s[1]=this.alpha*s[1]/255,s[2]=this.alpha*s[2]/255,s[3]=this.alpha,t.uniform4fv(e.uColor,s)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric,r=i.Image.filters,o=i.util.createClass;r.BlendImage=o(r.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(t){var e=this.type+"_"+this.mode,s=this.fragmentSource[this.mode];return t.programCache.hasOwnProperty(e)||(t.programCache[e]=this.createProgram(t.context,s)),t.programCache[e]},applyToWebGL:function(t){var e=t.context,s=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,s,e.TEXTURE1),this.callSuper("applyToWebGL",t),this.unbindAdditionalTexture(e,e.TEXTURE1)},createTexture:function(t,e){return t.getCachedTexture(e.cacheKey,e._element)},calculateMatrix:function(){var t=this.image,e=t._element.width,s=t._element.height;return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/s,1]},applyTo2d:function(t){var e,s,l,a,h,u,p,_,y,v,w,T=t.imageData,P=t.filterBackend.resources,L=T.data,W=L.length,N=T.width,B=T.height,D=this.image;P.blendImage||(P.blendImage=i.util.createCanvasElement()),v=(y=P.blendImage).getContext("2d"),y.width!==N||y.height!==B?(y.width=N,y.height=B):v.clearRect(0,0,N,B),v.setTransform(D.scaleX,0,0,D.scaleY,D.left,D.top),v.drawImage(D._element,0,0,N,B),w=v.getImageData(0,0,N,B).data;for(var A=0;A<W;A+=4)switch(h=L[A],u=L[A+1],p=L[A+2],_=L[A+3],e=w[A],s=w[A+1],l=w[A+2],a=w[A+3],this.mode){case"multiply":L[A]=h*e/255,L[A+1]=u*s/255,L[A+2]=p*l/255,L[A+3]=_*a/255;break;case"mask":L[A+3]=a}},getUniformLocations:function(t,e){return{uTransformMatrix:t.getUniformLocation(e,"uTransformMatrix"),uImage:t.getUniformLocation(e,"uImage")}},sendUniformData:function(t,e){var s=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,s)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(t,e){i.Image.fromObject(t.image,function(s){var l=i.util.object.clone(t);l.image=s,e(new i.Image.filters.BlendImage(l))})}}(c),function(n){var i=n.fabric||(n.fabric={}),r=Math.pow,o=Math.floor,t=Math.sqrt,e=Math.abs,s=Math.round,l=Math.sin,a=Math.ceil,h=i.Image.filters,u=i.util.createClass;h.Resize=u(h.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(p,_){return{uDelta:p.getUniformLocation(_,"uDelta"),uTaps:p.getUniformLocation(_,"uTaps")}},sendUniformData:function(p,_){p.uniform2fv(_.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),p.uniform1fv(_.uTaps,this.taps)},retrieveShader:function(p){var _=this.getFilterWindow(),y=this.type+"_"+_;if(!p.programCache.hasOwnProperty(y)){var v=this.generateShader(_);p.programCache[y]=this.createProgram(p.context,v)}return p.programCache[y]},getFilterWindow:function(){var p=this.tempScale;return Math.ceil(this.lanczosLobes/p)},getTaps:function(){for(var p=this.lanczosCreate(this.lanczosLobes),_=this.tempScale,y=this.getFilterWindow(),v=new Array(y),w=1;w<=y;w++)v[w-1]=p(w*_);return v},generateShader:function(p){for(var _=new Array(p),y=this.fragmentSourceTOP,v=1;v<=p;v++)_[v-1]=v+".0 * uDelta";return y+="uniform float uTaps["+p+`];
`,y+=`void main() {
`,y+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,y+=`  float sum = 1.0;
`,_.forEach(function(w,T){y+="  color += texture2D(uTexture, vTexCoord + "+w+") * uTaps["+T+`];
`,y+="  color += texture2D(uTexture, vTexCoord - "+w+") * uTaps["+T+`];
`,y+="  sum += 2.0 * uTaps["+T+`];
`}),y+=`  gl_FragColor = color / sum;
`,y+="}"},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(p){p.webgl?(p.passes++,this.width=p.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=p.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),p.destinationWidth=this.dW,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceWidth=p.destinationWidth,this.height=p.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),p.destinationHeight=this.dH,this._setupFrameBuffer(p),this.applyToWebGL(p),this._swapTextures(p),p.sourceHeight=p.destinationHeight):this.applyTo2d(p)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(p){return function(_){if(_>=p||_<=-p)return 0;if(_<11920929e-14&&_>-11920929e-14)return 1;var y=(_*=Math.PI)/p;return l(_)/_*l(y)/y}},applyTo2d:function(p){var _=p.imageData,y=this.scaleX,v=this.scaleY;this.rcpScaleX=1/y,this.rcpScaleY=1/v;var w,T=_.width,P=_.height,L=s(T*y),W=s(P*v);this.resizeType==="sliceHack"?w=this.sliceByTwo(p,T,P,L,W):this.resizeType==="hermite"?w=this.hermiteFastResize(p,T,P,L,W):this.resizeType==="bilinear"?w=this.bilinearFiltering(p,T,P,L,W):this.resizeType==="lanczos"&&(w=this.lanczosResize(p,T,P,L,W)),p.imageData=w},sliceByTwo:function(p,_,y,v,w){var T,P,L=p.imageData,W=.5,N=!1,B=!1,D=_*W,A=y*W,k=i.filterBackend.resources,G=0,H=0,M=_,I=0;for(k.sliceByTwo||(k.sliceByTwo=document.createElement("canvas")),((T=k.sliceByTwo).width<1.5*_||T.height<y)&&(T.width=1.5*_,T.height=y),(P=T.getContext("2d")).clearRect(0,0,1.5*_,y),P.putImageData(L,0,0),v=o(v),w=o(w);!N||!B;)_=D,y=A,v<o(D*W)?D=o(D*W):(D=v,N=!0),w<o(A*W)?A=o(A*W):(A=w,B=!0),P.drawImage(T,G,H,_,y,M,I,D,A),G=M,H=I,I+=A;return P.getImageData(G,H,v,w)},lanczosResize:function(p,_,y,v,w){var T=p.imageData.data,P=p.ctx.createImageData(v,w),L=P.data,W=this.lanczosCreate(this.lanczosLobes),N=this.rcpScaleX,B=this.rcpScaleY,D=2/this.rcpScaleX,A=2/this.rcpScaleY,k=a(N*this.lanczosLobes/2),G=a(B*this.lanczosLobes/2),H={},M={},I={};return function F(X){var U,Y,it,Q,q,et,$,rt,ot,nt,ut;for(M.x=(X+.5)*N,I.x=o(M.x),U=0;U<w;U++){for(M.y=(U+.5)*B,I.y=o(M.y),q=0,et=0,$=0,rt=0,ot=0,Y=I.x-k;Y<=I.x+k;Y++)if(!(Y<0||Y>=_)){nt=o(1e3*e(Y-M.x)),H[nt]||(H[nt]={});for(var ft=I.y-G;ft<=I.y+G;ft++)ft<0||ft>=y||(ut=o(1e3*e(ft-M.y)),H[nt][ut]||(H[nt][ut]=W(t(r(nt*D,2)+r(ut*A,2))/1e3)),(it=H[nt][ut])>0&&(q+=it,et+=it*T[Q=4*(ft*_+Y)],$+=it*T[Q+1],rt+=it*T[Q+2],ot+=it*T[Q+3]))}L[Q=4*(U*v+X)]=et/q,L[Q+1]=$/q,L[Q+2]=rt/q,L[Q+3]=ot/q}return++X<v?F(X):P}(0)},bilinearFiltering:function(p,_,y,v,w){var T,P,L,W,N,B,D,A,k,G=0,H=this.rcpScaleX,M=this.rcpScaleY,I=4*(_-1),F=p.imageData.data,X=p.ctx.createImageData(v,w),U=X.data;for(L=0;L<w;L++)for(W=0;W<v;W++)for(N=H*W-(T=o(H*W)),B=M*L-(P=o(M*L)),k=4*(P*_+T),D=0;D<4;D++)A=F[k+D]*(1-N)*(1-B)+F[k+4+D]*N*(1-B)+F[k+I+D]*B*(1-N)+F[k+I+4+D]*N*B,U[G++]=A;return X},hermiteFastResize:function(p,_,y,v,w){for(var T=this.rcpScaleX,P=this.rcpScaleY,L=a(T/2),W=a(P/2),N=p.imageData.data,B=p.ctx.createImageData(v,w),D=B.data,A=0;A<w;A++)for(var k=0;k<v;k++){for(var G=4*(k+A*v),H=0,M=0,I=0,F=0,X=0,U=0,Y=0,it=(A+.5)*P,Q=o(A*P);Q<(A+1)*P;Q++)for(var q=e(it-(Q+.5))/W,et=(k+.5)*T,$=q*q,rt=o(k*T);rt<(k+1)*T;rt++){var ot=e(et-(rt+.5))/L,nt=t($+ot*ot);nt>1&&nt<-1||(H=2*nt*nt*nt-3*nt*nt+1)>0&&(Y+=H*N[3+(ot=4*(rt+Q*_))],I+=H,N[ot+3]<255&&(H=H*N[ot+3]/250),F+=H*N[ot],X+=H*N[ot+1],U+=H*N[ot+2],M+=H)}D[G]=F/M,D[G+1]=X/M,D[G+2]=U/M,D[G+3]=Y/I}return B},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Contrast=o(r.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(t){if(this.contrast!==0){var e,s=t.imageData.data,l=s.length,a=Math.floor(255*this.contrast),h=259*(a+255)/(255*(259-a));for(e=0;e<l;e+=4)s[e]=h*(s[e]-128)+128,s[e+1]=h*(s[e+1]-128)+128,s[e+2]=h*(s[e+2]-128)+128}},getUniformLocations:function(t,e){return{uContrast:t.getUniformLocation(e,"uContrast")}},sendUniformData:function(t,e){t.uniform1f(e.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Saturation=o(r.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(t){if(this.saturation!==0){var e,s,l=t.imageData.data,a=l.length,h=-this.saturation;for(e=0;e<a;e+=4)s=Math.max(l[e],l[e+1],l[e+2]),l[e]+=s!==l[e]?(s-l[e])*h:0,l[e+1]+=s!==l[e+1]?(s-l[e+1])*h:0,l[e+2]+=s!==l[e+2]?(s-l[e+2])*h:0}},getUniformLocations:function(t,e){return{uSaturation:t.getUniformLocation(e,"uSaturation")}},sendUniformData:function(t,e){t.uniform1f(e.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Vibrance=o(r.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(t){if(this.vibrance!==0){var e,s,l,a,h=t.imageData.data,u=h.length,p=-this.vibrance;for(e=0;e<u;e+=4)s=Math.max(h[e],h[e+1],h[e+2]),l=(h[e]+h[e+1]+h[e+2])/3,a=2*Math.abs(s-l)/255*p,h[e]+=s!==h[e]?(s-h[e])*a:0,h[e+1]+=s!==h[e+1]?(s-h[e+1])*a:0,h[e+2]+=s!==h[e+2]?(s-h[e+2])*a:0}},getUniformLocations:function(t,e){return{uVibrance:t.getUniformLocation(e,"uVibrance")}},sendUniformData:function(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Blur=o(r.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(t){t.webgl?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)},applyTo2d:function(t){t.imageData=this.simpleBlur(t)},simpleBlur:function(t){var e,s,l=t.filterBackend.resources,a=t.imageData.width,h=t.imageData.height;l.blurLayer1||(l.blurLayer1=i.util.createCanvasElement(),l.blurLayer2=i.util.createCanvasElement()),e=l.blurLayer1,s=l.blurLayer2,e.width===a&&e.height===h||(s.width=e.width=a,s.height=e.height=h);var u,p,_,y,v=e.getContext("2d"),w=s.getContext("2d"),T=.06*this.blur*.5;for(v.putImageData(t.imageData,0,0),w.clearRect(0,0,a,h),y=-15;y<=15;y++)_=T*(p=y/15)*a+(u=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(e,_,u),v.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);for(y=-15;y<=15;y++)_=T*(p=y/15)*h+(u=(Math.random()-.5)/4),w.globalAlpha=1-Math.abs(p),w.drawImage(e,u,_),v.drawImage(s,0,0),w.globalAlpha=1,w.clearRect(0,0,s.width,s.height);t.ctx.drawImage(e,0,0);var P=t.ctx.getImageData(0,0,e.width,e.height);return v.globalAlpha=1,v.clearRect(0,0,e.width,e.height),P},getUniformLocations:function(t,e){return{delta:t.getUniformLocation(e,"uDelta")}},sendUniformData:function(t,e){var s=this.chooseRightDelta();t.uniform2fv(e.delta,s)},chooseRightDelta:function(){var t,e=1,s=[0,0];return this.horizontal?this.aspectRatio>1&&(e=1/this.aspectRatio):this.aspectRatio<1&&(e=this.aspectRatio),t=e*this.blur*.12,this.horizontal?s[0]=t:s[1]=t,s}}),r.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Gamma=o(r.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(t){this.gamma=[1,1,1],r.BaseFilter.prototype.initialize.call(this,t)},applyTo2d:function(t){var e,s=t.imageData.data,l=this.gamma,a=s.length,h=1/l[0],u=1/l[1],p=1/l[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),e=0,a=256;e<a;e++)this.rVals[e]=255*Math.pow(e/255,h),this.gVals[e]=255*Math.pow(e/255,u),this.bVals[e]=255*Math.pow(e/255,p);for(e=0,a=s.length;e<a;e+=4)s[e]=this.rVals[s[e]],s[e+1]=this.gVals[s[e+1]],s[e+2]=this.bVals[s[e+2]]},getUniformLocations:function(t,e){return{uGamma:t.getUniformLocation(e,"uGamma")}},sendUniformData:function(t,e){t.uniform3fv(e.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.Composed=o(r.BaseFilter,{type:"Composed",subFilters:[],initialize:function(t){this.callSuper("initialize",t),this.subFilters=this.subFilters.slice(0)},applyTo:function(t){t.passes+=this.subFilters.length-1,this.subFilters.forEach(function(e){e.applyTo(t)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(t){return t.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(t){return!t.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(t,e){var s=(t.subFilters||[]).map(function(a){return new i.Image.filters[a.type](a)}),l=new i.Image.filters.Composed({subFilters:s});return e&&e(l),l}}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.Image.filters,o=i.util.createClass;r.HueRotation=o(r.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var t=this.rotation*Math.PI,e=i.util.cos(t),s=i.util.sin(t),l=1/3,a=Math.sqrt(l)*s,h=1-e;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=e+h/3,this.matrix[1]=l*h-a,this.matrix[2]=l*h+a,this.matrix[5]=l*h+a,this.matrix[6]=e+l*h,this.matrix[7]=l*h-a,this.matrix[10]=l*h-a,this.matrix[11]=l*h+a,this.matrix[12]=e+l*h},isNeutralState:function(t){return this.calculateMatrix(),r.BaseFilter.prototype.isNeutralState.call(this,t)},applyTo:function(t){this.calculateMatrix(),r.BaseFilter.prototype.applyTo.call(this,t)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(c),function(n){var i=n.fabric||(n.fabric={}),r=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var o="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(o),cacheProperties:i.Object.prototype.cacheProperties.concat(o),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(t,e){this.styles=e&&e.styles||{},this.text=t,this.__skipDimension=!0,this.callSuper("initialize",e),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var t=this.path;t&&(t.segmentsInfo=i.util.getPathSegmentsInfo(t.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var t,e,s,l,a,h,u,p=0,_=this._textLines.length;p<_;p++)if((this.textAlign==="justify"||p!==_-1&&!this.isEndOfWrapping(p))&&(l=0,a=this._textLines[p],(e=this.getLineWidth(p))<this.width&&(u=this.textLines[p].match(this._reSpacesAndTabs)))){s=u.length,t=(this.width-e)/s;for(var y=0,v=a.length;y<=v;y++)h=this.__charBounds[p][y],this._reSpaceAndTab.test(a[y])?(h.width+=t,h.kernedWidth+=t,h.left+=l,l+=t):h.left+=l}},isEndOfWrapping:function(t){return t===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var t=this.callSuper("_getCacheCanvasDimensions"),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t},_render:function(t){var e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")},_renderText:function(t){this.paintFirst==="stroke"?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))},_setTextStyles:function(t,e,s){if(t.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":t.textBaseline="middle";break;case"ascender":t.textBaseline="top";break;case"descender":t.textBaseline="bottom"}t.font=this._getFontDeclaration(e,s)},calcTextWidth:function(){for(var t=this.getLineWidth(0),e=1,s=this._textLines.length;e<s;e++){var l=this.getLineWidth(e);l>t&&(t=l)}return t},_renderTextLine:function(t,e,s,l,a,h){this._renderChars(t,e,s,l,a,h)},_renderTextLinesBackground:function(t){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var e,s,l,a,h,u,p,_=t.fillStyle,y=this._getLeftOffset(),v=this._getTopOffset(),w=0,T=0,P=this.path,L=0,W=this._textLines.length;L<W;L++)if(e=this.getHeightOfLine(L),this.textBackgroundColor||this.styleHas("textBackgroundColor",L)){l=this._textLines[L],s=this._getLineLeftOffset(L),T=0,w=0,a=this.getValueOfPropertyAt(L,0,"textBackgroundColor");for(var N=0,B=l.length;N<B;N++)h=this.__charBounds[L][N],u=this.getValueOfPropertyAt(L,N,"textBackgroundColor"),P?(t.save(),t.translate(h.renderLeft,h.renderTop),t.rotate(h.angle),t.fillStyle=u,u&&t.fillRect(-h.width/2,-e/this.lineHeight*(1-this._fontSizeFraction),h.width,e/this.lineHeight),t.restore()):u!==a?(p=y+s+w,this.direction==="rtl"&&(p=this.width-p-T),t.fillStyle=a,a&&t.fillRect(p,v,T,e/this.lineHeight),w=h.left,T=h.width,a=u):T+=h.kernedWidth;u&&!P&&(p=y+s+w,this.direction==="rtl"&&(p=this.width-p-T),t.fillStyle=u,t.fillRect(p,v,T,e/this.lineHeight)),v+=e}else v+=e;t.fillStyle=_,this._removeShadow(t)}},getFontCache:function(t){var e=t.fontFamily.toLowerCase();i.charWidthsCache[e]||(i.charWidthsCache[e]={});var s=i.charWidthsCache[e],l=t.fontStyle.toLowerCase()+"_"+(t.fontWeight+"").toLowerCase();return s[l]||(s[l]={}),s[l]},_measureChar:function(t,e,s,l){var a,h,u,p,_=this.getFontCache(e),y=s+t,v=this._getFontDeclaration(e)===this._getFontDeclaration(l),w=e.fontSize/this.CACHE_FONT_SIZE;if(s&&_[s]!==void 0&&(u=_[s]),_[t]!==void 0&&(p=a=_[t]),v&&_[y]!==void 0&&(p=(h=_[y])-u),a===void 0||u===void 0||h===void 0){var T=this.getMeasuringContext();this._setTextStyles(T,e,!0)}return a===void 0&&(p=a=T.measureText(t).width,_[t]=a),u===void 0&&v&&s&&(u=T.measureText(s).width,_[s]=u),v&&h===void 0&&(h=T.measureText(y).width,_[y]=h,p=h-u),{width:a*w,kernedWidth:p*w}},getHeightOfChar:function(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")},measureLine:function(t){var e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e},_measureLine:function(t){var e,s,l,a,h,u,p=0,_=this._textLines[t],y=new Array(_.length),v=0,w=this.path,T=this.pathSide==="right";for(this.__charBounds[t]=y,e=0;e<_.length;e++)s=_[e],a=this._getGraphemeBox(s,t,e,l),y[e]=a,p+=a.kernedWidth,l=s;if(y[e]={left:a?a.left+a.width:0,width:0,kernedWidth:0,height:this.fontSize},w){switch(u=w.segmentsInfo[w.segmentsInfo.length-1].length,(h=i.util.getPointOnPath(w.path,0,w.segmentsInfo)).x+=w.pathOffset.x,h.y+=w.pathOffset.y,this.textAlign){case"left":v=T?u-p:0;break;case"center":v=(u-p)/2;break;case"right":v=T?0:u-p}for(v+=this.pathStartOffset*(T?-1:1),e=T?_.length-1:0;T?e>=0:e<_.length;T?e--:e++)a=y[e],v>u?v%=u:v<0&&(v+=u),this._setGraphemeOnPath(v,a,h),v+=a.kernedWidth}return{width:p,numOfSpaces:0}},_setGraphemeOnPath:function(t,e,s){var l=t+e.kernedWidth/2,a=this.path,h=i.util.getPointOnPath(a.path,l,a.segmentsInfo);e.renderLeft=h.x-s.x,e.renderTop=h.y-s.y,e.angle=h.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(t,e,s,l,a){var h,u=this.getCompleteStyleDeclaration(e,s),p=l?this.getCompleteStyleDeclaration(e,s-1):{},_=this._measureChar(t,u,l,p),y=_.kernedWidth,v=_.width;this.charSpacing!==0&&(v+=h=this._getWidthOfCharSpacing(),y+=h);var w={width:v,left:0,height:u.fontSize,kernedWidth:y,deltaY:u.deltaY};if(s>0&&!a){var T=this.__charBounds[e][s-1];w.left=T.left+T.width+_.kernedWidth-_.width}return w},getHeightOfLine:function(t){if(this.__lineHeights[t])return this.__lineHeights[t];for(var e=this._textLines[t],s=this.getHeightOfChar(t,0),l=1,a=e.length;l<a;l++)s=Math.max(this.getHeightOfChar(t,l),s);return this.__lineHeights[t]=s*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var t,e=0,s=0,l=this._textLines.length;s<l;s++)t=this.getHeightOfLine(s),e+=s===l-1?t/this.lineHeight:t;return e},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(t,e){t.save();for(var s=0,l=this._getLeftOffset(),a=this._getTopOffset(),h=0,u=this._textLines.length;h<u;h++){var p=this.getHeightOfLine(h),_=p/this.lineHeight,y=this._getLineLeftOffset(h);this._renderTextLine(e,t,this._textLines[h],l+y,a+s+_,h),s+=p}t.restore()},_renderTextFill:function(t){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(t,"fillText")},_renderTextStroke:function(t){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())},_renderChars:function(t,e,s,l,a,h){var u,p,_,y,v,w=this.getHeightOfLine(h),T=this.textAlign.indexOf("justify")!==-1,P="",L=0,W=this.path,N=!T&&this.charSpacing===0&&this.isEmptyStyles(h)&&!W,B=this.direction==="ltr",D=this.direction==="ltr"?1:-1,A=e.canvas.getAttribute("dir");if(e.save(),A!==this.direction&&(e.canvas.setAttribute("dir",B?"ltr":"rtl"),e.direction=B?"ltr":"rtl",e.textAlign=B?"left":"right"),a-=w*this._fontSizeFraction/this.lineHeight,N)return this._renderChar(t,e,h,0,s.join(""),l,a,w),void e.restore();for(var k=0,G=s.length-1;k<=G;k++)y=k===G||this.charSpacing||W,P+=s[k],_=this.__charBounds[h][k],L===0?(l+=D*(_.kernedWidth-_.width),L+=_.width):L+=_.kernedWidth,T&&!y&&this._reSpaceAndTab.test(s[k])&&(y=!0),y||(u=u||this.getCompleteStyleDeclaration(h,k),p=this.getCompleteStyleDeclaration(h,k+1),y=this._hasStyleChanged(u,p)),y&&(W?(e.save(),e.translate(_.renderLeft,_.renderTop),e.rotate(_.angle),this._renderChar(t,e,h,k,P,-L/2,0,w),e.restore()):(v=l,this._renderChar(t,e,h,k,P,v,a,w)),P="",u=p,l+=D*L,L=0);e.restore()},_applyPatternGradientTransformText:function(t){var e,s=i.util.createCanvasElement(),l=this.width+this.strokeWidth,a=this.height+this.strokeWidth;return s.width=l,s.height=a,(e=s.getContext("2d")).beginPath(),e.moveTo(0,0),e.lineTo(l,0),e.lineTo(l,a),e.lineTo(0,a),e.closePath(),e.translate(l/2,a/2),e.fillStyle=t.toLive(e),this._applyPatternGradientTransform(e,t),e.fill(),e.createPattern(s,"no-repeat")},handleFiller:function(t,e,s){var l,a;return s.toLive?s.gradientUnits==="percentage"||s.gradientTransform||s.patternTransform?(l=-this.width/2,a=-this.height/2,t.translate(l,a),t[e]=this._applyPatternGradientTransformText(s),{offsetX:l,offsetY:a}):(t[e]=s.toLive(t,this),this._applyPatternGradientTransform(t,s)):(t[e]=s,{offsetX:0,offsetY:0})},_setStrokeStyles:function(t,e){return t.lineWidth=e.strokeWidth,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",e.stroke)},_setFillStyles:function(t,e){return this.handleFiller(t,"fillStyle",e.fill)},_renderChar:function(t,e,s,l,a,h,u){var p,_,y=this._getStyleDeclaration(s,l),v=this.getCompleteStyleDeclaration(s,l),w=t==="fillText"&&v.fill,T=t==="strokeText"&&v.stroke&&v.strokeWidth;(T||w)&&(e.save(),w&&(p=this._setFillStyles(e,v)),T&&(_=this._setStrokeStyles(e,v)),e.font=this._getFontDeclaration(v),y&&y.textBackgroundColor&&this._removeShadow(e),y&&y.deltaY&&(u+=y.deltaY),w&&e.fillText(a,h-p.offsetX,u-p.offsetY),T&&e.strokeText(a,h-_.offsetX,u-_.offsetY),e.restore())},setSuperscript:function(t,e){return this._setScript(t,e,this.superscript)},setSubscript:function(t,e){return this._setScript(t,e,this.subscript)},_setScript:function(t,e,s){var l=this.get2DCursorLocation(t,!0),a=this.getValueOfPropertyAt(l.lineIndex,l.charIndex,"fontSize"),h=this.getValueOfPropertyAt(l.lineIndex,l.charIndex,"deltaY"),u={fontSize:a*s.size,deltaY:h+a*s.baseline};return this.setSelectionStyles(u,t,e),this},_hasStyleChanged:function(t,e){return t.fill!==e.fill||t.stroke!==e.stroke||t.strokeWidth!==e.strokeWidth||t.fontSize!==e.fontSize||t.fontFamily!==e.fontFamily||t.fontWeight!==e.fontWeight||t.fontStyle!==e.fontStyle||t.deltaY!==e.deltaY},_hasStyleChangedForSvg:function(t,e){return this._hasStyleChanged(t,e)||t.overline!==e.overline||t.underline!==e.underline||t.linethrough!==e.linethrough},_getLineLeftOffset:function(t){var e=this.getLineWidth(t),s=this.width-e,l=this.textAlign,a=this.direction,h=0,u=this.isEndOfWrapping(t);return l==="justify"||l==="justify-center"&&!u||l==="justify-right"&&!u||l==="justify-left"&&!u?0:(l==="center"&&(h=s/2),l==="right"&&(h=s),l==="justify-center"&&(h=s/2),l==="justify-right"&&(h=s),a==="rtl"&&(h-=s),h)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var t=this._forceClearCache;return t||(t=this.hasStateChanged("_dimensionAffectingProps")),t&&(this.dirty=!0,this._forceClearCache=!1),t},getLineWidth:function(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];var e=this.measureLine(t).width;return this.__lineWidths[t]=e,e},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(t,e,s){var l=this._getStyleDeclaration(t,e);return l&&l[s]!==void 0?l[s]:this[s]},_renderTextDecoration:function(t,e){if(this[e]||this.styleHas(e)){for(var s,l,a,h,u,p,_,y,v,w,T,P,L,W,N,B,D=this._getLeftOffset(),A=this._getTopOffset(),k=this.path,G=this._getWidthOfCharSpacing(),H=this.offsets[e],M=0,I=this._textLines.length;M<I;M++)if(s=this.getHeightOfLine(M),this[e]||this.styleHas(e,M)){_=this._textLines[M],W=s/this.lineHeight,h=this._getLineLeftOffset(M),w=0,T=0,y=this.getValueOfPropertyAt(M,0,e),B=this.getValueOfPropertyAt(M,0,"fill"),v=A+W*(1-this._fontSizeFraction),l=this.getHeightOfChar(M,0),u=this.getValueOfPropertyAt(M,0,"deltaY");for(var F=0,X=_.length;F<X;F++)if(P=this.__charBounds[M][F],L=this.getValueOfPropertyAt(M,F,e),N=this.getValueOfPropertyAt(M,F,"fill"),a=this.getHeightOfChar(M,F),p=this.getValueOfPropertyAt(M,F,"deltaY"),k&&L&&N)t.save(),t.fillStyle=B,t.translate(P.renderLeft,P.renderTop),t.rotate(P.angle),t.fillRect(-P.kernedWidth/2,H*a+p,P.kernedWidth,this.fontSize/15),t.restore();else if((L!==y||N!==B||a!==l||p!==u)&&T>0){var U=D+h+w;this.direction==="rtl"&&(U=this.width-U-T),y&&B&&(t.fillStyle=B,t.fillRect(U,v+H*l+u,T,this.fontSize/15)),w=P.left,T=P.width,y=L,B=N,l=a,u=p}else T+=P.kernedWidth;U=D+h+w,this.direction==="rtl"&&(U=this.width-U-T),t.fillStyle=N,L&&N&&t.fillRect(U,v+H*l+u,T-G,this.fontSize/15),A+=s}else A+=s;this._removeShadow(t)}},_getFontDeclaration:function(t,e){var s=t||this,l=this.fontFamily,a=i.Text.genericFonts.indexOf(l.toLowerCase())>-1,h=l===void 0||l.indexOf("'")>-1||l.indexOf(",")>-1||l.indexOf('"')>-1||a?s.fontFamily:'"'+s.fontFamily+'"';return[i.isLikelyNode?s.fontWeight:s.fontStyle,i.isLikelyNode?s.fontStyle:s.fontWeight,e?this.CACHE_FONT_SIZE+"px":s.fontSize+"px",h].join(" ")},render:function(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",t)))},_splitTextIntoLines:function(t){for(var e=t.split(this._reNewline),s=new Array(e.length),l=[`
`],a=[],h=0;h<e.length;h++)s[h]=i.util.string.graphemeSplit(e[h]),a=a.concat(s[h],l);return a.pop(),{_unwrappedLines:s,lines:e,graphemeText:a,graphemeLines:s}},toObject:function(t){var e=o.concat(t),s=this.callSuper("toObject",e);return s.styles=r(this.styles,!0),s.path&&(s.path=this.path.toObject()),s},set:function(t,e){this.callSuper("set",t,e);var s=!1,l=!1;if(typeof t=="object")for(var a in t)a==="path"&&this.setPathInfo(),s=s||this._dimensionAffectingProps.indexOf(a)!==-1,l=l||a==="path";else s=this._dimensionAffectingProps.indexOf(t)!==-1,l=t==="path";return l&&this.setPathInfo(),s&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(t,e,s){if(!t)return e(null);var l=i.parseAttributes(t,i.Text.ATTRIBUTE_NAMES),a=l.textAnchor||"left";if((s=i.util.object.extend(s?r(s):{},l)).top=s.top||0,s.left=s.left||0,l.textDecoration){var h=l.textDecoration;h.indexOf("underline")!==-1&&(s.underline=!0),h.indexOf("overline")!==-1&&(s.overline=!0),h.indexOf("line-through")!==-1&&(s.linethrough=!0),delete s.textDecoration}"dx"in l&&(s.left+=l.dx),"dy"in l&&(s.top+=l.dy),"fontSize"in s||(s.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var u="";"textContent"in t?u=t.textContent:"firstChild"in t&&t.firstChild!==null&&"data"in t.firstChild&&t.firstChild.data!==null&&(u=t.firstChild.data),u=u.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var p=s.strokeWidth;s.strokeWidth=0;var _=new i.Text(u,s),y=_.getScaledHeight()/_.height,v=((_.height+_.strokeWidth)*_.lineHeight-_.height)*y,w=_.getScaledHeight()+v,T=0;a==="center"&&(T=_.getScaledWidth()/2),a==="right"&&(T=_.getScaledWidth()),_.set({left:_.left-T,top:_.top-(w-_.fontSize*(.07+_._fontSizeFraction))/_.lineHeight,strokeWidth:p!==void 0?p:1}),e(_)},i.Text.fromObject=function(t,e){var s=r(t),l=t.path;return delete s.path,i.Object._fromObject("Text",s,function(a){l?i.Object._fromObject("Path",l,function(h){a.set("path",h),e(a)},"path"):e(a)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(c),d.util.object.extend(d.Text.prototype,{isEmptyStyles:function(n){if(!this.styles||n!==void 0&&!this.styles[n])return!0;var i=n===void 0?this.styles:{line:this.styles[n]};for(var r in i)for(var o in i[r])for(var t in i[r][o])return!1;return!0},styleHas:function(n,i){if(!this.styles||!n||n===""||i!==void 0&&!this.styles[i])return!1;var r=i===void 0?this.styles:{0:this.styles[i]};for(var o in r)for(var t in r[o])if(r[o][t][n]!==void 0)return!0;return!1},cleanStyle:function(n){if(!this.styles||!n||n==="")return!1;var i,r,o=this.styles,t=0,e=!0,s=0;for(var l in o){for(var a in i=0,o[l]){var h;t++,(h=o[l][a]).hasOwnProperty(n)?(r?h[n]!==r&&(e=!1):r=h[n],h[n]===this[n]&&delete h[n]):e=!1,Object.keys(h).length!==0?i++:delete o[l][a]}i===0&&delete o[l]}for(var u=0;u<this._textLines.length;u++)s+=this._textLines[u].length;e&&t===s&&(this[n]=r,this.removeStyle(n))},removeStyle:function(n){if(this.styles&&n&&n!==""){var i,r,o,t=this.styles;for(r in t){for(o in i=t[r])delete i[o][n],Object.keys(i[o]).length===0&&delete i[o];Object.keys(i).length===0&&delete t[r]}}},_extendStyles:function(n,i){var r=this.get2DCursorLocation(n);this._getLineStyle(r.lineIndex)||this._setLineStyle(r.lineIndex),this._getStyleDeclaration(r.lineIndex,r.charIndex)||this._setStyleDeclaration(r.lineIndex,r.charIndex,{}),d.util.object.extend(this._getStyleDeclaration(r.lineIndex,r.charIndex),i)},get2DCursorLocation:function(n,i){n===void 0&&(n=this.selectionStart);for(var r=i?this._unwrappedTextLines:this._textLines,o=r.length,t=0;t<o;t++){if(n<=r[t].length)return{lineIndex:t,charIndex:n};n-=r[t].length+this.missingNewlineOffset(t)}return{lineIndex:t-1,charIndex:r[t-1].length<n?r[t-1].length:n}},getSelectionStyles:function(n,i,r){n===void 0&&(n=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||n);for(var o=[],t=n;t<i;t++)o.push(this.getStyleAtPosition(t,r));return o},getStyleAtPosition:function(n,i){var r=this.get2DCursorLocation(n);return(i?this.getCompleteStyleDeclaration(r.lineIndex,r.charIndex):this._getStyleDeclaration(r.lineIndex,r.charIndex))||{}},setSelectionStyles:function(n,i,r){i===void 0&&(i=this.selectionStart||0),r===void 0&&(r=this.selectionEnd||i);for(var o=i;o<r;o++)this._extendStyles(o,n);return this._forceClearCache=!0,this},_getStyleDeclaration:function(n,i){var r=this.styles&&this.styles[n];return r?r[i]:null},getCompleteStyleDeclaration:function(n,i){for(var r,o=this._getStyleDeclaration(n,i)||{},t={},e=0;e<this._styleProperties.length;e++)t[r=this._styleProperties[e]]=o[r]===void 0?this[r]:o[r];return t},_setStyleDeclaration:function(n,i,r){this.styles[n][i]=r},_deleteStyleDeclaration:function(n,i){delete this.styles[n][i]},_getLineStyle:function(n){return!!this.styles[n]},_setLineStyle:function(n){this.styles[n]={}},_deleteLineStyle:function(n){delete this.styles[n]}}),function(){function n(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}d.IText=d.util.createClass(d.Text,d.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,r){this.callSuper("initialize",i,r),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,r){this[i]!==r&&(this._fireSelectionChanged(),this[i]=r),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var r=this.canvas.contextTop,o=this.canvas.viewportTransform;r.save(),r.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this.transform(r),this._clearTextArea(r),i||r.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),r=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,r):this.renderSelection(i,r),r.restore()}},_clearTextArea:function(i){var r=this.width+4,o=this.height+4;i.clearRect(-r/2,-o/2,r,o)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var r=this._getLeftOffset(),o=this._getTopOffset(),t=this._getCursorBoundariesOffsets(i);return{left:r,top:o,leftOffset:t.left,topOffset:t.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var r,o,t,e,s=0,l=0,a=this.get2DCursorLocation(i);t=a.charIndex,o=a.lineIndex;for(var h=0;h<o;h++)s+=this.getHeightOfLine(h);r=this._getLineLeftOffset(o);var u=this.__charBounds[o][t];return u&&(l=u.left),this.charSpacing!==0&&t===this._textLines[o].length&&(l-=this._getWidthOfCharSpacing()),e={top:s,left:r+(l>0?l:0)},this.direction==="rtl"&&(e.left*=-1),this.cursorOffsetCache=e,this.cursorOffsetCache},renderCursor:function(i,r){var o=this.get2DCursorLocation(),t=o.lineIndex,e=o.charIndex>0?o.charIndex-1:0,s=this.getValueOfPropertyAt(t,e,"fontSize"),l=this.scaleX*this.canvas.getZoom(),a=this.cursorWidth/l,h=i.topOffset,u=this.getValueOfPropertyAt(t,e,"deltaY");h+=(1-this._fontSizeFraction)*this.getHeightOfLine(t)/this.lineHeight-s*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,r),r.fillStyle=this.cursorColor||this.getValueOfPropertyAt(t,e,"fill"),r.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,r.fillRect(i.left+i.leftOffset-a/2,h+i.top+u,a,s)},renderSelection:function(i,r){for(var o=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,t=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,e=this.textAlign.indexOf("justify")!==-1,s=this.get2DCursorLocation(o),l=this.get2DCursorLocation(t),a=s.lineIndex,h=l.lineIndex,u=s.charIndex<0?0:s.charIndex,p=l.charIndex<0?0:l.charIndex,_=a;_<=h;_++){var y,v=this._getLineLeftOffset(_)||0,w=this.getHeightOfLine(_),T=0,P=0;if(_===a&&(T=this.__charBounds[a][u].left),_>=a&&_<h)P=e&&!this.isEndOfWrapping(_)?this.width:this.getLineWidth(_)||5;else if(_===h)if(p===0)P=this.__charBounds[h][p].left;else{var L=this._getWidthOfCharSpacing();P=this.__charBounds[h][p-1].left+this.__charBounds[h][p-1].width-L}y=w,(this.lineHeight<1||_===h&&this.lineHeight>1)&&(w/=this.lineHeight);var W=i.left+v+T,N=P-T,B=w,D=0;this.inCompositionMode?(r.fillStyle=this.compositionColor||"black",B=1,D=w):r.fillStyle=this.selectionColor,this.direction==="rtl"&&(W=this.width-W-N),r.fillRect(W,i.top+i.topOffset+D,N,B),i.topOffset+=y}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),r=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:r}}}),d.IText.fromObject=function(i,r){if(n(i),i.styles)for(var o in i.styles)for(var t in i.styles[o])n(i.styles[o][t]);d.Object._fromObject("IText",i,r,"text")}}(),vt=d.util.object.clone,d.util.object.extend(d.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var n=this;this.on("added",function(){var i=n.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,n._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(n))})},initRemovedHandler:function(){var n=this;this.on("removed",function(){var i=n.canvas;i&&(i._iTextInstances=i._iTextInstances||[],d.util.removeFromArray(i._iTextInstances,n),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,n._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(n){n._mouseUpITextHandler=function(){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.__isMousedown=!1})},n.on("mouse:up",n._mouseUpITextHandler)},_removeCanvasHandlers:function(n){n.off("mouse:up",n._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(n,i,r,o){var t;return t={isAborted:!1,abort:function(){this.isAborted=!0}},n.animate("_currentCursorOpacity",i,{duration:r,onComplete:function(){t.isAborted||n[o]()},onChange:function(){n.canvas&&n.selectionStart===n.selectionEnd&&n.renderCursorOrSelection()},abort:function(){return t.isAborted}}),t},_onTickComplete:function(){var n=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){n._currentTickCompleteState=n._animateCursor(n,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(n){var i=this,r=n?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},r)},abortCursorAnimation:function(){var n=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,n&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(n){var i=0,r=n-1;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)i++,r--;for(;/\S/.test(this._text[r])&&r>-1;)i++,r--;return n-i},findWordBoundaryRight:function(n){var i=0,r=n;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)i++,r++;for(;/\S/.test(this._text[r])&&r<this._text.length;)i++,r++;return n+i},findLineBoundaryLeft:function(n){for(var i=0,r=n-1;!/\n/.test(this._text[r])&&r>-1;)i++,r--;return n-i},findLineBoundaryRight:function(n){for(var i=0,r=n;!/\n/.test(this._text[r])&&r<this._text.length;)i++,r++;return n+i},searchWordBoundary:function(n,i){for(var r=this._text,o=this._reSpace.test(r[n])?n-1:n,t=r[o],e=d.reNonWord;!e.test(t)&&o>0&&o<r.length;)t=r[o+=i];return e.test(t)&&(o+=i===1?0:1),o},selectWord:function(n){n=n||this.selectionStart;var i=this.searchWordBoundary(n,-1),r=this.searchWordBoundary(n,1);this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(n){n=n||this.selectionStart;var i=this.findLineBoundaryLeft(n),r=this.findLineBoundaryRight(n);return this.selectionStart=i,this.selectionEnd=r,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(n){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(n),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(n){n._iTextInstances&&n._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(n){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(n.e),r=this.selectionStart,o=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&r!==o||r!==i&&o!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===r&&this.selectionEnd===o||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(n,i,r){var o=r.slice(0,n),t=d.util.string.graphemeSplit(o).length;if(n===i)return{selectionStart:t,selectionEnd:t};var e=r.slice(n,i);return{selectionStart:t,selectionEnd:t+d.util.string.graphemeSplit(e).length}},fromGraphemeToStringSelection:function(n,i,r){var o=r.slice(0,n).join("").length;return n===i?{selectionStart:o,selectionEnd:o}:{selectionStart:o,selectionEnd:o+r.slice(n,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var n=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=n.selectionStart,this.hiddenTextarea.selectionEnd=n.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var n=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=n.selectionEnd,this.inCompositionMode||(this.selectionStart=n.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var n=this._calcTextareaPosition();this.hiddenTextarea.style.left=n.left,this.hiddenTextarea.style.top=n.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var n=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(n),r=this.get2DCursorLocation(n),o=r.lineIndex,t=r.charIndex,e=this.getValueOfPropertyAt(o,t,"fontSize")*this.lineHeight,s=i.leftOffset,l=this.calcTransformMatrix(),a={x:i.left+s,y:i.top+i.topOffset+e},h=this.canvas.getRetinaScaling(),u=this.canvas.upperCanvasEl,p=u.width/h,_=u.height/h,y=p-e,v=_-e,w=u.clientWidth/p,T=u.clientHeight/_;return a=d.util.transformPoint(a,l),(a=d.util.transformPoint(a,this.canvas.viewportTransform)).x*=w,a.y*=T,a.x<0&&(a.x=0),a.x>y&&(a.x=y),a.y<0&&(a.y=0),a.y>v&&(a.y=v),a.x+=this.canvas._offset.left,a.y+=this.canvas._offset.top,{left:a.x+"px",top:a.y+"px",fontSize:e+"px",charHeight:e}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var n=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),n&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),n&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var n in this.styles)this._textLines[n]||delete this.styles[n]},removeStyleFromTo:function(n,i){var r,o,t=this.get2DCursorLocation(n,!0),e=this.get2DCursorLocation(i,!0),s=t.lineIndex,l=t.charIndex,a=e.lineIndex,h=e.charIndex;if(s!==a){if(this.styles[s])for(r=l;r<this._unwrappedTextLines[s].length;r++)delete this.styles[s][r];if(this.styles[a])for(r=h;r<this._unwrappedTextLines[a].length;r++)(o=this.styles[a][r])&&(this.styles[s]||(this.styles[s]={}),this.styles[s][l+r-h]=o);for(r=s+1;r<=a;r++)delete this.styles[r];this.shiftLineStyles(a,s-a)}else if(this.styles[s]){o=this.styles[s];var u,p,_=h-l;for(r=l;r<h;r++)delete o[r];for(p in this.styles[s])(u=parseInt(p,10))>=h&&(o[u-_]=o[p],delete o[p])}},shiftLineStyles:function(n,i){var r=vt(this.styles);for(var o in this.styles){var t=parseInt(o,10);t>n&&(this.styles[t+i]=r[t],r[t-i]||delete this.styles[t])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(n,i,r,o){var t,e={},s=!1,l=this._unwrappedTextLines[n].length===i;for(var a in r||(r=1),this.shiftLineStyles(n,r),this.styles[n]&&(t=this.styles[n][i===0?i:i-1]),this.styles[n]){var h=parseInt(a,10);h>=i&&(s=!0,e[h-i]=this.styles[n][a],l&&i===0||delete this.styles[n][a])}var u=!1;for(s&&!l&&(this.styles[n+r]=e,u=!0),u&&r--;r>0;)o&&o[r-1]?this.styles[n+r]={0:vt(o[r-1])}:t?this.styles[n+r]={0:vt(t)}:delete this.styles[n+r],r--;this._forceClearCache=!0},insertCharStyleObject:function(n,i,r,o){this.styles||(this.styles={});var t=this.styles[n],e=t?vt(t):{};for(var s in r||(r=1),e){var l=parseInt(s,10);l>=i&&(t[l+r]=e[l],e[l-r]||delete t[l])}if(this._forceClearCache=!0,o)for(;r--;)Object.keys(o[r]).length&&(this.styles[n]||(this.styles[n]={}),this.styles[n][i+r]=vt(o[r]));else if(t)for(var a=t[i?i-1:1];a&&r--;)this.styles[n][i+r]=vt(a)},insertNewStyleBlock:function(n,i,r){for(var o=this.get2DCursorLocation(i,!0),t=[0],e=0,s=0;s<n.length;s++)n[s]===`
`?t[++e]=0:t[e]++;for(t[0]>0&&(this.insertCharStyleObject(o.lineIndex,o.charIndex,t[0],r),r=r&&r.slice(t[0]+1)),e&&this.insertNewlineStyleObject(o.lineIndex,o.charIndex+t[0],e),s=1;s<e;s++)t[s]>0?this.insertCharStyleObject(o.lineIndex+s,0,t[s],r):r&&this.styles[o.lineIndex+s]&&r[0]&&(this.styles[o.lineIndex+s][0]=r[0]),r=r&&r.slice(t[s]+1);t[s]>0&&this.insertCharStyleObject(o.lineIndex+s,0,t[s],r)},setSelectionStartEndWithShift:function(n,i,r){r<=n?(i===n?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=n),this.selectionStart=r):r>n&&r<i?this._selectionDirection==="right"?this.selectionEnd=r:this.selectionStart=r:(i===n?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=r)},setSelectionInBoundaries:function(){var n=this.text.length;this.selectionStart>n?this.selectionStart=n:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>n?this.selectionEnd=n:this.selectionEnd<0&&(this.selectionEnd=0)}}),d.util.object.extend(d.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(n){if(this.canvas){this.__newClickTime=+new Date;var i=n.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",n),this._stopEvent(n.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(n){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===n.x&&this.__lastPointer.y===n.y},_stopEvent:function(n){n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(n){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(n.e))},tripleClickHandler:function(n){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(n.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(n.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(n){if(this.__isMousedown=!1,!(!this.editable||this.group||n.transform&&n.transform.actionPerformed||n.e.button&&n.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(n.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(n){var i=this.getSelectionStartFromPointer(n),r=this.selectionStart,o=this.selectionEnd;n.shiftKey?this.setSelectionStartEndWithShift(r,o,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(n){for(var i,r=this.getLocalPointer(n),o=0,t=0,e=0,s=0,l=0,a=0,h=this._textLines.length;a<h&&e<=r.y;a++)e+=this.getHeightOfLine(a)*this.scaleY,l=a,a>0&&(s+=this._textLines[a-1].length+this.missingNewlineOffset(a-1));t=this._getLineLeftOffset(l)*this.scaleX,i=this._textLines[l],this.direction==="rtl"&&(r.x=this.width*this.scaleX-r.x+t);for(var u=0,p=i.length;u<p&&(o=t,(t+=this.__charBounds[l][u].kernedWidth*this.scaleX)<=r.x);u++)s++;return this._getNewSelectionStartFromOffset(r,o,t,s,p)},_getNewSelectionStartFromOffset:function(n,i,r,o,t){var e=n.x-i,s=r-n.x,l=o+(s>e||s<0?0:1);return this.flipX&&(l=t-l),l>this._text.length&&(l=this._text.length),l}}),d.util.object.extend(d.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=d.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var n=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+n.top+"; left: "+n.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingｰtop: "+n.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):d.document.body.appendChild(this.hiddenTextarea),d.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),d.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),d.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),d.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),d.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),d.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),d.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(d.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(n){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(n.keyCode in i)this[i[n.keyCode]](n);else{if(!(n.keyCode in this.ctrlKeysMapDown)||!n.ctrlKey&&!n.metaKey)return;this[this.ctrlKeysMapDown[n.keyCode]](n)}n.stopImmediatePropagation(),n.preventDefault(),n.keyCode>=33&&n.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(n){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:n.keyCode in this.ctrlKeysMapUp&&(n.ctrlKey||n.metaKey)&&(this[this.ctrlKeysMapUp[n.keyCode]](n),n.stopImmediatePropagation(),n.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(n){var i=this.fromPaste;if(this.fromPaste=!1,n&&n.stopPropagation(),this.isEditing){var r,o,t,e,s,l=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,a=this._text.length,h=l.length,u=h-a,p=this.selectionStart,_=this.selectionEnd,y=p!==_;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var v=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),w=p>v.selectionStart;y?(r=this._text.slice(p,_),u+=_-p):h<a&&(r=w?this._text.slice(_+u,_):this._text.slice(p,p-u)),o=l.slice(v.selectionEnd-u,v.selectionEnd),r&&r.length&&(o.length&&(t=this.getSelectionStyles(p,p+1,!1),t=o.map(function(){return t[0]})),y?(e=p,s=_):w?(e=_-r.length,s=_):(e=_,s=_+r.length),this.removeStyleFromTo(e,s)),o.length&&(i&&o.join("")===d.copiedText&&!d.disableStyleCopyPaste&&(t=d.copiedTextStyle),this.insertNewStyleBlock(o,p,t)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(n){this.compositionStart=n.target.selectionStart,this.compositionEnd=n.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(d.copiedText=this.getSelectedText(),d.disableStyleCopyPaste?d.copiedTextStyle=null:d.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(n){return n&&n.clipboardData||d.window.clipboardData},_getWidthBeforeCursor:function(n,i){var r,o=this._getLineLeftOffset(n);return i>0&&(o+=(r=this.__charBounds[n][i-1]).left+r.width),o},getDownCursorOffset:function(n,i){var r=this._getSelectionForOffset(n,i),o=this.get2DCursorLocation(r),t=o.lineIndex;if(t===this._textLines.length-1||n.metaKey||n.keyCode===34)return this._text.length-r;var e=o.charIndex,s=this._getWidthBeforeCursor(t,e),l=this._getIndexOnLine(t+1,s);return this._textLines[t].slice(e).length+l+1+this.missingNewlineOffset(t)},_getSelectionForOffset:function(n,i){return n.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(n,i){var r=this._getSelectionForOffset(n,i),o=this.get2DCursorLocation(r),t=o.lineIndex;if(t===0||n.metaKey||n.keyCode===33)return-r;var e=o.charIndex,s=this._getWidthBeforeCursor(t,e),l=this._getIndexOnLine(t-1,s),a=this._textLines[t].slice(0,e),h=this.missingNewlineOffset(t-1);return-this._textLines[t-1].length+l-a.length+(1-h)},_getIndexOnLine:function(n,i){for(var r,o,t=this._textLines[n],e=this._getLineLeftOffset(n),s=0,l=0,a=t.length;l<a;l++)if((e+=r=this.__charBounds[n][l].width)>i){o=!0;var h=e-r,u=e,p=Math.abs(h-i);s=Math.abs(u-i)<p?l:l-1;break}return o||(s=t.length-1),s},moveCursorDown:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",n)},moveCursorUp:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",n)},_moveCursorUpOrDown:function(n,i){var r=this["get"+n+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(r):this.moveCursorWithoutShift(r),r!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(n){var i=this._selectionDirection==="left"?this.selectionStart+n:this.selectionEnd+n;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),n!==0},moveCursorWithoutShift:function(n){return n<0?(this.selectionStart+=n,this.selectionEnd=this.selectionStart):(this.selectionEnd+=n,this.selectionStart=this.selectionEnd),n!==0},moveCursorLeft:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",n)},_move:function(n,i,r){var o;if(n.altKey)o=this["findWordBoundary"+r](this[i]);else{if(!n.metaKey&&n.keyCode!==35&&n.keyCode!==36)return this[i]+=r==="Left"?-1:1,!0;o=this["findLineBoundary"+r](this[i])}if(typeof o!==void 0&&this[i]!==o)return this[i]=o,!0},_moveLeft:function(n,i){return this._move(n,i,"Left")},_moveRight:function(n,i){return this._move(n,i,"Right")},moveCursorLeftWithoutShift:function(n){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(n,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(n){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(n,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(n,"selectionStart")):void 0},moveCursorRight:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",n)},_moveCursorLeftOrRight:function(n,i){var r="moveCursor"+n+"With";this._currentCursorOpacity=1,i.shiftKey?r+="Shift":r+="outShift",this[r](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(n){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(n,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(n,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(n){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(n,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(n,i){i===void 0&&(i=n+1),this.removeStyleFromTo(n,i),this._text.splice(n,i-n),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(n,i,r,o){o===void 0&&(o=r),o>r&&this.removeStyleFromTo(r,o);var t=d.util.string.graphemeSplit(n);this.insertNewStyleBlock(t,r,i),this._text=[].concat(this._text.slice(0,r),t,this._text.slice(o)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var n=d.util.toFixed,i=/  +/g;d.util.object.extend(d.Text.prototype,{_toSVG:function(){var r=this._getSVGLeftTopOffsets(),o=this._getSVGTextAndBg(r.textTop,r.textLeft);return this._wrapSVGTextAndBg(o)},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(),{reviver:r,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(r){var o=this.getSvgTextDecoration(this);return[r.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",o?'text-decoration="'+o+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",r.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(r,o){var t,e=[],s=[],l=r;this._setSVGBg(s);for(var a=0,h=this._textLines.length;a<h;a++)t=this._getLineLeftOffset(a),(this.textBackgroundColor||this.styleHas("textBackgroundColor",a))&&this._setSVGTextLineBg(s,a,o+t,l),this._setSVGTextLineText(e,a,o+t,l),l+=this.getHeightOfLine(a);return{textSpans:e,textBgRects:s}},_createTextCharSpan:function(r,o,t,e){var s=r!==r.trim()||r.match(i),l=this.getSvgSpanStyles(o,s),a=l?'style="'+l+'"':"",h=o.deltaY,u="",p=d.Object.NUM_FRACTION_DIGITS;return h&&(u=' dy="'+n(h,p)+'" '),['<tspan x="',n(t,p),'" y="',n(e,p),'" ',u,a,">",d.util.string.escapeXml(r),"</tspan>"].join("")},_setSVGTextLineText:function(r,o,t,e){var s,l,a,h,u,p=this.getHeightOfLine(o),_=this.textAlign.indexOf("justify")!==-1,y="",v=0,w=this._textLines[o];e+=p*(1-this._fontSizeFraction)/this.lineHeight;for(var T=0,P=w.length-1;T<=P;T++)u=T===P||this.charSpacing,y+=w[T],a=this.__charBounds[o][T],v===0?(t+=a.kernedWidth-a.width,v+=a.width):v+=a.kernedWidth,_&&!u&&this._reSpaceAndTab.test(w[T])&&(u=!0),u||(s=s||this.getCompleteStyleDeclaration(o,T),l=this.getCompleteStyleDeclaration(o,T+1),u=this._hasStyleChangedForSvg(s,l)),u&&(h=this._getStyleDeclaration(o,T)||{},r.push(this._createTextCharSpan(y,h,t,e)),y="",s=l,t+=v,v=0)},_pushTextBgRect:function(r,o,t,e,s,l){var a=d.Object.NUM_FRACTION_DIGITS;r.push("		<rect ",this._getFillAttributes(o),' x="',n(t,a),'" y="',n(e,a),'" width="',n(s,a),'" height="',n(l,a),`"></rect>
`)},_setSVGTextLineBg:function(r,o,t,e){for(var s,l,a=this._textLines[o],h=this.getHeightOfLine(o)/this.lineHeight,u=0,p=0,_=this.getValueOfPropertyAt(o,0,"textBackgroundColor"),y=0,v=a.length;y<v;y++)s=this.__charBounds[o][y],(l=this.getValueOfPropertyAt(o,y,"textBackgroundColor"))!==_?(_&&this._pushTextBgRect(r,_,t+p,e,u,h),p=s.left,u=s.width,_=l):u+=s.kernedWidth;l&&this._pushTextBgRect(r,l,t+p,e,u,h)},_getFillAttributes:function(r){var o=r&&typeof r=="string"?new d.Color(r):"";return o&&o.getSource()&&o.getAlpha()!==1?'opacity="'+o.getAlpha()+'" fill="'+o.setAlpha(1).toRgb()+'"':'fill="'+r+'"'},_getSVGLineTopOffset:function(r){for(var o,t=0,e=0;e<r;e++)t+=this.getHeightOfLine(e);return o=this.getHeightOfLine(e),{lineTop:t,offset:(this._fontSizeMult-this._fontSizeFraction)*o/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(r){return d.Object.prototype.getSvgStyles.call(this,r)+" white-space: pre;"}})}(),function(n){var i=n.fabric||(n.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(r){for(var o=0,t=0,e=0,s={},l=0;l<r.graphemeLines.length;l++)r.graphemeText[e]===`
`&&l>0?(t=0,e++,o++):!this.splitByGrapheme&&this._reSpaceAndTab.test(r.graphemeText[e])&&l>0&&(t++,e++),s[l]={line:o,offset:t},e+=r.graphemeLines[l].length,t+=r.graphemeLines[l].length;return s},styleHas:function(r,o){if(this._styleMap&&!this.isWrapping){var t=this._styleMap[o];t&&(o=t.line)}return i.Text.prototype.styleHas.call(this,r,o)},isEmptyStyles:function(r){if(!this.styles)return!0;var o,t,e=0,s=!1,l=this._styleMap[r],a=this._styleMap[r+1];for(var h in l&&(r=l.line,e=l.offset),a&&(s=a.line===r,o=a.offset),t=r===void 0?this.styles:{line:this.styles[r]})for(var u in t[h])if(u>=e&&(!s||u<o))for(var p in t[h][u])return!1;return!0},_getStyleDeclaration:function(r,o){if(this._styleMap&&!this.isWrapping){var t=this._styleMap[r];if(!t)return null;r=t.line,o=t.offset+o}return this.callSuper("_getStyleDeclaration",r,o)},_setStyleDeclaration:function(r,o,t){var e=this._styleMap[r];r=e.line,o=e.offset+o,this.styles[r][o]=t},_deleteStyleDeclaration:function(r,o){var t=this._styleMap[r];r=t.line,o=t.offset+o,delete this.styles[r][o]},_getLineStyle:function(r){var o=this._styleMap[r];return!!this.styles[o.line]},_setLineStyle:function(r){var o=this._styleMap[r];this.styles[o.line]={}},_wrapText:function(r,o){var t,e=[];for(this.isWrapping=!0,t=0;t<r.length;t++)e=e.concat(this._wrapLine(r[t],t,o));return this.isWrapping=!1,e},_measureWord:function(r,o,t){var e,s=0;t=t||0;for(var l=0,a=r.length;l<a;l++)s+=this._getGraphemeBox(r[l],o,l+t,e,!0).kernedWidth,e=r[l];return s},_wrapLine:function(r,o,t,e){var s=0,l=this.splitByGrapheme,a=[],h=[],u=l?i.util.string.graphemeSplit(r):r.split(this._wordJoiners),p="",_=0,y=l?"":" ",v=0,w=0,T=0,P=!0,L=this._getWidthOfCharSpacing();e=e||0,u.length===0&&u.push([]),t-=e;for(var W=0;W<u.length;W++)p=l?u[W]:i.util.string.graphemeSplit(u[W]),v=this._measureWord(p,o,_),_+=p.length,(s+=w+v-L)>t&&!P?(a.push(h),h=[],s=v,P=!0):s+=L,P||l||h.push(y),h=h.concat(p),w=l?0:this._measureWord([y],o,_),_++,P=!1,v>T&&(T=v);return W&&a.push(h),T+e>this.dynamicMinWidth&&(this.dynamicMinWidth=T-L+e),a},isEndOfWrapping:function(r){return!this._styleMap[r+1]||this._styleMap[r+1].line!==this._styleMap[r].line},missingNewlineOffset:function(r){return this.splitByGrapheme?this.isEndOfWrapping(r)?1:0:1},_splitTextIntoLines:function(r){for(var o=i.Text.prototype._splitTextIntoLines.call(this,r),t=this._wrapText(o.lines,this.width),e=new Array(t.length),s=0;s<t.length;s++)e[s]=t[s].join("");return o.lines=e,o.graphemeLines=t,o},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var r={};for(var o in this._styleMap)this._textLines[o]&&(r[this._styleMap[o].line]=1);for(var o in this.styles)r[o]||delete this.styles[o]},toObject:function(r){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(r))}}),i.Textbox.fromObject=function(r,o){return i.Object._fromObject("Textbox",r,o,"text")}}(c),function(){var n=d.controlsUtils,i=n.scaleSkewCursorStyleHandler,r=n.scaleCursorStyleHandler,o=n.scalingEqually,t=n.scalingYOrSkewingX,e=n.scalingXOrSkewingY,s=n.scaleOrSkewActionName,l=d.Object.prototype.controls;if(l.ml=new d.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:e,getActionName:s}),l.mr=new d.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:e,getActionName:s}),l.mb=new d.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:t,getActionName:s}),l.mt=new d.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:t,getActionName:s}),l.tl=new d.Control({x:-.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),l.tr=new d.Control({x:.5,y:-.5,cursorStyleHandler:r,actionHandler:o}),l.bl=new d.Control({x:-.5,y:.5,cursorStyleHandler:r,actionHandler:o}),l.br=new d.Control({x:.5,y:.5,cursorStyleHandler:r,actionHandler:o}),l.mtr=new d.Control({x:0,y:-.5,actionHandler:n.rotationWithSnapping,cursorStyleHandler:n.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),d.Textbox){var a=d.Textbox.prototype.controls={};a.mtr=l.mtr,a.tr=l.tr,a.br=l.br,a.tl=l.tl,a.bl=l.bl,a.mt=l.mt,a.mb=l.mb,a.mr=new d.Control({x:.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),a.ml=new d.Control({x:-.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},ti={};function qt(f){var c=ti[f];if(c!==void 0)return c.exports;var g=ti[f]={exports:{}};return Oi[f](g,g.exports,qt),g.exports}qt.d=(f,c)=>{for(var g in c)qt.o(c,g)&&!qt.o(f,g)&&Object.defineProperty(f,g,{enumerable:!0,get:c[g]})},qt.o=(f,c)=>Object.prototype.hasOwnProperty.call(f,c);var ci={};(()=>{let f;qt.d(ci,{R:()=>f}),f=typeof document<"u"&&typeof window<"u"?qt(653).fabric:{version:"5.2.1"}})();var wt=ci.R;/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.3.5 (js 20230801)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */const pe=typeof self>"u";let re,Wt,oe,ge,Et;if(typeof navigator<"u"&&(re=navigator,Wt=re.userAgent,oe=re.platform,ge=re.mediaDevices),!pe){const f={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:re.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},c={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:oe,search:"Win"},Mac:{str:oe},Linux:{str:oe}};let g="unknownBrowser",m=0,C="unknownOS";for(let b in f){const S=f[b]||{};let x=S.str||Wt,R=S.search||b,O=S.verStr||Wt,E=S.verSearch||b;if(E instanceof Array||(E=[E]),x.indexOf(R)!=-1){g=b;for(let V of E){let j=O.indexOf(V);if(j!=-1){m=parseFloat(O.substring(j+V.length+1));break}}break}}for(let b in c){const S=c[b]||{};let x=S.str||Wt,R=S.search||b;if(x.indexOf(R)!=-1){C=b;break}}C=="Linux"&&Wt.indexOf("Windows NT")!=-1&&(C="HarmonyOS"),Et={browser:g,version:m,OS:C}}pe&&(Et={browser:"ssr",version:0,OS:"ssr"});const Ei=typeof WebAssembly<"u"&&Wt&&!(/Safari/.test(Wt)&&!/Chrome/.test(Wt)&&/\(.+\s11_2_([2-6]).*\)/.test(Wt)),Ai=!(typeof Worker>"u"),ui=!(!ge||!ge.getUserMedia),Di=async()=>{let f=!1;if(ui)try{(await ge.getUserMedia({video:!0})).getTracks().forEach(c=>{c.stop()}),f=!0}catch{}return f};Et.browser==="Chrome"&&Et.version>66||Et.browser==="Safari"&&Et.version>13||Et.browser==="OPR"&&Et.version>43||Et.browser==="Edge"&&Et.version;const Ii=(()=>{if(!pe&&document.currentScript){let f=document.currentScript.src,c=f.indexOf("?");if(c!=-1)f=f.substring(0,c);else{let g=f.indexOf("#");g!=-1&&(f=f.substring(0,g))}return f.substring(0,f.lastIndexOf("/")+1)}return"./"})();class Ht{constructor(c,g){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,this._setFabricObject(c),this._mediaType=c.type,this.styleSelector="default",this.styleId=g}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(c){this._fabricObject=c,this._fabricObject.on("selected",()=>{this.styleSelector="selected"}),this._fabricObject.on("deselected",()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.styleSelector="selected":this.styleSelector="default",this._fabricObject.type==="textbox"&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)}),c.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}_on(c,g){if(!g)return;const m=c.toLowerCase(),C=this.mapEvent_Callbacks.get(m);if(!C)throw new Error(`Event '${c}' does not exist.`);let b=C.get(g);b||(b=S=>{const x=S.e;if(!x)return void(g&&g.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const R={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let O,E,V,j;const tt=x.target.getBoundingClientRect();O=tt.left,E=tt.top,V=O+window.scrollX,j=E+window.scrollY;const K=this._drawingLayer.fabricCanvas.lowerCanvasEl.width,J=this._drawingLayer.fabricCanvas.lowerCanvasEl.height,Z=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).width),ht=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).height),at=Z/ht,st=K/J,dt=this._drawingLayer._getObjectFit();let gt,pt,vt,d,mt=1;if(dt==="contain")at<st?(mt=Z/K,gt=O+this.get("x")*mt,pt=E+this.get("y")*mt+(ht-J*mt)/2,vt=V+this.get("x")*mt,d=j+this.get("y")*mt+(ht-J*mt)/2):(mt=ht/J,gt=O+this.get("x")*mt+(Z-K*mt)/2,pt=E+this.get("y")*mt,vt=V+this.get("x")*mt+(Z-K*mt)/2,d=j+this.get("y")*mt);else if(dt==="cover")if(at<st){mt=ht/J;let Ct=this.get("x")*mt-(K*mt-Z)/2;Ct=Math.max(Ct,0),Ct=Math.min(Ct,Z),gt=O+Ct,pt=E+this.get("y")*mt,vt=V+Ct,d=j+this.get("y")*mt}else{mt=Z/K;let Ct=this.get("y")*mt-(J*mt-ht)/2;Ct=Math.max(Ct,0),Ct=Math.min(Ct,ht),gt=O+this.get("x")*mt,pt=E+Ct,vt=V+this.get("x")*mt,d=j+Ct}R.itemClientX=Math.round(gt),R.itemClientY=Math.round(pt),R.itemPageX=Math.round(vt),R.itemPageY=Math.round(d)}for(let O of Object.getOwnPropertyNames(R))Object.defineProperty(x,O,{value:R[O],writable:!0});g&&g.apply(this,[x])},C.set(g,b),this._fabricObject.on(m==="dblclick"?"mousedblclick":m,b))}on(c,g){this._on(c,g)}_off(c,g){const m=c.toLowerCase(),C=this.mapEvent_Callbacks.get(m);if(!C)throw new Error(`Event '${c}' does not exist.`);let b=C.get(g);b&&(C.delete(g),this._fabricObject.off(m==="dblclick"?"mousedblclick":m,b))}off(c,g){this._off(c,g)}_setEditable(c){const g=this._fabricObject;c?(g.selectable=!0,g.hasControls=!0,g.hoverCursor=null):(g.selectable=!1,g.hasControls=!1,g.hoverCursor="default")}hasNote(c){return this.mapNoteName_Content.has(c)}addNote(c,g){if(this.hasNote(c.name)&&!g)throw new Error("A note with the same name already exists, please use a different name.");const m=c.content?JSON.parse(JSON.stringify(c.content)):c.content;this.mapNoteName_Content.set(c.name,[m])}getNote(c){const g=this.mapNoteName_Content.get(c);return g?g.length===1?{name:c,content:g[0]?JSON.parse(JSON.stringify(g[0])):g[0]}:{name:c,content:JSON.parse(JSON.stringify(g))}:null}getNotes(){const c=[];for(let g of this.mapNoteName_Content){let m=g[1].length===1?g[1][0]:g[1];m=m&&JSON.parse(JSON.stringify(m)),c.push({name:g[0],content:m})}return c}updateNote(c,g,m){const C=this.mapNoteName_Content.get(c);if(!C)throw new Error("The note name does not exist.");m||(C.length=0),g=g&&JSON.parse(JSON.stringify(g)),C.push(g)}deleteNote(c){this.mapNoteName_Content.delete(c)}clearNotes(){this.mapNoteName_Content.clear()}_extendSet(c,g){return!1}_extendGet(c){}set(c,g){if(!this._extendSet(c,g))if(c==="x"){const m=this._fabricObject.group;m?(this._fabricObject.set("left",g-m.left-m.width/2),m.addWithUpdate()):this._fabricObject.set("left",g)}else if(c==="y"){const m=this._fabricObject.group;m?(this._fabricObject.set("top",g-m.top-m.height/2),m.addWithUpdate()):this._fabricObject.set("top",g)}else c==="styleId"?this.styleId=g:this._fabricObject.set(c,g);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(c)&&this._fabricObject.setCoords()}get(c){let g=this._extendGet(c);if(g===void 0)if(c==="x"){const m=this._fabricObject.group;g=m?this._fabricObject.get("left")+m.left+m.width/2:this._fabricObject.get("left")}else if(c==="y"){const m=this._fabricObject.group;g=m?this._fabricObject.get("top")+m.top+m.height/2:this._fabricObject.get("top")}else g=["type","mediaType"].includes(c)?this.mediaType:c==="styleSelector"?this.styleSelector:c==="styleId"?this.styleId:c==="drawingLayerId"?this.drawingLayerId:this._fabricObject.get(c);return g}setAttribute(c,g){this.set(c,g)}getAttribute(c){return this.get(c)}}Ht.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],Ht.arrStyleSelectors=["default","selected"];const ei=f=>{let c=(g=>g.split(`
`).map(m=>m.split("	")))(f);return(g=>{for(let m=0;;m++){let C=-1;for(let b=0;b<g.length;b++){let S=g[b][m];S!==void 0&&S.length>C&&(C=S.length)}if(C===-1)break;for(let b=0;b<g.length;b++){if(m>=g[b].length-1)continue;let S=" ".repeat(C+2-g[b][m].length);g[b][m]=g[b][m].concat(S)}}})(c),(g=>{let m="";for(let C=0;C<g.length;C++)m=m.concat(...g[C],C===g.length-1?"":`
`);return m})(c)};class Ri extends Ht{constructor(c,g,m,C,b){if(typeof C!="number"||C<=0)throw new RangeError("Invalid width.");super(new wt.Textbox(ei(c),{left:g,top:m,width:C}),b),this._mediaType="text",this._text=c}_extendSet(c,g){if(c==="text")return this._text=g,this._fabricObject.set("text",ei(g)),!0}_extendGet(c){if(c==="text")return this._text}}typeof document<"u"&&typeof window<"u"&&(wt.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(wt.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(f){f.dispose&&f.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),wt.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},wt.Object.prototype.transparentCorners=!1,wt.Object.prototype.cornerSize=20,wt.Object.prototype.touchCornerSize=100,wt.Object.prototype.cornerColor="rgb(254,142,20)",wt.Object.prototype.cornerStyle="circle",wt.Object.prototype.strokeUniform=!0,wt.Object.prototype.hasBorders=!1,wt.Canvas.prototype.containerClass="",wt.Canvas.prototype.getPointer=function(f,c){if(this._absolutePointer&&!c)return this._absolutePointer;if(this._pointer&&c)return this._pointer;var g,m=this.upperCanvasEl,C=wt.util.getPointer(f,m),b=m.getBoundingClientRect(),S=b.width||0,x=b.height||0;S&&x||("top"in b&&"bottom"in b&&(x=Math.abs(b.top-b.bottom)),"right"in b&&"left"in b&&(S=Math.abs(b.right-b.left))),this.calcOffset(),C.x=C.x-this._offset.left,C.y=C.y-this._offset.top,c||(C=this.restorePointerVpt(C));var R=this.getRetinaScaling();if(R!==1&&(C.x/=R,C.y/=R),S!==0&&x!==0){var O=window.getComputedStyle(m).objectFit,E=m.width,V=m.height,j=S,tt=x;g={width:E/j,height:V/tt};var K,J,Z=E/V,ht=j/tt;return O==="contain"?Z>ht?(K=j,J=j/Z,{x:C.x*g.width,y:(C.y-(tt-J)/2)*g.width}):(K=tt*Z,J=tt,{x:(C.x-(j-K)/2)*g.height,y:C.y*g.height}):O==="cover"?Z>ht?{x:(E-g.height*j)/2+C.x*g.height,y:C.y*g.height}:{x:C.x*g.width,y:(V-g.width*tt)/2+C.y*g.width}:{x:C.x*g.width,y:C.y*g.height}}return g={width:1,height:1},{x:C.x*g.width,y:C.y*g.height}},wt.Canvas.prototype._onTouchStart=function(f){var c=this.findTarget(f);!this.allowTouchScrolling&&f.cancelable&&f.preventDefault&&f.preventDefault(),c&&f.cancelable&&f.preventDefault&&f.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(f)),this.__onMouseDown(f),this._resetTransformEventData();var g=this.upperCanvasEl,m=this._getEventPrefix();wt.util.addListener(wt.document,"touchend",this._onTouchEnd,{passive:!1}),wt.util.addListener(wt.document,"touchmove",this._onMouseMove,{passive:!1}),wt.util.removeListener(g,m+"down",this._onMouseDown)},wt.Textbox.prototype._wrapLine=function(f,c,g,m){const C=f.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),b=!(!C||!C.length);var S=0,x=this.splitByGrapheme||b,R=[],O=[],E=x?wt.util.string.graphemeSplit(f):f.split(this._wordJoiners),V="",j=0,tt=x?"":" ",K=0,J=0,Z=0,ht=!0,at=this._getWidthOfCharSpacing();m=m||0,E.length===0&&E.push([]),g-=m;for(var st=0;st<E.length;st++)V=x?E[st]:wt.util.string.graphemeSplit(E[st]),K=this._measureWord(V,c,j),j+=V.length,(S+=J+K-at)>g&&!ht?(R.push(O),O=[],S=K,ht=!0):S+=at,ht||x||O.push(tt),O=O.concat(V),J=x?0:this._measureWord([tt],c,j),j++,ht=!1,K>Z&&(Z=K);return st&&R.push(O),Z+m>this.dynamicMinWidth&&(this.dynamicMinWidth=Z-at+m),R});class Mi{constructor(c,g,m,C){let b,S;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,c.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=c.getFabricCanvas():(this.fabricCanvas=new wt.Canvas(c,Object.assign(C,{allowTouchScrolling:!0})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",function(x){const R=x.selected,O=[];for(let E of R){const V=E.getDrawingItem()._drawingLayer;V&&!O.includes(V)&&O.push(V)}for(let E of O){const V=[];for(let j of R){const tt=j.getDrawingItem();tt._drawingLayer===E&&V.push(tt)}setTimeout(()=>{E.onSelectionChange&&E.onSelectionChange(V,[])},0)}}),this.fabricCanvas.on("before:selection:cleared",function(x){const R=this.getActiveObjects(),O=[];for(let E of R){const V=E.getDrawingItem()._drawingLayer;V&&!O.includes(V)&&O.push(V)}for(let E of O){const V=[];for(let j of R){const tt=j.getDrawingItem();tt._drawingLayer===E&&V.push(tt)}setTimeout(()=>{const j=[];for(let tt of V)E.hasDrawingItem(tt)&&j.push(tt);j.length>0&&E.onSelectionChange&&E.onSelectionChange([],j)},0)}}),this.fabricCanvas.on("selection:updated",function(x){const R=x.selected,O=x.deselected,E=[];for(let V of R){const j=V.getDrawingItem()._drawingLayer;j&&!E.includes(j)&&E.push(j)}for(let V of O){const j=V.getDrawingItem()._drawingLayer;j&&!E.includes(j)&&E.push(j)}for(let V of E){const j=[],tt=[];for(let K of R){const J=K.getDrawingItem();J._drawingLayer===V&&j.push(J)}for(let K of O){const J=K.getDrawingItem();J._drawingLayer===V&&tt.push(J)}setTimeout(()=>{V.onSelectionChange&&V.onSelectionChange(j,tt)},0)}}),this.fabricCanvas.wrapperEl.style.position="absolute",c.getFabricCanvas=()=>this.fabricCanvas),this.id=g,this._mapDrawingStyles=m,g){case 1:b=m.get(1),S=m.get(5);break;case 2:b=m.get(2),S=m.get(6);break;case 3:b=m.get(3),S=m.get(7);break;default:b=m.get(4),S=m.get(8)}for(let x of Ht.arrMediaTypes)this.mapMediaType_Style.set(x,{default:b,selected:S})}getId(){return this.id}_getDrawingStyle(c,g){if(typeof c!="number")throw new Error("Invalid style id.");const m=this._mapDrawingStyles.get(c);return m?g?JSON.parse(JSON.stringify(m)):m:null}setVisible(c){if(c){for(let g of this._arrFabricObject)g.visible=!0;this._visible=!0}else{for(let g of this._arrFabricObject)g.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(c){return c.styleId?c.styleId:this.mapMediaType_Style.get(c._mediaType)[c.styleSelector].styleId}_getItemCurrentStyle(c){return c.styleId?this._getDrawingStyle(c.styleId):c._mapStyle.get(c.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(c,g,m,C){let b;switch(c){case"rect":b=this.fabricCanvas.getObjects("rect");break;case"arc":b=this.fabricCanvas.getObjects("circle");break;case"polygon":b=this.fabricCanvas.getObjects("polygon");break;case"image":b=this.fabricCanvas.getObjects("image");break;case"text":b=this.fabricCanvas.getObjects("textbox");break;case"line":b=this.fabricCanvas.getObjects("line");break;case"path":b=this.fabricCanvas.getObjects("path")}for(let S of b){if(!this._arrFabricObject.includes(S))continue;const x=S.getDrawingItem();x.styleSelector===g&&this._changeItemStyle(x,m,!0)}C||this.fabricCanvas.renderAll()}_changeItemStyle(c,g,m){if(!c||!g)return;const C=c._getFabricObject();typeof c.styleId=="number"&&(g=this._getDrawingStyle(c.styleId)),C.strokeWidth=g.lineWidth,g.paintMode==="fill"?(C.fill=g.fillStyle,C.stroke=g.fillStyle):g.paintMode==="stroke"?(C.fill="transparent",C.stroke=g.strokeStyle):g.paintMode==="strokeAndFill"&&(C.fill=g.fillStyle,C.stroke=g.strokeStyle),C.fontFamily&&(C.fontFamily=g.fontFamily),C.fontSize&&(C.fontSize=g.fontSize),C.group||(C.dirty=!0),m||this.fabricCanvas.renderAll()}_updateGroupItem(c,g,m){if(!c||!g)return;const C=c.getChildItems();if(m==="add"){if(C.includes(g))return;const b=g._getFabricObject();if(this.fabricCanvas.getObjects().includes(b)){if(!this._arrFabricObject.includes(b))throw new Error("Existed in other drawing layers.");g._zIndex=null}else{let S;if(g.styleId)S=this._getDrawingStyle(g.styleId);else{S=this.mapMediaType_Style.get(g._mediaType)[c.styleSelector];const x=()=>{this._changeItemStyle(g,this.mapMediaType_Style.get(g._mediaType).selected,!0)},R=()=>{this._changeItemStyle(g,this.mapMediaType_Style.get(g._mediaType).default,!0)};g._on("selected",x),g._on("deselected",R),g._funcChangeStyleToSelected=x,g._funcChangeStyleToDefault=R}g._drawingLayer=this,g._drawingLayerId=this.id,this._changeItemStyle(g,S,!0)}c._fabricObject.addWithUpdate(g._getFabricObject())}else{if(m!=="remove"||!C.includes(g))return;g._zIndex=null,g._drawingLayer=null,g._drawingLayerId=null,g._off("selected",g._funcChangeStyleToSelected),g._off("deselected",g._funcChangeStyleToDefault),g._funcChangeStyleToSelected=null,g._funcChangeStyleToDefault=null,c._fabricObject.removeWithUpdate(g._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(c,g){let m=c._getFabricObject();const C=this.fabricCanvas.getObjects();let b,S;if(C.includes(m)){if(this._arrFabricObject.includes(m))return;throw new Error("Existed in other drawing layers.")}if(c._mediaType==="group"){b=c.getChildItems();for(let O of b)if(O._drawingLayer&&O._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(g&&typeof g=="object"&&!Array.isArray(g))for(let O in g)m.set(O,g[O]);if(b){for(let O of b){const E=this.mapMediaType_Style.get(O._mediaType);for(let V of Ht.arrStyleSelectors)O._mapStyle.set(V,E[V]);if(O.styleId)S=this._getDrawingStyle(O.styleId);else{S=E.default;const V=()=>{this._changeItemStyle(O,this.mapMediaType_Style.get(O._mediaType).selected,!0)},j=()=>{this._changeItemStyle(O,this.mapMediaType_Style.get(O._mediaType).default,!0)};O._on("selected",V),O._on("deselected",j),O._funcChangeStyleToSelected=V,O._funcChangeStyleToDefault=j}O._drawingLayer=this,O._drawingLayerId=this.id,this._changeItemStyle(O,S,!0)}m.dirty=!0,this.fabricCanvas.renderAll()}else{const O=this.mapMediaType_Style.get(c._mediaType);for(let E of Ht.arrStyleSelectors)c._mapStyle.set(E,O[E]);if(c.styleId)S=this._getDrawingStyle(c.styleId);else{S=O.default;const E=()=>{this._changeItemStyle(c,this.mapMediaType_Style.get(c._mediaType).selected)},V=()=>{this._changeItemStyle(c,this.mapMediaType_Style.get(c._mediaType).default)};c._on("selected",E),c._on("deselected",V),c._funcChangeStyleToSelected=E,c._funcChangeStyleToDefault=V}this._changeItemStyle(c,S)}c._zIndex=this.id,c._drawingLayer=this,c._drawingLayerId=this.id;const x=this._arrFabricObject.length;let R=C.length;if(x)R=C.indexOf(this._arrFabricObject[x-1])+1;else for(let O=0;O<C.length;O++)if(c._zIndex<C[O].getDrawingItem()._zIndex){R=O;break}this._arrDrwaingItem.push(c),this._arrFabricObject.push(m),this._visible?m.visible=!0:m.visible=!1,this.fabricCanvas.insertAt(m,R,!1)}addDrawingItem(c){if(!c||!c.isDrawingItem)throw TypeError("Illegal drawing item.");if(this.mode==="viewer")c._setEditable(!1);else{if(this.mode!=="editor")throw new Error("Illegal 'mode'.");c._setEditable(!0)}this._addDrawingItem(c)}addDrawingItems(c){for(let g of c)this.addDrawingItem(g)}removeDrawingItem(c){if(!c||!c.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(c))return;if(c._zIndex=null,c._drawingLayer=null,c._drawingLayerId=null,c._mediaType==="group"){const m=c.getChildItems();for(let C of m)C._zIndex=null,C._drawingLayer=null,C._drawingLayerId=null,C._off("selected",C._funcChangeStyleToSelected),C._off("deselected",C._funcChangeStyleToDefault),C._funcChangeStyleToSelected=null,C._funcChangeStyleToDefault=null,C._mapStyle.clear()}else c._off("selected",c._funcChangeStyleToSelected),c._off("deselected",c._funcChangeStyleToDefault),c._funcChangeStyleToSelected=null,c._funcChangeStyleToDefault=null,c._mapStyle.clear();const g=c._getFabricObject();c.styleSelector==="selected"&&(g.group?g.group.removeWithUpdate(g):this.fabricCanvas._activeObject=null,c.styleSelector="default"),this.fabricCanvas.remove(g),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(c),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(g),1)}removeDrawingItems(c){for(let g of c)this.removeDrawingItem(g)}setDrawingItems(c){this.clearDrawingItems(),this.addDrawingItems(c)}getDrawingItems(c){return c&&typeof c=="function"?this._arrDrwaingItem.filter(c):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const c=this.fabricCanvas.getActiveObjects(),g=[];for(let m of c)this._arrFabricObject.includes(m)&&g.push(m.getDrawingItem());return g}hasDrawingItem(c){if(!c||!c.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(c)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(c,g,m){g=g?g.toLocaleLowerCase():"all",m=m?m.toLocaleLowerCase():"all";let C,b=this._getDrawingStyle(c);if(g==="all"){const S=this.mapMediaType_Style.keys();for(let x of S)if(C=this.mapMediaType_Style.get(x),m==="all")for(let R of Ht.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(x,R,b,!0),C[R]=b;for(let O of this._arrDrwaingItem)O._mapStyle.set(R,b)}else{this._changeMediaTypeCurStyleInStyleSelector(x,m,b,!0),C[m]=b;for(let R of this._arrDrwaingItem)R._mapStyle.set(m,b)}this.fabricCanvas.renderAll()}else if(C=this.mapMediaType_Style.get(g),m==="all")for(let S of Ht.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(g,S,b,!0),C[S]=b;for(let x of this._arrDrwaingItem)x._mediaType===g&&x._mapStyle.set(S,b)}else{this._changeMediaTypeCurStyleInStyleSelector(g,m,b,!0),C[m]=b;for(let S of this._arrDrwaingItem)S._mediaType===g&&S._mapStyle.set(m,b)}}setMode(c){if((c=c.toLocaleLowerCase())==="viewer"){for(let g of this._arrDrwaingItem)g._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if(c!=="editor")throw new RangeError("Invalid value.");for(let g of this._arrDrwaingItem)g._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(c,g){this.fabricCanvas.setDimensions(c,g)}_setObjectFit(c){if(c=c.toLowerCase(),!["contain","cover"].includes(c))throw new Error(`Unsupported value '${c}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=c,this.fabricCanvas.upperCanvasEl.style.objectFit=c}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let c of this._arrDrwaingItem){const g=this._getItemCurrentStyle(c);this._changeItemStyle(c,g,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),this._manager._arrDrawingLayer.length===1&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class Pi{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}}createDrawingStyle(c){if(!c)throw new Error("Invalid style definition.");let g;if(c.hasOwnProperty("id")){if(this._mapDrawingStyles.has(c.id))throw new Error("Existing drawing style id.");g=c.id}else{let C=100;for(;this._mapDrawingStyles.has(C);)C++;g=C}const m=JSON.parse(JSON.stringify(c));m.id=g;for(let C in this._defaultStyleTemplate)m.hasOwnProperty(C)||(m[C]=this._defaultStyleTemplate[C]);return this._mapDrawingStyles.set(g,m),m.id}_getDrawingStyle(c,g){if(typeof c!="number")throw new Error("Invalid style id.");const m=this._mapDrawingStyles.get(c);return m?g?JSON.parse(JSON.stringify(m)):m:null}getDrawingStyle(c){return this._getDrawingStyle(c,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(c,g){const m=this._mapDrawingStyles.get(c);if(m)for(let C in g)m.hasOwnProperty(C)&&(m[C]=g[C])}updateDrawingStyle(c,g){this._updateDrawingStyle(c,g);for(let m of this._arrDrawingLayer)m.renderAll()}createDrawingLayer(c,g){const m=b=>{for(let S of this._arrDrawingLayer)if(S.getId()===b)return!0;return!1};if(g===void 0){for(let b=100;;b++)if(!m(b)){g=b;break}}else if(m(g))throw new Error("Existed drawing layer id.");const C=new Mi(c,g,this._mapDrawingStyles,{enableRetinaScaling:!1});return C._manager=this,this._arrDrawingLayer.push(C),this._switchPointerEvent(),C}deleteDrawingLayer(c){const g=this.getDrawingLayer(c);if(!g)return;const m=this._arrDrawingLayer;g.dispose(),m.splice(m.indexOf(g),1),this._switchPointerEvent()}clearDrawingLayers(){for(let c of this._arrDrawingLayer)c.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(c){for(let g of this._arrDrawingLayer)if(g.getId()===c)return g;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const c=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),g=[];for(let m of c)g.push(m.getDrawingItem());return g}setDimensions(c,g){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(c,g)}setObjectFit(c){for(let g of this._arrDrawingLayer)g&&g._setObjectFit(c)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(c){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=c?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let c of this._arrDrawingLayer)c.getMode()}}class Li{constructor(c){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=c}setControlTarget(c){this._controlTarget=c}getControlTarget(){return this._controlTarget}register(c){this._arrUsers.includes(c)||this._arrUsers.push(c)}logout(c){const g=this._arrUsers.indexOf(c);g!==-1&&(this.clearUserDisiredAction({user:c}),this.clearUserDisiredValue({user:c}),this._arrUsers.splice(g,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(c){return this._arrUsers.includes(c)}setDisiredValue(c,g,m,C){if(!this._arrUsers.includes(c))throw new Error("Unregistered user.");C&&(this._controlTarget[g]=m),this._mapProperty_UserValue.get(g)?this._mapProperty_UserValue.get(g).set(c,m):this._mapProperty_UserValue.set(g,new Map([[c,m]]))}clearUserDisiredValue(c){if(c&&(c.user||c.property)){if(c.property&&c.user){const g=this._mapProperty_UserValue.get(c.property);if(!g)return;g.delete(c.user)}else if(c.property)this._mapProperty_UserValue.delete(c.property);else if(c.user)for(let g of this._mapProperty_UserValue.values())g.delete(c.user)}else this._mapProperty_UserValue=new Map}getValue(c){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[c]}getPropertyDisiredValue(c){if(this._mapProperty_UserValue.get(c)){const g=[],m=this._mapProperty_UserValue.get(c);for(let C of m.values())g.push(C);return g}return null}setDisiredAction(c,g,m,C){if(!this._arrUsers.includes(c))throw new Error("Unregistered user.");return m||(m=[]),C?this._controlTarget[g](...m):(this._mapAction_UserArgs.get(g)?this._mapAction_UserArgs.get(g).set(c,m):this._mapAction_UserArgs.set(g,new Map([[c,m]])),this._render(g))}clearUserDisiredAction(c){if(c&&(c.user||c.actionName)){if(c.actionName&&c.user){const g=this._mapAction_UserArgs.get(c.actionName);if(!g)return;g.delete(c.user)}else if(c.actionName)this._mapAction_UserArgs.delete(c.actionName);else if(c.user)for(let g of this._mapAction_UserArgs.values())g.delete(c.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(c,g){const m=this._mapAction_Callbacks.get(c);m?m.push(g):this._mapAction_Callbacks.set(c,[g])}removeCallback(c,g){const m=this._mapAction_Callbacks.get(c);if(!m)return;const C=m.indexOf(g);C!==-1&&m.splice(C,1)}clearCallback(c){c?this._mapAction_Callbacks.delete(c):this._mapAction_Callbacks.clear()}_fireCallback(c){const g=this._mapAction_Callbacks.get(c);if(g)for(let m of g){if(!m)return;setTimeout(m.bind(this._controlTarget),0)}}_render(c){const g=this._mapAction_UserArgs.get(c);if(!g)throw new Error("Unrecorded action.");if(g.size===this._arrUsers.length){let m=[];for(let C of g.values())C.length>0&&(m=C);if(this._controlTarget[c]){const C=this._controlTarget[c](...m);return this._mapAction_UserArgs.delete(c),this._fireCallback(c),C}}}render(c){if(c)return this._render(c);for(let g of this._mapAction_UserArgs.keys())this._render(g)}}class kt{static multiply(c,g){const m=[];for(let C=0;C<3;C++){const b=g.slice(3*C,3*C+3);for(let S=0;S<3;S++){const x=[c[S],c[S+3],c[S+6]].reduce((R,O,E)=>R+O*b[E],0);m.push(x)}}return m}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(c,g,m){return kt.multiply(c,[1,0,0,0,1,0,g,m,1])}static rotate(c,g){var m=Math.cos(g),C=Math.sin(g);return kt.multiply(c,[m,-C,0,C,m,0,0,0,1])}static scale(c,g,m){return kt.multiply(c,[g,0,0,0,m,0,0,0,1])}}var yt;(function(f){f.GREY="grey",f.GREY32="grey32",f.RGBA="rgba",f.RBGA="rbga",f.GRBA="grba",f.GBRA="gbra",f.BRGA="brga",f.BGRA="bgra"})(yt||(yt={}));const Lt=(f,c,g,m)=>{let C=c+Math.round((f-c)/g)*g;return m&&(C=Math.min(C,m)),C};class lt{constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode&&!this.getDrawingLayers().some(c=>c.getMode()=="editor")){if(!this._singleFrameModeIpt){const c=document.createElement("input");this._singleFrameModeIpt=c,c.setAttribute("type","file"),c.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),c.setAttribute("capture",""),c.addEventListener("change",async()=>{const g=c.files[0];c.value="";const m=await(async O=>{let E=null,V=null;if(typeof createImageBitmap<"u")try{if(E=await createImageBitmap(O),E)return E}catch{}var j;return E||(V=await(j=O,new Promise((tt,K)=>{let J=URL.createObjectURL(j),Z=new Image;Z.dbrObjUrl=J,Z.src=J,Z.onload=()=>{tt(Z)},Z.onerror=ht=>{K(new Error("Can't convert blob to image : "+(ht instanceof Event?ht.type:ht)))}}))),V})(g),C=m instanceof HTMLImageElement?m.naturalWidth:m.width,b=m instanceof HTMLImageElement?m.naturalHeight:m.height;this._imgWidth=C,this._imgHeight=b;const S=O=>{const E=Date.now();if(C===0||b===0)return null;if(O instanceof HTMLImageElement&&!O.complete)throw new Error("The source is not loaded.");const V=this._scanRegion,j=this.getFrameSize(C,b,V,this.maxCvsSideLength);if(!j)return null;let tt=!0;C===j.sWidth&&b===j.sHeight&&(tt=!1);const K=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase()),J={data:null,region:V?JSON.parse(JSON.stringify(V)):null,sx:j.sx,sy:j.sy,width:j.dWidth,height:j.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:tt,toCanvas:this._toCanvas,_sWidth:j.sWidth,_sHeight:j.sHeight,_bUseWebGL:null},Z=this._getImageData(O,C,b,j,null,{pixelFormat:K});if(!Z)return null;const ht=Date.now();return lt._onLog&&lt._onLog("DCE: _getVideoData(region?) END: "+ht),J.data=Z.data,J.pixelFormat=J.colorMode=Z.pixelFormat,J._bUseWebGL=Z._bUseWebGL,J.timeSpent=ht-E,J.timeStamp=ht,Z.pixelFormat===yt.GREY?J.stride=J.width:J.stride=4*J.width,J};(O=>{let E=this._cvsSingleFrameMode;if(!E){if(E=document.createElement("canvas"),!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(E),E.style.position="absolute",E.style.width="100%",E.style.height="100%",E.style.left="0",E.style.top="0",E.style.objectFit="contain",E.style.pointerEvents="none",this._cvsSingleFrameMode=E}E.width==C&&E.height==b||(E.width=C,E.height=b);const V=E.getContext("2d");V.clearRect(0,0,E.width,E.height),V.drawImage(O,0,0)})(m),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let O of this._arrScanRegionOverlays)O&&this._updateScanRegionOverlay(O);let x;this._updateDrawingLayersSize();try{x=S(m)}catch(O){throw O}const R=this.mapCameraEvents.get("singleframeacquired");for(let O of R)if(O)try{const E={data:new Uint8Array(x.data),region:JSON.parse(JSON.stringify(x.region)),sx:x.sx,sy:x.sy,width:x.width,height:x.height,stride:x.stride,colorMode:x.colorMode,pixelFormat:x.pixelFormat,timeSpent:x.timeSpent,timeStamp:x.timeStamp,isCropped:x.isCropped,toCanvas:x.toCanvas,_sWidth:x._sWidth,_sHeight:x._sHeight,_bUseWebGL:x._bUseWebGL};await O.apply(this,[E])}catch(E){console.error(E)}}),c.style.position="fixed",c.style.left="-1px",c.style.top="-1px",c.style.width="1px",c.style.height="1px",c.style.backgroundColor="transparent",c.style.color="transparent",document.body.appendChild(c)}this._singleFrameModeIpt.click()}},this.styleEls=[],this._framePixelFormat=void 0,this._defaultFramePixelFormat="rgba",this.mapPixelFormatString_Enum=new Map([["grey",yt.GREY],["grey32",yt.GREY32],["rgba",yt.RGBA],["rbga",yt.RBGA],["grba",yt.GRBA],["gbra",yt.GBRA],["brga",yt.BRGA],["bgra",yt.BGRA]]),this.shaderPixelFormat=yt.RGBA,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._tempDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._softwareScale=1,this._scaleCenter={x:0,y:0},this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,_focusArea:null},this._tapFocusEnabled=!0,this._focusSupported=!0,this._tapDoFocus=async c=>{if(this._touchMoved)return void(this._touchMoved=!1);if(!this._tapFocusEnabled||!this._bOpen||this.singleFrameMode||!this._video||this._video.paused||!this._videoTrack||!this._focusSupported||this.getDrawingLayers().some(gt=>gt.getMode()=="editor"))return;if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(this._focusParameters.kTimeout==null&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus==1)return;let g,m,C,b;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),c instanceof MouseEvent)g=c.clientX,m=c.clientY;else{if(!(c instanceof TouchEvent))throw new Error("Unknown event type.");if(!c.changedTouches.length)return;g=c.changedTouches[0].clientX,m=c.changedTouches[0].clientY}const S=this.getVideoFit(),x=this._video.videoWidth,R=this._video.videoHeight,O=this._elContainer.getBoundingClientRect(),E=O.left,V=O.top,j=window.getComputedStyle(this._elContainer),tt=parseFloat(j.width),K=parseFloat(j.height),J=tt/K,Z=x/R;let ht=1;if(S==="contain")Z>J?(ht=tt/x,C=(g-E)/ht,b=(m-V-(K-tt/Z)/2)/ht):(ht=K/R,b=(m-V)/ht,C=(g-E-(tt-K*Z)/2)/ht);else{if(S!=="cover")throw new Error("Unsupported object-fit.");Z>J?(ht=K/R,b=(m-V)/ht,C=(g-E+(K*Z-tt)/2)/ht):(ht=tt/x,C=(g-E)/ht,b=(m-V+(tt/Z-K)/2)/ht)}const at={x:C+"px",y:b+"px"},st=2*Math.round(Math.min(x,R)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px",dt=st;await this._setLocalFocus(at,st,dt,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance),this._focusParameters.taskBackToContinous=setTimeout(()=>{this._videoTrack&&this._videoTrack.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch(()=>{})},this._focusParameters.focusBackToContinousTime)},this._touchMoved=!1,this._touchMoveEvent=()=>{this._touchMoved=!0},this._recordedStates={},this.playCallbackInfo=null,this._toCanvas=function(){const c=document.createElement("canvas");let g;if(c.width=this.width,c.height=this.height,(this.pixelFormat||this.colorMode)==="grey"){g=new Uint8ClampedArray(this.width*this.height*4);for(let C=0;C<g.length;C+=4)g[C]=this.data[C/4],g[C+1]=this.data[C/4],g[C+2]=this.data[C/4],g[C+3]=255}else g=new Uint8ClampedArray(this.data.buffer);const m=new ImageData(g,this.width,this.height);return c.getContext("2d").putImageData(m,0,0),c},this._onCameraSelChange=async()=>{await this.selectCamera(this._selCam.value),this._bOpen||this.stop()},this._onResolutionSelChange=async()=>{let c,g;if(this._selRsl&&this._selRsl.selectedIndex!=-1){let m=this._selRsl.options[this._selRsl.selectedIndex];c=m.getAttribute("data-width"),g=m.getAttribute("data-height")}await this.setResolution(c,g),this._bOpen||this.stop()},this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.disposed=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{if(!this.singleFrameMode)if(document.visibilityState==="visible"){if(lt._onLog&&lt._onLog("DCE: document visible."),this._bOpen&&this._vc_bPlayingVideoBeforeHide){if(this.videoSrc)this._video.play();else if(this._video.srcObject){const c=this._video.srcObject.getTracks()[0];this._video.srcObject.active&&c&&!c.muted?this._video.play():this.play()}}}else document.visibilityState==="hidden"&&(lt._onLog&&lt._onLog("DCE: document hidden."),["iPhone","iPad","Mac"].includes(Et.OS)?(this._vc_bPlayingVideoBeforeHide=!0,this._video&&this._video.pause()):this._video&&!this._video.paused?(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause()):this._vc_bPlayingVideoBeforeHide=!1)},this.containerClassName="dce-video-container",this._elContainer=null,this._videoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._drawingLayerOfTip=null,this._tipArgs={x:void 0,y:void 0,width:void 0,duration:void 0,autoShowSuggestedTip:void 0},this._hideTipTimeoutId=null,this.onTipSuggested=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=500,this._updateLayers=()=>{this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none");for(let c of this._arrScanRegionOverlays)c&&(c.style.display="none");this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout(()=>{if(!this.isDisposed||!this.disposed){this.ifShowScanRegionMask&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this.showScanRegionLaser(),this._cvsViewDecorator&&this.showViewDecorator(),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let c of this._arrScanRegionOverlays)c&&(c.style.display="",this._updateScanRegionOverlay(c));this._updateDrawingLayersSize(),this._updateVideoContainerStyle()}},this._updateLayersTimeout)},this._windowResizeListener=()=>{this._windowWidth!==document.documentElement.clientWidth&&(this._windowWidth=document.documentElement.clientWidth,this._updateLayers())},this.mapCameraEvents=new Map([["cameraopen",[]],["cameraclose",[]],["camerachange",[]],["resolutionchange",[]],["played",[]],["singleframeacquired",[]],["frameaddedtobuffer",[]]]),this._controler=null}static getVersion(){return this._version}static async detectEnvironment(){return await(async()=>({wasm:Ei,worker:Ai,getUserMedia:ui,camera:await Di(),browser:Et.browser,version:Et.version,OS:Et.OS}))()}static set engineResourcePath(c){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");lt._engineResourcePath=(g=>{if(g==null&&(g="./"),!pe){let m=document.createElement("a");m.href=g,g=m.href}return g.endsWith("/")||(g+="/"),g})(c)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(c){let g;try{g=window[c];const m="__storage_test__";return g.setItem(m,m),g.removeItem(m),!0}catch(m){return m instanceof DOMException&&(m.code===22||m.code===1014||m.name==="QuotaExceededError"||m.name==="NS_ERROR_DOM_QUOTA_REACHED")&&g&&g.length!==0}}static isDCEFrame(c){return!(!c||typeof c!="object"||Array.isArray(c))&&"data"in c&&"region"in c&&"sx"in c&&"sy"in c&&"width"in c&&"height"in c&&("colorMode"in c||"pixelFormat"in c)&&"timeSpent"in c&&"timeStamp"in c&&"isCropped"in c&&"toCanvas"in c&&"_sWidth"in c&&"_sHeight"in c&&"_bUseWebGL"in c}static async testCameraAccess(){try{if(!navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return{ok:!1,message:"Insecure context."};(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(c=>{c.stop()})}catch(c){if(c.name==="OverconstrainedError"||c.name==="NotFoundError")return{ok:!1,message:"No camera detected."};if(c.name==="NotAllowedError")return{ok:!1,message:"No permission to access camera."};if(c.name==="AbortError")return{ok:!1,message:"Some problem occurred which prevented the device from being used."};if(c.name==="NotReadableError")return{ok:!1,message:"A hardware error occurred."};if(c.name==="SecurityError")return{ok:!1,message:"User media support is disabled."};throw c}return{ok:!0,message:"Successfully accessed the camera."}}set maxCvsSideLength(c){if(c<=0)throw new Error("Invalid value.");this._maxCvsSideLength=c}get maxCvsSideLength(){if(this._maxCvsSideLength!==void 0)return this._maxCvsSideLength;if(this._controler){const c=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(c&&c.length===1)return c[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(c){lt._defaultUIElementURL=c}static get defaultUIElementURL(){var c;return(c=lt._defaultUIElementURL)===null||c===void 0?void 0:c.replace("@engineResourcePath/",lt.engineResourcePath)}getUIElement(){return this.UIElement}async setUIElement(c){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if(typeof c=="string"||c instanceof String){if(!c.trim().startsWith("<")){let m=await fetch(c);if(!m.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+m.statusText);c=await m.text()}if(!c.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let g=document.createElement("div");g.innerHTML=c;for(let m=0;m<g.childElementCount;++m){let C=g.children[m];C instanceof HTMLStyleElement&&(this.styleEls.push(C),document.head.append(C))}(c=g.childElementCount==1?g.children[0]:g).remove()}this.UIElement=c,this._uiOriginalState={display:c&&c.style.display,inDom:document.body.contains(c)}}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),this.UIElement.style.display=="none"&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(c){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=c}set frameColorMode(c){this._framePixelFormat=c}get frameColorMode(){if(this._framePixelFormat!==void 0)return this._framePixelFormat;if(this._controler){const c=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(c&&c.length===1)return c[0]}return this._defaultFramePixelFormat}set framePixelFormat(c){this._framePixelFormat=c}get framePixelFormat(){if(this._framePixelFormat!==void 0)return this._framePixelFormat;if(this._controler){const c=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(c&&c.length===1)return c[0]}return this._defaultFramePixelFormat}set bOpen(c){if(this._bOpen=c,c){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let g of this._arrScanRegionOverlays)g&&this._updateScanRegionOverlay(g);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}else this._softwareScale=1}set ifSaveLastUsedCamera(c){c?lt.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(c){if(c=c.toLowerCase(),!["contain","cover"].includes(c))throw new Error(`Unsupported value '${c}'.`);if(this.videoFit=c,this._video&&(this._video.style.objectFit=c,!this.singleFrameMode)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let g of this._arrScanRegionOverlays)g&&this._updateScanRegionOverlay(g);this._updateVideoContainerStyle(),this._drawingLayersManager.setObjectFit(c)}}getVideoFit(){return this.videoFit}_showElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.add("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.add("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.add("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.add("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.add("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.add("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.add("cvs-single-frame")}_hideElClassName(){this._cvsScanRegion&&this._cvsScanRegion.classList.remove("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.remove("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.remove("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.remove("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.remove("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.remove("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.remove("cvs-single-frame")}set ifShowScanRegionMask(c){this._bShowScanRegionMask=c,c?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display=="none"&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(c){this._bShowScanRegionLaser=c,c?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(this._bShowScanRegionLaser!==void 0)return this._bShowScanRegionLaser;if(this._controler){const c=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(c&&c.length){let g=0;for(let m of c)m||g++;return g!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display=="none"&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(c){return c===null||!!c&&!!(c.hasOwnProperty("regionLeft")&&c.hasOwnProperty("regionTop")&&c.hasOwnProperty("regionRight")&&c.hasOwnProperty("regionBottom")&&c.hasOwnProperty("regionMeasuredByPercentage"))&&!(c.regionLeft<0||c.regionTop<0||c.regionRight<0||c.regionBottom<0)&&(!c.regionMeasuredByPercentage||!(c.regionLeft>100||c.regionTop>100||c.regionRight>100||c.regionBottom>100))}set scanRegion(c){if(!this._checkValidRegion(c))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(c)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let g of this._arrScanRegionOverlays)g&&this._updateScanRegionOverlay(g)}setScanRegion(c){this.scanRegion=c}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){var c,g;let m,C,b;if(this.singleFrameMode?(m=this._imgWidth,C=this._imgHeight,b="contain"):(m=(c=this._video)===null||c===void 0?void 0:c.videoWidth,C=(g=this._video)===null||g===void 0?void 0:g.videoHeight,b=this.getVideoFit()),!m||!C)throw new Error("Invalid content dimensions.");return{width:m,height:C,objectFit:b}}addScanRegionOverlayCanvas(){this._assertOpen();const c=document.createElement("canvas");if(this._updateScanRegionOverlay(c),!this._scanRegionOverlayContainer){const g=document.createElement("div");if(this._scanRegionOverlayContainer=g,g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.width="100%",g.style.height="100%",g.style.overflow="hidden",g.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(g);else if(this._cvsScanRegion)this._cvsScanRegion.after(g);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(g);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(g);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(g)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(c),this._arrScanRegionOverlays.push(c),c}removeScanRegionOverlayCanvas(c){const g=this._arrScanRegionOverlays.indexOf(c);g!==-1&&(c.remove(),this._arrScanRegionOverlays.splice(g,1))}_updateScanRegionOverlay(c){if(!c)return;let g;try{g=this._calculateCvsSize()}catch(dt){if((dt.message||dt)==="Invalid content dimensions.")return;throw dt}const{width:m,height:C,objectFit:b}=g;if(m<=0||C<=0)return c.width=0,void(c.height=0);const S=this._getRegionInPixels(m,C,this._scanRegion),x=this.getFrameSize(m,C,this._scanRegion,this.maxCvsSideLength),R=x.dWidth,O=x.dHeight;c.width==R&&c.height==O||(c.width=R,c.height=O);const E=window.getComputedStyle(this._elContainer),V=parseFloat(E.width),j=parseFloat(E.height),tt=V/j,K=m/C;let J,Z,ht,at,st=1;b==="contain"?(K>tt?(st=V/m,J=0,Z=(j-C*st)/2):(st=j/C,J=(V-m*st)/2,Z=0),J+=S.regionLeft*st,Z+=S.regionTop*st,ht=(S.regionRight-S.regionLeft)*st,at=(S.regionBottom-S.regionTop)*st):b==="cover"?(K>tt?(st=j/C,J=S.regionLeft*st-(m*st-V)/2,Z=S.regionTop*st):(st=V/m,J=S.regionLeft*st,Z=S.regionTop*st-(C*st-j)/2),ht=(S.regionRight-S.regionLeft)*st,at=(S.regionBottom-S.regionTop)*st):(J=0,Z=0,ht=0,at=0),c.style.position="absolute",c.style.left=J+"px",c.style.top=Z+"px",c.style.width=ht+"px",c.style.height=at+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display=="none"&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(c,g){if(!c)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));if(!g)throw new Error("Invalid area.");this._assertOpen();let m=[];if(typeof c=="string"?m.push(c):Array.isArray(c)&&(m=JSON.parse(JSON.stringify(c))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(g)),this._decoratorType.length=0;const C=["rectangle","focus"],b=["crossline","crosshair"];let S=!1,x=!1;for(let R of m)R=R.toLowerCase(),C.includes(R)&&!S&&(S=!0,this._decoratorType.push(R)),b.includes(R)&&!x&&(x=!0,!this._decoratorType.includes(R)&&this._decoratorType.push(R));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display=="none"&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(c,g){if(typeof c!="string")throw new Error("The 'type' should be a string.");if(c=c.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(c))throw new Error(`The type of '${c}' doesn't exist.`);if(!this._viewDecoratorInfo[c].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${c}'.`);this._viewDecoratorInfo[c].lineWidth=g,this._updateViewDecorator()}setViewDecoratorStrokeStyle(c,g){if(typeof c!="string")throw new Error("The 'type' should be a string.");if(c=c.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(c))throw new Error(`The type of '${c}' doesn't exist.`);if(!this._viewDecoratorInfo[c].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${c}'.`);this._viewDecoratorInfo[c].strokeStyle=g,this._updateViewDecorator()}setViewDecoratorFillStyle(c,g){if(typeof c!="string")throw new Error("The 'type' should be a string.");if(c=c.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(c))throw new Error(`The type of '${c}' doesn't exist.`);if(!this._viewDecoratorInfo[c].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${c}'.`);this._viewDecoratorInfo[c].fillStyle=g,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(c,g){if(typeof c!="string")throw new Error("The 'type' should be a string.");if(c=c.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(c))throw new Error(`The type of '${c}' doesn't exist.`);if(!this._viewDecoratorInfo[c].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${c}'.`);this._viewDecoratorInfo[c].maskFillStyle=g,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen||!this._cvsViewDecorator||!this._decoratorArea)return;let c;if(this.singleFrameMode)c="contain";else{if(!this._video)return;c=this.getVideoFit()}const g=this._cvsViewDecorator;g.style.position="absolute",g.style.width="100%",g.style.height="100%",g.style.left="0",g.style.top="0",g.style.objectFit=c,g.style.pointerEvents="none";const m=this.getVisibleRegion(!0);if(!m)return;const C=m.regionRight-m.regionLeft,b=m.regionBottom-m.regionTop;if(g.width==C&&g.height==b||(g.width=C,g.height=b),C<=0||b<=0)return;const S=g.getContext("2d");S.clearRect(0,0,g.width,g.height);const x=this._decoratorArea.x/100*C,R=this._decoratorArea.y/100*b,O=this._decoratorArea.width/100*C,E=this._decoratorArea.height/100*b;for(let V of this._decoratorType){if(V==="rectangle"){S.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,S.fillRect(0,0,g.width,g.height),S.clearRect(Math.round(x),Math.round(R),Math.round(O),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,S.fillRect(Math.round(x),Math.round(R),Math.round(O),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,S.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const j=S.lineWidth/2;S.strokeRect(Math.round(x-j),Math.round(R-j),Math.round(O+S.lineWidth),Math.round(E+S.lineWidth))}if(V==="focus"){S.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,S.fillRect(0,0,g.width,g.height),S.clearRect(Math.round(x),Math.round(R),Math.round(O),Math.round(E)),S.fillStyle=this._viewDecoratorInfo.focus.fillStyle,S.fillRect(Math.round(x),Math.round(R),Math.round(O),Math.round(E)),S.lineWidth=this._viewDecoratorInfo.focus.lineWidth,S.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const j=S.lineWidth/2,tt=[0,.25,.75,1],K=[0,.25,.75,1];S.beginPath();for(let J=0;J<tt.length;J++)if(J==0||J==3)for(let Z=0;Z<K.length;Z+=2)S.moveTo(Math.round(x+tt[J]*O),Math.round(R+K[Z]*E)),S.lineTo(Math.round(x+tt[J]*O),Math.round(R+K[Z+1]*E));for(let J=0;J<K.length;J++)if(J==0||J==3)for(let Z=0;Z<tt.length;Z+=2)S.moveTo(Math.round(x+tt[Z]*O-j),Math.round(R+K[J]*E)),S.lineTo(Math.round(x+tt[Z+1]*O+j),Math.round(R+K[J]*E));S.stroke()}if(V==="crossline"&&(S.beginPath(),S.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,S.moveTo(Math.round(x),Math.round(R+E/2)),S.lineTo(Math.round(x+O),Math.round(R+E/2)),S.moveTo(Math.round(x+O/2),Math.round(R)),S.lineTo(Math.round(x+O/2),Math.round(R+E)),S.stroke()),V==="crosshair"){S.beginPath();const j=.05*Math.min(O,E);S.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,S.moveTo(Math.round(x+(O-j)/2),Math.round(R+E/2)),S.lineTo(Math.round(x+(O+j)/2),Math.round(R+E/2)),S.moveTo(Math.round(x+O/2),Math.round(R+(E-j)/2)),S.lineTo(Math.round(x+O/2),Math.round(R+(E+j)/2)),S.stroke()}}}getVisibleRegion(c){let g;this._assertOpen();try{g=this._calculateCvsSize()}catch(x){if((x.message||x)==="Invalid content dimensions.")return null;throw x}const{width:m,height:C,objectFit:b}=g;let S=(()=>{const x=parseFloat(window.getComputedStyle(this._elContainer).width),R=parseFloat(window.getComputedStyle(this._elContainer).height);let O,E={regionBottom:C,regionRight:m,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return b==="cover"?x/R<m/C?(O=R/C,E.regionLeft=Math.floor((m-x/O)/2),E.regionRight=Math.ceil(m-E.regionLeft),E.regionTop=0,E.regionBottom=C):(O=x/m,E.regionTop=Math.floor((C-R/O)/2),E.regionBottom=Math.ceil(C-E.regionTop),E.regionLeft=0,E.regionRight=m):b==="none"&&(x<m&&R<C?(E.regionLeft=Math.floor((m-x)/2),E.regionRight=Math.ceil(m-E.regionLeft),E.regionTop=Math.floor((C-R)/2),E.regionBottom=Math.ceil(C-E.regionTop)):x<m?(E.regionLeft=Math.floor((m-x)/2),E.regionRight=Math.ceil(m-E.regionLeft),E.regionTop=0,E.regionBottom=C):R<C&&(E.regionTop=Math.floor((C-R)/2),E.regionBottom=Math.ceil(C-E.regionTop),E.regionLeft=0,E.regionRight=m)),E})();return c?S.regionMeasuredByPercentage=!1:(S.regionBottom=Math.ceil(S.regionBottom/C*100),S.regionRight=Math.ceil(S.regionRight/m*100),S.regionLeft=Math.floor(S.regionLeft/m*100),S.regionTop=Math.floor(S.regionTop/C*100),S.regionMeasuredByPercentage=!0),S}setScanRegionMaskStyle(c){c&&(c.fillStyle&&(this.regionMaskFillStyle=c.fillStyle),c.strokeStyle&&(this.regionMaskStrokeStyle=c.strokeStyle),c.lineWidth&&(this.regionMaskLineWidth=c.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(c,g,m){if(!(c<=0||g<=0))return m?m.regionMeasuredByPercentage?{regionLeft:Math.round(m.regionLeft/100*c),regionTop:Math.round(m.regionTop/100*g),regionRight:Math.round(m.regionRight/100*c),regionBottom:Math.round(m.regionBottom/100*g),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(m)):{regionLeft:0,regionTop:0,regionRight:c,regionBottom:g,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;let c;try{c=this._calculateCvsSize()}catch(R){if((R.message||R)==="Invalid content dimensions.")return;throw R}const{width:g,height:m,objectFit:C}=c;if(g<=0||m<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const b=this._getRegionInPixels(g,m,this._scanRegion);if(!this._cvsScanRegion){if(this._cvsScanRegion=document.createElement("canvas"),this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsScanRegion);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsScanRegion);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsScanRegion)}this._recordedStates.maskShow=!0}const S=this._cvsScanRegion;S.style.position="absolute",S.style.width="100%",S.style.height="100%",S.style.left="0",S.style.top="0",S.style.objectFit=C,S.style.pointerEvents="none",S.width==g&&S.height==m||(S.width=g,S.height=m);const x=S.getContext("2d");if(x.clearRect(0,0,S.width,S.height),b.regionLeft!=0||b.regionRight!=g||b.regionTop!=0||b.regionBottom!=m){const R=b.regionLeft,O=b.regionTop,E=b.regionRight-b.regionLeft,V=b.regionBottom-b.regionTop;x.fillStyle=this.regionMaskFillStyle,x.fillRect(0,0,S.width,S.height),x.clearRect(Math.round(R),Math.round(O),Math.round(E),Math.round(V)),x.strokeStyle=this.regionMaskStrokeStyle,x.lineWidth=this.regionMaskLineWidth;const j=x.lineWidth/2;x.strokeRect(Math.round(R-j),Math.round(O-j),Math.round(E+x.lineWidth),Math.round(V+x.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;let c;try{c=this._calculateCvsSize()}catch(Z){if((Z.message||Z)==="Invalid content dimensions.")return;throw Z}const{width:g,height:m,objectFit:C}=c;if(!this._divScanArea)return;if(g<=0||m<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const b=this._getRegionInPixels(g,m,this._scanRegion),S=window.getComputedStyle(this._elContainer),x=parseFloat(S.width),R=parseFloat(S.height),O=x/R,E=g/m;let V,j,tt,K,J=1;if(C==="contain")O<E?(J=x/g,V=0,j=(R-m*J)/2):(J=R/m,V=(x-g*J)/2,j=0),V+=b.regionLeft*J,j+=b.regionTop*J,tt=(b.regionRight-b.regionLeft)*J,K=(b.regionBottom-b.regionTop)*J;else if(C==="cover")if(O<E){J=R/m,V=b.regionLeft*J-(g*J-x)/2,V=Math.max(V,0),V=Math.min(V,parseFloat(S.width)),j=b.regionTop*J;let Z=b.regionRight*J-(g*J-x)/2;Z=Math.max(Z,0),Z=Math.min(Z,parseFloat(S.width)),tt=Z-V,K=(b.regionBottom-b.regionTop)*J}else{J=x/g,V=b.regionLeft*J,j=b.regionTop*J-(m*J-R)/2,j=Math.max(j,0),j=Math.min(j,parseFloat(S.height));let Z=b.regionBottom*J-(m*J-R)/2;Z=Math.max(Z,0),Z=Math.min(Z,parseFloat(S.height)),tt=(b.regionRight-b.regionLeft)*J,K=Z-j}else V=0,j=0,tt=0,K=0;this._divScanArea.style.left=V+"px",this._divScanArea.style.top=j+"px",this._divScanArea.style.width=tt+"px",this._divScanArea.style.height=K+"px"}set croppingRegions(c){this._croppingRegions=c,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(this._croppingRegions!==void 0)return this._croppingRegions;if(this._controler){const c=this._controler.getPropertyDisiredValue("croppingRegions");if(c&&c.length===1)return c[0]}return this._defaultCroppingRegions}set croppingRegionIndex(c){c<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=c)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(c){if(c<0)throw new Error("'Invalid value.");this._loopInterval=c,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(this._loopInterval!==void 0)return this._loopInterval;if(this._controler){const c=this._controler.getPropertyDisiredValue("loopInterval");if(c&&c.length===1)return c[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(c){if(c<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=c;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(this._maxNumberOfFramesInBuffer!==void 0)return this._maxNumberOfFramesInBuffer;if(this._controler){const c=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(c&&c.length===1)return c[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(c){this._refreshInterval=c}get refreshInterval(){if(this._refreshInterval!==void 0)return this._refreshInterval;if(this._controler){const c=this._controler.getPropertyDisiredValue("refreshInterval");if(c&&c.length===1)return c[0]}return this._defaultRefreshInterval}static async createInstance(c){let g=new lt;(typeof c=="string"||c instanceof String)&&(c=JSON.parse(c));for(let m in c)g[m]=c[m];return this._hasEngineResourceLoaded=!0,lt.onWarning&&(location&&location.protocol==="file:"?setTimeout(()=>{lt.onWarning&&lt.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})},0):window.isSecureContext!==!1&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout(()=>{lt.onWarning&&lt.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})},0)),g._drawingLayersManager=new Pi,g}static async playVideo(c,g,m){return new Promise((C,b)=>{c||b(new Error("Invalid video element.")),g||b(new Error("Invalid source.")),c.onloadedmetadata=async()=>{c.onloadedmetadata=null,await c.play(),C(c)},typeof g=="string"||g instanceof String?c.src=g:c.srcObject=g,m!==void 0&&setTimeout(()=>b(new Error("Failed to play video. Timeout.")),m)})}static findBestRearCameraInIOS(c){if(!c||!c.length)return null;const g=["back","baksidan","bakre","bak","後置","后置","背面","خلفية","задна","posteriore","posterior","zadní","bagside","rück","πίσω","trasera","taka","arrière","אחורית","बैक","stražnja","hátsó","belakang","aртқы","후면","achterzijde","tylny","traseira","spate","задняя","задней","zadná","านหลัง","arka","sau"],m=["triple","三镜头","三鏡頭","トリプル","ثلاثية","тройна","trojný","τριπλή","kolmois","משולשת","ट्रिपल","trostruka","tiga","tripla","үштік","트리플","trippelt","trippel","trójobiektywowy","triplă","тройная","trojitá","สาม","üçlü","потроєна","ba camera"],C=["dual wide","dual-weitwinkel","dual con gran angular","dual","doble","double","双广角","雙廣角","デュアル広角","مزدوجة عريضة","двойна широкоъгълна","duální širokoúhlý","διπλή ευρεία","laajakulmainen kaksois","כפולה רחבה","ड्युअल वाइड","dvostruka široka","kettős, széles látószögű","ganda","doppia con grandangolo","қос кең бұрышты","듀얼 와이드","dwikamera","dobbelt vidvinkelkamera","dwuobiektywowy","dupla grande-angular","grande angular dupla","dublă","двойная широкоугольная","duálna širokouhlá","dubbel vidvinkel","คู่ด้านหลังมุมกว้าง","çift geniş","здвоєна ширококутна","kép rộng mặt sau"],b=c.filter(R=>{const O=R.label.toLowerCase();return g.some(E=>O.includes(E))});if(!b.length)return null;const S=b.find(R=>{const O=R.label.toLowerCase();return m.some(E=>O.includes(E))});if(S)return S.deviceId;const x=b.find(R=>{const O=R.label.toLowerCase();return C.some(E=>O.includes(E))});return x?x.deviceId:b[0].deviceId}static findBestRearCamera(c){if(!c||!c.length)return null;if(["iPhone","iPad","Mac"].includes(Et.OS))return lt.findBestRearCameraInIOS(c);const g=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","posterior","后面","後面","背面","后置","後置","背置","задней","خلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","taka","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक","задна","aртқы","задняя","bakre","านหลัง"];for(let m of c){const C=m.label.toLowerCase();if(C&&g.some(b=>C.includes(b))&&/\b0(\b)?/.test(C))return m.deviceId}return["Android","HarmonyOS"].includes(Et.OS)?c[c.length-1].deviceId:null}async play(c,g,m,C){let b;if(this._video&&this.videoSrc){lt._onLog&&(b=Date.now(),lt._onLog("DCE: start loading static video: "+b));const R=await lt.playVideo(this._video,this.videoSrc,4e3);if(lt._onLog&&lt._onLog("DCE: finish loading static video. Costs: "+(Date.now()-b)),!this._video)return R.pause(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};const O={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(O));const E=this.mapCameraEvents.get("played");for(let V of E){if(!V)continue;const j=JSON.parse(JSON.stringify(O));setTimeout(()=>{this.isDisposed&&this.disposed||V.apply(this,[j])},0)}return this._recordedStates.videoPlaying=!0,O}if(this.singleFrameMode)return C&&C.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};if(!this._video)throw new Error("'video' is null or undefined.");const S=++this.iPlayRound;if(this.promisePlay&&(await this.promisePlay,S<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(async()=>{var R;try{this._video&&this._video.srcObject&&this.stop(),lt._onLog&&lt._onLog("DCE: ======before video========");const O=()=>{if(!this._video)throw j&&j.getTracks().forEach(dt=>{dt.stop()}),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null or undefined.")},E=this.getVideoSettings();let V,j;if(typeof E.video=="boolean"&&(E.video={}),c)delete E.video.facingMode,E.video.deviceId={exact:c};else if(!E.video.deviceId){if(this._lastDeviceId)delete E.video.facingMode,E.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&lt.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete E.video.facingMode,E.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const dt=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),gt=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));dt&&gt&&(E.video.width=dt,E.video.height=gt)}else if(!this.ifSkipCameraInspection){if(E.video.facingMode){if(await this.getAllCameras(!1),!this._video)throw new Error("'video' is null or undefined.");let dt=E.video.facingMode;if(dt instanceof Array&&dt.length&&(dt=dt[0]),dt=dt.exact||dt.ideal||dt,dt==="environment"){V=!0;const gt=lt.findBestRearCamera(this._allCameras);gt&&(delete E.video.facingMode,E.video.deviceId={exact:gt})}}}}g&&(E.video.width={ideal:g}),m&&(E.video.height={ideal:m}),lt._onLog&&lt._onLog("DCE: ======try getUserMedia========");let tt=[0,500],K=null;const J=async dt=>{for(let gt of tt){gt&&await new Promise(pt=>setTimeout(pt,gt)),O();try{lt._onLog&&lt._onLog("DCE: ask "+JSON.stringify(dt)),j=await navigator.mediaDevices.getUserMedia(dt);break}catch(pt){if(O(),pt.name==="NotFoundError"||pt.name==="NotAllowedError")throw pt;K=pt,lt._onLog&&lt._onLog("DCE: "+pt.message||pt)}}O()};let Z;if(await J(E),!j&&(lt._onLog&&lt._onLog("DCE: ======try getUserMedia again========"),Z=JSON.parse(JSON.stringify(E)),typeof Z.video=="object"&&(["iPhone","iPad"].includes(Et.OS)?(g>=1280||m>=1280?Z.video.width=1280:g>=640||m>=640?Z.video.width=640:(g<640||m<640)&&(Z.video.width=320),delete Z.video.height):V&&!E.video.deviceId?(delete Z.video.facingMode,this._allCameras.length&&(Z.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):Z.video=!0),lt._onLog&&lt._onLog("DCE: "+Z),await J(Z)),j||(tt=[1e3,2e3],await J(E)),j||await J(Z),!j)throw K;const ht=()=>{const dt=j.getVideoTracks();let gt,pt;if(dt.length&&(gt=this._videoTrack=dt[0]),this._video&&gt){const vt=gt.getSettings();if(vt){for(let d of this._allCameras)if(vt.deviceId===d.deviceId){d._checked=!0,d.label=gt.label,pt=d;break}}}this._currentCamera=pt};if(await this.getAllCameras(!1),O(),V&&!this.ifSkipCameraInspection){ht();const dt=lt.findBestRearCamera(this._allCameras),gt=(R=this._currentCamera)===null||R===void 0?void 0:R.deviceId;dt&&dt!=gt&&(j.getTracks().forEach(pt=>{pt.stop()}),tt=[0,500,1e3,2e3],E.video.deviceId={exact:dt},await J(E))}lt._onLog&&lt._onLog("DCE: ======play video========"),O(),await lt.playVideo(this._video,j,4e3),O(),lt._onLog&&lt._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const at=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=at,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),lt._onLog&&lt._onLog("DCE: got "+at),ht(),this._renderSelCameraInfo();const st={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};if(st.deviceId&&(this._lastDeviceId=st.deviceId,this.ifSaveLastUsedCamera&&lt.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),E.video.width&&E.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(E.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(E.video.height))))),!C||!C.notTriggerPlayedEvent){const dt=this.mapCameraEvents.get("played");for(let gt of dt){if(!gt)continue;const pt=JSON.parse(JSON.stringify(st));setTimeout(()=>{this.isDisposed&&this.disposed||gt.apply(this,[pt])},0)}}return this.promisePlay=null,st}catch(O){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),O.name==="NotFoundError"&&(DOMException?O=new DOMException("No camera available, please use a device with an accessible camera.",O.name):(O=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),O}})(),lt._onLog&&(b=Date.now(),lt._onLog("DCE: start opening camera: "+b));const x=await this.promisePlay;return lt._onLog&&lt._onLog("DCE: finish opening camera. Costs: "+(Date.now()-b)),this.playCallbackInfo=JSON.parse(JSON.stringify(x)),this._recordedStates.videoPlaying=!0,x}async resume(){this._assertOpen(),this._video&&(await this._video.play(),this._recordedStates.videoPlaying=!0),this.ifShowScanRegionLaser&&this.showScanRegionLaser()}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}isPaused(){var c;return!this.singleFrameMode&&((c=this._video)===null||c===void 0?void 0:c.paused)===!0}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const c=[this.UIElement];for(let g=0;g<c.length;++g)for(let m of c[g].children)c.push(m);for(let g of c){if(!this._video&&g.classList.contains(this.containerClassName)){this._elContainer=g;const m=document.createElement("video");m.style.position="absolute",m.style.left="0",m.style.top="0",m.style.width="100%",m.style.height="100%",m.style.objectFit=this.getVideoFit(),m.setAttribute("playsinline","true"),m.setAttribute("muted","true"),this._video=m;const C=document.createElement("div");C.append(m),C.style.position="absolute",C.style.left="0",C.style.top="0",C.style.width="100%",C.style.height="100%",C.style.overflow="hidden",this._videoContainer=C,g.prepend(C)}else!this._divScanArea&&g.classList.contains("dce-scanarea")?this._divScanArea=g:!this._divScanLight&&g.classList.contains("dce-scanlight")?this._divScanLight=g:!this._bgLoading&&g.classList.contains("dce-bg-loading")?this._bgLoading=g:!this._bgCamera&&g.classList.contains("dce-bg-camera")?this._bgCamera=g:!this._selCam&&g.classList.contains("dce-sel-camera")?this._selCam=g:!this._selRsl&&g.classList.contains("dce-sel-resolution")?(this._selRsl=g,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&g.classList.contains("dce-opt-gotResolution")?this._optGotRsl=g:!this._btnClose&&g.classList.contains("dce-btn-close")?this._btnClose=g:!this._selMinLtr&&g.classList.contains("dlr-sel-minletter")?(this._selMinLtr=g,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&g.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=g);if(this.extraBindings&&this.extraBindings.length)for(let m of this.extraBindings)try{m(g)}catch{}}if(!this._video)throw this._unbindUI(),Error(`Can not find the video container element with class '${this.containerClassName}'`);this.singleFrameMode||this.videoSrc?(this.singleFrameMode&&(this._elContainer&&(this._elContainer.addEventListener("click",this._clickIptSingleFrameMode),this._elContainer.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._elContainer&&(["Android","HarmonyOS"].includes(Et.OS)?(this._elContainer.addEventListener("touchend",this._tapDoFocus),this._elContainer.addEventListener("touchmove",this._touchMoveEvent)):this._elContainer.addEventListener("click",this._tapDoFocus)),this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&(this._resizeObserver||(this._resizeObserver=new ResizeObserver(g=>{for(let m of g)m.target===this._elContainer&&this._updateLayers()})),this._elContainer&&this._resizeObserver.observe(this._elContainer)),this._windowWidth=document.documentElement.clientWidth,window.addEventListener("resize",this._windowResizeListener)}_unbindUI(){this.singleFrameMode?(this._elContainer&&(this._elContainer.removeEventListener("click",this._clickIptSingleFrameMode),this._elContainer.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._elContainer&&(this._elContainer.removeEventListener("click",this._tapDoFocus),this._elContainer.removeEventListener("touchend",this._tapDoFocus),this._elContainer.removeEventListener("touchmove",this._touchMoveEvent)),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._videoContainer&&this._videoContainer.remove(),this._video=null,this._videoContainer=null,this._elContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&this._resizeObserver&&this._resizeObserver.disconnect(),window.removeEventListener("resize",this._windowResizeListener)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}async open(c){this.UIElement||await this.setUIElement(lt.defaultUIElementURL),this._bindUI(),c&&this.appendAndShowUI();let g=await this.play();this.bOpen=!0,this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1));const m=this.mapCameraEvents.get("cameraopen");for(let C of m){if(!C)continue;const b=JSON.parse(JSON.stringify(g));setTimeout(()=>{this.isDisposed&&this.disposed||C.apply(this,[b])},0)}return g}close(c){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this.hideTip(),this._unbindUI(),c&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const g=this.mapCameraEvents.get("cameraclose");for(let m of g){if(!m)continue;const C={width:0,height:0,deviceId:null};setTimeout(()=>{this.isDisposed&&this.disposed||m.apply(this,[C])},0)}}stop(){this._video&&this._video.srcObject&&(lt._onLog&&lt._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach(c=>{c.stop()}),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&(lt._onLog&&lt._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}async getAllCameras(c=!0){let g=(await navigator.mediaDevices.enumerateDevices()).filter(b=>b.kind==="videoinput");if(c&&g&&g.length&&!g[0].deviceId){let b=await navigator.mediaDevices.getUserMedia({video:!0});g=(await navigator.mediaDevices.enumerateDevices()).filter(S=>S.kind==="videoinput"),b.getTracks().forEach(S=>{S.stop()})}const m=[],C=[];if(this._allCameras)for(let b of this._allCameras)b._checked&&C.push(b);for(let b=0;b<g.length;b++){let S,x=g[b];for(let R of C)if(x.deviceId==R.deviceId){S=R;break}S||(S={deviceId:x.deviceId,label:x.label?x.label:"camera "+b,_checked:!1}),S.deviceId&&m.push(S)}return this._allCameras=m,lt._onLog&&lt._onLog("DCE: "+JSON.stringify(this._allCameras)),m}_renderSelCameraInfo(){if(!this._selCam)return;let c;this._selCam.textContent="";for(let g of this._allCameras){const m=document.createElement("option");m.value=g.deviceId,m.innerText=g.label,this._selCam.append(m),g.deviceId&&this._currentCamera&&this._currentCamera.deviceId==g.deviceId&&(c=m)}this._selCam.value=c?c.value:""}getSelectedCamera(){if(!this._bOpen){let c="";const g=this.videoSettings.video.deviceId;g&&(c=g.exact||g.ideal||g);for(let m of this._allCameras)if(m.deviceId===c)return JSON.parse(JSON.stringify(m));return{deviceId:c,label:"",_checked:!1}}return this._currentCamera}async selectCamera(c){let g="";if(c&&(g=c.deviceId||c),this.videoSettings.video.deviceId={exact:g},!this._bOpen||this._video.paused)return null;let m=null;this._currentCamera&&(m=this._currentCamera.deviceId);const C=this._video.videoWidth,b=this._video.videoHeight,S=await this.play(c.deviceId||c);if(this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this.singleFrameMode&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1)),m!==S.deviceId){const x=this.mapCameraEvents.get("camerachange");for(let R of x){if(!R)continue;const O=JSON.parse(JSON.stringify(S));setTimeout(()=>{this.isDisposed&&this.disposed||R.apply(this,[O])},0)}}if(C!==S.width||b!==S.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let R of this._arrScanRegionOverlays)R&&this._updateScanRegionOverlay(R);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const x=this.mapCameraEvents.get("resolutionchange");for(let R of x){if(!R)continue;const O=JSON.parse(JSON.stringify(S));setTimeout(()=>{this.isDisposed&&this.disposed||R.apply(this,[O])},0)}}return S}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let c=0,g=0;const m=this.videoSettings.video.width,C=this.videoSettings.video.height;return m&&(c=m.exact||m.ideal||m),C&&(g=C.exact||C.ideal||C),[c,g]}}async setResolution(c,g){let m,C;if(c instanceof Array?(m=c[0],C=c[1]):(m=c,C=g),this.videoSettings.video.width={ideal:m},this.videoSettings.video.height={ideal:C},!this._bOpen||this._video.paused)return null;const b=this._video.videoWidth,S=this._video.videoHeight,x=await this.play(null,m,C);if(b!==x.width||S!==x.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let O of this._arrScanRegionOverlays)O&&this._updateScanRegionOverlay(O);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const R=this.mapCameraEvents.get("resolutionchange");for(let O of R){if(!O)continue;const E=JSON.parse(JSON.stringify(x));setTimeout(()=>{this.isDisposed&&this.disposed||O.apply(this,[E])},0)}}return x}async getResolutions(c){var g,m;let C="";const b=(x,R)=>{const O=this._mapCameraResolutions.get(x);if(!O||!O.length)return!1;for(let E of O)if(E[0]===R.width&&E[1]===R.height)return!0;return!1},S=async(x,R,O)=>{const E={video:{deviceId:{exact:x},width:{ideal:R},height:{ideal:O}}};let V=null;try{V=await navigator.mediaDevices.getUserMedia(E)}catch{return null}if(!V)return null;const j=V.getVideoTracks();let tt=null;try{const K=j[0].getSettings();tt={width:K.width,height:K.height}}catch{const J=document.createElement("video");J.srcObject=V,tt={width:J.videoWidth,height:J.videoHeight},J.srcObject=null}return j.forEach(K=>{K.stop()}),tt};if(!this._bOpen){const x=(m=(g=this.videoSettings)===null||g===void 0?void 0:g.video)===null||m===void 0?void 0:m.deviceId;if(!x||(C=x.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:x.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!C))return null;let R=this._mapCameraResolutions.get(C);if(R&&!c)return this._mapCameraResolutions.get(C);this._mapCameraResolutions.set(C,[]),R=this._mapCameraResolutions.get(C);for(let O of this._predefinedResolutions){const E=await S(C,O.width,O.height);E&&!b(C,E)&&R.push([E.width,E.height])}return R}if(this._currentCamera){C=this._currentCamera.deviceId;let x=this._mapCameraResolutions.get(C);if(x&&!c)return this._mapCameraResolutions.get(C);this._mapCameraResolutions.set(C,[]),x=this._mapCameraResolutions.get(C);let R=this._videoTrack;for(let O of this._predefinedResolutions){await R.applyConstraints({width:{ideal:O.width},height:{ideal:O.height}});const E=R.getSettings(),V={width:E.width,height:E.height};b(C,V)||x.push([V.width,V.height])}return this._video.srcObject.getTracks().forEach(O=>{O.stop()}),await this.play(C,null,null,{notTriggerPlayedEvent:!0}),x}return null}on(c,g){if(!g)return;const m=this.mapCameraEvents.get(c.toLowerCase());if(!m)throw new Error(`Event '${c}' does not exist.`);m.includes(g)||m.push(g)}off(c,g){const m=this.mapCameraEvents.get(c.toLowerCase());if(!m)throw new Error(`Event '${c}' does not exist.`);const C=m.indexOf(g);C!==-1&&m.splice(C,1)}offAll(c){if(c){if(typeof c=="string"){const g=this.mapCameraEvents.get(c);g&&(g.length=0)}}else for(let g of this.mapCameraEvents.values())g&&(g.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(c){if(this.videoSettings=JSON.parse(JSON.stringify(c)),this._lastDeviceId=null,this._bOpen)return this.play()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}async applyConstraints(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return await this._videoTrack.applyConstraints(c)}async turnOnTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}async turnOffTorch(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}async setColorTemperature(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let g=this.getCapabilities().colorTemperature;if(!g)throw Error("Not supported.");return c<g.min?c=g.min:c>g.max&&(c=g.max),await this._videoTrack.applyConstraints({advanced:[{colorTemperature:c,whiteBalanceMode:"manual"}]})}getColorTemperature(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getColorTemperature()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().colorTemperature||0:null}async setExposureCompensation(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let g=this.getCapabilities().exposureCompensation;if(!g)throw Error("Not supported.");return c<g.min?c=g.min:c>g.max&&(c=g.max),await this._videoTrack.applyConstraints({advanced:[{exposureCompensation:c}]})}getExposureCompensation(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getExposureCompensation()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().exposureCompensation||0:null}async _setHardwareScale(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setHardwareScale()' is unavailable in singleFrameMode.");if(c<1)throw new RangeError("Invalid value.");if(!this._videoTrack)return;const g=this.getCapabilities().zoom;if(!g)throw new Error("Not supported.");return c<g.min?c=g.min:c>g.max&&(c=g.max),c=Lt(c,g.min,g.step,g.max),await this._videoTrack.applyConstraints({advanced:[{zoom:c}]}),c}_getHardwareScale(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().zoom||1:null}_setSoftwareScale(c,g){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setSoftwareScale()' is unavailable in singleFrameMode.");if(c<1)throw new RangeError("Invalid value.");g&&this._setScaleCenter(g),this._softwareScale=c,this._scaleVideo(c,g)}_getSoftwareScale(){return this._softwareScale}_setScaleCenter(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_setScaleCenter()' is unavailable in singleFrameMode.");if(!c||typeof c.x!="string"||typeof c.y!="string")throw new Error("Invalid center.");const g=this._video.videoWidth,m=this._video.videoHeight;let C=0,b=0;if(c.x.endsWith("px"))C=parseFloat(c.x);else{if(!c.x.endsWith("%"))throw new Error("Invalid scale center.");C=parseFloat(c.x)/100*g}if(c.y.endsWith("px"))b=parseFloat(c.y);else{if(!c.y.endsWith("%"))throw new Error("Invalid scale center.");b=parseFloat(c.y)/100*m}if(C==NaN||b==NaN)throw new Error("Invalid scale center.");this._scaleCenter={x:C,y:b}}_resetScaleCenter(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_resetScaleCenter()' is unavailable in singleFrameMode.");const c=this._video.videoWidth,g=this._video.videoHeight;this._scaleCenter={x:c/2,y:g/2}}_isVideoCenter(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_isVideoCenter()' is unavailable in singleFrameMode.");return c&&c.x==this._video.videoWidth/2&&c.y==this._video.videoHeight/2}async _setZoom(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(c<1)throw new RangeError("Invalid value.");this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const g=await this._setHardwareScale(c);let m=this._getHardwareScale();m==1&&g!=1&&(m=g),c>m?this._setSoftwareScale(c/m):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(c)}catch(g){if((g.message||g)!=="Not supported.")throw g;this._setSoftwareScale(c)}}async setZoom(c){if(typeof c!="number"&&typeof c!="object")throw new TypeError("Illegal type of argument.");if(typeof c=="number")return this._setZoom(c);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(c){if(typeof c.factor!="number")throw new TypeError("Illegal type of 'factor'.");if(c.factor<1)throw new RangeError("Invalid value.");c.centerPoint?this._setScaleCenter(c.centerPoint):this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const g=await this._setHardwareScale(c.factor);let m=this._getHardwareScale();m==1&&g!=1&&(m=g),c.factor>m?this._setSoftwareScale(c.factor/m):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(c.factor)}catch(g){if((g.message||g)!=="Not supported.")throw g;this._setSoftwareScale(c.factor)}}}getZoom(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?this._getHardwareScale()*this._softwareScale:null}getZoomSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?{factor:this._getHardwareScale()*this._softwareScale}:null}async resetZoom(){await this.setZoom({factor:1})}async setFrameRate(c){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let g=this.getCapabilities().frameRate;if(!g)throw Error("Not supported.");return c<g.min?c=g.min:c>g.max&&(c=g.max),await this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:c})}getFrameRate(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrameRate()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().frameRate:null}async _setFocus(c,g){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(typeof c!="string")throw Error("Invalid focus mode.");c=c.toLowerCase();const m=this.getCapabilities().focusMode,C=this.getCapabilities().focusDistance;if(!m)throw Error("Not supported.");if(!m.includes(c))throw Error("Unsupported mode.");if(g>=0){if(!C)throw Error("Manual focus unsupported.");return g<C.min?g=C.min:g>C.max&&(g=C.max),g=Lt(g,C.min,C.step,C.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:c,focusDistance:g}]})}return await this._videoTrack.applyConstraints({advanced:[{focusMode:c}]})}async setFocus(c,g){if(typeof c=="string")return this._setFocus(c,g);if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(!c)return;const m=this.getCapabilities(),C=m.focusMode,b=m.focusDistance;if(!C)throw Error("Not supported.");if(typeof c.mode!="string")throw Error("Invalid focus mode.");const S=c.mode.toLowerCase();if(!C.includes(S))throw Error("Unsupported focus mode.");if(S!=="manual")return this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:S}]});if(!b)throw Error("Manual focus unsupported.");if(c.hasOwnProperty("distance")){let x=c.distance;return x<b.min?x=b.min:x>b.max&&(x=b.max),x=Lt(x,b.min,b.step,b.max),this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:S,focusDistance:x}]})}if(!c.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const x=c.area.centerPoint;let R=c.area.width,O=c.area.height;if(!R||!O){const E=this._video.videoWidth,V=this._video.videoHeight;R||(R=2*Math.round(Math.min(E,V)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),O||(O=2*Math.round(Math.min(E,V)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters._focusArea={centerPoint:{x:x.x,y:x.y},width:R,height:O},await this._setLocalFocus(x,R,O)}}getFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const c=this._videoTrack.getSettings().focusMode;return c?c==="continuous"?{mode:c}:{mode:c,distance:this._videoTrack.getSettings().focusDistance}:null}getFocusSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const c=this._videoTrack.getSettings(),g=c.focusMode;return g?g==="manual"?this._focusParameters._focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters._focusArea))}:{mode:"manual",distance:c.focusDistance}:{mode:g}:null}async _setFocusAndGetContract(c,g){const m=j=>{if(!this._bOpen||!this._videoTrack||this.video.paused||j.focusTaskId!=this._focusParameters.curFocusTaskId){this._bOpen&&this._videoTrack&&!this.video.paused||(this._focusParameters.isDoingFocus=0);const tt=new Error(`Focus task ${j.focusTaskId} canceled.`);throw tt.name="DeprecatedTaskError",tt}this._focusParameters.isDoingFocus===1&&Date.now()-j.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let C;g=Lt(g,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:g}]}),m(c),C=this._focusParameters.oldDistance==null?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/g),Math.abs(1/this._focusParameters.fds.max-1/g))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/g)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=g,await new Promise(j=>{setTimeout(j,C)}),m(c);let b=c.focusL-c.focusW/2,S=c.focusT-c.focusH/2,x=c.focusW,R=c.focusH;if(b>=this.video.videoWidth||S>=this.video.videoHeight)throw new Error("Invalid area.");b+x>this.video.videoWidth&&(x=this.video.videoWidth-b),S+R>this.video.videoHeight&&(R=this.video.videoHeight-S);const O=this._getImageData(this.video,this.video.videoWidth,this.video.videoHeight,{sx:b,sy:S,sWidth:x,sHeight:R,dWidth:x,dHeight:R},null,{pixelFormat:yt.RGBA});if(!O)return this._setFocusAndGetContract(c,g);const E=O.data;let V=0;for(let j=0,tt=E.length-8;j<tt;++j){let K=E[j]-E[j+8];++j;let J=E[j]-E[j+8];++j;let Z=E[j]-E[j+8];++j,V+=K*K+J*J+Z*Z}return-V}async _doFocusDetail(c,g,m,C,b,S,x){let R;if(g=Lt(g,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),C=Lt(C,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),S?S=Lt(S,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(S=Lt(Math.sqrt((g||this._focusParameters.fds.step)*(C||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),x=await this._setFocusAndGetContract(c,S)),x<=m&&x<=b?R=3:m<b&&m<x?R=1:b<m&&b<x&&(R=2),(C-g)/2<=this._focusParameters.fds.step)return R===3||(R===1?await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:g}]}):R===2&&await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:C}]})),!0;if(R===1)return await this._doFocusDetail(c,g,m,S,x);if(R===2)return await this._doFocusDetail(c,S,x,C,b);if(R!==3)return m=await this._setFocusAndGetContract(c,g),b=await this._setFocusAndGetContract(c,C),await this._doFocusDetail(c,g,m,C,b);let O=Lt(Math.sqrt((g||this._focusParameters.fds.step)*(S||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),E=Lt(Math.sqrt((C||this._focusParameters.fds.step)*(S||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/O)<=Math.abs(1/this._focusParameters.oldDistance-1/E)){let V=await this._setFocusAndGetContract(c,O);if(V<x)return await this._doFocusDetail(c,g,m,S,x,O,V);if(V==x)return await this._doFocusDetail(c,O,V,S,x);let j=await this._setFocusAndGetContract(c,E);if(V>x&&x<j)return await this._doFocusDetail(c,O,V,E,j,S,x);if(x==j)return await this._doFocusDetail(c,S,x,E,j);if(x>j)return await this._doFocusDetail(c,S,x,C,b,E,j)}else{let V=await this._setFocusAndGetContract(c,E);if(x>V)return await this._doFocusDetail(c,S,x,C,b,E,V);if(x==V)return await this._doFocusDetail(c,S,x,E,V);let j=await this._setFocusAndGetContract(c,O);if(j>x&&x<V)return await this._doFocusDetail(c,O,j,E,V,S,x);if(j==x)return await this._doFocusDetail(c,O,j,S,x);if(j<x)return await this._doFocusDetail(c,g,m,S,x,O,j)}return!1}async _setLocalFocus(c,g,m,C,b){if(this._focusParameters.isDoingFocus==1)return!1;if(!c||typeof c.x!="string"||typeof c.y!="string")throw new Error("Invalid centerPoint.");if(!g||typeof g!="string")throw new Error("Invalid width.");if(!m||typeof m!="string")throw new Error("Invalid height.");const S=this._video.videoWidth,x=this._video.videoHeight;let R=0,O=0;if(c.x.endsWith("px"))R=parseFloat(c.x);else{if(!c.x.endsWith("%"))throw new Error("Invalid centerPoint.");R=parseFloat(c.x)/100*S}if(c.y.endsWith("px"))O=parseFloat(c.y);else{if(!c.y.endsWith("%"))throw new Error("Invalid centerPoint.");O=parseFloat(c.y)/100*x}if(R==NaN||O==NaN)throw new Error("Invalid centerPoint.");let E=0;if(g.endsWith("px"))E=parseFloat(g);else{if(!g.endsWith("%"))throw new Error("Invalid width.");E=parseFloat(g)/100*S}if(E==NaN)throw new Error("Invalid width.");let V=0;if(m.endsWith("px"))V=parseFloat(m);else{if(!m.endsWith("%"))throw new Error("Invalid height.");V=parseFloat(m)/100*x}if(V==NaN)throw new Error("Invalid height.");if(this._softwareScale!==1){const K=this._softwareScale,J=this._scaleCenter;E/=K,V/=K,R=(1-1/K)*J.x+R/K,O=(1-1/K)*J.y+O/K}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");this._focusParameters.kTimeout==null&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const j={focusL:R,focusT:O,focusW:E,focusH:V,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},tt=async(K,J,Z)=>{try{(J==null||J<this._focusParameters.fds.min)&&(J=this._focusParameters.fds.min),(Z==null||Z>this._focusParameters.fds.max)&&(Z=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let ht=Lt(Math.sqrt(Z*(J||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),at=Lt(Math.sqrt((J||this._focusParameters.fds.step)*ht),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),st=Lt(Math.sqrt(ht*Z),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),dt=await this._setFocusAndGetContract(K,st),gt=await this._setFocusAndGetContract(K,at),pt=await this._setFocusAndGetContract(K,ht);if(gt>pt&&pt<dt){const vt=await this._doFocusDetail(K,at,gt,st,dt,ht,pt);return this._focusParameters.isDoingFocus=0,vt}if(gt<pt&&gt<dt){let vt=await this._setFocusAndGetContract(K,J);const d=await this._doFocusDetail(K,J,vt,ht,pt,at,gt);return this._focusParameters.isDoingFocus=0,d}if(pt>dt&&gt>dt){let vt=await this._setFocusAndGetContract(K,Z);const d=await this._doFocusDetail(K,ht,pt,Z,vt,st,dt);return this._focusParameters.isDoingFocus=0,d}if(gt==pt&&pt<dt){const vt=await this._doFocusDetail(K,at,gt,ht,pt);return this._focusParameters.isDoingFocus=0,vt}if(pt==dt&&gt>pt){const vt=await this._doFocusDetail(K,ht,pt,st,dt);return this._focusParameters.isDoingFocus=0,vt}return tt(K,J,Z)}catch(ht){if(ht.name!=="DeprecatedTaskError")throw ht}};return tt(j,C,b)}async enableTapToFocus(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'enableTapToFocus()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error("Video is not playing.");if(!this._focusSupported)throw new Error("Tapping to focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,this._tapFocusEnabled=!1,new Error("Tapping to focus unsupported.");this._tapFocusEnabled=!0}disableTapToFocus(){this._tapFocusEnabled=!1}isTapToFocusEnabled(){return this._tapFocusEnabled}_updateVideoContainerStyle(){if(!this._video||this.singleFrameMode)return;const c=this._getSoftwareScale(),g=this._videoContainer;if(this.videoFit==="contain"&&c>1){const m=this._video.videoWidth,C=this._video.videoHeight,b=window.getComputedStyle(this._elContainer),S=parseFloat(b.width),x=parseFloat(b.height),R=m/C;if(S/x<R){let O=S/R;g.style.left="0",g.style.top=(x-O)/2/x*100+"%",g.style.width="100%",g.style.height=O/x*100+"%"}else{let O=x*R;g.style.left=(S-O)/2/S*100+"%",g.style.top="0",g.style.width=O/S*100+"%",g.style.height="100%"}}else g.style.left="0",g.style.top="0",g.style.width="100%",g.style.height="100%"}_scaleVideo(c,g){if(this._video&&!this.singleFrameMode){if(c<1)throw new RangeError("Invalid scale value.");if(g&&this._setScaleCenter(g),c===1)this._video.style.transform="";else{const m=this.getVideoFit(),C=this._video.videoWidth,b=this._video.videoHeight,S=window.getComputedStyle(this._elContainer),x=parseFloat(S.width),R=parseFloat(S.height),O=x/R,E=C/b;let V=1;m==="contain"?V=O<E?x/(C/c):R/(b/c):m==="cover"&&(V=E>O?R/(C/c):x/(b/c));const j=V*(1-1/c)*(C/2-this._scaleCenter.x),tt=V*(1-1/c)*(b/2-this._scaleCenter.y);this._video.style.transform=`translate(${j}px, ${tt}px) scale(${c})`}this._updateVideoContainerStyle()}}getFrameSize(c,g,m,C){if(!c||!g)return null;let b,S,x,R,O=c,E=g;const V={regionLeft:0,regionTop:0,regionRight:O,regionBottom:E,regionMeasuredByPercentage:!1};m?(m.regionMeasuredByPercentage?(V.regionLeft=m.regionLeft*O/100,V.regionTop=m.regionTop*E/100,V.regionRight=m.regionRight*O/100,V.regionBottom=m.regionBottom*E/100):(V.regionLeft=m.regionLeft,V.regionTop=m.regionTop,V.regionRight=m.regionRight,V.regionBottom=m.regionBottom),b=Math.round(V.regionLeft),S=Math.round(V.regionTop),O=Math.round(V.regionRight-V.regionLeft),E=Math.round(V.regionBottom-V.regionTop)):(b=0,S=0,O=Math.round(O),E=Math.round(E));const j=Math.max(O,E);if(C&&C>0&&j>C){const tt=C/j;O>E?(x=C,R=Math.round(E*tt)):(x=Math.round(O*tt),R=C)}else x=O,R=E;return x<=0||R<=0?null:{sx:b,sy:S,sWidth:O,sHeight:E,dWidth:x,dHeight:R}}getFrame(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoData()}getImage(){return this.getFrame()}_drawImage(c,g,m,C,b,S,x){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!m||!C)return null;if(g instanceof HTMLVideoElement&&g.readyState!==4||g instanceof HTMLImageElement&&!g.complete)throw new Error("The source is not loaded.");let R;lt._onLog&&(R=Date.now(),lt._onLog("DCE: _drawImage(), START: "+R));let O=0,E=0,V=m,j=C,tt=0,K=0,J=m,Z=C;b&&(b.sx&&(O=Math.round(b.sx)),b.sy&&(E=Math.round(b.sy)),b.sWidth&&(V=Math.round(b.sWidth)),b.sHeight&&(j=Math.round(b.sHeight)),b.dx&&(tt=Math.round(b.dx)),b.dy&&(K=Math.round(b.dy)),b.dWidth&&(J=Math.round(b.dWidth)),b.dHeight&&(Z=Math.round(b.dHeight)));let ht=yt.RGBA;x&&x.pixelFormat&&(ht=x.pixelFormat);const at=c;if(x&&x.bUseWebGL){lt._onLog&&lt._onLog("DCE: _drawImage() in WebGL."),(at.width<tt+J||at.height<K+Z)&&(at.width=tt+J,at.height=K+Z,at.ctxWebGL&&at.ctxWebGL.viewport(0,0,tt+J,K+Z));const st=at.ctxWebGL||at.getContext("webgl",{antialias:!1})||at.getContext("experimental-webgl",{antialias:!1});if(!st){lt._onLog&&lt._onLog("DCE: WebGL unavailable.");const d=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw d.name="WebGLError",d}if(!at.ctxWebGL||ht!==this.shaderPixelFormat){at.ctxWebGL=st;const d=t=>{const e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW);const s=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW),{positions:e,texCoords:s}},mt=t=>{const e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e},Ct=(t,e)=>{const s=t.createProgram();if(e.forEach(l=>t.attachShader(s,l)),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const l=new Error(`An error occured linking the program: ${t.getProgramInfoLog(s)}.`);throw l.name="WebGLError",l}return t.useProgram(s),s},It=(t,e,s)=>{const l=t.createShader(e);if(t.shaderSource(l,s),t.compileShader(l),!t.getShaderParameter(l,t.COMPILE_STATUS)){const a=new Error(`An error occured compiling the shader: ${t.getShaderInfoLog(l)}.`);throw a.name="WebGLError",a}return l},n=`
                    attribute vec2 a_position;
                    attribute vec2 a_texCoord;

                    uniform mat3 u_matrix;
                    uniform mat3 u_textureMatrix;

                    varying vec2 v_texCoord;
                    void main(void) {
                    gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);
                    v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;
                    }
                `;let i="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(ht)&&(i=ht.slice(0,3));const r=`
                    precision mediump float;
                    varying vec2 v_texCoord;
                    uniform sampler2D u_image;
                    uniform float uColorFactor;

                    void main() {
                        vec4 sample = texture2D(u_image, v_texCoord);
                        float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;
                        gl_FragColor = vec4(sample.${i} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);
                    }
                `,o=Ct(st,[It(st,st.VERTEX_SHADER,n),It(st,st.FRAGMENT_SHADER,r)]);this._webGLProgramInfo={program:o,attribLocations:{vertexPosition:st.getAttribLocation(o,"a_position"),texPosition:st.getAttribLocation(o,"a_texCoord")},uniformLocations:{uSampler:st.getUniformLocation(o,"u_image"),uColorFactor:st.getUniformLocation(o,"uColorFactor"),uMatrix:st.getUniformLocation(o,"u_matrix"),uTextureMatrix:st.getUniformLocation(o,"u_textureMatrix")}},this._webGLBuffers=d(st),this._webGLTexture=mt(st),this.shaderPixelFormat=ht}const dt=(d,mt,Ct)=>{d.bindBuffer(d.ARRAY_BUFFER,mt),d.enableVertexAttribArray(Ct),d.vertexAttribPointer(Ct,2,d.FLOAT,!1,0,0)},gt=(d,mt,Ct)=>{const It=d.RGBA,n=d.RGBA,i=d.UNSIGNED_BYTE;d.bindTexture(d.TEXTURE_2D,mt),d.texImage2D(d.TEXTURE_2D,0,It,n,i,Ct)},pt=(d,mt,Ct,It)=>{d.clearColor(0,0,0,1),d.clearDepth(1),d.enable(d.DEPTH_TEST),d.depthFunc(d.LEQUAL),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),dt(d,Ct.positions,mt.attribLocations.vertexPosition),dt(d,Ct.texCoords,mt.attribLocations.texPosition),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,It),d.uniform1i(mt.uniformLocations.uSampler,0),d.uniform1f(mt.uniformLocations.uColorFactor,[yt.GREY,yt.GREY32].includes(ht)?1:0);let n,i,r=kt.translate(kt.identity(),-1,-1);r=kt.scale(r,2,2),r=kt.scale(r,1/d.canvas.width,1/d.canvas.height),n=kt.translate(r,tt,K),n=kt.scale(n,J,Z),d.uniformMatrix3fv(mt.uniformLocations.uMatrix,!1,n),i=kt.translate(kt.identity(),O/m,E/C),i=kt.scale(i,V/m,j/C),d.uniformMatrix3fv(mt.uniformLocations.uTextureMatrix,!1,i),d.drawArrays(d.TRIANGLES,0,6)};let vt;if(gt(st,this._webGLTexture,g),pt(st,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),S){if(S.length<J*Z*4)throw new Error("Unexpected size of the 'bufferContainer'.");vt=S}else vt=new Uint8Array(J*Z*4);if(st.readPixels(tt,K,J,Z,st.RGBA,st.UNSIGNED_BYTE,vt),vt[3]!==255){lt._onLog&&lt._onLog("DCE: WebGL drawing incorrect."),this._bWebGLSupported=!1;const d=new Error("WebGL error: incorrect WebGL drawing.");throw d.name="WebGLError",d}return lt._onLog&&lt._onLog("DCE: _drawImage() in WebGL end. Costs: "+(Date.now()-R)),{context:st,pixelFormat:ht===yt.GREY?yt.GREY32:ht,_bUseWebGL:!0}}{lt._onLog&&lt._onLog("DCE: _drawImage() in context2d."),at.ctx2d||(at.ctx2d=at.getContext("2d",{willReadFrequently:!0}));const st=at.ctx2d;if(!st)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(at.width<tt+J||at.height<K+Z)&&(at.width=tt+J,at.height=K+Z),st.drawImage(g,O,E,V,j,tt,K,J,Z),lt._onLog&&lt._onLog("DCE: _drawImage() in context2d end. Costs: "+(Date.now()-R)),{context:st,pixelFormat:yt.RGBA,_bUseWebGL:!1}}}_readCvsData(c,g,m){let C,b=0,S=0,x=c.canvas.width,R=c.canvas.height;if(g&&(g.x&&(b=g.x),g.y&&(S=g.y),g.width&&(x=g.width),g.height&&(R=g.height)),c instanceof WebGLRenderingContext){const O=c;if(m){if(m.length<x*R*4)throw new Error("Unexpected size of the 'bufferContainer'.");O.readPixels(b,S,x,R,O.RGBA,O.UNSIGNED_BYTE,m),C=new Uint8Array(m.buffer,0,x*R*4)}else C=new Uint8Array(x*R*4),O.readPixels(b,S,x,R,O.RGBA,O.UNSIGNED_BYTE,C)}else if(c instanceof CanvasRenderingContext2D){let O;if(O=c.getImageData(b,S,x,R),C=new Uint8Array(O.data.buffer),m){if(m.length<C.length)throw new Error("Unexpected size of the 'bufferContainer'.");m.set(C)}}return C}_transformPixelFormat(c,g,m,C){let b,S;if(lt._onLog&&(b=Date.now(),lt._onLog("DCE: _transformPixelFormat(), START: "+b)),g===m)return lt._onLog&&lt._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-b)),C?new Uint8Array(c):c;const x=[yt.RGBA,yt.RBGA,yt.GRBA,yt.GBRA,yt.BRGA,yt.BGRA];if(x.includes(g))if(m===yt.GREY){S=new Uint8Array(c.length/4);for(let R=0;R<c.length;R+=4){const O=.21*c[R]+.71*c[R+1]+.07*c[R+2];S[R/4]=O}}else if(m===yt.GREY32){S=C?new Uint8Array(c):c;for(let R=0;R<c.length;R+=4){const O=.21*c[R]+.71*c[R+1]+.07*c[R+2];S[R]=O,S[R+1]=O,S[R+2]=O}}else{if(!x.includes(m))throw new Error("Unable to transform.");if(C){S=new Uint8Array(c);const R=g.indexOf("r"),O=g.indexOf("g"),E=g.indexOf("b"),V=m.indexOf("r"),j=m.indexOf("g"),tt=m.indexOf("b");for(let K=0;K<c.length;K+=4)S[K+V]=c[K+R],S[K+j]=c[K+O],S[K+tt]=c[K+E]}else{S=c;const R=g.indexOf("r"),O=g.indexOf("g"),E=g.indexOf("b"),V=m.indexOf("r"),j=m.indexOf("g"),tt=m.indexOf("b");for(let K=0;K<c.length;K+=4){let J=[c[K],c[K+1],c[K+2]];S[K+V]=J[R],S[K+j]=J[O],S[K+tt]=J[E]}}}else if(g===yt.GREY){if(m!==yt.GREY32)throw new Error("Unable to transform.");S=new Uint8Array(4*c.length);for(let R=0;R<c.length;R++)S[4*R]=c[R],S[4*R+1]=c[R],S[4*R+2]=c[R],S[4*R+3]=255}else{if(g!==yt.GREY32)throw new Error("Unable to transform.");if(m!==yt.GREY)throw new Error("Unable to transform.");S=new Uint8Array(new Uint32Array(c.buffer))}return lt._onLog&&lt._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-b)),S}_getImageData(c,g,m,C,b,S){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!g||!m)return null;if(C.sx>g||C.sy>m||C.sx+C.sWidth>g||C.sy+C.sHeight>m)throw new Error("Invalid position.");if(c instanceof HTMLVideoElement&&c.readyState!==4||c instanceof HTMLImageElement&&!c.complete)throw new Error("The source is not loaded.");let x;lt._onLog&&(x=Date.now(),lt._onLog("DCE: _getImageData(), START: "+x));const R=Math.round(C.sx),O=Math.round(C.sy),E=Math.round(C.sWidth),V=Math.round(C.sHeight),j=Math.round(C.dWidth),tt=Math.round(C.dHeight);let K=yt.RGBA;S&&S.pixelFormat&&(K=S.pixelFormat);let J,Z,ht,at=this._bWebGLSupported;S&&S.bUseWebGL==0&&(at=!1),at?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),J=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),J=this._reusedCvs);try{if(at)if(lt._onLog&&lt._onLog("DCE: _getImageData() in WebGL."),b)if(K===yt.GREY){if(ht=new Uint8Array(j*tt*4),Z=this._drawImage(J,c,g,m,{sx:R,sy:O,sWidth:E,sHeight:V,dWidth:j,dHeight:tt},ht,{pixelFormat:K,bUseWebGL:at}),ht=this._transformPixelFormat(ht,Z.pixelFormat,K),b){if(b.length<ht.length)throw new Error("Unexpected size of the 'bufferContainer'.");b.set(ht)}}else Z=this._drawImage(J,c,g,m,{sx:R,sy:O,sWidth:E,sHeight:V,dWidth:j,dHeight:tt},b,{pixelFormat:K,bUseWebGL:at}),ht=new Uint8Array(b.buffer,0,j*tt*4),ht=this._transformPixelFormat(ht,Z.pixelFormat,K);else K===yt.GREY?((!this._tempDataContainer||this._tempDataContainer.length<j*tt*4)&&(this._tempDataContainer=new Uint8Array(j*tt*4)),ht=new Uint8Array(this._tempDataContainer.buffer,0,j*tt*4)):ht=new Uint8Array(j*tt*4),Z=this._drawImage(J,c,g,m,{sx:R,sy:O,sWidth:E,sHeight:V,dWidth:j,dHeight:tt},ht,{pixelFormat:K,bUseWebGL:at}),ht=this._transformPixelFormat(ht,Z.pixelFormat,K);else if(lt._onLog&&lt._onLog("DCE: _getImageData() in context2d."),Z=this._drawImage(J,c,g,m,{sx:R,sy:O,sWidth:E,sHeight:V,dWidth:j,dHeight:tt},null,{pixelFormat:yt.RGBA,bUseWebGL:at}),ht=this._readCvsData(Z.context,null,null),ht=this._transformPixelFormat(ht,Z.pixelFormat,K),b){if(b.length<ht.length)throw new Error("Unexpected size of the 'bufferContainer'.");b.set(ht)}}catch(st){if(st.name==="WebGLError")return lt._onLog&&lt._onLog("DCE: _getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this._getImageData(c,g,m,{sx:R,sy:O,sWidth:E,sHeight:V,dWidth:j,dHeight:tt},b,S);throw st}return lt._onLog&&lt._onLog("DCE: _getImageData() end. Costs: "+(Date.now()-x)),{data:ht,pixelFormat:K,_bUseWebGL:Z._bUseWebGL}}forceLoseContext(){if(!this._reusedWebGLCvs)return;const c=this._reusedWebGLCvs.ctxWebGL;c&&!c.isContextLost()&&c.getExtension("WEBGL_lose_context")&&c.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCvs=null}_getVideoData(c,g){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getVideoData()' is unavailable in singleFrameMode.");if(!this._video||this._video.readyState!==4)return null;const m=Date.now();lt._onLog&&lt._onLog("DCE: _getVideoData() START: "+m);let C=this._scanRegion;g&&g.hasOwnProperty("region")&&(C=g.region);let b=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase());g&&g.pixelFormat&&(b=this.mapPixelFormatString_Enum.get(g.pixelFormat.toLowerCase()));let S=this._softwareScale;g&&g.scale&&(S=g.scale);const x=this._video.videoWidth,R=this._video.videoHeight;let O=this._scaleCenter;if(g&&g.scaleCenter){if(typeof g.scaleCenter.x!="string"||typeof g.scaleCenter.y!="string")throw new Error("Invalid scale center.");let J=0,Z=0;if(g.scaleCenter.x.endsWith("px"))J=parseFloat(g.scaleCenter.x);else{if(!g.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");J=parseFloat(g.scaleCenter.x)/100*x}if(g.scaleCenter.y.endsWith("px"))Z=parseFloat(g.scaleCenter.y);else{if(!g.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");Z=parseFloat(g.scaleCenter.y)/100*R}if(J==NaN||Z==NaN)throw new Error("Invalid scale center.");O.x=Math.round(J),O.y=Math.round(Z)}if(x===0||R===0)return null;const E=this.getFrameSize(x,R,C,this.maxCvsSideLength);if(!E)return null;let V=!0;x===E.sWidth&&R===E.sHeight&&(V=!1);const j={data:null,region:C?JSON.parse(JSON.stringify(C)):null,sx:E.sx,sy:E.sy,width:E.dWidth,height:E.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:V,toCanvas:this._toCanvas,_sWidth:E.sWidth,_sHeight:E.sHeight,_bUseWebGL:null};S!==1&&(E.sWidth=Math.round(E.sWidth/S),E.sHeight=Math.round(E.sHeight/S),E.sx=Math.round((1-1/S)*O.x+E.sx/S),E.sy=Math.round((1-1/S)*O.y+E.sy/S));const tt=this._getImageData(this._video,x,R,E,c,{pixelFormat:b});if(!tt)return null;const K=Date.now();return lt._onLog&&lt._onLog("DCE: _getVideoData() END: "+K),j.data=tt.data,j.pixelFormat=j.colorMode=tt.pixelFormat,j._bUseWebGL=tt._bUseWebGL,j.timeSpent=K-m,j.timeStamp=K,tt.pixelFormat===yt.GREY?j.stride=j.width:j.stride=4*j.width,j}getCurrentRegion(){let c=null;if(this._scanRegion)c=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");c=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return c}_fetchingLoop(c){if(this.isDisposed&&this.disposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const g=()=>{lt._onLog&&lt._onLog("DCE: start fetching a frame into buffer: "+Date.now());const C=this.getCurrentRegion();let b=this._getVideoData(null,{region:C});if(!b)return void(lt._onLog&&lt._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(b),lt._onLog&&lt._onLog("DCE: finish fetching a frame into buffer: "+Date.now());const S=this.mapCameraEvents.get("frameaddedtobuffer");for(let x of S)x&&setTimeout(()=>{this.isDisposed&&this.disposed||x.apply(this)},0)},m=()=>{this.isDisposed&&this.disposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout(()=>{this.isDisposed&&this.disposed||(this._bOpen&&this.isFetchingLoopStarted()?(lt._onLog&&lt._onLog("DCE: second timeout executes: "+Date.now()),g(),m()):this.stopFetchingLoop())},this.refreshInterval)))};c&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(g(),this.refreshInterval>0&&m()):this.refreshInterval>0?(g(),m()):this.refreshInterval===0?g():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._fetchingLoop(!0)},this.loopInterval)}startFetchingLoop(){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,lt._onLog&&lt._onLog("DCE: start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(lt._onLog&&lt._onLog("DCE: stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(c){return this._frameQueue&&this._frameQueue.length?c?c<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(c,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.pop()):null}clearFrameBuffer(){this._frameQueue&&(this._frameQueue.length=0)}_createDrawingLayerBaseCvs(){let c;this._assertOpen();try{c=this._calculateCvsSize()}catch(S){throw S}let{width:g,height:m,objectFit:C}=c;(g<=0||m<=0)&&(g=2,m=2);const b=document.createElement("canvas");if(b.width==g&&b.height==m||(b.width=g,b.height=m),b.style.objectFit=C,this._cvsScanRegion)this._cvsScanRegion.after(b);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(b);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(b);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(b)}return b}_updateDrawingLayersSize(c){let g;try{g=c&&c.width&&c.height&&c.objectFit?{width:c.width,height:c.height,objectFit:c.objectFit}:this._calculateCvsSize()}catch(S){if((S.message||S)==="Invalid content dimensions.")return;throw S}const{width:m,height:C,objectFit:b}=g;this._drawingLayersManager.setDimensions({width:m,height:C},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(b)}_createDrawingLayer(c){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const g=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(g,c)}deleteDrawingLayer(c){this._drawingLayersManager.deleteDrawingLayer(c),this._drawingLayersManager.getDrawingLayers().length||this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(c){return this._drawingLayersManager.getDrawingLayer(c)||([1,2,3].includes(c)?this._createDrawingLayer(c):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers().filter(c=>c.getId()>=0)}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(c){return this._drawingLayersManager.createDrawingStyle(c)}getDrawingStyle(c){return this._drawingLayersManager.getDrawingStyle(c)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(c,g){return this._drawingLayersManager.updateDrawingStyle(c,g)}clearDrawingLayers(){const c=this.getDrawingLayers();for(let g of c)this.deleteDrawingLayer(g.getId())}showTip(c,g,m,C,b=3e3,S=!0){this._assertOpen(),this._tipArgs.x=c,this._tipArgs.y=g,this._tipArgs.width=m,this._tipArgs.autoShowSuggestedTip=!!S,this._drawingLayerOfTip||(this._drawingLayerOfTip=this._createDrawingLayer(-1)),this._tipStyleId||(this._tipStyleId=this.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip.clearDrawingItems();const x=new Ri(C||"",c,g,m,this._tipStyleId);x._fabricObject.paddingTop=15,x._fabricObject.calcTextHeight=function(){for(var R=0,O=0,E=this._textLines.length;O<E;O++)R+=this.getHeightOfLine(O);return R+=2*this.paddingTop},x._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},x.setAttribute("backgroundColor","rgba(50, 50, 52, .8)"),x.setAttribute("lineHeight",1.3),x.setAttribute("textAlign","center"),this._drawingLayerOfTip.addDrawingItem(x),this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._tipArgs.duration=b===void 0?3e3:b,this._tipArgs.duration>0&&(this._hideTipTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._hideTip()},this._tipArgs.duration))}_hideTip(){this._drawingLayerOfTip&&(this.deleteDrawingLayer(this._drawingLayerOfTip.getId()),this._drawingLayerOfTip=null,this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId))}hideTip(){this._hideTip(),this._tipArgs.x=null,this._tipArgs.y=null,this._tipArgs.width=null,this._tipArgs.autoShowSuggestedTip=null}updateTipMessage(c){if(!this._drawingLayerOfTip)throw new Error("The Tip is not showing.");this._drawingLayerOfTip.getDrawingItems()[0].setAttribute("text",c),this._drawingLayerOfTip.renderAll(),this._tipArgs.duration>0&&(this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._hideTipTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._hideTip()},this._tipArgs.duration))}suggestTip(c,g){this._tipArgs.autoShowSuggestedTip&&(this._drawingLayerOfTip?this.updateTipMessage(g):this._tipArgs.x!==void 0&&this.showTip(this._tipArgs.x,this._tipArgs.y,this._tipArgs.width,g,this._tipArgs.duration)),this.onTipSuggested&&setTimeout(()=>{this.isDisposed&&this.disposed||this.onTipSuggested.apply(this,[c,g])},0)}_createControler(){if(this._controler||(this._controler=new Li(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(c,g,m){if(!c||!g||!m)throw new Error("Invalid arguments");this._originalImageData={imageData:c,width:g,height:m};let C=this._cvsOriginalImage;C||(C=document.createElement("canvas"),C.style.position="absolute",C.style.width="100%",C.style.height="100%",C.style.left="0",C.style.top="0",C.style.backgroundColor="white",C.style.objectFit="contain",this._cvsOriginalImage=C),C.width===g&&C.height===m||(C.width=g,C.height=m);const b=C.getContext("2d");b.clearRect(0,0,C.width,C.height),c instanceof Uint8Array||c instanceof Uint8ClampedArray?(c instanceof Uint8Array&&(c=new Uint8ClampedArray(c.buffer)),b.putImageData(new ImageData(c,g,m),0,0)):c instanceof HTMLCanvasElement&&b.drawImage(c,0,0),document.body.contains(C)&&C.style.display===""&&this._updateDrawingLayersSize({width:g,height:m,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}async deleteOriginalImage(){await this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null}_showOriginalImageCvs(){this._cvsOriginalImage&&this._cvsOriginalImage.style.display=="none"&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const c=this._cvsOriginalImage;if(c.style.display===""&&document.body.contains(c))return;const{width:g,height:m}=this._originalImageData;if(this._updateDrawingLayersSize({width:g,height:m,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(c))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(c);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(c)}this._showOriginalImageCvs()}async _hideOriginalImage(c){this._originalImageData&&this._cvsOriginalImage&&this._cvsOriginalImage.style.display!=="none"&&(this._updateDrawingLayersSize(),this._bOpen&&c&&(this._video&&this._recordedStates.videoPlaying&&await this.play(null,null,null,{notTriggerSingleFrameClick:!0}),this._recordedStates.fetchingLoopStart&&!this.singleFrameMode&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())}async hideOriginalImage(){return this._hideOriginalImage(!0)}transformCoord(c){if(!this.isOpen())throw new Error("Unavailable when the camera is not open.");if(this.singleFrameMode&&!this._cvsSingleFrameMode)throw new Error("No image is selected. ");const g=this._elContainer.getBoundingClientRect();let m,C,b,S,x,R=g.left,O=g.top,E=R+window.scrollX,V=O+window.scrollY;this.singleFrameMode?(m=this._cvsSingleFrameMode.width,C=this._cvsSingleFrameMode.height,b=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).width),S=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).height),x="contain"):(m=this.video.videoWidth,C=this.video.videoHeight,b=parseFloat(window.getComputedStyle(this._elContainer).width),S=parseFloat(window.getComputedStyle(this._elContainer).height),x=this.videoFit);const j=b/S,tt=m/C;let K,J,Z,ht,at=1;if(x==="contain")j<tt?(at=b/m,K=R+c.x*at,J=O+c.y*at+(S-C*at)/2,Z=E+c.x*at,ht=V+c.y*at+(S-C*at)/2):(at=S/C,K=R+c.x*at+(b-m*at)/2,J=O+c.y*at,Z=E+c.x*at+(b-m*at)/2,ht=V+c.y*at);else if(x==="cover")if(j<tt){at=S/C;let st=c.x*at-(m*at-b)/2;st=Math.max(st,0),st=Math.min(st,b),K=R+st,J=O+c.y*at,Z=E+st,ht=V+c.y*at}else{at=b/m;let st=c.y*at-(C*at-S)/2;st=Math.max(st,0),st=Math.min(st,S),K=R+c.x*at,J=O+st,Z=E+c.x*at,ht=V+st}return{clientX:K,clientY:J,pageX:Z,pageY:ht}}convertToPageCoordinates(c){const g=this.transformCoord(c);return{x:g.pageX,y:g.pageY}}convertToClientCoordinates(c){const g=this.transformCoord(c);return{x:g.clientX,y:g.clientY}}dispose(c){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,c&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let g in this)delete this[g];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}lt._jsVersion="3.3.5",lt._jsEditVersion="20230801",lt._version="JS "+lt._jsVersion+"."+lt._jsEditVersion,lt.browserInfo=Et,lt._hasEngineResourceLoaded=!1,lt._engineResourcePath=Ii,lt._defaultUIElementURL="@engineResourcePath/dce.ui.html";z.license="DLS2eyJoYW5kc2hha2VDb2RlIjoiMjAwMDAxLTE2NDk4Mjk3OTI2MzUiLCJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSIsInNlc3Npb25QYXNzd29yZCI6IndTcGR6Vm05WDJrcEQ5YUoifQ==";z.engineResourcePath="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/";lt.engineResourcePath="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@3.3.5/dist/";let Zt,Ut,di,he=!1,ki=window.parseBarcode;Fi();async function Fi(){Zt=await z.createInstance(),Ut=await lt.createInstance(),await Ut.setUIElement(document.getElementById("scanner")),Ut.setVideoFit("cover"),Ut.on("played",function(){Vi()})}function Bi(f){let c=document.getElementById("selectedImg");c.onload=async function(){let g=await Zt.decode(c);fi(g)},c.src=f}function fi(f){const c=document.getElementById("results");c.innerHTML="";for(let g=0;g<f.length;g++){const m=f[g],C=document.createElement("h2");C.innerText="Barcode "+(g+1)+":",c.appendChild(C),c.appendChild(ji(m))}}function ji(f){const c=document.createElement("table"),g=[];g.push({key:"Format",value:f.barcodeFormatString}),g.push({key:"Text",value:f.barcodeText}),g.push({key:"Bytes",value:f.barcodeBytes});try{let S;S=Ni(f);for(let x=0;x<S.length;x++){const R=S[x];typeof R.data=="object"&&"getYear"in R.data?g.push({key:R.dataTitle,value:R.data.toDateString()}):g.push({key:R.dataTitle,value:R.data})}}catch(S){console.log(S)}const m=document.createElement("tr"),C=document.createElement("th");C.innerText="Key",C.style.minWidth="30vw";const b=document.createElement("th");b.innerText="Value",m.appendChild(C),m.appendChild(b),c.appendChild(m);for(let S=0;S<g.length;S++){const x=g[S],R=document.createElement("tr"),O=document.createElement("td");O.innerText=x.key;const E=document.createElement("td");E.innerText=x.value,R.appendChild(O),R.appendChild(E),c.appendChild(R)}return c}function Ni(f){let c=f.barcodeText;c=c.replace(/{GS}/g,"|"),c=c.replace(//g,"|");let g=c.split("|");(f.barcodeFormatString==="GS1 Composite Code"||f.barcodeFormatString.indexOf("GS1 Databar")!=-1&&f.barcodeFormatString.indexOf("Expanded")==-1)&&(g[0]="01"+g[0]),console.log(g);let m=[];for(let C=0;C<g.length;C++){const b=g[C],S=ki(b);m=m.concat(S.parsedCodeItems)}return m}function Ui(){if(!Zt||!Ut){alert("Please wait for the initialization of Dynamsoft Barcode Reader.");return}Ut.open(!0)}function gi(){pi(),Ut.close(!0)}function Vi(){pi(),di=setInterval(Gi,50)}function pi(){clearInterval(di),he=!1}async function Gi(){if(he!==!0&&Zt&&Ut){if(Ut.isOpen()===!1)return;he=!0;let f=Ut.getFrame(),c=await Zt.decode(f);if(c.length>0){let g=document.getElementById("selectedImg");g.onload=function(){},g.src=f.toCanvas().toDataURL(),fi(c),gi()}he=!1}}var ii;(ii=document.getElementById("decodeImageBtn"))==null||ii.addEventListener("click",async function(){var f;Zt?(f=document.getElementById("imageFile"))==null||f.click():alert("Please wait for the initialization of Dynamsoft Barcode Reader.")});var ri;(ri=document.getElementById("liveScanBtn"))==null||ri.addEventListener("click",function(){Ui()});var ni;(ni=document.getElementById("closeBtn"))==null||ni.addEventListener("click",function(){gi()});var si;(si=document.getElementById("imageFile"))==null||si.addEventListener("change",function(){let f=document.getElementById("imageFile");if(f.files&&f.files.length>0){let c=f.files[0],g=new FileReader;g.onload=function(m){var C;Bi((C=m.target)==null?void 0:C.result)},g.onerror=function(){console.warn("oops, something went wrong.")},g.readAsDataURL(c)}});
